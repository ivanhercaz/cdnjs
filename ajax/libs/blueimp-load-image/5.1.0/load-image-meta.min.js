!function(e){"use strict";"function"==typeof define&&define.amd?define(["./load-image"],e):"object"==typeof module&&module.exports?e(require("./load-image")):e(window.loadImage)}(function(p){"use strict";function i(e,a,t){return new Blob([t,p.blobSlice.call(e,a.byteLength)],{type:"image/jpeg"})}p.blobSlice=p.global.Blob&&(Blob.prototype.slice||Blob.prototype.webkitSlice||Blob.prototype.mozSlice),p.bufferSlice=p.global.ArrayBuffer.prototype.slice||function(e,a){a=a||this.byteLength-e;var t=new Uint8Array(this,e,a),r=new Uint8Array(a);return r.set(t),r.buffer},p.metaDataParsers={jpeg:{65505:[],65517:[]}},p.parseMetaData=function(a,e,u,b){var m=this;function t(c,g){if(!(p.global.DataView&&p.blobSlice&&a&&12<=a.size&&"image/jpeg"===a.type))return c(b);var e=u.maxMetaDataSize||262144;p.readFile(p.blobSlice.call(a,0,e),function(e){if(e.target.error)return g(e.target.error);var a=e.target.result,t=new DataView(a);if(65496!==t.getUint16(0))return g(new Error("Invalid JPEG file: Missing JPEG marker."));for(var r,i,n,o,l=2,s=t.byteLength-4,f=l;l<s&&(65504<=(r=t.getUint16(l))&&r<=65519||65534===r);){if(l+(i=t.getUint16(l+2)+2)>t.byteLength){console.log("Invalid JPEG metadata: Invalid segment size.");break}if((n=p.metaDataParsers.jpeg[r])&&!u.disableMetaDataParsers)for(o=0;o<n.length;o+=1)n[o].call(m,t,l,i,b,u);f=l+=i}!u.disableImageHead&&6<f&&(b.imageHead=p.bufferSlice.call(a,0,f)),c(b)},"readAsArrayBuffer")||c(b)}return u=u||{},p.global.Promise&&"function"!=typeof e?(b=u=e||{},new Promise(t)):(b=b||{},t(e,e))},p.replaceHead=function(a,t,r){var e={maxMetaDataSize:256,disableMetaDataParsers:!0};if(!r&&p.global.Promise)return p.parseMetaData(a,e).then(function(e){return i(a,e.imageHead,t)});p.parseMetaData(a,function(e){r(i(a,e.imageHead,t))},e)};var o=p.transform;p.transform=function(a,t,r,i,n){p.requiresMetaData(t)?(n=n||{},p.parseMetaData(i,function(e){e!==n&&(p.global.console&&console.log(e),e=n),o.call(p,a,t,r,i,e)},t,n)):o.apply(p,arguments)}});