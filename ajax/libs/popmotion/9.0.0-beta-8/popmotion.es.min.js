import{__rest,__assign,__extends}from"tslib";import{pipe,velocityPerSecond,mixComplex,mixColor,mix,clamp,progress,velocityPerFrame,distance,angle,applyOffset}from"@popmotion/popcorn";import sync,{getFrameData,cancelSync}from"framesync";import{color,complex,px,percent,degrees,vh,vw,number}from"style-value-types";import{createReversedEasing,linear,easeOut,easeInOut}from"@popmotion/easing";import{invariant}from"hey-listen";var Observer=function(){return function(t,e){var n=this,r=t.middleware,o=t.onComplete;this.isActive=!0,this.update=function(t){n.observer.update&&n.updateObserver(t)},this.complete=function(){n.observer.complete&&n.isActive&&n.observer.complete(),n.onComplete&&n.onComplete(),n.isActive=!1},this.error=function(t){n.observer.error&&n.isActive&&n.observer.error(t),n.isActive=!1},this.observer=e,this.updateObserver=function(t){return e.update(t)},this.onComplete=o,e.update&&r&&r.length&&r.forEach(function(t){return n.updateObserver=t(n.updateObserver,n.complete)})}}(),createObserver=function(t,e,n){var r=e.middleware;return new Observer({middleware:r,onComplete:n},"function"==typeof t?{update:t}:t)},Action=function(){function t(t){void 0===t&&(t={}),this.props=t}return t.prototype.create=function(e){return new t(e)},t.prototype.start=function(t){void 0===t&&(t={});var e=!1,n={stop:function(){}},r=this.props,o=r.init,i=__rest(r,["init"]),u=o(createObserver(t,i,function(){e=!0,n.stop()}));return n=u?__assign({},n,u):n,e&&n.stop(),n},t.prototype.applyMiddleware=function(t){return this.create(__assign({},this.props,{middleware:this.props.middleware?[t].concat(this.props.middleware):[t]}))},t.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=1===t.length?t[0]:pipe.apply(void 0,t);return this.applyMiddleware(function(t){return function(e){return t(n(e))}})},t}(),action=function(t){return new Action({init:t})},Chainable=function(){function t(t){void 0===t&&(t={}),this.props=t}return t.prototype.applyMiddleware=function(t){return this.create(__assign({},this.props,{middleware:this.props.middleware?[t].concat(this.props.middleware):[t]}))},t.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=1===t.length?t[0]:pipe.apply(void 0,t);return this.applyMiddleware(function(t){return function(e){return t(n(e))}})},t.prototype.while=function(t){return this.applyMiddleware(function(e,n){return function(r){return t(r)?e(r):n()}})},t.prototype.filter=function(t){return this.applyMiddleware(function(e){return function(n){return t(n)&&e(n)}})},t}(),BaseMulticast=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.subscribers=[],e}return __extends(e,t),e.prototype.complete=function(){this.subscribers.forEach(function(t){return t.complete()})},e.prototype.error=function(t){this.subscribers.forEach(function(e){return e.error(t)})},e.prototype.update=function(t){for(var e=0;e<this.subscribers.length;e++)this.subscribers[e].update(t)},e.prototype.subscribe=function(t){var e=this,n=createObserver(t,this.props);return this.subscribers.push(n),{unsubscribe:function(){var t=e.subscribers.indexOf(n);-1!==t&&e.subscribers.splice(t,1)}}},e.prototype.stop=function(){this.parent&&this.parent.stop()},e}(Chainable),Multicast=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.create=function(t){return new e(t)},e}(BaseMulticast),multicast=function(){return new Multicast},ValueReaction=function(t){function e(e){var n=t.call(this,e)||this;return n.scheduleVelocityCheck=function(){return sync.postRender(n.velocityCheck)},n.velocityCheck=function(t){t.timestamp!==n.lastUpdated&&(n.prev=n.current)},n.prev=n.current=e.value||0,n.updateCurrent=function(t){return n.current=t},n.getVelocityOfCurrent=function(){return n.getSingleVelocity(n.current,n.prev)},e.initialSubscription&&n.subscribe(e.initialSubscription),n}return __extends(e,t),e.prototype.create=function(t){return new e(t)},e.prototype.get=function(){return this.current},e.prototype.getVelocity=function(){return this.getVelocityOfCurrent()},e.prototype.update=function(e){t.prototype.update.call(this,e),this.prev=this.current,this.updateCurrent(e);var n=getFrameData(),r=n.delta,o=n.timestamp;this.timeDelta=r,this.lastUpdated=o,sync.postRender(this.scheduleVelocityCheck)},e.prototype.subscribe=function(e){var n=t.prototype.subscribe.call(this,e);return this.subscribers[this.subscribers.length-1].update(this.current),n},e.prototype.getSingleVelocity=function(t,e){return"number"==typeof t&&"number"==typeof e?velocityPerSecond(t-e,this.timeDelta):velocityPerSecond(parseFloat(t)-parseFloat(e),this.timeDelta)||0},e}(BaseMulticast),value=function(t,e){return new ValueReaction({value:t,initialSubscription:e})},createVectorTests=function(t){var e=Object.keys(t),n=function(e,n){return void 0!==e&&!t[n](e)};return{getVectorKeys:function(t){return e.reduce(function(e,r){return n(t[r],r)&&e.push(r),e},[])},testVectorProps:function(t){return t&&e.some(function(e){return n(t[e],e)})}}},unitTypes=[px,percent,degrees,vh,vw],findUnitType=function(t){return unitTypes.find(function(e){return e.test(t)})},isUnitProp=function(t){return Boolean(findUnitType(t))},createAction=function(t,e){return t(e)},createUnitAction=function(t,e){var n=e.from,r=e.to,o=__rest(e,["from","to"]),i=findUnitType(n)||findUnitType(r),u=i.transform,c=i.parse;return t(__assign({},o,{from:"string"==typeof n?c(n):n,to:"string"==typeof r?c(r):r})).pipe(u)},createMixerAction=function(t){return function(e,n){var r=n.from,o=n.to,i=__rest(n,["from","to"]);return e(__assign({},i,{from:0,to:1})).pipe(t(r,o))}},createColorAction=createMixerAction(mixColor),createComplexAction=createMixerAction(mixComplex),createVectorAction=function(t,e){var n=createVectorTests(e),r=n.testVectorProps,o=n.getVectorKeys;return function(e){if(!r(e))return t(e);var n=o(e),i=e[n[0]];return getActionCreator(i)(t,e,n)}},getActionCreator=function(t){return"number"==typeof t?createAction:isUnitProp(t)?createUnitAction:color.test(t)?createColorAction:complex.test(t)?createComplexAction:createAction},decay=function(t){return void 0===t&&(t={}),action(function(e){var n=e.complete,r=e.update,o=t.velocity,i=void 0===o?0:o,u=t.from,c=void 0===u?0:u,a=t.power,s=void 0===a?.8:a,p=t.timeConstant,f=void 0===p?350:p,l=t.restDelta,d=void 0===l?.5:l,v=t.modifyTarget,m=0,y=s*i,h=Math.round(c+y),g=void 0===v?h:v(h),b=sync.update(function(t){var e=t.delta;m+=e;var o=-y*Math.exp(-m/f),i=o>d||o<-d;r(i?g+o:g),i||(cancelSync.update(b),n())},!0);return{stop:function(){return cancelSync.update(b)}}})},vectorDecay=createVectorAction(decay,{from:number.test,modifyTarget:function(t){return"function"==typeof t},velocity:number.test}),spring=function(t){return void 0===t&&(t={}),action(function(e){var n=e.update,r=e.complete,o=t.velocity,i=void 0===o?0:o,u=t.from,c=void 0===u?0:u,a=t.to,s=void 0===a?0:a,p=t.stiffness,f=void 0===p?100:p,l=t.damping,d=void 0===l?10:l,v=t.mass,m=void 0===v?1:v,y=t.restSpeed,h=void 0===y?.01:y,g=t.restDelta,b=void 0===g?.01:g,A=i?-i/1e3:0,_=0,x=s-c,P=c,w=P,S=sync.update(function(t){var e=t.delta;_+=e;var o=d/(2*Math.sqrt(f*m)),u=Math.sqrt(f/m)/1e3;if(w=P,o<1){var c=Math.exp(-o*u*_),a=u*Math.sqrt(1-o*o);P=s-c*((A+o*u*x)/a*Math.sin(a*_)+x*Math.cos(a*_))}else{c=Math.exp(-u*_);P=s-c*(x+(A+u*x)*_)}i=velocityPerSecond(P-w,e);var p=Math.abs(i)<=h,l=Math.abs(s-P)<=b;p&&l?(n(P=s),cancelSync.update(S),r()):n(P)},!0);return{stop:function(){return cancelSync.update(S)}}})},vectorSpring=createVectorAction(spring,{from:number.test,to:number.test,stiffness:number.test,damping:number.test,mass:number.test,velocity:number.test}),inertia=function(t){var e=t.from,n=void 0===e?0:e,r=t.velocity,o=void 0===r?0:r,i=t.min,u=t.max,c=t.power,a=void 0===c?.8:c,s=t.timeConstant,p=void 0===s?700:s,f=t.bounceStiffness,l=void 0===f?500:f,d=t.bounceDamping,v=void 0===d?10:d,m=t.restDelta,y=void 0===m?1:m,h=t.modifyTarget;return action(function(t){var e,r=t.update,c=t.complete,s=n,f=n,d=!1,m=function(t){return void 0!==i&&t<=i},g=function(t){return void 0!==u&&t>=u},b=function(t){return m(t)||g(t)},A=function(t){r(t),s=f,o=velocityPerSecond((f=t)-s,getFrameData().delta),e&&!d&&function(t,e){return m(t)&&e<0||g(t)&&e>0}(t,o)&&x({from:t,velocity:o})},_=function(t,n){e&&e.stop(),e=t.start({update:A,complete:function(){n?n():c()}})},x=function(t){d=!0,_(vectorSpring(__assign({},t,{to:m(t.from)?i:u,stiffness:l,damping:v,restDelta:y})))};if(b(n))x({from:n,velocity:o});else if(0!==o){var P=vectorDecay({from:n,velocity:o,timeConstant:p,power:a,restDelta:b(n)?20:y,modifyTarget:h});_(P,function(){b(f)?x({from:f,velocity:o}):c()})}else c();return{stop:function(){return e&&e.stop()}}})},index=createVectorAction(inertia,{from:number.test,velocity:number.test,min:number.test,max:number.test,damping:number.test,stiffness:number.test,modifyTarget:function(t){return"function"==typeof t}}),frame=function(){return action(function(t){var e=t.update,n=0,r=sync.update(function(t){var r=t.timestamp;n||(n=r),e(r-n)},!0,!0);return{stop:function(){return cancelSync.update(r)}}})},scrubber=function(t){var e=t.from,n=void 0===e?0:e,r=t.to,o=void 0===r?1:r,i=t.ease,u=void 0===i?linear:i,c=t.reverseEase;return void 0!==c&&c&&(u=createReversedEasing(u)),action(function(t){var e=t.update;return{seek:function(t){return e(t)}}}).pipe(u,function(t){return mix(n,o,t)})},vectorScrubber=createVectorAction(scrubber,{ease:function(t){return"function"==typeof t},from:number.test,to:number.test}),clampProgress=clamp(0,1),tween=function(t){return void 0===t&&(t={}),action(function(e){var n,r=e.update,o=e.complete,i=t.duration,u=void 0===i?300:i,c=t.ease,a=void 0===c?easeOut:c,s=t.flip,p=void 0===s?0:s,f=t.loop,l=void 0===f?0:f,d=t.yoyo,v=void 0===d?0:d,m=t.repeatDelay,y=void 0===m?0:m,h=t.from,g=void 0===h?0:h,b=t.to,A=void 0===b?1:b,_=t.elapsed,x=void 0===_?0:_,P=t.flipCount,w=void 0===P?0:P,S=t.yoyoCount,T=void 0===S?0:S,D=t.loopCount,C=void 0===D?0:D,O=vectorScrubber({from:g,to:A,ease:a}).start(r),M=0,V=!1,k=function(t){var e;void 0===t&&(t=!1),O=vectorScrubber({from:g=(e=[A,g])[0],to:A=e[1],ease:a,reverseEase:t}).start(r)},E=function(){M=clampProgress(progress(0,u,x)),O.seek(M)},F=function(){V=!0,n=sync.update(function(t){var e,r=t.delta;x+=r,E(),!(e=V&&x>u+y)||(!e||l||p||v)&&(x=x-u-y,l&&C<l?(C++,1):p&&w<p?(w++,k(),1):v&&T<v&&(k(++T%2!=0),1))||(cancelSync.update(n),o&&sync.update(o,!1,!0))},!0)},U=function(){V=!1,n&&cancelSync.update(n)};return F(),{isActive:function(){return V},getElapsed:function(){return clamp(0,u,x)},getProgress:function(){return M},stop:function(){U()},pause:function(){return U(),this},resume:function(){return V||F(),this},seek:function(t){return x=mix(0,u,t),sync.update(E,!1,!0),this},reverse:function(){return k(),this}}})},clampProgress$1=clamp(0,1),defaultEasings=function(t,e){return t.map(function(){return e||easeOut}).splice(0,t.length-1)},defaultTimings=function(t){var e=t.length;return t.map(function(t,n){return 0!==n?n/(e-1):0})},interpolateScrubbers=function(t,e,n){var r=t.length,o=r-1,i=o-1,u=e.map(function(t){return t.start(n)});return function(e){e<=t[0]&&u[0].seek(0),e>=t[o]&&u[i].seek(1);for(var n=1;n<r&&!(t[n]>e||n===o);n++);var c=progress(t[n-1],t[n],e);u[n-1].seek(clampProgress$1(c))}},keyframes=function(t){var e=t.easings,n=t.ease,r=void 0===n?linear:n,o=t.times,i=t.values,u=__rest(t,["easings","ease","times","values"]);e=Array.isArray(e)?e:defaultEasings(i,e),o=o||defaultTimings(i);var c=e.map(function(t,e){return vectorScrubber({from:i[e],to:i[e+1],ease:t})});return tween(__assign({},u,{ease:r})).applyMiddleware(function(t){return interpolateScrubbers(o,c,t)})},physics=function(t){return void 0===t&&(t={}),action(function(e){var n=e.complete,r=e.update,o=t.acceleration,i=void 0===o?0:o,u=t.friction,c=void 0===u?0:u,a=t.velocity,s=void 0===a?0:a,p=t.springStrength,f=t.to,l=t.restSpeed,d=void 0===l?.001:l,v=t.from,m=void 0===v?0:v,y=sync.update(function(t){var e=t.delta,o=Math.max(e,16);(i&&(s+=velocityPerFrame(i,o)),c&&(s*=Math.pow(1-c,o/100)),void 0!==p&&void 0!==f)&&(s+=(f-m)*velocityPerFrame(p,o));m+=velocityPerFrame(s,o),r(m),!1!==d&&(!s||Math.abs(s)<=d)&&(cancelSync.update(y),n())},!0);return{set:function(t){return m=t,this},setAcceleration:function(t){return i=t,this},setFriction:function(t){return c=t,this},setSpringStrength:function(t){return p=t,this},setSpringTarget:function(t){return f=t,this},setVelocity:function(t){return s=t,this},stop:function(){return cancelSync.update(y)}}})},vectorPhysics=createVectorAction(physics,{acceleration:number.test,friction:number.test,velocity:number.test,from:number.test,to:number.test,springStrength:number.test}),multi=function(t){var e=t.getCount,n=t.getFirst,r=t.getOutput,o=t.mapApi,i=t.setProp,u=t.startActions;return function(t){return action(function(c){var a=c.update,s=c.complete,p=c.error,f=e(t),l=r(),d=function(){return a(l)},v=0,m=u(t,function(t,e){var n=!1;return t.start({complete:function(){n||(n=!0,++v===f&&sync.update(s))},error:p,update:function(t){i(l,e,t),sync.update(d,!1,!0)}})});return Object.keys(n(m)).reduce(function(t,e){return t[e]=o(m,e),t},{})})}},composite=multi({getOutput:function(){return{}},getCount:function(t){return Object.keys(t).length},getFirst:function(t){return t[Object.keys(t)[0]]},mapApi:function(t,e){return function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return Object.keys(t).reduce(function(r,o){var i;return t[o][e]&&(n[0]&&void 0!==n[0][o]?r[o]=t[o][e](n[0][o]):r[o]=(i=t[o])[e].apply(i,n)),r},{})}},setProp:function(t,e,n){return t[e]=n},startActions:function(t,e){return Object.keys(t).reduce(function(n,r){return n[r]=e(t[r],r),n},{})}}),DEFAULT_DURATION=300,flattenTimings=function(t){var e=[],n=t[t.length-1],r="number"==typeof n,o=r?n:0,i=r?t.slice(0,-1):t,u=i.length,c=0;return i.forEach(function(t,n){if(e.push(t),n!==u-1){var r=t.duration||DEFAULT_DURATION;c+=o,e.push("-"+(r-c))}}),e},flattenArrayInstructions=function(t,e){return Array.isArray(e)?t.push.apply(t,flattenTimings(e)):t.push(e),t},convertDefToProps=function(t,e,n){var r=t.duration,o=t.easings,i=t.times,u=t.values,c=u.length,a=i[c-1],s=0===e.at?0:e.at/r,p=(e.at+e.duration)/r;if(0===n)u.push(e.from),i.push(s);else if(a!==s){void 0!==e.from&&(u.push(u[c-1]),i.push(s),o.push(linear));var f=void 0!==e.from?e.from:u[c-1];u.push(f),i.push(s),o.push(linear)}else void 0!==e.from&&(u.push(e.from),i.push(s),o.push(linear));return u.push(e.to),i.push(p),o.push(e.ease||easeInOut),t},timeline=function(t,e){var n=void 0===e?{}:e,r=n.duration,o=n.elapsed,i=n.ease,u=n.loop,c=n.flip,a=n.yoyo,s=0,p=0,f=t.reduce(flattenArrayInstructions,[]),l=[];f.forEach(function(t){if("string"==typeof t)s+=parseFloat(t);else if("number"==typeof t)s=t;else{var e=__assign({},t,{at:s});e.duration=void 0===e.duration?DEFAULT_DURATION:e.duration,l.push(e),s+=e.duration,p=Math.max(p,e.at+e.duration)}});for(var d={},v=l.length,m=0;m<v;m++){var y=l[m],h=y.track;if(void 0===h)throw new Error("No track defined");d.hasOwnProperty(h)||(d[h]=[]),d[h].push(y)}var g={};for(var b in d)if(d.hasOwnProperty(b)){var A=d[b].reduce(convertDefToProps,{duration:p,easings:[],times:[],values:[]});g[b]=keyframes(__assign({},A,{duration:r||p,ease:i,elapsed:o,loop:u,yoyo:a,flip:c}))}return composite(g)},listen=function(t,e,n){return action(function(r){var o=r.update,i=e.split(" ").map(function(e){return t.addEventListener(e,o,n),e});return{stop:function(){return i.forEach(function(e){return t.removeEventListener(e,o,n)})}}})},defaultPointerPos=function(){return{clientX:0,clientY:0,pageX:0,pageY:0,x:0,y:0}},eventToPoint=function(t,e){return void 0===e&&(e=defaultPointerPos()),e.clientX=e.x=t.clientX,e.clientY=e.y=t.clientY,e.pageX=t.pageX,e.pageY=t.pageY,e},points=[defaultPointerPos()],isTouchDevice=!1;if("undefined"!=typeof document){var updatePointsLocation=function(t){var e=t.touches;isTouchDevice=!0;var n=e.length;points.length=0;for(var r=0;r<n;r++){var o=e[r];points.push(eventToPoint(o))}};listen(document,"touchstart touchmove",{passive:!0,capture:!0}).start(updatePointsLocation)}var multitouch=function(t){var e=void 0===t?{}:t,n=e.preventDefault,r=void 0===n||n,o=e.scale,i=void 0===o?1:o,u=e.rotate,c=void 0===u?0:u;return action(function(t){var e=t.update,n={touches:points,scale:i,rotate:c},o=0,u=0,a=points.length>1;if(a){var s=points[0],p=points[1];o=distance(s,p),u=angle(s,p)}var f=function(){if(a){var t=points[0],r=points[1],s=distance(t,r),p=angle(t,r);n.scale=i*(s/o),n.rotate=c+(p-u)}e(n)},l=listen(document,"touchmove",{passive:!r}).start(function(t){(r||t.touches.length>1)&&t.preventDefault(),sync.update(f)});return isTouchDevice&&sync.update(f),{stop:function(){cancelSync.update(f),l.stop()}}})},getIsTouchDevice=function(){return isTouchDevice},point=defaultPointerPos(),isMouseDevice=!1;if("undefined"!=typeof document){var updatePointLocation=function(t){isMouseDevice=!0,eventToPoint(t,point)};listen(document,"mousedown mousemove",!0).start(updatePointLocation)}var mouse=function(t){var e=(void 0===t?{}:t).preventDefault,n=void 0===e||e;return action(function(t){var e=t.update,r=function(){return e(point)},o=listen(document,"mousemove").start(function(t){n&&t.preventDefault(),sync.update(r)});return isMouseDevice&&sync.update(r),{stop:function(){cancelSync.update(r),o.stop()}}})},getFirstTouch=function(t){return t[0]},pointer=function(t){return void 0===t&&(t={}),getIsTouchDevice()?multitouch(t).pipe(function(t){return t.touches},getFirstTouch):mouse(t)},index$1=function(t){void 0===t&&(t={});var e=t.x,n=t.y,r=__rest(t,["x","y"]);if(void 0!==e||void 0!==n){var o=applyOffset(e||0),i=applyOffset(n||0),u={x:0,y:0};return pointer(r).pipe(function(t){return u.x=o(t.x),u.y=i(t.y),u})}return pointer(r)},chain=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return action(function(e){var n,r=e.update,o=e.complete,i=0,u=function(){n=t[i].start({complete:function(){++i>=t.length?o():u()},update:r})};return u(),{stop:function(){return n&&n.stop()}}})},parallel=multi({getOutput:function(){return[]},getCount:function(t){return t.length},getFirst:function(t){return t[0]},mapApi:function(t,e){return function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return t.map(function(t,r){if(t[e])return Array.isArray(n[0])?t[e](n[0][r]):t[e].apply(t,n)})}},setProp:function(t,e,n){return t[e]=n},startActions:function(t,e){return t.map(function(t,n){return e(t,n)})}}),parallel$1=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return parallel(t)},crossfade=function(t,e){return action(function(n){var r=0,o=parallel$1(t,e).start(__assign({},n,{update:function(t){var e=t[0],o=t[1];n.update(mix(e,o,r))}}));return{setBalance:function(t){return r=t},stop:function(){return o.stop()}}})},delay=function(t){return action(function(e){var n=e.complete,r=setTimeout(n,t);return{stop:function(){return clearTimeout(r)}}})},merge=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return action(function(e){var n=t.map(function(t){return t.start(e)});return{stop:function(){return n.forEach(function(t){return t.stop()})}}})},schedule=function(t,e){return action(function(n){var r,o=n.update,i=n.complete,u=t.start({update:function(){return void 0!==r&&o(r)},complete:i}),c=e.start({update:function(t){return r=t},complete:i});return{stop:function(){u.stop(),c.stop()}}})},stagger=function(t,e){var n="number"==typeof e,r=t.map(function(t,r){var o=n?e*r:e(r);return chain(delay(o),t)});return parallel$1.apply(void 0,r)},styler=function(){return invariant(!1,"styler has been removed from Popmotion in 9.0. Downgrade to 8.x or npm install stylefire")};export{Action,ValueReaction,action,chain,composite,crossfade,vectorDecay as decay,delay,frame as everyFrame,index as inertia,keyframes,listen,merge,mouse,multicast,multitouch,parallel$1 as parallel,vectorPhysics as physics,index$1 as pointer,schedule,vectorSpring as spring,stagger,styler,timeline,tween,value};