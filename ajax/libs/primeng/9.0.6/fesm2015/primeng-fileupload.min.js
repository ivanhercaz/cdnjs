import{EventEmitter,ElementRef,NgZone,Input,Output,ContentChildren,ViewChild,Component,ChangeDetectionStrategy,NgModule}from"@angular/core";import{CommonModule}from"@angular/common";import{DomSanitizer}from"@angular/platform-browser";import{ButtonModule}from"primeng/button";import{MessagesModule}from"primeng/messages";import{ProgressBarModule}from"primeng/progressbar";import{DomHandler}from"primeng/dom";import{PrimeTemplate,SharedModule}from"primeng/api";import{HttpEventType,HttpClient}from"@angular/common/http";var __decorate=this&&this.__decorate||function(e,t,i,o){var l,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,o);else for(var n=e.length-1;n>=0;n--)(l=e[n])&&(s=(a<3?l(s):a>3?l(t,i,s):l(t,i))||s);return a>3&&s&&Object.defineProperty(t,i,s),s};let FileUpload=class{constructor(e,t,i,o){this.el=e,this.sanitizer=t,this.zone=i,this.http=o,this.method="POST",this.invalidFileSizeMessageSummary="{0}: Invalid file size, ",this.invalidFileSizeMessageDetail="maximum upload size is {0}.",this.invalidFileTypeMessageSummary="{0}: Invalid file type, ",this.invalidFileTypeMessageDetail="allowed file types: {0}.",this.invalidFileLimitMessageDetail="limit is {0} at most.",this.invalidFileLimitMessageSummary="Maximum number of files exceeded, ",this.previewWidth=50,this.chooseLabel="Choose",this.uploadLabel="Upload",this.cancelLabel="Cancel",this.chooseIcon="pi pi-plus",this.uploadIcon="pi pi-upload",this.cancelIcon="pi pi-times",this.showUploadButton=!0,this.showCancelButton=!0,this.mode="advanced",this.onBeforeUpload=new EventEmitter,this.onSend=new EventEmitter,this.onUpload=new EventEmitter,this.onError=new EventEmitter,this.onClear=new EventEmitter,this.onRemove=new EventEmitter,this.onSelect=new EventEmitter,this.onProgress=new EventEmitter,this.uploadHandler=new EventEmitter,this._files=[],this.progress=0,this.uploadedFileCount=0}set files(e){this._files=[];for(let t=0;t<e.length;t++){let i=e[t];this.validate(i)&&(this.isImage(i)&&(i.objectURL=this.sanitizer.bypassSecurityTrustUrl(window.URL.createObjectURL(e[t]))),this._files.push(e[t]))}}get files(){return this._files}ngAfterContentInit(){this.templates.forEach(e=>{switch(e.getType()){case"file":this.fileTemplate=e.template;break;case"content":this.contentTemplate=e.template;break;case"toolbar":this.toolbarTemplate=e.template;break;default:this.fileTemplate=e.template}})}ngAfterViewInit(){"advanced"===this.mode&&this.zone.runOutsideAngular(()=>{this.content&&this.content.nativeElement.addEventListener("dragover",this.onDragOver.bind(this))})}onFileSelect(e){if("drop"!==e.type&&this.isIE11()&&this.duplicateIEEvent)return void(this.duplicateIEEvent=!1);this.msgs=[],this.multiple||(this.files=[]);let t=e.dataTransfer?e.dataTransfer.files:e.target.files;for(let e=0;e<t.length;e++){let i=t[e];this.isFileSelected(i)||this.validate(i)&&(this.isImage(i)&&(i.objectURL=this.sanitizer.bypassSecurityTrustUrl(window.URL.createObjectURL(t[e]))),this.files.push(t[e]))}this.onSelect.emit({originalEvent:e,files:t,currentFiles:this.files}),this.fileLimit&&"advanced"==this.mode&&this.checkFileLimit(),!this.hasFiles()||!this.auto||"advanced"===this.mode&&this.isFileLimitExceeded()||this.upload(),"drop"!==e.type&&this.isIE11()?this.clearIEInput():this.clearInputElement()}isFileSelected(e){for(let t of this.files)if(t.name+t.type+t.size===e.name+e.type+e.size)return!0;return!1}isIE11(){return!!window.MSInputMethodContext&&!!document.documentMode}validate(e){return this.accept&&!this.isFileTypeValid(e)?(this.msgs.push({severity:"error",summary:this.invalidFileTypeMessageSummary.replace("{0}",e.name),detail:this.invalidFileTypeMessageDetail.replace("{0}",this.accept)}),!1):!(this.maxFileSize&&e.size>this.maxFileSize)||(this.msgs.push({severity:"error",summary:this.invalidFileSizeMessageSummary.replace("{0}",e.name),detail:this.invalidFileSizeMessageDetail.replace("{0}",this.formatSize(this.maxFileSize))}),!1)}isFileTypeValid(e){let t=this.accept.split(",").map(e=>e.trim());for(let i of t){if(this.isWildcard(i)?this.getTypeClass(e.type)===this.getTypeClass(i):e.type==i||this.getFileExtension(e).toLowerCase()===i.toLowerCase())return!0}return!1}getTypeClass(e){return e.substring(0,e.indexOf("/"))}isWildcard(e){return-1!==e.indexOf("*")}getFileExtension(e){return"."+e.name.split(".").pop()}isImage(e){return/^image\//.test(e.type)}onImageLoad(e){window.URL.revokeObjectURL(e.src)}upload(){if(this.customUpload)this.fileLimit&&(this.uploadedFileCount+=this.files.length),this.uploadHandler.emit({files:this.files});else{this.uploading=!0,this.msgs=[];let e=new FormData;this.onBeforeUpload.emit({formData:e});for(let t=0;t<this.files.length;t++)e.append(this.name,this.files[t],this.files[t].name);this.http.post(this.url,e,{headers:this.headers,reportProgress:!0,observe:"events",withCredentials:this.withCredentials}).subscribe(t=>{switch(t.type){case HttpEventType.Sent:this.onSend.emit({originalEvent:t,formData:e});break;case HttpEventType.Response:this.uploading=!1,this.progress=0,t.status>=200&&t.status<300?(this.fileLimit&&(this.uploadedFileCount+=this.files.length),this.onUpload.emit({originalEvent:t,files:this.files})):this.onError.emit({files:this.files}),this.clear();break;case HttpEventType.UploadProgress:t.loaded&&(this.progress=Math.round(100*t.loaded/t.total)),this.onProgress.emit({originalEvent:t,progress:this.progress})}},e=>{this.uploading=!1,this.onError.emit({files:this.files,error:e})})}}clear(){this.files=[],this.onClear.emit(),this.clearInputElement()}remove(e,t){this.clearInputElement(),this.onRemove.emit({originalEvent:e,file:this.files[t]}),this.files.splice(t,1)}isFileLimitExceeded(){return this.fileLimit&&this.fileLimit<=this.files.length+this.uploadedFileCount&&this.focus&&(this.focus=!1),this.fileLimit&&this.fileLimit<this.files.length+this.uploadedFileCount}isChooseDisabled(){return this.fileLimit&&this.fileLimit<=this.files.length+this.uploadedFileCount}checkFileLimit(){this.isFileLimitExceeded()&&this.msgs.push({severity:"error",summary:this.invalidFileLimitMessageSummary.replace("{0}",this.fileLimit.toString()),detail:this.invalidFileLimitMessageDetail.replace("{0}",this.fileLimit.toString())})}clearInputElement(){this.advancedFileInput&&this.advancedFileInput.nativeElement&&(this.advancedFileInput.nativeElement.value=""),this.basicFileInput&&this.basicFileInput.nativeElement&&(this.basicFileInput.nativeElement.value="")}clearIEInput(){this.advancedFileInput&&this.advancedFileInput.nativeElement&&(this.duplicateIEEvent=!0,this.advancedFileInput.nativeElement.value="")}hasFiles(){return this.files&&this.files.length>0}onDragEnter(e){this.disabled||(e.stopPropagation(),e.preventDefault())}onDragOver(e){this.disabled||(DomHandler.addClass(this.content.nativeElement,"ui-fileupload-highlight"),this.dragHighlight=!0,e.stopPropagation(),e.preventDefault())}onDragLeave(e){this.disabled||DomHandler.removeClass(this.content.nativeElement,"ui-fileupload-highlight")}onDrop(e){if(!this.disabled){DomHandler.removeClass(this.content.nativeElement,"ui-fileupload-highlight"),e.stopPropagation(),e.preventDefault();let t=e.dataTransfer?e.dataTransfer.files:e.target.files;(this.multiple||t&&1===t.length)&&this.onFileSelect(e)}}onFocus(){this.focus=!0}onBlur(){this.focus=!1}formatSize(e){if(0==e)return"0 B";let t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(3))+" "+["B","KB","MB","GB","TB","PB","EB","ZB","YB"][t]}onSimpleUploaderClick(e){this.hasFiles()&&this.upload()}getBlockableElement(){return this.el.nativeElement.children[0]}ngOnDestroy(){this.content&&this.content.nativeElement&&this.content.nativeElement.removeEventListener("dragover",this.onDragOver)}};FileUpload.ctorParameters=(()=>[{type:ElementRef},{type:DomSanitizer},{type:NgZone},{type:HttpClient}]),__decorate([Input()],FileUpload.prototype,"name",void 0),__decorate([Input()],FileUpload.prototype,"url",void 0),__decorate([Input()],FileUpload.prototype,"method",void 0),__decorate([Input()],FileUpload.prototype,"multiple",void 0),__decorate([Input()],FileUpload.prototype,"accept",void 0),__decorate([Input()],FileUpload.prototype,"disabled",void 0),__decorate([Input()],FileUpload.prototype,"auto",void 0),__decorate([Input()],FileUpload.prototype,"withCredentials",void 0),__decorate([Input()],FileUpload.prototype,"maxFileSize",void 0),__decorate([Input()],FileUpload.prototype,"invalidFileSizeMessageSummary",void 0),__decorate([Input()],FileUpload.prototype,"invalidFileSizeMessageDetail",void 0),__decorate([Input()],FileUpload.prototype,"invalidFileTypeMessageSummary",void 0),__decorate([Input()],FileUpload.prototype,"invalidFileTypeMessageDetail",void 0),__decorate([Input()],FileUpload.prototype,"invalidFileLimitMessageDetail",void 0),__decorate([Input()],FileUpload.prototype,"invalidFileLimitMessageSummary",void 0),__decorate([Input()],FileUpload.prototype,"style",void 0),__decorate([Input()],FileUpload.prototype,"styleClass",void 0),__decorate([Input()],FileUpload.prototype,"previewWidth",void 0),__decorate([Input()],FileUpload.prototype,"chooseLabel",void 0),__decorate([Input()],FileUpload.prototype,"uploadLabel",void 0),__decorate([Input()],FileUpload.prototype,"cancelLabel",void 0),__decorate([Input()],FileUpload.prototype,"chooseIcon",void 0),__decorate([Input()],FileUpload.prototype,"uploadIcon",void 0),__decorate([Input()],FileUpload.prototype,"cancelIcon",void 0),__decorate([Input()],FileUpload.prototype,"showUploadButton",void 0),__decorate([Input()],FileUpload.prototype,"showCancelButton",void 0),__decorate([Input()],FileUpload.prototype,"mode",void 0),__decorate([Input()],FileUpload.prototype,"headers",void 0),__decorate([Input()],FileUpload.prototype,"customUpload",void 0),__decorate([Input()],FileUpload.prototype,"fileLimit",void 0),__decorate([Output()],FileUpload.prototype,"onBeforeUpload",void 0),__decorate([Output()],FileUpload.prototype,"onSend",void 0),__decorate([Output()],FileUpload.prototype,"onUpload",void 0),__decorate([Output()],FileUpload.prototype,"onError",void 0),__decorate([Output()],FileUpload.prototype,"onClear",void 0),__decorate([Output()],FileUpload.prototype,"onRemove",void 0),__decorate([Output()],FileUpload.prototype,"onSelect",void 0),__decorate([Output()],FileUpload.prototype,"onProgress",void 0),__decorate([Output()],FileUpload.prototype,"uploadHandler",void 0),__decorate([ContentChildren(PrimeTemplate)],FileUpload.prototype,"templates",void 0),__decorate([ViewChild("advancedfileinput")],FileUpload.prototype,"advancedFileInput",void 0),__decorate([ViewChild("basicfileinput")],FileUpload.prototype,"basicFileInput",void 0),__decorate([ViewChild("content")],FileUpload.prototype,"content",void 0),__decorate([Input()],FileUpload.prototype,"files",null);let FileUploadModule=class{};FileUploadModule=__decorate([NgModule({imports:[CommonModule,SharedModule,ButtonModule,ProgressBarModule,MessagesModule],exports:[FileUpload=__decorate([Component({selector:"p-fileUpload",template:'\n        <div [ngClass]="\'ui-fileupload ui-widget\'" [ngStyle]="style" [class]="styleClass" *ngIf="mode === \'advanced\'">\n            <div class="ui-fileupload-buttonbar ui-widget-header ui-corner-top">\n                <span class="ui-fileupload-choose" [label]="chooseLabel" [icon]="chooseIcon" pButton [ngClass]="{\'ui-state-focus\': focus, \'ui-state-disabled\':disabled || isChooseDisabled()}"> \n                    <input #advancedfileinput type="file" (change)="onFileSelect($event)" [multiple]="multiple" [accept]="accept" [disabled]="disabled || isChooseDisabled()" \n                        (focus)="onFocus()" (blur)="onBlur()" [attr.title]="\'\'">\n                </span>\n\n                <p-button *ngIf="!auto&&showUploadButton" type="button" [label]="uploadLabel" [icon]="uploadIcon" (onClick)="upload()" [disabled]="!hasFiles() || isFileLimitExceeded()"></p-button>\n                <p-button *ngIf="!auto&&showCancelButton" type="button" [label]="cancelLabel" [icon]="cancelIcon" (onClick)="clear()" [disabled]="!hasFiles() || uploading"></p-button>\n\n                <ng-container *ngTemplateOutlet="toolbarTemplate"></ng-container>\n            </div>\n            <div #content [ngClass]="{\'ui-fileupload-content ui-widget-content ui-corner-bottom\':true}"\n                 (dragenter)="onDragEnter($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">\n                <p-progressBar [value]="progress" [showValue]="false" *ngIf="hasFiles()"></p-progressBar>\n\n                <p-messages [value]="msgs" [enableService]="false"></p-messages>\n\n                <div class="ui-fileupload-files" *ngIf="hasFiles()">\n                    <div *ngIf="!fileTemplate">\n                        <div class="ui-fileupload-row" *ngFor="let file of files; let i = index;">\n                            <div><img [src]="file.objectURL" *ngIf="isImage(file)" [width]="previewWidth" /></div>\n                            <div>{{file.name}}</div>\n                            <div>{{formatSize(file.size)}}</div>\n                            <div>\n                                <button type="button" icon="pi pi-times" pButton (click)="remove($event,i)" [disabled]="uploading"></button>\n                            </div>\n                        </div>\n                    </div>\n                    <div *ngIf="fileTemplate">\n                        <ng-template ngFor [ngForOf]="files" [ngForTemplate]="fileTemplate"></ng-template>\n                    </div>\n                </div>\n                <ng-container *ngTemplateOutlet="contentTemplate"></ng-container>\n            </div>\n        </div>\n        <span *ngIf="mode === \'basic\'" [ngClass]="{\'ui-button ui-fileupload-choose ui-widget ui-state-default ui-corner-all ui-button-text-icon-left\': true, \n                \'ui-fileupload-choose-selected\': hasFiles(),\'ui-state-focus\': focus, \'ui-state-disabled\':disabled}"\n              [ngStyle]="style" [class]="styleClass" (mouseup)="onSimpleUploaderClick($event)">\n            <span class="ui-button-icon-left pi" [ngClass]="{\'pi-plus\': !hasFiles()||auto, \'pi-upload\': hasFiles()&&!auto}"></span>\n            <span class="ui-button-text ui-clickable">{{auto ? chooseLabel : hasFiles() ? files[0].name : chooseLabel}}</span>\n            <input #basicfileinput type="file" [accept]="accept" [multiple]="multiple" [disabled]="disabled"\n                   (change)="onFileSelect($event)" *ngIf="!hasFiles()" (focus)="onFocus()" (blur)="onBlur()">\n        </span>\n    ',changeDetection:ChangeDetectionStrategy.Default})],FileUpload),SharedModule,ButtonModule,ProgressBarModule,MessagesModule],declarations:[FileUpload]})],FileUploadModule);export{FileUpload,FileUploadModule};