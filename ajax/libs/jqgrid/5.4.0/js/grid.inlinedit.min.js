!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base","./grid.common"],e):e(jQuery)}(function(B){"use strict";B.jgrid.inlineEdit=B.jgrid.inlineEdit||{},B.jgrid.extend({editRow:function(u,e,t,i,r,a,n,o,d){var f={},s=B.makeArray(arguments).slice(1),p=this[0];return"object"===B.type(s[0])?f=s[0]:(void 0!==e&&(f.keys=e),B.isFunction(t)&&(f.oneditfunc=t),B.isFunction(i)&&(f.successfunc=i),void 0!==r&&(f.url=r),void 0!==a&&(f.extraparam=a),B.isFunction(n)&&(f.aftersavefunc=n),B.isFunction(o)&&(f.errorfunc=o),B.isFunction(d)&&(f.afterrestorefunc=d)),f=B.extend(!0,{keys:!1,keyevent:"keydown",onEnter:null,onEscape:null,oneditfunc:null,successfunc:null,url:null,extraparam:{},aftersavefunc:null,errorfunc:null,afterrestorefunc:null,restoreAfterError:!0,mtype:"POST",focusField:!0,saveui:"enable",savetext:B.jgrid.getRegional(p,"defaults.savetext")},B.jgrid.inlineEdit,f),this.each(function(){var a,n,t,o,e,d=0,s=null,l={},c=B(this).jqGrid("getStyleUI",p.p.styleUI+".inlinedit","inputClass",!0);p.grid&&!1!==(t=B(p).jqGrid("getInd",u,!0))&&(p.p.beforeAction=!0,void 0===(e=B.isFunction(f.beforeEditRow)?f.beforeEditRow.call(p,f,u):void 0)&&(e=!0),e?"0"!==(B(t).attr("editable")||"0")||B(t).hasClass("not-editable-row")||(o=p.p.colModel,B('td[role="gridcell"]',t).each(function(t){a=o[t].name;var e=!0===p.p.treeGrid&&a===p.p.ExpandColumn;if(e)n=B("span:first",this).html();else try{n=B.unformat.call(p,this,{rowId:u,colModel:o[t]},t)}catch(e){n=o[t].edittype&&"textarea"===o[t].edittype?B(this).text():B(this).html()}if("cb"!==a&&"subgrid"!==a&&"rn"!==a&&(p.p.autoencode&&(n=B.jgrid.htmlDecode(n)),l[a]=n,!0===o[t].editable)){null===s&&(s=t),e?B("span:first",this).html(""):B(this).html("");var i=B.extend({},o[t].editoptions||{},{id:u+"_"+a,name:a,rowId:u,oper:"edit",module:"inline"});o[t].edittype||(o[t].edittype="text"),("&nbsp;"===n||"&#160;"===n||1===n.length&&160===n.charCodeAt(0))&&(n="");var r=B.jgrid.createEl.call(p,o[t].edittype,i,n,!0,B.extend({},B.jgrid.ajaxOptions,p.p.ajaxSelectOptions||{}));B(r).addClass("editable inline-edit-cell"),-1<B.inArray(o[t].edittype,["text","textarea","password","select"])&&B(r).addClass(c),e?B("span:first",this).append(r):B(this).append(r),B.jgrid.bindEv.call(p,r,i),"select"===o[t].edittype&&void 0!==o[t].editoptions&&!0===o[t].editoptions.multiple&&void 0===o[t].editoptions.dataUrl&&B.jgrid.msie()&&B(r).width(B(r).width()),d++}}),0<d&&(l.id=u,p.p.savedRow.push(l),B(t).attr("editable","1"),f.focusField&&("number"==typeof f.focusField&&parseInt(f.focusField,10)<=o.length&&(s=f.focusField),setTimeout(function(){var e=B("td:eq("+s+") :input:visible",t).not(":disabled");0<e.length&&e.focus()},0)),!0===f.keys&&B(t).on(f.keyevent,function(e){if(27===e.keyCode){if(B.isFunction(f.onEscape))return f.onEscape.call(p,u,f,e),!0;if(B(p).jqGrid("restoreRow",u,f),p.p.inlineNav)try{B(p).jqGrid("showAddEditButtons")}catch(e){}return!1}if(13===e.keyCode){if("TEXTAREA"===e.target.tagName)return!0;if(B.isFunction(f.onEnter))return f.onEnter.call(p,u,f,e),!0;if(B(p).jqGrid("saveRow",u,f)&&p.p.inlineNav)try{B(p).jqGrid("showAddEditButtons")}catch(e){}return!1}}),B(p).triggerHandler("jqGridInlineEditRow",[u,f]),B.isFunction(f.oneditfunc)&&f.oneditfunc.call(p,u))):p.p.beforeAction=!1)})},saveRow:function(n,e,t,i,r,a,o){var d=B.makeArray(arguments).slice(1),s={},l=this[0];"object"===B.type(d[0])?s=d[0]:(B.isFunction(e)&&(s.successfunc=e),void 0!==t&&(s.url=t),void 0!==i&&(s.extraparam=i),B.isFunction(r)&&(s.aftersavefunc=r),B.isFunction(a)&&(s.errorfunc=a),B.isFunction(o)&&(s.afterrestorefunc=o)),s=B.extend(!0,{successfunc:null,url:null,extraparam:{},aftersavefunc:null,errorfunc:null,afterrestorefunc:null,restoreAfterError:!0,mtype:"POST",saveui:"enable",savetext:B.jgrid.getRegional(l,"defaults.savetext")},B.jgrid.inlineEdit,s);var c,u,f,p,v,m=!1,g={},w={},j={},h=!1,y=B.trim(B(l).jqGrid("getStyleUI",l.p.styleUI+".common","error",!0));if(!l.grid)return m;if(!1===(v=B(l).jqGrid("getInd",n,!0)))return m;var q=B.jgrid.getRegional(l,"errors"),x=B.jgrid.getRegional(l,"edit"),R=B.isFunction(s.beforeSaveRow)?s.beforeSaveRow.call(l,s,n):void 0;if(void 0===R&&(R=!0),R){if(u=B(v).attr("editable"),s.url=s.url||l.p.editurl,"1"===u){var b,I,_;if(B('td[role="gridcell"]',v).each(function(e){if(b=l.p.colModel[e],c=b.name,_="","cb"!==c&&"subgrid"!==c&&!0===b.editable&&"rn"!==c&&!B(this).hasClass("not-editable-cell")){switch(b.edittype){case"checkbox":var t=["Yes","No"];b.editoptions&&b.editoptions.value&&(t=b.editoptions.value.split(":")),g[c]=B("input",this).is(":checked")?t[0]:t[1],_=B("input",this);break;case"text":case"password":case"textarea":case"button":g[c]=B("input, textarea",this).val(),_=B("input, textarea",this);break;case"select":if(b.editoptions.multiple){var i=B("select",this),r=[];g[c]=B(i).val(),g[c]?g[c]=g[c].join(","):g[c]="",B("select option:selected",this).each(function(e,t){r[e]=B(t).text()}),w[c]=r.join(",")}else g[c]=B("select option:selected",this).val(),w[c]=B("select option:selected",this).text();b.formatter&&"select"===b.formatter&&(w={}),_=B("select",this);break;case"custom":try{if(!b.editoptions||!B.isFunction(b.editoptions.custom_value))throw"e1";if(g[c]=b.editoptions.custom_value.call(l,B(".customelement",this),"get"),void 0===g[c])throw"e2"}catch(e){"e1"===e?B.jgrid.info_dialog(q.errcap,"function 'custom_value' "+x.msg.nodefined,x.bClose,{styleUI:l.p.styleUI}):B.jgrid.info_dialog(q.errcap,e.message,x.bClose,{styleUI:l.p.styleUI})}}if(!1===(p=B.jgrid.checkValues.call(l,g[c],e))[0])return I=e,!1;l.p.autoencode&&(g[c]=B.jgrid.htmlEncode(g[c])),"clientArray"!==s.url&&b.editoptions&&!0===b.editoptions.NullIfEmpty&&""===g[c]&&(j[c]="null",h=!0)}}),!1===p[0]){try{if(B.isFunction(l.p.validationCell))l.p.validationCell.call(l,_,p[1],v.rowIndex,I);else{var G=B(l).jqGrid("getGridRowById",n),A=B.jgrid.findPos(G);B.jgrid.info_dialog(q.errcap,p[1],x.bClose,{left:A[0],top:A[1]+B(G).outerHeight(),styleUI:l.p.styleUI,onClose:function(){0<=I&&B("#"+n+"_"+l.p.colModel[I].name).focus()}})}}catch(e){alert(p[1])}return m}var C,D=l.p.prmNames,P=n;if(C=!1===l.p.keyName?D.id:l.p.keyName,g){if(g[D.oper]=D.editoper,void 0===g[C]||""===g[C])g[C]=n;else if(v.id!==l.p.idPrefix+g[C]){var E=B.jgrid.stripPref(l.p.idPrefix,n);if(void 0!==l.p._index[E]&&(l.p._index[g[C]]=l.p._index[E],delete l.p._index[E]),n=l.p.idPrefix+g[C],B(v).attr("id",n),l.p.selrow===P&&(l.p.selrow=n),B.isArray(l.p.selarrrow)){var F=B.inArray(P,l.p.selarrrow);0<=F&&(l.p.selarrrow[F]=n)}if(l.p.multiselect){var k="jqg_"+l.p.id+"_"+n;B("input.cbox",v).attr("id",k).attr("name",k)}}void 0===l.p.inlineData&&(l.p.inlineData={}),g=B.extend({},g,l.p.inlineData,s.extraparam)}if("clientArray"===s.url){g=B.extend({},g,w),l.p.autoencode&&B.each(g,function(e,t){g[e]=B.jgrid.htmlDecode(t)});var S,U=B(l).jqGrid("setRowData",n,g);for(B(v).attr("editable","0"),S=0;S<l.p.savedRow.length;S++)if(String(l.p.savedRow[S].id)===String(P)){f=S;break}B(l).triggerHandler("jqGridInlineAfterSaveRow",[n,U,g,s]),B.isFunction(s.aftersavefunc)&&s.aftersavefunc.call(l,n,U,g,s),0<=f&&l.p.savedRow.splice(f,1),m=!0,B(v).removeClass("jqgrid-new-row").off("keydown")}else B(l).jqGrid("progressBar",{method:"show",loadtype:s.saveui,htmlcontent:s.savetext}),(j=B.extend({},g,j))[C]=B.jgrid.stripPref(l.p.idPrefix,j[C]),B.ajax(B.extend({url:s.url,data:B.isFunction(l.p.serializeRowData)?l.p.serializeRowData.call(l,j):j,type:s.mtype,async:!1,complete:function(e,t){if(B(l).jqGrid("progressBar",{method:"hide",loadtype:s.saveui,htmlcontent:s.savetext}),"success"===t){var i,r,a=!0;if(i=B(l).triggerHandler("jqGridInlineSuccessSaveRow",[e,n,s]),B.isArray(i)||(i=[!0,j]),i[0]&&B.isFunction(s.successfunc)&&(i=s.successfunc.call(l,e)),B.isArray(i)?(a=i[0],g=i[1]||g):a=i,!0===a){for(l.p.autoencode&&B.each(g,function(e,t){g[e]=B.jgrid.htmlDecode(t)}),h&&B.each(g,function(e){"null"===g[e]&&(g[e]="")}),g=B.extend({},g,w),B(l).jqGrid("setRowData",n,g),B(v).attr("editable","0"),r=0;r<l.p.savedRow.length;r++)if(String(l.p.savedRow[r].id)===String(n)){f=r;break}B(l).triggerHandler("jqGridInlineAfterSaveRow",[n,e,g,s]),B.isFunction(s.aftersavefunc)&&s.aftersavefunc.call(l,n,e,g,s),0<=f&&l.p.savedRow.splice(f,1),m=!0,B(v).removeClass("jqgrid-new-row").off("keydown")}else B(l).triggerHandler("jqGridInlineErrorSaveRow",[n,e,t,null,s]),B.isFunction(s.errorfunc)&&s.errorfunc.call(l,n,e,t,null),!0===s.restoreAfterError&&B(l).jqGrid("restoreRow",n,s)}},error:function(e,t,i){if(B("#lui_"+B.jgrid.jqID(l.p.id)).hide(),B(l).triggerHandler("jqGridInlineErrorSaveRow",[n,e,t,i,s]),B.isFunction(s.errorfunc))s.errorfunc.call(l,n,e,t,i);else{var r=e.responseText||e.statusText;try{B.jgrid.info_dialog(q.errcap,'<div class="'+y+'">'+r+"</div>",x.bClose,{buttonalign:"right",styleUI:l.p.styleUI})}catch(e){alert(r)}}!0===s.restoreAfterError&&B(l).jqGrid("restoreRow",n,s)}},B.jgrid.ajaxOptions,l.p.ajaxRowOptions||{}))}return m}},restoreRow:function(o,e){var t=B.makeArray(arguments).slice(1),d={};return"object"===B.type(t[0])?d=t[0]:B.isFunction(e)&&(d.afterrestorefunc=e),d=B.extend(!0,{},B.jgrid.inlineEdit,d),this.each(function(){var e,t,i=this,r=-1,a={};if(i.grid&&!1!==(e=B(i).jqGrid("getInd",o,!0))){var n=B.isFunction(d.beforeCancelRow)?d.beforeCancelRow.call(i,d,o):void 0;if(void 0===n&&(n=!0),n){for(t=0;t<i.p.savedRow.length;t++)if(String(i.p.savedRow[t].id)===String(o)){r=t;break}if(0<=r){if(B.isFunction(B.fn.datepicker))try{B("input.hasDatepicker","#"+B.jgrid.jqID(e.id)).datepicker("hide")}catch(e){}B.each(i.p.colModel,function(){i.p.savedRow[r].hasOwnProperty(this.name)&&(a[this.name]=i.p.savedRow[r][this.name])}),B(i).jqGrid("setRowData",o,a),B(e).attr("editable","0").off("keydown"),i.p.savedRow.splice(r,1),B("#"+B.jgrid.jqID(o),"#"+B.jgrid.jqID(i.p.id)).hasClass("jqgrid-new-row")&&setTimeout(function(){B(i).jqGrid("delRowData",o),B(i).jqGrid("showAddEditButtons")},0)}B(i).triggerHandler("jqGridInlineAfterRestoreRow",[o]),B.isFunction(d.afterrestorefunc)&&d.afterrestorefunc.call(i,o)}}})},addRow:function(a){return a=B.extend(!0,{rowID:null,initdata:{},position:"first",useDefValues:!0,useFormatter:!1,addRowParams:{extraparam:{}}},a||{}),this.each(function(){if(this.grid){var i=this;i.p.beforeAction=!0;var e=B.isFunction(a.beforeAddRow)?a.beforeAddRow.call(i,a.addRowParams):void 0;if(void 0===e&&(e=!0),e)if(a.rowID=B.isFunction(a.rowID)?a.rowID.call(i,a):null!=a.rowID?a.rowID:B.jgrid.randId(),!0===a.useDefValues&&B(i.p.colModel).each(function(){if(this.editoptions&&this.editoptions.defaultValue){var e=this.editoptions.defaultValue,t=B.isFunction(e)?e.call(i):e;a.initdata[this.name]=t}}),B(i).jqGrid("addRowData",a.rowID,a.initdata,a.position),a.rowID=i.p.idPrefix+a.rowID,B("#"+B.jgrid.jqID(a.rowID),"#"+B.jgrid.jqID(i.p.id)).addClass("jqgrid-new-row"),a.useFormatter)B("#"+B.jgrid.jqID(a.rowID)+" .ui-inline-edit","#"+B.jgrid.jqID(i.p.id)).click();else{var t=i.p.prmNames,r=t.oper;a.addRowParams.extraparam[r]=t.addoper,B(i).jqGrid("editRow",a.rowID,a.addRowParams),B(i).jqGrid("setSelection",a.rowID)}else i.p.beforeAction=!1}})},inlineNav:function(n,o){var d=this[0],s=B.jgrid.getRegional(d,"nav"),e=B.jgrid.styleUI[d.p.styleUI].inlinedit;return o=B.extend(!0,{edit:!0,editicon:e.icon_edit_nav,add:!0,addicon:e.icon_add_nav,save:!0,saveicon:e.icon_save_nav,cancel:!0,cancelicon:e.icon_cancel_nav,addParams:{addRowParams:{extraparam:{}}},editParams:{},restoreAfterSelect:!0,saveAfterSelect:!1},s,o||{}),this.each(function(){if(this.grid&&!this.p.inlineNav){var a=B.jgrid.jqID(d.p.id),t=B.trim(B(d).jqGrid("getStyleUI",d.p.styleUI+".common","disabled",!0));if(d.p.navGrid||B(d).jqGrid("navGrid",n,{refresh:!1,edit:!1,add:!1,del:!1,search:!1,view:!1}),B(d).data("inlineNav")||B(d).data("inlineNav",o),d.p.force_regional&&(o=B.extend(o,s)),(d.p.inlineNav=!0)===o.addParams.useFormatter){var e,i=d.p.colModel;for(e=0;e<i.length;e++)if(i[e].formatter&&"actions"===i[e].formatter){if(i[e].formatoptions){var r=B.extend({keys:!1,onEdit:null,onSuccess:null,afterSave:null,onError:null,afterRestore:null,extraparam:{},url:null},i[e].formatoptions);o.addParams.addRowParams={keys:r.keys,oneditfunc:r.onEdit,successfunc:r.onSuccess,url:r.url,extraparam:r.extraparam,aftersavefunc:r.afterSave,errorfunc:r.onError,afterrestorefunc:r.afterRestore}}break}}o.add&&B(d).jqGrid("navButtonAdd",n,{caption:o.addtext,title:o.addtitle,buttonicon:o.addicon,id:d.p.id+"_iladd",internal:!0,onClickButton:function(){void 0===d.p.beforeAction&&(d.p.beforeAction=!0),B(d).jqGrid("addRow",o.addParams),!o.addParams.useFormatter&&d.p.beforeAction&&(B("#"+a+"_ilsave").removeClass(t),B("#"+a+"_ilcancel").removeClass(t),B("#"+a+"_iladd").addClass(t),B("#"+a+"_iledit").addClass(t))}}),o.edit&&B(d).jqGrid("navButtonAdd",n,{caption:o.edittext,title:o.edittitle,buttonicon:o.editicon,id:d.p.id+"_iledit",internal:!0,onClickButton:function(){var e=B(d).jqGrid("getGridParam","selrow");e?(void 0===d.p.beforeAction&&(d.p.beforeAction=!0),B(d).jqGrid("editRow",e,o.editParams),d.p.beforeAction&&(B("#"+a+"_ilsave").removeClass(t),B("#"+a+"_ilcancel").removeClass(t),B("#"+a+"_iladd").addClass(t),B("#"+a+"_iledit").addClass(t))):(B.jgrid.viewModal("#alertmod_"+a,{gbox:"#gbox_"+a,jqm:!0}),B("#jqg_alrt").focus())}}),o.save&&(B(d).jqGrid("navButtonAdd",n,{caption:o.savetext||"",title:o.savetitle||"Save row",buttonicon:o.saveicon,id:d.p.id+"_ilsave",internal:!0,onClickButton:function(){var e=d.p.savedRow[0].id;if(e){var t=d.p.prmNames,i=t.oper,r=o.editParams;B("#"+B.jgrid.jqID(e),"#"+a).hasClass("jqgrid-new-row")?(o.addParams.addRowParams.extraparam[i]=t.addoper,r=o.addParams.addRowParams):(o.editParams.extraparam||(o.editParams.extraparam={}),o.editParams.extraparam[i]=t.editoper),B(d).jqGrid("saveRow",e,r)&&B(d).jqGrid("showAddEditButtons")}else B.jgrid.viewModal("#alertmod_"+a,{gbox:"#gbox_"+a,jqm:!0}),B("#jqg_alrt").focus()}}),B("#"+a+"_ilsave").addClass(t)),o.cancel&&(B(d).jqGrid("navButtonAdd",n,{caption:o.canceltext||"",title:o.canceltitle||"Cancel row editing",buttonicon:o.cancelicon,id:d.p.id+"_ilcancel",internal:!0,onClickButton:function(){var e=d.p.savedRow[0].id,t=o.editParams;e?(B("#"+B.jgrid.jqID(e),"#"+a).hasClass("jqgrid-new-row")&&(t=o.addParams.addRowParams),B(d).jqGrid("restoreRow",e,t),B(d).jqGrid("showAddEditButtons")):(B.jgrid.viewModal("#alertmod",{gbox:"#gbox_"+a,jqm:!0}),B("#jqg_alrt").focus())}}),B("#"+a+"_ilcancel").addClass(t)),!0!==o.restoreAfterSelect&&!0!==o.saveAfterSelect||B(d).on("jqGridBeforeSelectRow.inlineNav",function(e,t){if(0<d.p.savedRow.length&&!0===d.p.inlineNav&&t!==d.p.selrow&&null!==d.p.selrow){var i=!0;d.p.selrow===o.addParams.rowID?B(d).jqGrid("delRowData",d.p.selrow):!0===o.restoreAfterSelect?B(d).jqGrid("restoreRow",d.p.selrow,o.editParams):i=B(d).jqGrid("saveRow",d.p.selrow,o.editParams),i&&B(d).jqGrid("showAddEditButtons")}})}})},showAddEditButtons:function(){return this.each(function(){if(this.grid){var e=B.jgrid.jqID(this.p.id),t=B.trim(B(this).jqGrid("getStyleUI",this.p.styleUI+".common","disabled",!0));B("#"+e+"_ilsave").addClass(t),B("#"+e+"_ilcancel").addClass(t),B("#"+e+"_iladd").removeClass(t),B("#"+e+"_iledit").removeClass(t)}})},showSaveCancelButtons:function(){return this.each(function(){if(this.grid){var e=B.jgrid.jqID(this.p.id),t=B.trim(B(this).jqGrid("getStyleUI",this.p.styleUI+".common","disabled",!0));B("#"+e+"_ilsave").removeClass(t),B("#"+e+"_ilcancel").removeClass(t),B("#"+e+"_iladd").addClass(t),B("#"+e+"_iledit").addClass(t)}})}})});