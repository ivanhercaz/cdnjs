!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base","./grid.grouping"],e):e(jQuery)}(function(B){"use strict";B.assocArraySize=function(e){var r,o=0;for(r in e)e.hasOwnProperty(r)&&o++;return o},B.jgrid.extend({pivotSetup:function(N,e){var k=[],G=[],M=[],z=[],A=[],V={grouping:!0,groupingView:{groupField:[],groupSummary:[],groupSummaryPos:[]}},q=[],Q=B.extend({rowTotals:!1,rowTotalsText:"Total",colTotals:!1,groupSummary:!0,groupSummaryPos:"header",frozenStaticCols:!1},e||{});return this.each(function(){var e,h,r,p,f,d,o,t,n,i=this,a=N.length,s=0;function l(e,r,o){var t;return 0<(t=function(e,r){var o,t,n,a=[];if(!this||"function"!=typeof e||e instanceof RegExp)throw new TypeError;for(n=this.length,o=0;o<n;o++)if(this.hasOwnProperty(o)&&(t=this[o],e.call(r,t,o,this))){a.push(t);break}return a}.call(e,r,o)).length?t[0]:null}function g(e,r){var o,t=0,n=!0;for(o in e)if(e.hasOwnProperty(o)){if(e[o]!=this[t]){n=!1;break}if(++t>=this.length)break}return n&&(h=r),n}function v(e,r,o,t,n){var a;if(B.isFunction(e))a=e.call(i,r,o,t);else switch(e){case"sum":a=parseFloat(r||0)+parseFloat(t[o]||0);break;case"count":""!==r&&null!=r||(r=0),a=t.hasOwnProperty(o)?r+1:0;break;case"min":a=""===r||null==r?parseFloat(t[o]||0):Math.min(parseFloat(r),parseFloat(t[o]||0));break;case"max":a=""===r||null==r?parseFloat(t[o]||0):Math.max(parseFloat(r),parseFloat(t[o]||0));break;case"avg":a=(parseFloat(r||0)*(n-1)+parseFloat(t[o]||0))/n}return a}function u(e,r,o,t){var n,a,i,s,l,g,u=r.length,m="",p=[],f=1;for(B.isArray(o)?(s=o.length,p=o):(s=1,p[0]=o),A=[],i=(z=[]).root=0;i<s;i++){var d,c=[];for(n=0;n<u;n++){if(l="string"==typeof r[n].aggregator?r[n].aggregator:"cust",null==o)d=a=B.trim(r[n].member)+"_"+l,p[0]=r[n].label||l+" "+B.trim(r[n].member);else{d=o[i].replace(/\s+/g,"");try{a=1===u?m+d:m+d+"_"+l+"_"+String(n)}catch(e){}p[i]=o[i]}a=isNaN(parseInt(a,10))?a:a+" ","avg"===r[n].aggregator&&(g=-1===h?G.length+"_"+a:h+"_"+a,x[g]?x[g]++:x[g]=1,f=x[g]),t[a]=c[a]=v(r[n].aggregator,t[a],r[n].member,e,f)}m+=o&&null!=o[i]?o[i].replace(/\s+/g,""):"",z[a]=c,A[a]=p[i]}return t}if(Q.rowTotals&&0<Q.yDimension.length){var m=Q.yDimension[0].dataName;Q.yDimension.splice(0,0,{dataName:m}),Q.yDimension[0].converter=function(){return"_r_Totals"}}if(p=B.isArray(Q.xDimension)?Q.xDimension.length:0,f=Q.yDimension.length,d=B.isArray(Q.aggregates)?Q.aggregates.length:0,0===p||0===d)throw"xDimension or aggregates optiona are not set!";for(r=0;r<p;r++)n={name:Q.xDimension[r].dataName,frozen:Q.frozenStaticCols},null==Q.xDimension[r].isGroupField&&(Q.xDimension[r].isGroupField=!0),n=B.extend(!0,n,Q.xDimension[r]),k.push(n);for(var c=p-1,y={},x=[];s<a;){e=N[s];var D=[],b=[];for(o={},r=0;D[r]=B.trim(e[Q.xDimension[r].dataName]),o[Q.xDimension[r].dataName]=D[r],++r<p;);var w=0;if(h=-1,t=l(G,g,D)){if(0<=h){if(w=0,1<=f){for(w=0;w<f;w++)b[w]=B.trim(e[Q.yDimension[w].dataName]),Q.yDimension[w].converter&&B.isFunction(Q.yDimension[w].converter)&&(b[w]=Q.yDimension[w].converter.call(this,b[w],D,b));t=u(e,Q.aggregates,b,t)}else 0===f&&(t=u(e,Q.aggregates,null,t));G[h]=t}}else{if(w=0,1<=f){for(w=0;w<f;w++)b[w]=B.trim(e[Q.yDimension[w].dataName]),Q.yDimension[w].converter&&B.isFunction(Q.yDimension[w].converter)&&(b[w]=Q.yDimension[w].converter.call(this,b[w],D,b));o=u(e,Q.aggregates,b,o)}else 0===f&&(o=u(e,Q.aggregates,null,o));G.push(o)}var F,O=0,j=null,S=null;for(F in z)if(z.hasOwnProperty(F)){if(0===O)y.children&&void 0!==y.children||(y={text:F,level:0,children:[],label:F}),j=y.children;else{for(S=null,r=0;r<j.length;r++)if(j[r].text===F){S=j[r];break}j=S?S.children:(j.push({children:[],text:F,level:O,fields:z[F],label:A[F]}),j[j.length-1].children)}O++}s++}x=null;var T,C=[],P=k.length,_=P;if(0<f&&(q[f-1]={useColSpanStyle:!1,groupHeaders:[]}),function e(r){var o,t,n,a,i;for(n in r)if(r.hasOwnProperty(n)){if("object"!=typeof r[n]){if("level"===n){if(void 0===C[r.level]&&(C[r.level]="",0<r.level&&-1===r.text.indexOf("_r_Totals")&&(q[r.level-1]={useColSpanStyle:!1,groupHeaders:[]})),C[r.level]!==r.text&&r.children.length&&-1===r.text.indexOf("_r_Totals")&&0<r.level){q[r.level-1].groupHeaders.push({titleText:r.label,numberOfColumns:0});var s=q[r.level-1].groupHeaders.length-1,l=0==s?_:P;if(r.level-1==(Q.rowTotals?1:0)&&0<s){for(var g=0,u=0;u<s;u++)g+=q[r.level-1].groupHeaders[u].numberOfColumns;g&&(l=g+p)}k[l]&&(q[r.level-1].groupHeaders[s].startColumnName=k[l].name,q[r.level-1].groupHeaders[s].numberOfColumns=k.length-l),P=k.length}C[r.level]=r.text}if(r.level===f&&"level"===n&&0<f)if(1<d){var m=1;for(o in r.fields)r.fields.hasOwnProperty(o)&&(1===m&&q[f-1].groupHeaders.push({startColumnName:o,numberOfColumns:1,titleText:r.label||r.text}),m++);q[f-1].groupHeaders[q[f-1].groupHeaders.length-1].numberOfColumns=m-1}else q.splice(f-1,1)}if(null!=r[n]&&"object"==typeof r[n]&&e(r[n]),"level"===n&&0<r.level&&(r.level===(0===f?r.level:f)||-1!==C[r.level].indexOf("_r_Totals")))for(o in t=0,r.fields)if(r.fields.hasOwnProperty(o)){for(a in i={},Q.aggregates[t])if(Q.aggregates[t].hasOwnProperty(a))switch(a){case"member":case"label":case"aggregator":break;default:i[a]=Q.aggregates[t][a]}1<d?(i.name=o,i.label=Q.aggregates[t].label||r.label):(i.name=r.text,i.label="_r_Totals"===r.text?Q.rowTotalsText:r.label),k.push(i),t++}}}(y),Q.colTotals)for(var H=G.length;H--;)for(r=p;r<k.length;r++)T=k[r].name,M[T]?M[T]+=parseFloat(G[H][T]||0):M[T]=parseFloat(G[H][T]||0);if(0<c)for(r=0;r<c;r++)k[r].isGroupField&&(V.groupingView.groupField.push(k[r].name),V.groupingView.groupSummary.push(Q.groupSummary),V.groupingView.groupSummaryPos.push(Q.groupSummaryPos));else V.grouping=!1;V.sortname=k[c].name,V.groupingView.hideFirstGroupCol=!0}),{colModel:k,rows:G,groupOptions:V,groupHeaders:q,summary:M}},jqPivot:function(o,u,m,t){return this.each(function(){var g=this,e=m.regional?m.regional:"en";function r(e){B.isFunction(u.onInitPivot)&&u.onInitPivot.call(g),B.isArray(e)||(e=[]);var r,o,t,n,a=jQuery(g).jqGrid("pivotSetup",e,u),i=0<B.assocArraySize(a.summary),s=B.jgrid.from.call(g,a.rows);for(u.ignoreCase&&(s=s.ignoreCase()),r=0;r<a.groupOptions.groupingView.groupField.length;r++)o=u.xDimension[r].sortorder?u.xDimension[r].sortorder:"asc",t=u.xDimension[r].sorttype?u.xDimension[r].sorttype:"text",s.orderBy(a.groupOptions.groupingView.groupField[r],o,t,"",t);if(n=u.xDimension.length,m.sortname){for(o=m.sortorder?m.sortorder:"asc",t="text",r=0;r<n;r++)if(u.xDimension[r].dataName===m.sortname){t=u.xDimension[r].sorttype?u.xDimension[r].sorttype:"text";break}s.orderBy(m.sortname,o,t,"",t)}else a.groupOptions.sortname&&n&&(o=u.xDimension[n-1].sortorder?u.xDimension[n-1].sortorder:"asc",t=u.xDimension[n-1].sorttype?u.xDimension[n-1].sorttype:"text",s.orderBy(a.groupOptions.sortname,o,t,"",t));jQuery(g).jqGrid(B.extend(!0,{datastr:B.extend(s.select(),i?{userdata:a.summary}:{}),datatype:"jsonstring",footerrow:i,userDataOnFooter:i,colModel:a.colModel,viewrecords:!0,sortname:u.xDimension[0].dataName},a.groupOptions,m||{}));var l=a.groupHeaders;if(l.length)for(r=0;r<l.length;r++)l[r]&&l[r].groupHeaders.length&&jQuery(g).jqGrid("setGroupHeaders",l[r]);u.frozenStaticCols&&jQuery(g).jqGrid("setFrozenColumns"),B.isFunction(u.onCompletePivot)&&u.onCompletePivot.call(g),u.loadMsg&&B(".loading_pivot").remove()}void 0===u.loadMsg&&(u.loadMsg=!0),u.loadMsg&&B("<div class='loading_pivot ui-state-default ui-state-active row'>"+B.jgrid.getRegional(g,"regional."+e+".defaults.loadtext")+"</div>").insertBefore(g).show(),"string"==typeof o?B.ajax(B.extend({url:o,dataType:"json",success:function(e){r(B.jgrid.getAccessor(e,t&&t.reader?t.reader:"rows"))}},t||{})):r(o)})}})});