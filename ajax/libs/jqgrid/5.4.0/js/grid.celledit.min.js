!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base"],e):e(jQuery)}(function(x){"use strict";x.jgrid.extend({editCell:function(f,u,v,w){return this.each(function(){var e,i,l,t,r=this,o=x(this).jqGrid("getStyleUI",r.p.styleUI+".common","highlight",!0),d=x(this).jqGrid("getStyleUI",r.p.styleUI+".common","hover",!0),s=x(this).jqGrid("getStyleUI",r.p.styleUI+".celledit","inputClass",!0);if(r.grid&&!0===r.p.cellEdit){if(u=parseInt(u,10),r.p.selrow=r.rows[f].id,r.p.knv||x(r).jqGrid("GridNav"),0<r.p.savedRow.length){if(!0===v&&f==r.p.iRow&&u==r.p.iCol)return;x(r).jqGrid("saveCell",r.p.savedRow[0].id,r.p.savedRow[0].ic)}else window.setTimeout(function(){x("#"+x.jgrid.jqID(r.p.knv)).attr("tabindex","-1").focus()},1);if("subgrid"!==(e=(t=r.p.colModel[u]).name)&&"cb"!==e&&"rn"!==e){try{l=x(r.rows[f].cells[u])}catch(e){l=x("td:eq("+u+")",r.rows[f])}if(0<=parseInt(r.p.iCol,10)&&0<=parseInt(r.p.iRow,10)&&void 0!==r.p.iRowId){var a=x(r).jqGrid("getGridRowById",r.p.iRowId);x(a).removeClass("selected-row "+d).find("td:eq("+r.p.iCol+")").removeClass("edit-cell "+o)}if(l.addClass("edit-cell "+o),x(r.rows[f]).addClass("selected-row "+d),!0!==t.editable||!0!==v||l.hasClass("not-editable-cell")||x.isFunction(r.p.isCellEditable)&&!r.p.isCellEditable.call(r,e,f,u))i=l.html().replace(/\&#160\;/gi,""),x(r).triggerHandler("jqGridCellSelect",[r.rows[f].id,u,i,w]),x.isFunction(r.p.onCellSelect)&&r.p.onCellSelect.call(r,r.rows[f].id,u,i,w);else{try{i=x.unformat.call(r,l,{rowId:r.rows[f].id,colModel:t},u)}catch(e){i=t.edittype&&"textarea"===t.edittype?l.text():l.html()}if(r.p.autoencode&&(i=x.jgrid.htmlDecode(i)),t.edittype||(t.edittype="text"),r.p.savedRow.push({id:f,ic:u,name:e,v:i,rowId:r.rows[f].id}),("&nbsp;"===i||"&#160;"===i||1===i.length&&160===i.charCodeAt(0))&&(i=""),x.isFunction(r.p.formatCell)){var n=r.p.formatCell.call(r,r.rows[f].id,e,i,f,u);void 0!==n&&(i=n)}x(r).triggerHandler("jqGridBeforeEditCell",[r.rows[f].id,e,i,f,u]),x.isFunction(r.p.beforeEditCell)&&r.p.beforeEditCell.call(r,r.rows[f].id,e,i,f,u);var p=x.extend({},t.editoptions||{},{id:f+"_"+e,name:e,rowId:r.rows[f].id,oper:"edit",module:"cell"}),c=x.jgrid.createEl.call(r,t.edittype,p,i,!0,x.extend({},x.jgrid.ajaxOptions,r.p.ajaxSelectOptions||{}));-1<x.inArray(t.edittype,["text","textarea","password","select"])&&x(c).addClass(s),l.html("").append(c).attr("tabindex","0"),x.jgrid.bindEv.call(r,c,p),window.setTimeout(function(){x(c).focus()},1),x("input, select, textarea",l).on("keydown",function(e){if(27===e.keyCode&&(0<x("input.hasDatepicker",l).length?x(".ui-datepicker").is(":hidden")?x(r).jqGrid("restoreCell",f,u):x("input.hasDatepicker",l).datepicker("hide"):x(r).jqGrid("restoreCell",f,u)),13===e.keyCode&&!e.shiftKey)return x(r).jqGrid("saveCell",f,u),!1;if(9===e.keyCode){if(r.grid.hDiv.loading)return!1;e.shiftKey?!x(r).jqGrid("prevCell",f,u,e)&&r.p.editNextRowCell&&0<f-1&&r.rows[f-1]&&(f--,x(r).jqGrid("prevCell",f,r.p.colModel.length,e)):!x(r).jqGrid("nextCell",f,u,e)&&r.p.editNextRowCell&&r.rows[f+1]&&(f++,x(r).jqGrid("nextCell",f,0,e))}e.stopPropagation()}),x(r).triggerHandler("jqGridAfterEditCell",[r.rows[f].id,e,i,f,u]),x.isFunction(r.p.afterEditCell)&&r.p.afterEditCell.call(r,r.rows[f].id,e,i,f,u)}r.p.iCol=u,r.p.iRow=f,r.p.iRowId=r.rows[f].id}}})},saveCell:function(q,G){return this.each(function(){var t=this,r=1<=t.p.savedRow.length?0:null,o=x.jgrid.getRegional(this,"errors"),d=x.jgrid.getRegional(this,"edit");if(t.grid&&!0===t.p.cellEdit){if(null!==r){var s,a,n=x(t).jqGrid("getGridRowById",t.p.savedRow[0].rowId),p=x("td:eq("+G+")",n),e=t.p.colModel[G],c=e.name,f=x.jgrid.jqID(c),u=x(p).offset();switch(e.edittype){case"select":if(e.editoptions.multiple){var i=x("#"+q+"_"+f,n),l=[];(s=x(i).val())?s.join(","):s="",x("option:selected",i).each(function(e,i){l[e]=x(i).text()}),a=l.join(",")}else s=x("#"+q+"_"+f+" option:selected",n).val(),a=x("#"+q+"_"+f+" option:selected",n).text();e.formatter&&(a=s);break;case"checkbox":var v=["Yes","No"];e.editoptions&&e.editoptions.value&&(v=e.editoptions.value.split(":")),s=x("#"+q+"_"+f,n).is(":checked")?v[0]:v[1],a=s;break;case"password":case"text":case"textarea":case"button":s=x("#"+q+"_"+f,n).val(),a=s;break;case"custom":try{if(!e.editoptions||!x.isFunction(e.editoptions.custom_value))throw"e1";if(void 0===(s=e.editoptions.custom_value.call(t,x(".customelement",p),"get")))throw"e2";a=s}catch(e){"e1"===e?x.jgrid.info_dialog(o.errcap,"function 'custom_value' "+d.msg.nodefined,d.bClose,{styleUI:t.p.styleUI}):"e2"===e?x.jgrid.info_dialog(o.errcap,"function 'custom_value' "+d.msg.novalue,d.bClose,{styleUI:t.p.styleUI}):x.jgrid.info_dialog(o.errcap,e.message,d.bClose,{styleUI:t.p.styleUI})}}if(a!==t.p.savedRow[r].v){var w=x(t).triggerHandler("jqGridBeforeSaveCell",[t.p.savedRow[r].rowId,c,s,q,G]);if(w&&(a=s=w),x.isFunction(t.p.beforeSaveCell)){var g=t.p.beforeSaveCell.call(t,t.p.savedRow[r].rowId,c,s,q,G);g&&(a=s=g)}var C=x.jgrid.checkValues.call(t,s,G),h=!1;if(!0===C[0]){var j=x(t).triggerHandler("jqGridBeforeSubmitCell",[t.p.savedRow[r].rowId,c,s,q,G])||{};x.isFunction(t.p.beforeSubmitCell)&&(j=(j=t.p.beforeSubmitCell.call(t,t.p.savedRow[r].rowId,c,s,q,G))||{});var b=x(t).triggerHandler("jqGridOnSubmitCell",[t.p.savedRow[r].rowId,c,s,q,G]);if(void 0===b&&(b=!0),x.isFunction(t.p.onSubmitCell)&&void 0===(b=t.p.onSubmitCell(t.p.savedRow[r].rowId,c,s,q,G))&&(b=!0),!1===b)return;if(0<x("input.hasDatepicker",p).length&&x("input.hasDatepicker",p).datepicker("hide"),"remote"===t.p.cellsubmit)if(t.p.cellurl){var m={};t.p.autoencode&&(s=x.jgrid.htmlEncode(s)),e.editoptions&&e.editoptions.NullIfEmpty&&""===s&&(s="null",h=!0),m[c]=s;var y=t.p.prmNames,R=y.id,I=y.oper;m[R]=x.jgrid.stripPref(t.p.idPrefix,t.p.savedRow[r].rowId),m[I]=y.editoper,m=x.extend(j,m),x(t).jqGrid("progressBar",{method:"show",loadtype:t.p.loadui,htmlcontent:x.jgrid.getRegional(t,"defaults.savetext")}),t.grid.hDiv.loading=!0,x.ajax(x.extend({url:t.p.cellurl,data:x.isFunction(t.p.serializeCellData)?t.p.serializeCellData.call(t,m,c):m,type:"POST",complete:function(e,i){if(x(t).jqGrid("progressBar",{method:"hide",loadtype:t.p.loadui}),t.grid.hDiv.loading=!1,"success"===i){var l=x(t).triggerHandler("jqGridAfterSubmitCell",[t,e,m[R],c,s,q,G])||[!0,""];!0===l[0]&&x.isFunction(t.p.afterSubmitCell)&&(l=t.p.afterSubmitCell.call(t,e,m[R],c,s,q,G)),!0===l[0]?(h&&(s=""),x(p).empty(),x(t).jqGrid("setCell",t.p.savedRow[r].rowId,G,a,!1,!1,!0),x(p).addClass("dirty-cell"),x(n).addClass("edited"),x(t).triggerHandler("jqGridAfterSaveCell",[t.p.savedRow[r].rowId,c,s,q,G]),x.isFunction(t.p.afterSaveCell)&&t.p.afterSaveCell.call(t,t.p.savedRow[r].rowId,c,s,q,G),t.p.savedRow.splice(0,1)):(x(t).triggerHandler("jqGridErrorCell",[e,i]),x.isFunction(t.p.errorCell)?t.p.errorCell.call(t,e,i):x.jgrid.info_dialog(o.errcap,l[1],d.bClose,{styleUI:t.p.styleUI,top:u.top+30,left:u.left,onClose:function(){t.p.restoreCellonFail||x("#"+q+"_"+f,n).focus()}}),t.p.restoreCellonFail&&x(t).jqGrid("restoreCell",q,G))}},error:function(e,i,l){x("#lui_"+x.jgrid.jqID(t.p.id)).hide(),t.grid.hDiv.loading=!1,x(t).triggerHandler("jqGridErrorCell",[e,i,l]),x.isFunction(t.p.errorCell)?t.p.errorCell.call(t,e,i,l):x.jgrid.info_dialog(o.errcap,e.status+" : "+e.statusText+"<br/>"+i,d.bClose,{styleUI:t.p.styleUI,top:u.top+30,left:u.left,onClose:function(){t.p.restoreCellonFail||x("#"+q+"_"+f,n).focus()}}),t.p.restoreCellonFail&&x(t).jqGrid("restoreCell",q,G)}},x.jgrid.ajaxOptions,t.p.ajaxCellOptions||{}))}else try{x.jgrid.info_dialog(o.errcap,o.nourl,d.bClose,{styleUI:t.p.styleUI}),t.p.restoreCellonFail&&x(t).jqGrid("restoreCell",q,G)}catch(e){}"clientArray"===t.p.cellsubmit&&(x(p).empty(),x(t).jqGrid("setCell",t.p.savedRow[r].rowId,G,a,!1,!1,!0),x(p).addClass("dirty-cell"),x(n).addClass("edited"),x(t).triggerHandler("jqGridAfterSaveCell",[t.p.savedRow[r].rowId,c,s,q,G]),x.isFunction(t.p.afterSaveCell)&&t.p.afterSaveCell.call(t,t.p.savedRow[r].rowId,c,s,q,G),t.p.savedRow.splice(0,1))}else try{x.isFunction(t.p.validationCell)?t.p.validationCell.call(t,x("#"+q+"_"+f,n),C[1],q,G):(window.setTimeout(function(){x.jgrid.info_dialog(o.errcap,s+" "+C[1],d.bClose,{styleUI:t.p.styleUI,top:u.top+30,left:u.left,onClose:function(){t.p.restoreCellonFail||x("#"+q+"_"+f,n).focus()}})},50),t.p.restoreCellonFail&&x(t).jqGrid("restoreCell",q,G))}catch(e){alert(C[1])}}else x(t).jqGrid("restoreCell",q,G)}window.setTimeout(function(){x("#"+x.jgrid.jqID(t.p.knv)).attr("tabindex","-1").focus()},0)}})},restoreCell:function(r,o){return this.each(function(){var e=this,i=1<=e.p.savedRow.length?0:null;if(e.grid&&!0===e.p.cellEdit){if(null!==i){var l=x(e).jqGrid("getGridRowById",e.p.savedRow[i].rowId),t=x("td:eq("+o+")",l);if(x.isFunction(x.fn.datepicker))try{x("input.hasDatepicker",t).datepicker("hide")}catch(e){}x(t).empty().attr("tabindex","-1"),x(e).jqGrid("setCell",e.p.savedRow[0].rowId,o,e.p.savedRow[i].v,!1,!1,!0),x(e).triggerHandler("jqGridAfterRestoreCell",[e.p.savedRow[i].rowId,e.p.savedRow[i].v,r,o]),x.isFunction(e.p.afterRestoreCell)&&e.p.afterRestoreCell.call(e,e.p.savedRow[i].rowId,e.p.savedRow[i].v,r,o),e.p.savedRow.splice(0,1)}window.setTimeout(function(){x("#"+e.p.knv).attr("tabindex","-1").focus()},0)}})},nextCell:function(t,r,o){var d;return this.each(function(){var e,i=this,l=!1;if(i.grid&&!0===i.p.cellEdit){for(e=r+1;e<i.p.colModel.length;e++)if(!0===i.p.colModel[e].editable&&(!x.isFunction(i.p.isCellEditable)||i.p.isCellEditable.call(i,i.p.colModel[e].name,t,e))){l=e;break}!1!==l?(d=!0,x(i).jqGrid("editCell",t,l,!0,o)):(d=!1,0<i.p.savedRow.length&&x(i).jqGrid("saveCell",t,r))}}),d},prevCell:function(t,r,o){var d;return this.each(function(){var e,i=this,l=!1;if(!i.grid||!0!==i.p.cellEdit)return!1;for(e=r-1;0<=e;e--)if(!0===i.p.colModel[e].editable&&(!x.isFunction(i.p.isCellEditable)||i.p.isCellEditable.call(i,i.p.colModel[e].name,t,e))){l=e;break}!1!==l?(d=!0,x(i).jqGrid("editCell",t,l,!0,o)):(d=!1,0<i.p.savedRow.length&&x(i).jqGrid("saveCell",t,r))}),d},GridNav:function(){return this.each(function(){var c=this;if(c.grid&&!0===c.p.cellEdit){c.p.knv=c.p.id+"_kn";var i,l,e=x("<div style='position:fixed;top:0px;width:1px;height:1px;' tabindex='0'><div tabindex='-1' style='width:1px;height:1px;' id='"+c.p.knv+"'></div></div>");x(e).insertBefore(c.grid.cDiv),x("#"+c.p.knv).focus().keydown(function(e){switch(l=e.keyCode,"rtl"===c.p.direction&&(37===l?l=39:39===l&&(l=37)),l){case 38:0<c.p.iRow-1&&(t(c.p.iRow-1,c.p.iCol,"vu"),x(c).jqGrid("editCell",c.p.iRow-1,c.p.iCol,!1,e));break;case 40:c.p.iRow+1<=c.rows.length-1&&(t(c.p.iRow+1,c.p.iCol,"vd"),x(c).jqGrid("editCell",c.p.iRow+1,c.p.iCol,!1,e));break;case 37:0<=c.p.iCol-1&&(i=r(c.p.iCol-1,"lft"),t(c.p.iRow,i,"h"),x(c).jqGrid("editCell",c.p.iRow,i,!1,e));break;case 39:c.p.iCol+1<=c.p.colModel.length-1&&(i=r(c.p.iCol+1,"rgt"),t(c.p.iRow,i,"h"),x(c).jqGrid("editCell",c.p.iRow,i,!1,e));break;case 13:0<=parseInt(c.p.iCol,10)&&0<=parseInt(c.p.iRow,10)&&x(c).jqGrid("editCell",c.p.iRow,c.p.iCol,!0,e);break;default:return!0}return!1})}function t(e,i,l){if("v"===l.substr(0,1)){var t=x(c.grid.bDiv)[0].clientHeight,r=x(c.grid.bDiv)[0].scrollTop,o=c.rows[e].offsetTop+c.rows[e].clientHeight,d=c.rows[e].offsetTop;"vd"===l&&t<=o&&(x(c.grid.bDiv)[0].scrollTop=x(c.grid.bDiv)[0].scrollTop+c.rows[e].clientHeight),"vu"===l&&d<r&&(x(c.grid.bDiv)[0].scrollTop=x(c.grid.bDiv)[0].scrollTop-c.rows[e].clientHeight)}if("h"===l){var s=x(c.grid.bDiv)[0].clientWidth,a=x(c.grid.bDiv)[0].scrollLeft,n=c.rows[e].cells[i].offsetLeft+c.rows[e].cells[i].clientWidth,p=c.rows[e].cells[i].offsetLeft;n>=s+parseInt(a,10)?x(c.grid.bDiv)[0].scrollLeft=x(c.grid.bDiv)[0].scrollLeft+c.rows[e].cells[i].clientWidth:p<a&&(x(c.grid.bDiv)[0].scrollLeft=x(c.grid.bDiv)[0].scrollLeft-c.rows[e].cells[i].clientWidth)}}function r(e,i){var l,t;if("lft"===i)for(l=e+1,t=e;0<=t;t--)if(!0!==c.p.colModel[t].hidden){l=t;break}if("rgt"===i)for(l=e-1,t=e;t<c.p.colModel.length;t++)if(!0!==c.p.colModel[t].hidden){l=t;break}return l}})},getChangedCells:function(o){var e=[];return o=o||"all",this.each(function(){var t,r=this;r.grid&&!0===r.p.cellEdit&&x(r.rows).each(function(i){var l={};x(this).hasClass("edited")&&(x("td",this).each(function(e){if("cb"!==(t=r.p.colModel[e].name)&&"subgrid"!==t)if("dirty"===o){if(x(this).hasClass("dirty-cell"))try{l[t]=x.unformat.call(r,this,{rowId:r.rows[i].id,colModel:r.p.colModel[e]},e)}catch(e){l[t]=x.jgrid.htmlDecode(x(this).html())}}else try{l[t]=x.unformat.call(r,this,{rowId:r.rows[i].id,colModel:r.p.colModel[e]},e)}catch(e){l[t]=x.jgrid.htmlDecode(x(this).html())}}),l.id=this.id,e.push(l))})}),e}})});