!function(x){x.jgrid.extend({searchGrid:function(g){return g=x.extend({recreateFilter:!1,drag:!0,sField:"searchField",sValue:"searchString",sOper:"searchOper",sFilter:"filters",loadDefaults:!0,beforeShowSearch:null,afterShowSearch:null,onInitializeSearch:null,closeAfterSearch:!1,closeAfterReset:!1,closeOnEscape:!1,multipleSearch:!1,cloneSearchRowOnAdd:!0,sopt:null,stringResult:void 0,onClose:null,useDataProxy:!1,overlay:!0},x.jgrid.search,g||{}),this.each(function(){var a=this;if(a.grid){var s="fbox_"+a.p.id,e=!0;if(x.fn.searchFilter)if(!0===g.recreateFilter&&x("#"+s).remove(),null!=x("#"+s).html()){if(x.isFunction(g.beforeShowSearch)&&void 0===(e=g.beforeShowSearch(x("#"+s)))&&(e=!0),!1===e)return;i(),x.isFunction(g.afterShowSearch)&&g.afterShowSearch(x("#"+s))}else{var h,p,c,u=[],f=x("#"+a.p.id).jqGrid("getGridParam","colNames"),t=x("#"+a.p.id).jqGrid("getGridParam","colModel"),m=["eq","ne","lt","le","gt","ge","bw","bn","in","ni","ew","en","cn","nc"],r=[];if(null!==g.sopt)for(h=c=0;h<g.sopt.length;h++)-1!=(p=x.inArray(g.sopt[h],m))&&(r[c]={op:g.sopt[h],text:g.odata[p].text},c++);else for(h=0;h<m.length;h++)r[h]={op:m[h],text:g.odata[h].text};if(x.each(t,function(e,t){var r,i=void 0===t.search||t.search,a=!0===t.hidden,s=x.extend({},{text:f[e],itemval:t.index||t.name},this.searchoptions),l=!0===s.searchhidden;if(void 0!==s.sopt&&(c=0,s.ops=[],0<s.sopt.length))for(h=0;h<s.sopt.length;h++)-1!=(p=x.inArray(s.sopt[h],m))&&(s.ops[c]={op:s.sopt[h],text:g.odata[p].text},c++);if((void 0===this.stype&&(this.stype="text"),"select"==this.stype)&&(void 0===s.dataUrl&&(s.value?r=s.value:this.editoptions&&(r=this.editoptions.value),r)))if(s.dataValues=[],"string"==typeof r){var n,d=r.split(";");for(h=0;h<d.length;h++)n=d[h].split(":"),s.dataValues[h]={value:n[0],text:n[1]}}else if("object"==typeof r)for(var o in h=0,r)r.hasOwnProperty(o)&&(s.dataValues[h]={value:o,text:r[o]},h++);(l&&i||i&&!a)&&u.push(s)}),0<u.length){if(x("<div id='"+s+"' role='dialog' tabindex='-1'></div>").insertBefore("#gview_"+a.p.id),void 0===g.stringResult&&(g.stringResult=g.multipleSearch),a.SearchFilter=x("#"+s).searchFilter(u,{groupOps:g.groupOps,operators:r,onClose:l,resetText:g.Reset,searchText:g.Find,windowTitle:g.caption,rulesText:g.rulesText,matchText:g.matchText,onSearch:function(e){var t=void 0!==e,r=x("#"+a.p.id),i={};!1===g.multipleSearch?(i[g.sField]=e.rules[0].field,i[g.sValue]=e.rules[0].data,i[g.sOper]=e.rules[0].op,i.hasOwnProperty(g.sFilter)&&delete i[g.sFilter]):(i[g.sFilter]=e,x.each([g.sField,g.sValue,g.sOper],function(e,t){i.hasOwnProperty(t)&&delete i[t]})),r[0].p.search=t,x.extend(r[0].p.postData,i),r.trigger("reloadGrid",[{page:1}]),g.closeAfterSearch&&l(x("#"+s))},onReset:function(e){var t=!e||!e.hasOwnProperty("reload")||e.reload,r=x("#"+a.p.id),i={};(r[0].p.search=!1)===g.multipleSearch?i[g.sField]=i[g.sValue]=i[g.sOper]="":i[g.sFilter]="",x.extend(r[0].p.postData,i),t&&r.trigger("reloadGrid",[{page:1}]),g.closeAfterReset&&l(x("#"+s))},stringResult:g.stringResult,ajaxSelectOptions:x.extend({},x.jgrid.ajaxOptions,a.p.ajaxSelectOptions||{}),clone:g.cloneSearchRowOnAdd}),x(".ui-widget-overlay","#"+s).remove(),"rtl"==a.p.direction&&x(".ui-closer","#"+s).css("float","left"),!0===g.drag)if(x("#"+s+" table thead tr:first td:first").css("cursor","move"),jQuery.fn.jqDrag)x("#"+s).jqDrag(x("#"+s+" table thead tr:first td:first"));else try{x("#"+s).draggable({handle:x("#"+s+" table thead tr:first td:first")})}catch(e){}if(!1===g.multipleSearch&&(x(".ui-del, .ui-add, .ui-del, .ui-add-last, .matchText, .rulesText","#"+s).hide(),x("select[name='groupOp']","#"+s).hide()),!0===g.multipleSearch&&!0===g.loadDefaults&&function(e,t){var r=e.p.postData[t.sFilter];if("string"==typeof r&&(r=x.jgrid.parse(r)),r&&(r.groupOp&&e.SearchFilter.setGroupOp(r.groupOp),r.rules))for(var i,a=0,s=r.rules.length;a<s;a++)void 0!==(i=r.rules[a]).field&&void 0!==i.op&&void 0!==i.data&&e.SearchFilter.setFilter({sfref:e.SearchFilter.$.find(".sf:last"),filter:x.extend({},i)})&&e.SearchFilter.add()}(a,g),x.isFunction(g.onInitializeSearch)&&g.onInitializeSearch(x("#"+s)),x.isFunction(g.beforeShowSearch)&&void 0===(e=g.beforeShowSearch(x("#"+s)))&&(e=!0),!1===e)return;i(),x.isFunction(g.afterShowSearch)&&g.afterShowSearch(x("#"+s)),!0===g.closeOnEscape&&x("#"+s).keydown(function(e){27==e.which&&l(x("#"+s)),13==e.which&&x(".ui-search",this).click()})}}}function l(e){if(g.onClose){var t=g.onClose(e);if("boolean"==typeof t&&!t)return}e.hide(),!0===g.overlay&&x(".jqgrid-overlay:first","#gbox_"+a.p.id).hide()}function i(){var e=x(".ui-searchFilter").length;if(1<e){var t=x("#"+s).css("zIndex");x("#"+s).css({zIndex:parseInt(t,10)+e})}x("#"+s).show(),!0===g.overlay&&x(".jqgrid-overlay:first","#gbox_"+a.p.id).show();try{x(":input:visible","#"+s)[0].focus()}catch(e){}}})},updateGridRows:function(e,n,d){var o,h,p=!1;return this.each(function(){var r,i,a,s,l=this;if(!l.grid)return!1;n=n||"id",e&&0<e.length&&x(e).each(function(e){if(a=this,i=l.rows.namedItem(a[n])){if(s=a[n],!0===d&&!0===l.p.jsonReader.repeatitems){l.p.jsonReader.cell&&(a=a[l.p.jsonReader.cell]);for(var t=0;t<a.length;t++)r=l.formatter(s,a[t],t,a,"edit"),h=l.p.colModel[t].title?{title:x.jgrid.stripHtml(r)}:{},!0===l.p.treeGrid&&o==l.p.ExpandColumn?x("td:eq("+t+") > span:first",i).html(r).attr(h):x("td:eq("+t+")",i).html(r).attr(h);return p=!0}x(l.p.colModel).each(function(e){o=!0===d&&this.jsonmap||this.name,void 0!==a[o]&&(r=l.formatter(s,a[o],e,a,"edit"),h=this.title?{title:x.jgrid.stripHtml(r)}:{},!0===l.p.treeGrid&&o==l.p.ExpandColumn?x("td:eq("+e+") > span:first",i).html(r).attr(h):x("td:eq("+e+")",i).html(r).attr(h),p=!0)})}})}),p},filterGrid:function(n,d){return d=x.extend({gridModel:!1,gridNames:!1,gridToolbar:!1,filterModel:[],formtype:"horizontal",autosearch:!0,formclass:"filterform",tableclass:"filtertable",buttonclass:"filterbutton",searchButton:"Search",clearButton:"Clear",enableSearch:!1,enableClear:!1,beforeSearch:null,afterSearch:null,beforeClear:null,afterClear:null,url:"",marksearched:!0},d||{}),this.each(function(){var p=this;if(this.p=d,0!==this.p.filterModel.length||!1!==this.p.gridModel)if(n){this.p.gridid=-1!=n.indexOf("#")?n:"#"+n;var i=x(this.p.gridid).jqGrid("getGridParam","colModel");if(i){if(!0===this.p.gridModel){var a,s=x(this.p.gridid)[0];x.each(i,function(e,t){var r=[];this.search=!1!==this.search,a=!(!this.editrules||!0!==this.editrules.searchhidden)||!0!==this.hidden,!0===this.search&&!0===a&&(!0===p.p.gridNames?r.label=s.p.colNames[e]:r.label="",r.name=this.name,r.index=this.index||this.name,r.stype=this.edittype||"text","select"!=r.stype&&(r.stype="text"),r.defval=this.defval||"",r.surl=this.surl||"",r.sopt=this.editoptions||{},r.width=this.width,p.p.filterModel.push(r))})}else x.each(p.p.filterModel,function(e,t){for(var r=0;r<i.length;r++)if(this.name==i[r].name){this.index=i[r].index||this.name;break}this.index||(this.index=this.name)});function c(){var r,i,a={},s=0,l=x(p.p.gridid)[0];l.p.searchdata={},x.isFunction(p.p.beforeSearch)&&p.p.beforeSearch(),x.each(p.p.filterModel,function(e,t){if(i=this.index,"select"===this.stype)if(r=x("select[name="+i+"]",p).val())a[i]=r,p.p.marksearched&&x("#jqgh_"+this.name,l.grid.hDiv).addClass("dirty-cell"),s++;else{p.p.marksearched&&x("#jqgh_"+this.name,l.grid.hDiv).removeClass("dirty-cell");try{delete l.p.postData[this.index]}catch(e){}}else if(r=x("input[name="+i+"]",p).val())a[i]=r,p.p.marksearched&&x("#jqgh_"+this.name,l.grid.hDiv).addClass("dirty-cell"),s++;else{p.p.marksearched&&x("#jqgh_"+this.name,l.grid.hDiv).removeClass("dirty-cell");try{delete l.p.postData[this.index]}catch(e){}}});var e,t=0<s;x.extend(l.p.postData,a),p.p.url&&(e=x(l).jqGrid("getGridParam","url"),x(l).jqGrid("setGridParam",{url:p.p.url})),x(l).jqGrid("setGridParam",{search:t}).trigger("reloadGrid",[{page:1}]),e&&x(l).jqGrid("setGridParam",{url:e}),x.isFunction(p.p.afterSearch)&&p.p.afterSearch()}function e(){var i,a,s={},l=0,n=x(p.p.gridid)[0];x.isFunction(p.p.beforeClear)&&p.p.beforeClear(),x.each(p.p.filterModel,function(e,t){switch(a=this.index,i=this.defval?this.defval:"",this.stype||(this.stype="text"),this.stype){case"select":var r;if(x("select[name="+a+"] option",p).each(function(e){if(0===e&&(this.selected=!0),x(this).text()==i)return this.selected=!0,r=x(this).val(),!1}),r)s[a]=r,p.p.marksearched&&x("#jqgh_"+this.name,n.grid.hDiv).addClass("dirty-cell"),l++;else{p.p.marksearched&&x("#jqgh_"+this.name,n.grid.hDiv).removeClass("dirty-cell");try{delete n.p.postData[this.index]}catch(e){}}break;case"text":if(x("input[name="+a+"]",p).val(i),i)s[a]=i,p.p.marksearched&&x("#jqgh_"+this.name,n.grid.hDiv).addClass("dirty-cell"),l++;else{p.p.marksearched&&x("#jqgh_"+this.name,n.grid.hDiv).removeClass("dirty-cell");try{delete n.p.postData[this.index]}catch(e){}}}});var e,t=0<l;x.extend(n.p.postData,s),p.p.url&&(e=x(n).jqGrid("getGridParam","url"),x(n).jqGrid("setGridParam",{url:p.p.url})),x(n).jqGrid("setGridParam",{search:t}).trigger("reloadGrid",[{page:1}]),e&&x(n).jqGrid("setGridParam",{url:e}),x.isFunction(p.p.afterClear)&&p.p.afterClear()}var u,f,t,r,m,g,v,l=x("<form name='SearchForm' style=display:inline;' class='"+this.p.formclass+"'></form>");u=x("<table class='"+this.p.tableclass+"' cellspacing='0' cellpadding='0' border='0'><tbody></tbody></table>"),x(l).append(u),v=document.createElement("tr"),"horizontal"==p.p.formtype&&x(u).append(v),x.each(p.p.filterModel,function(e,t){m=document.createElement("td"),x(m).append("<label for='"+this.name+"'>"+this.label+"</label>"),g=document.createElement("td");var r=this;switch(this.stype||(this.stype="text"),this.stype){case"select":if(this.surl)x(g).load(this.surl,function(){r.defval&&x("select",this).val(r.defval),x("select",this).attr({name:r.index||r.name,id:"sg_"+r.name}),r.sopt&&x("select",this).attr(r.sopt),!0===p.p.gridToolbar&&r.width&&x("select",this).width(r.width),!0===p.p.autosearch&&x("select",this).change(function(e){return c(),!1})});else if(r.sopt.value){var i,a,s,l=r.sopt.value,n=document.createElement("select");if(x(n).attr({name:r.index||r.name,id:"sg_"+r.name}).attr(r.sopt),"string"==typeof l){i=l.split(";");for(var d=0;d<i.length;d++)a=i[d].split(":"),(s=document.createElement("option")).value=a[0],s.innerHTML=a[1],a[1]==r.defval&&(s.selected="selected"),n.appendChild(s)}else if("object"==typeof l)for(var o in l)l.hasOwnProperty(o)&&((s=document.createElement("option")).value=o,s.innerHTML=l[o],l[o]==r.defval&&(s.selected="selected"),n.appendChild(s));!0===p.p.gridToolbar&&r.width&&x(n).width(r.width),x(g).append(n),!0===p.p.autosearch&&x(n).change(function(e){return c(),!1})}break;case"text":var h=this.defval?this.defval:"";x(g).append("<input type='text' name='"+(this.index||this.name)+"' id='sg_"+this.name+"' value='"+h+"'/>"),r.sopt&&x("input",g).attr(r.sopt),!0===p.p.gridToolbar&&r.width&&(x.browser.msie?x("input",g).width(r.width-4):x("input",g).width(r.width-2)),!0===p.p.autosearch&&x("input",g).keypress(function(e){return 13==(e.charCode?e.charCode:e.keyCode?e.keyCode:0)?(c(),!1):this})}"horizontal"==p.p.formtype?(!0===p.p.gridToolbar&&!1===p.p.gridNames?x(v).append(g):x(v).append(m).append(g),x(v).append(g)):(f=document.createElement("tr"),x(f).append(m).append(g),x(u).append(f))}),g=document.createElement("td"),!0===p.p.enableSearch&&(t="<input type='button' id='sButton' class='"+p.p.buttonclass+"' value='"+p.p.searchButton+"'/>",x(g).append(t),x("input#sButton",g).click(function(){return c(),!1})),!0===p.p.enableClear&&(r="<input type='button' id='cButton' class='"+p.p.buttonclass+"' value='"+p.p.clearButton+"'/>",x(g).append(r),x("input#cButton",g).click(function(){return e(),!1})),!0!==p.p.enableClear&&!0!==p.p.enableSearch||("horizontal"==p.p.formtype?x(v).append(g):(f=document.createElement("tr"),x(f).append("<td>&#160;</td>").append(g),x(u).append(f))),x(this).append(l),this.triggerSearch=c,this.clearSearch=e}else alert("Could not get grid colModel")}else alert("No target grid is set!");else alert("No filter is set")})}})}(jQuery);