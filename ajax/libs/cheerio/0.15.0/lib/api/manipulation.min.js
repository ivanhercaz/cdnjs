var _=require("lodash"),parse=require("../parse"),$=require("../static"),updateDOM=parse.update,evaluate=parse.evaluate,utils=require("../utils"),domEach=utils.domEach,encode=utils.encode,slice=Array.prototype.slice;exports._makeDomArray=function e(t){return null==t?[]:t.cheerio?t.get():_.isArray(t)?_.flatten(t.map(e,this)):_.isString(t)?evaluate(t,this.options):[t]};var _insert=function(a){return function(){var n=this,r=slice.call(arguments),i=this._makeDomArray(r);return _.isFunction(r[0])?domEach(this,function(e,t){i=n._makeDomArray(r[0].call(t,e,$.html(t.children))),a(i,t.children,t)}):domEach(this,function(e,t){a(i,t.children,t)})}},uniqueSplice=function(e,t,n,r,i){var a,l,c,o,u=[t,n].concat(r),h=e[t-1]||null,s=e[t]||null;for(a=0,l=r.length;a<l;++a)c=(o=r[a]).parent&&e.indexOf(r[a]),o.parent&&-1<c&&(e.splice(c,1),c<t&&u[0]--),o.parent=i,o.prev=r[a-1]||h,o.next=r[a+1]||s;return h&&(h.next=r[0]),s&&(s.prev=r[r.length-1]),e.splice.apply(e,u)},append=exports.append=_insert(function(e,t,n){uniqueSplice(t,t.length,0,e,n)}),prepend=exports.prepend=_insert(function(e,t,n){uniqueSplice(t,0,0,e,n)}),after=exports.after=function(){var a=slice.call(arguments),l=this._makeDomArray(a),c=this;return domEach(this,function(e,t){var n=t.parent||t.root,r=n.children,i=r.indexOf(t);~i&&(_.isFunction(a[0])&&(l=c._makeDomArray(a[0].call(t,e))),uniqueSplice(r,++i,0,l,n))}),this},before=exports.before=function(){var a=slice.call(arguments),l=this._makeDomArray(a),c=this;return domEach(this,function(e,t){var n=t.parent||t.root,r=n.children,i=r.indexOf(t);~i&&(_.isFunction(a[0])&&(l=c._makeDomArray(a[0].call(t,e))),uniqueSplice(r,i,0,l,n))}),this},remove=exports.remove=function(e){var t=this;return e&&(t=t.filter(e)),domEach(t,function(e,t){var n=(t.parent||t.root).children,r=n.indexOf(t);~r&&(n.splice(r,1),t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t.prev=t.next=t.parent=null)}),this},replaceWith=exports.replaceWith=function(l){var c=this;return domEach(this,function(e,t){var n,r=t.parent||t.root,i=r.children,a=c._makeDomArray(_.isFunction(l)?l.call(t,e,t):l);updateDOM(a,null),n=i.indexOf(t),uniqueSplice(i,n,1,a,r),t.parent=t.prev=t.next=null}),this},empty=exports.empty=function(){return domEach(this,function(e,t){_.each(t.children,function(e){e.next=e.prev=e.parent=null}),t.children.length=0}),this},html=exports.html=function(n){return void 0===n?this[0]&&this[0].children?$.html(this[0].children):null:(n=n.cheerio?n.get():evaluate(n,this.options),domEach(this,function(e,t){_.each(t.children,function(e){e.next=e.prev=e.parent=null}),updateDOM(n,t)}),this)},toString=exports.toString=function(){return $.html(this)},text=exports.text=function(r){if(void 0===r)return $.text(this);if(_.isFunction(r))return domEach(this,function(e,t){var n=[t];return text.call(n,r.call(t,e,$.text(n)))});var n={data:encode(r),type:"text",parent:null,prev:null,next:null,children:[]};return domEach(this,function(e,t){_.each(t.children,function(e){e.next=e.prev=e.parent=null}),updateDOM(n,t)}),this},clone=exports.clone=function(){return this._make($.html(this))};