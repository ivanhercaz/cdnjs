var _=require("lodash"),utils=require("../utils"),isTag=utils.isTag,domEach=utils.domEach,hasOwn=Object.prototype.hasOwnProperty,rspace=/\s+/,primitives={null:null,true:!0,false:!1},rboolean=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,rbrace=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,getAttr=function(t,s){if(t&&isTag(t))return t.attribs||(t.attribs={}),s?hasOwn.call(t.attribs,s)?t.attribs[s]:void 0:t.attribs},setAttr=function(t,s,i){null===i?removeAttribute(t,s):t.attribs[s]=i+""},attr=exports.attr=function(e,r){return"object"==typeof e||void 0!==r?_.isFunction(r)?domEach(this,function(t,s){setAttr(s,e,r.call(s,t,s.attribs[e]))}):domEach(this,function(t,i){isTag(i)&&("object"==typeof e?_.each(e,function(t,s){i.attribs[s]=t+""}):setAttr(i,e,r))}):getAttr(this[0],e)},setData=function(t,s,i){if("object"==typeof s)return _.extend(t.data,s);"string"==typeof s&&void 0!==i?t.data[s]=i:"object"==typeof s&&_.exend(t.data,s)},data=exports.data=function(i,e){var t=this[0];if(t&&isTag(t)){if(t.data||(t.data={}),!i)return t.data;if("object"==typeof i||void 0!==e)return domEach(this,function(t,s){setData(s,i,e)}),this;if(hasOwn.call(t.data,i)){var s=t.data[i];return hasOwn.call(primitives,s)?s=primitives[s]:s===String(Number(s))?s=Number(s):rbrace.test(s)&&(s=JSON.parse(s)),s}if("string"!=typeof i||void 0!==e)return this}},val=exports.val=function(t){var s=0===arguments.length,i=this[0];if(i)switch(i.name){case"textarea":return this.text(t);case"input":switch(this.attr("type")){case"radio":var e,r,a="input[type=radio][name="+this.attr("name")+"]:checked";return 0===(e=this.closest("form")).length&&(r=(this.parents().last()[0]||this[0]).root,e=this._make(r)),s?e.find(a).attr("value"):(e.find(":checked").removeAttr("checked"),e.find('input[type=radio][value="'+t+'"]').attr("checked",""),this);default:return this.attr("value",t)}return;case"select":var n,o=this.find("option:selected");if(void 0===o)return;if(s)return n=o.attr("value"),this.attr().hasOwnProperty("multiple")&&(n=[],domEach(o,function(t,s){n.push(s.attribs.value)})),n;if(!this.attr().hasOwnProperty("multiple")&&"object"==typeof t)return this;"object"!=typeof t&&(t=[t]),this.find("option").removeAttr("selected");for(var l=0;l<t.length;l++)this.find('option[value="'+t[l]+'"]').attr("selected","");return this;case"option":return s?this.attr("value"):(this.attr("value",t),this)}},removeAttribute=function(t,s){t.attribs&&hasOwn.call(t.attribs,s)&&(rboolean.test(t.attribs[s])?t.attribs[s]=!1:delete t.attribs[s])},removeAttr=exports.removeAttr=function(i){return domEach(this,function(t,s){removeAttribute(s,i)}),this},hasClass=exports.hasClass=function(i){return _.any(this,function(t){var s=t.attribs;return s&&_.contains((s.class||"").split(rspace),i)})},addClass=exports.addClass=function(e){if(_.isFunction(e))return domEach(this,function(t,s){var i=s.attribs.class||"";addClass.call([s],e.call(s,t,i))});if(!e||!_.isString(e))return this;for(var t=e.split(rspace),s=this.length,i=0;i<s;i++)if(isTag(this[i])){var r,a,n=getAttr(this[i],"class");if(n){a=" "+n+" ",r=t.length;for(var o=0;o<r;o++){var l=t[o]+" ";~a.indexOf(" "+l)||(a+=l)}setAttr(this[i],"class",a.trim())}else setAttr(this[i],"class",t.join(" ").trim())}return this},splitClass=function(t){return t?t.trim().split(rspace):[]},removeClass=exports.removeClass=function(i){var n,o,l;return _.isFunction(i)?domEach(this,function(t,s){removeClass.call([s],i.call(s,t,s.attribs.class||""))}):(n=splitClass(i),o=n.length,l=0===arguments.length,domEach(this,function(t,s){if(isTag(s))if(l)s.attribs.class="";else{for(var i,e,r=splitClass(s.attribs.class),a=0;a<o;a++)0<=(i=r.indexOf(n[a]))&&(r.splice(i,1),e=!0,a--);e&&(s.attribs.class=r.join(" "))}}))},toggleClass=exports.toggleClass=function(i,e){if(_.isFunction(i))return domEach(this,function(t,s){toggleClass.call([s],i.call(s,t,s.attribs.class||"",e),e)});if(!i||!_.isString(i))return this;for(var t,s,r=i.split(rspace),a=r.length,n="boolean"==typeof e,o=this.length,l=0;l<o;l++)if(isTag(this[l])){t=splitClass(this[l].attribs.class);for(var c=0;c<a;c++)s=n&&e?-1:t.indexOf(r[c]),(n?e:s<0)?t.push(r[c]):0<=s&&t.splice(s,1);this[l].attribs.class=t.join(" ")}return this},is=exports.is=function(t){return!!t&&0<this.filter(t).length};