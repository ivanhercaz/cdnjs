var _=require("lodash"),parse=require("../parse"),$=require("../static"),updateDOM=parse.update,evaluate=parse.evaluate,utils=require("../utils"),domEach=utils.domEach,cloneDom=utils.cloneDom,isHtml=utils.isHtml,slice=Array.prototype.slice;exports._makeDomArray=function(t,e){return null==t?[]:t.cheerio?e?cloneDom(t.get(),t.options):t.get():Array.isArray(t)?_.flatten(t.map(function(t){return this._makeDomArray(t,e)},this)):"string"==typeof t?evaluate(t,this.options):e?cloneDom([t]):[t]};var _insert=function(c){return function(){var i=slice.call(arguments),o=this.length-1;return domEach(this,function(t,e){var n,r;r="function"==typeof i[0]?i[0].call(e,t,$.html(e.children)):i,n=this._makeDomArray(r,t<o),c(n,e.children,e)})}},uniqueSplice=function(t,e,n,r,i){var o,c,l,a,s,u=[e,n].concat(r),h=t[e-1]||null,p=t[e]||null;for(o=0,c=r.length;o<c;++o)l=(s=(a=r[o]).parent||a.root)&&s.children.indexOf(r[o]),s&&-1<l&&(s.children.splice(l,1),i===s&&l<e&&u[0]--),a.root=null,a.parent=i,a.prev&&(a.prev.next=a.next||null),a.next&&(a.next.prev=a.prev||null),a.prev=r[o-1]||h,a.next=r[o+1]||p;return h&&(h.next=r[0]),p&&(p.prev=r[r.length-1]),t.splice.apply(t,u)};exports.appendTo=function(t){return t.cheerio||(t=this.constructor.call(this.constructor,t,null,this._originalRoot)),t.append(this),this},exports.prependTo=function(t){return t.cheerio||(t=this.constructor.call(this.constructor,t,null,this._originalRoot)),t.prepend(this),this},exports.append=_insert(function(t,e,n){uniqueSplice(e,e.length,0,t,n)}),exports.prepend=_insert(function(t,e,n){uniqueSplice(e,0,0,t,n)}),exports.wrap=function(c){var l="function"==typeof c&&c,a=this.length-1;return _.forEach(this,_.bind(function(t,e){var n,r,i=t.parent||t.root,o=i.children;i&&(l&&(c=l.call(t,e)),"string"!=typeof c||isHtml(c)||(c=this.parents().last().find(c).clone()),n=this._makeDomArray(c,e<a).slice(0,1),r=o.indexOf(t),updateDOM([t],n[0]),uniqueSplice(o,r,0,n,i))},this)),this},exports.after=function(){var l=slice.call(arguments),a=this.length-1;return domEach(this,function(t,e){var n=e.parent||e.root;if(n){var r,i,o=n.children,c=o.indexOf(e);c<0||(r="function"==typeof l[0]?l[0].call(e,t,$.html(e.children)):l,i=this._makeDomArray(r,t<a),uniqueSplice(o,c+1,0,i,n))}}),this},exports.insertAfter=function(t){var c=[],l=this;return"string"==typeof t&&(t=this.constructor.call(this.constructor,t,null,this._originalRoot)),t=this._makeDomArray(t),l.remove(),domEach(t,function(t,e){var n=l._makeDomArray(l.clone()),r=e.parent||e.root;if(r){var i=r.children,o=i.indexOf(e);o<0||(uniqueSplice(i,o+1,0,n,r),c.push(n))}}),this.constructor.call(this.constructor,this._makeDomArray(c))},exports.before=function(){var l=slice.call(arguments),a=this.length-1;return domEach(this,function(t,e){var n=e.parent||e.root;if(n){var r,i,o=n.children,c=o.indexOf(e);c<0||(r="function"==typeof l[0]?l[0].call(e,t,$.html(e.children)):l,i=this._makeDomArray(r,t<a),uniqueSplice(o,c,0,i,n))}}),this},exports.insertBefore=function(t){var c=[],l=this;return"string"==typeof t&&(t=this.constructor.call(this.constructor,t,null,this._originalRoot)),t=this._makeDomArray(t),l.remove(),domEach(t,function(t,e){var n=l._makeDomArray(l.clone()),r=e.parent||e.root;if(r){var i=r.children,o=i.indexOf(e);o<0||(uniqueSplice(i,o,0,n,r),c.push(n))}}),this.constructor.call(this.constructor,this._makeDomArray(c))},exports.remove=function(t){var e=this;return t&&(e=e.filter(t)),domEach(e,function(t,e){var n=e.parent||e.root;if(n){var r=n.children,i=r.indexOf(e);i<0||(r.splice(i,1),e.prev&&(e.prev.next=e.next),e.next&&(e.next.prev=e.prev),e.prev=e.next=e.parent=e.root=null)}}),this},exports.replaceWith=function(c){var l=this;return domEach(this,function(t,e){var n=e.parent||e.root;if(n){var r,i=n.children,o=l._makeDomArray("function"==typeof c?c.call(e,t,e):c);updateDOM(o,null),r=i.indexOf(e),uniqueSplice(i,r,1,o,n),e.parent=e.prev=e.next=e.root=null}}),this},exports.empty=function(){return domEach(this,function(t,e){_.each(e.children,function(t){t.next=t.prev=t.parent=null}),e.children.length=0}),this},exports.html=function(r){if(void 0===r)return this[0]&&this[0].children?$.html(this[0].children,this.options):null;var i=this.options;return domEach(this,function(t,e){_.each(e.children,function(t){t.next=t.prev=t.parent=null});var n=r.cheerio?r.clone().get():evaluate(""+r,i);updateDOM(n,e)}),this},exports.toString=function(){return $.html(this,this.options)},exports.text=function(r){return void 0===r?$.text(this):"function"==typeof r?domEach(this,function(t,e){var n=[e];return exports.text.call(n,r.call(e,t,$.text(n)))}):(domEach(this,function(t,e){_.each(e.children,function(t){t.next=t.prev=t.parent=null}),updateDOM({data:""+r,type:"text",parent:e,prev:null,next:null,children:[]},e)}),this)},exports.clone=function(){return this._make(cloneDom(this.get(),this.options))};