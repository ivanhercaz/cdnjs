var _=require("lodash"),utils=require("./utils"),entities=require("entities"),booleanAttributes={__proto__:null,autofocus:!0,autoplay:!0,async:!0,checked:!0,controls:!0,defer:!0,disabled:!0,hidden:!0,loop:!0,multiple:!0,open:!0,readonly:!0,required:!0,scoped:!0,selected:!0},formatAttrs=function(e){if(e){var r,t="";for(var n in e)t&&(t+=" "),!(r=e[n])&&booleanAttributes[n]?t+=n:t+=n+'="'+entities.escape(r||"")+'"';return t}},singleTag={__proto__:null,area:!0,base:!0,basefont:!0,br:!0,col:!0,command:!0,embed:!0,frame:!0,hr:!0,img:!0,input:!0,isindex:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0,path:!0,circle:!0,ellipse:!0,line:!0,rect:!0,use:!0},render=module.exports=function(e,n){Array.isArray(e)||e.cheerio||(e=[e]);var a="",i=(n=n||{}).xmlMode;return _.each(e,function(e){var r,t=utils.isTag(e.type);r=t?renderTag(e,i):("directive"===e.type?renderDirective:"comment"===e.type?renderComment:"cdata"===e.type?renderCdata:renderText)(e),e.children&&"cdata"!==e.type&&(r+=render(e.children,n)),!t||singleTag[e.name]&&!i||isClosedTag(e,i)||(r+="</"+e.name+">"),a+=r}),a},isClosedTag=function(e,r){return r&&(!e.children||0===e.children.length)},renderTag=function(e,r){var t="<"+e.name,n=formatAttrs(e.attribs);return n&&(t+=" "+n),isClosedTag(e,r)&&(t+="/"),t+">"},renderDirective=function(e){return"<"+e.data+">"},renderText=function(e){return entities.encodeXML(e.data||"")},renderCdata=function(e){return"<![CDATA["+e.children[0].data+"]]>"},renderComment=function(e){return"\x3c!--"+e.data+"--\x3e"};