var _=require("lodash"),parse=require("../parse"),$=require("../static"),updateDOM=parse.update,evaluate=parse.evaluate,utils=require("../utils"),domEach=utils.domEach,encode=utils.encode,slice=Array.prototype.slice;exports._makeDomArray=function e(t){return null==t?[]:t.cheerio?t.get():Array.isArray(t)?_.flatten(t.map(e,this)):"string"==typeof t?evaluate(t,this.options):[t]};var _insert=function(o){return function(){var n=this,r=slice.call(arguments),i=this._makeDomArray(r);return"function"==typeof r[0]?domEach(this,function(e,t){i=n._makeDomArray(r[0].call(t,e,$.html(t.children))),o(i,t.children,t)}):domEach(this,function(e,t){o(i,t.children,t)})}},uniqueSplice=function(e,t,n,r,i){var o,a,l,c,u,h=[t,n].concat(r),p=e[t-1]||null,s=e[t]||null;for(o=0,a=r.length;o<a;++o)l=(u=(c=r[o]).parent||c.root)&&u.children.indexOf(r[o]),u&&-1<l&&(u.children.splice(l,1),i===u&&l<t&&h[0]--),c.root=null,c.parent=i,c.prev=r[o-1]||p,c.next=r[o+1]||s;return p&&(p.next=r[0]),s&&(s.prev=r[r.length-1]),e.splice.apply(e,h)},append=exports.append=_insert(function(e,t,n){uniqueSplice(t,t.length,0,e,n)}),prepend=exports.prepend=_insert(function(e,t,n){uniqueSplice(t,0,0,e,n)}),after=exports.after=function(){var o=slice.call(arguments),a=this._makeDomArray(o),l=this;return domEach(this,function(e,t){var n=t.parent||t.root;if(n){var r=n.children,i=r.indexOf(t);~i&&("function"==typeof o[0]&&(a=l._makeDomArray(o[0].call(t,e))),uniqueSplice(r,++i,0,a,n))}}),this},before=exports.before=function(){var o=slice.call(arguments),a=this._makeDomArray(o),l=this;return domEach(this,function(e,t){var n=t.parent||t.root;if(n){var r=n.children,i=r.indexOf(t);~i&&("function"==typeof o[0]&&(a=l._makeDomArray(o[0].call(t,e))),uniqueSplice(r,i,0,a,n))}}),this},remove=exports.remove=function(e){var t=this;return e&&(t=t.filter(e)),domEach(t,function(e,t){var n=t.parent||t.root;if(n){var r=n.children,i=r.indexOf(t);~i&&(r.splice(i,1),t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t.prev=t.next=t.parent=t.root=null)}}),this},replaceWith=exports.replaceWith=function(a){var l=this;return domEach(this,function(e,t){var n=t.parent||t.root;if(n){var r,i=n.children,o=l._makeDomArray("function"==typeof a?a.call(t,e,t):a);updateDOM(o,null),r=i.indexOf(t),uniqueSplice(i,r,1,o,n),t.parent=t.prev=t.next=t.root=null}}),this},empty=exports.empty=function(){return domEach(this,function(e,t){_.each(t.children,function(e){e.next=e.prev=e.parent=null}),t.children.length=0}),this},html=exports.html=function(n){return void 0===n?this[0]&&this[0].children?$.html(this[0].children):null:(n=n.cheerio?n.get():evaluate(n,this.options),domEach(this,function(e,t){_.each(t.children,function(e){e.next=e.prev=e.parent=null}),updateDOM(n,t)}),this)},toString=exports.toString=function(){return $.html(this)},text=exports.text=function(r){if(void 0===r)return $.text(this);if("function"==typeof r)return domEach(this,function(e,t){var n=[t];return text.call(n,r.call(t,e,$.text(n)))});var n={data:r,type:"text",parent:null,prev:null,next:null,children:[]};return domEach(this,function(e,t){_.each(t.children,function(e){e.next=e.prev=e.parent=null}),updateDOM(n,t)}),this},clone=exports.clone=function(){return this._make($.html(this))};