var _=require("lodash"),utils=require("../utils"),isTag=utils.isTag,domEach=utils.domEach,hasOwn=Object.prototype.hasOwnProperty,camelCase=utils.camelCase,cssCase=utils.cssCase,rspace=/\s+/,dataAttrPrefix="data-",primitives={null:null,true:!0,false:!1},rboolean=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,rbrace=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,getAttr=function(t,e){if(t&&isTag(t))return t.attribs||(t.attribs={}),e?hasOwn.call(t.attribs,e)?t.attribs[e]:void 0:t.attribs},setAttr=function(t,e,s){null===s?removeAttribute(t,e):t.attribs[e]=s+""},attr=exports.attr=function(a,r){return"object"==typeof a||void 0!==r?domEach(this,"function"==typeof r?function(t,e){setAttr(e,a,r.call(e,t,e.attribs[a]))}:function(t,s){isTag(s)&&("object"==typeof a?_.each(a,function(t,e){s.attribs[e]=t+""}):setAttr(s,a,r))}):getAttr(this[0],a)},setData=function(t,e,s){if("object"==typeof e)return _.extend(t.data,e);"string"==typeof e&&void 0!==s?t.data[e]=s:"object"==typeof e&&_.exend(t.data,e)},readData=function(t,e){var s,a,r,i,n,o,l,c=1===arguments.length;for(r=c?(s=Object.keys(t.attribs).filter(function(t){return t.slice(0,dataAttrPrefix.length)===dataAttrPrefix})).map(function(t){return camelCase(t.slice(dataAttrPrefix.length))}):(s=[dataAttrPrefix+cssCase(e)],[e]),o=0,l=s.length;o<l;++o)a=s[o],i=r[o],hasOwn.call(t.attribs,a)&&(n=t.attribs[a],hasOwn.call(primitives,n)?n=primitives[n]:n===String(Number(n))?n=Number(n):rbrace.test(n)&&(n=JSON.parse(n)),t.data[i]=n);return c?t.data:n},data=exports.data=function(s,a){var t=this[0];if(t&&isTag(t))return t.data||(t.data={}),s?"object"==typeof s||void 0!==a?(domEach(this,function(t,e){setData(e,s,a)}),this):hasOwn.call(t.data,s)?t.data[s]:readData(t,s):readData(t)},val=exports.val=function(t){var e=0===arguments.length,s=this[0];if(s)switch(s.name){case"textarea":return this.text(t);case"input":switch(this.attr("type")){case"radio":var a,r,i="input[type=radio][name="+this.attr("name")+"]:checked";return 0===(a=this.closest("form")).length&&(r=(this.parents().last()[0]||this[0]).root,a=this._make(r)),e?a.find(i).attr("value"):(a.find(":checked").removeAttr("checked"),a.find('input[type=radio][value="'+t+'"]').attr("checked",""),this);default:return this.attr("value",t)}return;case"select":var n,o=this.find("option:selected");if(void 0===o)return;if(e)return n=o.attr("value"),this.attr().hasOwnProperty("multiple")&&(n=[],domEach(o,function(t,e){n.push(e.attribs.value)})),n;if(!this.attr().hasOwnProperty("multiple")&&"object"==typeof t)return this;"object"!=typeof t&&(t=[t]),this.find("option").removeAttr("selected");for(var l=0;l<t.length;l++)this.find('option[value="'+t[l]+'"]').attr("selected","");return this;case"option":return e?this.attr("value"):(this.attr("value",t),this)}},removeAttribute=function(t,e){t.attribs&&hasOwn.call(t.attribs,e)&&(rboolean.test(t.attribs[e])?t.attribs[e]=!1:delete t.attribs[e])},removeAttr=exports.removeAttr=function(s){return domEach(this,function(t,e){removeAttribute(e,s)}),this},hasClass=exports.hasClass=function(i){return _.any(this,function(t){var e,s=t.attribs,a=s&&s.class,r=-1;if(a)for(;-1<(r=a.indexOf(i,r+1));)if(e=r+i.length,(0===r||rspace.test(a[r-1]))&&(e===a.length||rspace.test(a[e])))return!0})},addClass=exports.addClass=function(a){if("function"==typeof a)return domEach(this,function(t,e){var s=e.attribs.class||"";addClass.call([e],a.call(e,t,s))});if(!a||"string"!=typeof a)return this;for(var t=a.split(rspace),e=this.length,s=0;s<e;s++)if(isTag(this[s])){var r,i,n=getAttr(this[s],"class");if(n){i=" "+n+" ",r=t.length;for(var o=0;o<r;o++){var l=t[o]+" ";~i.indexOf(" "+l)||(i+=l)}setAttr(this[s],"class",i.trim())}else setAttr(this[s],"class",t.join(" ").trim())}return this},splitClass=function(t){return t?t.trim().split(rspace):[]},removeClass=exports.removeClass=function(s){var n,o,l;return"function"==typeof s?domEach(this,function(t,e){removeClass.call([e],s.call(e,t,e.attribs.class||""))}):(n=splitClass(s),o=n.length,l=0===arguments.length,domEach(this,function(t,e){if(isTag(e))if(l)e.attribs.class="";else{for(var s,a,r=splitClass(e.attribs.class),i=0;i<o;i++)0<=(s=r.indexOf(n[i]))&&(r.splice(s,1),a=!0,i--);a&&(e.attribs.class=r.join(" "))}}))},toggleClass=exports.toggleClass=function(s,a){if("function"==typeof s)return domEach(this,function(t,e){toggleClass.call([e],s.call(e,t,e.attribs.class||"",a),a)});if(!s||"string"!=typeof s)return this;for(var t,e,r=s.split(rspace),i=r.length,n="boolean"==typeof a,o=this.length,l=0;l<o;l++)if(isTag(this[l])){t=splitClass(this[l].attribs.class);for(var c=0;c<i;c++)e=n&&a?-1:t.indexOf(r[c]),(n?a:e<0)?t.push(r[c]):0<=e&&t.splice(e,1);this[l].attribs.class=t.join(" ")}return this},is=exports.is=function(t){return!!t&&0<this.filter(t).length};