var _=require("lodash"),select=require("CSSselect"),utils=require("../utils"),domEach=utils.domEach,uniqueSort=require("htmlparser2").DomUtils.uniqueSort,isTag=utils.isTag;exports.find=function(t){var e,i=_.reduce(this,function(t,e){return t.concat(_.filter(e.children,isTag))},[]),r=this.constructor.contains;return t&&"string"!=typeof t?(e=t.cheerio?t.get():[t],this._make(e.filter(function(t){var e,i;for(e=0,i=this.length;e<i;++e)if(r(this[e],t))return!0},this))):this._make(select(t,i,this.options))},exports.parent=function(t){var r=[];return domEach(this,function(t,e){var i=e.parent;i&&r.indexOf(i)<0&&r.push(i)}),arguments.length&&(r=exports.filter.call(r,t,this)),this._make(r)},exports.parents=function(e){var i=[];return this.get().reverse().forEach(function(t){traverseParents(this,t.parent,e,1/0).forEach(function(t){-1===i.indexOf(t)&&i.push(t)})},this),this._make(i)},exports.parentsUntil=function(t,e){var i,r,n=[];return"string"==typeof t?i=select(t,this.parents().toArray(),this.options)[0]:t&&t.cheerio?r=t.toArray():t&&(i=t),this.toArray().reverse().forEach(function(t){for(;(t=t.parent)&&(i&&t!==i||r&&-1===r.indexOf(t)||!i&&!r);)isTag(t)&&-1===n.indexOf(t)&&n.push(t)},this),this._make(e?select(e,n,this.options):n)},exports.closest=function(r){var n=[];return r&&domEach(this,function(t,e){var i=traverseParents(this,e,r,1)[0];i&&n.indexOf(i)<0&&n.push(i)}.bind(this)),this._make(n)},exports.next=function(t){if(!this[0])return this;var e=[];return _.forEach(this,function(t){for(;t=t.next;)if(isTag(t))return void e.push(t)}),t?exports.filter.call(e,t,this):this._make(e)},exports.nextAll=function(t){if(!this[0])return this;var e=[];return _.forEach(this,function(t){for(;t=t.next;)isTag(t)&&-1===e.indexOf(t)&&e.push(t)}),t?exports.filter.call(e,t,this):this._make(e)},exports.nextUntil=function(t,e){if(!this[0])return this;var i,r,n=[];return"string"==typeof t?i=select(t,this.nextAll().get(),this.options)[0]:t&&t.cheerio?r=t.get():t&&(i=t),_.forEach(this,function(t){for(;(t=t.next)&&(i&&t!==i||r&&-1===r.indexOf(t)||!i&&!r);)isTag(t)&&-1===n.indexOf(t)&&n.push(t)}),e?exports.filter.call(n,e,this):this._make(n)},exports.prev=function(t){if(!this[0])return this;var e=[];return _.forEach(this,function(t){for(;t=t.prev;)if(isTag(t))return void e.push(t)}),t?exports.filter.call(e,t,this):this._make(e)},exports.prevAll=function(t){if(!this[0])return this;var e=[];return _.forEach(this,function(t){for(;t=t.prev;)isTag(t)&&-1===e.indexOf(t)&&e.push(t)}),t?exports.filter.call(e,t,this):this._make(e)},exports.prevUntil=function(t,e){if(!this[0])return this;var i,r,n=[];return"string"==typeof t?i=select(t,this.prevAll().get(),this.options)[0]:t&&t.cheerio?r=t.get():t&&(i=t),_.forEach(this,function(t){for(;(t=t.prev)&&(i&&t!==i||r&&-1===r.indexOf(t)||!i&&!r);)isTag(t)&&-1===n.indexOf(t)&&n.push(t)}),e?exports.filter.call(n,e,this):this._make(n)},exports.siblings=function(t){var e=this.parent(),i=_.filter(e?e.children():this.siblingsAndMe(),function(t){return isTag(t)&&!this.is(t)},this);return void 0!==t?exports.filter.call(i,t,this):this._make(i)},exports.children=function(t){var e=_.reduce(this,function(t,e){return t.concat(_.filter(e.children,isTag))},[]);return void 0===t?this._make(e):"number"==typeof t?this._make(e[t]):exports.filter.call(e,t,this)},exports.contents=function(){return this._make(_.reduce(this,function(t,e){return t.push.apply(t,e.children),t},[]))},exports.each=function(t){for(var e=0,i=this.length;e<i&&!1!==t.call(this[e],e,this[e]);)++e;return this},exports.map=function(n){return this._make(_.reduce(this,function(t,e,i){var r=n.call(e,i,e);return null==r?t:t.concat(r)},[]))};var makeFilterMethod=function(r){return function(i,t){var e;return t=t||this,e="string"==typeof i?select.compile(i,t.options):"function"==typeof i?function(t,e){return i.call(t,e,t)}:i.cheerio?i.is.bind(i):function(t){return i===t},t._make(r(this,e))}};function traverseParents(t,e,i,r){for(var n=[];e&&n.length<r;)i&&!exports.filter.call([e],i,t).length||n.push(e),e=e.parent;return n}exports.filter=makeFilterMethod(_.filter),exports.not=makeFilterMethod(_.reject),exports.has=function(t){var e=this;return exports.filter.call(this,function(){return 0<e._make(this).find(t).length})},exports.first=function(){return 1<this.length?this._make(this[0]):this},exports.last=function(){return 1<this.length?this._make(this[this.length-1]):this},exports.eq=function(t){return 0===(t=+t)&&this.length<=1?this:(t<0&&(t=this.length+t),this[t]?this._make(this[t]):this._make([]))},exports.get=function(t){return null==t?Array.prototype.slice.call(this):this[t<0?this.length+t:t]},exports.index=function(t){var e,i;return i=0===arguments.length?(e=this.parent().children(),this[0]):"string"==typeof t?(e=this._make(t),this[0]):(e=this,t.cheerio?t[0]:t),e.get().indexOf(i)},exports.slice=function(){return this._make([].slice.apply(this,arguments))},exports.end=function(){return this.prevObject||this._make([])},exports.add=function(t,e){for(var i=this._make(t,e),r=uniqueSort(i.get().concat(this.get())),n=0;n<r.length;++n)i[n]=r[n];return i.length=r.length,i},exports.addBack=function(t){return this.add(arguments.length?this.prevObject.filter(t):this.prevObject)};