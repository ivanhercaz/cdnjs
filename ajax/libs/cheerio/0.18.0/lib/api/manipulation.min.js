var _=require("lodash"),parse=require("../parse"),$=require("../static"),updateDOM=parse.update,evaluate=parse.evaluate,utils=require("../utils"),domEach=utils.domEach,slice=Array.prototype.slice;exports._makeDomArray=function t(e){return null==e?[]:e.cheerio?e.get():Array.isArray(e)?_.flatten(e.map(t,this)):"string"==typeof e?evaluate(e,this.options):[e]};var _insert=function(o){return function(){var n=this,r=slice.call(arguments),i=this._makeDomArray(r);return"function"==typeof r[0]?domEach(this,function(t,e){i=n._makeDomArray(r[0].call(e,t,$.html(e.children))),o(i,e.children,e)}):domEach(this,function(t,e){o(i,e.children,e)})}},uniqueSplice=function(t,e,n,r,i){var o,l,a,c,u,h=[e,n].concat(r),p=t[e-1]||null,s=t[e]||null;for(o=0,l=r.length;o<l;++o)a=(u=(c=r[o]).parent||c.root)&&u.children.indexOf(r[o]),u&&-1<a&&(u.children.splice(a,1),i===u&&a<e&&h[0]--),c.root=null,c.parent=i,c.prev&&(c.prev.next=c.next||null),c.next&&(c.next.prev=c.prev||null),c.prev=r[o-1]||p,c.next=r[o+1]||s;return p&&(p.next=r[0]),s&&(s.prev=r[r.length-1]),t.splice.apply(t,h)};exports.append=_insert(function(t,e,n){uniqueSplice(e,e.length,0,t,n)}),exports.prepend=_insert(function(t,e,n){uniqueSplice(e,0,0,t,n)}),exports.after=function(){var o=slice.call(arguments),l=this._makeDomArray(o),a=this;return domEach(this,function(t,e){var n=e.parent||e.root;if(n){var r=n.children,i=r.indexOf(e);~i&&("function"==typeof o[0]&&(l=a._makeDomArray(o[0].call(e,t,$.html(e.children)))),uniqueSplice(r,++i,0,l,n))}}),this},exports.before=function(){var o=slice.call(arguments),l=this._makeDomArray(o),a=this;return domEach(this,function(t,e){var n=e.parent||e.root;if(n){var r=n.children,i=r.indexOf(e);~i&&("function"==typeof o[0]&&(l=a._makeDomArray(o[0].call(e,t,$.html(e.children)))),uniqueSplice(r,i,0,l,n))}}),this},exports.remove=function(t){var e=this;return t&&(e=e.filter(t)),domEach(e,function(t,e){var n=e.parent||e.root;if(n){var r=n.children,i=r.indexOf(e);~i&&(r.splice(i,1),e.prev&&(e.prev.next=e.next),e.next&&(e.next.prev=e.prev),e.prev=e.next=e.parent=e.root=null)}}),this},exports.replaceWith=function(l){var a=this;return domEach(this,function(t,e){var n=e.parent||e.root;if(n){var r,i=n.children,o=a._makeDomArray("function"==typeof l?l.call(e,t,e):l);updateDOM(o,null),r=i.indexOf(e),uniqueSplice(i,r,1,o,n),e.parent=e.prev=e.next=e.root=null}}),this},exports.empty=function(){return domEach(this,function(t,e){_.each(e.children,function(t){t.next=t.prev=t.parent=null}),e.children.length=0}),this},exports.html=function(r){if(void 0===r)return this[0]&&this[0].children?$.html(this[0].children,this.options):null;var i=this.options;return domEach(this,function(t,e){_.each(e.children,function(t){t.next=t.prev=t.parent=null});var n=r.cheerio?r.clone().get():evaluate(r,i);updateDOM(n,e)}),this},exports.toString=function(){return $.html(this)},exports.text=function(r){return void 0===r?$.text(this):"function"==typeof r?domEach(this,function(t,e){var n=[e];return exports.text.call(n,r.call(e,t,$.text(n)))}):(domEach(this,function(t,e){_.each(e.children,function(t){t.next=t.prev=t.parent=null}),updateDOM({data:r,type:"text",parent:e,prev:null,next:null,children:[]},e)}),this)},exports.clone=function(){return this._make($.html(this,this.options))};