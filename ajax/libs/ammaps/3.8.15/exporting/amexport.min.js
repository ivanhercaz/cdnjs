AmCharts.AmExport=AmCharts.Class({construct:function(t,e){var o=this;o.DEBUG=!1,o.chart=t,o.canvas=null,o.svgs=[],o.userCFG=e,o.buttonIcon="export.png",o.exportPNG=!0,o.exportPDF=!1,o.exportJPG=!1,o.exportSVG=!1,o.right=0,o.top=0,o.buttonRollOverColor="#EFEFEF",o.textRollOverColor="#CC0000",o.buttonTitle="Save chart as an image",o.buttonAlpha=.75,o.imageFileName="amChart",o.imageBackgroundColor="#FFFFFF"},toCoordinate:function(t){return void 0===t?"auto":-1!=String(t).indexOf("%")?t:t+"px"},init:function(){var t=this,e=[];t.exportPNG&&e.push("png"),t.exportPDF&&e.push("pdf"),t.exportJPG&&e.push("jpg"),t.exportSVG&&e.push("svg");var o=[];if(1==e.length){var a=e[0];o.push({format:a,iconTitle:t.buttonTitle,icon:t.chart.pathToImages+t.buttonIcon})}else if(1<e.length){for(var r=[],n=0;n<e.length;n++)r.push({format:e[n],title:e[n].toUpperCase()});o.push({onclick:function(){},icon:t.chart.pathToImages+t.buttonIcon,items:r})}var i=t.color;void 0===i&&(i=t.chart.color);var u=t.buttonColor;void 0===u&&(u="transparent"),t.cfg={menuTop:t.toCoordinate(t.top),menuLeft:t.toCoordinate(t.left),menuRight:t.toCoordinate(t.right),menuBottom:t.toCoordinate(t.bottom),menuItems:o,menuItemStyle:{backgroundColor:u,opacity:t.buttonAlpha,rollOverBackgroundColor:t.buttonRollOverColor,color:i,rollOverColor:t.textRollOverColor,paddingTop:"6px",paddingRight:"6px",paddingBottom:"6px",paddingLeft:"6px",marginTop:"0px",marginRight:"0px",marginBottom:"0px",marginLeft:"0px",textAlign:"left",textDecoration:"none",fontFamily:t.chart.fontFamily,fontSize:t.chart.fontSize+"px"},menuItemOutput:{backgroundColor:t.imageBackgroundColor,fileName:t.imageFileName,format:"png",output:"dataurlnewwindow",render:"browser",dpi:90,onclick:function(t,e,o){o.preventDefault(),t.polifySVG(),t.output(e)}},removeImagery:!1},t.processing={buffer:[],drawn:0,timer:0},void 0!==window.canvg&&void 0!==window.RGBColor&&(t.cfg.menuItemOutput.render="canvg"),void 0!==window.saveAs&&(t.cfg.menuItemOutput.output="save"),AmCharts.isIE&&AmCharts.IEversion<10&&(t.cfg.menuItemOutput.output="dataurlnewwindow");var s=t.userCFG;s&&(s.menuItemOutput=AmCharts.extend(t.cfg.menuItemOutput,s.menuItemOutput||{}),s.menuItemStyle=AmCharts.extend(t.cfg.menuItemStyle,s.menuItemStyle||{}),t.cfg=AmCharts.extend(t.cfg,s)),(t.chart.AmExport=t).chart.addListener("rendered",function(){t.setup()}),t.DEBUG&&(window.AmExport=t)},log:function(){console.log("AmExport: ",arguments)},setup:function(){var t=this;10==t.DEBUG&&t.log("SETUP START"),!AmCharts.isIE||AmCharts.isIE&&9<AmCharts.IEversion?(t.generateButtons(),10==t.DEBUG&&t.log("SETUP END")):10==t.DEBUG&&t.log("< IE10 NOT SUPPORTED")},generateBinaryArray:function(t){for(var e,o,a=t.length,r=new Uint8Array(a/4*3|0),n=0,i=0,u=[0,0],s=0,l=0,g=new Uint8Array([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51]);a--;)255!==(e=g[(o=t.charCodeAt(n++))-43])&&void 0!==e&&(u[1]=u[0],u[0]=o,l=l<<6|e,4===++s&&(r[i++]=l>>>16,61!==u[1]&&(r[i++]=l>>>8),61!==u[0]&&(r[i++]=l),s=0));return r},generateBlob:function(t,e){var o=t.indexOf(",")+1,a=t.substring(0,o),r=t,n=new Blob;return-1!=a.indexOf("base64")&&(r=this.generateBinaryArray(t.substring(o))),AmCharts.isIE&&AmCharts.IEversion<10?(n.data=r,n.size=r.length,n.type=e,n.encoding="base64"):n=new Blob([r],{type:e}),n},generatePDF:function(t){var e=this,o={output:function(){return""}},a=e.canvas.toDataURL("image/jpeg"),r=25.4*e.canvas.width/t.dpi,n=25.4*e.canvas.height/t.dpi;return window.jsPDF?(o=new jsPDF).addImage?o.addImage(a,"JPEG",0,0,r,n):alert("Missing jsPDF plugin; Please add the 'addImage' plugin."):alert("Missing jsPDF lib; Don't forget to add the addImage plugin."),o},output:function(a,r){var n=this;return a=AmCharts.extend(AmCharts.extend({},n.cfg.menuItemOutput),a||{}),n.generateOutput(a,function(){var t,e=null;if(10==n.DEBUG&&n.log("OUTPUT",format),"image/svg+xml"==a.format||"svg"==a.format)for(var o=0;o<n.processing.buffer.length;o++)e=(new XMLSerializer).serializeToString(n.processing.buffer[o][0]),t=n.generateBlob(e,"image/svg+xml"),"save"==a.output?saveAs(t,a.fileName+".svg"):"datastring"==a.output||"datauristring"==a.output||"dataurlstring"==a.output?t="data:image/svg+xml;base64,"+btoa(e):"dataurlnewwindow"==a.output?window.open("data:image/svg+xml;base64,"+btoa(e)):"datauri"==a.output||"dataurl"==a.output?location.href="data:image/svg+xml;base64,"+btoa(e):"datastream"==a.output&&(location.href="data:image/octet-stream;base64,"+btoa(e)),r&&r.apply(n,[t]);else"application/pdf"==a.format||"pdf"==a.format?(e=n.generatePDF(a).output("dataurlstring"),t=n.generateBlob(e,"application/pdf"),"save"==a.output?saveAs(t,a.fileName+".pdf"):"datastring"==a.output||"datauristring"==a.output||"dataurlstring"==a.output?t=e:"dataurlnewwindow"==a.output?window.open(e):"datauri"==a.output||"dataurl"==a.output?location.href=e:"datastream"==a.output&&(location.href=e.replace("application/pdf","application/octet-stream")),r&&r.apply(n,[t])):"image/png"==a.format||"png"==a.format?(e=n.canvas.toDataURL("image/png"),t=n.generateBlob(e,"image/png"),"save"==a.output?saveAs(t,a.fileName+".png"):"datastring"==a.output||"datauristring"==a.output||"dataurlstring"==a.output?t=e:"dataurlnewwindow"==a.output?window.open(e):"datauri"==a.output||"dataurl"==a.output?location.href=e:"datastream"==a.output&&(location.href=e.replace("image/png","image/octet-stream")),r&&r.apply(n,[t])):"image/jpeg"!=a.format&&"jpeg"!=a.format&&"jpg"!=a.format||(e=n.canvas.toDataURL("image/jpeg"),t=n.generateBlob(e,"image/jpeg"),"save"==a.output?saveAs(t,a.fileName+".jpg"):"datastring"==a.output||"datauristring"==a.output||"dataurlstring"==a.output?t=e:"dataurlnewwindow"==a.output?window.open(e):"datauri"==a.output||"dataurl"==a.output?location.href=e:"datastream"==a.output&&(location.href=e.replace("image/jpeg","image/octet-stream")),r&&r.apply(n,[t]))})},polifySVG:function(){var u=this,t=u.chart.div.getElementsByTagName("svg");function e(t,e){for(var o=t.getElementsByTagName(e),a=0;a<o.length;a++){if(u.cfg.removeImagery)o[a].parentNode.removeChild(o[a]);else{var r=document.createElement("img"),n=document.createElement("canvas"),i=n.getContext("2d");n.width=o[a].getAttribute("width"),n.height=o[a].getAttribute("height"),r.src=o[a].getAttribute("xlink:href"),r.width=o[a].getAttribute("width"),r.height=o[a].getAttribute("height");try{i.drawImage(r,0,0,r.width,r.height),datastring=n.toDataURL()}catch(t){throw datastring=r.src,u.log("Tainted canvas, reached browser CORS security; origin from imagery must be equal to the server!"),new Error(t)}o[a].setAttribute("xlink:href",datastring)}10==u.DEBUG&&u.log("POLIFIED",o[a])}}for(var o=0;o<t.length;o++){t[o].parentNode;0==AmCharts.IEversion&&t[o].setAttribute("xmlns","http://www.w3.org/2000/svg"),10==u.DEBUG&&u.log("POLIFIED",t[o]),e(t[o],"pattern"),e(t[o],"image"),u.svgs.push(t[o])}return t},generateOutput:function(n,i){var u=this,t=u.chart.div.getElementsByTagName("svg"),s=document.createElement("canvas"),l=s.getContext("2d"),e={y:0,x:0},o={};u.processing.buffer=[],u.processing.drawn=0,u.canvas=s,10==u.DEBUG&&u.log("START EXPORT"),10==u.DEBUG&&u.log("START BUFFERING");for(var a=0;a<t.length;a++){var r=t[a].parentNode,g=Number(r.style.left.slice(0,-2)),p=Number(r.style.top.slice(0,-2));o=AmCharts.extend({},e),"relative"==r.style.position?(e.x=g||e.x,e.y=p||e.y):(e.x=g,e.y=p),u.processing.buffer.push([t[a],AmCharts.extend({},e)]),p&&g?e=o:e.y+=p?0:r.offsetHeight,10==u.DEBUG&&u.log("BUFFERED",t[a],e)}return 10==u.DEBUG&&u.log("END BUFFERING"),10==u.DEBUG&&u.log("START DRAWING",n.render),10==u.DEBUG&&u.log("FILL BACKGROUND"),s.id=AmCharts.getUniqueId(),s.width=u.chart.divRealWidth,s.height=u.chart.divRealHeight,!n.backgroundColor&&"image/jpeg"!=n.format||(l.fillStyle=n.backgroundColor||"#FFFFFF",l.fillRect(0,0,s.width,s.height)),function t(){var e,o,a,r;if(u.processing.buffer.length==u.processing.drawn)return 10==u.DEBUG&&u.log("END DRAWING"),i();10==u.DEBUG&&u.log("DRAW",u.processing.drawn+1,"OF",u.processing.buffer.length),o=u.processing.buffer[u.processing.drawn],r=(new XMLSerializer).serializeToString(o[0]),a=o[1],10==u.DEBUG&&u.log("SOURCE",r),"browser"==n.render?((e=new Image).id=AmCharts.getUniqueId(),r="data:image/svg+xml;base64,"+btoa(r),e.onload=function(){l.drawImage(this,o[1].x,o[1].y),u.processing.drawn++,10==u.DEBUG&&u.log("ONLOAD",this),t()},e.onerror=function(){10==u.DEBUG&&u.log("ONERROR",this),l.drawImage(this,o[1].x,o[1].y),u.processing.drawn++,t()},e.src=r,10==u.DEBUG&&u.log("ADD",e),!e.complete&&void 0!==e.complete&&void 0!==e.complete||(10==u.DEBUG&&u.log("FORCE ONLOAD",e),e.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",e.src=r)):"canvg"==n.render&&canvg(s,r,{offsetX:a.x,offsetY:a.y,ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,ignoreClear:!0,renderCallback:function(){u.processing.drawn++,t()}})}()},generateButtons:function(){var g=this,t=document.createElement("div");t.setAttribute("style","width:39px; height:28px; position: absolute;top:"+g.cfg.menuTop+";right:"+g.cfg.menuRight+";bottom:"+g.cfg.menuBottom+";left:"+g.cfg.menuLeft+";box-shadow:0px 0px 1px 0px rgba(0,0,0,0);"),t.setAttribute("class","amExportButton"),t.appendChild(function t(e){var o=document.createElement("ul");o.setAttribute("style","list-style: none; margin: 0; padding: 0;");for(var a=0;a<e.length;a++){var r=document.createElement("li"),n=document.createElement("img"),i=document.createElement("a"),u=e[a],s=null,l=AmCharts.extend(AmCharts.extend({},g.cfg.menuItemStyle),e[a]);(u=AmCharts.extend(AmCharts.extend({},g.cfg.menuItemOutput),u)).icon&&(n.alt="",n.src=u.icon,n.setAttribute("style","margin: 0 auto;border: none;outline: none"),u.iconTitle&&(n.title=u.iconTitle),i.appendChild(n)),i.href="#",u.title&&(n.setAttribute("style","margin-right: 5px;"),i.innerHTML+=u.title),i.setAttribute("style","display: block;"),AmCharts.extend(i.style,l),i.onclick=u.onclick.bind(i,g,u),r.appendChild(i),u.items&&(s=t(u.items),r.appendChild(s),r.onmouseover=function(){s.style.display="block"},r.onmouseout=function(){s.style.display="none"},s.style.display="none"),o.appendChild(r),i.onmouseover=function(){this.style.backgroundColor=l.rollOverBackgroundColor,this.style.color=l.rollOverColor,this.style.borderColor=l.rollOverBorderColor},i.onmouseout=function(){this.style.backgroundColor=l.backgroundColor,this.style.color=l.color,this.style.borderColor=l.borderColor}}return 10==g.DEBUG&&g.log("MENU",o),o}(g.cfg.menuItems)),g.chart.containerDiv.appendChild(t)}});