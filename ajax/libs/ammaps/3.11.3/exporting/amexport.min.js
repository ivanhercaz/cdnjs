AmCharts.AmExport=AmCharts.Class({construct:function(t,e,o){var r=this;r.DEBUG=!1,r.chart=t,r.canvas=null,r.svgs=[],r.userCFG=e,r.buttonIcon="export.png",r.exportPNG=!0,r.exportPDF=!1,r.exportJPG=!1,r.exportSVG=!1,r.right=0,r.top=0,r.buttonRollOverColor="#EFEFEF",r.textRollOverColor="#CC0000",r.buttonTitle="Save chart as an image",r.buttonAlpha=.75,r.imageFileName="amChart",r.imageBackgroundColor="#FFFFFF",o&&r.init()},toCoordinate:function(t){return void 0===t?"auto":-1!=String(t).indexOf("%")?t:t+"px"},init:function(){var t=this,e=[];t.exportPNG&&e.push("png"),t.exportPDF&&e.push("pdf"),t.exportJPG&&e.push("jpg"),t.exportSVG&&e.push("svg");var o=[];if(1==e.length){var r=e[0];o.push({format:r,iconTitle:t.buttonTitle,icon:t.chart.pathToImages+t.buttonIcon})}else if(1<e.length){for(var n=[],a=0;a<e.length;a++)n.push({format:e[a],title:e[a].toUpperCase()});o.push({onclick:function(){},icon:t.chart.pathToImages+t.buttonIcon,items:n})}var i=t.color;void 0===i&&(i=t.chart.color);var s=t.buttonColor;void 0===s&&(s="transparent"),t.cfg={menuTop:t.toCoordinate(t.top),menuLeft:t.toCoordinate(t.left),menuRight:t.toCoordinate(t.right),menuBottom:t.toCoordinate(t.bottom),menuItems:o,menuItemStyle:{backgroundColor:s,opacity:t.buttonAlpha,rollOverBackgroundColor:t.buttonRollOverColor,color:i,rollOverColor:t.textRollOverColor,paddingTop:"6px",paddingRight:"6px",paddingBottom:"6px",paddingLeft:"6px",marginTop:"0px",marginRight:"0px",marginBottom:"0px",marginLeft:"0px",textAlign:"left",textDecoration:"none",fontFamily:t.chart.fontFamily,fontSize:t.chart.fontSize+"px"},menuItemOutput:{backgroundColor:t.imageBackgroundColor,fileName:t.imageFileName,format:"png",output:"dataurlnewwindow",render:"browser",dpi:90,onclick:function(t,e,o){o.preventDefault(),t.output(e)}},removeImagery:!0},t.processing={buffer:[],drawn:0,timer:0},void 0!==window.canvg&&void 0!==window.RGBColor&&(t.cfg.menuItemOutput.render="canvg"),void 0!==window.saveAs&&(t.cfg.menuItemOutput.output="save"),AmCharts.isIE&&AmCharts.IEversion<10&&(t.cfg.menuItemOutput.output="dataurlnewwindow");var l=t.userCFG;l&&(l.menuItemOutput=AmCharts.extend(t.cfg.menuItemOutput,l.menuItemOutput||{}),l.menuItemStyle=AmCharts.extend(t.cfg.menuItemStyle,l.menuItemStyle||{}),t.cfg=AmCharts.extend(t.cfg,l)),(t.chart.AmExport=t).chart.addListener("rendered",function(){t.setup()}),t.DEBUG&&(window.AmExport=t)},log:function(){console.log("AmExport: ",arguments)},setup:function(){(!AmCharts.isIE||AmCharts.isIE&&9<AmCharts.IEversion)&&this.generateButtons()},generateBinaryArray:function(t){for(var e,o,r=t.length,n=new Uint8Array(r/4*3|0),a=0,i=0,s=[0,0],l=0,g=0,u=new Uint8Array([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51]);r--;)255!==(e=u[(o=t.charCodeAt(a++))-43])&&void 0!==e&&(s[1]=s[0],s[0]=o,g=g<<6|e,4===++l&&(n[i++]=g>>>16,61!==s[1]&&(n[i++]=g>>>8),61!==s[0]&&(n[i++]=g),l=0));return n},generateBlob:function(t,e){var o="image/svg+xml"!=e?t.indexOf(",")+1:0,r=t.substring(0,o),n=t,a=new Blob;return-1!=r.indexOf("base64")&&(n=this.generateBinaryArray(t.substring(o))),AmCharts.isIE&&AmCharts.IEversion<10?(a.data=n,a.size=n.length,a.type=e,a.encoding="base64"):a=new Blob([n],{type:e}),a},generatePDF:function(t){var e=this,o={output:function(){return""}},r=e.canvas.toDataURL("image/jpeg"),n=25.4*e.canvas.width/t.dpi,a=25.4*e.canvas.height/t.dpi;return window.jsPDF?(o=new jsPDF).addImage?o.addImage(r,"JPEG",0,0,n,a):alert("Missing jsPDF plugin; Please add the 'addImage' plugin."):alert("Missing jsPDF lib; Don't forget to add the addImage plugin."),o},output:function(o,r){var n=this;return o=AmCharts.extend(AmCharts.extend({},n.cfg.menuItemOutput),o||{}),n.chart.prepareForExport&&n.chart.prepareForExport(),n.generateOutput(o,function(){var t,e=null;"image/svg+xml"==o.format||"svg"==o.format?(e=n.generateSVG(),t=n.generateBlob(e,"image/svg+xml"),"save"==o.output?saveAs(t,o.fileName+".svg"):"datastring"==o.output||"datauristring"==o.output||"dataurlstring"==o.output?t="data:image/svg+xml;base64,"+btoa(e):"dataurlnewwindow"==o.output?window.open("data:image/svg+xml;base64,"+btoa(e)):"datauri"==o.output||"dataurl"==o.output?location.href="data:image/svg+xml;base64,"+btoa(e):"datastream"==o.output&&(location.href="data:image/octet-stream;base64,"+e),r&&r.apply(n,[t])):"application/pdf"==o.format||"pdf"==o.format?(e=n.generatePDF(o).output("dataurlstring"),t=n.generateBlob(e,"application/pdf"),"save"==o.output?saveAs(t,o.fileName+".pdf"):"datastring"==o.output||"datauristring"==o.output||"dataurlstring"==o.output?t=e:"dataurlnewwindow"==o.output?window.open(e):"datauri"==o.output||"dataurl"==o.output?location.href=e:"datastream"==o.output&&(location.href=e.replace("application/pdf","application/octet-stream")),r&&r.apply(n,[t])):"image/png"==o.format||"png"==o.format?(e=n.canvas.toDataURL("image/png"),t=n.generateBlob(e,"image/png"),"save"==o.output?saveAs(t,o.fileName+".png"):"datastring"==o.output||"datauristring"==o.output||"dataurlstring"==o.output?t=e:"dataurlnewwindow"==o.output?window.open(e):"datauri"==o.output||"dataurl"==o.output?location.href=e:"datastream"==o.output&&(location.href=e.replace("image/png","image/octet-stream")),r&&r.apply(n,[t])):"image/jpeg"!=o.format&&"jpeg"!=o.format&&"jpg"!=o.format||(e=n.canvas.toDataURL("image/jpeg"),t=n.generateBlob(e,"image/jpeg"),"save"==o.output?saveAs(t,o.fileName+".jpg"):"datastring"==o.output||"datauristring"==o.output||"dataurlstring"==o.output?t=e:"dataurlnewwindow"==o.output?window.open(e):"datauri"==o.output||"dataurl"==o.output?location.href=e:"datastream"==o.output&&(location.href=e.replace("image/jpeg","image/octet-stream")),r&&r.apply(n,[t]))})},polifySVG:function(t){var s=this;function e(t,e){for(var o=t.getElementsByTagName(e),r=o.length;r--;)if(s.cfg.removeImagery)o[r].parentNode.removeChild(o[r]);else{var n=document.createElement("img"),a=document.createElement("canvas"),i=a.getContext("2d");a.width=o[r].getAttribute("width"),a.height=o[r].getAttribute("height"),n.src=o[r].getAttribute("xlink:href"),n.width=o[r].getAttribute("width"),n.height=o[r].getAttribute("height");try{i.drawImage(n,0,0,n.width,n.height),datastring=a.toDataURL()}catch(t){throw datastring=n.src,s.log("Tainted canvas, reached browser CORS security; origin from imagery must be equal to the server!"),new Error(t)}o[r].setAttribute("xlink:href",datastring)}}return 0==AmCharts.IEversion&&(t.setAttribute("xmlns","http://www.w3.org/2000/svg"),s.cfg.removeImagery||t.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink")),e(t,"pattern"),e(t,"image"),s.svgs.push(t),t},generateSVG:function(){var t=document.createElement("svg");t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");for(var e=0;e<this.processing.buffer.length;e++){var o=document.createElement("g"),r=this.processing.buffer[e];r[0].setAttribute("xmlns","http://www.w3.org/2000/svg"),r[0].setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),o.setAttribute("transform","translate("+r[1].x+","+r[1].y+")"),o.appendChild(r[0]),t.appendChild(o)}return(new XMLSerializer).serializeToString(t)},generateOutput:function(a,i){for(var s=this,t=[],l=document.createElement("canvas"),g=l.getContext("2d"),e={y:0,x:0},o=s.chart.div.getElementsByTagName("svg"),r=0;r<o.length;r++)t.push(o[r]);s.chart.legend&&"outside"==s.chart.legend.position&&(s.chart.legend.container.container.externalLegend=!0,t.push(s.chart.legend.container.container),"left"==s.cfg.legendPosition?e.x=s.chart.legend.div.offsetWidth:"top"==s.cfg.legendPosition?e.y=s.chart.legend.div.offsetHeight:"object"==typeof s.cfg.legendPosition&&(e.y=s.cfg.legendPosition.chartTop,e.x=s.cfg.legendPosition.chartLeft)),s.processing.buffer=[],s.processing.drawn=0,s.canvas=l,s.svgs=[];var n={x:0,y:0};for(r=0;r<t.length;r++){var u=t[r].parentNode,d=Number(u.style.left.slice(0,-2)),c=Number(u.style.top.slice(0,-2)),p=s.polifySVG(t[r].cloneNode(!0)),m=AmCharts.extend({},e);t[r].externalLegend?"right"==s.cfg.legendPosition?(e.y=0,e.x=s.chart.divRealWidth):"bottom"==s.cfg.legendPosition?e.y=c||e.y:"object"==typeof s.cfg.legendPosition?(e.x=s.cfg.legendPosition.left,e.y=s.cfg.legendPosition.top):(e.x=0,e.y=0):"relative"==u.style.position?(e.x=d||e.x,e.y=c||e.y):(e.x=d+n.x,e.y=c+n.y),s.processing.buffer.push([p,AmCharts.extend({},e)]),c&&d?e=m:e.y+=c?0:u.offsetHeight,"absolute"==u.style.position&&"amChartsLegend"==u.getAttribute("class")&&(n.y+=u.parentNode.offsetHeight)}l.id=AmCharts.getUniqueId(),l.width=s.chart.divRealWidth,l.height=s.chart.divRealHeight,s.chart.legend&&"outside"==s.chart.legend.position&&(-1!=["left","right"].indexOf(s.cfg.legendPosition)?l.width+=s.chart.legend.div.offsetWidth:"object"==typeof s.cfg.legendPosition?(l.width+=s.cfg.legendPosition.width,l.height+=s.cfg.legendPosition.height):l.height+=s.chart.legend.div.offsetHeight);var h={width:!1,height:!1};return s.chart.periodSelector&&(-1!=["left","right"].indexOf(s.chart.periodSelector.position)?(l.width-=s.chart.periodSelector.div.offsetWidth+16,h.width=!0):(l.height-=s.chart.periodSelector.div.offsetHeight,h.height=!0)),s.chart.dataSetSelector&&(-1!=["left","right"].indexOf(s.chart.dataSetSelector.position)?h.width||(l.width-=s.chart.dataSetSelector.div.offsetWidth+16):l.height-=s.chart.dataSetSelector.div.offsetHeight),!a.backgroundColor&&"image/jpeg"!=a.format||(g.fillStyle=a.backgroundColor||"#FFFFFF",g.fillRect(0,0,l.width,l.height)),function t(){var e,o,r,n;if(s.processing.buffer.length==s.processing.drawn||"svg"==a.format)return i();o=s.processing.buffer[s.processing.drawn],n=(new XMLSerializer).serializeToString(o[0]),r=o[1],"browser"==a.render?((e=new Image).id=AmCharts.getUniqueId(),n="data:image/svg+xml;base64,"+btoa(n),e.onload=function(){g.drawImage(this,o[1].x,o[1].y),s.processing.drawn++,t()},e.onerror=function(){g.drawImage(this,o[1].x,o[1].y),s.processing.drawn++,t()},e.src=n,!e.complete&&void 0!==e.complete&&void 0!==e.complete||(e.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",e.src=n)):"canvg"==a.render&&canvg(l,n,{offsetX:r.x,offsetY:r.y,ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,ignoreClear:!0,renderCallback:function(){s.processing.drawn++,t()}})}()},generateButtons:function(){var u=this;u.div?(div=u.div,div.innerHTML=""):(div=document.createElement("div"),u.div=div),div.setAttribute("style","position: absolute;top:"+u.cfg.menuTop+";right:"+u.cfg.menuRight+";bottom:"+u.cfg.menuBottom+";left:"+u.cfg.menuLeft+";"),div.setAttribute("class","amExportButton"),div.appendChild(function t(e){var o=document.createElement("ul");o.setAttribute("style","list-style: none; margin: 0; padding: 0;");for(var r=0;r<e.length;r++){var n=document.createElement("li"),a=document.createElement("img"),i=document.createElement("a"),s=e[r],l=null,g=AmCharts.extend(AmCharts.extend({},u.cfg.menuItemStyle),e[r]);(s=AmCharts.extend(AmCharts.extend({},u.cfg.menuItemOutput),s)).icon&&(a.alt="",a.src=s.icon,a.setAttribute("style","margin: 0 auto;border: none;outline: none"),s.iconTitle&&(a.title=s.iconTitle),i.appendChild(a)),i.href="#",s.title&&(a.setAttribute("style","margin: 0px 5px;"),i.innerHTML+=s.title),i.setAttribute("style","display: block;"),AmCharts.extend(i.style,g),i.onclick=s.onclick.bind(i,u,s),n.appendChild(i),s.items&&(l=t(s.items),n.appendChild(l),n.onmouseover=function(){l.style.display="block"},n.onmouseout=function(){l.style.display="none"},l.style.display="none"),o.appendChild(n),i.onmouseover=function(){this.style.backgroundColor=g.rollOverBackgroundColor,this.style.color=g.rollOverColor,this.style.borderColor=g.rollOverBorderColor},i.onmouseout=function(){this.style.backgroundColor=g.backgroundColor,this.style.color=g.color,this.style.borderColor=g.borderColor}}return o}(u.cfg.menuItems)),u.chart.containerDiv.appendChild(div)}});