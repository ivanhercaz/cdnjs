AmCharts.AmExport=AmCharts.Class({construct:function(t,e){var a=this;a.DEBUG=!1,a.chart=t,a.canvas=null,a.svgs=[],a.cfg={menuTop:"auto",menuLeft:"auto",menuRight:"0px",menuBottom:"0px",menuItems:[{textAlign:"center",icon:a.chart.pathToImages+"export.png",iconTitle:"Save chart as an image",format:"png"}],menuItemStyle:{backgroundColor:"transparent",rollOverBackgroundColor:"#EFEFEF",color:"#000000",rollOverColor:"#CC0000",paddingTop:"6px",paddingRight:"6px",paddingBottom:"6px",paddingLeft:"6px",marginTop:"0px",marginRight:"0px",marginBottom:"0px",marginLeft:"0px",textAlign:"left",textDecoration:"none",fontFamily:a.chart.fontFamily,fontSize:a.chart.fontSize+"px"},menuItemOutput:{backgroundColor:"#FFFFFF",fileName:"amChart",format:"png",output:"dataurlnewwindow",render:"browser",dpi:90,onclick:function(t,e,a){a.preventDefault(),t.polifySVG(),t.output(e)}},removeImagery:!1},a.processing={buffer:[],drawn:0,timer:0},void 0!==window.canvg&&void 0!==window.RGBColor&&(a.cfg.menuItemOutput.render="canvg"),void 0!==window.saveAs&&(a.cfg.menuItemOutput.output="save"),AmCharts.isIE&&AmCharts.IEversion<10&&(a.cfg.menuItemOutput.output="dataurlnewwindow"),e&&(e.menuItemOutput=AmCharts.extend(a.cfg.menuItemOutput,e.menuItemOutput||{}),e.menuItemStyle=AmCharts.extend(a.cfg.menuItemStyle,e.menuItemStyle||{}),a.cfg=AmCharts.extend(a.cfg,e)),(a.chart.AmExport=a).chart.addListener("rendered",function(){a.setup()}),a.DEBUG&&(window.AmExport=a)},log:function(){console.log("AmExport: ",arguments)},setup:function(){var t=this;10==t.DEBUG&&t.log("SETUP START"),!AmCharts.isIE||AmCharts.isIE&&9<AmCharts.IEversion?(t.generateButtons(),10==t.DEBUG&&t.log("SETUP END")):10==t.DEBUG&&t.log("< IE10 NOT SUPPORTED")},generateBinaryArray:function(t){for(var e,a,r=t.length,n=new Uint8Array(r/4*3|0),o=0,i=0,u=[0,0],s=0,g=0,l=new Uint8Array([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51]);r--;)255!==(e=l[(a=t.charCodeAt(o++))-43])&&void 0!==e&&(u[1]=u[0],u[0]=a,g=g<<6|e,4===++s&&(n[i++]=g>>>16,61!==u[1]&&(n[i++]=g>>>8),61!==u[0]&&(n[i++]=g),s=0));return n},generateBlob:function(t,e){var a=t.indexOf(",")+1,r=t.substring(0,a),n=t,o=new Blob;return-1!=r.indexOf("base64")&&(n=this.generateBinaryArray(t.substring(a))),AmCharts.isIE&&AmCharts.IEversion<10?(o.data=n,o.size=n.length,o.type=e,o.encoding="base64"):o=new Blob([n],{type:e}),o},generatePDF:function(t){var e=this,a={output:function(){return""}},r=e.canvas.toDataURL("image/jpeg"),n=25.4*e.canvas.width/t.dpi,o=25.4*e.canvas.height/t.dpi;return window.jsPDF?(a=new jsPDF).addImage?a.addImage(r,"JPEG",0,0,n,o):alert("Missing jsPDF plugin; Please add the 'addImage' plugin."):alert("Missing jsPDF lib; Don't forget to add the addImage plugin."),a},output:function(r,n){var o=this;return r=AmCharts.extend(AmCharts.extend({},o.cfg.menuItemOutput),r||{}),o.generateOutput(r,function(){var t,e=null;if(10==o.DEBUG&&o.log("OUTPUT",format),"image/svg+xml"==r.format||"svg"==r.format)for(var a=0;a<o.processing.buffer.length;a++)e=(new XMLSerializer).serializeToString(o.processing.buffer[a][0]),t=o.generateBlob(e,"image/svg+xml"),"save"==r.output?saveAs(t,r.fileName+".svg"):"datastring"==r.output||"datauristring"==r.output||"dataurlstring"==r.output?t="data:image/svg+xml;base64,"+btoa(e):"dataurlnewwindow"==r.output?window.open("data:image/svg+xml;base64,"+btoa(e)):"datauri"==r.output||"dataurl"==r.output?location.href="data:image/svg+xml;base64,"+btoa(e):"datastream"==r.output&&(location.href="data:image/octet-stream;base64,"+btoa(e)),n&&n.apply(o,[t]);else"application/pdf"==r.format||"pdf"==r.format?(e=o.generatePDF(r).output("dataurlstring"),t=o.generateBlob(e,"application/pdf"),"save"==r.output?saveAs(t,r.fileName+".pdf"):"datastring"==r.output||"datauristring"==r.output||"dataurlstring"==r.output?t=e:"dataurlnewwindow"==r.output?window.open(e):"datauri"==r.output||"dataurl"==r.output?location.href=e:"datastream"==r.output&&(location.href=e.replace("application/pdf","application/octet-stream")),n&&n.apply(o,[t])):"image/png"==r.format||"png"==r.format?(e=o.canvas.toDataURL("image/png"),t=o.generateBlob(e,"image/png"),"save"==r.output?saveAs(t,r.fileName+".png"):"datastring"==r.output||"datauristring"==r.output||"dataurlstring"==r.output?t=e:"dataurlnewwindow"==r.output?window.open(e):"datauri"==r.output||"dataurl"==r.output?location.href=e:"datastream"==r.output&&(location.href=e.replace("image/png","image/octet-stream")),n&&n.apply(o,[t])):"image/jpeg"!=r.format&&"jpeg"!=r.format&&"jpg"!=r.format||(e=o.canvas.toDataURL("image/jpeg"),t=o.generateBlob(e,"image/jpeg"),"save"==r.output?saveAs(t,r.fileName+".jpg"):"datastring"==r.output||"datauristring"==r.output||"dataurlstring"==r.output?t=e:"dataurlnewwindow"==r.output?window.open(e):"datauri"==r.output||"dataurl"==r.output?location.href=e:"datastream"==r.output&&(location.href=e.replace("image/jpeg","image/octet-stream")),n&&n.apply(o,[t]))})},polifySVG:function(){var u=this,t=u.chart.div.getElementsByTagName("svg");function e(t,e){for(var a=t.getElementsByTagName(e),r=0;r<a.length;r++){if(u.cfg.removeImagery)a[r].parentNode.removeChild(a[r]);else{var n=document.createElement("img"),o=document.createElement("canvas"),i=o.getContext("2d");o.width=a[r].getAttribute("width"),o.height=a[r].getAttribute("height"),n.src=a[r].getAttribute("xlink:href"),n.width=a[r].getAttribute("width"),n.height=a[r].getAttribute("height");try{i.drawImage(n,0,0,n.width,n.height),datastring=o.toDataURL()}catch(t){throw datastring=n.src,u.log("Tainted canvas, reached browser CORS security; origin from imagery must be equal to the server!"),new Error(t)}a[r].setAttribute("xlink:href",datastring)}10==u.DEBUG&&u.log("POLIFIED",a[r])}}for(var a=0;a<t.length;a++){t[a].parentNode;AmCharts.isIE||t[a].setAttribute("xmlns","http://www.w3.org/2000/svg"),10==u.DEBUG&&u.log("POLIFIED",t[a]),e(t[a],"pattern"),e(t[a],"image"),u.svgs.push(t[a])}return t},generateOutput:function(o,i){var u=this,t=u.chart.div.getElementsByTagName("svg"),s=document.createElement("canvas"),g=s.getContext("2d"),e={y:0,x:0},a={};u.processing.buffer=[],u.processing.drawn=0,u.canvas=s,10==u.DEBUG&&u.log("START EXPORT"),10==u.DEBUG&&u.log("START BUFFERING");for(var r=0;r<t.length;r++){var n=t[r].parentNode,l=Number(n.style.left.slice(0,-2)),d=Number(n.style.top.slice(0,-2));a=AmCharts.extend({},e),"relative"==n.style.position?(e.x=l||e.x,e.y=d||e.y):(e.x=l,e.y=d),u.processing.buffer.push([t[r],AmCharts.extend({},e)]),d&&l?e=a:e.y+=d?0:n.offsetHeight,10==u.DEBUG&&u.log("BUFFERED",t[r],e)}return 10==u.DEBUG&&u.log("END BUFFERING"),10==u.DEBUG&&u.log("START DRAWING",o.render),10==u.DEBUG&&u.log("FILL BACKGROUND"),s.id=AmCharts.getUniqueId(),s.width=u.chart.divRealWidth,s.height=u.chart.divRealHeight,!o.backgroundColor&&"image/jpeg"!=format||(g.fillStyle=o.backgroundColor||"#FFFFFF",g.fillRect(0,0,s.width,s.height)),function t(){var e,a,r,n;if(u.processing.buffer.length==u.processing.drawn)return 10==u.DEBUG&&u.log("END DRAWING"),i();10==u.DEBUG&&u.log("DRAW",u.processing.drawn+1,"OF",u.processing.buffer.length),a=u.processing.buffer[u.processing.drawn],n=(new XMLSerializer).serializeToString(a[0]),r=a[1],10==u.DEBUG&&u.log("SOURCE",n),"browser"==o.render?((e=new Image).id=AmCharts.getUniqueId(),n="data:image/svg+xml;base64,"+btoa(n),e.onload=function(){g.drawImage(this,a[1].x,a[1].y),u.processing.drawn++,10==u.DEBUG&&u.log("ONLOAD",this),t()},e.onerror=function(){10==u.DEBUG&&u.log("ONERROR",this),g.drawImage(this,a[1].x,a[1].y),u.processing.drawn++,t()},e.src=n,10==u.DEBUG&&u.log("ADD",e),!e.complete&&void 0!==e.complete&&void 0!==e.complete||(10==u.DEBUG&&u.log("FORCE ONLOAD",e),e.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",e.src=n)):"canvg"==o.render&&canvg(s,n,{offsetX:r.x,offsetY:r.y,ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,ignoreClear:!0,renderCallback:function(){u.processing.drawn++,t()}})}()},generateButtons:function(){var l=this,t=document.createElement("div");t.setAttribute("style","width:39px; height:28px; position: absolute;top:"+l.cfg.menuTop+";right:"+l.cfg.menuRight+";bottom:"+l.cfg.menuBottom+";left:"+l.cfg.menuLeft+";box-shadow:0px 0px 1px 0px rgba(0,0,0,0);"),t.setAttribute("class","amExportButton"),t.appendChild(function t(e){var a=document.createElement("ul");a.setAttribute("style","list-style: none; margin: 0; padding: 0;");for(var r=0;r<e.length;r++){var n=document.createElement("li"),o=document.createElement("img"),i=document.createElement("a"),u=e[r],s=null,g=AmCharts.extend(AmCharts.extend({},l.cfg.menuItemStyle),e[r]);(u=AmCharts.extend(AmCharts.extend({},l.cfg.menuItemOutput),u)).icon&&(o.alt="",o.src=u.icon,o.setAttribute("style","margin: 0 auto;border: none;outline: none"),u.iconTitle&&(o.title=u.iconTitle),i.appendChild(o)),i.href="#",u.title&&(o.setAttribute("style","margin-right: 5px;"),i.innerHTML+=u.title),i.setAttribute("style","display: block;"),AmCharts.extend(i.style,g),i.onclick=u.onclick.bind(i,l,u),n.appendChild(i),u.items&&(s=t(u.items),n.appendChild(s),n.onmouseover=function(){s.style.display="block"},n.onmouseout=function(){s.style.display="none"},s.style.display="none"),a.appendChild(n),i.onmouseover=function(){this.style.backgroundColor=g.rollOverBackgroundColor,this.style.color=g.rollOverColor,this.style.borderColor=g.rollOverBorderColor},i.onmouseout=function(){this.style.backgroundColor=g.backgroundColor,this.style.color=g.color,this.style.borderColor=g.borderColor}}return 10==l.DEBUG&&l.log("MENU",a),a}(l.cfg.menuItems)),l.chart.containerDiv.appendChild(t)}});