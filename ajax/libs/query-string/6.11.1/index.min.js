"use strict";const strictUriEncode=require("strict-uri-encode"),decodeComponent=require("decode-uri-component"),splitOnFirst=require("split-on-first");function encoderForArrayFormat(e){switch(e.arrayFormat){case"index":return r=>(t,o)=>{const a=t.length;return void 0===o||e.skipNull&&null===o?t:null===o?[...t,[encode(r,e),"[",a,"]"].join("")]:[...t,[encode(r,e),"[",encode(a,e),"]=",encode(o,e)].join("")]};case"bracket":return r=>(t,o)=>void 0===o||e.skipNull&&null===o?t:null===o?[...t,[encode(r,e),"[]"].join("")]:[...t,[encode(r,e),"[]=",encode(o,e)].join("")];case"comma":case"separator":return r=>(t,o)=>null==o||0===o.length?t:0===t.length?[[encode(r,e),"=",encode(o,e)].join("")]:[[t,encode(o,e)].join(e.arrayFormatSeparator)];default:return r=>(t,o)=>void 0===o||e.skipNull&&null===o?t:null===o?[...t,encode(r,e)]:[...t,[encode(r,e),"=",encode(o,e)].join("")]}}function parserForArrayFormat(e){let r;switch(e.arrayFormat){case"index":return(e,t,o)=>{r=/\[(\d*)\]$/.exec(e),e=e.replace(/\[\d*\]$/,""),r?(void 0===o[e]&&(o[e]={}),o[e][r[1]]=t):o[e]=t};case"bracket":return(e,t,o)=>{r=/(\[\])$/.exec(e),e=e.replace(/\[\]$/,""),r?void 0!==o[e]?o[e]=[].concat(o[e],t):o[e]=[t]:o[e]=t};case"comma":case"separator":return(r,t,o)=>{const a="string"==typeof t&&t.split("").indexOf(e.arrayFormatSeparator)>-1?t.split(e.arrayFormatSeparator).map(r=>decode(r,e)):null===t?t:decode(t,e);o[r]=a};default:return(e,r,t)=>{void 0!==t[e]?t[e]=[].concat(t[e],r):t[e]=r}}}function validateArrayFormatSeparator(e){if("string"!=typeof e||1!==e.length)throw new TypeError("arrayFormatSeparator must be single character string")}function encode(e,r){return r.encode?r.strict?strictUriEncode(e):encodeURIComponent(e):e}function decode(e,r){return r.decode?decodeComponent(e):e}function keysSorter(e){return Array.isArray(e)?e.sort():"object"==typeof e?keysSorter(Object.keys(e)).sort((e,r)=>Number(e)-Number(r)).map(r=>e[r]):e}function removeHash(e){const r=e.indexOf("#");return-1!==r&&(e=e.slice(0,r)),e}function getHash(e){let r="";const t=e.indexOf("#");return-1!==t&&(r=e.slice(t)),r}function extract(e){const r=(e=removeHash(e)).indexOf("?");return-1===r?"":e.slice(r+1)}function parseValue(e,r){return r.parseNumbers&&!Number.isNaN(Number(e))&&"string"==typeof e&&""!==e.trim()?e=Number(e):!r.parseBooleans||null===e||"true"!==e.toLowerCase()&&"false"!==e.toLowerCase()||(e="true"===e.toLowerCase()),e}function parse(e,r){validateArrayFormatSeparator((r=Object.assign({decode:!0,sort:!0,arrayFormat:"none",arrayFormatSeparator:",",parseNumbers:!1,parseBooleans:!1},r)).arrayFormatSeparator);const t=parserForArrayFormat(r),o=Object.create(null);if("string"!=typeof e)return o;if(!(e=e.trim().replace(/^[?#&]/,"")))return o;for(const a of e.split("&")){let[e,n]=splitOnFirst(r.decode?a.replace(/\+/g," "):a,"=");n=void 0===n?null:"comma"===r.arrayFormat?n:decode(n,r),t(decode(e,r),n,o)}for(const e of Object.keys(o)){const t=o[e];if("object"==typeof t&&null!==t)for(const e of Object.keys(t))t[e]=parseValue(t[e],r);else o[e]=parseValue(t,r)}return!1===r.sort?o:(!0===r.sort?Object.keys(o).sort():Object.keys(o).sort(r.sort)).reduce((e,r)=>{const t=o[r];return Boolean(t)&&"object"==typeof t&&!Array.isArray(t)?e[r]=keysSorter(t):e[r]=t,e},Object.create(null))}exports.extract=extract,exports.parse=parse,exports.stringify=((e,r)=>{if(!e)return"";validateArrayFormatSeparator((r=Object.assign({encode:!0,strict:!0,arrayFormat:"none",arrayFormatSeparator:","},r)).arrayFormatSeparator);const t=encoderForArrayFormat(r),o=Object.assign({},e);if(r.skipNull)for(const e of Object.keys(o))void 0!==o[e]&&null!==o[e]||delete o[e];const a=Object.keys(o);return!1!==r.sort&&a.sort(r.sort),a.map(o=>{const a=e[o];return void 0===a?"":null===a?encode(o,r):Array.isArray(a)?a.reduce(t(o),[]).join("&"):encode(o,r)+"="+encode(a,r)}).filter(e=>e.length>0).join("&")}),exports.parseUrl=((e,r)=>({url:removeHash(e).split("?")[0]||"",query:parse(extract(e),r)})),exports.stringifyUrl=((e,r)=>{const t=removeHash(e.url).split("?")[0]||"",o=exports.extract(e.url),a=exports.parse(o),n=getHash(e.url),s=Object.assign(a,e.query);let c=exports.stringify(s,r);return c&&(c=`?${c}`),`${t}${c}${n}`});