var BaseLoaderState,FileState,Game=function(){function t(t,e){void 0===t&&(t=800),void 0===e&&(e=600),this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,document.body.appendChild(this.canvas),this.context=this.canvas.getContext("2d"),this.context.fillStyle="#2d2d2d",this.context.fillRect(0,0,t,e)}return t.prototype.drawImage=function(t,e,o){void 0===e&&(e=0),void 0===o&&(o=0),this.context.drawImage(t,e,o)},t.prototype.draw=function(t){this.context.fillStyle="#ff0000",this.context.fillText(t,10,40),this.context.fillStyle="#0000ff",this.context.fillText(t,10,20),this.context.fillStyle="#ffff00",this.context.fillText(t,10,60)},t}(),extendStatics=function(t,e){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])})(t,e)};function __extends(t,e){function o(){this.constructor=t}extendStatics(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}function __values(t){var e="function"==typeof Symbol&&t[Symbol.iterator],o=0;return e?e.call(t):{next:function(){return t&&o>=t.length&&(t=void 0),{value:t&&t[o++],done:!t}}}}function __read(t,e){var o="function"==typeof Symbol&&t[Symbol.iterator];if(!o)return t;var n,i,r=o.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(n=r.next()).done;)s.push(n.value)}catch(t){i={error:t}}finally{try{n&&!n.done&&(o=r.return)&&o.call(r)}finally{if(i)throw i.error}}return s}!function(t){t[t.IDLE=0]="IDLE",t[t.LOADING=1]="LOADING",t[t.PROCESSING=2]="PROCESSING",t[t.COMPLETE=3]="COMPLETE",t[t.SHUTDOWN=4]="SHUTDOWN",t[t.DESTROYED=5]="DESTROYED"}(BaseLoaderState||(BaseLoaderState={})),function(t){t[t.PENDING=0]="PENDING",t[t.LOADING=1]="LOADING",t[t.LOADED=2]="LOADED",t[t.FAILED=3]="FAILED",t[t.PROCESSING=4]="PROCESSING",t[t.ERRORED=5]="ERRORED",t[t.COMPLETE=6]="COMPLETE",t[t.DESTROYED=7]="DESTROYED",t[t.POPULATED=8]="POPULATED",t[t.TIMED_OUT=9]="TIMED_OUT",t[t.ABORTED=10]="ABORTED"}(FileState||(FileState={}));var BaseLoader=function(){function t(){this.fileGroup="",this.prefix="",this.baseURL="",this.path="",this.maxParallelDownloads=32,this.crossOrigin="",this.state=BaseLoaderState.IDLE,this.progress=0,this.totalToLoad=0,this.totalFailed=0,this.totalComplete=0,this.list=new Set,this.inflight=new Set,this.queue=new Set,this._deleteQueue=new Set,this.state=BaseLoaderState.IDLE}return t.prototype.setBaseURL=function(t){return void 0===t&&(t=""),""!==t&&"/"!==t.substr(-1)&&(t=t.concat("/")),this.baseURL=t,this},t.prototype.setPath=function(t){return void 0===t&&(t=""),""!==t&&"/"!==t.substr(-1)&&(t=t.concat("/")),this.path=t,this},t.prototype.setFileGroup=function(t){return void 0===t&&(t=""),this.fileGroup=t,this},t.prototype.isLoading=function(){return this.state===BaseLoaderState.LOADING||this.state===BaseLoaderState.PROCESSING},t.prototype.isReady=function(){return this.state===BaseLoaderState.IDLE||this.state===BaseLoaderState.COMPLETE},t.prototype.addFile=function(t){return console.log("addFile"),this.getURL(t),this.list.add(t),this.totalToLoad++,console.log(t),new Promise(function(e,o){t.fileResolve=e,t.fileReject=o})},t.prototype.start=function(){this.isReady()&&(this.progress=0,this.totalFailed=0,this.totalComplete=0,this.totalToLoad=this.list.size,0===this.totalToLoad?this.loadComplete():(this.state=BaseLoaderState.LOADING,this.inflight.clear(),this.queue.clear(),this._deleteQueue.clear(),this.updateProgress(),this.checkLoadQueue()))},t.prototype.getURL=function(t){if(t.url.match(/^(?:blob:|data:|http:\/\/|https:\/\/|\/\/)/))return t;t.url=this.baseURL+this.path+t.url},t.prototype.updateProgress=function(){this.progress=1-(this.list.size+this.inflight.size)/this.totalToLoad},t.prototype.checkLoadQueue=function(){var t,e,o=this;try{for(var n=__values(this.list),i=n.next();!i.done;i=n.next()){var r=i.value;if((r.state===FileState.POPULATED||r.state===FileState.PENDING&&this.inflight.size<this.maxParallelDownloads)&&(this.inflight.add(r),this.list.delete(r),r.load().then(function(t){return o.nextFile(t,!0)}).catch(function(t){return o.nextFile(t,!1)})),this.inflight.size===this.maxParallelDownloads)break}}catch(e){t={error:e}}finally{try{i&&!i.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}},t.prototype.nextFile=function(t,e){console.log("nextFile",t,e),e?this.queue.add(t):this._deleteQueue.add(t),this.inflight.delete(t),this.list.size>0?(console.log("nextFile - still something in the list"),this.checkLoadQueue()):0===this.inflight.size&&(console.log("nextFile calling finishedLoading"),this.loadComplete())},t.prototype.loadComplete=function(){this.list.clear(),this.inflight.clear(),this.progress=1,this.state=BaseLoaderState.COMPLETE},t}();function XHRLoader(t){var e,o,n=new XMLHttpRequest;t.xhrLoader=n;var i=t.xhrSettings;n.open("GET",t.url,i.async,i.username,i.password),n.responseType=i.responseType,n.timeout=i.timeout,n.setRequestHeader("X-Requested-With",i.requestedWith),i.header&&i.headerValue&&n.setRequestHeader(i.header,i.headerValue),i.overrideMimeType&&n.overrideMimeType(i.overrideMimeType);var r=new Map([["loadstart",function(e){return t.onLoadStart(e)}],["load",function(e){return t.onLoad(e)}],["loadend",function(e){return t.onLoadEnd(e)}],["progress",function(e){return t.onProgress(e)}],["timeout",function(e){return t.onTimeout(e)}],["abort",function(e){return t.onAbort(e)}],["error",function(e){return t.onError(e)}]]);try{for(var s=__values(r),a=s.next();!a.done;a=s.next()){var l=__read(a.value,2),u=l[0],d=l[1];n.addEventListener(u,d)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(o=s.return)&&o.call(s)}finally{if(e)throw e.error}}t.resetXHR=function(){var t,e;try{for(var o=__values(r),i=o.next();!i.done;i=o.next()){var s=__read(i.value,2),a=s[0],l=s[1];n.removeEventListener(a,l)}}catch(e){t={error:e}}finally{try{i&&!i.done&&(e=o.return)&&e.call(o)}finally{if(t)throw t.error}}},n.send()}function XHRSettings(t){return void 0===t&&(t={responseType:"blob",async:!0,username:"",password:"",timeout:0}),{responseType:t.responseType,async:t.async,username:t.username,password:t.password,timeout:t.timeout,header:void 0,headerValue:void 0,requestedWith:"XMLHttpRequest",overrideMimeType:void 0}}function File(t,e,o){return{key:t,url:e,type:o,xhrLoader:void 0,xhrSettings:XHRSettings(),data:null,state:FileState.PENDING,bytesLoaded:0,bytesTotal:0,percentComplete:0,load:function(){var t=this;return console.log("File.load",this.key),this.state=FileState.PENDING,XHRLoader(this),new Promise(function(e,o){t.loaderResolve=e,t.loaderReject=o})},onLoadStart:function(t){console.log("onLoadStart"),this.state=FileState.LOADING},onLoad:function(t){var e=this;console.log("onLoad");var o=this.xhrLoader,n=o.responseURL&&0===o.responseURL.indexOf("file://")&&0===o.status;t.target&&o.status;4===o.readyState&&o.status>=400&&o.status,this.onProcess().then(function(){return e.onComplete()}).catch(function(){return e.onError()})},onLoadEnd:function(t){console.log("onLoadEnd"),this.resetXHR(),this.state=FileState.LOADED},onTimeout:function(t){console.log("onTimeout"),this.state=FileState.TIMED_OUT},onAbort:function(t){console.log("onAbort"),this.state=FileState.ABORTED},onError:function(t){console.log("onError"),this.state=FileState.ERRORED,this.fileReject&&this.fileReject(this)},onProgress:function(t){console.log("onProgress"),t.lengthComputable&&(this.bytesLoaded=t.loaded,this.bytesTotal=t.total,this.percentComplete=Math.min(t.loaded/t.total,1),console.log(this.percentComplete,"%"))},onProcess:function(){return console.log("File.onProcess"),this.state=FileState.PROCESSING,new Promise(function(t,e){t()})},onComplete:function(){console.log("onComplete!"),this.state=FileState.COMPLETE,this.fileResolve?this.fileResolve(this):this.loaderResolve&&this.loaderResolve(this)},onDestroy:function(){this.state=FileState.DESTROYED}}}function ImageFile(t,e){e||(e=t+".png");var o=File(t,e,"image");return o.xhrSettings.responseType="blob",o.onProcess=function(){console.log("ImageFile.onProcess"),o.state=FileState.PROCESSING;var t=new Image;return o.data=t,new Promise(function(e,n){t.onload=function(){console.log("ImageFile.onload"),t.onload=null,t.onerror=null,o.state=FileState.COMPLETE,e(o)},t.onerror=function(e){console.log("ImageFile.onerror"),t.onload=null,t.onerror=null,o.state=FileState.FAILED,n(o)},console.log("ImageFile.set src",o.url),t.src=o.url,t.complete&&t.width&&t.height&&(console.log("ImageFile.instant"),t.onload=null,t.onerror=null,o.state=FileState.COMPLETE,e(o))})},o}var LoaderPlugin=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.image=function(t,e){return void 0===e&&(e=""),this.addFile(ImageFile(t,e))},e}(BaseLoader),Loader={BaseLoader:BaseLoader,BaseLoaderState:BaseLoaderState,File:File,FileState:FileState,LoaderPlugin:LoaderPlugin,XHRLoader:XHRLoader,XHRSettings:XHRSettings,FileTypes:{ImageFile:ImageFile}};export{Game,Loader};