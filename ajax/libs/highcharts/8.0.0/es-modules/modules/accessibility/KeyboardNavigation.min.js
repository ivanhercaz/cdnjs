"use strict";import H from"../../parts/Globals.js";var merge=H.merge,win=H.win,doc=win.document;import HTMLUtilities from"./utils/htmlUtilities.js";var getElement=HTMLUtilities.getElement;import KeyboardNavigationHandler from"./KeyboardNavigationHandler.js";import EventProvider from"./utils/EventProvider.js";function KeyboardNavigation(t,e){this.init(t,e)}KeyboardNavigation.prototype={init:function(t,e){var i=this,n=this.eventProvider=new EventProvider;this.chart=t,this.components=e,this.modules=[],this.currentModuleIx=0,n.addEvent(t.renderTo,"keydown",function(t){i.onKeydown(t)}),n.addEvent(doc,"mouseup",function(){i.onMouseUp()}),this.update(),this.modules.length&&this.modules[0].init(1)},update:function(t){var e=this.chart.options.accessibility,i=e&&e.keyboardNavigation,n=this.components;this.updateContainerTabindex(),i&&i.enabled&&t&&t.length?(this.modules=t.reduce(function(t,e){var i=n[e].getKeyboardNavigation();return t.concat(i)},[new KeyboardNavigationHandler(this.chart,{init:function(){}})]),this.updateExitAnchor()):(this.modules=[],this.currentModuleIx=0,this.removeExitAnchor())},onMouseUp:function(){if(!(this.keyboardReset||this.chart.pointer&&this.chart.pointer.chartPosition)){var t=this.chart,e=this.modules&&this.modules[this.currentModuleIx||0];e&&e.terminate&&e.terminate(),t.focusElement&&t.focusElement.removeFocusBorder(),this.currentModuleIx=0,this.keyboardReset=!0}},onKeydown:function(t){var e,i=t||win.event,n=this.modules&&this.modules.length&&this.modules[this.currentModuleIx];if(this.keyboardReset=!1,n){var r=n.run(i);r===n.response.success?e=!0:r===n.response.prev?e=this.prev():r===n.response.next&&(e=this.next()),e&&(i.preventDefault(),i.stopPropagation())}},prev:function(){return this.move(-1)},next:function(){return this.move(1)},move:function(t){var e=this.modules&&this.modules[this.currentModuleIx];e&&e.terminate&&e.terminate(t),this.chart.focusElement&&this.chart.focusElement.removeFocusBorder(),this.currentModuleIx+=t;var i=this.modules&&this.modules[this.currentModuleIx];if(i){if(i.validate&&!i.validate())return this.move(t);if(i.init)return i.init(t),!0}return this.currentModuleIx=0,t>0?(this.exiting=!0,this.exitAnchor.focus()):this.chart.renderTo.focus(),!1},updateExitAnchor:function(){var t="highcharts-end-of-chart-marker-"+this.chart.index,e=getElement(t);this.removeExitAnchor(),e?(this.makeElementAnExitAnchor(e),this.exitAnchor=e):this.createExitAnchor()},updateContainerTabindex:function(){var t=this.chart.options.accessibility,e=t&&t.keyboardNavigation,i=!(e&&!1===e.enabled),n=this.chart.container,r=n.getAttribute("tabIndex");i&&!r?n.setAttribute("tabindex","0"):i||"0"!==r||n.removeAttribute("tabindex")},makeElementAnExitAnchor:function(t){t.setAttribute("class","highcharts-exit-anchor"),t.setAttribute("tabindex","0"),t.setAttribute("aria-hidden",!1),this.addExitAnchorEventsToEl(t)},createExitAnchor:function(){var t=this.chart,e=this.exitAnchor=doc.createElement("div");merge(!0,e.style,{position:"absolute",width:"1px",height:"1px",zIndex:0,overflow:"hidden",outline:"none"}),t.renderTo.appendChild(e),this.makeElementAnExitAnchor(e)},removeExitAnchor:function(){this.exitAnchor&&this.exitAnchor.parentNode&&(this.exitAnchor.parentNode.removeChild(this.exitAnchor),delete this.exitAnchor)},addExitAnchorEventsToEl:function(t){var e=this.chart,i=this;this.eventProvider.addEvent(t,"focus",function(t){var n,r=t||win.event;!(r.relatedTarget&&e.container.contains(r.relatedTarget)||i.exiting)?(e.renderTo.focus(),r.preventDefault(),i.modules&&i.modules.length&&(i.currentModuleIx=i.modules.length-1,(n=i.modules[i.currentModuleIx])&&n.validate&&!n.validate()?i.prev():n&&n.init(-1))):i.exiting=!1})},destroy:function(){this.removeExitAnchor(),this.eventProvider.removeAddedEvents(),"0"===this.chart.container.getAttribute("tabindex")&&this.chart.container.removeAttribute("tabindex")}};export default KeyboardNavigation;