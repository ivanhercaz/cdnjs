"use strict";import H from"../../../../parts/Globals.js";import U from"../../../../parts/Utilities.js";var extend=U.extend,defined=U.defined;import HTMLUtilities from"../../utils/htmlUtilities.js";var visuallyHideElement=HTMLUtilities.visuallyHideElement;import ChartUtilities from"../../utils/chartUtilities.js";var getChartTitle=ChartUtilities.getChartTitle;import SeriesDescriber from"./SeriesDescriber.js";var defaultPointDescriptionFormatter=SeriesDescriber.defaultPointDescriptionFormatter,defaultSeriesDescriptionFormatter=SeriesDescriber.defaultSeriesDescriptionFormatter;import EventProvider from"../../utils/EventProvider.js";import DOMElementProvider from"../../utils/DOMElementProvider.js";function chartHasAnnounceEnabled(e){return!!e.options.accessibility.announceNewData.enabled}function findPointInDataArray(e){var n=e.series.data.filter(function(n){return e.x===n.x&&e.y===n.y});return 1===n.length?n[0]:e}function getUniqueSeries(e,n){var t=(e||[]).concat(n||[]).reduce(function(e,n){return e[n.name+n.index]=n,e},{});return Object.keys(t).map(function(e){return t[e]})}var NewDataAnnouncer=function(e){this.chart=e};extend(NewDataAnnouncer.prototype,{init:function(){this.lastAnnouncementTime=0,this.dirty={allSeries:{}},this.eventProvider=new EventProvider,this.domElementProvider=new DOMElementProvider,this.announceRegion=this.addAnnounceRegion(),this.addEventListeners()},destroy:function(){this.eventProvider.removeAddedEvents(),this.domElementProvider.destroyCreatedElements()},addAnnounceRegion:function(){var e=this.chart,n=this.domElementProvider.createElement("div"),t=e.options.accessibility.announceNewData;return n.setAttribute("aria-hidden",!1),n.setAttribute("aria-live",t.interruptUser?"assertive":"polite"),visuallyHideElement(n),e.renderTo.insertBefore(n,e.renderTo.firstChild),n},addEventListeners:function(){var e=this,n=this.chart,t=this.eventProvider;t.addEvent(n,"afterDrilldown",function(){e.lastAnnouncementTime=0}),t.addEvent(H.Series,"updatedData",function(){e.onSeriesUpdatedData(this)}),t.addEvent(n,"afterAddSeries",function(n){e.onSeriesAdded(n.series)}),t.addEvent(H.Series,"addPoint",function(n){e.onPointAdded(n.point)}),t.addEvent(n,"redraw",function(){e.announceDirtyData()})},onSeriesUpdatedData:function(e){var n=this.chart;e.chart===n&&chartHasAnnounceEnabled(n)&&(this.dirty.hasDirty=!0,this.dirty.allSeries[e.name+e.index]=e)},onSeriesAdded:function(e){chartHasAnnounceEnabled(this.chart)&&(this.dirty.hasDirty=!0,this.dirty.allSeries[e.name+e.index]=e,this.dirty.newSeries=defined(this.dirty.newSeries)?void 0:e)},onPointAdded:function(e){var n=e.series.chart;this.chart===n&&chartHasAnnounceEnabled(n)&&(this.dirty.newPoint=defined(this.dirty.newPoint)?void 0:e)},announceDirtyData:function(){var e=this.chart,n=this;if(e.options.accessibility.announceNewData&&this.dirty.hasDirty){var t=this.dirty.newPoint;t&&(t=findPointInDataArray(t)),this.queueAnnouncement(Object.keys(this.dirty.allSeries).map(function(e){return n.dirty.allSeries[e]}),this.dirty.newSeries,t),this.dirty={allSeries:{}}}},queueAnnouncement:function(e,n,t){var i=this.chart.options.accessibility.announceNewData;if(i.enabled){var r=this,a=+new Date,s=a-this.lastAnnouncementTime,o=Math.max(0,i.minAnnounceInterval-s),u=getUniqueSeries(this.queuedAnnouncement&&this.queuedAnnouncement.series,e),d=this.buildAnnouncementMessage(u,n,t);d&&(this.queuedAnnouncement&&clearTimeout(this.queuedAnnouncementTimer),this.queuedAnnouncement={time:a,message:d,series:u},r.queuedAnnouncementTimer=setTimeout(function(){r&&r.announceRegion&&(r.lastAnnouncementTime=+new Date,r.liveRegionSpeak(r.queuedAnnouncement.message),delete r.queuedAnnouncement,delete r.queuedAnnouncementTimer)},o))}},liveRegionSpeak:function(e){var n=this;this.announceRegion.innerHTML=e,this.clearAnnouncementContainerTimer&&clearTimeout(this.clearAnnouncementContainerTimer),this.clearAnnouncementContainerTimer=setTimeout(function(){n.announceRegion.innerHTML="",delete n.clearAnnouncementContainerTimer},1e3)},buildAnnouncementMessage:function(e,n,t){var i=this.chart,r=i.options.accessibility.announceNewData;if(r.announcementFormatter){var a=r.announcementFormatter(e,n,t);if(!1!==a)return a.length?a:null}var s=H.charts&&H.charts.length>1?"Multiple":"Single",o=n?"newSeriesAnnounce"+s:t?"newPointAnnounce"+s:"newDataAnnounce",u=getChartTitle(i);return i.langFormat("accessibility.announceNewData."+o,{chartTitle:u,seriesDesc:n?defaultSeriesDescriptionFormatter(n):null,pointDesc:t?defaultPointDescriptionFormatter(t):null,point:t,series:n})}});export default NewDataAnnouncer;