"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var defined=U.defined,pick=U.pick,splat=U.splat,wrap=U.wrap;import"../parts/Pointer.js";import"../parts/Series.js";import"../parts/Pointer.js";var colProto,Pointer=H.Pointer,Series=H.Series,seriesTypes=H.seriesTypes,seriesProto=Series.prototype,pointerProto=Pointer.prototype;seriesProto.searchPointByAngle=function(t){var e=this.chart,i=this.xAxis.pane.center,s=t.chartX-i[0]-e.plotLeft,r=t.chartY-i[1]-e.plotTop;return this.searchKDTree({clientX:180+Math.atan2(s,r)*(-180/Math.PI)})},seriesProto.getConnectors=function(t,e,i,s){var r,a,o,n,l,p,h,c,d,f,g,P,u,y,A,v,x,m,X,Y,C,T=s?1:0;return a=(r=e>=0&&e<=t.length-1?e:e<0?t.length-1+e:0)-1<0?t.length-(1+T):r-1,o=r+1>t.length-1?T:r+1,n=t[a],l=t[o],p=n.plotX,h=n.plotY,c=l.plotX,d=l.plotY,u=(1.5*(f=t[r].plotX)+p)/2.5,y=(1.5*(g=t[r].plotY)+h)/2.5,A=(1.5*f+c)/2.5,v=(1.5*g+d)/2.5,x=Math.sqrt(Math.pow(u-f,2)+Math.pow(y-g,2)),m=Math.sqrt(Math.pow(A-f,2)+Math.pow(v-g,2)),X=Math.atan2(y-g,u-f),Y=Math.atan2(v-g,A-f),C=Math.PI/2+(X+Y)/2,Math.abs(X-C)>Math.PI/2&&(C-=Math.PI),u=f+Math.cos(C)*x,y=g+Math.sin(C)*x,P={rightContX:A=f+Math.cos(Math.PI+C)*m,rightContY:v=g+Math.sin(Math.PI+C)*m,leftContX:u,leftContY:y,plotX:f,plotY:g},i&&(P.prevPointCont=this.getConnectors(t,a,!1,s)),P},seriesProto.toXY=function(t){var e,i,s=this.chart,r=this.xAxis,a=this.yAxis,o=t.plotX,n=t.plotY,l=t.series,p=s.inverted,h=t.y;p&&l&&!l.isRadialBar&&(t.plotY=n="number"==typeof h&&a.translate(h)||0),t.rectPlotX=o,t.rectPlotY=n,e=p?r.postTranslate(n,o):r.postTranslate(o,a.len-n),t.plotX=t.polarPlotX=e.x-s.plotLeft,t.plotY=t.polarPlotY=e.y-s.plotTop,this.kdByAngle?((i=(o/Math.PI*180+r.pane.options.startAngle)%360)<0&&(i+=360),t.clientX=i):t.clientX=t.plotX},seriesTypes.spline&&(wrap(seriesTypes.spline.prototype,"getPointSpline",function(t,e,i,s){var r;return this.chart.polar?s?["C",(r=this.getConnectors(e,s,!0,this.connectEnds)).prevPointCont.rightContX,r.prevPointCont.rightContY,r.leftContX,r.leftContY,r.plotX,r.plotY]:["M",i.plotX,i.plotY]:t.call(this,e,i,s)}),seriesTypes.areasplinerange&&(seriesTypes.areasplinerange.prototype.getPointSpline=seriesTypes.spline.prototype.getPointSpline)),H.addEvent(Series,"afterTranslate",function(){var t=this.chart;if(t.polar&&this.xAxis){if(this.kdByAngle=t.tooltip&&t.tooltip.shared,this.kdByAngle?this.searchPoint=this.searchPointByAngle:this.options.findNearestPointBy="xy",!this.preventPostTranslate)for(var e=this.points,i=e.length;i--;)this.toXY(e[i]),!t.hasParallelCoordinates&&!this.yAxis.reversed&&e[i].y<this.yAxis.min&&(e[i].isNull=!0);this.hasClipCircleSetter||(this.hasClipCircleSetter=!!this.eventsToUnbind.push(H.addEvent(this,"afterRender",function(){var e;t.polar&&(e=this.yAxis.center,this.clipCircle?this.clipCircle.animate({x:e[0],y:e[1],r:e[2]/2}):this.clipCircle=t.renderer.clipCircle(e[0],e[1],e[2]/2),this.group.clip(this.clipCircle),this.setClip=H.noop)})))}},{order:2}),wrap(seriesProto,"getGraphPath",function(t,e){var i,s,r,a=this;if(this.chart.polar){for(e=e||this.points,i=0;i<e.length;i++)if(!e[i].isNull){s=i;break}!1!==this.options.connectEnds&&void 0!==s&&(this.connectEnds=!0,e.splice(e.length,0,e[s]),r=!0),e.forEach(function(t){void 0===t.polarPlotY&&a.toXY(t)})}var o=t.apply(this,[].slice.call(arguments,1));return r&&e.pop(),o});var polarAnimate=function(t,e){var i,s=this.chart,r=this.options.animation,a=this.group,o=this.markerGroup,n=this.xAxis.center,l=s.plotLeft,p=s.plotTop;s.polar?this.isRadialBar?e||(this.startAngleRad=pick(this.translatedThreshold,this.xAxis.startAngleRad),H.seriesTypes.pie.prototype.animate.call(this,e)):s.renderer.isSVG&&(r=H.animObject(r),e?(i={translateX:n[0]+l,translateY:n[1]+p,scaleX:.001,scaleY:.001},a.attr(i),o&&o.attr(i)):(i={translateX:l,translateY:p,scaleX:1,scaleY:1},a.animate(i,r),o&&o.animate(i,r),this.animate=null)):t.call(this,e)};wrap(seriesProto,"animate",polarAnimate),seriesTypes.column&&((colProto=seriesTypes.column.prototype).polarArc=function(t,e,i,s){var r=this.xAxis.center,a=this.yAxis.len;return this.chart.renderer.symbols.arc(r[0],r[1],a-e,null,{start:i,end:s,innerR:a-pick(t,a)})},wrap(colProto,"animate",polarAnimate),wrap(colProto,"translate",function(t){var e,i,s,r,a,o,n,l,p,h,c,d,f,g,P,u,y=this.options,A=y.threshold,v=y.stacking,x=this.chart,m=this.xAxis,X=this.yAxis,Y=X.reversed,C=m.center,T=m.startAngleRad,M=m.endAngleRad-T;if(this.preventPostTranslate=!0,t.call(this),m.isRadial)for(r=(i=this.points).length,a=X.translate(X.min),o=X.translate(X.max),A=y.threshold||0,x.inverted&&H.isNumber(A)&&(e=X.translate(A),defined(e)&&(e<0?e=0:e>M&&(e=M),this.translatedThreshold=e+T));r--;)g=(s=i[r]).barX,h=s.x,c=s.y,x.inverted?(s.shapeType="arc",s.plotY=X.translate(c),v?(f=X.stacks[(c<0?"-":"")+this.stackKey],this.visible&&f&&f[h]&&(s.isNull||(d=f[h].points[this.getStackIndicator(void 0,h,this.index).key],n=X.translate(d[0]),l=X.translate(d[1]),defined(n)&&(n=U.clamp(n,0,M))))):(n=e,l=s.plotY),n>l&&(l=[n,n=l][0]),Y?l>a?l=a:n<o?n=o:(n>a||l<o)&&(n=l=M):n<a?n=a:l>o?l=o:(l<a||n>o)&&(n=l=0),X.min>X.max&&(n=l=Y?M:0),n+=T,l+=T,P=Math.max(g,0),u=Math.max(g+s.pointWidth,0),s.shapeArgs={x:C[0],y:C[1],r:u,innerR:P,start:n,end:l},s.opacity=n===l?0:void 0,s.plotY=(defined(this.translatedThreshold)&&(n<this.translatedThreshold?n:l))-T):(s.shapeType="path",n=g+T,s.shapeArgs={d:this.polarArc(s.yBottom,s.plotY,n,n+s.pointWidth)}),this.toXY(s),x.inverted?(p=m.postTranslate(s.rectPlotY,s.barX+s.pointWidth/2),s.tooltipPos=[p.x-x.plotLeft,p.y-x.plotTop]):s.tooltipPos=[s.plotX,s.plotY],s.ttBelow=s.plotY>C[1]}),colProto.findAlignments=function(t,e){var i,s;return null===e.align&&(i=t>20&&t<160?"left":t>200&&t<340?"right":"center",e.align=i),null===e.verticalAlign&&(s=t<45||t>315?"bottom":t>135&&t<225?"top":"middle",e.verticalAlign=s),e},wrap(colProto,"alignDataLabel",function(t,e,i,s,r,a){var o,n,l,p=this.chart,h=pick(s.inside,!!this.options.stacking);p.polar?(o=e.rectPlotX/Math.PI*180,p.inverted?(this.forceDL=p.isInsidePlot(e.plotX,Math.round(e.plotY),!1),h&&e.shapeArgs?(n=e.shapeArgs,r={x:(l=this.xAxis.postTranslate((n.start+n.end)/2-this.xAxis.startAngleRad,e.barX+e.pointWidth/2)).x-p.plotLeft,y:l.y-p.plotTop}):e.tooltipPos&&(r={x:e.tooltipPos[0],y:e.tooltipPos[1]}),s.align=pick(s.align,"center"),s.verticalAlign=pick(s.verticalAlign,"middle")):s=this.findAlignments(o,s),seriesProto.alignDataLabel.call(this,e,i,s,r,a),this.isRadialBar&&e.shapeArgs&&e.shapeArgs.start===e.shapeArgs.end&&i.hide(!0)):t.call(this,e,i,s,r,a)})),wrap(pointerProto,"getCoordinates",function(t,e){var i=this.chart,s={xAxis:[],yAxis:[]};return i.polar?i.axes.forEach(function(t){var r,a,o=t.isXAxis,n=t.center;"colorAxis"!==t.coll&&(r=e.chartX-n[0]-i.plotLeft,a=e.chartY-n[1]-i.plotTop,s[o?"xAxis":"yAxis"].push({axis:t,value:t.translate(o?Math.PI-Math.atan2(r,a):Math.sqrt(Math.pow(r,2)+Math.pow(a,2)),!0)}))}):s=t.call(this,e),s}),H.SVGRenderer.prototype.clipCircle=function(t,e,i){var s,r=H.uniqueKey(),a=this.createElement("clipPath").attr({id:r}).add(this.defs);return(s=this.circle(t,e,i).add(a)).id=r,s.clipPath=a,s},H.addEvent(H.Chart,"getAxes",function(){this.pane||(this.pane=[]),splat(this.options.pane).forEach(function(t){new H.Pane(t,this)},this)}),H.addEvent(H.Chart,"afterDrawChartBox",function(){this.pane.forEach(function(t){t.render()})}),H.addEvent(H.Series,"afterInit",function(){var t=this.chart;t.inverted&&t.polar&&(this.isRadialSeries=!0,this instanceof seriesTypes.column&&(this.isRadialBar=!0))}),wrap(H.Chart.prototype,"get",function(t,e){return H.find(this.pane,function(t){return t.options.id===e})||t.call(this,e)});