"use strict";import H from"./Globals.js";import U from"./Utilities.js";var clamp=U.clamp,defined=U.defined,discardElement=U.discardElement,extend=U.extend,isNumber=U.isNumber,isString=U.isString,pick=U.pick,splat=U.splat,syncTimeout=U.syncTimeout,doc=H.doc,format=H.format,merge=H.merge,timeUnits=H.timeUnits;H.Tooltip=function(){this.init.apply(this,arguments)},H.Tooltip.prototype={init:function(t,e){this.chart=t,this.options=e,this.crosshairs=[],this.now={x:0,y:0},this.isHidden=!0,this.split=e.split&&!t.inverted&&!t.polar,this.shared=e.shared||this.split,this.outside=pick(e.outside,Boolean(t.scrollablePixelsX||t.scrollablePixelsY))},cleanSplit:function(t){this.chart.series.forEach(function(e){var i=e&&e.tt;i&&(!i.isActive||t?e.tt=i.destroy():i.isActive=!1)})},applyFilter:function(){var t=this.chart;t.renderer.definition({tagName:"filter",id:"drop-shadow-"+t.index,opacity:.5,children:[{tagName:"feGaussianBlur",in:"SourceAlpha",stdDeviation:1},{tagName:"feOffset",dx:1,dy:1},{tagName:"feComponentTransfer",children:[{tagName:"feFuncA",type:"linear",slope:.3}]},{tagName:"feMerge",children:[{tagName:"feMergeNode"},{tagName:"feMergeNode",in:"SourceGraphic"}]}]}),t.renderer.definition({tagName:"style",textContent:".highcharts-tooltip-"+t.index+"{filter:url(#drop-shadow-"+t.index+")}"})},getLabel:function(){var t,e,i=this,o=this.chart.renderer,r=this.chart.styledMode,s=this.options,a="tooltip"+(defined(s.className)?" "+s.className:"");return this.label||(this.outside&&(this.container=t=H.doc.createElement("div"),t.className="highcharts-tooltip-container",H.css(t,{position:"absolute",top:"1px",pointerEvents:s.style&&s.style.pointerEvents,zIndex:3}),H.doc.body.appendChild(t),this.renderer=o=new H.Renderer(t,0,0,{},void 0,void 0,o.styledMode)),this.split?this.label=o.g(a):(this.label=o.label("",0,0,s.shape||"callout",null,null,s.useHTML,null,a).attr({padding:s.padding,r:s.borderRadius}),r||this.label.attr({fill:s.backgroundColor,"stroke-width":s.borderWidth}).css(s.style).shadow(s.shadow)),r&&(this.applyFilter(),this.label.addClass("highcharts-tooltip-"+this.chart.index)),i.outside&&!i.split&&(e={x:this.label.xSetter,y:this.label.ySetter},this.label.xSetter=function(o,r){e[r].call(this.label,i.distance),t.style.left=o+"px"},this.label.ySetter=function(o,r){e[r].call(this.label,i.distance),t.style.top=o+"px"}),this.label.attr({zIndex:8}).add()),this.label},update:function(t){this.destroy(),merge(!0,this.chart.options.tooltip.userOptions,t),this.init(this.chart,merge(!0,this.options,t))},destroy:function(){this.label&&(this.label=this.label.destroy()),this.split&&this.tt&&(this.cleanSplit(this.chart,!0),this.tt=this.tt.destroy()),this.renderer&&(this.renderer=this.renderer.destroy(),discardElement(this.container)),H.clearTimeout(this.hideTimer),H.clearTimeout(this.tooltipTimeout)},move:function(t,e,i,o){var r=this,s=r.now,a=!1!==r.options.animation&&!r.isHidden&&(Math.abs(t-s.x)>1||Math.abs(e-s.y)>1),n=r.followPointer||r.len>1;extend(s,{x:a?(2*s.x+t)/3:t,y:a?(s.y+e)/2:e,anchorX:n?void 0:a?(2*s.anchorX+i)/3:i,anchorY:n?void 0:a?(s.anchorY+o)/2:o}),r.getLabel().attr(s),a&&(H.clearTimeout(this.tooltipTimeout),this.tooltipTimeout=setTimeout(function(){r&&r.move(t,e,i,o)},32))},hide:function(t){var e=this;H.clearTimeout(this.hideTimer),t=pick(t,this.options.hideDelay,500),this.isHidden||(this.hideTimer=syncTimeout(function(){e.getLabel()[t?"fadeOut":"hide"](),e.isHidden=!0},t))},getAnchor:function(t,e){var i,o,r,s=this.chart,a=s.pointer,n=s.inverted,l=s.plotTop,h=s.plotLeft,c=0,d=0;return t=splat(t),this.followPointer&&e?(void 0===e.chartX&&(e=a.normalize(e)),i=[e.chartX-s.plotLeft,e.chartY-l]):t[0].tooltipPos?i=t[0].tooltipPos:(t.forEach(function(t){o=t.series.yAxis,r=t.series.xAxis,c+=t.plotX+(!n&&r?r.left-h:0),d+=(t.plotLow?(t.plotLow+t.plotHigh)/2:t.plotY)+(!n&&o?o.top-l:0)}),c/=t.length,d/=t.length,i=[n?s.plotWidth-d:c,this.shared&&!n&&t.length>1&&e?e.chartY-l:n?s.plotHeight-c:d]),i.map(Math.round)},getPosition:function(t,e,i){var o,r=this.chart,s=this.distance,a={},n=r.inverted&&i.h||0,l=this.outside,h=l?doc.documentElement.clientWidth-2*s:r.chartWidth,c=l?Math.max(doc.body.scrollHeight,doc.documentElement.scrollHeight,doc.body.offsetHeight,doc.documentElement.offsetHeight,doc.documentElement.clientHeight):r.chartHeight,d=r.pointer.getChartPosition(),p=r.containerScaling,f=function(t){return p?t*p.scaleX:t},u=function(t){return p?t*p.scaleY:t},m=function(o){var a="x"===o;return[o,a?h:c,a?t:e].concat(l?[a?f(t):u(e),a?d.left-s+f(i.plotX+r.plotLeft):d.top-s+u(i.plotY+r.plotTop),0,a?h:c]:[a?t:e,a?i.plotX+r.plotLeft:i.plotY+r.plotTop,a?r.plotLeft:r.plotTop,a?r.plotLeft+r.plotWidth:r.plotTop+r.plotHeight])},g=m("y"),x=m("x"),y=!this.followPointer&&pick(i.ttBelow,!r.inverted==!!i.negative),v=function(t){var e=g;g=x,x=e,o=t},b=function(){!1!==function(t,e,i,o,r,l,h){var c="y"===t?u(s):f(s),d=(i-o)/2,p=o<r-s,m=r+s+o<e,g=r-c-i+d,x=r+c-d;if(y&&m)a[t]=x;else if(!y&&p)a[t]=g;else if(p)a[t]=Math.min(h-o,g-n<0?g:g-n);else{if(!m)return!1;a[t]=Math.max(l,x+n+i>e?x:x+n)}}.apply(0,g)?!1!==function(t,e,i,o,r){var n;return r<s||r>e-s?n=!1:a[t]=r<i/2?1:r>e-o/2?e-o-2:r-i/2,n}.apply(0,x)||o||(v(!0),b()):o?a.x=a.y=0:(v(!0),b())};return(r.inverted||this.len>1)&&v(),b(),a},defaultFormatter:function(t){var e,i=this.points||splat(this);return(e=(e=[t.tooltipFooterHeaderFormatter(i[0])]).concat(t.bodyFormatter(i))).push(t.tooltipFooterHeaderFormatter(i[0],!0)),e},refresh:function(t,e){var i,o,r,s,a,n=this.chart,l=this.options,h=t,c={},d=[],p=l.formatter||this.defaultFormatter,f=this.shared,u=n.styledMode;if(l.enabled){if(H.clearTimeout(this.hideTimer),this.followPointer=splat(h)[0].series.tooltipOptions.followPointer,i=(r=this.getAnchor(h,e))[0],o=r[1],!f||h.series&&h.series.noSharedTooltip?c=h.getLabelConfig():(n.pointer.applyInactiveState(h),h.forEach(function(t){t.setState("hover"),d.push(t.getLabelConfig())}),(c={x:h[0].category,y:h[0].y}).points=d,h=h[0]),this.len=d.length,s=p.call(c,this),a=h.series,this.distance=pick(a.tooltipOptions.distance,16),!1===s)this.hide();else{if(this.split)this.renderSplit(s,splat(t));else{var m=this.getLabel();l.style.width&&!u||m.css({width:this.chart.spacingBox.width}),m.attr({text:s&&s.join?s.join(""):s}),m.removeClass(/highcharts-color-[\d]+/g).addClass("highcharts-color-"+pick(h.colorIndex,a.colorIndex)),u||m.attr({stroke:l.borderColor||h.color||a.color||"#666666"}),this.updatePosition({plotX:i,plotY:o,negative:h.negative,ttBelow:h.ttBelow,h:r[2]||0})}this.isHidden&&this.label&&this.label.attr({opacity:1}).show(),this.isHidden=!1}H.fireEvent(this,"refresh")}},renderSplit:function(t,e){var i=this,o=i.chart,r=i.chart,s=r.chartWidth,a=r.chartHeight,n=r.plotHeight,l=r.plotLeft,h=r.plotTop,c=r.plotWidth,d=r.pointer,p=r.renderer,f=r.scrollablePixelsX,u=void 0===f?0:f,m=r.scrollablePixelsY,g=void 0===m?0:m,x=r.scrollingContainer,y=void 0===x?{scrollLeft:0,scrollTop:0}:x,v=y.scrollLeft,b=y.scrollTop,w=r.styledMode,T=i.distance,F=i.options,k=i.options.positioner,L={left:u?l:0,right:u?l+c-u:s,top:g?h:0,bottom:g?h+n-g:a},X=i.getLabel(),S=Boolean(o.xAxis[0]&&o.xAxis[0].opposite),Y=h,M=0,P=n-g;function C(t,e,i,o,r){var s,a;return void 0===r&&(r=!0),i?(s=S?0:P,a=clamp(t-o/2,L.left,L.right-o)):(s=e-Y,a=clamp(a=r?t-o-T:t+T,r?a:L.left,L.right)),{x:a,y:s}}isString(t)&&(t=[!1,t]);var E=t.slice(0,e.length+1).reduce(function(t,o,r){if(!1!==o&&""!==o){var s=e[r-1]||{isHeader:!0,plotX:e[0].plotX,plotY:n,series:{}},a=s.isHeader,c=a?i:s.series,d=c.tt=function(t,e,i){var o=t,r=e.isHeader,s=e.series,a="highcharts-color-"+pick(e.colorIndex,s.colorIndex,"none");if(!o){var n={padding:F.padding,r:F.borderRadius};w||(n.fill=F.backgroundColor,n["stroke-width"]=F.borderWidth),o=p.label(null,null,null,F[r?"headerShape":"shape"]||"callout",null,null,F.useHTML).addClass(r?"highcharts-tooltip-header ":"highcharts-tooltip-box "+a).attr(n).add(X)}return o.isActive=!0,o.attr({text:i}),w||o.css(F.style).shadow(F.shadow).attr({stroke:F.borderColor||e.color||s.color||"#333333"}),o}(c.tt,s,o),f=d.getBBox(),u=f.width+d.strokeWidth();a&&(M=f.height,P+=M,S&&(Y-=M));var m=function(t){var e,i,o=t.isHeader,r=t.plotX,s=void 0===r?0:r,a=t.plotY,c=void 0===a?0:a,d=t.series;if(o)e=l+s-v,i=h+(n-g)/2;else{var p=d.xAxis,f=d.yAxis;e=p.pos+clamp(s,-T,p.len+T)-v,i=f.pos+clamp(c,0,f.len)-b}return{anchorX:e=clamp(e,L.left-T,L.right+T),anchorY:i=clamp(i,L.top,L.bottom)}}(s),x=m.anchorX,y=m.anchorY,H=f.height+1,E=k?k.call(i,u,H,s):C(x,y,a,u);t.push({align:k?0:void 0,anchorX:x,anchorY:y,boxWidth:u,point:s,rank:pick(E.rank,a?1:0),size:H,target:E.y,tt:d,x:E.x})}return t},[]);!k&&E.some(function(t){return t.x<0})&&(E=E.map(function(t){var e=C(t.anchorX,t.anchorY,t.point.isHeader,t.boxWidth,!1),i=e.x,o=e.y;return extend(t,{target:o,x:i})})),i.cleanSplit(),H.distribute(E,P,void 0),E.forEach(function(t){var e=t.anchorX,i=t.anchorY,o=t.pos,r=t.x;t.tt.attr({visibility:void 0===o?"hidden":"inherit",x:r,y:o+Y,anchorX:e,anchorY:i})});var N=i.container,U=i.outside,A=i.renderer;if(U&&N&&A){var W=X.getBBox(),B=W.width,D=W.height,I=W.x,O=W.y;A.setSize(B+I,D+O,!1);var z=d.getChartPosition();N.style.left=z.left+"px",N.style.top=z.top+"px"}},updatePosition:function(t){var e,i,o=this.chart,r=o.pointer,s=this.getLabel(),a=t.plotX+o.plotLeft,n=t.plotY+o.plotTop,l=r.getChartPosition();if(e=(this.options.positioner||this.getPosition).call(this,s.width,s.height,t),this.outside){i=(this.options.borderWidth||0)+2*this.distance,this.renderer.setSize(s.width+i,s.height+i,!1);var h=o.containerScaling;h&&(H.css(this.container,{transform:"scale("+h.scaleX+", "+h.scaleY+")"}),a*=h.scaleX,n*=h.scaleY),a+=l.left-e.x,n+=l.top-e.y}this.move(Math.round(e.x),Math.round(e.y||0),a,n)},getDateFormat:function(t,e,i,o){var r,s,a=this.chart.time,n=a.dateFormat("%m-%d %H:%M:%S.%L",e),l="01-01 00:00:00.000",h={millisecond:15,second:12,minute:9,hour:6,day:3},c="millisecond";for(s in timeUnits){if(t===timeUnits.week&&+a.dateFormat("%w",e)===i&&n.substr(6)===l.substr(6)){s="week";break}if(timeUnits[s]>t){s=c;break}if(h[s]&&n.substr(h[s])!==l.substr(h[s]))break;"week"!==s&&(c=s)}return s&&(r=a.resolveDTLFormat(o[s]).main),r},getXDateFormat:function(t,e,i){var o=e.dateTimeLabelFormats,r=i&&i.closestPointRange;return(r?this.getDateFormat(r,t.x,i.options.startOfWeek,o):o.day)||o.year},tooltipFooterHeaderFormatter:function(t,e){var i=e?"footer":"header",o=t.series,r=o.tooltipOptions,s=r.xDateFormat,a=o.xAxis,n=a&&"datetime"===a.options.type&&isNumber(t.key),l=r[i+"Format"],h={isFooter:e,labelConfig:t};return H.fireEvent(this,"headerFormatter",h,function(e){n&&!s&&(s=this.getXDateFormat(t,r,a)),n&&s&&(t.point&&t.point.tooltipDateKeys||["key"]).forEach(function(t){l=l.replace("{point."+t+"}","{point."+t+":"+s+"}")}),o.chart.styledMode&&(l=this.styledModeFormat(l)),e.text=format(l,{point:t,series:o},this.chart)}),h.text},bodyFormatter:function(t){return t.map(function(t){var e=t.series.tooltipOptions;return(e[(t.point.formatPrefix||"point")+"Formatter"]||t.point.tooltipFormatter).call(t.point,e[(t.point.formatPrefix||"point")+"Format"]||"")})},styledModeFormat:function(t){return t.replace('style="font-size: 10px"','class="highcharts-header"').replace(/style="color:{(point|series)\.color}"/g,'class="highcharts-color-{$1.colorIndex}"')}};