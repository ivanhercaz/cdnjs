"use strict";import H from"../../../parts/Globals.js";import Legend from"../../../parts/Legend.js";import U from"../../../parts/Utilities.js";var addEvent=U.addEvent,extend=U.extend,fireEvent=U.fireEvent;import AccessibilityComponent from"../AccessibilityComponent.js";import KeyboardNavigationHandler from"../KeyboardNavigationHandler.js";import HTMLUtilities from"../utils/htmlUtilities.js";var stripHTMLTags=HTMLUtilities.stripHTMLTagsFromString,removeElement=HTMLUtilities.removeElement;function scrollLegendToItem(e,t){var n=e.allItems[t].pageIx,i=e.currentPage;void 0!==n&&n+1!==i&&e.scroll(1+n-i)}function shouldDoLegendA11y(e){var t=e.legend&&e.legend.allItems,n=e.options.legend.accessibility||{};return!(!t||!t.length||e.colorAxis&&e.colorAxis.length||!1===n.enabled)}H.Chart.prototype.highlightLegendItem=function(e){var t=this.legend.allItems,n=this.highlightedLegendItemIx;return!!t[e]&&(t[n]&&fireEvent(t[n].legendGroup.element,"mouseout"),scrollLegendToItem(this.legend,e),this.setFocusToElement(t[e].legendItem,t[e].a11yProxyElement),fireEvent(t[e].legendGroup.element,"mouseover"),!0)},addEvent(Legend,"afterColorizeItem",function(e){var t=this.chart.options.accessibility,n=e.item;t.enabled&&n&&n.a11yProxyElement&&n.a11yProxyElement.setAttribute("aria-pressed",e.visible?"false":"true")});var LegendComponent=function(){};LegendComponent.prototype=new AccessibilityComponent,extend(LegendComponent.prototype,{init:function(){var e=this;this.addEvent(Legend,"afterScroll",function(){this.chart===e.chart&&e.updateProxies()})},updateLegendItemProxyVisibility:function(){var e=this.chart.legend,t=e.allItems||[],n=e.currentPage||1,i=e.clipHeight||0;t.forEach(function(t){var o=t.pageIx||0,r=(t._legendItemPos?t._legendItemPos[1]:0)+(t.legendItem?Math.round(t.legendItem.getBBox().height):0)-e.pages[o]>i||o!==n-1;t.a11yProxyElement&&(t.a11yProxyElement.style.visibility=r?"hidden":"visible")})},onChartRender:function(){this.legendProxyButtonClicked?delete this.legendProxyButtonClicked:this.updateProxies()},updateProxies:function(){removeElement(this.legendProxyGroup),shouldDoLegendA11y(this.chart)&&(this.addLegendProxyGroup(),this.proxyLegendItems(),this.updateLegendItemProxyVisibility())},addLegendProxyGroup:function(){var e=this.chart.options.accessibility,t=this.chart.langFormat("accessibility.legend.legendLabel",{}),n="all"===e.landmarkVerbosity?"region":null;this.legendProxyGroup=this.addProxyGroup({"aria-label":t,role:n})},proxyLegendItems:function(){var e=this;(this.chart.legend&&this.chart.legend.allItems||[]).forEach(function(t){t.legendItem&&t.legendItem.element&&e.proxyLegendItem(t)})},proxyLegendItem:function(e){var t=this,n=this.chart.langFormat("accessibility.legend.legendItem",{chart:this.chart,itemName:stripHTMLTags(e.name)}),i={tabindex:-1,"aria-pressed":!e.visible,"aria-label":n},o=e.legendGroup.div?e.legendItem:e.legendGroup;e.a11yProxyElement=this.createProxyButton(e.legendItem,this.legendProxyGroup,i,o,function(){t.legendProxyButtonClicked=!0})},getKeyboardNavigation:function(){var e=this.keyCodes,t=this,n=this.chart;return new KeyboardNavigationHandler(n,{keyCodeMap:[[[e.left,e.right,e.up,e.down],function(e){return t.onKbdArrowKey(this,e)}],[[e.enter,e.space],function(){return t.onKbdClick(this)}]],validate:function(){return t.shouldHaveLegendNavigation()},init:function(e){return t.onKbdNavigationInit(e)}})},onKbdArrowKey:function(e,t){var n=this.keyCodes,i=e.response,o=this.chart,r=o.options.accessibility,l=o.legend.allItems.length,a=t===n.left||t===n.up?-1:1;return o.highlightLegendItem(this.highlightedLegendItemIx+a)?(this.highlightedLegendItemIx+=a,i.success):l>1&&r.keyboardNavigation.wrapAround?(e.init(a),i.success):i[a>0?"next":"prev"]},onKbdClick:function(e){var t=this.chart.legend.allItems[this.highlightedLegendItemIx];return t&&t.a11yProxyElement&&fireEvent(t.a11yProxyElement,"click"),e.response.success},shouldHaveLegendNavigation:function(){var e=this.chart,t=e.options.legend||{},n=e.legend&&e.legend.allItems,i=e.colorAxis&&e.colorAxis.length,o=t.accessibility||{};return!!(n&&e.legend.display&&!i&&o.enabled&&o.keyboardNavigation&&o.keyboardNavigation.enabled)},onKbdNavigationInit:function(e){var t=this.chart,n=t.legend.allItems.length-1,i=e>0?0:n;t.highlightLegendItem(i),this.highlightedLegendItemIx=i}});export default LegendComponent;