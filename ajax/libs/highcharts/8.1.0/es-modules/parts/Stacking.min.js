"use strict";import Axis from"./Axis.js";import H from"./Globals.js";import StackingAxis from"./StackingAxis.js";import U from"./Utilities.js";var correctFloat=U.correctFloat,defined=U.defined,destroyObjectProperties=U.destroyObjectProperties,format=U.format,pick=U.pick;import"./Chart.js";import"./Series.js";var Chart=H.Chart,Series=H.Series,StackItem=function(){function t(t,i,e,s,a){var o=t.chart.inverted;this.axis=t,this.isNegative=e,this.options=i=i||{},this.x=s,this.total=null,this.points={},this.stack=a,this.leftCliff=0,this.rightCliff=0,this.alignOptions={align:i.align||(o?e?"left":"right":"center"),verticalAlign:i.verticalAlign||(o?"middle":e?"bottom":"top"),y:i.y,x:i.x},this.textAlign=i.textAlign||(o?e?"right":"left":"center")}return t.prototype.destroy=function(){destroyObjectProperties(this,this.axis)},t.prototype.render=function(t){var i=this.axis.chart,e=this.options,s=e.format,a={},o=s?format(s,this,i):e.formatter.call(this);this.label?this.label.attr({text:o,visibility:"hidden"}):(this.label=i.renderer.label(o,null,null,e.shape,null,null,e.useHTML,!1,"stack-labels"),a={r:e.borderRadius||0,text:o,rotation:e.rotation,padding:pick(e.padding,5),visibility:"hidden"},i.styledMode||(a.fill=e.backgroundColor,a.stroke=e.borderColor,a["stroke-width"]=e.borderWidth,this.label.css(e.style)),this.label.attr(a),this.label.added||this.label.add(t)),this.label.labelrank=i.plotHeight},t.prototype.setOffset=function(t,i,e,s,a){var o=this.axis,n=o.chart,r=o.translate(o.stacking.usePercentage?100:s||this.total,0,0,0,1),l=o.translate(e||0),c=defined(r)&&Math.abs(r-l),h=pick(a,n.xAxis[0].translate(this.x))+t,p=defined(r)&&this.getStackBox(n,this,h,r,i,c,o),d=this.label,k=this.isNegative,g="justify"===pick(this.options.overflow,"justify"),x=this.textAlign;if(d&&p){var f,u,y=d.getBBox(),v=d.padding;f="left"===x?n.inverted?-v:v:"right"===x?y.width:n.inverted&&"center"===x?y.width/2:n.inverted?k?y.width+v:-v:y.width/2,u=n.inverted?y.height/2:k?-v:y.height,this.alignOptions.x=pick(this.options.x,0),this.alignOptions.y=pick(this.options.y,0),p.x-=f,p.y-=u,d.align(this.alignOptions,null,p),n.isInsidePlot(d.alignAttr.x+f-this.alignOptions.x,d.alignAttr.y+u-this.alignOptions.y)?d.show():(d.alignAttr.y=-9999,g=!1),g&&Series.prototype.justifyDataLabel.call(this.axis,d,this.alignOptions,d.alignAttr,y,p),d.attr({x:d.alignAttr.x,y:d.alignAttr.y}),pick(!g&&this.options.crop,!0)&&(n.isInsidePlot(d.x-v+d.width,d.y)&&n.isInsidePlot(d.x+v,d.y)||d.hide())}},t.prototype.getStackBox=function(t,i,e,s,a,o,n){var r=i.axis.reversed,l=t.inverted,c=n.height+n.pos-(l?t.plotLeft:t.plotTop),h=i.isNegative&&!r||!i.isNegative&&r;return{x:l?h?s-n.right:s-o+n.pos-t.plotLeft:e+t.xAxis[0].transB-t.plotLeft,y:l?n.height-e-a:h?c-s-o:c-s,width:l?o:a,height:l?a:o}},t}();Chart.prototype.getStacks=function(){var t=this,i=t.inverted;t.yAxis.forEach(function(t){t.stacking&&t.stacking.stacks&&t.hasVisibleSeries&&(t.stacking.oldStacks=t.stacking.stacks)}),t.series.forEach(function(e){var s=e.xAxis&&e.xAxis.options||{};!e.options.stacking||!0!==e.visible&&!1!==t.options.chart.ignoreHiddenSeries||(e.stackKey=[e.type,pick(e.options.stack,""),i?s.top:s.left,i?s.height:s.width].join(","))})},StackingAxis.compose(Axis),Series.prototype.setStackedPoints=function(){if(this.options.stacking&&(!0===this.visible||!1===this.chart.options.chart.ignoreHiddenSeries)){var t,i,e,s,a,o,n,r,l,c=this.processedXData,h=this.processedYData,p=[],d=h.length,k=this.options,g=k.threshold,x=pick(k.startFromThreshold&&g,0),f=k.stack,u=k.stacking,y=this.stackKey,v="-"+y,S=this.negStacks,b=this.yAxis,m=b.stacking.stacks,A=b.stacking.oldStacks;for(b.stacking.stacksTouched+=1,n=0;n<d;n++)r=c[n],l=h[n],o=(t=this.getStackIndicator(t,r,this.index)).key,m[a=(i=S&&l<(x?0:g))?v:y]||(m[a]={}),m[a][r]||(A[a]&&A[a][r]?(m[a][r]=A[a][r],m[a][r].total=null):m[a][r]=new StackItem(b,b.options.stackLabels,i,r,f)),e=m[a][r],null!==l?(e.points[o]=e.points[this.index]=[pick(e.cumulative,x)],defined(e.cumulative)||(e.base=o),e.touched=b.stacking.stacksTouched,t.index>0&&!1===this.singleStacks&&(e.points[o][0]=e.points[this.index+","+r+",0"][0])):e.points[o]=e.points[this.index]=null,"percent"===u?(s=i?y:v,S&&m[s]&&m[s][r]?(s=m[s][r],e.total=s.total=Math.max(s.total,e.total)+Math.abs(l)||0):e.total=correctFloat(e.total+(Math.abs(l)||0))):e.total=correctFloat(e.total+(l||0)),e.cumulative=pick(e.cumulative,x)+(l||0),null!==l&&(e.points[o].push(e.cumulative),p[n]=e.cumulative);"percent"===u&&(b.stacking.usePercentage=!0),this.stackedYData=p,b.stacking.oldStacks={}}},Series.prototype.modifyStacks=function(){var t,i=this,e=i.yAxis,s=i.stackKey,a=e.stacking.stacks,o=i.processedXData,n=i.options.stacking;i[n+"Stacker"]&&[s,"-"+s].forEach(function(e){for(var s,r,l,c=o.length;c--;)s=o[c],t=i.getStackIndicator(t,s,i.index,e),(l=(r=a[e]&&a[e][s])&&r.points[t.key])&&i[n+"Stacker"](l,r,c)})},Series.prototype.percentStacker=function(t,i,e){var s=i.total?100/i.total:0;t[0]=correctFloat(t[0]*s),t[1]=correctFloat(t[1]*s),this.stackedYData[e]=t[1]},Series.prototype.getStackIndicator=function(t,i,e,s){return!defined(t)||t.x!==i||s&&t.key!==s?t={x:i,index:0,key:s}:t.index++,t.key=[e,i,t.index].join(","),t},H.StackItem=StackItem;export default H.StackItem;