"use strict";import Axis from"./Axis.js";import H from"./Globals.js";import U from"./Utilities.js";var addEvent=U.addEvent,css=U.css,defined=U.defined,pick=U.pick,timeUnits=U.timeUnits;import"./Chart.js";import"./Navigator.js";import"./Series.js";var Chart=H.Chart,Series=H.Series,OrdinalAxisAdditions=function(){function t(t){this.index={},this.axis=t}return t.prototype.getExtendedPositions=function(){var t,i,o=this,s=o.axis,n=s.constructor.prototype,e=s.chart,r=s.series[0].currentDataGrouping,a=o.index,l=r?r.count+r.unitName:"raw",h=s.options.overscroll,d=s.getExtremes();return a||(a=o.index={}),a[l]||((t={series:[],chart:e,getExtremes:function(){return{min:d.dataMin,max:d.dataMax+h}},options:{ordinal:!0},ordinal:{},ordinal2lin:n.ordinal2lin,val2lin:n.val2lin}).ordinal.axis=t,s.series.forEach(function(s){(i={xAxis:t,xData:s.xData.slice(),chart:e,destroyGroupedData:H.noop,getProcessedData:H.Series.prototype.getProcessedData}).xData=i.xData.concat(o.getOverscrollPositions()),i.options={dataGrouping:r?{enabled:!0,forced:!0,approximation:"open",units:[[r.unitName,[r.count]]]}:{enabled:!1}},s.processData.apply(i),t.series.push(i)}),s.beforeSetTickPositions.apply(t),a[l]=t.ordinal.positions),a[l]},t.prototype.getGroupIntervalFactor=function(t,i,o){this.axis;var s,n,e=o.processedXData,r=e.length,a=[],l=this.groupIntervalFactor;if(!l){for(s=0;s<r-1;s++)a[s]=e[s+1]-e[s];a.sort(function(t,i){return t-i}),n=a[Math.floor(r/2)],t=Math.max(t,e[0]),i=Math.min(i,e[r-1]),this.groupIntervalFactor=l=r*n/(i-t)}return l},t.prototype.getOverscrollPositions=function(){var t=this.axis,i=t.options.overscroll,o=this.overscrollPointsRange,s=[],n=t.dataMax;if(defined(o))for(s.push(n);n<=t.dataMax+i;)n+=o,s.push(n);return s},t.prototype.postProcessTickInterval=function(t){var i=this.axis,o=this.slope;return o?i.options.breaks?i.closestPointRange||t:t/(o/i.closestPointRange):t},t}(),OrdinalAxis=function(){function t(){}return t.compose=function(t,i,o){t.keepProps.push("ordinal");var s=t.prototype;s.beforeSetTickPositions=function(){var t,i,o,s,n,e,r,a,l=this.ordinal,h=[],d=!1,p=this.getExtremes(),c=p.min,f=p.max,u=this.isXAxis&&!!this.options.breaks,v=this.options.ordinal,g=Number.MAX_VALUE,x=this.chart.options.chart.ignoreHiddenSeries;if(v||u){if(this.series.forEach(function(o,s){if(i=[],(!x||!1!==o.visible)&&(!1!==o.takeOrdinalPosition||u)&&(h=h.concat(o.processedXData),t=h.length,h.sort(function(t,i){return t-i}),g=Math.min(g,pick(o.closestPointRange,g)),t)){for(s=0;s<t-1;)h[s]!==h[s+1]&&i.push(h[s+1]),s++;i[0]!==h[0]&&i.unshift(h[0]),h=i}o.isSeriesBoosting&&(a=!0)}),a&&(h.length=0),(t=h.length)>2){for(o=h[1]-h[0],r=t-1;r--&&!d;)h[r+1]-h[r]!==o&&(d=!0);!this.options.keepOrdinalPadding&&(h[0]-c>o||f-h[h.length-1]>o)&&(d=!0)}else this.options.overscroll&&(2===t?g=h[1]-h[0]:1===t?(g=this.options.overscroll,h=[h[0],h[0]+g]):g=l.overscrollPointsRange);d?(this.options.overscroll&&(l.overscrollPointsRange=g,h=h.concat(l.getOverscrollPositions())),l.positions=h,s=this.ordinal2lin(Math.max(c,h[0]),!0),n=Math.max(this.ordinal2lin(Math.min(f,h[h.length-1]),!0),1),l.slope=e=(f-c)/(n-s),l.offset=c-s*e):(l.overscrollPointsRange=pick(this.closestPointRange,l.overscrollPointsRange),l.positions=this.ordinal.slope=l.offset=void 0)}this.isOrdinal=v&&d,l.groupIntervalFactor=null},t.prototype.getTimeTicks=function(t,i,o,s,n,e,r){void 0===n&&(n=[]),void 0===e&&(e=0);var a,l,h,d,p,c,f=0,u={},v=[],g=-Number.MAX_VALUE,x=this.options.tickPixelInterval,m=this.chart.time,P=[];if(!this.options.ordinal&&!this.options.breaks||!n||n.length<3||void 0===i)return m.getTimeTicks.apply(m,arguments);for(p=n.length,a=0;a<p;a++){if(c=a&&n[a-1]>o,n[a]<i&&(f=a),a===p-1||n[a+1]-n[a]>5*e||c){if(n[a]>g){for(l=m.getTimeTicks(t,n[f],n[a],s);l.length&&l[0]<=g;)l.shift();l.length&&(g=l[l.length-1]),P.push(v.length),v=v.concat(l)}f=a+1}if(c)break}if(d=l.info,r&&d.unitRange<=timeUnits.hour){for(a=v.length-1,f=1;f<a;f++)m.dateFormat("%d",v[f])!==m.dateFormat("%d",v[f-1])&&(u[v[f]]="day",h=!0);h&&(u[v[0]]="day"),d.higherRanks=u}if(d.segmentStarts=P,v.info=d,r&&defined(x)){for(var y,M,A,k,E,D=v.length,b=D,R=[],S=[];b--;)M=this.translate(v[b]),A&&(S[b]=A-M),R[b]=A=M;for(S.sort(),(k=S[Math.floor(S.length/2)])<.6*x&&(k=null),b=v[D-1]>o?D-1:D,A=void 0;b--;)M=R[b],E=Math.abs(A-M),A&&E<.8*x&&(null===k||E<.8*k)?(u[v[b]]&&!u[v[b+1]]?(y=b+1,A=M):y=b,v.splice(y,1)):A=M}return v},s.lin2val=function(t,i){var o=this.ordinal,s=o.positions;if(s){var n,e,r=o.slope,a=o.offset,l=s.length-1;if(i)t<0?t=s[0]:t>l?t=s[l]:e=t-(l=Math.floor(t));else for(;l--;)if(t>=(n=r*l+a)){e=(t-n)/(r*(l+1)+a-n);break}return void 0!==e&&void 0!==s[l]?s[l]+(e?e*(s[l+1]-s[l]):0):t}return t},s.val2lin=function(t,i){var o,s=this.ordinal,n=s.positions;if(n){var e,r,a=n.length;for(e=a;e--;)if(n[e]===t){r=e;break}for(e=a-1;e--;)if(t>n[e]||0===e){r=e+(t-n[e])/(n[e+1]-n[e]);break}o=i?r:s.slope*(r||0)+s.offset}else o=t;return o},s.ordinal2lin=s.val2lin,addEvent(t,"afterInit",function(){this.ordinal||(this.ordinal=new OrdinalAxisAdditions(this))}),addEvent(t,"foundExtremes",function(){this.isXAxis&&defined(this.options.overscroll)&&this.max===this.dataMax&&(!this.chart.mouseIsDown||this.isInternal)&&(!this.eventArgs||this.eventArgs&&"navigator"!==this.eventArgs.trigger)&&(this.max+=this.options.overscroll,!this.isInternal&&defined(this.userMin)&&(this.min+=this.options.overscroll))}),addEvent(t,"afterSetScale",function(){this.horiz&&!this.isDirty&&(this.isDirty=this.isOrdinal&&this.chart.navigator&&!this.chart.navigator.adaptToUpdatedData)}),addEvent(i,"pan",function(t){var i=this.xAxis[0],o=i.options.overscroll,s=t.originalEvent.chartX,n=this.options.chart&&this.options.chart.panning,e=!1;if(n&&"y"!==n.type&&i.options.ordinal&&i.series.length){var r,a,l,h,d=this.mouseDownX,p=i.getExtremes(),c=p.dataMax,f=p.min,u=p.max,v=this.hoverPoints,g=i.closestPointRange||i.ordinal&&i.ordinal.overscrollPointsRange,x=(d-s)/(i.translationSlope*(i.ordinal.slope||g)),m={ordinal:{positions:i.ordinal.getExtendedPositions()}},P=i.lin2val,y=i.val2lin;m.ordinal.positions?Math.abs(x)>1&&(v&&v.forEach(function(t){t.setState()}),x<0?(l=m,h=i.ordinal.positions?i:m):(l=i.ordinal.positions?i:m,h=m),c>(a=h.ordinal.positions)[a.length-1]&&a.push(c),this.fixedRange=u-f,(r=i.navigatorAxis.toFixedRange(null,null,P.apply(l,[y.apply(l,[f,!0])+x,!0]),P.apply(h,[y.apply(h,[u,!0])+x,!0]))).min>=Math.min(p.dataMin,f)&&r.max<=Math.max(c,u)+o&&i.setExtremes(r.min,r.max,!0,!1,{trigger:"pan"}),this.mouseDownX=s,css(this.container,{cursor:"move"})):e=!0}else e=!0;e||n&&/y/.test(n.type)?o&&(i.max=i.dataMax+o):t.preventDefault()}),addEvent(o,"updatedData",function(){var t=this.xAxis;t&&t.options.ordinal&&delete t.ordinal.index})},t}();OrdinalAxis.compose(Axis,Chart,Series);export default OrdinalAxis;