"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var addEvent=U.addEvent,pick=U.pick,wrap=U.wrap;import"../parts/Series.js";var perspective=H.perspective,Series=H.Series,seriesTypes=H.seriesTypes,svg=H.svg;function pointAttribs(t){var e=t.apply(this,[].slice.call(arguments,1));return this.chart.is3d&&this.chart.is3d()&&(e.stroke=this.options.edgeColor||e.fill,e["stroke-width"]=pick(this.options.edgeWidth,1)),e}function setState(t,e,s){var i=this.chart.is3d&&this.chart.is3d();i&&(this.options.inactiveOtherPoints=!0),t.call(this,e,s),i&&(this.options.inactiveOtherPoints=!1)}function hasNewShapeType(t){for(var e=[],s=1;s<arguments.length;s++)e[s-1]=arguments[s];return this.series.chart.is3d()?this.graphic&&"g"!==this.graphic.element.nodeName:t.apply(this,e)}wrap(seriesTypes.column.prototype,"translate",function(t){t.apply(this,[].slice.call(arguments,1)),this.chart.is3d()&&this.translate3dShapes()}),wrap(H.Series.prototype,"justifyDataLabel",function(t){return!arguments[2].outside3dPlot&&t.apply(this,[].slice.call(arguments,1))}),seriesTypes.column.prototype.translate3dPoints=function(){},seriesTypes.column.prototype.translate3dShapes=function(){var t,e=this,s=e.chart,i=e.options,r=i.depth,p=(i.stacking?i.stack||0:e.index)*(r+(i.groupZPadding||1)),a=e.borderWidth%2?.5:0;s.inverted&&!e.yAxis.reversed&&(a*=-1),!1!==i.grouping&&(p=0),p+=i.groupZPadding||1,e.data.forEach(function(i){if(i.outside3dPlot=null,null!==i.y){var o,h=i.shapeArgs,n=i.tooltipPos;[["x","width"],["y","height"]].forEach(function(t){if((o=h[t[0]]-a)<0&&(h[t[1]]+=h[t[0]]+a,h[t[0]]=-a,o=0),o+h[t[1]]>e[t[0]+"Axis"].len&&0!==h[t[1]]&&(h[t[1]]=e[t[0]+"Axis"].len-h[t[0]]),0!==h[t[1]]&&(h[t[0]]>=e[t[0]+"Axis"].len||h[t[0]]+h[t[1]]<=a)){for(var s in h)h[s]=0;i.outside3dPlot=!0}}),"rect"===i.shapeType&&(i.shapeType="cuboid"),h.z=p,h.depth=r,h.insidePlotArea=!0,t={x:h.x+h.width/2,y:h.y,z:p+r/2},s.inverted&&(t.x=h.height,t.y=i.clientX),i.plot3d=perspective([t],s,!0,!1)[0],n=perspective([{x:n[0],y:n[1],z:p+r/2}],s,!0,!1)[0],i.tooltipPos=[n.x,n.y]}}),e.z=p},wrap(seriesTypes.column.prototype,"animate",function(t){if(this.chart.is3d()){var e=arguments[1],s=this.yAxis,i=this,r=this.yAxis.reversed;svg&&(e?i.data.forEach(function(t){null!==t.y&&(t.height=t.shapeArgs.height,t.shapey=t.shapeArgs.y,t.shapeArgs.height=1,r||(t.stackY?t.shapeArgs.y=t.plotY+s.translate(t.stackY):t.shapeArgs.y=t.plotY+(t.negative?-t.height:t.height)))}):(i.data.forEach(function(t){null!==t.y&&(t.shapeArgs.height=t.height,t.shapeArgs.y=t.shapey,t.graphic&&t.graphic.animate(t.shapeArgs,i.options.animation))}),this.drawDataLabels()))}else t.apply(this,[].slice.call(arguments,1))}),wrap(seriesTypes.column.prototype,"plotGroup",function(t,e,s,i,r,p){return"dataLabelsGroup"!==e&&this.chart.is3d()&&(this[e]&&delete this[e],p&&(this.chart.columnGroup||(this.chart.columnGroup=this.chart.renderer.g("columnGroup").add(p)),this[e]=this.chart.columnGroup,this.chart.columnGroup.attr(this.getPlotBox()),this[e].survive=!0,"group"!==e&&"markerGroup"!==e||(arguments[3]="visible"))),t.apply(this,Array.prototype.slice.call(arguments,1))}),wrap(seriesTypes.column.prototype,"setVisible",function(t,e){var s,i=this;i.chart.is3d()&&i.data.forEach(function(t){t.visible=t.options.visible=e=void 0===e?!pick(i.visible,t.visible):e,s=e?"visible":"hidden",i.options.data[i.data.indexOf(t)]=t.options,t.graphic&&t.graphic.attr({visibility:s})}),t.apply(this,Array.prototype.slice.call(arguments,1))}),seriesTypes.column.prototype.handle3dGrouping=!0,addEvent(Series,"afterInit",function(){if(this.chart.is3d()&&this.handle3dGrouping){var t=this.options,e=t.grouping,s=t.stacking,i=pick(this.yAxis.options.reversedStacks,!0),r=0;if(void 0===e||e){var p,a=this.chart.retrieveStacks(s),o=t.stack||0;for(p=0;p<a[o].series.length&&a[o].series[p]!==this;p++);r=10*(a.totalStacks-a[o].position)+(i?p:-p),this.xAxis.reversed||(r=10*a.totalStacks-r)}t.depth=t.depth||25,this.z=this.z||0,t.zIndex=r}}),wrap(seriesTypes.column.prototype,"pointAttribs",pointAttribs),wrap(seriesTypes.column.prototype,"setState",setState),wrap(seriesTypes.column.prototype.pointClass.prototype,"hasNewShapeType",hasNewShapeType),seriesTypes.columnrange&&(wrap(seriesTypes.columnrange.prototype,"pointAttribs",pointAttribs),wrap(seriesTypes.columnrange.prototype,"setState",setState),wrap(seriesTypes.columnrange.prototype.pointClass.prototype,"hasNewShapeType",hasNewShapeType),seriesTypes.columnrange.prototype.plotGroup=seriesTypes.column.prototype.plotGroup,seriesTypes.columnrange.prototype.setVisible=seriesTypes.column.prototype.setVisible),wrap(Series.prototype,"alignDataLabel",function(t,e,s,i,r){var p=this.chart;if(i.outside3dPlot=e.outside3dPlot,p.is3d()&&this.is("column")){var a=this.options,o=pick(i.inside,!!this.options.stacking),h=p.options.chart.options3d,n=e.pointWidth/2||0,l={x:r.x+n,y:r.y,z:this.z+a.depth/2};p.inverted&&(o&&(r.width=0,l.x+=e.shapeArgs.height/2),h.alpha>=90&&h.alpha<=270&&(l.y+=e.shapeArgs.width)),l=perspective([l],p,!0,!1)[0],r.x=l.x-n,r.y=e.outside3dPlot?-9e9:l.y}t.apply(this,[].slice.call(arguments,1))}),wrap(H.StackItem.prototype,"getStackBox",function(t,e,s,i,r,p,a,o){var h=t.apply(this,[].slice.call(arguments,1));if(e.is3d()&&s.base){var n=+s.base.split(",")[0],l=e.series[n],c=e.options.chart.options3d;if(l&&l instanceof seriesTypes.column){var d={x:h.x+(e.inverted?a:p/2),y:h.y,z:l.options.depth/2};e.inverted&&(h.width=0,c.alpha>=90&&c.alpha<=270&&(d.y+=p)),d=perspective([d],e,!0,!1)[0],h.x=d.x-p/2,h.y=d.y}}return h});