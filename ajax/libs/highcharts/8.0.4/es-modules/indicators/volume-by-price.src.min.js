"use strict";import H from"../parts/Globals.js";import Point from"../parts/Point.js";import U from"../parts/Utilities.js";var addEvent=U.addEvent,animObject=U.animObject,arrayMax=U.arrayMax,arrayMin=U.arrayMin,correctFloat=U.correctFloat,error=U.error,extend=U.extend,isArray=U.isArray,seriesType=U.seriesType;function arrayExtremesOHLC(e){for(var t,o=e.length,s=e[0][3],a=s,i=1;i<o;i++)(t=e[i][3])<s&&(s=t),t>a&&(a=t);return{min:s,max:a}}var abs=Math.abs,noop=H.noop,columnPrototype=H.seriesTypes.column.prototype;seriesType("vbp","sma",{params:{ranges:12,volumeSeriesID:"volume"},zoneLines:{enabled:!0,styles:{color:"#0A9AC9",dashStyle:"LongDash",lineWidth:1}},volumeDivision:{enabled:!0,styles:{positiveColor:"rgba(144, 237, 125, 0.8)",negativeColor:"rgba(244, 91, 91, 0.8)"}},animationLimit:1e3,enableMouseTracking:!1,pointPadding:0,zIndex:-1,crisp:!0,dataGrouping:{enabled:!1},dataLabels:{allowOverlap:!0,enabled:!0,format:"P: {point.volumePos:.2f} | N: {point.volumeNeg:.2f}",padding:0,style:{fontSize:"7px"},verticalAlign:"top"}},{nameBase:"Volume by Price",bindTo:{series:!1,eventName:"afterSetExtremes"},calculateOn:"render",markerAttribs:noop,drawGraph:noop,getColumnMetrics:columnPrototype.getColumnMetrics,crispCol:columnPrototype.crispCol,init:function(e){var t,o,s;return H.seriesTypes.sma.prototype.init.apply(this,arguments),t=this.options.params,o=this.linkedParent,s=e.get(t.volumeSeriesID),this.addCustomEvents(o,s),this},addCustomEvents:function(e,t){var o=this;function s(){o.chart.redraw(),o.setData([]),o.zoneStarts=[],o.zoneLinesSVG&&(o.zoneLinesSVG.destroy(),delete o.zoneLinesSVG)}return o.dataEventsToUnbind.push(addEvent(e,"remove",function(){s()})),t&&o.dataEventsToUnbind.push(addEvent(t,"remove",function(){s()})),o},animate:function(e){var t=this,o={};e||(o.translateX=t.yAxis.pos,t.group.animate(o,extend(animObject(t.options.animation),{step:function(e,o){t.group.attr({scaleX:Math.max(.001,o.pos)})}})))},drawPoints:function(){this.options.volumeDivision.enabled&&(this.posNegVolume(!0,!0),columnPrototype.drawPoints.apply(this,arguments),this.posNegVolume(!1,!1)),columnPrototype.drawPoints.apply(this,arguments)},posNegVolume:function(e,t){var o,s,a,i,r=t?["positive","negative"]:["negative","positive"],n=this.options.volumeDivision,p=this.points.length,l=[],h=[],u=0;for(e?(this.posWidths=l,this.negWidths=h):(l=this.posWidths,h=this.negWidths);u<p;u++)(i=this.points[u])[r[0]+"Graphic"]=i.graphic,i.graphic=i[r[1]+"Graphic"],e&&(o=i.shapeArgs.width,(a=(s=this.priceZones[u]).wholeVolumeData)?(l.push(o/a*s.positiveVolumeData),h.push(o/a*s.negativeVolumeData)):(l.push(0),h.push(0))),i.color=t?n.styles.positiveColor:n.styles.negativeColor,i.shapeArgs.width=t?this.posWidths[u]:this.negWidths[u],i.shapeArgs.x=t?i.shapeArgs.x:this.posWidths[u]},translate:function(){var e,t,o,s,a,i,r,n,p,l,h,u,d=this,c=d.options,m=d.chart,v=d.yAxis,g=v.min,y=d.options.zoneLines,f=d.priceZones,D=0;columnPrototype.translate.apply(d),(e=d.points).length&&(p=c.pointPadding<.5?c.pointPadding:.1,t=d.volumeDataArray,o=arrayMax(t),s=m.plotWidth/2,l=m.plotTop,a=abs(v.toPixels(g)-v.toPixels(g+d.rangeStep)),r=abs(v.toPixels(g)-v.toPixels(g+d.rangeStep)),p&&(i=abs(a*(1-2*p)),D=abs((a-i)/2),a=abs(i)),e.forEach(function(e,t){h=e.barX=e.plotX=0,u=e.plotY=v.toPixels(f[t].start)-l-(v.reversed?a-r:a)-D,n=correctFloat(s*f[t].wholeVolumeData/o),e.pointWidth=n,e.shapeArgs=d.crispCol.apply(d,[h,u,n,a]),e.volumeNeg=f[t].negativeVolumeData,e.volumePos=f[t].positiveVolumeData,e.volumeAll=f[t].wholeVolumeData}),y.enabled&&d.drawZones(m,v,d.zoneStarts,y.styles))},getValues:function(e,t){var o,s,a=e.processedXData,i=e.processedYData,r=this.chart,n=t.ranges,p=[],l=[],h=[];if(e.chart)if(s=r.get(t.volumeSeriesID)){if(!(o=isArray(i[0]))||4===i[0].length)return(this.priceZones=this.specifyZones(o,a,i,n,s)).forEach(function(e,t){p.push([e.x,e.end]),l.push(p[t][0]),h.push(p[t][1])}),{values:p,xData:l,yData:h};error("Type of "+e.name+" series is different than line, OHLC or candlestick.",!0,r)}else error("Series "+t.volumeSeriesID+" not found! Check `volumeSeriesID`.",!0,r);else error("Base series not found! In case it has been removed, add a new one.",!0,r)},specifyZones:function(e,t,o,s,a){var i,r,n=!!e&&arrayExtremesOHLC(o),p=n?n.min:arrayMin(o),l=n?n.max:arrayMax(o),h=this.zoneStarts=[],u=[],d=0,c=1;if(!p||!l)return this.points.length&&(this.setData([]),this.zoneStarts=[],this.zoneLinesSVG.destroy()),[];for(i=this.rangeStep=correctFloat(l-p)/s,h.push(p);d<s-1;d++)h.push(correctFloat(h[d]+i));for(h.push(l),r=h.length;c<r;c++)u.push({index:c-1,x:t[0],start:h[c-1],end:h[c]});return this.volumePerZone(e,u,a,t,o)},volumePerZone:function(e,t,o,s,a){var i,r,n,p,l,h=this,u=o.processedXData,d=o.processedYData,c=t.length-1,m=a.length,v=d.length;return abs(m-v)&&(s[0]!==u[0]&&d.unshift(0),s[m-1]!==u[v-1]&&d.push(0)),h.volumeDataArray=[],t.forEach(function(t){for(t.wholeVolumeData=0,t.positiveVolumeData=0,t.negativeVolumeData=0,l=0;l<m;l++)r=!1,n=!1,p=e?a[l][3]:a[l],i=l?e?a[l-1][3]:a[l-1]:p,p<=t.start&&0===t.index&&(r=!0),p>=t.end&&t.index===c&&(n=!0),(p>t.start||r)&&(p<t.end||n)&&(t.wholeVolumeData+=d[l],i>p?t.negativeVolumeData+=d[l]:t.positiveVolumeData+=d[l]);h.volumeDataArray.push(t.wholeVolumeData)}),t},drawZones:function(e,t,o,s){var a,i=e.renderer,r=this.zoneLinesSVG,n=[],p=e.plotWidth,l=e.plotTop;o.forEach(function(o){a=t.toPixels(o)-l,n=n.concat(e.renderer.crispLine(["M",0,a,"L",p,a],s.lineWidth))}),r?r.animate({d:n}):r=this.zoneLinesSVG=i.path(n).attr({"stroke-width":s.lineWidth,stroke:s.color,dashstyle:s.dashStyle,zIndex:this.group.zIndex+.1}).add(this.group)}},{destroy:function(){return this.negativeGraphic&&(this.negativeGraphic=this.negativeGraphic.destroy()),Point.prototype.destroy.apply(this,arguments)}});