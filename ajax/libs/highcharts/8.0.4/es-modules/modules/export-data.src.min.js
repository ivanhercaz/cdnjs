"use strict";import Highcharts from"../parts/Globals.js";import U from"../parts/Utilities.js";var defined=U.defined,extend=U.extend,isObject=U.isObject,pick=U.pick;import"../parts/Chart.js";import"../mixins/ajax.js";import"../mixins/download-url.js";var win=Highcharts.win,doc=win.document,seriesTypes=Highcharts.seriesTypes,downloadURL=Highcharts.downloadURL,fireEvent=Highcharts.fireEvent;function htmlencode(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")}function getBlobFromContent(t,e){var i=win.navigator,o=i.userAgent.indexOf("WebKit")>-1&&i.userAgent.indexOf("Chrome")<0,a=win.URL||win.webkitURL||win;try{if(i.msSaveOrOpenBlob&&win.MSBlobBuilder){var n=new win.MSBlobBuilder;return n.append(t),n.getBlob("image/svg+xml")}if(!o)return a.createObjectURL(new win.Blob(["\ufeff"+t],{type:e}))}catch(t){}}Highcharts.setOptions({exporting:{csv:{columnHeaderFormatter:null,dateFormat:"%Y-%m-%d %H:%M:%S",decimalPoint:null,itemDelimiter:null,lineDelimiter:"\n"},showTable:!1,useMultiLevelHeaders:!0,useRowspanHeaders:!0},lang:{downloadCSV:"Download CSV",downloadXLS:"Download XLS",viewData:"View data table"}}),Highcharts.addEvent(Highcharts.Chart,"render",function(){this.options&&this.options.exporting&&this.options.exporting.showTable&&!this.options.chart.forExport&&this.viewData()}),Highcharts.Chart.prototype.setUpKeyToAxis=function(){seriesTypes.arearange&&(seriesTypes.arearange.prototype.keyToAxis={low:"y",high:"y"}),seriesTypes.gantt&&(seriesTypes.gantt.prototype.keyToAxis={start:"x",end:"x"})},Highcharts.Chart.prototype.getDataRows=function(t){var e,i,o,a,n,r,s,l,p=this.hasParallelCoordinates,c=this.time,h=this.options.exporting&&this.options.exporting.csv||{},d=this.xAxis,m={},x=[],g=[],u=[],f=function(e,i,o){if(h.columnHeaderFormatter){var a=h.columnHeaderFormatter(e,i,o);if(!1!==a)return a}return e?e instanceof Highcharts.Axis?e.options.title&&e.options.title.text||(e.isDatetimeAxis?"DateTime":"Category"):t?{columnTitle:o>1?i:e.name,topLevelColumnTitle:e.name}:e.name+(o>1?" ("+i+")":""):"Category"},y=function(t,e,i){var o={},a={};return e.forEach(function(e){var n=(t.keyToAxis&&t.keyToAxis[e]||e)+"Axis",r=Highcharts.isNumber(i)?t.chart[n][i]:t[n];o[e]=r&&r.categories||[],a[e]=r&&r.isDatetimeAxis}),{categoryMap:o,dateTimeValueAxisMap:a}},b=[];for(n in a=0,this.setUpKeyToAxis(),this.series.forEach(function(e){var i,n,r=e.options.keys||e.pointArrayMap||["y"],s=r.length,l=!e.requireSorting&&{},x=d.indexOf(e.xAxis),v=y(e,r);if(!1!==e.options.includeInDataExport&&!e.options.isInternal&&!1!==e.visible){for(Highcharts.find(b,function(t){return t[0]===x})||b.push([x,a]),n=0;n<s;)o=f(e,r[n],r.length),u.push(o.columnTitle||o),t&&g.push(o.topLevelColumnTitle||o),n++;i={chart:e.chart,autoIncrement:e.autoIncrement,options:e.options,pointArrayMap:e.pointArrayMap},e.options.data.forEach(function(t,o){var d,g,u,f,b;for(p&&(v=y(e,r,o)),b={series:i},e.pointClass.prototype.applyOptions.apply(b,[t]),d=b.x,f=e.data[o]&&e.data[o].name,n=0,e.xAxis&&"name"!==e.exportKey||(d=f),l&&(l[d]&&(d+="|"+o),l[d]=!0),m[d]||(m[d]=[],m[d].xValues=[]),m[d].x=b.x,m[d].name=f,m[d].xValues[x]=b.x;n<s;)u=b[g=r[n]],m[d][a+n]=pick(v.categoryMap[g][u],v.dateTimeValueAxisMap[g]?c.dateFormat(h.dateFormat,u):null,u),n++}),a+=n}}),m)Object.hasOwnProperty.call(m,n)&&x.push(m[n]);for(i=t?[g,u]:[u],a=b.length;a--;)s=b[a][0],l=b[a][1],e=d[s],x.sort(function(t,e){return t.xValues[s]-e.xValues[s]}),r=f(e),i[0].splice(l,0,r),t&&i[1]&&i[1].splice(l,0,r),x.forEach(function(t){var i=t.name;e&&!defined(i)&&(e.isDatetimeAxis?(t.x instanceof Date&&(t.x=t.x.getTime()),i=c.dateFormat(h.dateFormat,t.x)):i=e.categories?pick(e.names[t.x],e.categories[t.x],t.x):t.x),t.splice(l,0,i)});return i=i.concat(x),fireEvent(this,"exportData",{dataRows:i}),i},Highcharts.Chart.prototype.getCSV=function(t){var e="",i=this.getDataRows(),o=this.options.exporting.csv,a=pick(o.decimalPoint,","!==o.itemDelimiter&&t?1.1.toLocaleString()[1]:"."),n=pick(o.itemDelimiter,","===a?";":","),r=o.lineDelimiter;return i.forEach(function(t,o){for(var s="",l=t.length;l--;)"string"==typeof(s=t[l])&&(s='"'+s+'"'),"number"==typeof s&&"."!==a&&(s=s.toString().replace(".",a)),t[l]=s;e+=t.join(n),o<i.length-1&&(e+=r)}),e},Highcharts.Chart.prototype.getTable=function(t){var e='<table id="highcharts-data-table-'+this.index+'">',i=this.options,o=t?1.1.toLocaleString()[1]:".",a=pick(i.exporting.useMultiLevelHeaders,!0),n=this.getDataRows(a),r=0,s=a?n.shift():null,l=n.shift(),p=function(t,e,i,a){var n=pick(a,""),r="text"+(e?" "+e:"");return"number"==typeof n?(n=n.toString(),","===o&&(n=n.replace(".",o)),r="number"):a||(r="empty"),"<"+t+(i?" "+i:"")+' class="'+r+'">'+n+"</"+t+">"};!1!==i.exporting.tableCaption&&(e+='<caption class="highcharts-table-caption">'+pick(i.exporting.tableCaption,i.title.text?htmlencode(i.title.text):"Chart")+"</caption>");for(var c=0,h=n.length;c<h;++c)n[c].length>r&&(r=n[c].length);e+=function(t,e,o){var n,r,s="<thead>",l=0,c=o||e&&e.length,h=0;if(a&&t&&e&&!function(t,e){var i=t.length;if(e.length!==i)return!1;for(;i--;)if(t[i]!==e[i])return!1;return!0}(t,e)){for(s+="<tr>";l<c;++l)(n=t[l])===t[l+1]?++h:h?(s+=p("th","highcharts-table-topheading",'scope="col" colspan="'+(h+1)+'"',n),h=0):(n===e[l]?i.exporting.useRowspanHeaders?(r=2,delete e[l]):(r=1,e[l]=""):r=1,s+=p("th","highcharts-table-topheading",'scope="col"'+(r>1?' valign="top" rowspan="'+r+'"':""),n));s+="</tr>"}if(e){for(s+="<tr>",l=0,c=e.length;l<c;++l)void 0!==e[l]&&(s+=p("th",null,'scope="col"',e[l]));s+="</tr>"}return s+="</thead>"}(s,l,Math.max(r,l.length)),e+="<tbody>",n.forEach(function(t){e+="<tr>";for(var i=0;i<r;i++)e+=p(i?"td":"th",null,i?"":'scope="row"',t[i]);e+="</tr>"});var d={html:e+="</tbody></table>"};return fireEvent(this,"afterGetTable",d),d.html},Highcharts.Chart.prototype.downloadCSV=function(){var t=this.getCSV(!0);downloadURL(getBlobFromContent(t,"text/csv")||"data:text/csv,\ufeff"+encodeURIComponent(t),this.getFilename()+".csv")},Highcharts.Chart.prototype.downloadXLS=function(){var t,e='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head>\x3c!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Ark1</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--\x3e<style>td{border:none;font-family: Calibri, sans-serif;} .number{mso-number-format:"0.00";} .text{ mso-number-format:"@";}</style><meta name=ProgId content=Excel.Sheet><meta charset=UTF-8></head><body>'+this.getTable(!0)+"</body></html>";downloadURL(getBlobFromContent(e,"application/vnd.ms-excel")||"data:application/vnd.ms-excel;base64,"+(t=e,win.btoa(unescape(encodeURIComponent(t)))),this.getFilename()+".xls")},Highcharts.Chart.prototype.viewData=function(){this.dataTableDiv||(this.dataTableDiv=doc.createElement("div"),this.dataTableDiv.className="highcharts-data-table",this.renderTo.parentNode.insertBefore(this.dataTableDiv,this.renderTo.nextSibling)),this.dataTableDiv.innerHTML=this.getTable(),fireEvent(this,"afterViewData",this.dataTableDiv)};var exportingOptions=Highcharts.getOptions().exporting;exportingOptions&&(extend(exportingOptions.menuItemDefinitions,{downloadCSV:{textKey:"downloadCSV",onclick:function(){this.downloadCSV()}},downloadXLS:{textKey:"downloadXLS",onclick:function(){this.downloadXLS()}},viewData:{textKey:"viewData",onclick:function(){this.viewData()}}}),exportingOptions.buttons&&exportingOptions.buttons.contextButton.menuItems.push("separator","downloadCSV","downloadXLS","viewData")),seriesTypes.map&&(seriesTypes.map.prototype.exportKey="name"),seriesTypes.mapbubble&&(seriesTypes.mapbubble.prototype.exportKey="name"),seriesTypes.treemap&&(seriesTypes.treemap.prototype.exportKey="name");