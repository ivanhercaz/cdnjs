define(["./_base/config","./_base/lang","./sniff","./dom","./dom-construct","./_base/window","require"],function(l,o,d,n,s,u,r){var t={};d("extend-dojo")&&o.setObject("dojo.back",t);var h=t.getHash=function(){var o=window.location.hash;return"#"==o.charAt(0)&&(o=o.substring(1)),d("mozilla")?o:decodeURIComponent(o)},f=t.setHash=function(o){o=o||"",window.location.hash=encodeURIComponent(o),history.length},e="undefined"!=typeof window?window.location.href:"",a="undefined"!=typeof window?h():"",c=null,w=null,g=null,m=null,b=[],k=[],i=!1,y=!1;function p(){var o=k.pop();if(o){var n=k[k.length-1];n||0!=k.length||(n=c),n&&(n.kwArgs.back?n.kwArgs.back():n.kwArgs.backButton?n.kwArgs.backButton():n.kwArgs.handle&&n.kwArgs.handle("back")),b.push(o)}}function v(){var o=b.pop();o&&(o.kwArgs.forward?o.kwArgs.forward():o.kwArgs.forwardButton?o.kwArgs.forwardButton():o.kwArgs.handle&&o.kwArgs.handle("forward"),k.push(o))}function j(o,n,r){return{url:o,kwArgs:n,urlHash:r}}function A(o){var n=o.split("?");return n.length<2?null:n[1]}function H(){var o=(l.dojoIframeHistoryUrl||r.toUrl("./resources/iframe_history.html"))+"?"+(new Date).getTime();return i=!0,m&&(d("webkit")?m.location=o:window.frames[m.name].location=o),o}function _(){if(!y){var o=k.length,n=h();if((n===a||window.location.href==e)&&1==o)return void p();if(0<b.length&&b[b.length-1].urlHash===n)return void v();2<=o&&k[o-2]&&k[o-2].urlHash===n&&p()}}return t.goBack=p,t.goForward=v,t.init=function(){if(!n.byId("dj_history")){var o=l.dojoIframeHistoryUrl||r.toUrl("./resources/iframe_history.html");l.afterOnLoad?console.error("dojo/back::init() must be called before the DOM has loaded. Include dojo/back in a build layer."):document.write('<iframe style="border:0;width:1px;height:1px;position:absolute;visibility:hidden;bottom:0;right:0;" name="dj_history" id="dj_history" src="'+o+'"></iframe>')}},t.setInitialState=function(o){c=j(e,o,a)},t.addToHistory=function(o){b=[];var n=null,r=null;if(m||(l.useXDomain&&!l.dojoIframeHistoryUrl&&console.warn("dojo/back: When using cross-domain Dojo builds, please save iframe_history.html to your domain and set djConfig.dojoIframeHistoryUrl to the path on your domain to iframe_history.html"),m=window.frames.dj_history),g=g||s.create("a",{style:{display:"none"}},u.body()),o.changeUrl){if(n=""+(!0!==o.changeUrl?o.changeUrl:(new Date).getTime()),0==k.length&&c.urlHash==n)return void(c=j(r,o,n));if(0<k.length&&k[k.length-1].urlHash==n)return void(k[k.length-1]=j(r,o,n));if(y=!0,setTimeout(function(){f(n),y=!1},1),g.href=n,d("ie")){r=H();function t(o){""!=h()&&setTimeout(function(){f(n)},1),e.apply(this,[o])}var e=o.back||o.backButton||o.handle;o.back?o.back=t:o.backButton?o.backButton=t:o.handle&&(o.handle=t);function a(o){""!=h()&&f(n),i&&i.apply(this,[o])}var i=o.forward||o.forwardButton||o.handle;o.forward?o.forward=a:o.forwardButton?o.forwardButton=a:o.handle&&(o.handle=a)}else d("ie")||(w=w||setInterval(_,200))}else r=H();k.push(j(r,o,n))},t._iframeLoaded=function(o,n){var r=A(n.href);null!=r?i?i=!1:2<=k.length&&r==A(k[k.length-2].url)?p():0<b.length&&r==A(b[b.length-1].url)&&v():1==k.length&&p()},t});