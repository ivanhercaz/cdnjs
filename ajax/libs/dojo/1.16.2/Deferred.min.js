define(["./has","./_base/lang","./errors/CancelError","./promise/Promise","./has!config-deferredInstrumentation?./promise/instrumentation"],function(l,e,d,r,n){"use strict";function h(e,r,n,t,i){l("config-deferredInstrumentation")&&2===r&&w.instrumentRejected&&0===e.length&&w.instrumentRejected(n,!1,t,i);for(var c=0;c<e.length;c++)v(e[c],r,n,t)}var m="This deferred has already been fulfilled.",p=Object.freeze||function(){},v=function(e,r,n,t){var i=e[r],c=e.deferred;if(i)try{var o=i(n);if(0===r)void 0!==o&&s(c,r,o);else{if(o&&"function"==typeof o.then)return e.cancel=o.cancel,void o.then(u(c,1),u(c,2),u(c,0));s(c,1,o)}}catch(e){s(c,2,e)}else s(c,r,n);l("config-deferredInstrumentation")&&2===r&&w.instrumentRejected&&w.instrumentRejected(n,!!i,t,c.promise)},u=function(r,n){return function(e){s(r,n,e)}},s=function(e,r,n){if(!e.isCanceled())switch(r){case 0:e.progress(n);break;case 1:e.resolve(n);break;case 2:e.reject(n)}},w=function(t){var i,c,o,u=this.promise=new r,n=this,s=!1,f=[];l("config-deferredInstrumentation")&&Error.captureStackTrace&&(Error.captureStackTrace(n,w),Error.captureStackTrace(u,w)),this.isResolved=u.isResolved=function(){return 1===i},this.isRejected=u.isRejected=function(){return 2===i},this.isFulfilled=u.isFulfilled=function(){return!!i},this.isCanceled=u.isCanceled=function(){return s},this.progress=function(e,r){if(i){if(!0===r)throw new Error(m);return u}return h(f,0,e,null,n),u},this.resolve=function(e,r){if(i){if(!0===r)throw new Error(m);return u}return h(f,i=1,c=e,null,n),f=null,u};var a=this.reject=function(e,r){if(i){if(!0===r)throw new Error(m);return u}return l("config-deferredInstrumentation")&&Error.captureStackTrace&&Error.captureStackTrace(o={},a),h(f,i=2,c=e,o,n),f=null,u};this.then=u.then=function(e,r,n){var t=[n,e,r];return t.cancel=u.cancel,t.deferred=new w(function(e){return t.cancel&&t.cancel(e)}),i&&!f?v(t,i,c,o):f.push(t),t.deferred.promise},this.cancel=u.cancel=function(e,r){if(i){if(!0===r)throw new Error(m)}else{if(t){var n=t(e);e=void 0===n?e:n}if(s=!0,!i)return void 0===e&&(e=new d),a(e),e;if(2===i&&c===e)return e}},p(u)};return w.prototype.toString=function(){return"[object Deferred]"},n&&n(w),w});