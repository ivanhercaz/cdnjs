define(["dojo/main","doh/main","require","./readOnlyItemFileTestTemplates","dojo/data/ItemFileWriteStore","dojo/data/api/Read","dojo/data/api/Identity","dojo/data/api/Write","dojo/data/api/Notification"],function(d,y,r){d.getObject("data.ItemFileWriteStore",!0,tests),tests.data.readOnlyItemFileTestTemplates.registerTestsForDatastore("dojo.data.ItemFileWriteStore"),tests.data.ItemFileWriteStore.getTestData=function(e){var t={};return"reference_integrity"===e&&(t=d.isBrowser?{url:r.toUrl("./reference_integrity.json")}:{data:{identifier:"id",label:"name",items:[{id:1,name:"Item 1"},{id:2,name:"Item 2"},{id:3,name:"Item 3"},{id:4,name:"Item 4"},{id:5,name:"Item 5"},{id:6,name:"Item 6"},{id:7,name:"Item 7"},{id:8,name:"Item 8"},{id:9,name:"Item 9"},{id:10,name:"Item 10",friends:[{_reference:1},{_reference:3},{_reference:5}]},{id:11,name:"Item 11",friends:[{_reference:10}],siblings:[{_reference:10}]},{id:12,name:"Item 12",friends:[{_reference:3},{_reference:7}],enemies:[{_reference:10}]},{id:13,name:"Item 13",friends:[{_reference:10}]},{id:14,name:"Item 14",friends:[{_reference:11}]},{id:15,name:"item 15",friends:[{id:16,name:"Item 16"}]}]}}),t},y.register("testsDOH.data.ItemFileWriteStore",[function(){var e=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")).getFeatures();y.assertTrue(null!==e["dojo.data.api.Read"]),y.assertTrue(null!==e["dojo.data.api.Identity"]),y.assertTrue(null!==e["dojo.data.api.Write"]),y.assertTrue(null!==e["dojo.data.api.Notification"]),y.assertFalse(e.iggy);var t=0;for(var r in e)y.assertTrue("dojo.data.api.Read"===r||"dojo.data.api.Identity"===r||"dojo.data.api.Write"===r||"dojo.data.api.Notification"===r),t++;y.assertEqual(t,4)},function(){var a=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),n=new y.Deferred;return a.fetch({query:{name:"Egypt"},onComplete:function(e,t){y.assertEqual(1,e.length);var r=e[0];y.assertTrue(a.containsValue(r,"capital","Cairo")),y.assertEqual(a.isDirty(r),!1),y.assertTrue(!1===a.isDirty(r)),y.assertFalse(a.isDirty()),y.assertTrue(!1===a.isDirty(r)),y.assertTrue(!a.isDirty()),a.setValue(r,"capital","New Cairo"),y.assertTrue(a.isDirty(r)),y.assertTrue(a.isDirty()),y.assertEqual(a.getValue(r,"capital").toString(),"New Cairo"),n.callback(!0)},onError:function(e,t){n.errback(e)}}),n},function(){var n=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),i=new y.Deferred;return n.fetch({query:{name:"Egypt"},onComplete:function(e,t){y.assertEqual(1,e.length);var r=e[0];y.assertTrue(n.containsValue(r,"name","Egypt")),y.assertTrue(!1===n.isDirty(r)),y.assertTrue(!n.isDirty()),n.setValues(r,"name",["Egypt 1","Egypt 2"]),y.assertTrue(n.isDirty(r)),y.assertTrue(n.isDirty());var a=n.getValues(r,"name");y.assertTrue("Egypt 1"==a[0]),y.assertTrue("Egypt 2"==a[1]),i.callback(!0)},onError:function(e,t){i.errback(e)}}),i},function(){var a=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),n=new y.Deferred;return a.fetch({query:{name:"Egypt"},onComplete:function(e,t){y.assertEqual(1,e.length);var r=e[0];y.assertTrue(a.containsValue(r,"name","Egypt")),y.assertTrue(!1===a.isDirty(r)),y.assertTrue(!a.isDirty()),a.unsetAttribute(r,"name"),y.assertTrue(a.isDirty(r)),y.assertTrue(a.isDirty()),y.assertTrue(!a.hasAttribute(r,"name")),n.callback(!0)},onError:function(e,t){n.errback(e)}}),n},function(){var a=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),n=new y.Deferred;y.assertTrue(!a.isDirty());var r=!1;a.onNew=function(e,t){y.assertTrue(null!==e),y.assertTrue(null===t),y.assertTrue(a.isItem(e)),r=!0};var e=a.newItem({name:"Canada",abbr:"ca",capital:"Ottawa"});return y.assertTrue(r),y.assertTrue(a.isDirty(e)),y.assertTrue(a.isDirty()),y.assertTrue("Canada"==a.getValues(e,"name")),a.fetch({query:{name:"Canada"},onComplete:function(e,t){y.assertEqual(1,e.length);var r=e[0];y.assertTrue(a.containsValue(r,"name","Canada")),n.callback(!0)},onError:function(e,t){n.errback(e)}}),n},function(){var n=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),i=new y.Deferred;y.assertTrue(!n.isDirty());function o(e,t){i.errback(e)}return n.fetch({query:{name:"Egypt"},onComplete:function(e,t){y.assertEqual(1,e.length);var r=e[0];y.assertTrue(n.containsValue(r,"name","Egypt"));var a=!1;n.onNew=function(e,t){y.assertEqual(r,t.item),y.assertEqual("cities",t.attribute),y.assertTrue(void 0===t.oldValue),y.assertTrue(t.newValue===e),a=!0},n.onSet=function(e,t,r,a){y.assertTrue(!1)};n.newItem({name:"Cairo",abbr:"Cairo"},{parent:r,attribute:"cities"});y.assertTrue(a),n.fetch({query:{name:"Cairo"},onComplete:function(e,t){y.assertEqual(0,e.length),n.fetch({query:{name:"Cairo"},onComplete:function(e,t){y.assertEqual(1,e.length);var r=e[0];y.assertEqual("Cairo",n.getValue(r,"name")),i.callback(!0)},onError:o,queryOptions:{deep:!0}})},onError:o})},onError:o}),i},function(){var i=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),o=new y.Deferred;return y.assertTrue(!i.isDirty()),i.fetch({query:{name:"Egypt"},onComplete:function(e,t){y.assertEqual(1,e.length);var r=e[0];y.assertTrue(i.containsValue(r,"name","Egypt")),i.onNew=function(e,t){y.assertEqual(r,t.item),y.assertEqual("cities",t.attribute),y.assertTrue(void 0===t.oldValue),y.assertTrue(t.newValue===e)};var a=i.newItem({name:"Cairo",abbr:"Cairo"},{parent:r,attribute:"cities"});i.onNew=function(e,t){y.assertEqual(r,t.item),y.assertEqual("cities",t.attribute),console.log(t.oldValue),y.assertTrue(t.oldValue==a),y.assertTrue(t.newValue[0]==a),y.assertTrue(t.newValue[1]==e)};var n=i.newItem({name:"Banha",abbr:"Banha"},{parent:r,attribute:"cities"});i.onNew=function(e,t){y.assertEqual(r,t.item),y.assertEqual("cities",t.attribute),y.assertTrue(t.oldValue[0]==a),y.assertTrue(t.oldValue[1]==n),y.assertTrue(t.newValue[0]==a),y.assertTrue(t.newValue[1]==n),y.assertTrue(t.newValue[2]==e)},i.newItem({name:"Damanhur",abbr:"Damanhur"},{parent:r,attribute:"cities"}),o.callback(!0)},onError:function(e,t){o.errback(e)}}),o},function(){function a(e,t){i.errback(e)}var n=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),i=new y.Deferred;return n.fetch({query:{name:"Egypt"},onComplete:function(e,t){y.assertEqual(1,e.length);var r=e[0];y.assertTrue(n.containsValue(r,"name","Egypt")),y.assertTrue(!1===n.isDirty(r)),y.assertTrue(!n.isDirty()),n.deleteItem(r),y.assertTrue(n.isDirty(r)),y.assertTrue(n.isDirty());n.fetch({query:{name:"Egypt"},onComplete:function(e,t){y.assertEqual(0,e.length),i.callback(!0)},onError:a})},onError:a}),i},function(){var a=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),n=new y.Deferred;return a.fetch({query:{name:"Egypt"},onComplete:function(e,t){y.assertEqual(1,e.length);var r=e[0];y.assertTrue(a.containsValue(r,"name","Egypt")),a.setValue(r,"name","Egypt 2"),y.assertTrue("Egypt 2"==a.getValue(r,"name")),y.assertTrue(a.isDirty(r)),n.callback(!0)},onError:function(e,t){n.errback(e)}}),n},function(){function a(e,t){i.errback(e)}var n=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),i=new y.Deferred;return n.fetch({query:{name:"Egypt"},onComplete:function(e,t){y.assertEqual(1,e.length);var r=e[0];y.assertTrue(n.containsValue(r,"name","Egypt")),y.assertTrue(!1===n.isDirty(r)),y.assertTrue(!n.isDirty()),n.setValue(r,"name","Egypt 2"),y.assertTrue("Egypt 2"==n.getValue(r,"name")),y.assertTrue(n.isDirty(r)),y.assertTrue(n.isDirty()),n.revert();n.fetch({query:{name:"Egypt"},onComplete:function(e,t){y.assertEqual(1,e.length);var r=e[0];y.assertTrue(n.containsValue(r,"name","Egypt")),i.callback(!0)},onError:a})},onError:a}),i},function(){var t=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),r=new y.Deferred;function a(e){r.errback(e)}return t.fetchItemByIdentity({identity:"eg",onItem:function(e){t.setValue(e,"capital","New Cairo"),t.save({onComplete:function(){r.callback(!0)},onError:a})},onError:a}),r},function(){var t=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),r=new y.Deferred;function a(e){r.errback(e)}return t.fetchItemByIdentity({identity:"eg",onItem:function(e){t.setValue(e,"capital","New Cairo"),t.save({onComplete:function(){y.assertTrue(!t._saveInProgress),r.callback(!0)},onError:a})},onError:a}),r},function(){function i(e){t.errback(e)}var o,s=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),t=new y.Deferred;s._saveEverything=function(e,t,r){var a=d.fromJson(r);y.assertEqual(a.identifier,s.getIdentityAttributes(o)[0]),y.assertEqual(a.label,s.getLabelAttributes(o)[0]),y.assertEqual(a.items.length,7);var n=new d.data.ItemFileWriteStore({data:a});n.fetchItemByIdentity({identity:"eg",onItem:function(e){var t=e;y.assertEqual(s.getIdentityAttributes(o)[0],n.getIdentityAttributes(t)[0]),y.assertEqual(s.getLabelAttributes(o)[0],n.getLabelAttributes(t)[0]),y.assertEqual(s.getValue(o,"name"),n.getValue(t,"name"))},onError:i}),e()};return s.fetchItemByIdentity({identity:"eg",onItem:function(e){o=e;s.setValue(o,"capital","New Cairo"),s.save({onComplete:function(){t.callback(!0)},onError:i})},onError:i}),t},function(){var i,o=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("geography_hierarchy_small"));o.hierarchical=!1;function s(e){r.errback(e)}var r=new y.Deferred;o._saveEverything=function(e,t,r){var a=d.fromJson(r);y.assertEqual(a.items.length,3);var n=new d.data.ItemFileWriteStore({data:a,hierarchical:!1});n.fetch({query:{name:"Africa"},onComplete:function(e,t){var r=e[0];y.assertEqual(o.getValue(i,"name"),n.getValue(r,"name"))},onError:s,queryOptions:{deep:!0}}),e()};return o.fetch({query:{name:"Africa"},onComplete:function(e,t){i=e[0];o.setValue(i,"size","HUGE!"),o.save({onComplete:function(){r.callback(!0)},onError:s})},onError:s,queryOptions:{deep:!0}}),r},function(){var t=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),i=new y.Deferred;t._saveEverything=function(r,a,e){var t=d.fromJson(e),n=new d.data.ItemFileWriteStore({data:t});n.fetchItemByIdentity({identity:"eg",onItem:function(e){var t=n.getValue(e,"independence");y.assertTrue(t instanceof Date),y.assertTrue(0===d.date.compare(new Date(1993,4,24),t,"date")),r()},onError:function(e,t){i.errback(e),a()}})};function r(e){i.errback(e)}return t.fetchItemByIdentity({identity:"eg",onItem:function(e){t.setValue(e,"independence",new Date(1993,4,24)),t.save({onComplete:function(){i.callback(!0)},onError:r})},onError:r}),i},function(){var o={Color:d.Color},e=new d.data.ItemFileWriteStore({data:{identifier:"name",items:[{name:"Kermit",species:"frog",color:{_type:"Color",_value:"green"}},{name:"Beaker",hairColor:{_type:"Color",_value:"red"}}]},typeMap:o}),t=new y.Deferred;e._saveEverything=function(r,a,e){var t=d.fromJson(e),n=new d.data.ItemFileWriteStore({data:t,typeMap:o}),i=new y.Deferred;n.fetchItemByIdentity({identity:"Animal",onItem:function(e){var t=n.getValue(e,"hairColor");y.assertTrue(t instanceof d.Color),y.assertEqual("rgba(255, 255, 0, 1)",t.toString()),r()},onError:function(e,t){i.errback(e),a()}})};e.newItem({name:"Animal",hairColor:new d.Color("yellow")});return e.save({onComplete:function(){t.callback(!0)},onError:function(e){t.errback(e)}}),t},function(){var i={Color:{type:d.Color,deserialize:function(e){return new d.Color(e)},serialize:function(e){return e.toString()}}},e=new d.data.ItemFileWriteStore({data:{identifier:"name",items:[{name:"Kermit",species:"frog",color:{_type:"Color",_value:"green"}},{name:"Beaker",hairColor:{_type:"Color",_value:"red"}}]},typeMap:i}),o=new y.Deferred;e._saveEverything=function(r,a,e){var t=d.fromJson(e),n=new d.data.ItemFileWriteStore({data:t,typeMap:i});n.fetchItemByIdentity({identity:"Animal",onItem:function(e){var t=n.getValue(e,"hairColor");y.assertTrue(t instanceof d.Color),y.assertEqual("rgba(255, 255, 0, 1)",t.toString()),r()},onError:function(e,t){o.errback(e),a()}})};e.newItem({name:"Animal",hairColor:new d.Color("yellow")});return e.save({onComplete:function(){o.callback(!0)},onError:function(e){o.errback(e)}}),o},function(){var e=new d.data.ItemFileWriteStore({data:{label:"name",items:[{name:"Ecuador",capital:"Quito"},{name:"Egypt",capital:"Cairo"},{name:"El Salvador",capital:"San Salvador"},{name:"Equatorial Guinea",capital:"Malabo"},{name:"Eritrea",capital:"Asmara"},{name:"Estonia",capital:"Tallinn"},{name:"Ethiopia",capital:"Addis Ababa"}]}}),t=e.newItem({name:"Utopia",capitol:"Perfect"}),r=t[e._itemNumPropName];y.assertTrue(e._arrayOfAllItems[r]===t),e.revert(),y.assertTrue(null===e._arrayOfAllItems[r])},function(){var n=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),i=new y.Deferred;y.assertTrue(!n.isDirty());function o(e,t){i.errback(e)}return n.fetch({onComplete:function(e,t){var a=e.length,r=n.newItem({name:"Canada",abbr:"ca",capital:"Ottawa"});n.setValue(r,"someattribute","modified a new item!");n.fetch({onComplete:function(e,t){var r=e.length;y.assertEqual(r,a+1),n.revert();n.fetch({onComplete:function(e,t){var r=e.length;y.assertEqual(r,a),i.callback(!0)},onError:o})},onError:o})},onError:o}),i},function(){var i,o=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),s=!1,l=new y.Deferred;y.assertTrue(!o.isDirty());function u(e,t){l.errback(e)}return o.fetch({onComplete:function(e,t){var a=e.length,n=o.newItem({name:"Canada",abbr:"ca",capital:"Ottawa"});o.setValue(n,"someattribute","modified a new item!");o.fetch({onComplete:function(e,t){var r=e.length;y.assertEqual(r,a+1),o.deleteItem(n);o.fetch({onComplete:function(e,t){var r=e.length;for(y.assertEqual(a,r),i=0;i<e.length&&!(s="ca"===o.getIdentity(e[i]));i++);if(s)l.errback(new Error("Error: Found the supposedly deleted item!"));else{o.revert();o.fetch({onComplete:function(e,t){var r=e.length;for(y.assertEqual(r,a),i=0;i<e.length&&!(s="ca"===o.getIdentity(e[i]));i++);s?l.errback(new Error("Error: Found the 'new' item after revert!")):l.callback(!0)},onError:u})}},onError:u})},onError:u})},onError:u}),l},function(){var o=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),s=new y.Deferred;o.fetchItemByIdentity({identity:"eg",onItem:function(e){var n=e,i=null;i=d.connect(o,"onSet",function(e,t,r,a){y.assertTrue(o.isItem(e)),y.assertTrue(e==n),y.assertTrue("capital"==t),y.assertTrue("Cairo"==r),y.assertTrue("New Cairo"==a),s.callback(!0),d.disconnect(i)}),o.setValue(n,"capital","New Cairo")},onError:function(e){s.errback(e)}})},function(){var t=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),r=new y.Deferred,a=null;a=d.connect(t,"onNew",function(e){y.assertTrue(t.isItem(e)),y.assertTrue("Canada"==t.getValue(e,"name")),r.callback(!0),d.disconnect(a)});t.newItem({name:"Canada",abbr:"ca",capital:"Ottawa"})},function(){var a=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),n=new y.Deferred;a.fetchItemByIdentity({identity:"eg",onItem:function(e){var t=e,r=null;r=d.connect(a,"onDelete",function(e){y.assertTrue(!1===a.isItem(e)),y.assertTrue(e==t),n.callback(!0),d.disconnect(r)}),a.deleteItem(t)},onError:function(e){n.errback(e)}})},function(){var e=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),t=new d.data.api.Read,r=!0;for(var a in t){if("function"==typeof t[a])if("function"!=typeof e[a]){r=!1;break}}y.assertTrue(r)},function(){var e=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),t=new d.data.api.Write,r=!0;for(var a in t){if("function"==typeof t[a])if("function"!=typeof e[a]){r=!1;break}}y.assertTrue(r)},function(){var e=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),t=new d.data.api.Notification,r=!0;for(var a in t){if("function"==typeof t[a])if("function"!=typeof e[a]){r=!1;break}}y.assertTrue(r)},function(){function a(e,t){s.errback(e)}var o=new d.data.ItemFileWriteStore({data:{label:"name",items:[{name:"Ecuador",capital:"Quito"},{name:"Egypt",capital:"Cairo"},{name:"El Salvador",capital:"San Salvador"},{name:"Equatorial Guinea",capital:"Malabo"},{name:"Eritrea",capital:"Asmara"},{name:"Estonia",capital:"Tallinn"},{name:"Ethiopia",capital:"Addis Ababa"}]}}),s=new y.Deferred;return o.fetch({onComplete:function(e,t){y.assertEqual(7,e.length);var r=e[e.length-1];o.getIdentity(r);o.deleteItem(r),o.newItem({name:"Canada",capital:"Ottawa"});o.fetch({onComplete:function(e,t){y.assertEqual(7,e.length);for(var r={},a=0;a<e.length;++a){var n=e[a],i=o.getIdentity(n);r.hasOwnProperty(i)?y.assertTrue(!1):r[i]=n}s.callback(!0)},onError:a})},onError:a}),s},function(){function o(e,t){l.errback(e)}var s=new d.data.ItemFileWriteStore({data:{label:"name",items:[{name:"Ecuador",capital:"Quito"},{name:"Egypt",capital:"Cairo"},{name:"El Salvador",capital:"San Salvador"},{name:"Equatorial Guinea",capital:"Malabo"},{name:"Eritrea",capital:"Asmara"},{name:"Estonia",capital:"Tallinn"},{name:"Ethiopia",capital:"Addis Ababa"}]}}),l=new y.Deferred;return s.fetch({onComplete:function(e,t){y.assertEqual(7,e.length);var r=e[e.length-1];s.getIdentity(r);s.deleteItem(r),s.newItem({name:"Canada",capital:"Ottawa"});s.fetch({onComplete:function(e,t){y.assertEqual(7,e.length);for(var r={},a=0;a<e.length;++a){var n=e[a],i=s.getIdentity(n);r.hasOwnProperty(i)?y.assertTrue(!1):r[i]=n}s.revert();s.fetch({onComplete:function(e,t){y.assertEqual(7,e.length),l.callback(!0)},onError:o})},onError:o})},onError:o}),l},function(){var c=new d.data.ItemFileWriteStore(tests.data.ItemFileWriteStore.getTestData("reference_integrity")),m=new y.Deferred;return c.fetch({onError:function(e,t){m.errback(e)},onComplete:function(e,t){var r,a=null,n=null,i=null,o=null;for(r=0;r<e.length;r++){var s=c.getIdentity(e[r]);10===s?a=e[r]:1===s?n=e[r]:3===s?i=e[r]:5===s&&(o=e[r])}var l=c.getValues(a,"friends");y.assertTrue(null!==l),y.assertTrue(void 0!==l),y.assertTrue(c.isItem(a)),y.assertTrue(c.isItem(n)),y.assertTrue(c.isItem(i)),y.assertTrue(c.isItem(o));var u=0;try{for(r=0;r<l.length;r++)0===r?(y.assertTrue(c.isItem(l[r])),y.assertEqual(l[r],n),y.assertEqual(c.getIdentity(l[r]),1),u++):1===r?(y.assertTrue(c.isItem(l[r])),y.assertEqual(l[r],i),y.assertEqual(c.getIdentity(l[r]),3),u++):2===r&&(y.assertTrue(c.isItem(l[r])),y.assertEqual(l[r],o),y.assertEqual(c.getIdentity(l[r]),5),u++)}catch(e){y.errback(e)}y.assertEqual(3,u),m.callback(!0)}}),m},function(){var m=new d.data.ItemFileWriteStore(tests.data.ItemFileWriteStore.getTestData("reference_integrity")),f=new y.Deferred;function r(e,t){f.errback(e)}return m.fetchItemByIdentity({identity:10,onError:r,onItem:function(e,t){try{console.log("Before delete map state is: "+d.toJson(e[m._reverseRefMap])),m.deleteItem(e),console.log("After delete map state is: "+d.toJson(e[m._reverseRefMap])),m.fetch({onComplete:function(e,t){for(var r=!0,a=0;a<e.length;a++)for(var n=e[a],i=m.getAttributes(n),o=0;o<i.length;o++){for(var s=m.getValues(n,i[o]),l=!1,u=0;u<s.length;u++){var c=s[u];try{if(10==m.getIdentity(c)){l=!0;break}}catch(e){}}if(l){f.errback(new Error("Found a reference remaining to a deleted item.  Failure.")),r=!1;break}}r&&f.callback(!0)},onError:r})}catch(e){f.errback(e)}}}),f},function(){var n=new d.data.ItemFileWriteStore(tests.data.ItemFileWriteStore.getTestData("reference_integrity")),i=new y.Deferred,o=!0;return n.fetchItemByIdentity({identity:10,onError:function(e,t){i.errback(e)},onItem:function(e,t){try{console.log("Map before delete:"),n._dumpReferenceMap();var r=d.toJson(e[n._reverseRefMap]);n.deleteItem(e),console.log("Map after delete:"),n._dumpReferenceMap();d.toJson(e[n._reverseRefMap]);n.revert(),console.log("Map after revert:"),n._dumpReferenceMap();var a=d.toJson(e[n._reverseRefMap]);y.assertTrue(a===r)}catch(e){i.errback(e),o=!1}o&&i.callback(!0)}}),i},function(){var n=new d.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries_references")),i=new y.Deferred;function o(e,t){i.errback(e),y.assertTrue(!1)}return n.fetchItemByIdentity({identity:"Egypt",onError:o,onItem:function(e,t){y.assertTrue(n.isItem(e));var a=e;n.fetchItemByIdentity({identity:"Nairobi",onError:o,onItem:function(e,t){y.assertTrue(n.isItem(e));var r=e;n.deleteItem(a),n.deleteItem(r);try{n.revert(),n.fetch({query:{name:"*"},start:0,count:20,onComplete:function(e,t){i.callback(!0)},onError:o})}catch(e){i.errback(e)}}})}}),i},function(){var n=new d.data.ItemFileWriteStore(tests.data.ItemFileWriteStore.getTestData("reference_integrity")),i=new y.Deferred;function t(e,t){i.errback(e),y.assertTrue(!1)}return n.fetchItemByIdentity({identity:11,onError:t,onItem:function(a,e){try{n.setValues(a,"friends",[null]),n.fetchItemByIdentity({identity:10,onError:t,onItem:function(e,t){var r=e[n._reverseRefMap];n._dumpReferenceMap(),console.log("MAP for Item 10 is: "+d.toJson(r)),y.assertTrue(!r[11].friends),n.setValues(a,"siblings",[0,1,2]),y.assertTrue(!r[11]),i.callback(!0)}})}catch(e){console.debug(e),i.errback(e),y.assertTrue(!1)}}}),i},function(){var m=new d.data.ItemFileWriteStore(tests.data.ItemFileWriteStore.getTestData("reference_integrity")),f=new y.Deferred;function r(e,t){f.errback(e)}return m.fetchItemByIdentity({identity:16,onError:r,onItem:function(e,t){try{console.log("Reference state for item 16 is: "+d.toJson(e[m._reverseRefMap])),m.deleteItem(e),m.fetch({onComplete:function(e,t){for(var r=!0,a=0;a<e.length;a++)for(var n=e[a],i=m.getAttributes(n),o=0;o<i.length;o++){for(var s=m.getValues(n,i[o]),l=!1,u=0;u<s.length;u++){var c=s[u];try{if(16==m.getIdentity(c)){l=!0;break}}catch(e){}}if(l){f.errback(new Error("Found a reference remaining to a deleted item.  Failure.")),r=!1;break}}r&&f.callback(!0)},onError:r})}catch(e){f.errback(e)}}}),f},function(){var n=new d.data.ItemFileWriteStore(tests.data.ItemFileWriteStore.getTestData("reference_integrity")),i=new y.Deferred;return n.fetch({onError:function(e,t){i.errback(e),y.assertTrue(!1)},onComplete:function(e,t){y.assertTrue(2<e.length);var r=e[0],a=e[1];console.log("Map state for Item 1 is: "+d.toJson(r[n._reverseRefMap])),console.log("Map state for Item 2 is: "+d.toJson(a[n._reverseRefMap])),n.setValue(r,"siblings",a),console.log("Map state for Item 1 is: "+d.toJson(r[n._reverseRefMap])),console.log("Map state for Item 2 is: "+d.toJson(a[n._reverseRefMap])),y.assertTrue(null!==a[n._reverseRefMap]),y.assertTrue(a[n._reverseRefMap][n.getIdentity(r)].siblings),i.callback(!0)}}),i},function(){var a=new d.data.ItemFileWriteStore(tests.data.ItemFileWriteStore.getTestData("reference_integrity")),n=new y.Deferred,i=!0;return a.fetchItemByIdentity({identity:10,onError:function(e,t){n.errback(e),y.assertTrue(!1)},onItem:function(e,t){try{var r=a.newItem({id:17,name:"Item 17"},{parent:e,attribute:"uncles"})[a._reverseRefMap];y.assertTrue(r[10].uncles),console.log("State of map of item 17 after newItem: "+d.toJson(r))}catch(e){console.debug(e),n.errback(e),y.assertTrue(!1),i=!1}i&&n.callback(!0)}}),n},function(){var a=new d.data.ItemFileWriteStore(tests.data.ItemFileWriteStore.getTestData("reference_integrity")),n=new y.Deferred,i=!0;return a.fetchItemByIdentity({identity:10,onError:function(e,t){n.errback(e),y.assertTrue(!1)},onItem:function(e,t){try{console.log("State of reference map to item 10 before newItem: "+d.toJson(e[a._reverseRefMap]));a.newItem({id:17,name:"Item 17",friends:[e]});var r=e[a._reverseRefMap];y.assertTrue(r[17].friends),console.log("State of reference map to item 10 after newItem: "+d.toJson(r))}catch(e){console.debug(e),n.errback(e),y.assertTrue(!1),i=!1}i&&n.callback(!0)}}),n},function(){var e=tests.data.ItemFileWriteStore.getTestData("reference_integrity");e.referenceIntegrity=!1;var r=new d.data.ItemFileWriteStore(e),a=new y.Deferred;return r.fetchItemByIdentity({identity:10,onError:function(e,t){a.errback(e),y.assertTrue(!1)},onItem:function(e,t){void 0===e[r._reverseRefMap]?a.callback(!0):a.errback(new Error("Disabling of reference integrity failed."))}}),a},function(){if(d.isBrowser){var e=tests.data.readOnlyItemFileTestTemplates.getTestData("countries");e.clearOnClose=!0,e.urlPreventCache=!0;var n=new d.data.ItemFileWriteStore(e),i=new y.Deferred;return n.fetchItemByIdentity({identity:"ec",onItem:function(e){var t=null;try{y.assertTrue(null!==e);var r=e,a=n.getValue(r,"name");y.assertEqual("Ecuador",a);n.newItem({abbr:"foo",name:"bar"});n.close()}catch(e){t=e}null===t?i.errback(new Error("Store was dirty, should have thrown an error on close!")):i.callback(!0)},onError:function(e){i.errback(e)}}),i}}])});