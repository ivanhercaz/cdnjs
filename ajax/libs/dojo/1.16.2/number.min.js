define(["./_base/lang","./i18n","./i18n!./cldr/nls/number","./string","./regexp"],function(i,p,e,v,u){var b={};if(i.setObject("dojo.number",b),b.format=function(e,r){r=i.mixin({},r||{});var n=p.normalizeLocale(r.locale),a=p.getLocalization("dojo.cldr","number",n);r.customs=a;var t=r.pattern||a[(r.type||"decimal")+"Format"];return isNaN(e)||Math.abs(e)==1/0?null:b._applyPattern(e,t,r)},b._numberPatternRE=/[#0,]*[#0](?:\.0*#*)?/,b._applyPattern=function(e,r,l){var n=(l=l||{}).customs.group,a=l.customs.decimal,t=r.split(";"),i=t[0];if(-1!=(r=t[e<0?1:0]||"-"+i).indexOf("%"))e*=100;else if(-1!=r.indexOf("‰"))e*=1e3;else if(-1!=r.indexOf("¤"))n=l.customs.currencyGroup||n,a=l.customs.currencyDecimal||a,r=r.replace(/([\s\xa0]*)(\u00a4{1,3})([\s\xa0]*)/,function(e,r,n,a){var t=["symbol","currency","displayName"][n.length-1],i=l[t]||l.currency||"";return i?r+i+a:""});else if(-1!=r.indexOf("E"))throw new Error("exponential notation not supported");var o=b._numberPatternRE,c=i.match(o);if(!c)throw new Error("unable to find a number expression in pattern: "+r);return!1===l.fractional&&(l.places=0),r.replace(o,b._formatAbsolute(e,c[0],{decimal:a,group:n,places:l.places,round:l.round}))},b.round=function(e,r,n){var a=10/(n||10);return(a*e).toFixed(r)/a},0==.9.toFixed()){var l=b.round;b.round=function(e,r,n){var a=Math.pow(10,-r||0),t=Math.abs(e);return!e||a<=t?a=0:((t/=a)<.5||.95<=t)&&(a=0),l(e,r,n)+(0<e?a:-a)}}return b._formatAbsolute=function(e,r,n){!0===(n=n||{}).places&&(n.places=0),n.places===1/0&&(n.places=6);var a=r.split("."),t="string"==typeof n.places&&n.places.indexOf(","),i=n.places;t?i=n.places.substring(t+1):0<=i||(i=(a[1]||[]).length),n.round<0||(e=b.round(e,i,n.round));var l=String(Math.abs(e)).split("."),o=l[1]||"";if(a[1]||n.places){t&&(n.places=n.places.substring(0,t));var c=void 0!==n.places?n.places:a[1]&&a[1].lastIndexOf("0")+1;c>o.length&&(l[1]=v.pad(o,c,"0",!0)),i<o.length&&(l[1]=o.substr(0,i))}else l[1]&&l.pop();var s=a[0].replace(",","");-1!=(c=s.indexOf("0"))&&((c=s.length-c)>l[0].length&&(l[0]=v.pad(l[0],c)),-1==s.indexOf("#")&&(l[0]=l[0].substr(l[0].length-c)));var p,u,d=a[0].lastIndexOf(",");if(-1!=d){p=a[0].length-d-1;var f=a[0].substr(0,d);-1!=(d=f.lastIndexOf(","))&&(u=f.length-d-1)}for(var g=[],x=l[0];x;){var m=x.length-p;g.push(0<m?x.substr(m):x),x=0<m?x.slice(0,m):"",u&&(p=u,u=void 0)}return l[0]=g.reverse().join(n.group||","),l.join(n.decimal||".")},b.regexp=function(e){return b._parseInfo(e).regexp},b._parseInfo=function(l){l=l||{};var e=p.normalizeLocale(l.locale),r=p.getLocalization("dojo.cldr","number",e),n=l.pattern||r[(l.type||"decimal")+"Format"],i=r.group,o=r.decimal,c=1;if(-1!=n.indexOf("%"))c/=100;else if(-1!=n.indexOf("‰"))c/=1e3;else{var a=-1!=n.indexOf("¤");a&&(i=r.currencyGroup||i,o=r.currencyDecimal||o)}var t=n.split(";");1==t.length&&t.push("-"+t[0]);var s=u.buildGroupRE(t,function(e){return(e="(?:"+u.escapeString(e,".")+")").replace(b._numberPatternRE,function(e){var r={signed:!1,separator:l.strict?i:[i,""],fractional:l.fractional,decimal:o,exponent:!1},n=e.split("."),a=l.places;1==n.length&&1!=c&&(n[1]="###"),1==n.length||0===a?r.fractional=!1:(void 0===a&&(a=l.pattern?n[1].lastIndexOf("0")+1:1/0),a&&null==l.fractional&&(r.fractional=!0),!l.places&&a<n[1].length&&(a+=","+n[1].length),r.places=a);var t=n[0].split(",");return 1<t.length&&(r.groupSize=t.pop().length,1<t.length&&(r.groupSize2=t.pop().length)),"("+b._realNumberRegexp(r)+")"})},!0);return a&&(s=s.replace(/([\s\xa0]*)(\u00a4{1,3})([\s\xa0]*)/g,function(e,r,n,a){var t=["symbol","currency","displayName"][n.length-1],i=u.escapeString(l[t]||l.currency||"");return i?(r=r?"[\\s\\xa0]":"",a=a?"[\\s\\xa0]":"",l.strict?r+i+a:(r&&(r+="*"),a&&(a+="*"),"(?:"+r+i+a+")?")):""})),{regexp:s.replace(/[\xa0 ]/g,"[\\s\\xa0]"),group:i,decimal:o,factor:c}},b.parse=function(e,r){var n=b._parseInfo(r),a=new RegExp("^"+n.regexp+"$").exec(e);if(!a)return NaN;var t=a[1];if(!a[1]){if(!a[2])return NaN;t=a[2],n.factor*=-1}return(t=t.replace(new RegExp("["+n.group+"\\s\\xa0]","g"),"").replace(n.decimal,"."))*n.factor},b._realNumberRegexp=function(n){"places"in(n=n||{})||(n.places=1/0),"string"!=typeof n.decimal&&(n.decimal="."),"fractional"in n&&!/^0/.test(n.places)||(n.fractional=[!0,!1]),"exponent"in n||(n.exponent=[!0,!1]),"eSigned"in n||(n.eSigned=[!0,!1]);var e=b._integerRegexp(n),r=u.buildGroupRE(n.fractional,function(e){var r="";return e&&0!==n.places&&(r="\\"+n.decimal,n.places==1/0?r="(?:"+r+"\\d+)?":r+="\\d{"+n.places+"}"),r},!0),a=e+r;return r&&(a="(?:(?:"+a+")|(?:"+r+"))"),a+u.buildGroupRE(n.exponent,function(e){return e?"([eE]"+b._integerRegexp({signed:n.eSigned})+")":""})},b._integerRegexp=function(t){return"signed"in(t=t||{})||(t.signed=[!0,!1]),"separator"in t?"groupSize"in t||(t.groupSize=3):t.separator="",u.buildGroupRE(t.signed,function(e){return e?"[-+]":""},!0)+u.buildGroupRE(t.separator,function(e){if(!e)return"(?:\\d+)";" "==(e=u.escapeString(e))?e="\\s":" "==e&&(e="\\s\\xa0");var r=t.groupSize,n=t.groupSize2;if(n){var a="(?:0|[1-9]\\d{0,"+(n-1)+"}(?:["+e+"]\\d{"+n+"})*["+e+"]\\d{"+r+"})";return 0<r-n?"(?:"+a+"|(?:0|[1-9]\\d{0,"+(r-1)+"}))":a}return"(?:0|[1-9]\\d{0,"+(r-1)+"}(?:["+e+"]\\d{"+r+"})*)"},!0)},b});