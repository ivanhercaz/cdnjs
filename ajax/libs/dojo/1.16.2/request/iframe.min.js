define(["module","require","./watch","./util","./handlers","../_base/lang","../io-query","../query","../has","../dom","../dom-construct","../_base/window","../NodeList-dom","../NodeList-manipulate"],function(e,n,a,b,i,y,x,N,l,T,j,A){var w=e.id.replace(/[\/\.\-]/g,"_"),d=w+"_onload";function u(e){return!this.isFulfilled()}function s(e){return!!this._finished}function m(e,t){if(!t)try{var o=e.options,r=q.doc(q._frame),n=o.handleAs;if("html"!==n){if("xml"===n)if("html"===r.documentElement.tagName.toLowerCase()){N("a",r.documentElement).orphan();var a=r.documentElement.innerText||r.documentElement.textContent;a=a.replace(/>\s+</g,"><"),e.text=y.trim(a)}else e.data=r;else e.text=r.getElementsByTagName("textarea")[0].value;i(e)}else e.data=r}catch(e){t=e}t?this.reject(t):this._finished?this.resolve(e):this.reject(new Error("Invalid dojo/request/iframe request state"))}function c(e){this._callNext()}A.global[d]||(A.global[d]=function(){var e=q._currentDfd;if(e){var t=e.response.options,o=T.byId(t.form)||e._tmpForm;if(o){for(var r=e._contentToClean,n=0;n<r.length;n++)for(var a=r[n],i=0;i<o.childNodes.length;i++){var l=o.childNodes[i];if(l.name===a){j.destroy(l);break}}e._originalAction&&o.setAttribute("action",e._originalAction),e._originalMethod&&(o.setAttribute("method",e._originalMethod),o.method=e._originalMethod),e._originalTarget&&(o.setAttribute("target",e._originalTarget),o.target=e._originalTarget)}e._tmpForm&&(j.destroy(e._tmpForm),delete e._tmpForm),e._finished=!0}else q._fireNextRequest()});var f={method:"POST"};function q(e,t,o){var r=b.parseArgs(e,b.deepCreate(f,t),!0);if(e=r.url,"GET"!==(t=r.options).method&&"POST"!==t.method)throw new Error(t.method+" not supported by dojo/request/iframe");q._frame||(q._frame=q.create(q._iframeName,d+"();"));var n=b.deferred(r,null,u,s,m,c);return n._callNext=function(){this._calledNext||(this._calledNext=!0,q._currentDfd=null,q._fireNextRequest())},n._legacy=o,q._dfdQueue.push(n),q._fireNextRequest(),a(n),o?n:n.promise}return q.create=function(e,t,o){if(A.global[e])return A.global[e];if(A.global.frames[e])return A.global.frames[e];o||(l("config-useXDomain")&&!l("config-dojoBlankHtmlUrl")&&console.warn("dojo/request/iframe: When using cross-domain Dojo builds, please save dojo/resources/blank.html to your domain and set dojoConfig.dojoBlankHtmlUrl to the path on your domain to blank.html"),o=l("config-dojoBlankHtmlUrl")||n.toUrl("dojo/resources/blank.html"));var r=j.place('<iframe id="'+e+'" name="'+e+'" src="'+o+'" onload="'+t+'" style="position: absolute; left: 1px; top: 1px; height: 1px; width: 1px; visibility: hidden">',A.body());return A.global[e]=r},q.doc=function(e){if(e.contentDocument)return e.contentDocument;var t=e.name;if(t){var o=A.doc.getElementsByTagName("iframe");if(e.document&&o[t].contentWindow&&o[t].contentWindow.document)return o[t].contentWindow.document;if(A.doc.frames[t]&&A.doc.frames[t].document)return A.doc.frames[t].document}return null},q.setSrc=function(e,t,o){var r=A.global.frames[e.name];r.contentWindow&&(r=r.contentWindow);try{o?r.location.replace(t):r.location=t}catch(e){console.log("dojo/request/iframe.setSrc: ",e)}},q._iframeName=w+"_IoIframe",q._notifyStart=function(){},q._dfdQueue=[],q._currentDfd=null,q._fireNextRequest=function(){var t;try{if(q._currentDfd||!q._dfdQueue.length)return;for(;(t=q._currentDfd=q._dfdQueue.shift())&&(t.canceled||t.isCanceled&&t.isCanceled())&&q._dfdQueue.length;);if(!t||t.canceled||t.isCanceled&&t.isCanceled())return void(q._currentDfd=null);var e,o=t.response,r=o.options,n=t._contentToClean=[],a=T.byId(r.form),i=b.notify,l=r.data||null;if(t._legacy||"POST"!==r.method||a?"GET"===r.method&&a&&-1<o.url.indexOf("?")&&(e=o.url.slice(o.url.indexOf("?")+1),l=y.mixin(x.queryToObject(e),l)):a=t._tmpForm=j.create("form",{name:w+"_form",style:{position:"absolute",top:"-1000px",left:"-1000px"}},A.body()),a){if(!t._legacy){for(var d=a;(d=d.parentNode)&&d!==A.doc.documentElement;);d||(a.style.position="absolute",a.style.left="-1000px",a.style.top="-1000px",A.body().appendChild(a)),a.name||(a.name=w+"_form")}if(l){function u(e,t){j.create("input",{type:"hidden",name:e,value:t},a),n.push(e)}for(var s in l){var m=l[s];if(y.isArray(m)&&1<m.length)for(var c=0;c<m.length;c++)u(s,m[c]);else{var f=N("input[name='"+s+"']",a);-1==f.indexOf()?u(s,m):f.val(m)}}}var h=a.getAttributeNode("action"),_=a.getAttributeNode("method"),g=a.getAttributeNode("target");o.url&&(t._originalAction=h?h.value:null,h?h.value=o.url:a.setAttribute("action",o.url)),t._legacy?_&&_.value||(_?_.value=r.method:a.setAttribute("method",r.method)):(t._originalMethod=_?_.value:null,_?_.value=r.method:a.setAttribute("method",r.method)),t._originalTarget=g?g.value:null,g?g.value=q._iframeName:a.setAttribute("target",q._iframeName),a.target=q._iframeName,i&&i.emit("send",o,t.promise.cancel),q._notifyStart(o),a.submit()}else{var p="";o.options.data&&"string"!=typeof(p=o.options.data)&&(p=x.objectToQuery(p));var v=o.url+(-1<o.url.indexOf("?")?"&":"?")+p;i&&i.emit("send",o,t.promise.cancel),q._notifyStart(o),q.setSrc(q._frame,v,!0)}}catch(e){t.reject(e)}},b.addCommonMethods(q,["GET","POST"]),q});