define(["./util","../errors/RequestTimeoutError","../errors/CancelError","../_base/array","../has!host-browser?../_base/window:","../has!host-browser?dom-addeventlistener?:../on:"],function(e,s,n,t,o,i){var l=null,a=[];function c(){for(var e,n=+new Date,t=0;t<a.length&&(e=a[t]);t++){var o=e.response,i=o.options;e.isCanceled&&e.isCanceled()||e.isValid&&!e.isValid(o)?(a.splice(t--,1),r._onAction&&r._onAction()):e.isReady&&e.isReady(o)?(a.splice(t--,1),e.handleResponse(o),r._onAction&&r._onAction()):e.startTime&&e.startTime+(i.timeout||0)<n&&(a.splice(t--,1),e.cancel(new s("Timeout exceeded",o)),r._onAction&&r._onAction())}r._onInFlight&&r._onInFlight(e),a.length||(clearInterval(l),l=null)}function r(e){e.response.options.timeout&&(e.startTime=+new Date),e.isFulfilled()||(a.push(e),l=l||setInterval(c,50),e.response.options.sync&&c())}return r.cancelAll=function(){try{t.forEach(a,function(e){try{e.cancel(new n("All requests canceled."))}catch(e){}})}catch(e){}},o&&i&&o.doc.attachEvent&&i(o.global,"unload",function(){r.cancelAll()}),r});