define(["../errors/RequestError","./watch","./handlers","./util","../has"],function(h,y,o,b,x){x.add("native-xhr",function(){return"undefined"!=typeof XMLHttpRequest}),x.add("dojo-force-activex-xhr",function(){return x("activex")&&"file:"===window.location.protocol}),x.add("native-xhr2",function(){if(x("native-xhr")&&!x("dojo-force-activex-xhr")){var e=new XMLHttpRequest;return void 0!==e.addEventListener&&("undefined"==typeof opera||void 0!==e.upload)}}),x.add("native-formdata",function(){return"undefined"!=typeof FormData}),x.add("native-blob",function(){return"undefined"!=typeof Blob}),x.add("native-arraybuffer",function(){return"undefined"!=typeof ArrayBuffer}),x.add("native-response-type",function(){return x("native-xhr")&&void 0!==(new XMLHttpRequest).responseType}),x.add("native-xhr2-blob",function(){if(x("native-response-type")){var e=new XMLHttpRequest;e.open("GET","https://dojotoolkit.org/",!0),e.responseType="blob";var t=e.responseType;return e.abort(),"blob"===t}});var w,m,L,T,X={blob:x("native-xhr2-blob")?"blob":"arraybuffer",document:"document",arraybuffer:"arraybuffer"};function H(e,t){var r,n=e.xhr;e.status=e.xhr.status;try{e.text=n.responseText}catch(e){}if("xml"===e.options.handleAs&&(e.data=n.responseXML),t)this.reject(t);else{try{o(e)}catch(e){r=e}b.checkStatus(n.status)?r?this.reject(r):this.resolve(e):(t=new h(r?"Unable to load "+e.url+" status: "+n.status+" and an error in handleAs: transformation of response":"Unable to load "+e.url+" status: "+n.status,e),this.reject(t))}}function M(e){return this.xhr.getResponseHeader(e)}x("native-xhr2")?(w=function(e){return!this.isFulfilled()},T=function(e,t){t.xhr.abort()},L=function(e,n,o,t){function r(e){n.handleResponse(o)}function a(e){var t=e.target,r=new h("Unable to load "+o.url+" status: "+t.status,o);n.handleResponse(o,r)}function s(e,t){o.transferType=e,t.lengthComputable?(o.loaded=t.loaded,o.total=t.total,n.progress(o)):3===o.xhr.readyState&&(o.loaded="loaded"in t?t.loaded:t.position,n.progress(o))}function i(e){return s("download",e)}function d(e){return s("upload",e)}return e.addEventListener("load",r,!1),e.addEventListener("error",a,!1),e.addEventListener("progress",i,!1),t&&e.upload&&e.upload.addEventListener("progress",d,!1),function(){e.removeEventListener("load",r,!1),e.removeEventListener("error",a,!1),e.removeEventListener("progress",i,!1),e.upload.removeEventListener("progress",d,!1),e=null}}):(w=function(e){return e.xhr.readyState},m=function(e){return 4===e.xhr.readyState},T=function(e,t){var r=t.xhr,n=typeof r.abort;"function"!=n&&"object"!=n&&"unknown"!=n||r.abort()});var R,g={data:null,query:null,sync:!1,method:"GET"};function j(e,t,r){var n=x("native-formdata")&&t&&t.data&&t.data instanceof FormData,o=b.parseArgs(e,b.deepCreate(g,t),n);e=o.url;var a=!(t=o.options).data&&"POST"!==t.method&&"PUT"!==t.method;x("ie")<=10&&(e=e.split("#")[0]);var s,i=b.deferred(o,T,w,m,H,function(){s&&s()}),d=o.xhr=j._create();if(!d)return i.cancel(new h("XHR was not created")),r?i:i.promise;o.getHeader=M,L&&(s=L(d,i,o,t.uploadProgress));var u=void 0===t.data?null:t.data,c=!t.sync,f=t.method;try{d.open(f,e,c,t.user||R,t.password||R),t.withCredentials&&(d.withCredentials=t.withCredentials),x("native-response-type")&&t.handleAs in X&&(d.responseType=X[t.handleAs]);var l=t.headers,p=!n&&!a&&"application/x-www-form-urlencoded";if(l)for(var v in l)"content-type"===v.toLowerCase()?p=l[v]:l[v]&&d.setRequestHeader(v,l[v]);p&&!1!==p&&d.setRequestHeader("Content-Type",p),l&&"X-Requested-With"in l||d.setRequestHeader("X-Requested-With","XMLHttpRequest"),b.notify&&b.notify.emit("send",o,i.promise.cancel),d.send(u)}catch(e){i.reject(e)}return y(i),d=null,r?i:i.promise}if(j._create=function(){throw new Error("XMLHTTP not available")},x("native-xhr")&&!x("dojo-force-activex-xhr"))j._create=function(){return new XMLHttpRequest};else if(x("activex"))try{new ActiveXObject("Msxml2.XMLHTTP"),j._create=function(){return new ActiveXObject("Msxml2.XMLHTTP")}}catch(e){try{new ActiveXObject("Microsoft.XMLHTTP"),j._create=function(){return new ActiveXObject("Microsoft.XMLHTTP")}}catch(e){}}return b.addCommonMethods(j),j});