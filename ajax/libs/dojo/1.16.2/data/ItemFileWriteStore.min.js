define(["../_base/lang","../_base/declare","../_base/array","../_base/json","../_base/kernel","./ItemFileReadStore","../date/stamp"],function(I,e,g,_,n,t,i){return e("dojo.data.ItemFileWriteStore",t,{constructor:function(e){this._features["dojo.data.api.Write"]=!0,this._features["dojo.data.api.Notification"]=!0,this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},this._datatypeMap.Date.serialize||(this._datatypeMap.Date.serialize=function(e){return i.toISOString(e,{zulu:!0})}),e&&!1===e.referenceIntegrity&&(this.referenceIntegrity=!1),this._saveInProgress=!1},referenceIntegrity:!0,_assert:function(e){if(!e)throw new Error("assertion failed in ItemFileWriteStore")},_getIdentifierAttribute:function(){return this.getFeatures()["dojo.data.api.Identity"]},newItem:function(e,t){if(this._assert(!this._saveInProgress),this._loadFinished||this._forceLoad(),"object"!=typeof e&&void 0!==e)throw new Error("newItem() was passed something other than an object");var i=null,s=this._getIdentifierAttribute();if(s===Number)i=this._arrayOfAllItems.length;else{if(void 0===(i=e[s]))throw new Error("newItem() was not passed an identity for the new item");if(I.isArray(i))throw new Error("newItem() was not passed an single-valued identity")}this._itemsByIdentity&&this._assert(void 0===this._itemsByIdentity[i]),this._assert(void 0===this._pending._newItems[i]),this._assert(void 0===this._pending._deletedItems[i]);var r={};r[this._storeRefPropName]=this,r[this._itemNumPropName]=this._arrayOfAllItems.length,this._itemsByIdentity&&((this._itemsByIdentity[i]=r)[s]=[i]),this._arrayOfAllItems.push(r);var n=null;if(t&&t.parent&&t.attribute){n={item:t.parent,attribute:t.attribute,oldValue:void 0};var a=this.getValues(t.parent,t.attribute);if(a&&0<a.length){var h=a.slice(0,a.length);1===a.length?n.oldValue=a[0]:n.oldValue=a.slice(0,a.length),h.push(r),this._setValueOrValues(t.parent,t.attribute,h,!1),n.newValue=this.getValues(t.parent,t.attribute)}else this._setValueOrValues(t.parent,t.attribute,r,!1),n.newValue=r}else r[this._rootItemPropName]=!0,this._arrayOfTopLevelItems.push(r);for(var o in this._pending._newItems[i]=r,e){if(o===this._storeRefPropName||o===this._itemNumPropName)throw new Error("encountered bug in ItemFileWriteStore.newItem");var _=e[o];if(I.isArray(_)||(_=[_]),r[o]=_,this.referenceIntegrity)for(var f=0;f<_.length;f++){var l=_[f];this.isItem(l)&&this._addReferenceToMap(l,r,o)}}return this.onNew(r,n),r},_removeArrayElement:function(e,t){var i=g.indexOf(e,t);return-1!=i&&(e.splice(i,1),!0)},deleteItem:function(i){this._assert(!this._saveInProgress),this._assertIsItem(i);var e=i[this._itemNumPropName],t=this.getIdentity(i);if(this.referenceIntegrity){var s=this.getAttributes(i);i[this._reverseRefMap]&&(i["backup_"+this._reverseRefMap]=I.clone(i[this._reverseRefMap])),g.forEach(s,function(t){g.forEach(this.getValues(i,t),function(e){this.isItem(e)&&(i["backupRefs_"+this._reverseRefMap]||(i["backupRefs_"+this._reverseRefMap]=[]),i["backupRefs_"+this._reverseRefMap].push({id:this.getIdentity(e),attr:t}),this._removeReferenceFromMap(e,i,t))},this)},this);var r=i[this._reverseRefMap];if(r)for(var n in r){var a=null;if(a=this._itemsByIdentity?this._itemsByIdentity[n]:this._arrayOfAllItems[n])for(var h in r[n]){var o=this.getValues(a,h)||[],_=g.filter(o,function(e){return!(this.isItem(e)&&this.getIdentity(e)==t)},this);this._removeReferenceFromMap(i,a,h),_.length<o.length&&this._setValueOrValues(a,h,_,!0)}}}return this._arrayOfAllItems[e]=null,i[this._storeRefPropName]=null,this._itemsByIdentity&&delete this._itemsByIdentity[t],(this._pending._deletedItems[t]=i)[this._rootItemPropName]&&this._removeArrayElement(this._arrayOfTopLevelItems,i),this.onDelete(i),!0},setValue:function(e,t,i){return this._setValueOrValues(e,t,i,!0)},setValues:function(e,t,i){return this._setValueOrValues(e,t,i,!0)},unsetAttribute:function(e,t){return this._setValueOrValues(e,t,[],!0)},_setValueOrValues:function(i,s,e,t){this._assert(!this._saveInProgress),this._assertIsItem(i),this._assert(I.isString(s)),this._assert(void 0!==e);var r=this._getIdentifierAttribute();if(s==r)throw new Error("ItemFileWriteStore does not have support for changing the value of an item's identifier.");var n=this._getValueOrValues(i,s),a=this.getIdentity(i);if(!this._pending._modifiedItems[a]){var h={};for(var o in i)o===this._storeRefPropName||o===this._itemNumPropName||o===this._rootItemPropName?h[o]=i[o]:o===this._reverseRefMap?h[o]=I.clone(i[o]):h[o]=i[o].slice(0,i[o].length);this._pending._modifiedItems[a]=h}var _=!1;if(I.isArray(e)&&0===e.length){if(_=delete i[s],e=void 0,this.referenceIntegrity&&n){var f=n;I.isArray(f)||(f=[f]);for(var l=0;l<f.length;l++){var m=f[l];this.isItem(m)&&this._removeReferenceFromMap(m,i,s)}}}else{var d;if(d=I.isArray(e)?e.slice(0,e.length):[e],this.referenceIntegrity)if(n){f=n;I.isArray(f)||(f=[f]);var u={};for(var p in g.forEach(f,function(e){if(this.isItem(e)){var t=this.getIdentity(e);u[t.toString()]=!0}},this),g.forEach(d,function(e){if(this.isItem(e)){var t=this.getIdentity(e);u[t.toString()]?delete u[t.toString()]:this._addReferenceToMap(e,i,s)}},this),u){var v;v=this._itemsByIdentity?this._itemsByIdentity[p]:this._arrayOfAllItems[p],this._removeReferenceFromMap(v,i,s)}}else for(l=0;l<d.length;l++){m=d[l];this.isItem(m)&&this._addReferenceToMap(m,i,s)}i[s]=d,_=!0}return t&&this.onSet(i,s,n,e),_},_addReferenceToMap:function(e,t,i){var s=this.getIdentity(t),r=e[this._reverseRefMap],n=(r=r||(e[this._reverseRefMap]={}))[s];(n=n||(r[s]={}))[i]=!0},_removeReferenceFromMap:function(e,t,i){var s,r=this.getIdentity(t),n=e[this._reverseRefMap];if(n){for(s in n)s==r&&(delete n[s][i],this._isEmpty(n[s])&&delete n[s]);this._isEmpty(n)&&delete e[this._reverseRefMap]}},_dumpReferenceMap:function(){var e;for(e=0;e<this._arrayOfAllItems.length;e++){var t=this._arrayOfAllItems[e];t&&t[this._reverseRefMap]&&console.log("Item: ["+this.getIdentity(t)+"] is referenced by: "+_.toJson(t[this._reverseRefMap]))}},_getValueOrValues:function(e,t){var i=void 0;if(this.hasAttribute(e,t)){var s=this.getValues(e,t);i=1==s.length?s[0]:s}return i},_flatten:function(e){if(this.isItem(e))return{_reference:this.getIdentity(e)};if("object"==typeof e)for(var t in this._datatypeMap){var i=this._datatypeMap[t];if(I.isObject(i)&&!I.isFunction(i)){if(e instanceof i.type){if(!i.serialize)throw new Error("ItemFileWriteStore:  No serializer defined for type mapping: ["+t+"]");return{_type:t,_value:i.serialize(e)}}}else if(e instanceof i)return{_type:t,_value:e.toString()}}return e},_getNewFileContentString:function(){var e={},t=this._getIdentifierAttribute();t!==Number&&(e.identifier=t),this._labelAttr&&(e.label=this._labelAttr),e.items=[];for(var i=0;i<this._arrayOfAllItems.length;++i){var s=this._arrayOfAllItems[i];if(null!==s){var r={};for(var n in s)if(n!==this._storeRefPropName&&n!==this._itemNumPropName&&n!==this._reverseRefMap&&n!==this._rootItemPropName){var a=this.getValues(s,n);if(1==a.length)r[n]=this._flatten(a[0]);else for(var h=[],o=0;o<a.length;++o)h.push(this._flatten(a[o])),r[n]=h}e.items.push(r)}}return _.toJson(e,!0)},_isEmpty:function(e){var t,i=!0;if(I.isObject(e))for(t in e){i=!1;break}else I.isArray(e)&&0<e.length&&(i=!1);return i},save:function(i){this._assert(!this._saveInProgress),this._saveInProgress=!0;function e(){if(s._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},s._saveInProgress=!1,i&&i.onComplete){var e=i.scope||n.global;i.onComplete.call(e)}}function t(e){if(s._saveInProgress=!1,i&&i.onError){var t=i.scope||n.global;i.onError.call(t,e)}}var s=this;if(this._saveEverything){var r=this._getNewFileContentString();this._saveEverything(e,t,r)}this._saveCustom&&this._saveCustom(e,t),this._saveEverything||this._saveCustom||e()},revert:function(){var e,i;for(e in this._assert(!this._saveInProgress),this._pending._modifiedItems){var t=this._pending._modifiedItems[e],s=null;for(var r in s=this._itemsByIdentity?this._itemsByIdentity[e]:this._arrayOfAllItems[e],t[this._storeRefPropName]=this,s)delete s[r];I.mixin(s,t)}for(e in this._pending._deletedItems){(i=this._pending._deletedItems[e])[this._storeRefPropName]=this;var n=i[this._itemNumPropName];i["backup_"+this._reverseRefMap]&&(i[this._reverseRefMap]=i["backup_"+this._reverseRefMap],delete i["backup_"+this._reverseRefMap]),this._arrayOfAllItems[n]=i,this._itemsByIdentity&&(this._itemsByIdentity[e]=i),i[this._rootItemPropName]&&this._arrayOfTopLevelItems.push(i)}for(e in this._pending._deletedItems)(i=this._pending._deletedItems[e])["backupRefs_"+this._reverseRefMap]&&(g.forEach(i["backupRefs_"+this._reverseRefMap],function(e){var t;t=this._itemsByIdentity?this._itemsByIdentity[e.id]:this._arrayOfAllItems[e.id],this._addReferenceToMap(t,i,e.attr)},this),delete i["backupRefs_"+this._reverseRefMap]);for(e in this._pending._newItems){var a=this._pending._newItems[e];a[this._storeRefPropName]=null,this._arrayOfAllItems[a[this._itemNumPropName]]=null,a[this._rootItemPropName]&&this._removeArrayElement(this._arrayOfTopLevelItems,a),this._itemsByIdentity&&delete this._itemsByIdentity[e]}return this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},!0},isDirty:function(e){if(e){var t=this.getIdentity(e);return new Boolean(this._pending._newItems[t]||this._pending._modifiedItems[t]||this._pending._deletedItems[t]).valueOf()}return!this._isEmpty(this._pending._newItems)||!this._isEmpty(this._pending._modifiedItems)||!this._isEmpty(this._pending._deletedItems)},onSet:function(e,t,i,s){},onNew:function(e,t){},onDelete:function(e){},close:function(e){if(this.clearOnClose){if(this.isDirty())throw new Error("dojo.data.ItemFileWriteStore: There are unsaved changes present in the store.  Please save or revert the changes before invoking close.");this.inherited(arguments)}}})});