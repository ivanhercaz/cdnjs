define(["../_base/lang","../Evented","../_base/declare","../_base/Deferred","../promise/all","../_base/array","../_base/connect","../regexp"],function(s,t,e,u,f,l,h,b){function d(t){return"*"==t?".*":"?"==t?".":t}return e("dojo.data.ObjectStore",[t],{objectStore:null,constructor:function(t){this._dirtyObjects=[],t.labelAttribute&&(t.labelProperty=t.labelAttribute),s.mixin(this,t)},labelProperty:"label",getValue:function(t,e,n){return"function"==typeof t.get?t.get(e):e in t?t[e]:n},getValues:function(t,e){var n=this.getValue(t,e);return n instanceof Array?n:void 0===n?[]:[n]},getAttributes:function(t){var e=[];for(var n in t)!t.hasOwnProperty(n)||"_"==n.charAt(0)&&"_"==n.charAt(1)||e.push(n);return e},hasAttribute:function(t,e){return e in t},containsValue:function(t,e,n){return-1<l.indexOf(this.getValues(t,e),n)},isItem:function(t){return"object"==typeof t&&t&&!(t instanceof Date)},isItemLoaded:function(t){return t&&"function"!=typeof t.load},loadItem:function(n){var r;return"function"==typeof n.item.load?u.when(n.item.load(),function(t){var e=(r=t)instanceof Error?n.onError:n.onItem;e&&e.call(n.scope,t)}):n.onItem&&n.onItem.call(n.scope,n.item),r},close:function(t){return t&&t.abort&&t.abort()},fetch:function(r){r=s.delegate(r,r&&r.queryOptions);var o=this,i=r.scope||o,t=r.query;if("object"==typeof t)for(var e in t=s.delegate(t)){var n=t[e];"string"==typeof n&&(t[e]=RegExp("^"+b.escapeString(n,"*?\\").replace(/\\.|\*|\?/g,d)+"$",r.ignoreCase?"mi":"m"),t[e].toString=function(t){return function(){return t}}(n))}var a=this.objectStore.query(t,r);function c(t){r.onError&&r.onError.call(i,t,r)}return u.when(a.total,function(n){u.when(a,function(t){if(r.onBegin&&r.onBegin.call(i,n||t.length,r),r.onItem)for(var e=0;e<t.length;e++)r.onItem.call(i,t[e],r);return r.onComplete&&r.onComplete.call(i,r.onItem?null:t,r),t},c)},c),r.abort=function(){a.cancel&&a.cancel()},a.observe&&(this.observing&&this.observing.cancel(),this.observing=a.observe(function(t,e,n){if(-1==l.indexOf(o._dirtyObjects,t))if(-1==e)o.onNew(t);else if(-1==n)o.onDelete(t);else for(var r in t)r!=o.objectStore.idProperty&&o.onSet(t,r,null,t[r])},!0)),this.onFetch(a),r.store=this,r},getFeatures:function(){return{"dojo.data.api.Read":!!this.objectStore.get,"dojo.data.api.Identity":!0,"dojo.data.api.Write":!!this.objectStore.put,"dojo.data.api.Notification":!0}},getLabel:function(t){if(this.isItem(t))return this.getValue(t,this.labelProperty)},getLabelAttributes:function(t){return[this.labelProperty]},getIdentity:function(t){return this.objectStore.getIdentity?this.objectStore.getIdentity(t):t[this.objectStore.idProperty||"id"]},getIdentityAttributes:function(t){return[this.objectStore.idProperty]},fetchItemByIdentity:function(e){var n;return u.when(this.objectStore.get(e.identity),function(t){n=t,e.onItem.call(e.scope,t)},function(t){e.onError.call(e.scope,t)}),n},newItem:function(t,e){if(e){var n=this.getValue(e.parent,e.attribute,[]);n=n.concat([t]),t.__parent=n,this.setValue(e.parent,e.attribute,n)}return this._dirtyObjects.push({object:t,save:!0}),this.onNew(t),t},deleteItem:function(t){this.changing(t,!0),this.onDelete(t)},setValue:function(t,e,n){var r=t[e];this.changing(t),t[e]=n,this.onSet(t,e,r,n)},setValues:function(t,e,n){if(!s.isArray(n))throw new Error("setValues expects to be passed an Array object as its value");this.setValue(t,e,n)},unsetAttribute:function(t,e){this.changing(t);var n=t[e];delete t[e],this.onSet(t,e,n,void 0)},changing:function(t,e){t.__isDirty=!0;for(var n=0;n<this._dirtyObjects.length;n++){var r=this._dirtyObjects[n];if(t==r.object)return void(e&&(r.object=!1,this._saveNotNeeded||(r.save=!0)))}var o=t instanceof Array?[]:{};for(n in t)t.hasOwnProperty(n)&&(o[n]=t[n]);this._dirtyObjects.push({object:!e&&t,old:o,save:!this._saveNotNeeded})},save:function(e){e=e||{};var t,n=[],r=[],o=this,i=this._dirtyObjects;i.length;try{var a;h.connect(e,"onError",function(){if(!1!==e.revertOnError){var t=i;i=r,o.revert(),o._dirtyObjects=t}else o._dirtyObjects=i.concat(r)}),this.objectStore.transaction&&(a=this.objectStore.transaction());for(var c=0;c<i.length;c++){var s=i[c],u=s.object,l=s.old;delete u.__isDirty,u?(t=this.objectStore.put(u,{overwrite:!!l}),n.push(t)):void 0!==l&&(t=this.objectStore.remove(this.getIdentity(l)),n.push(t)),r.push(s),i.splice(c--,1)}f(n).then(function(t){e.onComplete&&e.onComplete.call(e.scope,t)},function(t){e.onError&&e.onError.call(e.scope,t)}),a&&a.commit()}catch(t){e.onError.call(e.scope,value)}},revert:function(){for(var t=this._dirtyObjects,e=t.length;0<e;){var n=t[--e],r=n.object,o=n.old;if(r&&o){for(var i in o)o.hasOwnProperty(i)&&r[i]!==o[i]&&(this.onSet(r,i,r[i],o[i]),r[i]=o[i]);for(i in r)o.hasOwnProperty(i)||(this.onSet(r,i,r[i]),delete r[i])}else o?this.onNew(o):this.onDelete(r);delete(r||o).__isDirty,t.splice(e,1)}},isDirty:function(t){return t?t.__isDirty:!!this._dirtyObjects.length},onSet:function(){},onNew:function(){},onDelete:function(){},onFetch:function(t){}})});