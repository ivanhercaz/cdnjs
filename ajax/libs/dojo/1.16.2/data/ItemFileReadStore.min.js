define(["../_base/kernel","../_base/lang","../_base/declare","../_base/array","../_base/xhr","../Evented","./util/filter","./util/simpleFetch","../date/stamp"],function(n,F,e,i,o,t,_,r,s){var a=e("dojo.data.ItemFileReadStore",[t],{constructor:function(e){this._arrayOfAllItems=[],this._arrayOfTopLevelItems=[],this._loadFinished=!1,this._jsonFileUrl=e.url,this._ccUrl=e.url,this.url=e.url,this._jsonData=e.data,this.data=null,this._datatypeMap=e.typeMap||{},this._datatypeMap.Date||(this._datatypeMap.Date={type:Date,deserialize:function(e){return s.fromISOString(e)}}),this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0},this._itemsByIdentity=null,this._storeRefPropName="_S",this._itemNumPropName="_0",this._rootItemPropName="_RI",this._reverseRefMap="_RRM",this._loadInProgress=!1,this._queuedFetches=[],void 0!==e.urlPreventCache&&(this.urlPreventCache=!!e.urlPreventCache),void 0!==e.hierarchical&&(this.hierarchical=!!e.hierarchical),e.clearOnClose&&(this.clearOnClose=!0),"failOk"in e&&(this.failOk=!!e.failOk)},url:"",_ccUrl:"",data:null,typeMap:null,clearOnClose:!1,urlPreventCache:!1,failOk:!1,hierarchical:!0,_assertIsItem:function(e){if(!this.isItem(e))throw new Error(this.declaredClass+": Invalid item argument.")},_assertIsAttribute:function(e){if("string"!=typeof e)throw new Error(this.declaredClass+": Invalid attribute argument.")},getValue:function(e,t,r){var s=this.getValues(e,t);return 0<s.length?s[0]:r},getValues:function(e,t){return this._assertIsItem(e),this._assertIsAttribute(t),(e[t]||[]).slice(0)},getAttributes:function(e){this._assertIsItem(e);var t=[];for(var r in e)r!==this._storeRefPropName&&r!==this._itemNumPropName&&r!==this._rootItemPropName&&r!==this._reverseRefMap&&t.push(r);return t},hasAttribute:function(e,t){return this._assertIsItem(e),this._assertIsAttribute(t),t in e},containsValue:function(e,t,r){var s=void 0;return"string"==typeof r&&(s=_.patternToRegExp(r,!1)),this._containsValue(e,t,r,s)},_containsValue:function(e,t,r,s){return i.some(this.getValues(e,t),function(e){if(null!==e&&!F.isObject(e)&&s){if(e.toString().match(s))return!0}else if(r===e)return!0})},isItem:function(e){return!(!e||e[this._storeRefPropName]!==this||this._arrayOfAllItems[e[this._itemNumPropName]]!==e)},isItemLoaded:function(e){return this.isItem(e)},loadItem:function(e){this._assertIsItem(e.item)},getFeatures:function(){return this._features},getLabel:function(e){if(this._labelAttr&&this.isItem(e))return this.getValue(e,this._labelAttr)},getLabelAttributes:function(e){return this._labelAttr?[this._labelAttr]:null},filter:function(e,t,r){var s,i,a=[];if(e.query){var l,n=!!e.queryOptions&&e.queryOptions.ignoreCase,o={};for(i in e.query)"string"==typeof(l=e.query[i])?o[i]=_.patternToRegExp(l,n):l instanceof RegExp&&(o[i]=l);for(s=0;s<t.length;++s){var h=!0,d=t[s];if(null===d)h=!1;else for(i in e.query)l=e.query[i],this._containsValue(d,i,l,o[i])||(h=!1);h&&a.push(d)}r(a,e)}else{for(s=0;s<t.length;++s){var u=t[s];null!==u&&a.push(u)}r(a,e)}},_fetchItems:function(t,r,s){var i=this;if(this._loadFinished)this.filter(t,this._getItemsArray(t.queryOptions),r);else if(this._jsonFileUrl!==this._ccUrl?(n.deprecated(this.declaredClass+": ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this._ccUrl=this._jsonFileUrl,this.url=this._jsonFileUrl):this.url!==this._ccUrl&&(this._jsonFileUrl=this.url,this._ccUrl=this.url),null!=this.data&&(this._jsonData=this.data,this.data=null),this._jsonFileUrl)if(this._loadInProgress)this._queuedFetches.push({args:t,filter:F.hitch(i,"filter"),findCallback:F.hitch(i,r)});else{this._loadInProgress=!0;var e={url:i._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk},a=o.get(e);a.addCallback(function(e){try{i._getItemsFromLoadedData(e),i._loadFinished=!0,i._loadInProgress=!1,i.filter(t,i._getItemsArray(t.queryOptions),r),i._handleQueuedFetches()}catch(e){i._loadFinished=!0,i._loadInProgress=!1,s(e,t)}}),a.addErrback(function(e){i._loadInProgress=!1,s(e,t)});var l=null;t.abort&&(l=t.abort),t.abort=function(){var e=a;e&&-1===e.fired&&(e.cancel(),e=null),l&&l.call(t)}}else if(this._jsonData)try{this._loadFinished=!0,this._getItemsFromLoadedData(this._jsonData),this._jsonData=null,i.filter(t,this._getItemsArray(t.queryOptions),r)}catch(e){s(e,t)}else s(new Error(this.declaredClass+": No JSON source data was provided as either URL or a nested Javascript object."),t)},_handleQueuedFetches:function(){if(0<this._queuedFetches.length){for(var e=0;e<this._queuedFetches.length;e++){var t=this._queuedFetches[e],r=t.args,s=t.filter,i=t.findCallback;s?s(r,this._getItemsArray(r.queryOptions),i):this.fetchItemByIdentity(r)}this._queuedFetches=[]}},_getItemsArray:function(e){return e&&e.deep?this._arrayOfAllItems:this._arrayOfTopLevelItems},close:function(e){this.clearOnClose&&this._loadFinished&&!this._loadInProgress&&(""!=this._jsonFileUrl&&null!=this._jsonFileUrl||""!=this.url&&null!=this.url||null!=this.data||console.debug(this.declaredClass+": WARNING!  Data reload  information has not been provided.  Please set 'url' or 'data' to the appropriate value before the next fetch"),this._arrayOfAllItems=[],this._arrayOfTopLevelItems=[],this._loadFinished=!1,this._itemsByIdentity=null,this._loadInProgress=!1,this._queuedFetches=[])},_getItemsFromLoadedData:function(e){var t,r,s=!1,l=this;function n(e){return null!==e&&"object"==typeof e&&(!F.isArray(e)||s)&&!F.isFunction(e)&&(e.constructor==Object||F.isArray(e))&&void 0===e._reference&&void 0===e._type&&void 0===e._value&&l.hierarchical}function o(e){for(var t in l._arrayOfAllItems.push(e),e){var r=e[t];if(r)if(F.isArray(r))for(var s=r,i=0;i<s.length;++i){var a=s[i];n(a)&&o(a)}else n(r)&&o(r)}}for(this._labelAttr=e.label,this._arrayOfAllItems=[],this._arrayOfTopLevelItems=e.items,t=0;t<this._arrayOfTopLevelItems.length;++t)r=this._arrayOfTopLevelItems[t],F.isArray(r)&&(s=!0),o(r),r[this._rootItemPropName]=!0;var i,a,h={};for(t=0;t<this._arrayOfAllItems.length;++t)for(i in r=this._arrayOfAllItems[t]){if(i!==this._rootItemPropName){var d=r[i];null!==d?F.isArray(d)||(r[i]=[d]):r[i]=[null]}h[i]=i}for(;h[this._storeRefPropName];)this._storeRefPropName+="_";for(;h[this._itemNumPropName];)this._itemNumPropName+="_";for(;h[this._reverseRefMap];)this._reverseRefMap+="_";var u=e.identifier;if(u)for(this._itemsByIdentity={},this._features["dojo.data.api.Identity"]=u,t=0;t<this._arrayOfAllItems.length;++t){var _=(a=(r=this._arrayOfAllItems[t])[u])[0];if(Object.hasOwnProperty.call(this._itemsByIdentity,_)){if(this._jsonFileUrl)throw new Error(this.declaredClass+":  The json data as specified by: ["+this._jsonFileUrl+"] is malformed.  Items within the list have identifier: ["+u+"].  Value collided: ["+_+"]");if(this._jsonData)throw new Error(this.declaredClass+":  The json data provided by the creation arguments is malformed.  Items within the list have identifier: ["+u+"].  Value collided: ["+_+"]")}else this._itemsByIdentity[_]=r}else this._features["dojo.data.api.Identity"]=Number;for(t=0;t<this._arrayOfAllItems.length;++t)(r=this._arrayOfAllItems[t])[this._storeRefPropName]=this,r[this._itemNumPropName]=t;for(t=0;t<this._arrayOfAllItems.length;++t)for(i in r=this._arrayOfAllItems[t]){a=r[i];for(var c=0;c<a.length;++c)if(null!==(d=a[c])&&"object"==typeof d){if("_type"in d&&"_value"in d){var f=d._type,m=this._datatypeMap[f];if(!m)throw new Error("dojo.data.ItemFileReadStore: in the typeMap constructor arg, no object class was specified for the datatype '"+f+"'");if(F.isFunction(m))a[c]=new m(d._value);else{if(!F.isFunction(m.deserialize))throw new Error("dojo.data.ItemFileReadStore: Value provided in typeMap was neither a constructor, nor a an object with a deserialize function");a[c]=m.deserialize(d._value)}}if(d._reference){var p=d._reference;if(F.isObject(p))for(var I=0;I<this._arrayOfAllItems.length;++I){var y=this._arrayOfAllItems[I],g=!0;for(var v in p)y[v]!=p[v]&&(g=!1);g&&(a[c]=y)}else a[c]=this._getItemByIdentity(p);if(this.referenceIntegrity){var j=a[c];this.isItem(j)&&this._addReferenceToMap(j,r,i)}}else this.isItem(d)&&this.referenceIntegrity&&this._addReferenceToMap(d,r,i)}}},_addReferenceToMap:function(e,t,r){},getIdentity:function(e){var t=this._features["dojo.data.api.Identity"];if(t===Number)return e[this._itemNumPropName];var r=e[t];return r?r[0]:null},fetchItemByIdentity:function(r){var s,e;if(this._loadFinished)s=this._getItemByIdentity(r.identity),r.onItem&&(e=r.scope?r.scope:n.global,r.onItem.call(e,s));else{var i=this;if(this._jsonFileUrl!==this._ccUrl?(n.deprecated(this.declaredClass+": ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this._ccUrl=this._jsonFileUrl,this.url=this._jsonFileUrl):this.url!==this._ccUrl&&(this._jsonFileUrl=this.url,this._ccUrl=this.url),null!=this.data&&null==this._jsonData&&(this._jsonData=this.data,this.data=null),this._jsonFileUrl)if(this._loadInProgress)this._queuedFetches.push({args:r});else{this._loadInProgress=!0;var t={url:i._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk},a=o.get(t);a.addCallback(function(e){var t=r.scope?r.scope:n.global;try{i._getItemsFromLoadedData(e),i._loadFinished=!0,i._loadInProgress=!1,s=i._getItemByIdentity(r.identity),r.onItem&&r.onItem.call(t,s),i._handleQueuedFetches()}catch(e){i._loadInProgress=!1,r.onError&&r.onError.call(t,e)}}),a.addErrback(function(e){if(i._loadInProgress=!1,r.onError){var t=r.scope?r.scope:n.global;r.onError.call(t,e)}})}else this._jsonData&&(i._getItemsFromLoadedData(i._jsonData),i._jsonData=null,i._loadFinished=!0,s=i._getItemByIdentity(r.identity),r.onItem&&(e=r.scope?r.scope:n.global,r.onItem.call(e,s)))}},_getItemByIdentity:function(e){var t=null;return this._itemsByIdentity?Object.hasOwnProperty.call(this._itemsByIdentity,e)&&(t=this._itemsByIdentity[e]):Object.hasOwnProperty.call(this._arrayOfAllItems,e)&&(t=this._arrayOfAllItems[e]),void 0===t&&(t=null),t},getIdentityAttributes:function(e){var t=this._features["dojo.data.api.Identity"];return t===Number?null:[t]},_forceLoad:function(){var t=this;if(this._jsonFileUrl!==this._ccUrl?(n.deprecated(this.declaredClass+": ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this._ccUrl=this._jsonFileUrl,this.url=this._jsonFileUrl):this.url!==this._ccUrl&&(this._jsonFileUrl=this.url,this._ccUrl=this.url),null!=this.data&&(this._jsonData=this.data,this.data=null),this._jsonFileUrl){var e={url:this._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk,sync:!0},r=o.get(e);r.addCallback(function(e){try{if(!0===t._loadInProgress||t._loadFinished){if(t._loadInProgress)throw new Error(this.declaredClass+":  Unable to perform a synchronous load, an async load is in progress.")}else t._getItemsFromLoadedData(e),t._loadFinished=!0}catch(e){throw console.log(e),e}}),r.addErrback(function(e){throw e})}else this._jsonData&&(t._getItemsFromLoadedData(t._jsonData),t._jsonData=null,t._loadFinished=!0)}});return F.extend(a,r),a});