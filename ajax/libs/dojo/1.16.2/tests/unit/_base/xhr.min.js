define(["intern!object","intern/chai!assert","../../../_base/kernel","../../../_base/xhr","../../../_base/Deferred","../../../topic","dojo/_base/array","dojo/query","dojo/json","dojo/dom-construct","dojo/Deferred","dojo/promise/all","dojo/domReady!"],function(e,o,t,c,a,n,s,l,r,i,u,d){var b,f,h;e({name:"dojo/_base/xhr","text content handler":function(){o.strictEqual(t._contentHandlers.text({responseText:"foo bar baz "}),"foo bar baz ")},"json content handler":function(){var e={foo:"bar",baz:[{thonk:"blarg"},"xyzzy!"]};o.deepEqual(t._contentHandlers.json({responseText:r.stringify(e)}),e)},"json-comment-filtered handler":function(){var e={foo:"bar",baz:[{thonk:"blarg"},"xyzzy!"]};o.throws(function(){t._contentHandlers["json-comment-filtered"]({responseText:r.stringify(e)})}),o.deepEqual(t._contentHandlers["json-comment-filtered"]({responseText:"\tblag\n/*"+r.stringify(e)+"*/\n\r\t\r"}),e),o.deepEqual(t._contentHandlers["json-comment-optional"]({responseText:"\tblag\n/*"+r.stringify(e)+"*/\n\r\t\r"}),e)},"javascript content handler":function(){var e={foo:"bar",baz:[{thonk:"blarg"},"xyzzy!"]};o.deepEqual(t._contentHandlers.javascript({responseText:"("+r.stringify(e)+")"}),e),o.ok(t._contentHandlers.javascript({responseText:"true;"})),o.ok(!t._contentHandlers.javascript({responseText:"false;"}))},"xml content handler":function(){var e={responseText:'<foo><bar baz="thonk">blarg</bar></foo>'};if("DOMParser"in t.global){var r=new DOMParser;e.responseXML=r.parseFromString(e.responseText,"text/xml")}var a=t._contentHandlers.xml(e);o.strictEqual(a.documentElement.tagName,"foo")},".get":{success:function(){var e=this.async(3e4,2),r=c.get({url:"/__services/request/xhr",preventCache:!0,handleAs:"json",load:e.callback(function(e,r){return o.strictEqual(r.xhr.readyState,4),e})});o.instanceOf(r,a),r.addCallback(e.callback(function(e){o.strictEqual(e.method,"GET")})),r.addErrback(e.reject)},"404 status":function(){var e=this.async(3e4,2),r=c.get({url:"xhr_blarg.html",error:e.callback(function(e,r){return o.strictEqual(r.xhr.status,404),e})});r.addCallback(e.reject),r.addErrback(e.resolve)},content:function(){var e=this.async(),r=c.get({url:"/__services/request/xhr?color=blue",content:{foo:["bar","baz"],thud:"thonk",xyzzy:3}});r.addCallback(e.callback(function(){o.strictEqual(r.ioArgs.url,"/__services/request/xhr?color=blue&foo=bar&foo=baz&thud=thonk&xyzzy=3")}))},form:{setup:function(){b=i.place('<form id="f3" style="border: 1px solid black;"><input id="f3_spaces" type="hidden" name="spaces" value="string with spaces"></form>',document.body)},teardown:function(){i.destroy(b),b=null},serialize:function(){var e=this.async(),r=c.get({url:"/__services/request/xhr",form:"f3"});r.addCallback(e.callback(function(){o.strictEqual(r.ioArgs.url,"/__services/request/xhr?spaces=string%20with%20spaces")}))},"with content":function(){var e=this.async(),r=c.get({url:"/__services/request/xhr",form:"f3",content:{spaces:"blah"}});r.addCallback(e.callback(function(){o.strictEqual(r.ioArgs.url,"/__services/request/xhr?spaces=blah")}))}}},".post":{success:function(){var e=this.async();c.post({url:"/__services/request/xhr?foo=bar",content:{color:"blue"},handleAs:"json",handle:e.callback(function(e){o.strictEqual(e.method,"POST"),o.deepEqual(e.query,{foo:"bar"}),o.deepEqual(e.payload,{color:"blue"})})})},"with content":function(){var e=this.async(),r=c.post({url:"/__services/request/xhr",content:{foo:["bar","baz"],thud:"thonk",xyzzy:3}});r.addCallback(e.callback(function(){o.strictEqual(r.ioArgs.query,"foo=bar&foo=baz&thud=thonk&xyzzy=3")})),r.addErrback(e.reject)},form:{setup:function(){b=i.place('<form id="f4" style="border: 1px solid black;" action="/__services/request/xhr"><input id="f4_action" type="hidden" name="action" value="Form with input named action"></form>',document.body)},teardown:function(){i.destroy(b),b=null},serialize:function(){var e=this.async(),r=c.post({form:"f4"});r.addCallback(e.resolve),r.addErrback(e.reject)}},raw:function(){var e=this.async(),r=c.post({url:"/__services/request/xhr",postData:"foo=bar&color=blue&height=average",handleAs:"json"});r.addCallback(e.callback(function(e){o.deepEqual(e.payload,{foo:"bar",color:"blue",height:"average"})})),r.addErrback(e.reject)}},".put":function(){var e=this.async(),r=c.put({url:"/__services/request/xhr?foo=bar",content:{color:"blue"},handleAs:"json"});r.addCallback(e.callback(function(e){o.strictEqual(e.method,"PUT"),o.deepEqual(e.query,{foo:"bar"}),o.deepEqual(e.payload,{color:"blue"})})),r.addErrback(e.reject)},".del":function(){var e=this.async(),r=c.del({url:"/__services/request/xhr",preventCache:!0,handleAs:"json"});r.addCallback(e.callback(function(e){o.strictEqual(e.method,"DELETE")})),r.addErrback(e.reject)},cancel:function(){var e=this.async(),r=c.post({url:"/__services/request/xhr?delay=3000"});r.addCallback(e.reject),r.addErrback(e.callback(function(e){o.instanceOf(e,Error),o.strictEqual(e.dojoType,"cancel")})),r.cancel()},"xml queryable":function(){var e=this.async(),r=c.get({url:"/__services/request/xhr/xml",handleAs:"xml"});r.addCallback(e.callback(function(e){var r=l("bar",e);o.strictEqual(r.length,2)})),r.addErrback(e.reject)},ioPublish:{setup:function(){t.config.ioPublish=!0,f={};var r=[];h=function(){s.forEach(r,function(e){e.remove()}),r=null},s.forEach(["start","send","load","error","done"],function(e){f[e]=0,r.push(n.subscribe("/dojo/io/"+e,function(){f[e]+=1}))})},teardown:function(){t.config.ioPublish=!1,h()},counts:function(){var e=this.async(),r=new u,a=c.get({url:"/__services/request/xhr?delay=1000"}),t=new u,n=c.get({url:"/__services/request/xhr?delay=1000"});a.addCallback(r.resolve),a.addErrback(r.reject),n.addCallback(t.resolve),n.addErrback(t.reject),d([r,t]).then(function(){setTimeout(e.callback(function(){o.deepEqual(f,{start:1,send:2,load:2,error:0,done:2})}),100)},e.reject)}}})});