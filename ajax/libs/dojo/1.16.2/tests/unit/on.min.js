define(["intern!object","intern/chai!assert","../../on","../../Evented","dojo/_base/lang","dojo/_base/array","dojo/has","dojo/has!host-browser?dojo/dom-construct","dojo/has!host-browser?../../query","dojo/has!host-browser?dojo/domReady!"],function(e,a,u,t,r,n,c,i){var o=[],l=u;for(var s in u=function(){var e=l.apply(null,arguments);return o.push(e),e},l)u[s]=l[s];function f(){for(;0<o.length;)o.pop().remove()}function m(e){var o,i=e.eventName;return{beforeEach:function(){o=e.createTarget()},afterEach:function(){f(),e.destroyTarget&&e.destroyTarget(o)},"on and on.emit":function(){var t,n=0;u(o,i,function(e){n++,a.strictEqual(e.value,t.value)}),t={value:"foo"},u.emit(o,i,t),a.strictEqual(n,1),t={value:"bar"},u.emit(o,i,t),a.strictEqual(n,2)},".emit return value":function(){var e=u.emit(o,i,{cancelable:!1});c("dom-addeventlistener")&&"dispatchEvent"in o?(a.ok(e),a.propertyVal(e,"cancelable",!1)):a.isFalse(e),e=u.emit(o,i,{cancelable:!0}),a.ok(e),a.propertyVal(e,"cancelable",!0),u(o,i,function(e){"preventDefault"in e?e.preventDefault():e.cancelable=!1}),a.isFalse(u.emit(o,i,{cancelable:!0}))},"on - multiple event names":function(){var t,n,c=0;u(o,"test1, test2",function(e){c++,t in e&&a.strictEqual(e.type,t),a.strictEqual(e.value,n.value)}),t="test1",n={value:"foo"},u.emit(o,t,n),a.strictEqual(c,1),t="test2",n={value:"bar"},u.emit(o,t,n),a.strictEqual(c,2)},"on - multiple handlers":function(){var t=[];u(o,"a, b",function(e){t.push(1+e.type)}),u(o,["a",function(e,t){return u(e,"custom",t)}],function(e){t.push(2+e.type)}),u.emit(o,"a",{type:"a"}),u.emit(o,"b",{type:"b"}),u.emit(o,"custom",{type:"custom"}),a.deepEqual(t,["1a","2a","1b","2custom"])},"on - extension events":function(){var t,n=0;u(o,function(e,t){return u(e,i,t)},function(e){n++,a.strictEqual(e.value,t.value)}),t={value:"foo"},u.emit(o,i,t),a.strictEqual(n,1),t={value:"bar"},u.emit(o,i,t),a.strictEqual(n,2)},".pausable":function(){var e=0,t=u.pausable(o,i,function(){e++});u.emit(o,i,{}),a.strictEqual(e,1),t.pause(),u.emit(o,i,{}),a.strictEqual(e,1),t.resume(),u.emit(o,i,{}),a.strictEqual(e,2)},".once":function(){var e=0;u.once(o,i,function(){++e}),a.strictEqual(e,0),u.emit(o,i,{}),a.strictEqual(e,1),u.emit(o,i,{}),a.strictEqual(e,1)},"hitch no selector":function(){var e=document.body.appendChild(document.createElement("div")),t=e.appendChild(document.createElement("span")).appendChild(document.createElement("button")),n={fake:!0},c={contextIsOk:!1,selectorTargetIsOk:!1};u(e,"click",r.hitch(n,function(e){c.contextIsOk=this===n,c.selectorTargetIsOk=void 0===e.selectorTarget})),u.emit(t,"click",{cancelable:!0,bubbles:!0}),a.isTrue(c.contextIsOk,"contextIsOk"),a.isTrue(c.selectorTargetIsOk,"selectorTargetIsOk")},"hitch with selector":function(){var e=document.body.appendChild(document.createElement("div")),t=e.appendChild(document.createElement("span")),n=t.appendChild(document.createElement("button")),c={fake:!0},o={contextIsOk:!1,selectorTargetIsOk:!1};u(e,"span:click",r.hitch(c,function(e){o.contextIsOk=this===c,o.selectorTargetIsOk=e.selectorTarget===t})),u.emit(n,"click",{cancelable:!0,bubbles:!0}),a.isTrue(o.contextIsOk,"contextIsOk"),a.isTrue(o.selectorTargetIsOk,"selectorTargetIsOk")},"listener call order":function(){var t=[];o["on"+i]=function(e){t.push(e.a)};var e=u.pausable(o,i,function(){t.push(1)}),n=u(o,i+", foo",function(e){t.push(e.a)});u.emit(o,i,{a:3}),e.pause();var c=u(o,i,function(){t.push(3)},!0);u.emit(o,i,{a:3}),n.remove(),e.resume(),u.emit(o,i,{a:6}),c.remove(),u(o,"foo, "+i,function(){t.push(4)},!0),e.remove(),u.emit(o,i,{a:7}),a.deepEqual(t,[3,1,3,3,3,3,6,1,3,7,4])}}}var d,v,h,p={name:"dojo/on",common:{"object events":m({eventName:"test",createTarget:function(){return new t}})},"cannot target non-emitter":function(){var t=!1;try{u({},"test",function(){})}catch(e){t=!0}a.isTrue(t)}};c("host-browser")&&(p.common["DOM events"]=m({eventName:"click",createTarget:function(){return i.create("div",null,document.body)},destroyTarget:function(e){i.destroy(e)}}),p["DOM-specific"]={beforeEach:function(){d=i.create("div",null,document.body),v=i.create("span",null,d)},afterEach:function(){f(),i.destroy(d),d=v=null},"event.preventDefault":{"native event":function(){var t=!1;u(v,"click",function(e){e.preventDefault(),t=e.defaultPrevented}),v.click(),a.isTrue(t)},"synthetic event":function(){var t=!1,n=!1;u(v,"click",function(e){e.preventDefault()}),u(d,"click",function(e){t=!0,n=e.defaultPrevented}),u.emit(v,"click",{bubbles:!0,cancelable:!0}),a.isTrue(t,"bubbled synthetic event on div"),a.isTrue(n,"defaultPrevented set for synthetic event on div")}},"event bubbling":function(){var e=!1;u(d,"click",function(){e=!0}),v.click(),a.isTrue(e,"expected event to bubble")},"event.stopPropagation":function(){var e;u(d,"click",function(){e=!0}),u(v,"click",function(e){e.stopPropagation()}),e=!1,v.click(),a.isFalse(e),e=!1,u.emit(v,"click",{}),a.isFalse(e)},"event.stopImmediatePropagation":function(){u(v,"click",function(e){e.stopImmediatePropagation()});var e=!1;u(v,"click",function(){e=!0}),v.click(),a.isFalse(e,"expected no other listener to be called")},"emitting events from document and window":function(){for(var e,t=i.place("<iframe></iframe>",d),n=[document,window,t.contentWindow,t.contentDocument||t.contentWindow.document],c=0,o=n.length;c<o;c++)e=!1,u(n[c],"custom-test-event",function(){e=!0}),u.emit(n[c],"custom-test-event",{}),a.isTrue(e)},"event delegation":{"CSS selector":function(){var e=i.create("button",null,v),t=!1;u(d,"button:click",function(){t=!0}),e.click(),a.isTrue(t)},"listening on document":function(){var e=i.create("button",null,v),t=!1;u(document,"button:click",function(){t=!0}),e.click(),a.isTrue(t)},"CSS selector and text node target":function(){var e;v.className="textnode-parent",v.innerHTML="text",u(d,".textnode-parent:click",function(){e=!0}),u.emit(v.firstChild,"click",{bubbles:!0,cancelable:!0}),a.isTrue(e)},"custom selector":function(){var e=i.create("button",null,v),t=!1;u(d,u.selector(function(e){return"BUTTON"===e.tagName},"click"),function(){t=!0}),e.click(),a.isTrue(t)},"on.selector and extension events":{"basic extension events":function(){v.setAttribute("foo",2);function e(e,t){return u(e,"custom",t)}var t=[];u(d,e,function(e){t.push(e.a)}),u(d,u.selector("span",e),function(){t.push(+this.getAttribute("foo"))}),u.emit(d,"custom",{a:0}),u.emit(v,"custom",{a:1,bubbles:!0,cancelable:!0}),u.emit(d,"custom",{a:3,bubbles:!0,cancelable:!0}),a.deepEqual(t,[0,1,2,3])},"extension events with bubbling forms":function(){function c(e,t){return u(e,"custom",t)}var e=!1,o=!1;c.bubble=function(n){return function(e,t){return c(e,function(e){o=!0,n(e.target)&&t(e)})}},u(d,u.selector("span",c),function(){e=!0}),u.emit(v,"custom",{bubbles:!0}),a.isTrue(e),a.isTrue(o)}},"only call listener when matching":function(){d.innerHTML='<input type="checkbox">',u(d,".matchesNothing:click",function(e){e.preventDefault()}),d.firstChild.click(),a.isTrue(d.firstChild.checked)}},"event augmentation":function(){var t,e=i.create("button",null,d);u(e,"click",function(e){e.modified=!0,e.test=3}),u(d,"click",function(e){t=e.test}),e.click(),a.strictEqual(t,3)}},p[".matches"]={beforeEach:function(){d=i.create("div",null,document.body),h=i.create("div",null,d),v=i.create("span",null,h)},afterEach:function(){f(),i.destroy(d),d=h=v=null},"inner-most child click":function(){u(d,"click",function(e){a.ok(u.matches(e.target,"span:click",this)),a.ok(u.matches(e.target,"div:click",this)),a.ok(!u.matches(e.target,"div:click",this,!1)),a.ok(!u.matches(e.target,"body:click",this))}),v.click()},"inner-most container click":function(){u(d,"click",function(e){a.ok(!u.matches(e.target,"span:click",this)),a.ok(u.matches(e.target,"div:click",this))}),h.click()}},c("touch")&&(p["DOM-specific"]["touch event normalization"]=function(){var t,e=document.body.appendChild(document.createElement("div"));u(e,"touchstart",function(e){t=r.mixin({},e)});var n=window.TouchEvent;window.TouchEvent=Event,u.emit(e,"touchstart",{changedTouches:[{pageX:100}]}),window.TouchEvent=n,a.property(t,"rotation"),a.property(t,"pageX")}),c("touch")&&(p["DOM-specific"]["touch event normalization doesn't happen to non-TouchEvent"]=function(){var t,e=document.body.appendChild(document.createElement("div"));u(e,"touchstart",function(e){t=r.mixin({},e)}),u.emit(e,"touchstart",{changedTouches:[{pageX:100}]}),a.isFalse(100===t.pageX)}));e(p)});