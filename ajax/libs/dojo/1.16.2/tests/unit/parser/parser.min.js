define(["intern!object","intern/chai!assert","../../../parser","dojo/dom-construct","dojo/_base/array","dojo/aspect","dojo/_base/declare","dojo/dom","dojo/dom-attr","dojo/_base/lang","dojo/on","dojo/_base/window","dojo/date/stamp","dojo/Stateful","dojo/Evented","dojo/text!./parser.html","./support/util"],function(e,r,n,a,o,i,s,c,l,d,u,p,m,f,b,h,j){var x;function t(r,o){return function(){delete window.tests,(window.MyNonDojoClass=function(){}).extend=function(){var e=arguments;return function(){this.expectedClass=!0,this.params=e}},s("tests.parser.Widget",null,{constructor:function(e){this.params=e}}),s("tests.parser.Class1",null,{constructor:function(e){this.params=e,d.mixin(this,e)},preambleTestProp:1,preamble:function(){this.preambleTestProp++},intProp:1,callCount:0,callInc:function(){this.callCount++},callCount2:0,strProp1:"original1",strProp2:"original2",arrProp:[],arrProp2:["foo"],boolProp1:!1,boolProp2:!0,boolProp3:!1,boolProp4:!0,dateProp1:m.fromISOString("2007-01-01"),dateProp2:m.fromISOString("2007-01-01"),dateProp3:m.fromISOString("2007-01-01"),funcProp:function(){},funcProp2:function(){},funcProp3:function(){},onclick:function(){this.prototypeOnclick=!0}}),s("tests.parser.Class2",null,{constructor:function(){this.fromMarkup=!1},fromMarkup:!1,markupFactory:function(){var e=new tests.parser.Class2;return e.fromMarkup=!0,e}}),s("tests.parser.Class3",tests.parser.Class2,{fromMarkup:!1,markupFactory:function(e,t,r){var o=new r;return o.classCtor=r,o.params=e,o}}),s("tests.parser.InputClass",null,{constructor:function(e){this.params=e,d.mixin(this,e)},disabled:!1,readonly:!1,checked:!1,value:"default value",title:"default title",tabIndex:"0",custom1:123,custom2:456}),s("tests.parser.BidiClass",tests.parser.Widget,{constructor:function(e){d.mixin(this,e)},dir:"",lang:"",textdir:"",name:""}),s("tests.parser.NormalContainer",null,{constructor:function(e){d.mixin(this,e)}}),s("tests.parser.ShieldedContainer",null,{constructor:function(e){d.mixin(this,e)},stopParser:!0}),s("tests.parser.HTML5Props",null,{constructor:function(e){d.mixin(this,e)},simple:!1,a:2,b:null,c:null,d:null,e:null,f:null,afn:function(){return 2*this.a}}),tests.parser.HTML5Props._aDefaultObj={a:1,b:2,simple:!0},s("tests.parser.HTML5withMethod",null,{constructor:function(e){d.mixin(this,e)},baseValue:10,someMethod:function(){return this.baseValue},diffMethod:function(){this._ran=!0}}),s("tests.parser.StatefulClass",[b,f],{strProp1:"",objProp1:{},boolProp1:!1,prototypeOnclick:!1,onclick:function(){this.prototypeOnclick=!0}}),s("tests.parser.MethodClass",null,{method1ran:!1,method1after:!1,method2ran:!1,method2before:!1,method2after:!1,method3result:"",method4ran:!1,method4after:!1,method1:function(){this.method1ran=!0},method2:function(){this.method2ran=!0},method3:function(e){this.method3result=e},method4:function(){this.method4ran=!0}}),s("tests.parser.ClassForMixins",null,{classDone:!0}),s("tests.parser.Mixin1",null,{mixin1Done:!0}),s("tests.parser.Mixin2",null,{mixin2Done:!0}),s("tests.resources.AMDWidget",null,{constructor:function(e){this.params=e}}),s("tests.resources.AMDWidget2",null,{constructor:function(e){this.params=e},method1:function(e){return++e}}),s("tests.resources.AMDWidget3",null,{constructor:function(e){this.params=e}}),window.deepTestProp={blah:{thinger:1}},tests.parser.FormClass=s(tests.parser.Widget,{encType:""}),window.foo=function(){this.fooCalled=!0},x=a.place(j.fixScope(h),document.body);var e=r?c.byId(r):null,t=n.parse(e);return o&&t}}function y(){a.destroy(x),x=null,delete window.foo,delete window.tests}e({name:"dojo/parser basic tests",setup:t("main",!0),teardown:y,"data-dojo-id":function(){r.isObject(obj)},JsId:function(){r.isObject(obj3)},"string property":function(){r.isString(obj.strProp1),r.equal(obj.strProp1,"text")},"int property":function(){r.isNumber(obj.intProp),r.equal(obj.intProp,5)},"array property":function(){r.lengthOf(obj.arrProp,3),r.lengthOf(obj.arrProp[1],3),r.equal(obj.arrProp[1],"bar")},"boolean property":function(){r.isBoolean(obj.boolProp1),r.isTrue(obj.boolProp1),r.isBoolean(obj.boolProp2),r.isFalse(obj.boolProp2),r.isBoolean(obj.boolProp3)},"date property":function(){r.equal(m.toISOString(obj.dateProp1,{selector:"date"}),"2006-01-01"),r.ok(isNaN(obj.dateProp2)),r.equal(m.toISOString(obj.dateProp3,{selector:"date"}),m.toISOString(new Date,{selector:"date"}))},"unwanted params":function(){for(var e in obj.params)r.ok(0<=o.indexOf(["strProp1","strProp2","intProp","arrProp","arrProp2","boolProp1","boolProp2","dateProp1","dateProp2","dateProp3","funcProp2","funcProp3","preamble","callInc1","callInc2","dir","lang","textDir"],e),e+" should not be in the parameters passed to the widget constructor")},"disabled flag":function(){r.isBoolean(disabledObj.disabled),r.isTrue(disabledObj.disabled),r.isFalse(disabledObj.checked)},"checked flag":function(){r.isBoolean(checkedObj.checked),r.isFalse(checkedObj.disabled),r.isTrue(checkedObj.checked)},"function property":function(){obj.onclick(),r.isTrue(obj.prototypeOnclick,"prototypeOnClick"),obj.funcProp2(),r.isTrue(obj.fooCalled,"fooCalled"),obj.funcProp3(),r.isTrue(obj.func3Called,"func3Called")},connect:function(){obj.callInc(),r.equal(obj.callCount,2)},"function assignment":function(){obj.callInc2(),r.equal(obj.callCount2,1)},"subnode parse":function(){r.isFalse(d.exists("obj2"),"exists before parse");var e=c.byId("toParse");n.parse(e.parentNode),r.isTrue(d.exists("obj2"),"exists after parse"),r.equal(obj.declaredClass,"tests.parser.Class1")},"markup factory":function(){r.isTrue(d.exists("obj3"),"obj3 exists"),r.isTrue(obj3.fromMarkup)},"markup factory class":function(){r.isTrue(d.exists("obj4"),"obj4 exists"),r.equal(obj4.classCtor,tests.parser.Class3),r.instanceOf(obj4,tests.parser.Class3),r.instanceOf(obj4,tests.parser.Class2)},"no start":function(){var e=!1;s("SampleThinger",null,{startup:function(){e=!0}}),a.create("div",{dojoType:"SampleThinger"},"parsertest"),n.parse("parsertest",{noStart:!0}),r.isFalse(e,"first started check"),a.empty("parsertest"),e=!1,a.create("div",{dojoType:"SampleThinger"},"parsertest"),n.parse("parsertest",{noStart:!0,rootNode:"parserTest"}),r.isFalse(e,"second started check")},"cache refresh":function(){var e=a.place(j.fixScope('<div><div ${dojo}Type="tests.parser.Class3" newParam=12345>hi</div></div>'),p.body(),"last");try{d.extend(tests.parser.Class2,{newParam:0});var t=n.parse({rootNode:e});r.lengthOf(t,1),r.equal(t[0].params.newparam||t[0].params.newParam,12345)}finally{a.destroy(e)}},recurse:function(){r.isDefined(container1,"normal container created"),r.isDefined(container1.incr,"script tag works too"),r.isDefined(contained1,"child widget also created"),r.isDefined(contained2,"child widget 2 also created"),r.isDefined(container2,"shielded container created"),r.isDefined(container2.incr,"script tag works too"),r.isUndefined(window.contained3,"child widget not created"),r.isUndefined(window.contained4,"child widget 2 not created")},"simple HTML5":function(){r.isObject(html5simple,"data-dojo-id export"),r.isObject(html5simple2,"data-dojo-id export"),r.isTrue(html5simple.simple,'default respecified in props=""'),r.isFalse(html5simple2.simple,'default overridden by props=""');var e=html5simple2;r.equal(e.a,1,"number in param"),r.equal(e.b,"two","string in param"),r.isArray(e.c,"array in param"),r.lengthOf(e.c,3,"array sanity"),r.equal(e.e.f,"g","nested object with string"),r.equal(e.d(),e,"simple 'return this' function")},"HTML5 inherited":function(){r.isObject(html5simple3);var e=html5simple3.afn();r.equal(e,2*html5simple3.a,"afn() overrides default but calls inherited")},"HTML5 with method":function(){r.isObject(htmldojomethod),r.isTrue(htmldojomethod._methodRan,"plain dojo/method ran");var e=htmldojomethod.someMethod(2,2);r.equal(e,14,"overridden dojo/method"),htmldojomethod.diffMethod(2),r.isTrue(htmldojomethod._ran,"ensures original was called first"),r.equal(htmldojomethod._fromvalue,2,"ensures connected was executed in scope")},"test watch":function(){r.isObject(objOnWatch),objOnWatch.set("strProp1","newValue1"),r.equal(objOnWatch.arrProp.newValue,"newValue1","ensures watch executed"),objOnWatch.onclick(),r.isTrue(objOnWatch.prototypeOnclick,"ensures original was called"),r.isTrue(objOnWatch.boolProp1,"ensure on executed in scope")},on:function(){n.parse("on"),r.property(window,"on_form","widget created"),on_form.emit("click"),r.isTrue(on_form.clicked,"on callback fired")},aspect:function(){r.isObject(objAspect),r.isFalse(objAspect.method1ran,"ensures method unfired"),r.isFalse(objAspect.method2ran,"ensures method unfired"),r.equal(objAspect.method3result,"","ensures method unfired"),r.isFalse(objAspect.method4ran,"ensures method unfired"),objAspect.method1(),objAspect.method2(),objAspect.method3("something"),objAspect.method4(),r.isTrue(objAspect.method1ran,"method fired"),r.isTrue(objAspect.method1after,"after advice fired"),r.isTrue(objAspect.method2ran,"method fired"),r.isTrue(objAspect.method2before,"around before advice fired"),r.isTrue(objAspect.method2after,"around after advice fired"),r.equal(objAspect.method3result,"before","before argument passed"),r.isTrue(objAspect.method4ran,"method fired"),r.isTrue(objAspect.method4after,"after advice fired")},mid:function(){r.isObject(objAMDWidget),r.equal(objAMDWidget.params.value,"Value1","ensure object was properly parsed using MID")}}),e({name:"bidi",setup:t("main"),teardown:y,"dir attribute":function(){n.parse("dirSection1"),n.parse("dirSection2"),r.equal(setRtl.dir,"rtl","direct setting of dir=rtl works"),r.equal(inheritRtl.dir,"rtl","inherited rtl works"),r.equal(inheritLtr.dir,"ltr","inherited ltr works (closest ancestor wins)"),r.equal(inheritRtl2.dir,"rtl","inherited rtl works, from grandparent"),r.equal(setLtr.dir,"ltr","direct setting of dir=ltr overrides inherited RTL")},"lang attribute":function(){n.parse("langSection"),r.notProperty(noLang.params,"lang","no lang"),r.equal(inheritedLang.lang,"it_it","inherited lang works"),r.equal(specifiedLang.lang,"en_us","direct setting of lang overrides inherited")},"textDir attribute":function(){n.parse("textDirSection"),r.notProperty(noTextdir.params,"textDir","no textdir"),r.equal(inheritedTextdir.textDir,"rtl","inherited textdir works"),r.equal(specifiedTextdir.textDir,"ltr","direct setting of textdir overrides inherited")},"inheritance from HTML":function(){var e=j.fixScope("data-${dojo}-textdir"),t={dir:"rtl",lang:"ja-jp"};t[e]="auto",l.set(p.doc.documentElement,t),n.parse("bidiInheritanceFromHtml"),r.equal(inheritedFromHtml.params.dir,"rtl","dir"),r.equal(inheritedFromHtml.params.lang,"ja-jp","lang"),r.equal(inheritedFromHtml.params.textDir,"auto","textDir"),o.forEach(["dir","lang",e],function(e){p.doc.documentElement.removeAttribute(e)})}}),e({name:"IE Attribute Detection",setup:t("main"),teardown:y,input1:function(){var e=n.instantiate([c.byId("ieInput1")])[0].params;r.equal(e.type,"checkbox","type"),r.isTrue(e.disabled,"disabled"),r.isTrue(e.checked,"checked"),r.isTrue(e.readonly,"readonly"),r.equal(e.foo,"bar","foo"),r.equal(e.bar,"zaz","bar"),r.equal(e.bob,'escaped"dq',"bob"),r.equal(e.frank,"escaped'sq","frank")},input2:function(){var e=n.instantiate([c.byId("ieInput2")])[0].params;r.notProperty(e,"type","type"),r.notProperty(e,"name","name"),r.notProperty(e,"value","value"),r.notProperty(e,"data-dojo-type","data-dojo-type"),r.notProperty(e,"data-dojo-props","data-dojo-props"),r.equal(e.foo,"hi","foo"),r.notProperty(e,"value","value not specified")},input3:function(){var e=n.instantiate([c.byId("ieInput3")])[0].params;r.equal(e.type,"password","type"),r.equal(e.name,"test","name"),r.equal(e.value,"123","value"),r.equal(e.class,"myClass","class"),r.equal(e.style.replace(/[ ;]/g,"").toLowerCase(),"display:block","style"),r.equal(e.tabIndex,"3","tabIndex")},textarea:function(){var e=n.instantiate([c.byId("ieTextarea")])[0].params;r.equal(e.value,"attrVal","value")},button1:function(){var e=n.instantiate([c.byId("ieButton1")])[0].params;r.isTrue(e.checked,"checked"),r.equal(e.value,"button1val","value")},button2:function(){var e=n.instantiate([c.byId("ieButton2")])[0].params;r.notProperty(e,"checked","checked"),r.notProperty(e,"value","value")},button3:function(){var e=n.instantiate([c.byId("ieButton3")])[0].params;r.isTrue(e.checked,"checked")},button4:function(){var e=n.instantiate([c.byId("ieButton4")])[0].params;r.notProperty(e,"checked")},form1:function(){var e=n.instantiate([c.byId("ieForm1")])[0].params;r.equal(e.encType,"foo","encType is specified")},form2:function(){var e=n.instantiate([c.byId("ieForm2")])[0].params;r.notProperty(e,"encType","encType not specified")},li:function(){var e=n.instantiate([c.byId("li")])[0].params;r.equal(e.value,"home")}}),e({name:"mixed attribute specification",setup:t("main"),teardown:y,mixed:function(){n.parse(c.byId("mixedContainer")),r.isObject(mixedObj,"widget created"),r.equal(mixedObj.value,"mixedValue","native attribute"),r.equal(mixedObj.custom1,999,"data-dojo-props attribute"),r.equal(mixedObj.title,"custom title","data-dojo-props overrides native")}}),e({name:"functions",setup:t("main"),teardown:y,onclick:function(){s("tests.parser.Button",null,{onClick:function(){console.log("prototype click")},constructor:function(e,t){d.mixin(this,e),this.domNode=t,i.after(this.domNode,"onclick",d.hitch(this,"onClick"))}}),buttonClicked=function(){console.log("markup click")},n.parse("functions"),r.isObject(button,"widget created"),r.isFunction(button.onClick,"created as function"),r.isTrue(buttonClicked===button.onClick,"points to specified function")}}),e({name:"parser.construct()",setup:t("main"),teardown:y,construct1:function(){n.construct(tests.parser.Class1,c.byId("objC1")),r.isObject(objC1,"widget 1 created"),r.equal(objC1.intProp,5,"objC1.intProp"),n.construct(tests.parser.Class1,c.byId("objC2")),r.isObject(objC2,"widget 2 created"),r.equal(objC2.intProp,5,"objC2.intProp")}}),e({name:"data-dojo-mixins support",setup:t("mixins",!0),teardown:y,mixins:function(){r.ok(resultMixins1,"object using data-dojo-mixins created from an already parsed type"),r.isTrue(resultMixins1.mixin1Done,"mixin1 correctly mixed in"),r.isTrue(resultMixins1.mixin2Done,"mixin2 correctly mixed in"),r.isTrue(resultMixins1.amdMixinDone,"amd mixin correctly mixed in"),r.ok(resultMixins2,"object using data-dojo-mixins created from a non parsed type"),r.isTrue(resultMixins2.classDone,"class correctly created"),r.isTrue(resultMixins2.mixin1Done,"mixin1 correctly mixed in"),r.isTrue(resultMixins2.mixin2Done,"mixin2 correctly mixed in"),r.isTrue(resultMixins2.amdMixinDone,"amd mixin correctly mixed in"),r.isTrue(resultNonDojoMixin.expectedClass,"correct class is returned for composeJS mixin"),r.equal(resultNonDojoMixin.params.length,2,"correct # of params were passed to compose JS"),r.equal(resultNonDojoMixin.params[0],tests.parser.Mixin1,"correct param 1"),r.equal(resultNonDojoMixin.params[1],tests.parser.Mixin2,"correct param 2")}}),e({name:"behavorial",setup:t("main"),teardown:y,doubleConnect:function(){Behavioral1=s(null,{constructor:function(e,t){if(u(t,"click",d.hitch(this,"onClick")),"function"!=typeof e.onClick)throw new Error("onClick not passed to constructor");d.mixin(this,e)},onClick:function(){console.log("original onnClick handler")},foo:""}),n.parse("behavioral"),behavioralClickCounter=0,u.emit(c.byId("bh1"),"click",{bubbles:!0,cancelable:!0}),r.equal(behavioralClickCounter,1,"one click event processed"),r.equal(c.byId("bh1").getAttribute("foo"),"bar","foo attribute not removed from widget DOMNode")}}),e({name:"script type=dojo/require support",setup:t("main"),teardown:y,declarativeRequire:function(){var e=this.async();n.parse("declarativeRequire").then(e.callback(function(){r.isObject(dr1,"object using MID mapped to return var"),r.equal(dr1.params.foo,"bar","parameters set on instantiation"),r.isObject(dr2,"object using MID mapped to return var"),r.equal(dr2.params.foo,"bar","parameters set on instantiation"),r.isObject(dr3,"object using fully required"),r.equal(dr3.params.foo,"bar","parameters set on instantiation"),r.equal(dr4.params.foo,2,"module loaded and executed"),r.equal(dr5.method1(1),3,"declarative script has access to parser scope")}))},contextRequire:function(){var e=this.async();n.parse("contextRequire",{contextRequire:require}).then(e.callback(function(){r.isObject(cr1,"object using relative MID mapped to return var"),r.equal(cr1.params.foo,"bar","parameters set on instantiation"),r.isObject(cr2,"object using relative MID mapped to return var"),r.equal(cr2.params.foo,"bar","parameters set on instantiation"),r.isObject(cr3,"object using relative MID mapped to return var"),r.equal(cr3.params.foo,"bar","parameters set on instantiation"),r.isObject(cr4,"object using relative MID mapped to return var"),r.equal(cr4.params.foo,"bar","parameters set on instantiation")}))}}),e({name:"promise error handling support",setup:t("main"),teardown:y,asyncError:function(){var e=this.async();n.parse("errorHandling").then(e.rejectOnError(function(){throw new Error("shouldn't get here")}),e.callback(function(e){r.equal(typeof e,"object","error object returned")}))},missingCtor:function(){var e=this.async();n.parse("missingCtor").then(e.rejectOnError(function(){throw new Error("shouldn't get here")}),e.callback(function(e){r.equal(typeof e,"object","error object returned"),r.equal(e.toString(),"Error: Unable to resolve constructor for: 'some.type'","proper error value returned")}))}})});