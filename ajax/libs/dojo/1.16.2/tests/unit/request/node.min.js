define(["intern!object","intern/chai!assert","../../../request/node","intern/dojo/node!http","intern/dojo/node!url","intern/dojo/Deferred"],function(e,n,t,r,l,o){var s;function a(e,n){return"http://localhost:8124?dataKey="+e+"&httpState="+n}e({name:"dojo/request/node",before:function(){var e=new o,c={fooBar:'{ "foo": "bar" }',invalidJson:"<not>JSON</not>"},d={error:500,success:200};return(s=r.createServer(function(e,n){var t,r,o,s,a=(t=e,r=l.parse(t.url,!0),c[r.query.dataKey]),i=(o=e,s=l.parse(o.url,!0),d[s.query.httpState]);n.writeHead(i,{"Content-Length":a.length,"Content-Type":"application/json"}),n.write(a),n.end()})).on("listening",e.resolve),s.listen(8124),e.promise},after:function(){s.close()},".get":{"successfully get a record":function(){var e=this.async();t.get(a("fooBar","success"),{handleAs:"json"}).then(e.callback(function(e){n.deepEqual(e,{foo:"bar"})}),e.reject.bind(e))},"invalid json response throws":function(){var e=this.async();t.get(a("invalidJson","success"),{handleAs:"json"}).then(e.reject.bind(e),e.callback(function(e){n.instanceOf(e,SyntaxError)}))},"http error state throws":function(){var e=this.async();t.get(a("fooBar","error"),{handleAs:"json"}).then(e.reject.bind(e),e.resolve)}}})});