define(["intern!object","intern/chai!assert","../../../request/xhr","../../../errors/RequestTimeoutError","../../../errors/CancelError","dojo/promise/all","dojo/query","require","../../../has"],function(e,o,a,t,r,s,n,c,i){var u,l=this,h="FormData"in this&&"function"==typeof FormData,p="undefined"!=typeof XMLHttpRequest&&void 0!==(new XMLHttpRequest).responseType;function f(){if("undefined"!=typeof File)try{new File}catch(e){}}e({name:"dojo/request/xhr",".get":function(){var e=a.get("/__services/request/xhr",{preventCache:!0,handleAs:"json"});return o.isFunction(e.then),o.isFunction(e.cancel),o.isObject(e.response),o.isFunction(e.response.then),o.isFunction(e.response.cancel),e.response.then(function(e){return o.strictEqual(e.data.method,"GET"),o.strictEqual(e.xhr.readyState,4),e})},".get 404":function(){var e=this.async();a.get(c.toUrl("./xhr_blarg.html"),{preventCache:!0}).response.then(e.reject,e.callback(function(e){o.strictEqual(e.response.status,404)}))},".get json with truthy value":function(){var e=this.async();a.get(c.toUrl("./support/truthy.json"),{preventCache:!0,handleAs:"json"}).then(e.callback(function(e){o.strictEqual(e,!0)}))},".get json with falsy value":function(){var e=this.async();a.get(c.toUrl("./support/falsy.json"),{preventCache:!0,handleAs:"json"}).then(e.callback(function(e){o.strictEqual(e,!1)}))},".get with progress":function(){var e=this.async();return a.get(c.toUrl("./support/truthy.json"),{handleAs:"json",preventCache:!0}).then(e.callback(function(){}),function(e){o.isTrue(!1,e)},e.callback(function(e){o.strictEqual(e.transferType,"download")})),e.promise},".get with query":function(){var e=this.async();a.get("/__services/request/xhr?color=blue",{query:{foo:["bar","baz"],thud:"thonk",xyzzy:3},handleAs:"json"}).response.then(e.callback(function(e){o.strictEqual(e.data.method,"GET");var t=e.data.query;o.ok(t.color&&t.foo&&t.foo.length&&t.thud&&t.xyzzy),o.strictEqual(t.color,"blue"),o.strictEqual(t.foo.length,2),o.strictEqual(t.thud,"thonk"),o.strictEqual(t.xyzzy,"3"),o.strictEqual(e.url,"/__services/request/xhr?color=blue&foo=bar&foo=baz&thud=thonk&xyzzy=3")}))},".post":function(){var e=this.async();a.post("/__services/request/xhr",{data:{color:"blue"},handleAs:"json"}).response.then(e.callback(function(e){o.strictEqual(e.data.method,"POST");var t=e.data.payload;o.ok(t&&t.color),o.strictEqual(t.color,"blue")}),e.reject)},".post ArrayBuffer":function(){if(i("native-arraybuffer")){for(var e=this.async(),t="foo",r=new ArrayBuffer(t.length),s=new Uint8Array(r),n=0;n<t.length;n++)s[n]=t.charCodeAt(n);a.post("/__services/request/xhr",{data:r,handleAs:"json",headers:{"Content-Type":"text/plain"}}).response.then(e.callback(function(e){o.strictEqual(e.data.method,"POST");var t=e.data.payload;o.deepEqual(t,{foo:""})}),e.reject)}else this.skip("ArrayBuffer not available")},".post Blob":function(){if(i("native-blob")){var e=this.async(),t=new Blob(["foo"],{type:"text/plain"});a.post("/__services/request/xhr",{data:t,handleAs:"json",headers:{"Content-Type":"text/plain"}}).response.then(e.callback(function(e){o.strictEqual(e.data.method,"POST");var t=e.data.payload;o.deepEqual(t,{foo:""})}),e.reject)}else this.skip("Blob not available")},".post File":function(){if(f()){var e=this.async(),t=new File(["foo"],"bar.txt",{type:"text/plain"});a.post("/__services/request/xhr",{data:t,handleAs:"json",headers:{"Content-Type":"text/plain"}}).response.then(e.callback(function(e){o.strictEqual(e.data.method,"POST");var t=e.data.payload;o.deepEqual(t,{foo:""})}),e.reject)}else this.skip("File or File constructor not available")},".post File with upload progress":function(){if(f()){var e=this.async(),t=new File(["foo"],"bar.txt",{type:"text/plain"});a.post("/__services/request/xhr",{data:t,handleAs:"json",uploadProgress:!0,query:{simulateProgress:!0},headers:{"Content-Type":"text/plain"}}).then(null,e.reject,e.callback(function(e){o.isDefined(e.xhr),o.deepEqual(e.transferType,"upload")}))}else this.skip("File or File constructor not available")},".post with query":function(){var e=this.async();a.post("/__services/request/xhr",{query:{foo:["bar","baz"],thud:"thonk",xyzzy:3},data:{color:"blue"},handleAs:"json"}).then(e.callback(function(e){o.strictEqual(e.method,"POST");var t=e.query,r=e.payload;o.ok(t),o.deepEqual(t.foo,["bar","baz"]),o.strictEqual(t.thud,"thonk"),o.strictEqual(t.xyzzy,"3"),o.ok(r),o.strictEqual(r.color,"blue")}),e.reject)},".post string payload":function(){var e=this.async();a.post("/__services/request/xhr",{data:"foo=bar&color=blue&height=average",handleAs:"json"}).then(e.callback(function(e){o.strictEqual(e.method,"POST");var t=e.payload;o.ok(t),o.strictEqual(t.foo,"bar"),o.strictEqual(t.color,"blue"),o.strictEqual(t.height,"average")}),e.reject)},".put":function(){var e=this.async();a.put("/__services/request/xhr",{query:{foo:"bar"},data:{color:"blue"},handleAs:"json"}).then(e.callback(function(e){o.strictEqual(e.method,"PUT"),o.ok(e.payload),o.strictEqual(e.payload.color,"blue"),o.ok(e.query),o.strictEqual(e.query.foo,"bar")}),e.reject)},".del":function(){var e=this.async();a.del("/__services/request/xhr",{query:{foo:"bar"},handleAs:"json"}).then(e.callback(function(e){o.strictEqual(e.method,"DELETE"),o.strictEqual(e.query.foo,"bar")}),e.reject)},timeout:function(){var e=this.async();a.get("/__services/request/xhr",{query:{delay:"3000"},timeout:1e3}).then(e.reject,e.callback(function(e){o.instanceOf(e,t)}))},cancel:function(){var e=this.async(),t=a.get("/__services/request/xhr",{query:{delay:"3000"}});t.then(e.reject,e.callback(function(e){o.instanceOf(e,r)})),t.cancel()},sync:function(){var e=!1;a.get("/__services/request/xhr",{sync:!0}).then(function(){e=!0}),o.ok(e)},"cross-domain fails":function(){var e=this.async();a.get("http://dojotoolkit.org").response.then(e.reject,function(){e.resolve(!0)})},"has Content-Type with data":function(){var e=this.async();a.post("/__services/request/xhr",{data:"testing",handleAs:"json"}).then(e.callback(function(e){o.equal(e.headers["content-type"],"application/x-www-form-urlencoded")}),e.reject)},"no Content-Type with no data":function(){var e=this.async();a.get("/__services/request/xhr",{handleAs:"json"}).then(e.callback(function(e){o.isUndefined(e.headers["content-type"])}),e.reject)},headers:function(){var e=this.async();a.get("/__services/request/xhr").response.then(e.callback(function(e){o.notEqual(e.getHeader("Content-Type"),null)}),e.reject)},"custom Content-Type":function(){var e=this.async(),t="application/x-test-xhr";function r(e){return a.post("/__services/request/xhr",{query:{"header-test":"true"},headers:e,data:"testing",handleAs:"json"})}s({lowercase:r({"content-type":t}),uppercase:r({"CONTENT-TYPE":t})}).then(e.callback(function(e){o.match(e.lowercase.headers["content-type"],/^application\/x-test-xhr(?:;.*)?$/),o.match(e.uppercase.headers["content-type"],/^application\/x-test-xhr(?:;.*)?$/)}),e.reject)},"queryable xml":function(){var e=this.async();a.get("/__services/request/xhr/xml",{handleAs:"xml"}).then(e.callback(function(e){var t=n("bar",e);o.strictEqual(t.length,2)}),e.reject)},"strip fragment":function(){var e=this.async();a.get("/__services/request/xhr?color=blue#some-hash",{handleAs:"json"}).response.then(e.callback(function(e){o.strictEqual(e.data.method,"GET"),o.strictEqual(e.data.url,"/__services/request/xhr?color=blue")}))},"form data":{setup:function(){h&&((u=new FormData).append("foo","bar"),u.append("baz","blah"))},post:function(){h||this.skip("No FormData to test");var e=this.async();a.post("/__services/request/xhr/multipart",{data:u,handleAs:"json"}).then(e.callback(function(e){o.deepEqual(e,{foo:"bar",baz:"blah"})}),e.reject)},teardown:function(){u=null}},"response type":{Blob:function(){return p||this.skip("No responseType to test"),a.get("/__services/request/xhr/responseTypeGif",{handleAs:"blob"}).then(function(e){o.strictEqual(e.constructor,Blob)})},"Blob POST":function(){return p||this.skip("No responseType to test"),a.post("/__services/request/xhr/responseTypeGif",{handleAs:"blob"}).then(function(e){o.strictEqual(e.constructor,Blob)})},ArrayBuffer:function(){if(i("native-arraybuffer")&&p)return a.get("/__services/request/xhr/responseTypeGif",{handleAs:"arraybuffer"}).then(function(e){o.strictEqual(e.constructor,ArrayBuffer)});this.skip("No responseType to test")},"ArrayBuffer POST":function(){if(i("native-arraybuffer")&&p)return a.post("/__services/request/xhr/responseTypeGif",{handleAs:"arraybuffer"}).then(function(e){o.strictEqual(e.constructor,ArrayBuffer)});this.skip("No responseType to test")},document:function(){return p||this.skip("No responseType to test"),a.get("/__services/request/xhr/responseTypeDoc",{handleAs:"document"}).then(function(e){o.strictEqual(e.constructor,document.constructor)})},"document POST":function(){return p||this.skip("No responseType to test"),a.post("/__services/request/xhr/responseTypeDoc",{handleAs:"document"}).then(function(e){o.strictEqual(e.constructor,document.constructor)})}},"Web Workers":{"from blob":function(){"URL"in l||this.skip("URL is not supported"),"Worker"in l||this.skip("Worker is not supported"),"Blob"in l||this.skip("Blob is not supported"),URL.createObjectURL||this.skip("URL.createObjectURL is not supported");var t=this.async(),e=location.origin+"/"+c.toUrl("testing"),r=location.origin+"/"+c.toUrl("./support/truthy.json"),s=new Blob(["("+function(){self.addEventListener("message",function(e){var t,r,s;e.data.baseUrl&&(t=e.data.baseUrl,r=e.data.testUrl,s=new XMLHttpRequest,dojoConfig.baseUrl=t,s.onreadystatechange=function(){if(4===s.readyState&&200===s.status){var e=new Blob([s.response],{type:"application/javascript"}),t=URL.createObjectURL(e);importScripts(t),c(["dojo/request/xhr"],function(e){e.get(r).then(function(e){if("true"!==e)throw new Error(e);self.postMessage("success")},function(e){throw e})})}},s.open("GET",t+"/dojo.js",!0),s.send())}),dojoConfig={async:!0}}.toString()+")()"],{type:"application/javascript"}),n=new Worker(URL.createObjectURL(s));n.addEventListener("error",function(e){t.reject(e)}),n.addEventListener("message",function(e){"success"===e.data?t.resolve():t.reject(e)}),n.postMessage({baseUrl:e,testUrl:r})}}})});