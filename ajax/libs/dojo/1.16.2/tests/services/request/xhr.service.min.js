define(["require","../util","intern/dojo/node!querystring","intern/dojo/node!fs"],function(o,t,i,r){function s(e,n){return t.call(r.readFile,e).then(function(e){return{status:200,headers:{"Content-Type":n},body:[e.toString()]}})}return function(r){var e=new t.Promise(function(n){function t(e){n({status:200,headers:{"Content-Type":"application/json"},body:[JSON.stringify({method:r.method,query:r.query,headers:r.headers,url:r.nodeRequest.url,payload:e||null})]})}-1<r.serviceURL.indexOf("/xml")?n({status:200,headers:{"Content-Type":"application/xml"},body:['<?xml version="1.0" encoding="UTF-8" ?>','<foo><bar baz="thonk">blargh</bar><bar>blah</bar></foo>']}):-1<r.serviceURL.indexOf("/responseTypeGif")?n(s(o.toUrl("./support/blob.gif"),"image/gif")):-1<r.serviceURL.indexOf("/responseTypeDoc")?n(s(o.toUrl("./support/document.html"),"text/html")):r.data?n(r.data.then(function(e){return{status:200,headers:{"Content-Type":"application/json"},body:[JSON.stringify(e)]}})):"GET"!==r.method?r.body.join().then(function(e){t(i.parse(e))}):t()},!0);r.query.simulateProgress&&e.progress({type:"progress"});var n=r.query.delay;return n&&(n=parseInt(n,10),e.promise=t.delay(e.promise,n)),e.promise}});