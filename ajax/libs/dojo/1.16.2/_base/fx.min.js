define(["./kernel","./config","./lang","../Evented","./Color","../aspect","../sniff","../dom","../dom-style"],function(r,n,o,e,s,i,t,u,p){var c=o.mixin,_={},a=_._Line=function(e,t){this.start=e,this.end=t};a.prototype.getValue=function(e){return(this.end-this.start)*e+this.start};var d=_.Animation=function(e){c(this,e),o.isArray(this.curve)&&(this.curve=new a(this.curve[0],this.curve[1]))};d.prototype=new e,o.extend(d,{duration:350,repeat:0,rate:20,_percent:0,_startRepeatCount:0,_getStep:function(){var e=this._percent,t=this.easing;return t?t(e):e},_fire:function(t,e){var r=e||[];if(this[t])if(n.debugAtAllCosts)this[t].apply(this,r);else try{this[t].apply(this,r)}catch(e){console.error("exception in animation handler for:",t),console.error(e)}return this},play:function(e,t){var r=this;if(r._delayTimer&&r._clearTimer(),t)r._stopTimer(),r._active=r._paused=!1,r._percent=0;else if(r._active&&!r._paused)return r;r._fire("beforeBegin",[r.node]);var n=e||r.delay,i=o.hitch(r,"_play",t);return 0<n?r._delayTimer=setTimeout(i,n):i(),r},_play:function(e){var t=this;t._delayTimer&&t._clearTimer(),t._startTime=(new Date).valueOf(),t._paused&&(t._startTime-=t.duration*t._percent),t._active=!0,t._paused=!1;var r=t.curve.getValue(t._getStep());return t._percent||(t._startRepeatCount||(t._startRepeatCount=t.repeat),t._fire("onBegin",[r])),t._fire("onPlay",[r]),t._cycle(),t},pause:function(){var e=this;return e._delayTimer&&e._clearTimer(),e._stopTimer(),e._active&&(e._paused=!0,e._fire("onPause",[e.curve.getValue(e._getStep())])),e},gotoPercent:function(e,t){var r=this;return r._stopTimer(),r._active=r._paused=!0,r._percent=e,t&&r.play(),r},stop:function(e){var t=this;return t._delayTimer&&t._clearTimer(),t._timer&&(t._stopTimer(),e&&(t._percent=1),t._fire("onStop",[t.curve.getValue(t._getStep())]),t._active=t._paused=!1),t},destroy:function(){this.stop()},status:function(){return this._active?this._paused?"paused":"playing":"stopped"},_cycle:function(){var e=this;if(e._active){var t=(new Date).valueOf(),r=0===e.duration?1:(t-e._startTime)/e.duration;1<=r&&(r=1),e._percent=r,e.easing&&(r=e.easing(r)),e._fire("onAnimate",[e.curve.getValue(r)]),e._percent<1?e._startTimer():(e._active=!1,0<e.repeat?(e.repeat--,e.play(null,!0)):-1==e.repeat?e.play(null,!0):e._startRepeatCount&&(e.repeat=e._startRepeatCount,e._startRepeatCount=0),e._percent=0,e._fire("onEnd",[e.node]),e.repeat||e._stopTimer())}return e},_clearTimer:function(){clearTimeout(this._delayTimer),delete this._delayTimer}});var f=0,l=null,h={run:function(){}};o.extend(d,{_startTimer:function(){this._timer||(this._timer=i.after(h,"run",o.hitch(this,"_cycle"),!0),f++),l=l||setInterval(o.hitch(h,"run"),this.rate)},_stopTimer:function(){this._timer&&(this._timer.remove(),this._timer=null,f--),f<=0&&(clearInterval(l),l=null,f=0)}});var v=t("ie")?function(e){var t=e.style;t.width.length||"auto"!=p.get(e,"width")||(t.width="auto")}:function(){};_._fade=function(e){e.node=u.byId(e.node);var t=c({properties:{}},e),r=t.properties.opacity={};r.start="start"in t?t.start:function(){return+p.get(t.node,"opacity")||0},r.end=t.end;var n=_.animateProperty(t);return i.after(n,"beforeBegin",o.partial(v,t.node),!0),n},_.fadeIn=function(e){return _._fade(c({end:1},e))},_.fadeOut=function(e){return _._fade(c({end:0},e))},_._defaultEasing=function(e){return.5+Math.sin((e+1.5)*Math.PI)/2};function m(e){for(var t in this._properties=e){var r=e[t];r.start instanceof s&&(r.tempColor=new s)}}return m.prototype.getValue=function(e){var t={};for(var r in this._properties){var n=this._properties[r],i=n.start;i instanceof s?t[r]=s.blendColors(i,n.end,e,n.tempColor).toCss():o.isArray(i)||(t[r]=(n.end-i)*e+i+("opacity"!=r?n.units||"px":0))}return t},_.animateProperty=function(e){var a=e.node=u.byId(e.node);e.easing||(e.easing=r._defaultEasing);var t=new d(e);return i.after(t,"beforeBegin",o.hitch(t,function(){var e={};for(var t in this.properties){"width"!=t&&"height"!=t||(this.node.display="block");var r=this.properties[t];o.isFunction(r)&&(r=r(a)),r=e[t]=c({},o.isObject(r)?r:{end:r}),o.isFunction(r.start)&&(r.start=r.start(a)),o.isFunction(r.end)&&(r.end=r.end(a));var n=0<=t.toLowerCase().indexOf("color");function i(e,t){var r={height:e.offsetHeight,width:e.offsetWidth}[t];return void 0!==r?r:(r=p.get(e,t),"opacity"==t?+r:n?r:parseFloat(r))}"end"in r?"start"in r||(r.start=i(a,t)):r.end=i(a,t),n?(r.start=new s(r.start),r.end=new s(r.end)):r.start="opacity"==t?+r.start:parseFloat(r.start)}this.curve=new m(e)}),!0),i.after(t,"onAnimate",o.hitch(p,"set",t.node),!0),t},_.anim=function(e,t,r,n,i,a){return _.animateProperty({node:e,duration:r||d.prototype.duration,properties:t,easing:n,onEnd:i}).play(a||0)},t("extend-dojo")&&(c(r,_),r._Animation=d),_});