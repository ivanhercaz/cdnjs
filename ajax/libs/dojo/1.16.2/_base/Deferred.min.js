define(["./kernel","../Deferred","../promise/Promise","../errors/CancelError","../has","./lang","../when"],function(t,u,e,v,p,j,r){function b(){}var m=Object.freeze||function(){},g=t.Deferred=function(r){var s,c,t,n,o,d,a,f=this.promise=new e;function i(e){if(c)throw new Error("This deferred has already been resolved");s=e,c=!0,h()}function h(){for(var e;!e&&a;){var r=a;a=a.next,(e=r.progress==b)&&(c=!1);var t=o?r.error:r.resolved;if(p("config-useDeferredInstrumentation")&&o&&u.instrumentRejected&&u.instrumentRejected(s,!!t),t)try{var n=t(s);if(n&&"function"==typeof n.then){n.then(j.hitch(r.deferred,"resolve"),j.hitch(r.deferred,"reject"),j.hitch(r.deferred,"progress"));continue}var i=e&&void 0===n;e&&!i&&(o=n instanceof Error),r.deferred[i&&o?"reject":"resolve"](i?s:n)}catch(e){r.deferred.reject(e)}else o?r.deferred.reject(s):r.deferred.resolve(s)}}this.isResolved=f.isResolved=function(){return 0==n},this.isRejected=f.isRejected=function(){return 1==n},this.isFulfilled=f.isFulfilled=function(){return 0<=n},this.isCanceled=f.isCanceled=function(){return t},this.resolve=this.callback=function(e){this.fired=n=0,this.results=[e,null],i(e)},this.reject=this.errback=function(e){o=!0,this.fired=n=1,p("config-useDeferredInstrumentation")&&u.instrumentRejected&&u.instrumentRejected(e,!!a),i(e),this.results=[null,e]},this.progress=function(e){for(var r=a;r;){var t=r.progress;t&&t(e),r=r.next}},this.addCallbacks=function(e,r){return this.then(e,r,b),this},f.then=this.then=function(e,r,t){var n=t==b?this:new g(f.cancel),i={resolved:e,error:r,progress:t,deferred:n};return a?d=d.next=i:a=d=i,c&&h(),n.promise};var l=this;f.cancel=this.cancel=function(){if(!c){var e=r&&r(l);c||(e instanceof Error||(e=new v(e)),e.log=!1,l.reject(e))}t=!0},m(f)};return j.extend(g,{addCallback:function(e){return this.addCallbacks(j.hitch.apply(t,arguments))},addErrback:function(e){return this.addCallbacks(null,j.hitch.apply(t,arguments))},addBoth:function(e){var r=j.hitch.apply(t,arguments);return this.addCallbacks(r,r)},fired:-1}),g.when=t.when=r,g});