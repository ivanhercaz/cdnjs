define(["./kernel","./sniff","require","../io-query","../dom","../dom-form","./Deferred","./config","./json","./lang","./array","../on","../aspect","../request/watch","../request/xhr","../request/util"],function(h,n,e,p,x,y,m,i,s,b,u,r,o,a,c,t){h._xhrObj=c._create;var T=h.config;h.objectToQuery=p.objectToQuery,h.queryToObject=p.queryToObject,h.fieldToObject=y.fieldToObject,h.formToObject=y.toObject,h.formToQuery=y.toQuery,h.formToJson=y.toJson,h._blockAsync=!1;var l=h._contentHandlers=h.contentHandlers={text:function(e){return e.responseText},json:function(e){return s.fromJson(e.responseText||null)},"json-comment-filtered":function(e){i.useCommentedJson||console.warn("Consider using the standard mimetype:application/json. json-commenting can introduce security issues. To decrease the chances of hijacking, use the standard the 'json' handler and prefix your json with: {}&&\nUse djConfig.useCommentedJson=true to turn off this message.");var r=e.responseText,o=r.indexOf("/*"),t=r.lastIndexOf("*/");if(-1==o||-1==t)throw new Error("JSON was not comment filtered");return s.fromJson(r.substring(o+2,t))},javascript:function(e){return h.eval(e.responseText)},xml:function(o){var t=o.responseXML;if(t&&n("dom-qsa2.1")&&!t.querySelectorAll&&n("dom-parser")&&(t=(new DOMParser).parseFromString(o.responseText,"application/xml")),n("ie")&&(!t||!t.documentElement)){function e(e){return"MSXML"+e+".DOMDocument"}var r=["Microsoft.XMLDOM",e(6),e(4),e(3),e(2)];u.some(r,function(e){try{var r=new ActiveXObject(e);r.async=!1,r.loadXML(o.responseText),t=r}catch(e){return!1}return!0})}return t},"json-comment-optional":function(e){return e.responseText&&/^[^{\[]*\/\*/.test(e.responseText)?l["json-comment-filtered"](e):l.json(e)}};h._ioSetArgs=function(r,o,e,t){var n={args:r,url:r.url},i=null;if(r.form){var s=x.byId(r.form),u=s.getAttributeNode("action");n.url=n.url||(u?u.value:h.doc?h.doc.URL:null),i=y.toObject(s)}var a={};i&&b.mixin(a,i),r.content&&b.mixin(a,r.content),r.preventCache&&(a["dojo.preventCache"]=(new Date).valueOf()),n.query=p.objectToQuery(a),n.handleAs=r.handleAs||"text";var c=new m(function(e){e.canceled=!0,o&&o(e);var r=e.ioArgs.error;return r||((r=new Error("request cancelled")).dojoType="cancel",e.ioArgs.error=r),r});c.addCallback(e);var l=r.load;l&&b.isFunction(l)&&c.addCallback(function(e){return l.call(r,e,n)});var d=r.error;d&&b.isFunction(d)&&c.addErrback(function(e){return d.call(r,e,n)});var f=r.handle;return f&&b.isFunction(f)&&c.addBoth(function(e){return f.call(r,e,n)}),c.addErrback(function(e){return t(e,c)}),T.ioPublish&&h.publish&&!1!==n.args.ioPublish&&(c.addCallbacks(function(e){return h.publish("/dojo/io/load",[c,e]),e},function(e){return h.publish("/dojo/io/error",[c,e]),e}),c.addBoth(function(e){return h.publish("/dojo/io/done",[c,e]),e})),c.ioArgs=n,c};function d(e){var r=l[e.ioArgs.handleAs](e.ioArgs.xhr);return void 0===r?null:r}function f(e,r){return r.ioArgs.args.failOk||console.error(e),e}function j(e){g<=0&&(g=0,T.ioPublish&&h.publish&&(!e||e&&!1!==e.ioArgs.args.ioPublish)&&h.publish("/dojo/io/stop"))}var g=0;o.after(a,"_onAction",function(){--g}),o.after(a,"_onInFlight",j),h._ioCancelAll=a.cancelAll,h._ioNotifyStart=function(e){T.ioPublish&&h.publish&&!1!==e.ioArgs.args.ioPublish&&(g||h.publish("/dojo/io/start"),g+=1,h.publish("/dojo/io/send",[e]))},h._ioWatch=function(r,o,t,n){r.ioArgs.options=r.ioArgs.args;b.mixin(r,{response:r.ioArgs,isValid:function(e){return o(r)},isReady:function(e){return t(r)},handleResponse:function(e){return n(r)}}),a(r),j(r)};return h._ioAddQueryToUrl=function(e){e.query.length&&(e.url+=(-1==e.url.indexOf("?")?"?":"&")+e.query,e.query=null)},h.xhr=function(e,r,o){var t,n=h._ioSetArgs(r,function(e){t&&t.cancel()},d,f),i=n.ioArgs;"postData"in r?i.query=r.postData:"putData"in r?i.query=r.putData:"rawBody"in r?i.query=r.rawBody:(2<arguments.length&&!o||-1==="POST|PUT".indexOf(e.toUpperCase()))&&h._ioAddQueryToUrl(i);var s={method:e,handleAs:"text",timeout:r.timeout,withCredentials:r.withCredentials,ioArgs:i};void 0!==r.headers&&(s.headers=r.headers),void 0!==r.contentType&&(s.headers||(s.headers={}),s.headers["Content-Type"]=r.contentType),void 0!==i.query&&(s.data=i.query),void 0!==r.sync&&(s.sync=r.sync),h._ioNotifyStart(n);try{t=c(i.url,s,!0)}catch(e){return n.cancel(),n}return n.ioArgs.xhr=t.response.xhr,t.then(function(){n.resolve(n)}).otherwise(function(e){(i.error=e).response&&(e.status=e.response.status,e.responseText=e.response.text,e.xhr=e.response.xhr),n.reject(e)}),n},h.xhrGet=function(e){return h.xhr("GET",e)},h.rawXhrPost=h.xhrPost=function(e){return h.xhr("POST",e,!0)},h.rawXhrPut=h.xhrPut=function(e){return h.xhr("PUT",e,!0)},h.xhrDelete=function(e){return h.xhr("DELETE",e)},h._isDocumentOk=function(e){return t.checkStatus(e.status)},h._getText=function(e){var r;return h.xhrGet({url:e,sync:!0,load:function(e){r=e}}),r},b.mixin(h.xhr,{_xhrObj:h._xhrObj,fieldToObject:y.fieldToObject,formToObject:y.toObject,objectToQuery:p.objectToQuery,formToQuery:y.toQuery,formToJson:y.toJson,queryToObject:p.queryToObject,contentHandlers:l,_ioSetArgs:h._ioSetArgs,_ioCancelAll:h._ioCancelAll,_ioNotifyStart:h._ioNotifyStart,_ioWatch:h._ioWatch,_ioAddQueryToUrl:h._ioAddQueryToUrl,_isDocumentOk:h._isDocumentOk,_getText:h._getText,get:h.xhrGet,post:h.xhrPost,put:h.xhrPut,del:h.xhrDelete}),h.xhr});