define(["./kernel","../on","../topic","../aspect","./event","../mouse","./sniff","./lang","../keys"],function(f,y,r,l,e,h,i,p){i.add("events-keypress-typed",function(){var e={charCode:0};try{((e=document.createEvent("KeyboardEvent")).initKeyboardEvent||e.initKeyEvent).call(e,"keypress",!0,!0,null,!1,!1,!1,!1,9,3)}catch(e){}return 0==e.charCode&&!i("opera")});function a(e,n){var t=p.mixin({},e,n);return c(t),t.preventDefault=function(){e.preventDefault()},t.stopPropagation=function(){e.stopPropagation()},t}var v,u={106:42,111:47,186:59,187:43,188:44,189:45,190:46,191:47,192:96,219:91,220:92,221:93,222:39,229:113},n=i("mac")?"metaKey":"ctrlKey";function c(e){e.keyChar=e.charCode?String.fromCharCode(e.charCode):"",e.charOrCode=e.keyChar||e.keyCode}if(i("events-keypress-typed")){v=function(e,o){var n=y(e,"keydown",function(e){var n=e.keyCode,t=13!=n&&32!=n&&(27!=n||!i("ie"))&&(n<48||90<n)&&(n<96||111<n)&&(n<186||192<n)&&(n<219||222<n)&&229!=n;if(t||e.ctrlKey){var r=t?0:n;if(e.ctrlKey){if(3==n||13==n)return o.call(e.currentTarget,e);95<r&&r<106?r-=48:!e.shiftKey&&65<=r&&r<=90?r+=32:r=u[r]||r}var c=a(e,{type:"keypress",faux:!0,charCode:r});o.call(e.currentTarget,c),i("ie")&&function(e,n){try{e.keyCode=n}catch(e){return}}(e,c.keyCode)}}),t=y(e,"keypress",function(e){var n=e.charCode;return e=a(e,{charCode:n=32<=n?n:0,faux:!0}),o.call(this,e)});return{remove:function(){n.remove(),t.remove()}}}}else v=i("opera")?function(e,t){return y(e,"keypress",function(e){var n=e.which;return 3==n&&(n=99),n=n<32&&!e.shiftKey?0:n,e.ctrlKey&&!e.shiftKey&&65<=n&&n<=90&&(n+=32),t.call(this,a(e,{charCode:n}))})}:function(e,n){return y(e,"keypress",function(e){return c(e),n.call(this,e)})};var o={_keypress:v,connect:function(e,n,t,r,c){var o=arguments,i=[],a=0;i.push("string"==typeof o[0]?null:o[a++],o[a++]);var u=o[a+1];i.push("string"==typeof u||"function"==typeof u?o[a++]:null,o[a++]);for(var s=o.length;a<s;a++)i.push(o[a]);return function(e,n,t,r,c){if(r=p.hitch(t,r),!e||!e.addEventListener&&!e.attachEvent)return l.after(e||f.global,n,r,!0);if("string"==typeof n&&"on"==n.substring(0,2)&&(n=n.substring(2)),e=e||f.global,!c)switch(n){case"keypress":n=v;break;case"mouseenter":n=h.enter;break;case"mouseleave":n=h.leave}return y(e,n,r,c)}.apply(this,i)},disconnect:function(e){e&&e.remove()},subscribe:function(e,n,t){return r.subscribe(e,p.hitch(n,t))},publish:function(e,n){return r.publish.apply(r,[e].concat(n))},connectPublisher:function(e,n,t){function r(){o.publish(e,arguments)}return t?o.connect(n,t,r):o.connect(n,r)},isCopyKey:function(e){return e[n]}};return o.unsubscribe=o.disconnect,i("extend-dojo")&&p.mixin(f,o),o});