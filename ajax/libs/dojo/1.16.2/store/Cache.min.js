define(["../_base/lang","../when"],function(e,i){function n(r,u,o){return o=o||{},e.delegate(r,{query:function(e,n){var t=r.query(e,n);return t.forEach(function(e){o.isLoaded&&!o.isLoaded(e)||u.put(e)}),t},queryEngine:r.queryEngine||u.queryEngine,get:function(n,t){return i(u.get(n),function(e){return e||i(r.get(n,t),function(e){return e&&u.put(e,{id:n}),e})})},add:function(n,t){return i(r.add(n,t),function(e){return u.add(e&&"object"==typeof e?e:n,t),e})},put:function(n,t){return u.remove(t&&t.id||this.getIdentity(n)),i(r.put(n,t),function(e){return u.put(e&&"object"==typeof e?e:n,t),e})},remove:function(n,t){return i(r.remove(n,t),function(e){return u.remove(n,t)})},evict:function(e){return u.remove(e)}})}return e.setObject("dojo.store.Cache",n),n});