define(["../_base/kernel","../_base/lang","../when","../_base/array"],function(e,f,u,q){function t(m){var x,a=[],O=0;(m=f.delegate(m)).notify=function(e,t){O++;for(var n=a.slice(),r=0,i=n.length;r<i;r++)n[r](e,t)};var o,i=m.query;function e(r,i){var a=m[r];a&&(m[r]=function(t){var n;if("put"===r&&(n=m.getIdentity(t)),o)return a.apply(this,arguments);o=!0;try{var e=a.apply(this,arguments);return u(e,function(e){i("object"==typeof e&&e||t,n)}),e}finally{o=!1}})}return m.query=function(e,p){p=p||{};var n=i.apply(this,arguments);if(n&&n.forEach){var t=f.mixin({},p);delete t.start,delete t.count;var r,h=m.queryEngine&&m.queryEngine(e,t),g=O,b=[];n.observe=function(t,d){1==b.push(t)&&a.push(r=function(v,y){u(n,function(e){var t,n,r,i=e.length!=p.count;if(++g!=O)throw new Error("Query is out of date, you must observe() the query prior to any data modifications");var a,o=-1,f=-1;if(y!==x){var u=[].concat(e);for(h&&!v&&(u=h(e)),t=0,n=e.length;t<n;t++){var c=e[t];if(m.getIdentity(c)==y){if(u.indexOf(c)<0)continue;a=c,o=t,!h&&v||e.splice(t,1);break}}}if(h){if(v&&(h.matches?h.matches(v):h([v]).length)){var s=-1<o?o:e.length;e.splice(s,0,v),f=q.indexOf(h(e),v),e.splice(s,1),p.start&&0==f||!i&&f==e.length?f=-1:e.splice(f,0,v)}}else v&&(y!==x?f=o:p.start||(f=m.defaultIndex||0,e.splice(f,0,v)));if((-1<o||-1<f)&&(d||!h||o!=f)){var l=b.slice();for(t=0;r=l[t];t++)r(v||a,o,f)}})});var e={};return e.remove=e.cancel=function(){var e=q.indexOf(b,t);-1<e&&(b.splice(e,1),b.length||a.splice(q.indexOf(a,r),1))},e}}return n},e("put",function(e,t){m.notify(e,t)}),e("add",function(e){m.notify(e)}),e("remove",function(e){m.notify(void 0,e)}),m}return f.setObject("dojo.store.Observable",t),t});