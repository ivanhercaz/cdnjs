define(["../_base/xhr","../_base/lang","../json","../_base/declare","./util/QueryResults"],function(h,c,n,e,u){return e("dojo.store.JsonRest",null,{constructor:function(t){this.headers={},e.safeMixin(this,t)},headers:{},target:"",idProperty:"id",ascendingPrefix:"+",descendingPrefix:"-",_getTarget:function(t){var e=this.target;return void 0!==t&&("/"==e.charAt(e.length-1)||"="==e.charAt(e.length-1)?e+=t:e+="/"+t),e},get:function(t,e){e=e||{};var r=c.mixin({Accept:this.accepts},this.headers,e.headers||e);return h("GET",{url:this._getTarget(t),handleAs:"json",headers:r,timeout:e&&e.timeout})},accepts:"application/javascript, application/json",getIdentity:function(t){return t[this.idProperty]},put:function(t,e){var r="id"in(e=e||{})?e.id:this.getIdentity(t);return h(void 0!==r&&!e.incremental?"PUT":"POST",{url:this._getTarget(r),postData:n.stringify(t),handleAs:"json",headers:c.mixin({"Content-Type":"application/json",Accept:this.accepts,"If-Match":!0===e.overwrite?"*":null,"If-None-Match":!1===e.overwrite?"*":null},this.headers,e.headers),timeout:e&&e.timeout})},add:function(t,e){return(e=e||{}).overwrite=!1,this.put(t,e)},remove:function(t,e){return e=e||{},h("DELETE",{url:this._getTarget(t),headers:c.mixin({},this.headers,e.headers),timeout:e&&e.timeout})},query:function(t,e){e=e||{};var r=c.mixin({Accept:this.accepts},this.headers,e.headers),n=-1<this.target.indexOf("?");if((t=t||"")&&"object"==typeof t&&(t=(t=h.objectToQuery(t))?(n?"&":"?")+t:""),(0<=e.start||0<=e.count)&&(r["X-Range"]="items="+(e.start||"0")+"-"+("count"in e&&e.count!=1/0?e.count+(e.start||0)-1:""),this.rangeParam?(t+=(t||n?"&":"?")+this.rangeParam+"="+r["X-Range"],n=!0):r.Range=r["X-Range"]),e&&e.sort){var i=this.sortParam;t+=(t||n?"&":"?")+(i?i+"=":"sort(");for(var a=0;a<e.sort.length;a++){var s=e.sort[a];t+=(0<a?",":"")+(s.descending?this.descendingPrefix:this.ascendingPrefix)+encodeURIComponent(s.attribute)}i||(t+=")")}var o=h("GET",{url:this.target+(t||""),handleAs:"json",headers:r,timeout:e&&e.timeout});return o.total=o.then(function(){var t=o.ioArgs.xhr.getResponseHeader("Content-Range");return(t=(t=t||o.ioArgs.xhr.getResponseHeader("X-Content-Range"))&&t.match(/\/(.*)/))&&+t[1]}),u(o)}})});