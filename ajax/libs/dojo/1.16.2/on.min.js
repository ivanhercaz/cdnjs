define(["./has!dom-addeventlistener?:./aspect","./_base/kernel","./sniff"],function(c,i,u){"use strict";if(u("dom")){var e=window.ScriptEngineMajorVersion;u.add("jscript",e&&e()+ScriptEngineMinorVersion()/10),u.add("event-orientationchange",u("touch")&&!u("android")),u.add("event-stopimmediatepropagation",window.Event&&!!window.Event.prototype&&!!window.Event.prototype.stopImmediatePropagation),u.add("event-focusin",function(e,t,n){return"onfocusin"in n}),u("touch")&&u.add("touch-can-modify-event-delegate",function(){function e(){}e.prototype=document.createEvent("MouseEvents");try{var t=new e;return(t.target=null)===t.target}catch(e){return!1}})}var f=function(e,t,n,r){return"function"!=typeof e.on||"function"==typeof t||e.nodeType?f.parse(e,t,n,o,r,this):e.on(t,n)};f.pausable=function(e,t,n,r){var o,i=f(e,t,function(){if(!o)return n.apply(this,arguments)},r);return i.pause=function(){o=!0},i.resume=function(){o=!1},i},f.once=function(e,t,n,r){var o=f(e,t,function(){return o.remove(),n.apply(this,arguments)});return o},f.parse=function(e,t,n,r,o,i){var a;if(t.call)return t.call(i,e,n);if(t instanceof Array?a=t:-1<t.indexOf(",")&&(a=t.split(/\s*,\s*/)),a){for(var c,u=[],s=0;c=a[s++];)u.push(f.parse(e,c,n,r,o,i));return u.remove=function(){for(var e=0;e<u.length;e++)u[e].remove()},u}return r(e,t,n,o,i)};var s=/^touch/;function o(e,t,n,r,o){var i=t.match(/(.*):(.*)/);if(i)return t=i[2],i=i[1],f.selector(i,t).call(o,e,n);if(u("touch")&&(s.test(t)&&(n=C(n)),u("event-orientationchange")||"orientationchange"!=t||(t="resize",e=window,n=C(n))),h&&(n=h(n)),e.addEventListener){var a=t in v,c=a?v[t]:t;return e.addEventListener(c,n,a),{remove:function(){e.removeEventListener(c,n,a)}}}if(t="on"+t,w&&e.attachEvent)return w(e,t,n);throw new Error("Target must be an event emitter")}function d(){this.cancelable=!1,this.defaultPrevented=!0}function l(){this.bubbles=!1}f.matches=function(e,t,n,r,o){for(o=o&&"function"==typeof o.matches?o:i.query,r=!1!==r,1!=e.nodeType&&(e=e.parentNode);!o.matches(e,t,n);)if(e==n||!1===r||!(e=e.parentNode)||1!=e.nodeType)return!1;return e},f.selector=function(i,a,c){return function(t,n){var r="function"==typeof i?{matches:i}:this,e=a.bubble;function o(e){return f.matches(e,i,t,c,r)}return e?f(t,e(o),n):f(t,a,function(e){var t=o(e.target);if(t)return e.selectorTarget=t,n.call(t,e)})}};var p=[].slice,a=f.emit=function(e,t,n){var r=p.call(arguments,2),o="on"+t;if("parentNode"in e){var i=r[0]={};for(var a in n)i[a]=n[a];i.preventDefault=d,i.stopPropagation=l,i.target=e,i.type=t,n=i}for(;e[o]&&e[o].apply(e,r),n&&n.bubbles&&(e=e.parentNode););return n&&n.cancelable&&n},v=u("event-focusin")?{}:{focusin:"focus",focusout:"blur"};if(!u("event-stopimmediatepropagation"))var n=function(){this.immediatelyStopped=!0,this.modified=!0},h=function(t){return function(e){if(!e.immediatelyStopped)return e.stopImmediatePropagation=n,t.apply(this,arguments)}};if(u("dom-addeventlistener"))f.emit=function(e,t,n){if(e.dispatchEvent&&document.createEvent){var r=(e.ownerDocument||document).createEvent("HTMLEvents");for(var o in r.initEvent(t,!!n.bubbles,!!n.cancelable),n)o in r||(r[o]=n[o]);return e.dispatchEvent(r)&&r}return a.apply(f,arguments)};else{f._fixEvent=function(e,t){e=e||(t&&(t.ownerDocument||t.document||t).parentWindow||window).event;if(!e)return e;try{m&&e.type==m.type&&e.srcElement==m.target&&(e=m)}catch(e){}if(!e.target)switch(e.target=e.srcElement,e.currentTarget=t||e.srcElement,"mouseover"==e.type&&(e.relatedTarget=e.fromElement),"mouseout"==e.type&&(e.relatedTarget=e.toElement),e.stopPropagation||(e.stopPropagation=g,e.preventDefault=E),e.type){case"keypress":var n="charCode"in e?e.charCode:e.keyCode;10==n?(n=0,e.keyCode=13):13==n||27==n?n=0:3==n&&(n=99),e.charCode=n,r(e)}return e};var m,y=function(e){this.handle=e};y.prototype.remove=function(){delete _dojoIEListeners_[this.handle]};var w=function(e,t,n){var r;if(r=n,n=function(e){e=f._fixEvent(e,this);var t=r.call(this,e);return e.modified&&(m||setTimeout(function(){m=null}),m=e),t},!((e.ownerDocument?e.ownerDocument.parentWindow:e.parentWindow||e.window||window)!=top||u("jscript")<5.8)||u("config-_allow_leaks"))return c.after(e,t,n,!0);"undefined"==typeof _dojoIEListeners_&&(_dojoIEListeners_=[]);var o,i=e[t];if(!i||!i.listeners){var a=i;(i=Function("event","var callee = arguments.callee; for(var i = 0; i<callee.listeners.length; i++){var listener = _dojoIEListeners_[callee.listeners[i]]; if(listener){listener.call(this,event);}}")).listeners=[],(e[t]=i).global=this,a&&i.listeners.push(_dojoIEListeners_.push(a)-1)}return i.listeners.push(o=i.global._dojoIEListeners_.push(n)-1),new y(o)},r=function(e){e.keyChar=e.charCode?String.fromCharCode(e.charCode):"",e.charOrCode=e.keyChar||e.keyCode},g=function(){this.cancelBubble=!0},E=f._preventDefault=function(){if(this.bubbledKeyCode=this.keyCode,this.ctrlKey)try{this.keyCode=0}catch(e){}this.defaultPrevented=!0,this.returnValue=!1,this.modified=!0}}if(u("touch"))var b=function(){},_=window.orientation,C=function(a){return function(e){var t=e.corrected;if(!t){var n=e.type;try{delete e.type}catch(e){}if(e.type){if(u("touch-can-modify-event-delegate"))b.prototype=e,t=new b;else for(var r in t={},e)t[r]=e[r];t.preventDefault=function(){e.preventDefault()},t.stopPropagation=function(){e.stopPropagation()}}else(t=e).type=n;if(e.corrected=t,"resize"==n)return _==window.orientation?null:(_=window.orientation,t.type="orientationchange",a.call(this,t));if("rotation"in t||(t.rotation=0,t.scale=1),window.TouchEvent&&e instanceof TouchEvent){var o=t.changedTouches[0];for(var i in o)delete t[i],t[i]=o[i]}}return a.call(this,t)}};return f});