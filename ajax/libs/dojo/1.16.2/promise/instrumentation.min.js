define(["./tracer","../has","../_base/lang","../_base/array"],function(r,o,s,i){function c(e,t,n){if(!e||!1!==e.log){var r="";e&&e.stack&&(r+=e.stack),t&&t.stack&&(r+="\n    ----------------------------------------\n    rejected"+t.stack.split("\n").slice(1).join("\n").replace(/^\s+/," ")),n&&n.stack&&(r+="\n    ----------------------------------------\n"+n.stack),console.error(e,r)}}function a(e,t,n,r){t||c(e,n,r)}o.add("config-useDeferredInstrumentation","report-unhandled-rejections");var d=[],u=!1,f=1e3;function l(t,n,e,r){i.some(d,function(e){if(e.error===t)return n&&(e.handled=!0),!0})||d.push({error:t,rejection:e,handled:n,deferred:r,timestamp:(new Date).getTime()}),u=u||setTimeout(h,f)}function h(){var e=(new Date).getTime(),t=e-f;d=i.filter(d,function(e){return!(e.timestamp<t)||(e.handled||c(e.error,e.rejection,e.deferred),!1)}),u=!!d.length&&setTimeout(h,d[0].timestamp+f-e)}return function(e){var t=o("config-useDeferredInstrumentation");if(t){r.on("resolved",s.hitch(console,"log","resolved")),r.on("rejected",s.hitch(console,"log","rejected")),r.on("progress",s.hitch(console,"log","progress"));var n=[];if("string"==typeof t&&(t=(n=t.split(",")).shift()),"report-rejections"===t)e.instrumentRejected=a;else{if("report-unhandled-rejections"!==t&&!0!==t&&1!==t)throw new Error("Unsupported instrumentation usage <"+t+">");e.instrumentRejected=l,f=parseInt(n[0],10)||f}}}});