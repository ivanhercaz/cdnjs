define(["../_base/array","../_base/declare","../_base/kernel","../_base/lang","../_base/window","../dom","../dom-class","../dom-construct","../Evented","../has","../on","../query","../touch","./common"],function(t,e,a,s,n,r,i,o,d,h,u,c,l,p){var f=e("dojo.dnd.Container",d,{skipForm:!1,allowNested:!1,constructor:function(t,e){this.node=r.byId(t),e=e||{},this.creator=e.creator||null,this.skipForm=e.skipForm,this.parent=e.dropParent&&r.byId(e.dropParent),this.map={},this.current=null,this.containerState="",i.add(this.node,"dojoDndContainer"),e&&e._skipStartup||this.startup(),this.events=[u(this.node,l.over,s.hitch(this,"onMouseOver")),u(this.node,l.out,s.hitch(this,"onMouseOut")),u(this.node,"dragstart",s.hitch(this,"onSelectStart")),u(this.node,"selectstart",s.hitch(this,"onSelectStart"))]},creator:function(){},getItem:function(t){return this.map[t]},setItem:function(t,e){this.map[t]=e},delItem:function(t){delete this.map[t]},forInItems:function(t,e){e=e||a.global;var n=this.map,r=p._empty;for(var i in n)i in r||t.call(e,n[i],i,this);return e},clearItems:function(){this.map={}},getAllNodes:function(){return c((this.allowNested?"":"> ")+".dojoDndItem",this.parent)},sync:function(){var i={};return this.getAllNodes().forEach(function(t){if(t.id){var e=this.getItem(t.id);if(e)return void(i[t.id]=e)}else t.id=p.getUniqueId();var n=t.getAttribute("dndType"),r=t.getAttribute("dndData");i[t.id]={data:r||t.innerHTML,type:n?n.split(/\s*,\s*/):["text"]}},this),this.map=i,this},insertNodes:function(t,e,n){var r,i;if(n=this.parent.firstChild?e?n||this.parent.firstChild:n&&n.nextSibling:null)for(r=0;r<t.length;++r)i=this._normalizedCreator(t[r]),this.setItem(i.node.id,{data:i.data,type:i.type}),n.parentNode.insertBefore(i.node,n);else for(r=0;r<t.length;++r)i=this._normalizedCreator(t[r]),this.setItem(i.node.id,{data:i.data,type:i.type}),this.parent.appendChild(i.node);return this},destroy:function(){t.forEach(this.events,function(t){t.remove()}),this.clearItems(),this.node=this.parent=this.current=null},markupFactory:function(t,e,n){return t._skipStartup=!0,new n(e,t)},startup:function(){if(!this.parent&&(this.parent=this.node,"table"==this.parent.tagName.toLowerCase())){var t=this.parent.getElementsByTagName("tbody");t&&t.length&&(this.parent=t[0])}this.defaultCreator=p._defaultCreator(this.parent),this.sync()},onMouseOver:function(t){for(var e=t.relatedTarget;e&&e!=this.node;)try{e=e.parentNode}catch(t){e=null}e||(this._changeState("Container","Over"),this.onOverEvent()),e=this._getChildByEvent(t),this.current!=e&&(this.current&&this._removeItemClass(this.current,"Over"),e&&this._addItemClass(e,"Over"),this.current=e)},onMouseOut:function(t){for(var e=t.relatedTarget;e;){if(e==this.node)return;try{e=e.parentNode}catch(t){e=null}}this.current&&(this._removeItemClass(this.current,"Over"),this.current=null),this._changeState("Container",""),this.onOutEvent()},onSelectStart:function(t){this.withHandles||this.skipForm&&p.isFormElement(t)||(t.stopPropagation(),t.preventDefault())},onOverEvent:function(){},onOutEvent:function(){},_changeState:function(t,e){var n="dojoDnd"+t,r=t.toLowerCase()+"State";i.replace(this.node,n+e,n+this[r]),this[r]=e},_addItemClass:function(t,e){i.add(t,"dojoDndItem"+e)},_removeItemClass:function(t,e){i.remove(t,"dojoDndItem"+e)},_getChildByEvent:function(t){var e=t.target;if(e)for(var n=e.parentNode;n;n=(e=n).parentNode)if((n==this.parent||this.allowNested)&&i.contains(e,"dojoDndItem"))return e;return null},_normalizedCreator:function(t,e){var n=(this.creator||this.defaultCreator).call(this,t,e);return s.isArray(n.type)||(n.type=["text"]),n.node.id||(n.node.id=p.getUniqueId()),i.add(n.node,"dojoDndItem"),n}});return p._createNode=function(e){return e?function(t){return o.create(e,{innerHTML:t})}:p._createSpan},p._createTrTd=function(t){var e=o.create("tr");return o.create("td",{innerHTML:t},e),e},p._createSpan=function(t){return o.create("span",{innerHTML:t})},p._defaultCreatorNodes={ul:"li",ol:"li",div:"div",p:"div"},p._defaultCreator=function(t){var e=t.tagName.toLowerCase(),o="tbody"==e||"thead"==e?p._createTrTd:p._createNode(p._defaultCreatorNodes[e]);return function(t,e){var n,r,i,a=t&&s.isObject(t);return(i=a&&t.tagName&&t.nodeType&&t.getAttribute?(n=t.getAttribute("dndData")||t.innerHTML,r=(r=t.getAttribute("dndType"))?r.split(/\s*,\s*/):["text"],t):(n=a&&t.data?t.data:t,r=a&&t.type?t.type:["text"],("avatar"==e?p._createSpan:o)(String(n)))).id||(i.id=p.getUniqueId()),{node:i,data:n,type:r}}},f});