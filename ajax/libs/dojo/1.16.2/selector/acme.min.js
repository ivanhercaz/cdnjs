define(["../dom","../sniff","../_base/array","../_base/lang","../_base/window"],function(s,f,d,n,t){function g(){return t.doc}function h(){return!0}function c(e){function t(n,t){return _(e.slice(n,t))}function n(){0<=s&&(m.id=t(s,p).replace(/\\/g,""),s=-1),function(){if(0<=d){var n=d==p?null:t(d,p);m[w.indexOf(n)<0?"tag":"oper"]=n,d=-1}}(),0<=l&&(m.classes.push(t(l+1,p).replace(/\\/g,"")),l=-1)}0<=w.indexOf(e.slice(-1))?e+=" * ":e+=" ";for(var r,i,u=[],o=-1,a=-1,f=-1,c=-1,l=-1,s=-1,d=-1,g="",h="",p=0,v=e.length,m=null,y=null;g=h,h=e.charAt(p),p<v;p++)if("\\"!=g)if(m||(m={query:null,pseudos:[],attrs:[],classes:[],tag:null,oper:null,id:null,getTag:function(){return q?this.otag:this.tag}},d=i=p),r)h==r&&(r=null);else if("'"!=h&&'"'!=h)if(0<=o){if("]"==h){y.attr?y.matchFor=t(f||o+1,p):y.attr=t(o+1,p);var b=y.matchFor;b&&('"'!=b.charAt(0)&&"'"!=b.charAt(0)||(y.matchFor=b.slice(1,-1))),y.matchFor&&(y.matchFor=y.matchFor.replace(/\\/g,"")),m.attrs.push(y),y=null,o=f=-1}else if("="==h){var x=0<="|~^$*".indexOf(g)?g:"";y.type=x+h,y.attr=t(o+1,p-x.length),f=p+1}}else 0<=a?")"==h&&(0<=c&&(y.value=t(a+1,p)),c=a=-1):"#"==h?(n(),s=p+1):"."==h?(n(),l=p):":"==h?(n(),c=p):"["==h?(n(),o=p,y={}):"("==h?(0<=c&&(y={name:t(c+1,p),value:null},m.pseudos.push(y)),a=p):" "==h&&g!=h&&(n(),0<=c&&m.pseudos.push({name:t(c+1,p)}),m.loops=m.pseudos.length||m.attrs.length||m.classes.length,m.oquery=m.query=t(i,p),m.otag=m.tag=m.oper?null:m.tag||"*",m.tag&&(m.tag=m.tag.toUpperCase()),u.length&&u[u.length-1].oper&&(m.infixOper=u.pop(),m.query=m.infixOper.query+" "+m.query),u.push(m),m=null);else r=h;return u}function u(n,t){return n?t?function(){return n.apply(window,arguments)&&t.apply(window,arguments)}:n:t}function p(n,t){var e=t||[];return n&&e.push(n),e}function v(n){return 1==n.nodeType}function o(n,t){return n?"class"==t?n.className||"":"for"==t?n.htmlFor||"":"style"==t?n.style.cssText||"":(q?n.getAttribute(t):n.getAttribute(t,2))||"":""}function e(n){for(;n=n[z];)if(B(n))return!1;return!0}function r(n){for(;n=n[F];)if(B(n))return!1;return!0}function l(n){var t=n.parentNode,e=0,r=(t=7!=t.nodeType?t:t.nextSibling).children||t.childNodes,i=n._i||n.getAttribute("_i")||-1,u=t._l||(void 0!==t.getAttribute?t.getAttribute("_l"):-1);if(!r)return-1;var o=r.length;if(u==o&&0<=i&&0<=u)return i;f("ie")&&void 0!==t.setAttribute?t.setAttribute("_l",o):t._l=o,i=-1;for(var a=t.firstElementChild||t.firstChild;a;a=a[F])B(a)&&(f("ie")?a.setAttribute("_i",++e):a._i=++e,n===a&&(i=e));return i}function m(n){return!(l(n)%2)}function y(n){return l(n)%2}function b(o,a){function f(t){var e=[];try{e=Array.prototype.slice.call(t)}catch(n){for(var r=0,i=t.length;r<i;r++)e.push(t[r])}return e}return o=o||h,function(n,t,e){var r,i=0,u=[];for(u=f(n.children||n.childNodes),a&&d.forEach(u,function(n){1===n.nodeType&&(u=u.concat(f(n.getElementsByTagName("*"))))});r=u[i++];)B(r)&&(!e||V(r,e))&&o(r,i)&&t.push(r);return t}}function x(n,t){for(var e=n.parentNode;e&&e!=t;)e=e.parentNode;return!!e}function A(f){var n=L[f.query];if(n)return n;var i,r,t=f.infixOper,e=t?t.oper:"",c=$(f,{el:1}),u="*"==f.tag,o=g().getElementsByClassName;if(e){var a={el:1};u&&(a.tag=1),c=$(f,a),"+"==e?(r=c,n=function(n,t,e){for(;n=n[F];)if(!C||v(n)){e&&!V(n,e)||!r(n)||t.push(n);break}return t}):"~"==e?(i=c,n=function(n,t,e){for(var r=n[F];r;){if(B(r)){if(e&&!V(r,e))break;i(r)&&t.push(r)}r=r[F]}return t}):">"==e&&(n=b(c))}else if(f.id)c=!f.loops&&u?h:$(f,{el:1,id:1}),n=function(n,t){var e=s.byId(f.id,n.ownerDocument||n);if(n.ownerDocument&&!x(n,n.ownerDocument)){var r=11===n.nodeType?n.childNodes:[n];d.some(r,function(n){var t=b(function(n){return n.id===f.id},!0)(n,[]);if(t.length)return e=t[0],!1})}if(e&&c(e))return 9==n.nodeType||x(e,n)?p(e,t):void 0};else if(o&&/\{\s*\[native code\]\s*\}/.test(String(o))&&f.classes.length&&!E){c=$(f,{el:1,classes:1,id:1});var l=f.classes.join(" ");n=function(n,t,e){for(var r,i=p(0,t),u=0,o=n.getElementsByClassName(l);r=o[u++];)c(r,n)&&V(r,e)&&i.push(r);return i}}else n=u||f.loops?(c=$(f,{el:1,tag:1,id:1}),function(n,t,e){for(var r,i=p(0,t),u=0,o=f.getTag(),a=o?n.getElementsByTagName(o):[];r=a[u++];)c(r,n)&&V(r,e)&&i.push(r);return i}):function(n,t,e){for(var r,i=p(0,t),u=0,o=f.getTag(),a=o?n.getElementsByTagName(o):[];r=a[u++];)V(r,e)&&i.push(r);return i};return L[f.query]=n}function O(n){var t=c(_(n));if(1!=t.length)return function(n){return function(n,t){for(var e,r,i,u,o=p(n),a=t.length,f=0;f<a;f++){u=[],e=t[f],0<o.length-1&&(i={},u.nozip=!0);for(var c=A(e),l=0;r=o[l];l++)c(r,u,i);if(!u.length)break;o=u}return u}(n,t)};var e=A(t[0]);return function(n){var t=e(n,[]);return t&&(t.nozip=!0),t}}function i(n,t,e,r){return e?(t?t+" ":"")+e+(r?" "+r:""):n}function N(n,t,e){return t.replace(G,i)+(e||"")}function T(n,t){var e=(t=t||g()).ownerDocument||t;q="div"===e.createElement("div").tagName;var r=K(n)(t);return r&&r.nozip?r:function(n){if(n&&n.nozip)return n;if(!n||!n.length)return[];if(n.length<2)return[n[0]];var t,e,r=[];if(P++,f("ie")&&q){var i=P+"";for(t=0;t<n.length;t++)(e=n[t])&&e.getAttribute(W)!=i&&(r.push(e),e.setAttribute(W,i))}else if(f("ie")&&n.commentStrip)try{for(t=0;t<n.length;t++)(e=n[t])&&v(e)&&r.push(e)}catch(n){}else for(t=0;t<n.length;t++)(e=n[t])&&e[W]!=P&&(r.push(e),e[W]=P);return r}(r)}var _=n.trim,a=d.forEach,E="BackCompat"==g().compatMode,w=">~+",q=!1,S={"*=":function(t,e){return function(n){return 0<=o(n,t).indexOf(e)}},"^=":function(t,e){return function(n){return 0==o(n,t).indexOf(e)}},"$=":function(r,i){return function(n){var t=" "+o(n,r),e=t.lastIndexOf(i);return-1<e&&e==t.length-i.length}},"~=":function(t,n){var e=" "+n+" ";return function(n){return 0<=(" "+o(n,t)+" ").indexOf(e)}},"|=":function(e,r){var i=r+"-";return function(n){var t=o(n,e);return t==r||0==t.indexOf(i)}},"=":function(t,e){return function(n){return o(n,t)==e}}},k=g().documentElement,C=!(k.nextElementSibling||"nextElementSibling"in k),F=C?"nextSibling":"nextElementSibling",z=C?"previousSibling":"previousElementSibling",B=C?v:h,I={checked:function(n,t){return function(n){return!!("checked"in n?n.checked:n.selected)}},disabled:function(n,t){return function(n){return n.disabled}},enabled:function(n,t){return function(n){return!n.disabled}},"first-child":function(){return e},"last-child":function(){return r},"only-child":function(n,t){return function(n){return e(n)&&r(n)}},empty:function(n,t){return function(n){for(var t=n.childNodes,e=n.childNodes.length-1;0<=e;e--){var r=t[e].nodeType;if(1===r||3==r)return!1}return!0}},contains:function(n,t){var e=t.charAt(0);return'"'!=e&&"'"!=e||(t=t.slice(1,-1)),function(n){return 0<=n.innerHTML.indexOf(t)}},not:function(n,t){var e=c(t)[0],r={el:1};"*"!=e.tag&&(r.tag=1),e.classes.length||(r.classes=1);var i=$(e,r);return function(n){return!i(n)}},"nth-child":function(n,t){var e=parseInt;if("odd"==t)return y;if("even"==t)return m;if(-1!=t.indexOf("n")){var r=t.split("n",2),i=r[0]?"-"==r[0]?-1:e(r[0]):1,u=r[1]?e(r[1]):0,o=0,a=-1;if(0<i?u<0?u=u%i&&i+u%i:0<u&&(i<=u&&(o=u-u%i),u%=i):i<0&&(i*=-1,0<u&&(a=u,u%=i)),0<i)return function(n){var t=l(n);return o<=t&&(a<0||t<=a)&&t%i==u};t=u}var f=e(t);return function(n){return l(n)==f}}},D=f("ie")<9||9==f("ie")&&f("quirks")?function(t){var e=t.toLowerCase();return"class"==e&&(t="className"),function(n){return q?n.getAttribute(t):n[t]||n[e]}}:function(t){return function(n){return n&&n.getAttribute&&n.hasAttribute(t)}},$=function(t,n){if(!t)return h;var i=null;return"el"in(n=n||{})||(i=u(i,v)),"tag"in n||"*"!=t.tag&&(i=u(i,function(n){return n&&(q?n.tagName:n.tagName.toUpperCase())==t.getTag()})),"classes"in n||a(t.classes,function(n,t,e){var r=new RegExp("(?:^|\\s)"+n+"(?:\\s|$)");(i=u(i,function(n){return r.test(n.className)})).count=t}),"pseudos"in n||a(t.pseudos,function(n){var t=n.name;I[t]&&(i=u(i,I[t](t,n.value)))}),"attrs"in n||a(t.attrs,function(n){var t,e=n.attr;n.type&&S[n.type]?t=S[n.type](e,n.matchFor):e.length&&(t=D(e)),t&&(i=u(i,t))}),"id"in n||t.id&&(i=u(i,function(n){return!!n&&n.id==t.id})),i||"default"in n||(i=h),i},L={},M={},U={},j=f("ie")?"commentStrip":"nozip",H="querySelectorAll",R=!!g()[H],G=/\\[>~+]|n\+\d|([^ \\])?([>~+])([^ =])?/g,J=/([^[]*)([^\]]*])?/g,K=function(e,n){if(e=e.replace(J,N),R){var t=U[e];if(t&&!n)return t}var r=M[e];if(r)return r;var i=e.charAt(0),u=-1==e.indexOf(" ");if(0<=e.indexOf("#")&&u&&(n=!0),!(!R||n||-1!=w.indexOf(i)||f("ie")&&-1!=e.indexOf(":")||E&&0<=e.indexOf(".")||-1!=e.indexOf(":contains")||-1!=e.indexOf(":checked")||-1!=e.indexOf("|="))){var o=0<=w.indexOf(e.charAt(e.length-1))?e+" *":e;return U[e]=function(n){if(9==n.nodeType||u)try{var t=n[H](o);return t[j]=!0,t}catch(n){}return K(e,!0)(n)}}var a=e.match(/([^\s,](?:"(?:\\.|[^"])+"|'(?:\\.|[^'])+'|[^,])*)/g);return M[e]=a.length<2?O(e):function(n){for(var t,e=0,r=[];t=a[e++];)r=r.concat(O(t)(n));return r}},P=0,Q=f("ie")?function(n){return q?n.getAttribute("_uid")||n.setAttribute("_uid",++P)||P:n.uniqueID}:function(n){return n._uid||(n._uid=++P)},V=function(n,t){if(!t)return 1;var e=Q(n);return t[e]?0:t[e]=1},W="_zipIdx";return T.filter=function(n,t,e){for(var r,i=[],u=c(t),o=1!=u.length||/[^\w#\.]/.test(t)?function(n){return-1!=d.indexOf(T(t,s.byId(e)),n)}:$(u[0]),a=0;r=n[a];a++)o(r)&&i.push(r);return i},T});