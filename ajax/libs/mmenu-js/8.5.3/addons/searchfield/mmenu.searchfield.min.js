import Mmenu from"../../core/oncanvas/mmenu.oncanvas";import options from"./_options";import configs from"./_configs";import translate from"./translations/translate";import{extendShorthandOptions}from"./_options";import*as DOM from"../../_modules/dom";import*as events from"../../_modules/eventlisteners";import{type,extend}from"../../_modules/helpers";translate(),Mmenu.options.searchfield=options,Mmenu.configs.searchfield=configs;export default function(){var e=this,n=extendShorthandOptions(this.opts.searchfield);this.opts.searchfield=extend(n,Mmenu.options.searchfield);this.conf.searchfield;n.add&&(this.bind("close:start",function(){DOM.find(e.node.menu,".mm-searchfield").forEach(function(e){e.blur()})}),this.bind("initPanel:after",function(t){var i=null;n.panel.add&&(i=initSearchPanel.call(e));var s=null;switch(n.addTo){case"panels":s=[t];break;case"panel":s=[i];break;default:"string"==typeof n.addTo?s=DOM.find(e.node.menu,n.addTo):"array"==type(n.addTo)&&(s=n.addTo)}s.forEach(function(t){t=initSearchfield.call(e,t),n.search&&t&&initSearching.call(e,t)}),n.noResults&&initNoResultsMsg.call(e,n.panel.add?i:t)}),this.clck.push(function(n,t){if(t.inMenu&&n.matches(".mm-searchfield__btn")){if(n.matches(".mm-btn_close")){var i=n.closest(".mm-searchfield"),s=DOM.find(i,"input")[0];return s.value="",e.search(s),!0}if(n.matches(".mm-btn_next"))return(i=n.closest("form"))&&i.submit(),!0}}))};var initSearchPanel=function(){var e=this.opts.searchfield,n=(this.conf.searchfield,DOM.children(this.node.pnls,".mm-panel_search")[0]);if(n)return n;n=DOM.create("div.mm-panel.mm-panel_search.mm-hidden"),e.panel.id&&(n.id=e.panel.id),e.panel.title&&n.setAttribute("data-mm-title",e.panel.title);var t=DOM.create("ul");switch(n.append(t),this.node.pnls.append(n),this.initListview(t),this._initNavbar(n),e.panel.fx){case!1:break;case"none":n.classList.add("mm-panel_noanimation");break;default:n.classList.add("mm-panel_fx-"+e.panel.fx)}if(e.panel.splash){var i=DOM.create("div.mm-panel__content");i.innerHTML=e.panel.splash,n.append(i)}return n.classList.add("mm-panel"),n.classList.add("mm-hidden"),this.node.pnls.append(n),n},initSearchfield=function(e){var n=this.opts.searchfield,t=this.conf.searchfield;if(e.parentElement.matches(".mm-listitem_vertical"))return null;if(a=DOM.find(e,".mm-searchfield")[0])return a;function i(e,n){if(n)for(var t in n)e.setAttribute(t,n[t])}var s,a=DOM.create((t.form?"form":"div")+".mm-searchfield"),m=DOM.create("div.mm-searchfield__input"),l=DOM.create("input");(l.type="text",l.autocomplete="off",l.placeholder=this.i18n(n.placeholder),m.append(l),a.append(m),e.prepend(a),i(l,t.input),t.clear)&&((s=DOM.create("a.mm-btn.mm-btn_close.mm-searchfield__btn")).setAttribute("href","#"),m.append(s));(i(a,t.form),t.form&&t.submit&&!t.clear)&&((s=DOM.create("a.mm-btn.mm-btn_next.mm-searchfield__btn")).setAttribute("href","#"),m.append(s));n.cancel&&((s=DOM.create("a.mm-searchfield__cancel")).setAttribute("href","#"),s.textContent=this.i18n("cancel"),a.append(s));return a},initSearching=function(e){var n=this,t=this.opts.searchfield,i=(this.conf.searchfield,{});e.closest(".mm-panel_search")?(i.panels=DOM.find(this.node.pnls,".mm-panel"),i.noresults=[e.closest(".mm-panel")]):e.closest(".mm-panel")?(i.panels=[e.closest(".mm-panel")],i.noresults=i.panels):(i.panels=DOM.find(this.node.pnls,".mm-panel"),i.noresults=[this.node.menu]),i.panels=i.panels.filter(function(e){return!e.matches(".mm-panel_search")}),i.panels=i.panels.filter(function(e){return!e.parentElement.matches(".mm-listitem_vertical")}),i.listitems=[],i.dividers=[],i.panels.forEach(function(e){var n,t;(n=i.listitems).push.apply(n,DOM.find(e,".mm-listitem")),(t=i.dividers).push.apply(t,DOM.find(e,".mm-divider"))});var s=DOM.children(this.node.pnls,".mm-panel_search")[0],a=DOM.find(e,"input")[0],m=DOM.find(e,".mm-searchfield__cancel")[0];a.mmSearchfield=i,t.panel.add&&t.panel.splash&&(events.off(a,"focus.splash"),events.on(a,"focus.splash",function(e){n.openPanel(s)})),t.cancel&&(events.off(a,"focus.cancel"),events.on(a,"focus.cancel",function(e){m.classList.add("mm-searchfield__cancel-active")}),events.off(m,"click.splash"),events.on(m,"click.splash",function(e){if(e.preventDefault(),m.classList.remove("mm-searchfield__cancel-active"),s.matches(".mm-panel_opened")){var t=DOM.children(n.node.pnls,".mm-panel_opened-parent");t.length&&n.openPanel(t[t.length-1])}})),t.panel.add&&"panel"==t.addTo&&this.bind("openPanel:finish",function(e){e===s&&a.focus()}),events.off(a,"input.search"),events.on(a,"input.search",function(e){switch(e.keyCode){case 9:case 16:case 17:case 18:case 37:case 38:case 39:case 40:break;default:n.search(a)}}),this.search(a)},initNoResultsMsg=function(e){if(e){var n=this.opts.searchfield;this.conf.searchfield;if(e.closest(".mm-panel")||(e=DOM.children(this.node.pnls,".mm-panel")[0]),!DOM.children(e,".mm-panel__noresultsmsg").length){var t=DOM.create("div.mm-panel__noresultsmsg.mm-hidden");t.innerHTML=this.i18n(n.noResults),e.append(t)}}};Mmenu.prototype.search=function(e,n){var t,i=this,s=this.opts.searchfield;this.conf.searchfield;n=(n=n||""+e.value).toLowerCase().trim();var a=e.mmSearchfield,m=e.closest(".mm-searchfield"),l=DOM.find(m,".mm-btn"),r=DOM.children(this.node.pnls,".mm-panel_search")[0],c=a.panels,o=a.noresults,d=a.listitems,f=a.dividers;if(d.forEach(function(e){e.classList.remove("mm-listitem_nosubitems"),e.classList.remove("mm-listitem_onlysubitems"),e.classList.remove("mm-hidden")}),r&&(DOM.children(r,".mm-listview")[0].innerHTML=""),c.forEach(function(e){e.scrollTop=0}),n.length){f.forEach(function(e){e.classList.add("mm-hidden")}),d.forEach(function(e){var t=DOM.children(e,".mm-listitem__text")[0],i=!1;t&&DOM.text(t).toLowerCase().indexOf(n)>-1&&(t.matches(".mm-listitem__btn")?s.showSubPanels&&(i=!0):t.matches("a")?i=!0:s.showTextItems&&(i=!0)),i||e.classList.add("mm-hidden")});var h=d.filter(function(e){return!e.matches(".mm-hidden")}).length;if(s.panel.add){var p=[];c.forEach(function(e){var n=DOM.filterLI(DOM.find(e,".mm-listitem"));if((n=n.filter(function(e){return!e.matches(".mm-hidden")})).length){if(s.panel.dividers){var t=DOM.create("li.mm-divider"),i=DOM.find(e,".mm-navbar__title")[0];i&&(t.innerHTML=i.innerHTML,p.push(t))}n.forEach(function(e){p.push(e.cloneNode(!0))})}}),p.forEach(function(e){e.querySelectorAll(".mm-toggle, .mm-check").forEach(function(e){e.remove()})}),(t=DOM.children(r,".mm-listview")[0]).append.apply(t,p),this.openPanel(r)}else s.showSubPanels&&c.forEach(function(e){var n=DOM.find(e,".mm-listitem");DOM.filterLI(n).forEach(function(e){var n=e.mmChild;n&&DOM.find(n,".mm-listitem").forEach(function(e){e.classList.remove("mm-hidden")})})}),c.slice().reverse().forEach(function(n,t){var s=n.mmParent;if(s){var a=DOM.find(n,".mm-listitem");DOM.filterLI(a).length?(s.matches(".mm-hidden")&&s.classList.remove("mm-hidden"),s.classList.add("mm-listitem_onlysubitems")):e.closest(".mm-panel")||((n.matches(".mm-panel_opened")||n.matches(".mm-panel_opened-parent"))&&setTimeout(function(){i.openPanel(s.closest(".mm-panel"))},(t+1)*(1.5*i.conf.openingInterval)),s.classList.add("mm-listitem_nosubitems"))}}),c.forEach(function(e){var n=DOM.find(e,".mm-listitem");DOM.filterLI(n).forEach(function(e){DOM.parents(e,".mm-listitem_vertical").forEach(function(e){e.matches(".mm-hidden")&&(e.classList.remove("mm-hidden"),e.classList.add("mm-listitem_onlysubitems"))})})}),c.forEach(function(e){var n=DOM.find(e,".mm-listitem");DOM.filterLI(n).forEach(function(e){var n=DOM.prevAll(e,".mm-divider")[0];n&&n.classList.remove("mm-hidden")})});l.forEach(function(e){return e.classList.remove("mm-hidden")}),o.forEach(function(e){DOM.find(e,".mm-panel__noresultsmsg").forEach(function(e){return e.classList[h?"add":"remove"]("mm-hidden")})}),s.panel.add&&(s.panel.splash&&DOM.find(r,".mm-panel__content").forEach(function(e){return e.classList.add("mm-hidden")}),d.forEach(function(e){return e.classList.remove("mm-hidden")}),f.forEach(function(e){return e.classList.remove("mm-hidden")}))}else if(d.forEach(function(e){return e.classList.remove("mm-hidden")}),f.forEach(function(e){return e.classList.remove("mm-hidden")}),l.forEach(function(e){return e.classList.add("mm-hidden")}),o.forEach(function(e){DOM.find(e,".mm-panel__noresultsmsg").forEach(function(e){return e.classList.add("mm-hidden")})}),s.panel.add)if(s.panel.splash)DOM.find(r,".mm-panel__content").forEach(function(e){return e.classList.remove("mm-hidden")});else if(!e.closest(".mm-panel_search")){var u=DOM.children(this.node.pnls,".mm-panel_opened-parent");this.openPanel(u.slice(-1)[0])}this.trigger("updateListview")};