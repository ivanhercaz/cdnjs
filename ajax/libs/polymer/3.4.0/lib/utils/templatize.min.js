import"./boot.js";import{PropertyEffects}from"../mixins/property-effects.js";import{MutableData}from"../mixins/mutable-data.js";import{strictTemplatePolicy,legacyWarnings}from"./settings.js";import{wrap}from"./wrap.js";let newInstance=null;function HTMLTemplateElementExtension(){return newInstance}HTMLTemplateElementExtension.prototype=Object.create(HTMLTemplateElement.prototype,{constructor:{value:HTMLTemplateElementExtension,writable:!0}});const DataTemplate=PropertyEffects(HTMLTemplateElementExtension),MutableDataTemplate=MutableData(DataTemplate);function upgradeTemplate(t,e){newInstance=t,Object.setPrototypeOf(t,e.prototype),new e,newInstance=null}const templateInstanceBase=PropertyEffects(class{});export function showHideChildren(t,e){for(let o=0;o<e.length;o++){let a=e[o];if(Boolean(t)!=Boolean(a.__hideTemplateChildren__))if(a.nodeType===Node.TEXT_NODE)t?(a.__polymerTextContent__=a.textContent,a.textContent=""):a.textContent=a.__polymerTextContent__;else if("slot"===a.localName)if(t)a.__polymerReplaced__=document.createComment("hidden-slot"),wrap(wrap(a).parentNode).replaceChild(a.__polymerReplaced__,a);else{const t=a.__polymerReplaced__;t&&wrap(wrap(t).parentNode).replaceChild(a,t)}else a.style&&(t?(a.__polymerDisplay__=a.style.display,a.style.display="none"):a.style.display=a.__polymerDisplay__);a.__hideTemplateChildren__=t,a._showHideChildren&&a._showHideChildren(t)}}class TemplateInstanceBase extends templateInstanceBase{constructor(t){super(),this._configureProperties(t),this.root=this._stampTemplate(this.__dataHost);let e=[];this.children=e;for(let t=this.root.firstChild;t;t=t.nextSibling)e.push(t),t.__templatizeInstance=this;this.__templatizeOwner&&this.__templatizeOwner.__hideTemplateChildren__&&this._showHideChildren(!0);let o=this.__templatizeOptions;(t&&o.instanceProps||!o.instanceProps)&&this._enableProperties()}_configureProperties(t){if(this.__templatizeOptions.forwardHostProp)for(let t in this.__hostProps)this._setPendingProperty(t,this.__dataHost["_host_"+t]);for(let e in t)this._setPendingProperty(e,t[e])}forwardHostProp(t,e){this._setPendingPropertyOrPath(t,e,!1,!0)&&this.__dataHost._enqueueClient(this)}_addEventListenerToNode(t,e,o){if(this._methodHost&&this.__templatizeOptions.parentModel)this._methodHost._addEventListenerToNode(t,e,t=>{t.model=this,o(t)});else{let a=this.__dataHost.__dataHost;a&&a._addEventListenerToNode(t,e,o)}}_showHideChildren(t){showHideChildren(t,this.children)}_setUnmanagedPropertyToNode(t,e,o){t.__hideTemplateChildren__&&t.nodeType==Node.TEXT_NODE&&"textContent"==e?t.__polymerTextContent__=o:super._setUnmanagedPropertyToNode(t,e,o)}get parentModel(){let t=this.__parentModel;if(!t){let e;t=this;do{t=t.__dataHost.__dataHost}while((e=t.__templatizeOptions)&&!e.parentModel);this.__parentModel=t}return t}dispatchEvent(t){return!0}}TemplateInstanceBase.prototype.__dataHost,TemplateInstanceBase.prototype.__templatizeOptions,TemplateInstanceBase.prototype._methodHost,TemplateInstanceBase.prototype.__templatizeOwner,TemplateInstanceBase.prototype.__hostProps;const MutableTemplateInstanceBase=MutableData(TemplateInstanceBase);function findMethodHost(t){let e=t.__dataHost;return e&&e._methodHost||e}function createTemplatizerClass(t,e,o){let a=o.mutableData?MutableTemplateInstanceBase:TemplateInstanceBase;templatize.mixin&&(a=templatize.mixin(a));let n=class extends a{};return n.prototype.__templatizeOptions=o,n.prototype._bindTemplate(t),addNotifyEffects(n,t,e,o),n}function addPropagateEffects(t,e,o,a){let n=o.forwardHostProp;if(n&&e.hasHostProps){const s="template"==t.localName;let r=e.templatizeTemplateClass;if(!r){if(s){let t=o.mutableData?MutableDataTemplate:DataTemplate;class a extends t{}r=e.templatizeTemplateClass=a}else{const o=t.constructor;class a extends o{}r=e.templatizeTemplateClass=a}let p=e.hostProps;for(let t in p)r.prototype._addPropertyEffect("_host_"+t,r.prototype.PROPERTY_EFFECT_TYPES.PROPAGATE,{fn:createForwardHostPropEffect(t,n)}),r.prototype._createNotifyingProperty("_host_"+t);legacyWarnings&&a&&warnOnUndeclaredProperties(e,o,a)}if(t.__dataProto&&Object.assign(t.__data,t.__dataProto),s)upgradeTemplate(t,r),t.__dataTemp={},t.__dataPending=null,t.__dataOld=null,t._enableProperties();else{Object.setPrototypeOf(t,r.prototype);const o=e.hostProps;for(let e in o)if((e="_host_"+e)in t){const o=t[e];delete t[e],t.__data[e]=o}}}}function createForwardHostPropEffect(t,e){return function(t,o,a){e.call(t.__templatizeOwner,o.substring("_host_".length),a[o])}}function addNotifyEffects(t,e,o,a){let n=o.hostProps||{};for(let e in a.instanceProps){delete n[e];let o=a.notifyInstanceProp;o&&t.prototype._addPropertyEffect(e,t.prototype.PROPERTY_EFFECT_TYPES.NOTIFY,{fn:createNotifyInstancePropEffect(e,o)})}if(a.forwardHostProp&&e.__dataHost)for(let e in n)o.hasHostProps||(o.hasHostProps=!0),t.prototype._addPropertyEffect(e,t.prototype.PROPERTY_EFFECT_TYPES.NOTIFY,{fn:createNotifyHostPropEffect()})}function createNotifyInstancePropEffect(t,e){return function(t,o,a){e.call(t.__templatizeOwner,t,o,a[o])}}function createNotifyHostPropEffect(){return function(t,e,o){t.__dataHost._setPendingPropertyOrPath("_host_"+e,o[e],!0,!0)}}export function templatize(t,e,o){if(strictTemplatePolicy&&!findMethodHost(t))throw new Error("strictTemplatePolicy: template owner not trusted");if(o=o||{},t.__templatizeOwner)throw new Error("A <template> can only be templatized once");t.__templatizeOwner=e;let a=(e?e.constructor:TemplateInstanceBase)._parseTemplate(t),n=a.templatizeInstanceClass;n||(n=createTemplatizerClass(t,a,o),a.templatizeInstanceClass=n);const s=findMethodHost(t);addPropagateEffects(t,a,o,s);let r=class extends n{};return r.prototype._methodHost=s,r.prototype.__dataHost=t,r.prototype.__templatizeOwner=e,r.prototype.__hostProps=a.hostProps,r=r}function warnOnUndeclaredProperties(t,e,o){const a=o.constructor._properties,{propertyEffects:n}=t,{instanceProps:s}=e;for(let t in n)if(!(a[t]||s&&s[t])){const e=n[t];for(let o=0;o<e.length;o++){const{part:a}=e[o].info;if(!a.signature||!a.signature.static){console.warn(`Property '${t}' used in template but not `+"declared in 'properties'; attribute will not be observed.");break}}}}export function modelForElement(t,e){let o;for(;e;)if(o=e.__dataHost?e:e.__templatizeInstance){if(o.__dataHost==t)return o;e=o.__dataHost}else e=wrap(e).parentNode;return null}export{TemplateInstanceBase};