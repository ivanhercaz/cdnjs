"use strict";var __extends=this&&this.__extends||function(){var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s])})(e,t)};return function(e,t){function s(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,s=1,n=arguments.length;s<n;s++)for(var i in t=arguments[s])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};Object.defineProperty(exports,"__esModule",{value:!0});var constants_1=require("../constants"),message_constants_1=require("../../binary-protocol/src/message-constants"),json_path_1=require("./json-path"),Emitter=require("component-emitter2"),utils=require("../util/utils"),state_machine_1=require("../util/state-machine"),RecordCore=function(a){function e(e,t,s,n,i){var o=a.call(this)||this;if(o.name=e,o.services=t,o.options=s,o.recordServices=n,o.whenComplete=i,o.readyCallbacks=[],o.emitter=new Emitter,o.data=Object.create(null),o.references=1,o.hasProvider=!1,o.pendingWrites=[],o.isReady=!1,o.offlineLoadingAborted=!1,o.version=null,o.responseTimeout=null,o.discardTimeout=null,o.deletedTimeout=null,o.readyTimer=-1,o.deleteResponse=null,"string"!=typeof e||0===e.length)throw new Error("invalid argument name");return o.onConnectionLost=o.onConnectionLost.bind(o),o.onConnectionReestablished=o.onConnectionReestablished.bind(o),o.stateMachine=new state_machine_1.StateMachine(o.services.logger,{init:"INITIAL",context:o,onStateChanged:o.onStateChanged,transitions:recordStateTransitions}),o.recordServices.dirtyService.whenLoaded(o,o.onDirtyServiceLoaded),o}return __extends(e,a),Object.defineProperty(e.prototype,"recordState",{get:function(){return this.stateMachine.state},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"usages",{get:function(){return this.references},set:function(e){this.references=e,1===this.references&&(this.services.timeoutRegistry.clear(this.discardTimeout),this.services.timerRegistry.remove(this.readyTimer),this.stateMachine.transition(message_constants_1.RECORD_ACTIONS.SUBSCRIBE))},enumerable:!0,configurable:!0}),e.prototype.onDirtyServiceLoaded=function(){var n=this;this.services.connection.isConnected?this.services.storage.get(this.name,function(e,t,s){-1!==t||n.recordServices.dirtyService.isDirty(n.name)?(n.version=t,n.data=s,n.stateMachine.transition("RESUBSCRIBE")):n.stateMachine.transition(message_constants_1.RECORD_ACTIONS.SUBSCRIBE)}):this.stateMachine.transition("LOAD"),this.services.connection.onReestablished(this.onConnectionReestablished),this.services.connection.onLost(this.onConnectionLost)},e.prototype.onStateChanged=function(e,t){this.emitter.emit(constants_1.EVENT.RECORD_STATE_CHANGED,e)},e.prototype.whenReady=function(t,s){var n=this;if(!s)return new Promise(function(e){return n.whenReadyInternal(t,function(){return e(t)})});this.whenReadyInternal(t,function(e){s(e)})},e.prototype.whenReadyInternal=function(e,t){!0!==this.isReady?t&&this.readyCallbacks.push({callback:t,context:e}):t(e)},e.prototype.set=function(e){var t=this,s=e.path,n=e.data,i=e.callback;if(!s&&(null===n||"object"!=typeof n))throw new Error("invalid arguments, scalar values cannot be set without path");if(!this.checkDestroyed("set"))if(!1!==this.isReady){var o=this.data,a=json_path_1.setValue(o,s||null,n);o!==a?(this.applyChange(a),this.services.connection.isConnected?this.sendUpdate(s,n,i):(i&&i(constants_1.EVENT.CLIENT_OFFLINE,this.name),this.saveUpdate())):i&&this.services.timerRegistry.requestIdleCallback(function(){return i(null,t.name)})}else this.pendingWrites.push({path:s,data:n,callback:i})},e.prototype.setWithAck=function(e){var n=this;if(!e.callback)return new Promise(function(t,s){e.callback=function(e){return null===e?t():s(e)},n.set(e)});this.set(e)},e.prototype.get=function(e){return json_path_1.get(this.data,e||null,this.options.recordDeepCopy)},e.prototype.subscribe=function(e){var t=this;if(void 0!==e.path&&("string"!=typeof e.path||0===e.path.length))throw new Error("invalid argument path");if("function"!=typeof e.callback)throw new Error("invalid argument callback");this.checkDestroyed("subscribe")||(e.triggerNow?this.whenReadyInternal(null,function(){t.emitter.on(e.path||"",e.callback),e.callback(t.get(e.path))}):this.emitter.on(e.path||"",e.callback))},e.prototype.unsubscribe=function(e){if(void 0!==e.path&&("string"!=typeof e.path||0===e.path.length))throw new Error("invalid argument path");if(void 0!==e.callback&&"function"!=typeof e.callback)throw new Error("invalid argument callback");this.checkDestroyed("unsubscribe")||this.emitter.off(e.path||"",e.callback)},e.prototype.discard=function(){var e=this;this.checkDestroyed("discard")||(this.whenReadyInternal(null,function(){e.references--,e.references<=0&&(e.readyTimer=e.services.timerRegistry.add({duration:e.options.recordReadTimeout,callback:e.stateMachine.transition,context:e.stateMachine,data:message_constants_1.RECORD_ACTIONS.UNSUBSCRIBE_ACK}))}),this.stateMachine.transition(message_constants_1.RECORD_ACTIONS.UNSUBSCRIBE))},e.prototype.delete=function(e){var s=this;if(!this.services.connection.isConnected)return e?void this.services.timerRegistry.requestIdleCallback(function(){e("Deleting while offline is not supported")}):Promise.reject("Deleting while offline is not supported");if(!this.checkDestroyed("delete")){if(this.stateMachine.transition(message_constants_1.RECORD_ACTIONS.DELETE),!e||"function"!=typeof e)return new Promise(function(e,t){s.deleteResponse={resolve:e,reject:t},s.sendDelete()});this.deleteResponse={callback:e},this.sendDelete()}},e.prototype.setMergeStrategy=function(e){this.recordServices.mergeStrategy.setMergeStrategyByName(this.name,e)},e.prototype.saveRecordToOffline=function(){this.services.storage.set(this.name,this.version,this.data,function(){})},e.prototype.onSubscribing=function(){this.recordServices.readRegistry.register(this.name,this,this.handleReadResponse),this.responseTimeout=this.services.timeoutRegistry.add({message:{topic:message_constants_1.TOPIC.RECORD,action:message_constants_1.RECORD_ACTIONS.READ_RESPONSE,name:this.name}}),this.recordServices.bulkSubscriptionService[message_constants_1.RECORD_ACTIONS.SUBSCRIBECREATEANDREAD_BULK].subscribe(this.name)},e.prototype.onResubscribing=function(){this.services.timerRegistry.remove(this.readyTimer),this.recordServices.headRegistry.register(this.name,this,this.handleHeadResponse),this.responseTimeout=this.services.timeoutRegistry.add({message:{topic:message_constants_1.TOPIC.RECORD,action:message_constants_1.RECORD_ACTIONS.HEAD,name:this.name}}),this.recordServices.bulkSubscriptionService[message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDHEAD_BULK].subscribe(this.name)},e.prototype.onOfflineLoading=function(){var n=this;this.services.storage.get(this.name,function(e,t,s){if(-1===t){if(n.offlineLoadingAborted)return void(n.offlineLoadingAborted=!1);n.data={},n.version=1,n.services.storage.set(n.name,n.version,n.data,function(e){}),n.stateMachine.transition("LOADED")}else n.data=s,n.version=t,n.stateMachine.transition("LOADED")})},e.prototype.abortOfflineLoading=function(){this.offlineLoadingAborted=!0,this.onResubscribing()},e.prototype.onReady=function(){this.services.timeoutRegistry.clear(this.responseTimeout),this.applyPendingWrites(),this.isReady=!0,this.readyCallbacks.forEach(function(e){var t=e.context;e.callback.call(t,t)})},e.prototype.applyPendingWrites=function(){for(var s=this,n=[],e=this.data,t=e,i=0;i<this.pendingWrites.length;i++){var o=this.pendingWrites[i],a=o.callback,r=o.path,c=o.data;a&&n.push(a),t=json_path_1.setValue(t,r||null,c)}this.pendingWrites=[],this.applyChange(t);function h(e){for(var t=0;t<n.length;t++)n[t](e,s.name)}utils.deepEquals(e,t)?h(null):this.services.connection.isConnected?this.sendUpdate(null,t,h):(h(constants_1.EVENT.CLIENT_OFFLINE),this.saveUpdate())},e.prototype.onUnsubscribed=function(){if(this.services.connection.isConnected){var e={topic:message_constants_1.TOPIC.RECORD,action:message_constants_1.RECORD_ACTIONS.UNSUBSCRIBE,name:this.name};this.discardTimeout=this.services.timeoutRegistry.add({message:e}),this.services.connection.sendMessage(e)}this.emit(constants_1.EVENT.RECORD_DISCARDED),this.destroy()},e.prototype.onDeleted=function(){this.emit(constants_1.EVENT.RECORD_DELETED),this.destroy()},e.prototype.handle=function(e){if(e.action!==message_constants_1.RECORD_ACTIONS.PATCH&&e.action!==message_constants_1.RECORD_ACTIONS.UPDATE&&e.action!==message_constants_1.RECORD_ACTIONS.ERASE){if(e.action===message_constants_1.RECORD_ACTIONS.DELETE_SUCCESS)return this.services.timeoutRegistry.clear(this.deletedTimeout),this.stateMachine.transition(message_constants_1.RECORD_ACTIONS.DELETE_SUCCESS),void(this.deleteResponse.callback?this.deleteResponse.callback(null):this.deleteResponse.resolve&&this.deleteResponse.resolve());if(e.action!==message_constants_1.RECORD_ACTIONS.DELETED){if(e.action!==message_constants_1.RECORD_ACTIONS.VERSION_EXISTS){if(e.action!==message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED&&e.action!==message_constants_1.RECORD_ACTIONS.MESSAGE_PERMISSION_ERROR)return e.action===message_constants_1.RECORD_ACTIONS.SUBSCRIPTION_HAS_PROVIDER||e.action===message_constants_1.RECORD_ACTIONS.SUBSCRIPTION_HAS_NO_PROVIDER?(this.hasProvider=e.action===message_constants_1.RECORD_ACTIONS.SUBSCRIPTION_HAS_PROVIDER,void this.emit(constants_1.EVENT.RECORD_HAS_PROVIDER_CHANGED,this.hasProvider)):void 0;if(e.originalAction===message_constants_1.RECORD_ACTIONS.SUBSCRIBECREATEANDREAD||e.originalAction===message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDHEAD||e.originalAction===message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDREAD){var t=__assign({},e,{originalAction:message_constants_1.RECORD_ACTIONS.SUBSCRIBE}),s=__assign({},e,{originalAction:e.originalAction===message_constants_1.RECORD_ACTIONS.SUBSCRIBECREATEANDREAD?message_constants_1.RECORD_ACTIONS.READ_RESPONSE:message_constants_1.RECORD_ACTIONS.HEAD_RESPONSE});this.services.timeoutRegistry.remove(t),this.services.timeoutRegistry.remove(s)}return this.emit(constants_1.EVENT.RECORD_ERROR,message_constants_1.RECORD_ACTIONS[message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED],message_constants_1.RECORD_ACTIONS[e.originalAction]),void(e.originalAction===message_constants_1.RECORD_ACTIONS.DELETE&&(this.deleteResponse.callback?this.deleteResponse.callback(message_constants_1.RECORD_ACTIONS[message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED]):this.deleteResponse.reject&&this.deleteResponse.reject(message_constants_1.RECORD_ACTIONS[message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED])))}}else this.stateMachine.transition(message_constants_1.RECORD_ACTIONS.DELETED)}else{if("MERGING"===this.stateMachine.state)return;this.applyUpdate(e)}},e.prototype.handleReadResponse=function(e){if("MERGING"===this.stateMachine.state)return this.recoverRecord(e.version,e.parsedData,e),void this.recordServices.dirtyService.setDirty(this.name,!1);this.version=e.version,this.stateMachine.transition(message_constants_1.RECORD_ACTIONS.READ_RESPONSE),this.applyChange(json_path_1.setValue(this.data,null,e.parsedData))},e.prototype.handleHeadResponse=function(e){var t=e.version;this.recordServices.dirtyService.isDirty(this.name)?-1===t&&1===this.version?(this.stateMachine.transition("SUBSCRIBED"),this.sendCreateUpdate(this.data)):this.version===t+1?(this.stateMachine.transition("RESUBSCRIBED"),this.sendUpdate(null,this.data)):(this.stateMachine.transition("INVALID_VERSION"),this.sendRead(),this.recordServices.readRegistry.register(this.name,this,this.handleReadResponse)):this.version===t?this.stateMachine.transition("RESUBSCRIBED"):(this.version,this.stateMachine.transition("INVALID_VERSION"),this.sendRead(),this.recordServices.readRegistry.register(this.name,this,this.handleReadResponse))},e.prototype.sendRead=function(){this.services.connection.sendMessage({topic:message_constants_1.TOPIC.RECORD,action:message_constants_1.RECORD_ACTIONS.READ,name:this.name})},e.prototype.saveUpdate=function(){this.recordServices.dirtyService.isDirty(this.name)||(this.version++,this.recordServices.dirtyService.setDirty(this.name,!0)),this.saveRecordToOffline()},e.prototype.sendUpdate=function(e,t,s){void 0===e&&(e=null),this.recordServices.dirtyService.isDirty(this.name)?this.recordServices.dirtyService.setDirty(this.name,!1):this.version++;var n={topic:message_constants_1.TOPIC.RECORD,version:this.version,name:this.name};e?void 0===t?Object.assign(n,{action:message_constants_1.RECORD_ACTIONS.ERASE,path:e}):Object.assign(n,{action:message_constants_1.RECORD_ACTIONS.PATCH,path:e,parsedData:t}):Object.assign(n,{action:message_constants_1.RECORD_ACTIONS.UPDATE,parsedData:t}),s?this.recordServices.writeAckService.send(n,s):this.services.connection.sendMessage(n)},e.prototype.sendCreateUpdate=function(e){this.services.connection.sendMessage({name:this.name,topic:message_constants_1.TOPIC.RECORD,action:message_constants_1.RECORD_ACTIONS.CREATEANDUPDATE,version:1,parsedData:e}),this.recordServices.dirtyService.setDirty(this.name,!1)},e.prototype.applyUpdate=function(e){var t,s=e.version,n=e.parsedData;if(null===this.version)this.version=s;else if(this.version+1!==s)return this.stateMachine.transition("INVALID_VERSION"),void(e.action===message_constants_1.RECORD_ACTIONS.PATCH?this.sendRead():this.recoverRecord(e.version,n,e));this.version=s,t=e.action===message_constants_1.RECORD_ACTIONS.PATCH?json_path_1.setValue(this.data,e.path,n):e.action===message_constants_1.RECORD_ACTIONS.ERASE?json_path_1.setValue(this.data,e.path,void 0):json_path_1.setValue(this.data,null,n),this.applyChange(t)},e.prototype.applyChange=function(e){if(!this.stateMachine.inEndState){var t=this.data;this.data=e;for(var s=this.emitter.eventNames(),n=0;n<s.length;n++){json_path_1.get(e,s[n],!1)!==json_path_1.get(t,s[n],!1)&&this.emitter.emit(s[n],this.get(s[n]))}}},e.prototype.sendDelete=function(){var t=this;this.whenReadyInternal(null,function(){if(t.services.connection.isConnected){var e={topic:message_constants_1.TOPIC.RECORD,action:message_constants_1.RECORD_ACTIONS.DELETE,name:t.name};t.deletedTimeout=t.services.timeoutRegistry.add({message:e,event:constants_1.EVENT.RECORD_DELETE_TIMEOUT,duration:t.options.recordDeleteTimeout}),t.services.connection.sendMessage(e)}else t.services.storage.delete(t.name,function(){t.services.timerRegistry.requestIdleCallback(function(){t.stateMachine.transition(message_constants_1.RECORD_ACTIONS.DELETE_SUCCESS)})})})},e.prototype.recoverRecord=function(e,t,s){this.recordServices.mergeStrategy.merge(this.name,this.version,this.get(),e,t,this.onRecordRecovered,this)},e.prototype.onRecordRecovered=function(e,t,s,n,i){e&&this.services.logger.error({topic:message_constants_1.TOPIC.RECORD},constants_1.EVENT.RECORD_VERSION_EXISTS),this.version=n;var o=this.data;if(utils.deepEquals(o,i))this.stateMachine.transition("MERGED");else{var a=json_path_1.setValue(o,null,s);this.stateMachine.transition("MERGED"),utils.deepEquals(s,i)?this.applyChange(s):this.applyChange(a)}},e.prototype.checkDestroyed=function(e){return!!this.stateMachine.inEndState&&(this.services.logger.error({topic:message_constants_1.TOPIC.RECORD},constants_1.EVENT.RECORD_ALREADY_DESTROYED,{methodName:e}),!0)},e.prototype.destroy=function(){this.services.timerRegistry.remove(this.readyTimer),this.services.timeoutRegistry.clear(this.responseTimeout),this.services.timeoutRegistry.clear(this.deletedTimeout),this.services.timeoutRegistry.clear(this.discardTimeout),this.services.connection.removeOnReestablished(this.onConnectionReestablished),this.services.connection.removeOnLost(this.onConnectionLost),this.emitter.off(),this.isReady=!1,this.whenComplete(this.name)},e.prototype.onConnectionReestablished=function(){this.stateMachine.transition("RESUBSCRIBE")},e.prototype.onConnectionLost=function(){this.saveRecordToOffline()},e}(Emitter);exports.RecordCore=RecordCore;var recordStateTransitions=[{name:message_constants_1.RECORD_ACTIONS.SUBSCRIBE,from:"INITIAL",to:"SUBSCRIBING",handler:RecordCore.prototype.onSubscribing},{name:"LOAD",from:"INITIAL",to:"LOADING_OFFLINE",handler:RecordCore.prototype.onOfflineLoading},{name:"LOADED",from:"LOADING_OFFLINE",to:"READY",handler:RecordCore.prototype.onReady},{name:"RESUBSCRIBE",from:"LOADING_OFFLINE",to:"RESUBSCRIBING",handler:RecordCore.prototype.abortOfflineLoading},{name:message_constants_1.RECORD_ACTIONS.READ_RESPONSE,from:"SUBSCRIBING",to:"READY",handler:RecordCore.prototype.onReady},{name:"SUBSCRIBED",from:"RESUBSCRIBING",to:"READY"},{name:"RESUBSCRIBE",from:"INITIAL",to:"RESUBSCRIBING",handler:RecordCore.prototype.onResubscribing},{name:"RESUBSCRIBE",from:"READY",to:"RESUBSCRIBING",handler:RecordCore.prototype.onResubscribing},{name:"RESUBSCRIBE",from:"UNSUBSCRIBING",to:"RESUBSCRIBING",handler:RecordCore.prototype.onResubscribing},{name:"RESUBSCRIBED",from:"RESUBSCRIBING",to:"READY"},{name:"INVALID_VERSION",from:"RESUBSCRIBING",to:"MERGING"},{name:"MERGED",from:"MERGING",to:"READY"},{name:message_constants_1.RECORD_ACTIONS.DELETE,from:"READY",to:"DELETING"},{name:message_constants_1.RECORD_ACTIONS.DELETED,from:"READY",to:"DELETED",handler:RecordCore.prototype.onDeleted},{name:message_constants_1.RECORD_ACTIONS.DELETE_SUCCESS,from:"DELETING",to:"DELETED",handler:RecordCore.prototype.onDeleted},{name:message_constants_1.RECORD_ACTIONS.UNSUBSCRIBE,from:"READY",to:"UNSUBSCRIBING"},{name:message_constants_1.RECORD_ACTIONS.SUBSCRIBE,from:"UNSUBSCRIBING",to:"READY"},{name:message_constants_1.RECORD_ACTIONS.UNSUBSCRIBE_ACK,from:"UNSUBSCRIBING",to:"UNSUBSCRIBED",handler:RecordCore.prototype.onUnsubscribed},{name:"INVALID_VERSION",from:"READY",to:"MERGING"}];