"use strict";var Operation;Object.defineProperty(exports,"__esModule",{value:!0}),function(e){e[e.GET=0]="GET",e[e.SET=1]="SET",e[e.DELETE=2]="DELETE"}(Operation=Operation||{});var Storage=function(){function e(e){var t=this;if(this.isReady=!1,this.queuedRequests=[],this.flushTimeout=null,"undefined"==typeof indexedDB||null===indexedDB)throw new Error("IndexDB currently not supported when deepstream in node");this.flush=this.flush.bind(this);var r=indexedDB.open(e.storageDatabaseName,1);r.onerror=function(e){},r.onsuccess=function(e){t.db=e.target.result,t.onReady()},r.onupgradeneeded=function(){var e=r.result;e.objectStoreNames.contains("records")||e.createObjectStore("records",{keyPath:"name"})}}return e.prototype.get=function(e,t){this.queuedRequests.push({recordName:e,callback:t,operation:Operation.GET}),this.registerFlush()},e.prototype.set=function(e,t,r,o){this.queuedRequests.push({recordName:e,version:t,callback:o,operation:Operation.SET}),this.registerFlush()},e.prototype.delete=function(e,t){this.queuedRequests.push({recordName:e,callback:t,operation:Operation.DELETE}),this.registerFlush()},e.prototype.registerFlush=function(){this.isReady&&!this.flushTimeout&&(this.flushTimeout=setTimeout(this.flush,50))},e.prototype.flush=function(){var a=this.db.transaction(["records"],"readwrite").objectStore("records");this.queuedRequests.forEach(function(e){var t=e.operation,r=e.recordName,o=e.version,s=e.data,n=e.callback;switch(t){case Operation.GET:var u=a.get(r);u.onerror=function(e){throw new Error("Requesting record "+r+" failed")},u.onsuccess=function(){u.result?n(u.result.name,u.result.version,u.result.data):n(r,-1,null)};break;case Operation.DELETE:(i=a.delete(r)).onsuccess=function(){return n(null)},i.onerror=function(e){return n(e.errorCode)};break;case Operation.SET:var i;(i=a.put({name:r,version:o,data:s})).onsuccess=function(){return n(null)},i.onerror=function(e){return n(e.errorCode)}}}),this.queuedRequests=[],this.flushTimeout=null},e.prototype.onReady=function(){this.isReady=!0,this.flush()},e}();exports.Storage=Storage;