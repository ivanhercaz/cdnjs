"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var constants_1=require("../constants"),message_constants_1=require("../../binary-protocol/src/message-constants"),message_parser_1=require("../../binary-protocol/src/message-parser"),state_machine_1=require("../util/state-machine"),utils=require("../util/utils"),Emitter=require("component-emitter2"),Connection=function(){function t(t,n,e,s){var i=this;this.services=t,this.options=n,this.reconnectTimeout=-1,this.authParams=null,this.handlers=new Map,this.authCallback=null,this.resumeCallback=null,this.emitter=s,this.internalEmitter=new Emitter,this.isInLimbo=!0,this.clientData=null,this.heartbeatIntervalTimeout=null,this.endpoint=null,this.reconnectionAttempt=0,this.limboTimeout=null;var o=!1,a=!0;this.stateMachine=new state_machine_1.StateMachine(this.services.logger,{init:constants_1.CONNECTION_STATE.CLOSED,onStateChanged:function(t,n){t!==n&&(s.emit(constants_1.EVENT.CONNECTION_STATE_CHANGED,t),t===constants_1.CONNECTION_STATE.RECONNECTING?(i.isInLimbo=!0,o=!0,n!==constants_1.CONNECTION_STATE.CLOSED&&(i.internalEmitter.emit(constants_1.EVENT.CONNECTION_LOST),i.limboTimeout=i.services.timerRegistry.add({duration:i.options.offlineBufferTimeout,context:i,callback:function(){i.isInLimbo=!1,i.internalEmitter.emit(constants_1.EVENT.EXIT_LIMBO)}}))):t===constants_1.CONNECTION_STATE.OPEN&&(o||a)&&(a=!1,i.isInLimbo=!1,i.internalEmitter.emit(constants_1.EVENT.CONNECTION_REESTABLISHED),i.services.timerRegistry.remove(i.limboTimeout)))},transitions:[{name:"initialised",from:constants_1.CONNECTION_STATE.CLOSED,to:constants_1.CONNECTION_STATE.INITIALISING},{name:"connected",from:constants_1.CONNECTION_STATE.INITIALISING,to:constants_1.CONNECTION_STATE.AWAITING_CONNECTION},{name:"connected",from:constants_1.CONNECTION_STATE.REDIRECTING,to:constants_1.CONNECTION_STATE.AWAITING_CONNECTION},{name:"connected",from:constants_1.CONNECTION_STATE.RECONNECTING,to:constants_1.CONNECTION_STATE.AWAITING_CONNECTION},{name:"challenge",from:constants_1.CONNECTION_STATE.AWAITING_CONNECTION,to:constants_1.CONNECTION_STATE.CHALLENGING},{name:"redirected",from:constants_1.CONNECTION_STATE.CHALLENGING,to:constants_1.CONNECTION_STATE.REDIRECTING},{name:"challenge-denied",from:constants_1.CONNECTION_STATE.CHALLENGING,to:constants_1.CONNECTION_STATE.CHALLENGE_DENIED},{name:"accepted",from:constants_1.CONNECTION_STATE.CHALLENGING,to:constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION,handler:this.onAwaitingAuthentication.bind(this)},{name:"authentication-timeout",from:constants_1.CONNECTION_STATE.AWAITING_CONNECTION,to:constants_1.CONNECTION_STATE.AUTHENTICATION_TIMEOUT},{name:"authentication-timeout",from:constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION,to:constants_1.CONNECTION_STATE.AUTHENTICATION_TIMEOUT},{name:"authenticate",from:constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION,to:constants_1.CONNECTION_STATE.AUTHENTICATING},{name:"unsuccesful-login",from:constants_1.CONNECTION_STATE.AUTHENTICATING,to:constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION},{name:"succesful-login",from:constants_1.CONNECTION_STATE.AUTHENTICATING,to:constants_1.CONNECTION_STATE.OPEN},{name:"too-many-auth-attempts",from:constants_1.CONNECTION_STATE.AUTHENTICATING,to:constants_1.CONNECTION_STATE.TOO_MANY_AUTH_ATTEMPTS},{name:"too-many-auth-attempts",from:constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION,to:constants_1.CONNECTION_STATE.TOO_MANY_AUTH_ATTEMPTS},{name:"authentication-timeout",from:constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION,to:constants_1.CONNECTION_STATE.AUTHENTICATION_TIMEOUT},{name:"reconnect",from:constants_1.CONNECTION_STATE.RECONNECTING,to:constants_1.CONNECTION_STATE.RECONNECTING},{name:"closed",from:constants_1.CONNECTION_STATE.CLOSING,to:constants_1.CONNECTION_STATE.CLOSED},{name:"offline",from:constants_1.CONNECTION_STATE.PAUSING,to:constants_1.CONNECTION_STATE.OFFLINE},{name:"error",to:constants_1.CONNECTION_STATE.RECONNECTING},{name:"connection-lost",to:constants_1.CONNECTION_STATE.RECONNECTING},{name:"resume",to:constants_1.CONNECTION_STATE.RECONNECTING},{name:"pause",to:constants_1.CONNECTION_STATE.PAUSING},{name:"close",to:constants_1.CONNECTION_STATE.CLOSING}]}),this.stateMachine.transition("initialised"),this.originalUrl=utils.parseUrl(e,this.options.path),this.url=this.originalUrl,n.lazyConnect||this.createEndpoint()}return Object.defineProperty(t.prototype,"isConnected",{get:function(){return this.stateMachine.state===constants_1.CONNECTION_STATE.OPEN},enumerable:!0,configurable:!0}),t.prototype.onLost=function(t){this.internalEmitter.on(constants_1.EVENT.CONNECTION_LOST,t)},t.prototype.removeOnLost=function(t){this.internalEmitter.off(constants_1.EVENT.CONNECTION_LOST,t)},t.prototype.onReestablished=function(t){this.internalEmitter.on(constants_1.EVENT.CONNECTION_REESTABLISHED,t)},t.prototype.removeOnReestablished=function(t){this.internalEmitter.off(constants_1.EVENT.CONNECTION_REESTABLISHED,t)},t.prototype.onExitLimbo=function(t){this.internalEmitter.on(constants_1.EVENT.EXIT_LIMBO,t)},t.prototype.registerHandler=function(t,n){this.handlers.set(t,n)},t.prototype.sendMessage=function(t){this.isOpen()?this.endpoint&&this.endpoint.sendParsedMessage(t):this.services.logger.error(t,constants_1.EVENT.IS_CLOSED)},t.prototype.authenticate=function(t,n){if(t&&"object"!=typeof t&&"function"!=typeof t)throw new Error("invalid argument authParamsOrCallback");if(n&&"function"!=typeof n)throw new Error("invalid argument callback");this.stateMachine.state!==constants_1.CONNECTION_STATE.CHALLENGE_DENIED&&this.stateMachine.state!==constants_1.CONNECTION_STATE.TOO_MANY_AUTH_ATTEMPTS&&this.stateMachine.state!==constants_1.CONNECTION_STATE.AUTHENTICATION_TIMEOUT?(t&&(this.authParams="object"==typeof t?t:{}),this.authCallback=t&&"function"==typeof t?t:n||function(){},this.stateMachine.state===constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION&&this.authParams&&this.sendAuthParams(),this.endpoint||this.createEndpoint()):this.services.logger.error({topic:message_constants_1.TOPIC.CONNECTION},constants_1.EVENT.IS_CLOSED)},t.prototype.getConnectionState=function(){return this.stateMachine.state},t.prototype.isOpen=function(){var t=this.getConnectionState();return t!==constants_1.CONNECTION_STATE.CLOSED&&t!==constants_1.CONNECTION_STATE.ERROR&&t!==constants_1.CONNECTION_STATE.CLOSING},t.prototype.close=function(){this.services.timerRegistry.remove(this.heartbeatIntervalTimeout),this.sendMessage({topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.CLOSING}),this.stateMachine.transition("close")},t.prototype.pause=function(){this.stateMachine.transition("pause"),this.services.timerRegistry.remove(this.heartbeatIntervalTimeout),this.endpoint&&this.endpoint.close()},t.prototype.resume=function(t){this.stateMachine.transition("resume"),this.resumeCallback=t,this.tryReconnect()},t.prototype.createEndpoint=function(){this.endpoint=this.services.socketFactory(this.url,this.options.socketOptions,this.options.heartbeatInterval),this.endpoint.onopened=this.onOpen.bind(this),this.endpoint.onerror=this.onError.bind(this),this.endpoint.onclosed=this.onClose.bind(this),this.endpoint.onparsedmessages=this.onMessages.bind(this)},t.prototype.onOpen=function(){this.clearReconnect(),this.checkHeartBeat(),this.stateMachine.transition("connected"),this.sendMessage({topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.CHALLENGE,url:this.originalUrl,protocolVersion:"0.1a"}),this.stateMachine.transition("challenge")},t.prototype.onError=function(e){var t=this;setTimeout(function(){var n;if("ECONNRESET"===e.code||"ECONNREFUSED"===e.code)n="Can't connect! Deepstream server unreachable on "+t.originalUrl;else try{n=JSON.stringify(e)}catch(t){n=e.toString()}t.services.logger.error({topic:message_constants_1.TOPIC.CONNECTION},constants_1.EVENT.CONNECTION_ERROR,n)},1),this.services.timerRegistry.remove(this.heartbeatIntervalTimeout),this.stateMachine.transition("error"),this.tryReconnect()},t.prototype.onClose=function(){this.services.timerRegistry.remove(this.heartbeatIntervalTimeout),this.stateMachine.state!==constants_1.CONNECTION_STATE.REDIRECTING?this.stateMachine.state!==constants_1.CONNECTION_STATE.CHALLENGE_DENIED&&this.stateMachine.state!==constants_1.CONNECTION_STATE.TOO_MANY_AUTH_ATTEMPTS&&this.stateMachine.state!==constants_1.CONNECTION_STATE.AUTHENTICATION_TIMEOUT&&(this.stateMachine.state!==constants_1.CONNECTION_STATE.CLOSING?this.stateMachine.state!==constants_1.CONNECTION_STATE.PAUSING?(this.stateMachine.transition("connection-lost"),this.tryReconnect()):this.stateMachine.transition("offline"):this.stateMachine.transition("closed")):this.createEndpoint()},t.prototype.onMessages=function(t){var i=this;t.forEach(function(t){if(t.parseError)i.services.logger.error({topic:message_constants_1.TOPIC.PARSER},t.action,t.raw&&t.raw.toString());else{var n=t,e=message_parser_1.parseData(n);if(!0!==e&&i.services.logger.error({topic:message_constants_1.TOPIC.PARSER},message_constants_1.PARSER_ACTIONS.INVALID_MESSAGE,e),null!==n)if(n.topic!==message_constants_1.TOPIC.CONNECTION)if(n.topic!==message_constants_1.TOPIC.AUTH){var s=i.handlers.get(n.topic);s&&s(n)}else i.handleAuthResponse(n);else i.handleConnectionResponse(n)}})},t.prototype.sendAuthParams=function(){this.stateMachine.transition("authenticate"),this.sendMessage({topic:message_constants_1.TOPIC.AUTH,action:message_constants_1.AUTH_ACTIONS.REQUEST,parsedData:this.authParams})},t.prototype.checkHeartBeat=function(){var t=2*this.options.heartbeatInterval;if(this.endpoint)return this.endpoint.getTimeSinceLastMessage()>t?(this.services.timerRegistry.remove(this.heartbeatIntervalTimeout),this.services.logger.error({topic:message_constants_1.TOPIC.CONNECTION},constants_1.EVENT.HEARTBEAT_TIMEOUT),void this.endpoint.close()):void(this.heartbeatIntervalTimeout=this.services.timerRegistry.add({duration:this.options.heartbeatInterval,callback:this.checkHeartBeat,context:this}))},t.prototype.tryReconnect=function(){if(null===this.reconnectTimeout){if(this.reconnectionAttempt<this.options.maxReconnectAttempts)return this.stateMachine.transition("reconnect"),this.reconnectTimeout=this.services.timerRegistry.add({callback:this.tryOpen,context:this,duration:Math.min(this.options.maxReconnectInterval,this.options.reconnectIntervalIncrement*this.reconnectionAttempt)}),void this.reconnectionAttempt++;this.emitter.emit(constants_1.EVENT[constants_1.EVENT.MAX_RECONNECTION_ATTEMPTS_REACHED],this.reconnectionAttempt),this.clearReconnect(),this.close()}},t.prototype.tryOpen=function(){this.stateMachine.state!==constants_1.CONNECTION_STATE.REDIRECTING&&(this.url=this.originalUrl),this.createEndpoint(),this.reconnectTimeout=null},t.prototype.clearReconnect=function(){this.services.timerRegistry.remove(this.reconnectTimeout),this.reconnectTimeout=null,this.reconnectionAttempt=0},t.prototype.handleConnectionResponse=function(t){if(t.action!==message_constants_1.CONNECTION_ACTIONS.ACCEPT)return t.action===message_constants_1.CONNECTION_ACTIONS.REJECT?(this.stateMachine.transition("challenge-denied"),void(this.endpoint&&this.endpoint.close())):t.action===message_constants_1.CONNECTION_ACTIONS.REDIRECT?(this.url=t.url,this.stateMachine.transition("redirected"),void(this.endpoint&&this.endpoint.close())):void(t.action===message_constants_1.CONNECTION_ACTIONS.AUTHENTICATION_TIMEOUT&&(this.stateMachine.transition("authentication-timeout"),this.services.logger.error(t)));this.stateMachine.transition("accepted")},t.prototype.handleAuthResponse=function(t){return t.action===message_constants_1.AUTH_ACTIONS.TOO_MANY_AUTH_ATTEMPTS?(this.stateMachine.transition("too-many-auth-attempts"),void this.services.logger.error(t)):t.action===message_constants_1.AUTH_ACTIONS.AUTH_UNSUCCESSFUL?(this.stateMachine.transition("unsuccesful-login"),void this.onAuthUnSuccessful()):t.action===message_constants_1.AUTH_ACTIONS.AUTH_SUCCESSFUL?(this.stateMachine.transition("succesful-login"),void this.onAuthSuccessful(t.parsedData)):void 0},t.prototype.onAwaitingAuthentication=function(){this.authParams&&this.sendAuthParams()},t.prototype.onAuthSuccessful=function(t){this.updateClientData(t),this.resumeCallback&&(this.resumeCallback(),this.resumeCallback=null),null!==this.authCallback&&(this.authCallback(!0,this.clientData),this.authCallback=null)},t.prototype.onAuthUnSuccessful=function(){var t={reason:constants_1.EVENT[constants_1.EVENT.INVALID_AUTHENTICATION_DETAILS]};this.resumeCallback&&(this.resumeCallback(t),this.resumeCallback=null),null!==this.authCallback?(this.authCallback(!1,t),this.authCallback=null):this.emitter.emit(constants_1.EVENT.REAUTHENTICATION_FAILURE,t)},t.prototype.updateClientData=function(t){var n=t||null;(null!==this.clientData||null!==n&&0!==Object.keys(n).length)&&(utils.deepEquals(this.clientData,t)||(this.emitter.emit(constants_1.EVENT.CLIENT_DATA_CHANGED,Object.assign({},n)),this.clientData=n))},t}();exports.Connection=Connection;