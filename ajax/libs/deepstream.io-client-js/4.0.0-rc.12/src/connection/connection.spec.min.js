"use strict";var __awaiter=this&&this.__awaiter||function(a,i,c,o){return new(c=c||Promise)(function(e,t){function n(e){try{r(o.next(e))}catch(e){t(e)}}function s(e){try{r(o.throw(e))}catch(e){t(e)}}function r(t){t.done?e(t.value):new c(function(e){e(t.value)}).then(n,s)}r((o=o.apply(a,i||[])).next())})},__generator=this&&this.__generator||function(n,s){var r,a,i,e,c={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(r)throw new TypeError("Generator is already executing.");for(;c;)try{if(r=1,a&&(i=2&t[0]?a.return:t[0]?a.throw||((i=a.return)&&i.call(a),0):a.next)&&!(i=i.call(a,t[1])).done)return i;switch(a=0,i&&(t=[2&t[0],i.value]),t[0]){case 0:case 1:i=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,a=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(i=0<(i=c.trys).length&&i[i.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!i||t[1]>i[0]&&t[1]<i[3])){c.label=t[1];break}if(6===t[0]&&c.label<i[1]){c.label=i[1],i=t;break}if(i&&c.label<i[2]){c.label=i[2],c.ops.push(t);break}i[2]&&c.ops.pop(),c.trys.pop();continue}t=s.call(n,c)}catch(e){t=[6,e],a=0}finally{r=i=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0});var bluebird_1=require("bluebird"),chai_1=require("chai"),sinon_1=require("sinon"),connection_1=require("./connection"),mocks_1=require("../test/mocks"),client_options_1=require("../client-options"),constants_1=require("../constants"),message_constants_1=require("../../binary-protocol/src/message-constants"),Emitter=require("component-emitter2");describe("connection",function(){var n,t,s,r,a,i,c,o,_,u="wss://localhost:6020/deepstream",N={password:"123456"},T={name:"elton"},E="wss://localhost:6020/deepstream",C="wss://otherhost:6020/deepstream";function l(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return i.simulateOpen(),[4,bluebird_1.Promise.delay(0)];case 1:return e.sent(),[2]}})})}function O(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.AWAITING_CONNECTION),a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.CHALLENGING),chai_1.expect(i.url).to.equal(E),i.simulateOpen(),[4,bluebird_1.Promise.delay(0)];case 1:return e.sent(),[2]}})})}function h(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return c.expects("sendParsedMessage").once().withExactArgs([{topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.CHALLENGE,url:u}]),[4,bluebird_1.Promise.delay(0)];case 1:return e.sent(),[2]}})})}function A(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION),i.simulateMessages([{topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.ACCEPT}]),[4,bluebird_1.Promise.delay(0)];case 1:return e.sent(),[2]}})})}function d(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return i.simulateMessages([{topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.REJECT}]),[4,bluebird_1.Promise.delay(0)];case 1:return e.sent(),[2]}})})}function I(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.AUTHENTICATING),c.expects("sendParsedMessage").once().withExactArgs({topic:message_constants_1.TOPIC.AUTH,action:message_constants_1.AUTH_ACTIONS.REQUEST,parsedData:N}),n.authenticate(N,_),[4,bluebird_1.Promise.delay(0)];case 1:return e.sent(),[2]}})})}function f(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=n||T,a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.OPEN),a.expects("emit").once().withExactArgs(constants_1.EVENT.CLIENT_DATA_CHANGED,Object.assign({},t)),i.simulateMessages([{topic:message_constants_1.TOPIC.AUTH,action:message_constants_1.AUTH_ACTIONS.AUTH_SUCCESSFUL,parsedData:Object.assign({},t)}]),[4,bluebird_1.Promise.delay(5)];case 1:return e.sent(),[2]}})})}function g(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return o.expects("error").once().withExactArgs({topic:message_constants_1.TOPIC.CONNECTION},constants_1.EVENT.CONNECTION_ERROR,JSON.stringify({code:1234})),i.simulateError(),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),[2]}})})}function m(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return i.simulateMessages([{topic:message_constants_1.TOPIC.AUTH,action:message_constants_1.AUTH_ACTIONS.AUTH_UNSUCCESSFUL,parsedData:message_constants_1.AUTH_ACTIONS.INVALID_MESSAGE_DATA}]),[4,bluebird_1.Promise.delay(10)];case 1:return e.sent(),[2]}})})}function w(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.RECONNECTING),i.close(),[4,bluebird_1.Promise.delay(2)];case 1:return e.sent(),chai_1.expect(n.isConnected).to.equal(!1),[2]}})})}function b(){var e=t.getSocket();i=e.socket,c=e.socketMock}beforeEach(function(){var e;t=mocks_1.getServicesMock(),s=Object.assign(client_options_1.DefaultOptions,{heartbeatInterval:15,reconnectIntervalIncrement:20,maxReconnectAttempts:3,maxReconnectInterval:300,offlineBufferTimeout:10}),r=new Emitter,a=sinon_1.mock(r),n=new connection_1.Connection(t,s,E,r),b(),e=t.getLogger(),o=e.loggerMock,_=sinon_1.spy()}),afterEach(function(){t.verify(),a.verify(),o.verify()}),it("supports happiest path",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,O()];case 1:return e.sent(),[4,h()];case 2:return e.sent(),[4,A()];case 3:return e.sent(),[4,I()];case 4:return e.sent(),[4,f()];case 5:return e.sent(),[4,function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return i.simulateMessages([{topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.EMIT,name:"eventA"}]),[4,bluebird_1.Promise.delay(0)];case 1:return e.sent(),[2]}})})}()];case 6:return e.sent(),[4,function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.CLOSING),c.expects("sendParsedMessage").once().withExactArgs({topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.CLOSING}),n.close(),[4,bluebird_1.Promise.delay(0)];case 1:return e.sent(),[2]}})})}()];case 7:return e.sent(),[4,function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.CLOSED),i.simulateMessages([{topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.CLOSING}]),i.simulateRemoteClose(),[4,bluebird_1.Promise.delay(0)];case 1:return e.sent(),[2]}})})}()];case 8:return e.sent(),[2]}})})}),it("send pong when ping received across all states",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,l()];case 1:return e.sent(),c.expects("sendParsedMessage").once().withExactArgs({topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.PONG}),i.simulateMessages([{topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.PING}]),[2]}})})}),it("miss heartbeat once",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,l()];case 1:return e.sent(),[4,bluebird_1.Promise.delay(22.5)];case 2:return e.sent(),[2]}})})}),it("miss a heartbeat twice and receive error",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return o.expects("error").once().withExactArgs({topic:message_constants_1.TOPIC.CONNECTION},constants_1.EVENT.HEARTBEAT_TIMEOUT),i.getTimeSinceLastMessage=function(){return 200},[4,l()];case 1:return e.sent(),[2]}})})}),it("get redirected to server B while connecting to server A, reconnect to server A when connection to server B is lost",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,O()];case 1:return e.sent(),[4,h()];case 2:return e.sent(),[4,function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.REDIRECTING),i.simulateMessages([{topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.REDIRECT,url:C}]),[4,bluebird_1.Promise.delay(0)];case 1:return e.sent(),[2]}})})}()];case 3:return e.sent(),[4,function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.AWAITING_CONNECTION),a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.CHALLENGING),b(),chai_1.expect(i.url).to.equal(C),i.simulateOpen(),[4,bluebird_1.Promise.delay(0)];case 1:return e.sent(),[2]}})})}()];case 4:return e.sent(),[4,h()];case 5:return e.sent(),[4,A()];case 6:return e.sent(),[4,w()];case 7:return e.sent(),[4,function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return c.expects("onopen").once(),c.expects("sendParsedMessage").once().withExactArgs({topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.CHALLENGE,url:u}),i.simulateOpen(),[4,bluebird_1.Promise.delay(0)];case 1:return e.sent(),[2]}})})}()];case 8:return e.sent(),[2]}})})}),it("handles challenge denial",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.CHALLENGE_DENIED),[4,O()];case 1:return e.sent(),[4,h()];case 2:return e.sent(),[4,d()];case 3:return e.sent(),[2]}})})}),it("handles authentication when challenge was denied",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return o.expects("error").once().withArgs({topic:message_constants_1.TOPIC.CONNECTION},constants_1.EVENT.IS_CLOSED),a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.CHALLENGE_DENIED),[4,O()];case 1:return e.sent(),[4,h()];case 2:return e.sent(),[4,d()];case 3:return e.sent(),n.authenticate(N,_),sinon_1.assert.callCount(_,0),[4,bluebird_1.Promise.delay(10)];case 4:return e.sent(),[2]}})})}),it("handles successful authentication",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,O()];case 1:return e.sent(),[4,h()];case 2:return e.sent(),[4,A()];case 3:return e.sent(),[4,I()];case 4:return e.sent(),[4,f()];case 5:return e.sent(),sinon_1.assert.calledOnce(_),sinon_1.assert.calledWithExactly(_,!0,T),[2]}})})}),it("handles rejected authentication",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION),[4,O()];case 1:return e.sent(),[4,h()];case 2:return e.sent(),[4,A()];case 3:return e.sent(),[4,I()];case 4:return e.sent(),[4,m()];case 5:return e.sent(),sinon_1.assert.calledOnce(_),sinon_1.assert.calledWithExactly(_,!1,{reason:constants_1.EVENT.INVALID_AUTHENTICATION_DETAILS}),[2]}})})}),it("handles authenticating too may times",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.TOO_MANY_AUTH_ATTEMPTS),[4,O()];case 1:return e.sent(),[4,h()];case 2:return e.sent(),[4,A()];case 3:return e.sent(),[4,I()];case 4:return e.sent(),[4,function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return i.simulateMessages([{topic:message_constants_1.TOPIC.AUTH,action:message_constants_1.AUTH_ACTIONS.TOO_MANY_AUTH_ATTEMPTS}]),[4,bluebird_1.Promise.delay(0)];case 1:return e.sent(),[2]}})})}()];case 5:return e.sent(),[2]}})})}),it("handles authentication timeout",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.AUTHENTICATION_TIMEOUT),[4,O()];case 1:return e.sent(),[4,h()];case 2:return e.sent(),[4,A()];case 3:return e.sent(),[4,function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return i.simulateMessages([{topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.AUTHENTICATION_TIMEOUT}]),[4,bluebird_1.Promise.delay(0)];case 1:return e.sent(),[2]}})})}()];case 4:return e.sent(),[2]}})})}),it("try to authenticate with invalid data and receive error",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,O()];case 1:return e.sent(),[4,h()];case 2:return e.sent(),[4,A()];case 3:return e.sent(),[4,function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return chai_1.expect(function(){n.authenticate("Bad Auth Data",_)}).to.throw("invalid argument authParamsOrCallback"),chai_1.expect(function(){n.authenticate({},"Bad Auth Data")}).to.throw("invalid argument callback"),[4,bluebird_1.Promise.delay(0)];case 1:return e.sent(),[2]}})})}()];case 4:return e.sent(),[2]}})})}),it("tries to reconnect every time connection fails, stops when max reconnection attempts is reached and closes connection",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.CLOSING),a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.RECONNECTING),a.expects("emit").once().withExactArgs(constants_1.EVENT[constants_1.EVENT.MAX_RECONNECTION_ATTEMPTS_REACHED],3),[4,O()];case 1:return e.sent(),[4,h()];case 2:return e.sent(),[4,A()];case 3:return e.sent(),[4,g()];case 4:return e.sent(),[4,bluebird_1.Promise.delay(0)];case 5:return e.sent(),[4,g()];case 6:return e.sent(),[4,bluebird_1.Promise.delay(25)];case 7:return e.sent(),[4,g()];case 8:return e.sent(),[4,bluebird_1.Promise.delay(45)];case 9:return e.sent(),[4,g()];case 10:return e.sent(),[4,bluebird_1.Promise.delay(70)];case 11:return e.sent(),[2]}})})}),it("tries to reconnect if the connection drops unexpectedly",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.RECONNECTING),[4,O()];case 1:return e.sent(),[4,h()];case 2:return e.sent(),[4,A()];case 3:return e.sent(),[4,g()];case 4:return e.sent(),[2]}})})}),it("emits reauthenticationFailure if reauthentication is rejected",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.RECONNECTING),a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION),a.expects("emit").once().withExactArgs(constants_1.EVENT.REAUTHENTICATION_FAILURE,{reason:constants_1.EVENT.INVALID_AUTHENTICATION_DETAILS}),[4,O()];case 1:return e.sent(),[4,h()];case 2:return e.sent(),[4,A()];case 3:return e.sent(),[4,I()];case 4:return e.sent(),[4,f()];case 5:return e.sent(),[4,g()];case 6:return e.sent(),[4,bluebird_1.Promise.delay(0)];case 7:return e.sent(),[4,O()];case 8:return e.sent(),[4,h()];case 9:return e.sent(),[4,function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION),a.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.AUTHENTICATING),c.expects("sendParsedMessage").once().withExactArgs({topic:message_constants_1.TOPIC.AUTH,action:message_constants_1.AUTH_ACTIONS.REQUEST,parsedData:N}),i.simulateMessages([{topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.ACCEPT}]),[4,bluebird_1.Promise.delay(0)];case 1:return e.sent(),[2]}})})}()];case 10:return e.sent(),[4,m()];case 11:return e.sent(),[4,bluebird_1.Promise.delay(0)];case 12:return e.sent(),sinon_1.assert.calledOnce(_),[2]}})})}),it("goes into limbo on connection lost",function(){return __awaiter(_this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,l()];case 1:return e.sent(),t=sinon_1.spy(),n.onExitLimbo(t),[4,w()];case 2:return e.sent(),chai_1.expect(n.isInLimbo).to.equal(!0),[4,bluebird_1.Promise.delay(20)];case 3:return e.sent(),sinon_1.assert.calledOnce(t),chai_1.expect(n.isInLimbo).to.equal(!1),[2]}})})})});