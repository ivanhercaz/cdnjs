"use strict";var __extends=this&&this.__extends||function(){var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var n in e=arguments[r])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)},__values=this&&this.__values||function(t){var e="function"==typeof Symbol&&t[Symbol.iterator],r=0;return e?e.call(t):{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}}},__read=this&&this.__read||function(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var i,n,o=r.call(t),s=[];try{for(;(void 0===e||0<e--)&&!(i=o.next()).done;)s.push(i.value)}catch(t){n={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return s};Object.defineProperty(exports,"__esModule",{value:!0});var constants_1=require("../constants"),utils_1=require("../../binary-protocol/src/utils"),EventEmitter=require("component-emitter2"),TimeoutRegistry=function(i){function t(t,e){var r=i.call(this)||this;return r.services=t,r.options=e,r.register=new Map,r}return __extends(t,i),t.prototype.add=function(t){if(void 0===t.duration&&(t.duration=this.options.subscriptionTimeout),void 0===t.event&&(t.event=constants_1.EVENT.ACK_TIMEOUT),!this.services.connection.isConnected)return null;this.remove(t.message);var e={timerId:-1,uniqueName:this.getUniqueName(t.message),timeout:t};return e.timerId=this.services.timerRegistry.add({context:this,callback:this.onTimeout,duration:t.duration,data:e}),this.register.set(e.uniqueName,e),e.uniqueName},t.prototype.remove=function(t){var e,r=utils_1.RESPONSE_TO_REQUEST[t.topic][t.action];e=r?__assign({},t,{action:r}):t;var i=this.getUniqueName(e);this.clear(i)},t.prototype.clear=function(t){var e=this.register.get(t);e&&(this.register.delete(t),this.services.timerRegistry.remove(e.timerId))},t.prototype.onTimeout=function(t){this.register.delete(t.uniqueName);var e=t.timeout;e.callback?e.callback(e.event,e.message):this.services.logger.warn(e.message,e.event)},t.prototype.getUniqueName=function(t){var e=t.originalAction||t.action,r=""+t.topic+e+"_";return t.correlationId?r+=t.correlationId:t.name&&(r+=t.name),r},t.prototype.onConnectionLost=function(){var e,t;try{for(var r=__values(this.register),i=r.next();!i.done;i=r.next()){var n=__read(i.value,2),o=n[0],s=n[1];this.services.timerRegistry.remove(s.timerId),this.register.delete(o)}}catch(t){e={error:t}}finally{try{i&&!i.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}},t}(EventEmitter);exports.TimeoutRegistry=TimeoutRegistry;