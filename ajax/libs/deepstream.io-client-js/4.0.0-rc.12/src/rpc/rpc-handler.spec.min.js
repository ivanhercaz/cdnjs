"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var n,t=1,s=arguments.length;t<s;t++)for(var a in n=arguments[t])Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(o,i,r,c){return new(r=r||Promise)(function(e,n){function t(e){try{a(c.next(e))}catch(e){n(e)}}function s(e){try{a(c.throw(e))}catch(e){n(e)}}function a(n){n.done?e(n.value):new r(function(e){e(n.value)}).then(t,s)}a((c=c.apply(o,i||[])).next())})},__generator=this&&this.__generator||function(t,s){var a,o,i,e,r={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return e={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function n(n){return function(e){return function(n){if(a)throw new TypeError("Generator is already executing.");for(;r;)try{if(a=1,o&&(i=2&n[0]?o.return:n[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,n[1])).done)return i;switch(o=0,i&&(n=[2&n[0],i.value]),n[0]){case 0:case 1:i=n;break;case 4:return r.label++,{value:n[1],done:!1};case 5:r.label++,o=n[1],n=[0];continue;case 7:n=r.ops.pop(),r.trys.pop();continue;default:if(!(i=0<(i=r.trys).length&&i[i.length-1])&&(6===n[0]||2===n[0])){r=0;continue}if(3===n[0]&&(!i||n[1]>i[0]&&n[1]<i[3])){r.label=n[1];break}if(6===n[0]&&r.label<i[1]){r.label=i[1],i=n;break}if(i&&r.label<i[2]){r.label=i[2],r.ops.push(n);break}i[2]&&r.ops.pop(),r.trys.pop();continue}n=s.call(t,r)}catch(e){n=[6,e],o=0}finally{a=i=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,e])}}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0});var bluebird_1=require("bluebird"),chai_1=require("chai"),sinon=require("sinon"),mocks_1=require("../test/mocks"),constants_1=require("../constants"),message_constants_1=require("../../binary-protocol/src/message-constants"),client_options_1=require("../client-options"),rpc_handler_1=require("./rpc-handler"),rpc_response_1=require("./rpc-response"),timeout_registry_1=require("../util/timeout-registry");describe("RPC handler",function(){var c,_,l,t,n,d,u="myRpc",C=__assign({},client_options_1.DefaultOptions,{rpcAcceptTimeout:10,rpcResponseTimeout:30});beforeEach(function(){c=mocks_1.getServicesMock(),_=new rpc_handler_1.RPCHandler(c,C),l=c.getHandle(),t=sinon.spy(),n=sinon.spy(),d={foo:"bar"}}),afterEach(function(){c.connectionMock.verify(),c.timeoutRegistryMock.verify(),c.loggerMock.verify()}),it("validates parameters on provide, unprovide and make",function(){chai_1.expect(_.provide.bind(_,"",function(){})).to.throw(),chai_1.expect(_.unprovide.bind(_,"")).to.throw(),chai_1.expect(_.unprovide.bind(_)).to.throw(),chai_1.expect(_.make.bind(_,"")).to.throw(),chai_1.expect(_.make.bind(_)).to.throw()}),it("registers a provider",function(){var e={topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.PROVIDE,name:u};c.connectionMock.expects("sendMessage").once().withExactArgs(e),c.timeoutRegistryMock.expects("add").once().withExactArgs({message:e}),_.provide(u,t),sinon.assert.notCalled(t)}),it("reregisters a provider after a connection reconnection",function(){var e={topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.PROVIDE,name:u};c.connectionMock.expects("sendMessage").twice().withExactArgs(e),c.timeoutRegistryMock.expects("add").twice().withExactArgs({message:e}),_.provide(u,t),c.simulateConnectionReestablished(),sinon.assert.notCalled(t)}),it("sends rpc request message on make",function(){c.connectionMock.expects("sendMessage").once().withExactArgs({topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.REQUEST,name:u,parsedData:d,correlationId:sinon.match.any}),_.make(u,d,function(){})}),it("returns promise on make when no callback is passed",function(){c.connectionMock.expects("sendMessage").once();var e=_.make(u,d);chai_1.expect(e).to.be.a("promise")}),it("cant't make requests when client is offline",function(){return __awaiter(_this,void 0,void 0,function(){var n,t,s;return __generator(this,function(e){switch(e.label){case 0:return n=sinon.spy(),t=sinon.spy(),s=sinon.spy(),c.connection.isConnected=!1,_.make(u,d,n),_.make(u,d).then(s).catch(t),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon.assert.calledOnce(n),sinon.assert.calledWithExactly(n,constants_1.EVENT.CLIENT_OFFLINE),sinon.assert.notCalled(s),sinon.assert.calledOnce(t),sinon.assert.calledWithExactly(t,constants_1.EVENT.CLIENT_OFFLINE),[2]}})})}),it("doesn't reply rpc and sends rejection if no provider exists",function(){c.connectionMock.expects("sendMessage").once().withExactArgs({topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.REJECT,name:u,correlationId:"123"}),c.timeoutRegistryMock.expects("add").never(),l({topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.REQUEST,name:u,parsedData:d,correlationId:"123"})}),it("handles ack messages",function(){var e={topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.PROVIDE_ACK,name:u,isAck:!0};c.timeoutRegistryMock.expects("remove").once().withExactArgs(e),l(e)}),it("handles permission and message denied errors for provide and unprovide",function(){function e(e){c.timeoutRegistryMock.expects("remove").once().withExactArgs(e),c.loggerMock.expects("error").once().withExactArgs(e)}var n={topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.MESSAGE_PERMISSION_ERROR,name:u,originalAction:message_constants_1.RPC_ACTIONS.PROVIDE},t={topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.MESSAGE_PERMISSION_ERROR,name:u,originalAction:message_constants_1.RPC_ACTIONS.UNPROVIDE},s={topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.MESSAGE_DENIED,name:u,originalAction:message_constants_1.RPC_ACTIONS.PROVIDE},a={topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.MESSAGE_DENIED,name:u,originalAction:message_constants_1.RPC_ACTIONS.UNPROVIDE};e(n),e(t),e(s),e(a),l(n),l(t),l(s),l(a)}),it("logs unknown correlation error when handling unknown rpc response",function(){var e={topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.ACCEPT,name:u,correlationId:"123abc"};c.loggerMock.expects("error").once().withExactArgs(e,constants_1.EVENT.UNKNOWN_CORRELATION_ID),l(e)}),describe("when providing",function(){beforeEach(function(){_.provide(u,t)}),it("doesn't register provider twice",function(){c.connectionMock.expects("sendMessage").never(),c.timeoutRegistryMock.expects("add").never(),chai_1.expect(_.provide.bind(_,u,t)).to.throw("RPC myRpc already registered")}),it("triggers rpc provider callback in a new request",function(){var e={topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.REQUEST,name:u,parsedData:d,correlationId:"123"},n=new rpc_response_1.RPCResponse(e,C,c);l(e),sinon.assert.calledOnce(t),sinon.assert.calledWithExactly(t,d,n)}),it("deregisters providers",function(){var e={topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.UNPROVIDE,name:u};c.connectionMock.expects("sendMessage").once().withExactArgs(e),c.timeoutRegistryMock.expects("add").once().withExactArgs({message:e}),_.unprovide(u)}),it("doesn't send deregister provider message twice",function(){c.connectionMock.expects("sendMessage").once(),c.timeoutRegistryMock.expects("add").once(),c.loggerMock.expects("warn").once(),_.unprovide(u),_.unprovide(u)})}),describe("when making",function(){var s,a,o,i,r;beforeEach(function(){c.timeoutRegistry=new timeout_registry_1.TimeoutRegistry(c,C),s=sinon.spy(),_.make(u,d,s),i=mocks_1.getLastMessageSent().correlationId,a=sinon.spy(),o=sinon.spy(),_.make(u,d).then(a).catch(o),r=mocks_1.getLastMessageSent().correlationId}),it("handles permission errors",function(){return __awaiter(_this,void 0,void 0,function(){var n,t;return __generator(this,function(e){switch(e.label){case 0:return n=message_constants_1.RPC_ACTIONS.MESSAGE_PERMISSION_ERROR,(t=function(e){return l({topic:message_constants_1.TOPIC.RPC,action:n,name:u,originalAction:message_constants_1.RPC_ACTIONS.REQUEST,correlationId:e})})(i),t(r),[4,bluebird_1.Promise.delay(20)];case 1:return e.sent(),sinon.assert.calledOnce(s),sinon.assert.calledWithExactly(s,message_constants_1.RPC_ACTIONS[n]),sinon.assert.notCalled(a),sinon.assert.calledOnce(o),sinon.assert.calledWithExactly(o,message_constants_1.RPC_ACTIONS[n]),[2]}})})}),it("handles message denied errors",function(){return __awaiter(_this,void 0,void 0,function(){var n,t;return __generator(this,function(e){switch(e.label){case 0:return n=message_constants_1.RPC_ACTIONS.MESSAGE_DENIED,(t=function(e){return l({topic:message_constants_1.TOPIC.RPC,action:n,name:u,originalAction:message_constants_1.RPC_ACTIONS.REQUEST,correlationId:e})})(i),t(r),[4,bluebird_1.Promise.delay(20)];case 1:return e.sent(),sinon.assert.calledOnce(s),sinon.assert.calledWithExactly(s,message_constants_1.RPC_ACTIONS[n]),sinon.assert.notCalled(a),sinon.assert.calledOnce(o),sinon.assert.calledWithExactly(o,message_constants_1.RPC_ACTIONS[n]),[2]}})})}),it("responds rpc with error when request is not accepted in time",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,bluebird_1.Promise.delay(20)];case 1:return e.sent(),sinon.assert.calledOnce(s),sinon.assert.calledWithExactly(s,message_constants_1.RPC_ACTIONS[message_constants_1.RPC_ACTIONS.ACCEPT_TIMEOUT]),sinon.assert.notCalled(a),sinon.assert.calledOnce(o),sinon.assert.calledWithExactly(o,message_constants_1.RPC_ACTIONS[message_constants_1.RPC_ACTIONS.ACCEPT_TIMEOUT]),[2]}})})}),it("handles the rpc response accepted message",function(){return __awaiter(_this,void 0,void 0,function(){var n;return __generator(this,function(e){switch(e.label){case 0:return(n=function(e){return l({topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.ACCEPT,name:u,correlationId:e})})(i),n(r),[4,bluebird_1.Promise.delay(20)];case 1:return e.sent(),sinon.assert.notCalled(s),sinon.assert.notCalled(o),sinon.assert.notCalled(a),[2]}})})}),it("calls rpcResponse with error when response is not sent in time",function(){return __awaiter(_this,void 0,void 0,function(){var n;return __generator(this,function(e){switch(e.label){case 0:return(n=function(e){return l({topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.ACCEPT,name:u,correlationId:e})})(i),n(r),[4,bluebird_1.Promise.delay(60)];case 1:return e.sent(),sinon.assert.calledOnce(s),sinon.assert.calledWithExactly(s,message_constants_1.RPC_ACTIONS[message_constants_1.RPC_ACTIONS.RESPONSE_TIMEOUT]),sinon.assert.notCalled(a),sinon.assert.calledOnce(o),sinon.assert.calledWithExactly(o,message_constants_1.RPC_ACTIONS[message_constants_1.RPC_ACTIONS.RESPONSE_TIMEOUT]),[2]}})})}),it("calls rpcResponse with error when no rpc provider is returned",function(){return __awaiter(_this,void 0,void 0,function(){var n;return __generator(this,function(e){switch(e.label){case 0:return(n=function(e){return l({topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.ACCEPT,name:u,correlationId:e})})(i),n(r),l({topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.NO_RPC_PROVIDER,name:u,correlationId:i}),l({topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.NO_RPC_PROVIDER,name:u,correlationId:r}),sinon.assert.calledOnce(s),sinon.assert.calledWithExactly(s,message_constants_1.RPC_ACTIONS[message_constants_1.RPC_ACTIONS.NO_RPC_PROVIDER]),[4,bluebird_1.Promise.delay(0)];case 1:return e.sent(),sinon.assert.notCalled(a),sinon.assert.calledOnce(o),sinon.assert.calledWithExactly(o,message_constants_1.RPC_ACTIONS[message_constants_1.RPC_ACTIONS.NO_RPC_PROVIDER]),[2]}})})}),it("handles the rpc response RESPONSE message",function(){return __awaiter(_this,void 0,void 0,function(){var n;return __generator(this,function(e){switch(e.label){case 0:return(n=function(e){return l({topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.RESPONSE,name:u,correlationId:e,parsedData:d})})(i),n(r),sinon.assert.calledOnce(s),sinon.assert.calledWithExactly(s,null,d),[4,bluebird_1.Promise.delay(0)];case 1:return e.sent(),sinon.assert.notCalled(o),sinon.assert.calledOnce(a),sinon.assert.calledWithExactly(a,d),[2]}})})}),it("doesn't call rpc response callback twice when handling response message",function(){return __awaiter(_this,void 0,void 0,function(){var n;return __generator(this,function(e){switch(e.label){case 0:return(n=function(e){return l({topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.RESPONSE,name:u,correlationId:e,parsedData:d})})(i),n(i),n(r),n(r),[4,bluebird_1.Promise.delay(60)];case 1:return e.sent(),sinon.assert.calledOnce(s),sinon.assert.notCalled(o),sinon.assert.calledOnce(a),[2]}})})}),it("handles the rpc response error message",function(){return __awaiter(_this,void 0,void 0,function(){var n,t;return __generator(this,function(e){switch(e.label){case 0:return n="ERROR",(t=function(e){return l({topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.REQUEST_ERROR,name:u,correlationId:e,parsedData:n})})(i),t(r),[4,bluebird_1.Promise.delay(60)];case 1:return e.sent(),sinon.assert.calledOnce(s),sinon.assert.calledWithExactly(s,n),sinon.assert.notCalled(a),sinon.assert.calledOnce(o),sinon.assert.calledWithExactly(o,n),[2]}})})}),it("doesn't call rpc response callback twice when handling error message",function(){return __awaiter(_this,void 0,void 0,function(){var n;return __generator(this,function(e){switch(e.label){case 0:return(n=function(e){return l({topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.REQUEST_ERROR,name:u,correlationId:e,parsedData:"ERROR"})})(i),n(i),n(r),n(r),[4,bluebird_1.Promise.delay(60)];case 1:return e.sent(),sinon.assert.calledOnce(s),sinon.assert.notCalled(a),sinon.assert.calledOnce(o),[2]}})})}),it("responds with error when onConnectionLost",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return c.simulateConnectionLost(),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon.assert.calledOnce(s),sinon.assert.calledWithExactly(s,constants_1.EVENT.CLIENT_OFFLINE),sinon.assert.notCalled(a),sinon.assert.calledOnce(o),sinon.assert.calledWithExactly(o,constants_1.EVENT.CLIENT_OFFLINE),[2]}})})})}),describe("limbo",function(){beforeEach(function(){c.connection.isConnected=!1,c.connection.isInLimbo=!0}),it("returns client offline error once limbo state over",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return _.make(u,d,n),c.simulateExitLimbo(),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon.assert.calledOnce(n),sinon.assert.calledWithExactly(n,constants_1.EVENT.CLIENT_OFFLINE),[2]}})})}),it("sends messages once re-established if in limbo",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return _.make(u,d,n),c.connectionMock.expects("sendMessage").once(),c.timeoutRegistryMock.expects("add").twice(),c.simulateConnectionReestablished(),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),[2]}})})})})});