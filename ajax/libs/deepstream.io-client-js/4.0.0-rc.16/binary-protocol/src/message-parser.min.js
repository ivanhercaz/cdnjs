"use strict";var _a,_b,_c;Object.defineProperty(exports,"__esModule",{value:!0});var message_constants_1=require("./message-constants"),constants_1=require("./constants"),utils_1=require("./utils"),message_validator_1=require("./message-validator");function isError(a){return 80<=a.action&&a.action<112||a.topic===message_constants_1.TOPIC.PARSER}exports.isError=isError;var BULK_ACTIONS=((_a={})[message_constants_1.TOPIC.RECORD]=((_b={})[message_constants_1.RECORD_ACTIONS.SUBSCRIBECREATEANDREAD_BULK]=message_constants_1.RECORD_ACTIONS.SUBSCRIBECREATEANDREAD,_b[message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDHEAD_BULK]=message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDHEAD,_b[message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDREAD_BULK]=message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDREAD,_b),_a[message_constants_1.TOPIC.EVENT]=((_c={})[message_constants_1.EVENT_ACTIONS.SUBSCRIBE_BULK]=message_constants_1.EVENT_ACTIONS.SUBSCRIBE,_c[message_constants_1.EVENT_ACTIONS.UNSUBSCRIBE_BULK]=message_constants_1.EVENT_ACTIONS.UNSUBSCRIBE,_c),_a),uuid=0;function parse(r,o){void 0===o&&(o=[]);function a(){var a=readBinary(r,i),s=a.bytesConsumed,e=a.rawMessage;if(!e)return"break";if(o.push(e),i+=s,e.fin){var t=parseMessage(joinMessages(o));if(void 0===t.parseError&&!t.isAck&&BULK_ACTIONS[t.topic]&&BULK_ACTIONS[t.topic][t.action]){var n=BULK_ACTIONS[t.topic][t.action];uuid++,t.names.forEach(function(a){_.push({topic:t.topic,action:n,name:a,correlationId:t.correlationId,isBulk:!0,bulkId:uuid,bulkAction:t.action})})}else _.push(t);o.length=0}}var i=0,_=[];do{if("break"===a())break}while(i<r.length);return _}function parseData(a){return void 0!==a.parsedData||void 0===a.data||(a.payloadEncoding&&a.payloadEncoding!==message_constants_1.PAYLOAD_ENCODING.JSON?new Error("unable to parse data of type '"+a.payloadEncoding+"'"):"string"==typeof a.data?new Error("tried to parse string data with binary parser"):(a.parsedData=parseJSON(a.data),void 0!==a.parsedData||new Error("unable to parse data "+a.data)))}function readBinary(a,s){if(a.length<s+constants_1.HEADER_LENGTH)return{bytesConsumed:0};var e=!!(128&a[s]),t=127&a[s],n=a[s+1],r=a.readUIntBE(s+2,3),o=a.readUIntBE(s+5,3),i=constants_1.HEADER_LENGTH+r+o;if(a.length<s+i)return{bytesConsumed:0};var _={fin:e,topic:t,action:n,rawHeader:a.slice(s,s+constants_1.HEADER_LENGTH)};return 0<r&&(_.meta=a.slice(s+constants_1.HEADER_LENGTH,s+constants_1.HEADER_LENGTH+r)),0<o&&(_.payload=a.slice(s+constants_1.HEADER_LENGTH+r,s+i)),{bytesConsumed:i,rawMessage:_}}function joinMessages(a){if(0===a.length)throw new Error("parseMessage must not be called with an empty message queue");if(1===a.length)return a[0];var s=a[0],e=s.topic,t=s.action,n=s.rawHeader,r=[],o=[];a.forEach(function(a){var s=a.payload,e=a.meta;s&&r.push(s),e&&o.push(e)});var i=Buffer.concat(r);return{fin:!0,topic:e,action:t,rawHeader:n,meta:Buffer.concat(o),payload:i}}function parseMessage(a){var s=a.topic,e=a.action,t=a.rawHeader;if(void 0===message_constants_1.TOPIC[s])return{parseError:!0,action:message_constants_1.PARSER_ACTIONS.UNKNOWN_TOPIC,parsedMessage:{topic:s,action:e},description:"unknown topic "+s,raw:t};var n=s;if(void 0===message_constants_1.ACTIONS[n][e])return{parseError:!0,action:message_constants_1.PARSER_ACTIONS.UNKNOWN_ACTION,parsedMessage:{topic:n,action:e},description:"unknown "+message_constants_1.TOPIC[n]+" action "+e,raw:t};var r={topic:n,action:127&e};if(a.meta&&0<a.meta.length){var o=parseJSON(a.meta);if(!o||"object"!=typeof o)return{parseError:!0,action:message_constants_1.PARSER_ACTIONS.MESSAGE_PARSE_ERROR,parsedMessage:r,description:"invalid meta field "+a.meta.toString(),raw:t};var i=message_validator_1.validateMeta(n,e,o);if(i)throw new Error("invalid meta "+message_constants_1.TOPIC[r.topic]+" "+message_constants_1.ACTIONS[r.topic][r.action]+": "+i);addMetadataToMessage(o,r)}if(void 0!==a.payload){if(!message_validator_1.hasPayload(r.topic,e))return{parseError:!0,action:message_constants_1.PARSER_ACTIONS.INVALID_MESSAGE,parsedMessage:r,description:"should not have a payload"};r.payloadEncoding||n!==message_constants_1.TOPIC.PARSER||(r.payloadEncoding=message_constants_1.PAYLOAD_ENCODING.BINARY),r.data=a.payload}return r.isAck=128<=e,!r.isAck&&112<=e&&(r.isBulk=!0),r.isError=isError(r),r.topic===message_constants_1.TOPIC.RECORD&&utils_1.isWriteAck(e)&&(r.isWriteAck=!0),r}function addMetadataToMessage(a,s){for(var e in message_constants_1.META_KEYS){var t=a[message_constants_1.META_KEYS[e]];void 0!==t&&(s[e]=t)}}function parseJSON(a){try{return JSON.parse(a.toString())}catch(a){return}}exports.parse=parse,exports.parseData=parseData,exports.parseJSON=parseJSON;