"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var utils=require("../util/utils"),constants_1=require("../constants"),message_constants_1=require("../../binary-protocol/src/message-constants"),utils_1=require("../../binary-protocol/src/utils"),record_core_1=require("./record-core"),record_1=require("./record"),anonymous_record_1=require("./anonymous-record"),list_1=require("./list"),listener_1=require("../util/listener"),single_notifier_1=require("./single-notifier"),write_ack_service_1=require("./write-ack-service"),dirty_service_1=require("./dirty-service"),merge_strategy_service_1=require("./merge-strategy-service"),bulk_subscription_service_1=require("../util/bulk-subscription-service"),RecordHandler=function(){function e(e,t,r,s){var i;this.services=e,this.options=t,this.listener=s||new listener_1.Listener(message_constants_1.TOPIC.RECORD,this.services),this.recordCores=new Map,this.recordServices=r||{bulkSubscriptionService:((i={})[message_constants_1.RECORD_ACTIONS.SUBSCRIBECREATEANDREAD_BULK]=this.getBulkSubscriptionService(message_constants_1.RECORD_ACTIONS.SUBSCRIBECREATEANDREAD_BULK,message_constants_1.RECORD_ACTIONS.SUBSCRIBECREATEANDREAD),i[message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDHEAD_BULK]=this.getBulkSubscriptionService(message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDHEAD_BULK,message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDHEAD),i[message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDREAD_BULK]=this.getBulkSubscriptionService(message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDREAD_BULK,message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDREAD),i),writeAckService:new write_ack_service_1.WriteAcknowledgementService(e),readRegistry:new single_notifier_1.SingleNotifier(e,message_constants_1.RECORD_ACTIONS.READ,t.recordReadTimeout),headRegistry:new single_notifier_1.SingleNotifier(e,message_constants_1.RECORD_ACTIONS.HEAD,t.recordReadTimeout),dirtyService:new dirty_service_1.DirtyService(e.storage,t.dirtyStorageName),mergeStrategy:new merge_strategy_service_1.MergeStrategyService(e,t.mergeStrategy)},this.dirtyService=this.recordServices.dirtyService,this.sendUpdatedData=this.sendUpdatedData.bind(this),this.onRecordUpdated=this.onRecordUpdated.bind(this),this.onMergeCompleted=this.onMergeCompleted.bind(this),this.getRecordCore=this.getRecordCore.bind(this),this.removeRecord=this.removeRecord.bind(this),this.onBulkSubscriptionSent=this.onBulkSubscriptionSent.bind(this),this.services.connection.registerHandler(message_constants_1.TOPIC.RECORD,this.handle.bind(this)),this.services.connection.onReestablished(this.syncDirtyRecords.bind(this)),this.services.connection.isConnected&&this.syncDirtyRecords()}return e.prototype.setMergeStrategy=function(e,t){if("function"!=typeof t)throw new Error("Invalid merge strategy: Must be a Function");this.recordServices.mergeStrategy.setMergeStrategyByName(e,t)},e.prototype.setMergeStrategyRegExp=function(e,t){if("function"!=typeof t)throw new Error("Invalid merge strategy: Must be a Function");this.recordServices.mergeStrategy.setMergeStrategyByPattern(e,t)},e.prototype.getRecord=function(e){return new record_1.Record(this.getRecordCore(e))},e.prototype.getList=function(e){return new list_1.List(this.getRecordCore(e))},e.prototype.getAnonymousRecord=function(){return new anonymous_record_1.AnonymousRecord(this.getRecordCore)},e.prototype.listen=function(e,t){this.listener.listen(e,t)},e.prototype.unlisten=function(e){this.listener.unlisten(e)},e.prototype.snapshot=function(e,t){var i=this;if("string"!=typeof e||0===e.length)throw new Error("invalid argument: name");if(void 0!==t&&"function"!=typeof t)throw new Error("invalid argument: callback");var r=this.recordCores.get(e);return r?t?void r.whenReady(null,function(){t(null,r.get())}):new Promise(function(e,t){r.whenReady(null,function(){e(r.get())})}):t?void this.recordServices.readRegistry.request(e,t):new Promise(function(r,s){i.recordServices.readRegistry.request(e,function(e,t){return e?s(e):r(t)})})},e.prototype.has=function(e,r){var t,i=this;if("string"!=typeof e||0===e.length)throw new Error("invalid argument: name");if(void 0!==r&&"function"!=typeof r)throw new Error("invalid argument: callback");if(!r)return new Promise(function(r,s){t=function(e,t){return e?s(e):r(-1!==t)},i.head(e,t)});t=function(e,t){return e?r(e,null):r(null,-1!==t)},this.head(e,t)},e.prototype.head=function(e,t){var i=this;if("string"!=typeof e||0===e.length)throw new Error("invalid argument: name");if(void 0!==t&&"function"!=typeof t)throw new Error("invalid argument: callback");var r=this.recordCores.get(e);return r?t?void r.whenReady(null,function(){t(null,r.version)}):new Promise(function(e,t){r.whenReady(null,function(){e(r.version)})}):t?void this.recordServices.headRegistry.request(e,t):new Promise(function(r,s){i.recordServices.headRegistry.request(e,function(e,t){return e?s(e):r(t)})})},e.prototype.setDataWithAck=function(e){for(var s=this,t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];var i=utils.normalizeSetArguments(arguments,1);if(!i.callback)return new Promise(function(t,r){i.callback=function(e){return null===e?t():r(e)},s.sendSetData(e,-1,i)});this.sendSetData(e,-1,i)},e.prototype.setData=function(e){var t=utils.normalizeSetArguments(arguments,1);this.sendSetData(e,-1,t)},e.prototype.delete=function(e,t){},e.prototype.sendSetData=function(e,t,r){var s=r.path,i=r.data,n=r.callback;if(!e||"string"!=typeof e||0===e.length)throw new Error("invalid argument: recordName must be an non empty string");if(!s&&(null===i||"object"!=typeof i))throw new Error("invalid argument: data must be an object when no path is provided");var o=this.recordCores.get(e);if(o)o.set({path:s,data:i,callback:n});else{var c;c=s?void 0===i?message_constants_1.RECORD_ACTIONS.ERASE:message_constants_1.RECORD_ACTIONS.CREATEANDPATCH:message_constants_1.RECORD_ACTIONS.CREATEANDUPDATE;var a={topic:message_constants_1.TOPIC.RECORD,action:c,name:e,path:s,version:t,parsedData:i};n?this.recordServices.writeAckService.send(a,n):this.services.connection.sendMessage(a)}},e.prototype.handle=function(e){if(e.isAck)this.services.timeoutRegistry.remove(e);else if(e.action!==message_constants_1.RECORD_ACTIONS.SUBSCRIPTION_FOR_PATTERN_FOUND&&e.action!==message_constants_1.RECORD_ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED&&e.action!==message_constants_1.RECORD_ACTIONS.LISTEN&&e.action!==message_constants_1.RECORD_ACTIONS.UNLISTEN)if(utils_1.isWriteAck(e.action)||utils_1.isWriteAck(e.originalAction))this.recordServices.writeAckService.recieve(e);else if(e.action!==message_constants_1.RECORD_ACTIONS.READ_RESPONSE&&e.originalAction!==message_constants_1.RECORD_ACTIONS.READ){e.action!==message_constants_1.RECORD_ACTIONS.HEAD_RESPONSE&&e.originalAction!==message_constants_1.RECORD_ACTIONS.HEAD||(e.isError?this.recordServices.headRegistry.recieve(e,message_constants_1.RECORD_ACTIONS[e.action]):this.recordServices.headRegistry.recieve(e,null,e.version));var t=this.recordCores.get(e.name);t?t.handle(e):e.action!==message_constants_1.RECORD_ACTIONS.VERSION_EXISTS&&e.action!==message_constants_1.RECORD_ACTIONS.SUBSCRIPTION_HAS_PROVIDER&&e.action!==message_constants_1.RECORD_ACTIONS.SUBSCRIPTION_HAS_NO_PROVIDER&&(e.isError?this.services.logger.error(e):this.services.logger.error(e,constants_1.EVENT.UNSOLICITED_MESSAGE))}else e.isError?this.recordServices.readRegistry.recieve(e,message_constants_1.RECORD_ACTIONS[e.action]):this.recordServices.readRegistry.recieve(e,null,e.parsedData);else this.listener.handle(e)},e.prototype.removeRecord=function(e){this.recordCores.delete(e)},e.prototype.getRecordCore=function(e){var t=this.recordCores.get(e);return t||(t=new record_core_1.RecordCore(e,this.services,this.options,this.recordServices,this.removeRecord),this.recordCores.set(e,t)),t},e.prototype.syncDirtyRecords=function(){this.dirtyService.whenLoaded(this,this._syncDirtyRecords)},e.prototype._syncDirtyRecords=function(){var e=this.dirtyService.getAll();for(var t in e){var r=this.recordCores.get(t);r&&0<r.references.size||this.services.storage.get(t,this.sendUpdatedData)}},e.prototype.sendUpdatedData=function(e,t,r){this.sendSetData(e,t,{data:r,callback:this.onRecordUpdated})},e.prototype.onRecordUpdated=function(e,t){e||this.dirtyService.setDirty(t,!1)},e.prototype.onMergeCompleted=function(e,t,r,s,i){this.sendSetData(t,s+1,{data:r})},e.prototype.getBulkSubscriptionService=function(e,t){return new bulk_subscription_service_1.BulkSubscriptionService(this.services,this.options.subscriptionInterval,message_constants_1.TOPIC.RECORD,e,t,message_constants_1.RECORD_ACTIONS.UNSUBSCRIBE_BULK,message_constants_1.RECORD_ACTIONS.UNSUBSCRIBE,this.onBulkSubscriptionSent)},e.prototype.onBulkSubscriptionSent=function(e){e.names||this.services.timeoutRegistry.add({message:e})},e}();exports.RecordHandler=RecordHandler;