"use strict";var __awaiter=this&&this.__awaiter||function(i,o,a,c){return new(a=a||Promise)(function(e,t){function n(e){try{s(c.next(e))}catch(e){t(e)}}function r(e){try{s(c.throw(e))}catch(e){t(e)}}function s(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(n,r)}s((c=c.apply(i,o||[])).next())})},__generator=this&&this.__generator||function(n,r){var s,i,o,e,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(s)throw new TypeError("Generator is already executing.");for(;a;)try{if(s=1,i&&(o=2&t[0]?i.return:t[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,t[1])).done)return o;switch(i=0,o&&(t=[2&t[0],o.value]),t[0]){case 0:case 1:o=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,i=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(o=0<(o=a.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){a.label=t[1];break}if(6===t[0]&&a.label<o[1]){a.label=o[1],o=t;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(t);break}o[2]&&a.ops.pop(),a.trys.pop();continue}t=r.call(n,a)}catch(e){t=[6,e],i=0}finally{s=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0});var bluebird_1=require("bluebird"),sinon_1=require("sinon"),mocks_1=require("../test/mocks"),constants_1=require("../constants"),message_constants_1=require("../../binary-protocol/src/message-constants"),single_notifier_1=require("./single-notifier");describe("Single Notifier",function(){var n,r,s,i=message_constants_1.RECORD_ACTIONS.READ,o="name",a=message_constants_1.TOPIC.RECORD;beforeEach(function(){n=mocks_1.getServicesMock(),r=new single_notifier_1.SingleNotifier(n,i,10),s=sinon_1.spy()}),afterEach(function(){n.verify()}),it("requests with correct topic and action",function(){var e={topic:a,action:i,name:o};n.connectionMock.expects("sendMessage").once().withExactArgs(e),n.timeoutRegistryMock.expects("add").once().withExactArgs({message:e}),r.request(o,s)}),it("doesn't send message twice and updates the timeout when requesting twice",function(){var e={topic:a,action:i,name:o};n.connectionMock.expects("sendMessage").once().withExactArgs(e),n.timeoutRegistryMock.expects("add").once().withExactArgs({message:e}),r.request(o,s),r.request(o,s)}),it("cant't query request when client is offline",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return n.connection.isConnected=!1,r.request(o,s),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(s),sinon_1.assert.calledWithExactly(s,constants_1.EVENT.CLIENT_OFFLINE),[2]}})})}),describe("requesting",function(){return __awaiter(_this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return beforeEach(function(){r.request(o,s)}),it("doesn't respond unknown requests",function(){return __awaiter(t,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t={topic:a,action:message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED,name:"something",isError:!0},r.recieve(t,message_constants_1.RECORD_ACTIONS[message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED],void 0),sinon_1.assert.notCalled(s),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),[2]}})})}),it("responds callback and promise requests with success response",function(){return __awaiter(t,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t={some:"data"},r.recieve({topic:a,action:i,name:o,isError:!1,parsedData:t},void 0,t),sinon_1.assert.calledOnce(s),sinon_1.assert.calledWithExactly(s,void 0,t),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),[2]}})})}),it("responds callback and promise requests with error response",function(){return __awaiter(t,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return r.recieve({topic:a,action:message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED,name:o,isError:!0},message_constants_1.RECORD_ACTIONS[message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED],void 0),sinon_1.assert.calledOnce(s),sinon_1.assert.calledWithExactly(s,message_constants_1.RECORD_ACTIONS[message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED],void 0),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),[2]}})})}),it("responds with error on connection lost",function(){return __awaiter(t,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return n.simulateConnectionLost(),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(s),sinon_1.assert.calledWithExactly(s,constants_1.EVENT.CLIENT_OFFLINE),[2]}})})}),[2]})})})});