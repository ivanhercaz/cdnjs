"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var lastMessageSent,sinon_1=require("sinon"),constants_1=require("../constants"),timer_registry_1=require("../util/timer-registry"),message_constants_1=require("../../binary-protocol/src/message-constants"),single_notifier_1=require("../record/single-notifier"),write_ack_service_1=require("../record/write-ack-service"),dirty_service_1=require("../record/dirty-service"),listener_1=require("../util/listener"),bulk_subscription_service_1=require("../util/bulk-subscription-service");exports.getLastMessageSent=function(){return lastMessageSent},exports.getServicesMock=function(){var t,n,s,o=null,e={sendMessage:function(e){lastMessageSent=e},getConnectionState:sinon_1.stub().returns(constants_1.CONNECTION_STATE.OPEN),isConnected:!0,isInLimbo:!1,registerHandler:function(e,t){o=t},onReestablished:function(e){t=e},onLost:function(e){n=e},onExitLimbo:function(e){s=e},removeOnReestablished:function(){},removeOnLost:function(){}},r=sinon_1.mock(e),i={warn:function(){},error:function(){}},c=sinon_1.mock(i);c.expects("warn").never();var _,a=new timer_registry_1.TimerRegistry(1),u={add:function(){},remove:function(){},clear:function(){}},g=sinon_1.mock(u),R=(S.prototype.sendParsedMessage=function(e){},S.prototype.onparsedmessages=function(e){},S.prototype.onopened=function(){},S.prototype.onerror=function(){},S.prototype.onclosed=function(){},S.prototype.close=function(){process.nextTick(this.onclosed)},S.prototype.simulateRemoteClose=function(){this.close()},S.prototype.simulateOpen=function(){process.nextTick(this.onopened)},S.prototype.simulateError=function(){process.nextTick(this.onerror.bind(null,{code:1234}))},S.prototype.simulateMessages=function(e){process.nextTick(this.onparsedmessages.bind(this,e))},S.prototype.getTimeSinceLastMessage=function(){return 1},S);function S(e){this.url=e}var C={get:function(){},set:function(){},delete:function(){}},l=sinon_1.mock(C);return{socketFactory:function(e,t){return _=new R(e)},getSocket:function(){return{socket:_,socketMock:sinon_1.mock(_)}},connection:e,connectionMock:r,timeoutRegistry:u,timeoutRegistryMock:g,logger:i,loggerMock:c,getLogger:function(){return{logger:i,loggerMock:c}},timerRegistry:a,getHandle:function(){return o},simulateConnectionLost:function(){return n()},simulateConnectionReestablished:function(){return t()},simulateExitLimbo:function(){return s()},storage:C,storageMock:l,verify:function(){r.verify(),g.verify(),c.verify(),l.verify()}}},exports.getRecordServices=function(e){var t;e.storageMock.expects("get").withArgs("__ds__dirty_records",sinon_1.match.func).atLeast(0).callsArgWith(1,"__ds__dirty_records",1,[]),e.storageMock.expects("set").withArgs("__ds__dirty_records",1,sinon_1.match.any,sinon_1.match.func).atLeast(0);var n=new dirty_service_1.DirtyService(e.storage,"__ds__dirty_records"),s=new single_notifier_1.SingleNotifier(e,message_constants_1.RECORD_ACTIONS.HEAD,50),o=new single_notifier_1.SingleNotifier(e,message_constants_1.RECORD_ACTIONS.READ,50),r=new write_ack_service_1.WriteAcknowledgementService(e),i=((t={})[message_constants_1.RECORD_ACTIONS.SUBSCRIBECREATEANDREAD_BULK]=new bulk_subscription_service_1.BulkSubscriptionService(e,0,message_constants_1.TOPIC.RECORD,message_constants_1.RECORD_ACTIONS.SUBSCRIBECREATEANDREAD_BULK,message_constants_1.RECORD_ACTIONS.SUBSCRIBECREATEANDREAD,message_constants_1.RECORD_ACTIONS.UNSUBSCRIBE_BULK,message_constants_1.RECORD_ACTIONS.UNSUBSCRIBE),t[message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDHEAD_BULK]=new bulk_subscription_service_1.BulkSubscriptionService(e,0,message_constants_1.TOPIC.RECORD,message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDHEAD_BULK,message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDHEAD,message_constants_1.RECORD_ACTIONS.UNSUBSCRIBE_BULK,message_constants_1.RECORD_ACTIONS.UNSUBSCRIBE),t[message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDREAD_BULK]=new bulk_subscription_service_1.BulkSubscriptionService(e,0,message_constants_1.TOPIC.RECORD,message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDREAD_BULK,message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDREAD,message_constants_1.RECORD_ACTIONS.UNSUBSCRIBE_BULK,message_constants_1.RECORD_ACTIONS.UNSUBSCRIBE),t),c=sinon_1.mock(n),_=sinon_1.mock(o),a=sinon_1.mock(s),u=sinon_1.mock(r);return{dirtyService:n,dirtyServiceMock:c,headRegistry:s,headRegistryMock:a,readRegistry:o,readRegistryMock:_,writeAckService:r,writeAckServiceMock:u,bulkSubscriptionService:i,verify:function(){c.verify(),a.verify(),_.verify(),u.verify()}}},exports.getListenerMock=function(){var e=listener_1.Listener.prototype;return{listener:e,listenerMock:sinon_1.mock(e)}};