"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var message_parser_1=require("../../binary-protocol/src/message-parser"),message_builder_1=require("../../binary-protocol/src/message-builder"),message_constants_1=require("../../binary-protocol/src/message-constants"),BrowserWebsocket=global.WebSocket||global.MozWebSocket;exports.socketFactory=function(e,s,a){var n=BrowserWebsocket?new BrowserWebsocket(e,[],s):new(require("ws"))(e,s);BrowserWebsocket&&(n.binaryType="arraybuffer");var o=message_builder_1.getMessage({topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.PING},!1),r=null,t=-1;return n.onparsedmessage=function(){},n.onmessage=function(e){t=Date.now();var s=message_parser_1.parse(BrowserWebsocket?new Buffer(new Uint8Array(e.data)):e.data);n.onparsedmessages(s)},n.getTimeSinceLastMessage=function(){return 0},n.sendParsedMessage=function(e){if(e.topic===message_constants_1.TOPIC.CONNECTION&&e.action===message_constants_1.CONNECTION_ACTIONS.CLOSING)return n.onparsedmessages([{topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.CLOSED}]),void n.close();e.data=JSON.stringify(e.parsedData),n.send(message_builder_1.getMessage(e,!1))},n.onclosed=null,n.onclose=function(){clearInterval(r),n.onclosed()},n.onopened=null,n.onopen=function(){r=setInterval(function(){if(Date.now()-t>a)try{n.send(o)}catch(e){clearTimeout(r)}},a),n.onopened()},n};