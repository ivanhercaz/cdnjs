"use strict";var __extends=this&&this.__extends||function(){var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var utils=require("../util/utils"),constants_1=require("../constants"),Emitter=require("component-emitter2"),List=function(r){function t(t){var e=r.call(this)||this;return e.record=t,e.originalApplyUpdate=e.record.applyUpdate.bind(e.record),e.record.applyUpdate=e.applyUpdate.bind(e),e.wrappedFunctions=new Map,e.hasAddListener=!1,e.hasRemoveListener=!1,e.hasMoveListener=!1,e.subscriptions=[],e.record.addReference(e),e}return __extends(t,r),Object.defineProperty(t.prototype,"name",{get:function(){return this.record.name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isReady",{get:function(){return this.record.isReady},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"version",{get:function(){return this.record.version},enumerable:!0,configurable:!0}),t.prototype.whenReady=function(t){if(!t)return this.record.whenReady(this);this.record.whenReady(this,t)},t.prototype.discard=function(){this.destroy(),this.record.removeReference(this)},t.prototype.delete=function(t){return this.destroy(),this.record.delete(t)},t.prototype.getEntries=function(){var t=this.record.get();return t instanceof Array?t:[]},t.prototype.isEmpty=function(){return 0===this.getEntries().length},t.prototype.setEntriesWithAck=function(t,e){var i=this;if(!e)return new Promise(function(e,r){i.setEntries(t,function(t){t?r(t):e()})});this.setEntries(t,e)},t.prototype.setEntries=function(t,e){var r,i="entries must be an array of record names";if(!(t instanceof Array))throw new Error(i);for(r=0;r<t.length;r++)if("string"!=typeof t[r])throw new Error(i);!1===this.record.isReady||(this.beforeChange(),this.record.set({data:t,callback:e}),this.afterChange())},t.prototype.removeEntry=function(t,e,r){if(!1!==this.record.isReady){var i,n=this.record.get(),s=this.hasIndex(e),o=[];for(i=0;i<n.length;i++)(n[i]!==t||s&&e!==i)&&o.push(n[i]);this.beforeChange(),this.record.set({data:o,callback:r}),this.afterChange()}},t.prototype.addEntry=function(t,e,r){if("string"!=typeof t)throw new Error("Entry must be a recordName");if(!1!==this.record.isReady){var i=this.hasIndex(e),n=this.getEntries();i?n.splice(e,0,t):n.push(t),this.beforeChange(),this.record.set({data:n,callback:r}),this.afterChange()}},t.prototype.subscribe=function(t){var e=utils.normalizeArguments(arguments);if(e.path)throw new Error("path is not supported for List.subscribe");var r=function(t,e){e(t.getEntries())}.bind(this,this,e.callback);this.wrappedFunctions.set(e.callback,r),e.callback=r,this.subscriptions.push(e),this.record.subscribe(e)},t.prototype.unsubscribe=function(t){var e=utils.normalizeArguments(arguments);if(e.path)throw new Error("path is not supported for List.unsubscribe");var r=this.wrappedFunctions.get(e.callback);e.callback=r,this.record.unsubscribe(e),this.wrappedFunctions.delete(e.callback)},t.prototype.applyUpdate=function(t){t.parsedData instanceof Array||(t.parsedData=[]),this.beforeChange(),this.originalApplyUpdate(t),this.afterChange()},t.prototype.hasIndex=function(t){var e=!1,r=this.getEntries();if(void 0!==t){if(isNaN(t))throw new Error("Index must be a number");if(t!==r.length&&(t>=r.length||t<0))throw new Error("Index must be within current entries");e=!0}return e},t.prototype.beforeChange=function(){this.hasAddListener=0<this.listeners(constants_1.EVENT.ENTRY_ADDED_EVENT).length,this.hasRemoveListener=0<this.listeners(constants_1.EVENT.ENTRY_REMOVED_EVENT).length,this.hasMoveListener=0<this.listeners(constants_1.EVENT.ENTRY_MOVED_EVENT).length,this.hasAddListener||this.hasRemoveListener||this.hasMoveListener?this.beforeStructure=this.getStructure():this.beforeStructure=null},t.prototype.afterChange=function(){if(null!==this.beforeStructure){var t,e,r=this.getStructure(),i=this.beforeStructure;if(this.hasRemoveListener)for(t in i)for(e=0;e<i[t].length;e++)void 0!==r[t]&&void 0!==r[t][e]||this.emit(constants_1.EVENT.ENTRY_REMOVED_EVENT,t,i[t][e]);if(this.hasAddListener||this.hasMoveListener)for(t in r)if(void 0===i[t])for(e=0;e<r[t].length;e++)this.emit(constants_1.EVENT.ENTRY_ADDED_EVENT,t,r[t][e]);else for(e=0;e<r[t].length;e++)i[t][e]!==r[t][e]&&(void 0===i[t][e]?this.emit(constants_1.EVENT.ENTRY_ADDED_EVENT,t,r[t][e]):this.emit(constants_1.EVENT.ENTRY_MOVED_EVENT,t,r[t][e]))}},t.prototype.getStructure=function(){var t,e={},r=this.getEntries();for(t=0;t<r.length;t++)void 0===e[r[t]]?e[r[t]]=[t]:e[r[t]].push(t);return e},t.prototype.destroy=function(){for(var t=0;t<this.subscriptions.length;t++)this.record.unsubscribe(this.subscriptions[t]);this.wrappedFunctions.clear()},t}(Emitter);exports.List=List;