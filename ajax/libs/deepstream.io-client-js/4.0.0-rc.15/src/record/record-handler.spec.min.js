"use strict";var __awaiter=this&&this.__awaiter||function(i,c,o,r){return new(o=o||Promise)(function(e,t){function n(e){try{a(r.next(e))}catch(e){t(e)}}function s(e){try{a(r.throw(e))}catch(e){t(e)}}function a(t){t.done?e(t.value):new o(function(e){e(t.value)}).then(n,s)}a((r=r.apply(i,c||[])).next())})},__generator=this&&this.__generator||function(n,s){var a,i,c,e,o={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;o;)try{if(a=1,i&&(c=2&t[0]?i.return:t[0]?i.throw||((c=i.return)&&c.call(i),0):i.next)&&!(c=c.call(i,t[1])).done)return c;switch(i=0,c&&(t=[2&t[0],c.value]),t[0]){case 0:case 1:c=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,i=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(c=0<(c=o.trys).length&&c[c.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!c||t[1]>c[0]&&t[1]<c[3])){o.label=t[1];break}if(6===t[0]&&o.label<c[1]){o.label=c[1],c=t;break}if(c&&o.label<c[2]){o.label=c[2],o.ops.push(t);break}c[2]&&o.ops.pop(),o.trys.pop();continue}t=s.call(n,o)}catch(e){t=[6,e],i=0}finally{a=c=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0});var bluebird_1=require("bluebird"),chai_1=require("chai"),sinon_1=require("sinon"),mocks_1=require("../test/mocks"),record_handler_1=require("./record-handler"),client_options_1=require("../client-options"),message_constants_1=require("../../binary-protocol/src/message-constants");describe("Record handler",function(){var t,s,n,a,i,d,u,h="recordA",e=Object.assign({},client_options_1.DefaultOptions);beforeEach(function(){n=sinon_1.spy(),a=sinon_1.spy(),i=sinon_1.spy(),t=mocks_1.getServicesMock(),s=mocks_1.getRecordServices(t),d=new record_handler_1.RecordHandler(t,e,s),u=t.getHandle()}),afterEach(function(){t.verify(),s.verify()}),it("validates on has, head and snapshot",function(){chai_1.expect(d.has.bind(d,"")).to.throw(),chai_1.expect(d.has.bind(d,"",function(){})).to.throw(),chai_1.expect(d.head.bind(d,"")).to.throw(),chai_1.expect(d.head.bind(d,"",function(){})).to.throw(),chai_1.expect(d.snapshot.bind(d,"")).to.throw(),chai_1.expect(d.snapshot.bind(d,"",function(){})).to.throw()}),it("snapshots record remotely using callback and promise style",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){return s.readRegistryMock.expects("request").twice().withExactArgs(h,sinon_1.match.func),d.snapshot(h,n),d.snapshot(h),[2]})})}),it("snapshots local records using callback and promise style",function(){}),describe("handling snapshot messages",function(){var t;beforeEach(function(){t={some:"data"},d.snapshot(h,n),d.snapshot(h).then(a).catch(i)}),it("handles success messages",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return u({topic:message_constants_1.TOPIC.RECORD,action:message_constants_1.RECORD_ACTIONS.READ_RESPONSE,name:h,isError:!1,parsedData:t}),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(n),sinon_1.assert.calledWithExactly(n,null,t),sinon_1.assert.calledOnce(a),sinon_1.assert.calledWithExactly(a,t),sinon_1.assert.notCalled(i),[2]}})})}),it("handles error messages",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return u({topic:message_constants_1.TOPIC.RECORD,action:message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED,originalAction:message_constants_1.RECORD_ACTIONS.READ,name:h,isError:!0}),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(n),sinon_1.assert.calledWithExactly(n,message_constants_1.RECORD_ACTIONS[message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED],void 0),sinon_1.assert.notCalled(a),sinon_1.assert.calledOnce(i),sinon_1.assert.calledWithExactly(i,message_constants_1.RECORD_ACTIONS[message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED]),[2]}})})})}),it("queries for the record version remotely using callback and promise",function(){s.headRegistryMock.expects("request").twice().withExactArgs(h,sinon_1.match.func),d.head(h,n),d.head(h).then(a).catch(i)}),it("queries for the record version in local records using callback and promise",function(){}),describe("handling head messages from head calls",function(){var t;beforeEach(function(){t=1,d.head(h,n),d.head(h).then(a).catch(i)}),it("handles success messages",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return u({topic:message_constants_1.TOPIC.RECORD,action:message_constants_1.RECORD_ACTIONS.HEAD_RESPONSE,name:h,isError:!1,version:t}),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(n),sinon_1.assert.calledWithExactly(n,null,t),sinon_1.assert.calledOnce(a),sinon_1.assert.calledWithExactly(a,t),sinon_1.assert.notCalled(i),[2]}})})}),it("handles error messages",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return u({topic:message_constants_1.TOPIC.RECORD,action:message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED,originalAction:message_constants_1.RECORD_ACTIONS.HEAD,name:h,isError:!0}),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(n),sinon_1.assert.calledWithExactly(n,message_constants_1.RECORD_ACTIONS[message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED],void 0),sinon_1.assert.notCalled(a),sinon_1.assert.calledOnce(i),sinon_1.assert.calledWithExactly(i,message_constants_1.RECORD_ACTIONS[message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED]),[2]}})})})}),it("queries for record exists remotely using callback and promise",function(){s.headRegistryMock.expects("request").twice().withExactArgs(h,sinon_1.match.func),d.has(h,n),d.has(h).then(a).catch(i)}),it("queries for record exists in local records using callback and promise",function(){}),describe("handling head messages from has calls",function(){var t;beforeEach(function(){t=1,d.has(h,n),d.has(h).then(a).catch(i)}),it("handles success messages",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return u({topic:message_constants_1.TOPIC.RECORD,action:message_constants_1.RECORD_ACTIONS.HEAD_RESPONSE,name:h,isError:!1,version:t}),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(n),sinon_1.assert.calledWithExactly(n,null,!0),sinon_1.assert.calledOnce(a),sinon_1.assert.calledWithExactly(a,!0),sinon_1.assert.notCalled(i),[2]}})})}),it("handles record not found error messages",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return u({topic:message_constants_1.TOPIC.RECORD,action:message_constants_1.RECORD_ACTIONS.HEAD_RESPONSE,originalAction:message_constants_1.RECORD_ACTIONS.HEAD,version:-1,name:h}),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(n),sinon_1.assert.calledWithExactly(n,null,!1),sinon_1.assert.calledOnce(a),sinon_1.assert.calledWithExactly(a,!1),sinon_1.assert.notCalled(i),[2]}})})}),it("handles error messages",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return u({topic:message_constants_1.TOPIC.RECORD,action:message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED,originalAction:message_constants_1.RECORD_ACTIONS.HEAD,name:h,isError:!0}),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(n),sinon_1.assert.calledWithExactly(n,message_constants_1.RECORD_ACTIONS[message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED],null),sinon_1.assert.notCalled(a),sinon_1.assert.calledOnce(i),sinon_1.assert.calledWithExactly(i,message_constants_1.RECORD_ACTIONS[message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED]),[2]}})})})}),describe("record setData online",function(){var l=message_constants_1.TOPIC.RECORD;beforeEach(function(){t=mocks_1.getServicesMock(),s=mocks_1.getRecordServices(t),e=Object.assign({},client_options_1.DefaultOptions),t.connection.isConnected=!0,d=new record_handler_1.RecordHandler(t,e,s),u=t.getHandle()}),afterEach(function(){t.verify(),s.verify()}),it("sends update messages for entire data changes",function(){var e={firstname:"Wolfram"};t.connectionMock.expects("sendMessage").once().withExactArgs({topic:l,action:message_constants_1.RECORD_ACTIONS.CREATEANDUPDATE,name:h,path:void 0,parsedData:e,version:-1}),d.setData(h,e)}),it("sends update messages for path changes ",function(){var e="lastName";t.connectionMock.expects("sendMessage").once().withExactArgs({topic:l,action:message_constants_1.RECORD_ACTIONS.CREATEANDPATCH,name:h,path:e,parsedData:"Hempel",version:-1}),d.setData(h,e,"Hempel")}),it("deletes value when sending undefined for a value",function(){var e="lastName";t.connectionMock.expects("sendMessage").once().withExactArgs({topic:l,action:message_constants_1.RECORD_ACTIONS.ERASE,name:h,path:e,version:-1,parsedData:void 0}),d.setData(h,e,void 0)}),it.skip("updates existent local record",function(){}),it("throws error for invalid arguments",function(){chai_1.expect(d.setData.bind(d)).to.throw(),chai_1.expect(d.setData.bind(d,h)).to.throw(),chai_1.expect(d.setData.bind(d,h,void 0)).to.throw(),chai_1.expect(d.setData.bind(d,h,void 0,function(){})).to.throw(),chai_1.expect(d.setData.bind(d,h,null)).to.throw(),chai_1.expect(d.setData.bind(d,h,null,function(){})).to.throw(),chai_1.expect(d.setData.bind(d,h,"","data")).to.throw(),chai_1.expect(d.setData.bind(d,h,"Some String")).to.throw(),chai_1.expect(d.setData.bind(d,h,100.24)).to.throw(),chai_1.expect(d.setData.bind(d,h,{},{not:"func"})).to.throw()}),describe("with ack",function(){var t,n,e;beforeEach(function(){n="key",t={some:"value"},e=function(){}}),it("sends update messages for entire data changes with ack callback",function(){s.writeAckServiceMock.expects("send").once().withExactArgs({topic:l,action:message_constants_1.RECORD_ACTIONS.CREATEANDUPDATE,name:h,path:void 0,parsedData:t,version:-1},e),d.setData(h,t,e)}),it("sends update messages for path changes with ack callback",function(){s.writeAckServiceMock.expects("send").once().withExactArgs({topic:l,action:message_constants_1.RECORD_ACTIONS.CREATEANDPATCH,name:h,path:n,parsedData:t,version:-1},e),d.setData(h,n,t,e)}),it("sends update messages for entire data changes with ack promise",function(){s.writeAckServiceMock.expects("send").once().withExactArgs({topic:l,action:message_constants_1.RECORD_ACTIONS.CREATEANDUPDATE,name:h,path:void 0,parsedData:t,version:-1},sinon_1.match.func);var e=d.setDataWithAck(h,t);chai_1.expect(e).is.a("promise")}),it("sends update messages for path changes with ack promise",function(){s.writeAckServiceMock.expects("send").once().withExactArgs({topic:l,action:message_constants_1.RECORD_ACTIONS.CREATEANDPATCH,name:h,path:n,parsedData:t,version:-1},sinon_1.match.func);var e=d.setDataWithAck(h,n,t);chai_1.expect(e).is.a("promise")}),it("deletes value when sending undefined for a path with ack callback",function(){s.writeAckServiceMock.expects("send").once().withExactArgs({topic:l,action:message_constants_1.RECORD_ACTIONS.ERASE,name:h,path:n,version:-1,parsedData:void 0},e),d.setDataWithAck(h,n,void 0,e)}),it("deletes value when sending undefined for a path with ack promise",function(){s.writeAckServiceMock.expects("send").once().withExactArgs({topic:l,action:message_constants_1.RECORD_ACTIONS.ERASE,name:h,path:n,version:-1,parsedData:void 0},sinon_1.match.func);var e=d.setDataWithAck(h,n,void 0);chai_1.expect(e).is.a("promise")})}),describe("handling acknowledgements",function(){var t,n,s,a="key",i={some:"value"};beforeEach(function(){t=sinon_1.spy(),n=sinon_1.spy(),s=sinon_1.spy()});var c={topic:l,action:message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED,originalAction:message_constants_1.RECORD_ACTIONS.CREATEANDUPDATE_WITH_WRITE_ACK,name:h,correlationId:"1",isError:!0,isWriteAck:!0};it("calls callbackAck with error",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return d.setDataWithAck(h,i,t),u(c),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(t),sinon_1.assert.calledWithExactly(t,message_constants_1.RECORD_ACTIONS[c.action]),[2]}})})}),it("rejects promise with error",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return d.setDataWithAck(h,a,void 0).then(n).catch(s),u(c),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.notCalled(n),sinon_1.assert.calledOnce(s),sinon_1.assert.calledWithExactly(s,message_constants_1.RECORD_ACTIONS[c.action]),[2]}})})});var o={topic:l,action:message_constants_1.RECORD_ACTIONS.WRITE_ACKNOWLEDGEMENT,originalAction:message_constants_1.RECORD_ACTIONS.CREATEANDUPDATE_WITH_WRITE_ACK,name:h,correlationId:"1",isWriteAck:!0};it("calls callbackAck for setData without path",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return d.setDataWithAck(h,i,t),u(o),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(t),sinon_1.assert.calledWithExactly(t,null),[2]}})})}),it("resolves promise for setData without path",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return d.setDataWithAck(h,i).then(n).catch(s),u(o),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(n),sinon_1.assert.notCalled(s),[2]}})})});var r={topic:l,action:message_constants_1.RECORD_ACTIONS.WRITE_ACKNOWLEDGEMENT,originalAction:message_constants_1.RECORD_ACTIONS.CREATEANDPATCH_WITH_WRITE_ACK,name:h,correlationId:"1",isWriteAck:!0};it("calls callbackAck for setData with path",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return d.setDataWithAck(h,a,i,t),u(r),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(t),sinon_1.assert.calledWithExactly(t,null),[2]}})})}),it("resolves promise for setData with path",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return d.setDataWithAck(h,a,i).then(n).catch(s),u(r),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(n),sinon_1.assert.notCalled(s),[2]}})})});var _={topic:l,action:message_constants_1.RECORD_ACTIONS.WRITE_ACKNOWLEDGEMENT,originalAction:message_constants_1.RECORD_ACTIONS.ERASE_WITH_WRITE_ACK,name:h,correlationId:"1",isWriteAck:!0};it("calls callbackAck for setData deleting values",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return d.setDataWithAck(h,a,void 0,t),u(_),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(t),sinon_1.assert.calledWithExactly(t,null),[2]}})})}),it("resolves promise for setData deleting values",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return d.setDataWithAck(h,a,void 0).then(n).catch(s),u(_),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(n),sinon_1.assert.notCalled(s),[2]}})})})})})});