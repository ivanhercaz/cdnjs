"use strict";var __awaiter=this&&this.__awaiter||function(i,c,o,a){return new(o=o||Promise)(function(e,n){function t(e){try{s(a.next(e))}catch(e){n(e)}}function r(e){try{s(a.throw(e))}catch(e){n(e)}}function s(n){n.done?e(n.value):new o(function(e){e(n.value)}).then(t,r)}s((a=a.apply(i,c||[])).next())})},__generator=this&&this.__generator||function(t,r){var s,i,c,e,o={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]};return e={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function n(n){return function(e){return function(n){if(s)throw new TypeError("Generator is already executing.");for(;o;)try{if(s=1,i&&(c=2&n[0]?i.return:n[0]?i.throw||((c=i.return)&&c.call(i),0):i.next)&&!(c=c.call(i,n[1])).done)return c;switch(i=0,c&&(n=[2&n[0],c.value]),n[0]){case 0:case 1:c=n;break;case 4:return o.label++,{value:n[1],done:!1};case 5:o.label++,i=n[1],n=[0];continue;case 7:n=o.ops.pop(),o.trys.pop();continue;default:if(!(c=0<(c=o.trys).length&&c[c.length-1])&&(6===n[0]||2===n[0])){o=0;continue}if(3===n[0]&&(!c||n[1]>c[0]&&n[1]<c[3])){o.label=n[1];break}if(6===n[0]&&o.label<c[1]){o.label=c[1],c=n;break}if(c&&o.label<c[2]){o.label=c[2],o.ops.push(n);break}c[2]&&o.ops.pop(),o.trys.pop();continue}n=r.call(t,o)}catch(e){n=[6,e],i=0}finally{s=c=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,e])}}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0});var bluebird_1=require("bluebird"),sinon_1=require("sinon"),mocks_1=require("../test/mocks"),constants_1=require("../constants"),message_constants_1=require("../../binary-protocol/src/message-constants"),write_ack_service_1=require("./write-ack-service");describe("Write Ack Notifier",function(){var t,r,s,i=message_constants_1.TOPIC.RECORD,c=message_constants_1.RECORD_ACTIONS.CREATEANDPATCH,n=message_constants_1.RECORD_ACTIONS.CREATEANDPATCH_WITH_WRITE_ACK,o="record";beforeEach(function(){t=mocks_1.getServicesMock(),r=new write_ack_service_1.WriteAcknowledgementService(t),s=sinon_1.spy()}),afterEach(function(){t.verify()}),it("cant't send request when client is offline",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return t.connection.isConnected=!1,t.connectionMock.expects("sendMessage").never(),r.send({topic:i,action:c,name:o},s),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(s),sinon_1.assert.calledWithExactly(s,constants_1.EVENT.CLIENT_OFFLINE),[2]}})})}),it("calls callbacks with error message when connection is lost",function(){return __awaiter(_this,void 0,void 0,function(){var n;return __generator(this,function(e){switch(e.label){case 0:return n={topic:i,action:c,name:o},r.send(n,s),r.send(n,s),t.simulateConnectionLost(),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledTwice(s),sinon_1.assert.calledWithExactly(s,constants_1.EVENT.CLIENT_OFFLINE),[2]}})})}),it("sends correct messages with different correlationsId for each call",function(){var e={topic:i,action:c,name:o};t.connectionMock.expects("sendMessage").once().withExactArgs(Object.assign({},e,{action:n,correlationId:"1"})),t.connectionMock.expects("sendMessage").once().withExactArgs(Object.assign({},e,{action:n,correlationId:"2"})),r.send(e,function(){}),r.send(e,function(){})}),describe("receiving",function(){var e;beforeEach(function(){e={topic:i,action:c,name:o},r.send(Object.assign({},e),s)}),it("logs error for unknown acknowledgements",function(){return __awaiter(_this,void 0,void 0,function(){var n;return __generator(this,function(e){switch(e.label){case 0:return n={topic:i,action:c,name:o,correlationId:"123"},r.recieve(n),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.notCalled(s),[2]}})})}),it("calls ack callback when server sends ack message",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return r.recieve({topic:i,action:message_constants_1.RECORD_ACTIONS.WRITE_ACKNOWLEDGEMENT,correlationId:"1",originalAction:message_constants_1.RECORD_ACTIONS.CREATEANDUPDATE_WITH_WRITE_ACK}),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(s),sinon_1.assert.calledWith(s),[2]}})})}),it("doesn't call callback twice",function(){return __awaiter(_this,void 0,void 0,function(){var n;return __generator(this,function(e){switch(e.label){case 0:return n={topic:i,action:message_constants_1.RECORD_ACTIONS.WRITE_ACKNOWLEDGEMENT,correlationId:"1",originalAction:message_constants_1.RECORD_ACTIONS.CREATEANDUPDATE_WITH_WRITE_ACK},r.recieve(n),r.recieve(n),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(s),sinon_1.assert.calledWith(s),[2]}})})}),it("calls ack callback with error when server sends error message",function(){return __awaiter(_this,void 0,void 0,function(){var n;return __generator(this,function(e){switch(e.label){case 0:return n=message_constants_1.RECORD_ACTIONS.MESSAGE_DENIED,r.recieve({topic:i,action:n,correlationId:"1",originalAction:message_constants_1.RECORD_ACTIONS.CREATEANDUPDATE_WITH_WRITE_ACK,isError:!0}),[4,bluebird_1.Promise.delay(1)];case 1:return e.sent(),sinon_1.assert.calledOnce(s),sinon_1.assert.calledWith(s,message_constants_1.RECORD_ACTIONS[n]),[2]}})})})})});