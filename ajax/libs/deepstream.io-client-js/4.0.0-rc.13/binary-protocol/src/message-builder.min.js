"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var message_constants_1=require("./message-constants"),utils_1=require("./utils"),constants_1=require("./constants"),message_validator_1=require("./message-validator");function getMessage(t,e){var a=t,s=a.action;if(a.isWriteAck&&!utils_1.isWriteAck(a.action)&&(s=utils_1.ACTION_TO_WRITE_ACK[a.action]),(a.isAck||e)&&(s|=128,void 0===message_constants_1.ACTIONS[a.topic][a.action]))throw new Error("message "+message_constants_1.TOPIC[a.topic]+" "+a.action+" should not have an ack");var n={n:a.name,m:a.names,c:a.correlationId,s:a.subscription,v:a.version,p:a.path,r:a.reason,u:a.url,t:a.originalTopic,a:a.originalAction,x:a.protocolVersion,rn:a.requestorName,rd:a.requestorData,ts:a.trustedSender,rt:a.registryTopic};a.payloadEncoding&&a.payloadEncoding!==message_constants_1.PAYLOAD_ENCODING.JSON&&(n[message_constants_1.META_KEYS.payloadEncoding]=a.payloadEncoding);var o=message_validator_1.validateMeta(a.topic,s,n);if(o)throw new Error("invalid "+message_constants_1.TOPIC[a.topic]+" "+(message_constants_1.ACTIONS[a.topic][s]||s)+": "+o);var i,r=JSON.stringify(n),c="{}"===r?null:Buffer.from(r,"utf8");if(a.data instanceof Buffer)i=a.data;else if(void 0!==a.data||void 0!==a.parsedData){var l=a.data;void 0===l&&(l=JSON.stringify(a.parsedData)),i=Buffer.from(l,"utf8")}else i=null;i&&!message_validator_1.hasPayload(a.topic,s)&&console.error("invalid message "+message_constants_1.TOPIC[a.topic]+" "+a.action+": should not have payload");var _=c?c.length:0,u=i?i.length:0;return _<=constants_1.META_PAYLOAD_OVERFLOW_LENGTH&&u<=constants_1.META_PAYLOAD_OVERFLOW_LENGTH?buildRaw(!0,a.topic,s,c,i):buildMultipart(a.topic,s,c,i)}function buildMultipart(t,e,a,s){var n,o=a?a.length:0,i=s?s.length:0,r=[],c=0,l=0;do{var _=Math.min(o-c,constants_1.META_PAYLOAD_OVERFLOW_LENGTH),u=Math.min(i-l,constants_1.META_PAYLOAD_OVERFLOW_LENGTH),d=a&&a.slice(c,c+_),g=s&&s.slice(l,l+u);l+=u,n=(c+=_)===o&&l===i,r.push(buildRaw(n,t,e,d,g))}while(!n);return Buffer.concat(r)}function buildRaw(t,e,a,s,n){var o=s?s.length:0,i=n?n.length:0,r=constants_1.HEADER_LENGTH+o+i,c=Buffer.allocUnsafe(r);return c[0]=(t?128:0)|e,c[1]=a,c.writeUIntBE(o,2,3),c.writeUIntBE(i,5,3),s&&s.copy(c,constants_1.HEADER_LENGTH),n&&n.copy(c,constants_1.HEADER_LENGTH+o),c}function combineMultipleMessages(t){return Buffer.concat(t)}exports.getMessage=getMessage,exports.combineMultipleMessages=combineMultipleMessages;