"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var constants_1=require("../constants"),message_constants_1=require("../../binary-protocol/src/message-constants"),Emitter=require("component-emitter2"),bulk_subscription_service_1=require("../util/bulk-subscription-service"),ONLY_EVENT="OE";function validateQueryArguments(t){var e=null,s=null;if(1===t.length)if(Array.isArray(t[0]))e=t[0];else{if("function"!=typeof t[0])throw new Error('invalid argument: "callback"');s=t[0]}else if(2===t.length&&(e=t[0],s=t[1],!Array.isArray(e)||"function"!=typeof s))throw new Error('invalid argument: "users" or "callback"');return{users:e,callback:s}}var PresenceHandler=function(){function t(t,e){this.services=t,this.globalSubscriptionEmitter=new Emitter,this.subscriptionEmitter=new Emitter,this.queryEmitter=new Emitter,this.queryAllEmitter=new Emitter,this.counter=0,this.limboQueue=[],this.bulkSubscription=new bulk_subscription_service_1.BulkSubscriptionService(this.services,e.subscriptionInterval,message_constants_1.TOPIC.PRESENCE,message_constants_1.PRESENCE_ACTIONS.SUBSCRIBE_BULK,null,message_constants_1.PRESENCE_ACTIONS.UNSUBSCRIBE_BULK,null,this.onBulkSubscriptionSent.bind(this)),this.services.connection.registerHandler(message_constants_1.TOPIC.PRESENCE,this.handle.bind(this)),this.services.connection.onExitLimbo(this.onExitLimbo.bind(this)),this.services.connection.onLost(this.onExitLimbo.bind(this)),this.services.connection.onReestablished(this.onConnectionReestablished.bind(this))}return t.prototype.subscribe=function(t,e){if("string"==typeof t&&0<t.length&&"function"==typeof e){var s=t;return this.subscriptionEmitter.hasListeners(s)||this.bulkSubscription.subscribe(s),void this.subscriptionEmitter.on(s,e)}if("function"==typeof t&&void 0===e)return this.globalSubscriptionEmitter.hasListeners(ONLY_EVENT)||this.subscribeToAllChanges(),void this.globalSubscriptionEmitter.on(ONLY_EVENT,t);throw new Error('invalid arguments: "user" or "callback"')},t.prototype.unsubscribe=function(t,e){if(t&&"string"==typeof t&&0<t.length){var s=t;if(e){if("function"!=typeof e)throw new Error('invalid argument: "callback"');this.subscriptionEmitter.off(s,e)}else this.subscriptionEmitter.off(s);if(!this.subscriptionEmitter.hasListeners(s))return void this.bulkSubscription.unsubscribe(s)}if(t&&"function"==typeof t)return e=t,this.globalSubscriptionEmitter.off(ONLY_EVENT,e),void(this.globalSubscriptionEmitter.hasListeners(ONLY_EVENT)||this.unsubscribeToAllChanges());if(void 0===t&&void 0===e)return this.subscriptionEmitter.off(),this.globalSubscriptionEmitter.off(),this.bulkSubscription.unsubscribeList(this.subscriptionEmitter.eventNames()),void this.unsubscribeToAllChanges();throw new Error('invalid argument: "user" or "callback"')},t.prototype.getAll=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var s,n,r,i=validateQueryArguments(t),o=i.callback,c=i.users;if(c){var E=(this.counter++).toString();s={topic:message_constants_1.TOPIC.PRESENCE,action:message_constants_1.PRESENCE_ACTIONS.QUERY,correlationId:E,names:c},n=this.queryEmitter,r=E}else s={topic:message_constants_1.TOPIC.PRESENCE,action:message_constants_1.PRESENCE_ACTIONS.QUERY_ALL},n=this.queryAllEmitter,r=ONLY_EVENT;if(this.services.connection.isConnected?this.sendQuery(s):this.services.connection.isInLimbo?this.limboQueue.push(s):this.services.timerRegistry.requestIdleCallback(function(){n.emit(r,constants_1.EVENT.CLIENT_OFFLINE)}),!o)return new Promise(function(s,i){n.once(r,function(t,e){return t?i(t):s(e)})});n.once(r,o)},t.prototype.handle=function(t){if(t.isAck)this.services.timeoutRegistry.remove(t);else{if(t.action===message_constants_1.PRESENCE_ACTIONS.QUERY_ALL_RESPONSE)return this.queryAllEmitter.emit(ONLY_EVENT,null,t.names),void this.services.timeoutRegistry.remove(t);if(t.action===message_constants_1.PRESENCE_ACTIONS.QUERY_RESPONSE)return this.queryEmitter.emit(t.correlationId,null,t.parsedData),void this.services.timeoutRegistry.remove(t);if(t.action!==message_constants_1.PRESENCE_ACTIONS.PRESENCE_JOIN)if(t.action!==message_constants_1.PRESENCE_ACTIONS.PRESENCE_JOIN_ALL)if(t.action!==message_constants_1.PRESENCE_ACTIONS.PRESENCE_LEAVE){if(t.action!==message_constants_1.PRESENCE_ACTIONS.PRESENCE_LEAVE_ALL)return t.isError?(this.services.timeoutRegistry.remove(t),void(t.originalAction===message_constants_1.PRESENCE_ACTIONS.QUERY?this.queryEmitter.emit(t.correlationId,message_constants_1.PRESENCE_ACTIONS[t.action]):t.originalAction===message_constants_1.PRESENCE_ACTIONS.QUERY_ALL?this.queryAllEmitter.emit(ONLY_EVENT,message_constants_1.PRESENCE_ACTIONS[t.action]):this.services.logger.error(t))):void this.services.logger.error(t,constants_1.EVENT.UNSOLICITED_MESSAGE);this.globalSubscriptionEmitter.emit(ONLY_EVENT,t.name,!1)}else this.subscriptionEmitter.emit(t.name,t.name,!1);else this.globalSubscriptionEmitter.emit(ONLY_EVENT,t.name,!0);else this.subscriptionEmitter.emit(t.name,t.name,!0)}},t.prototype.sendQuery=function(t){this.services.connection.sendMessage(t),this.services.timeoutRegistry.add({message:t})},t.prototype.subscribeToAllChanges=function(){if(this.services.connection.isConnected){var t={topic:message_constants_1.TOPIC.PRESENCE,action:message_constants_1.PRESENCE_ACTIONS.SUBSCRIBE_ALL};this.services.timeoutRegistry.add({message:t}),this.services.connection.sendMessage(t)}},t.prototype.unsubscribeToAllChanges=function(){if(this.services.connection.isConnected){var t={topic:message_constants_1.TOPIC.PRESENCE,action:message_constants_1.PRESENCE_ACTIONS.UNSUBSCRIBE_ALL};this.services.timeoutRegistry.add({message:t}),this.services.connection.sendMessage(t)}},t.prototype.onConnectionReestablished=function(){var t=this.subscriptionEmitter.eventNames();0<t.length&&this.bulkSubscription.subscribeList(t),this.globalSubscriptionEmitter.hasListeners(ONLY_EVENT)&&this.subscribeToAllChanges();for(var e=0;e<this.limboQueue.length;e++)this.sendQuery(this.limboQueue[e]);this.limboQueue=[]},t.prototype.onExitLimbo=function(){var e=this;this.queryEmitter.eventNames().forEach(function(t){e.queryEmitter.emit(t,constants_1.EVENT.CLIENT_OFFLINE)}),this.queryAllEmitter.emit(ONLY_EVENT,constants_1.EVENT.CLIENT_OFFLINE),this.limboQueue=[],this.queryAllEmitter.off(),this.queryEmitter.off()},t.prototype.onBulkSubscriptionSent=function(t){this.services.timeoutRegistry.add({message:t})},t}();exports.PresenceHandler=PresenceHandler;