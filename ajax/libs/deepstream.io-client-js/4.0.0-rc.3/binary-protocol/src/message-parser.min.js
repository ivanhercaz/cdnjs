"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const message_constants_1=require("./message-constants"),constants_1=require("./constants"),utils_1=require("./utils"),message_validator_1=require("./message-validator");function isError(s){return s.action>=80&&s.action<112||s.topic===message_constants_1.TOPIC.PARSER}exports.isError=isError;const BULK_ACTIONS={[message_constants_1.TOPIC.RECORD]:{[message_constants_1.RECORD_ACTIONS.SUBSCRIBECREATEANDREAD_BULK]:message_constants_1.RECORD_ACTIONS.SUBSCRIBECREATEANDREAD,[message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDHEAD_BULK]:message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDHEAD,[message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDREAD_BULK]:message_constants_1.RECORD_ACTIONS.SUBSCRIBEANDREAD},[message_constants_1.TOPIC.EVENT]:{[message_constants_1.EVENT_ACTIONS.SUBSCRIBE_BULK]:message_constants_1.EVENT_ACTIONS.SUBSCRIBE,[message_constants_1.EVENT_ACTIONS.UNSUBSCRIBE_BULK]:message_constants_1.EVENT_ACTIONS.UNSUBSCRIBE}};let uuid=0;function parse(s,a=[]){let t=0;const e=[];do{const{bytesConsumed:n,rawMessage:o}=readBinary(s,t);if(!o)break;if(a.push(o),t+=n,o.fin){const s=parseMessage(joinMessages(a));if(void 0===s.parseError&&!s.isAck&&BULK_ACTIONS[s.topic]&&BULK_ACTIONS[s.topic][s.action]){const a=BULK_ACTIONS[s.topic][s.action];uuid++,s.names.forEach(t=>{e.push({topic:s.topic,action:a,name:t,correlationId:s.correlationId,isBulk:!0,bulkId:uuid,bulkAction:s.action})})}else e.push(s);a.length=0}}while(t<s.length);return e}function parseData(s){return void 0!==s.parsedData||void 0===s.data||(s.payloadEncoding&&s.payloadEncoding!==message_constants_1.PAYLOAD_ENCODING.JSON?new Error(`unable to parse data of type '${s.payloadEncoding}'`):"string"==typeof s.data?new Error("tried to parse string data with binary parser"):(s.parsedData=parseJSON(s.data),void 0!==s.parsedData||new Error(`unable to parse data ${s.data}`)))}function readBinary(s,a){if(s.length<a+constants_1.HEADER_LENGTH)return{bytesConsumed:0};const t=!!(128&s[a]),e=127&s[a],n=s[a+1],o=s.readUIntBE(a+2,3),r=s.readUIntBE(a+5,3),i=constants_1.HEADER_LENGTH+o+r;if(s.length<a+i)return{bytesConsumed:0};const c={fin:t,topic:e,action:n,rawHeader:s.slice(a,a+constants_1.HEADER_LENGTH)};return o>0&&(c.meta=s.slice(a+constants_1.HEADER_LENGTH,a+constants_1.HEADER_LENGTH+o)),r>0&&(c.payload=s.slice(a+constants_1.HEADER_LENGTH+o,a+i)),{bytesConsumed:i,rawMessage:c}}function joinMessages(s){if(0===s.length)throw new Error("parseMessage must not be called with an empty message queue");if(1===s.length)return s[0];const{topic:a,action:t,rawHeader:e}=s[0],n=[],o=[];s.forEach(({payload:s,meta:a})=>{s&&n.push(s),a&&o.push(a)});const r=Buffer.concat(n);return{fin:!0,topic:a,action:t,rawHeader:e,meta:Buffer.concat(o),payload:r}}function parseMessage(s){const{topic:a,action:t,rawHeader:e}=s;if(void 0===message_constants_1.TOPIC[a])return{parseError:!0,action:message_constants_1.PARSER_ACTIONS.UNKNOWN_TOPIC,parsedMessage:{topic:a,action:t},description:`unknown topic ${a}`,raw:e};const n=a;if(void 0===message_constants_1.ACTIONS[n][t])return{parseError:!0,action:message_constants_1.PARSER_ACTIONS.UNKNOWN_ACTION,parsedMessage:{topic:n,action:t},description:`unknown ${message_constants_1.TOPIC[n]} action ${t}`,raw:e};const o={topic:n,action:127&t};if(s.meta&&s.meta.length>0){const a=parseJSON(s.meta);if(!a||"object"!=typeof a)return{parseError:!0,action:message_constants_1.PARSER_ACTIONS.MESSAGE_PARSE_ERROR,parsedMessage:o,description:`invalid meta field ${s.meta.toString()}`,raw:e};const r=message_validator_1.validateMeta(n,t,a);if(r)throw new Error(`invalid meta ${message_constants_1.TOPIC[o.topic]} ${message_constants_1.ACTIONS[o.topic][o.action]}: ${r}`);addMetadataToMessage(a,o)}if(void 0!==s.payload){if(!message_validator_1.hasPayload(o.topic,t))return{parseError:!0,action:message_constants_1.PARSER_ACTIONS.INVALID_MESSAGE,parsedMessage:o,description:"should not have a payload"};o.payloadEncoding||n!==message_constants_1.TOPIC.PARSER||(o.payloadEncoding=message_constants_1.PAYLOAD_ENCODING.BINARY),o.data=s.payload}return o.isAck=t>=128,!o.isAck&&t>=112&&(o.isBulk=!0),o.isError=isError(o),o.topic===message_constants_1.TOPIC.RECORD&&utils_1.isWriteAck(t)&&(o.isWriteAck=!0),o}function addMetadataToMessage(s,a){for(const t in message_constants_1.META_KEYS){const e=s[message_constants_1.META_KEYS[t]];void 0!==e&&(a[t]=e)}}function parseJSON(s){try{return JSON.parse(s.toString())}catch(s){return}}exports.parse=parse,exports.parseData=parseData,exports.parseJSON=parseJSON;