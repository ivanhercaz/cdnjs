"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const constants_1=require("../constants"),message_constants_1=require("../../binary-protocol/src/message-constants"),Emitter=require("component-emitter2"),bulk_subscription_service_1=require("../util/bulk-subscription-service"),ONLY_EVENT="OE";function validateQueryArguments(s){let e=null,t=null;if(1===s.length)if(Array.isArray(s[0]))e=s[0];else{if("function"!=typeof s[0])throw new Error('invalid argument: "callback"');t=s[0]}else if(2===s.length&&(e=s[0],t=s[1],!Array.isArray(e)||"function"!=typeof t))throw new Error('invalid argument: "users" or "callback"');return{users:e,callback:t}}class PresenceHandler{constructor(s,e){this.services=s,this.globalSubscriptionEmitter=new Emitter,this.subscriptionEmitter=new Emitter,this.queryEmitter=new Emitter,this.queryAllEmitter=new Emitter,this.counter=0,this.limboQueue=[],this.bulkSubscription=new bulk_subscription_service_1.BulkSubscriptionService(this.services,e.subscriptionInterval,message_constants_1.TOPIC.PRESENCE,message_constants_1.PRESENCE_ACTIONS.SUBSCRIBE_BULK,null,message_constants_1.PRESENCE_ACTIONS.UNSUBSCRIBE_BULK,null,this.onBulkSubscriptionSent.bind(this)),this.services.connection.registerHandler(message_constants_1.TOPIC.PRESENCE,this.handle.bind(this)),this.services.connection.onExitLimbo(this.onExitLimbo.bind(this)),this.services.connection.onLost(this.onExitLimbo.bind(this)),this.services.connection.onReestablished(this.onConnectionReestablished.bind(this))}subscribe(s,e){if("string"==typeof s&&s.length>0&&"function"==typeof e){const t=s;return this.subscriptionEmitter.hasListeners(t)||this.bulkSubscription.subscribe(t),void this.subscriptionEmitter.on(t,e)}if("function"==typeof s&&void 0===e)return this.globalSubscriptionEmitter.hasListeners(ONLY_EVENT)||this.subscribeToAllChanges(),void this.globalSubscriptionEmitter.on(ONLY_EVENT,s);throw new Error('invalid arguments: "user" or "callback"')}unsubscribe(s,e){if(s&&"string"==typeof s&&s.length>0){const t=s;if(e){if("function"!=typeof e)throw new Error('invalid argument: "callback"');this.subscriptionEmitter.off(t,e)}else this.subscriptionEmitter.off(t);if(!this.subscriptionEmitter.hasListeners(t))return void this.bulkSubscription.unsubscribe(t)}if(s&&"function"==typeof s)return e=s,this.globalSubscriptionEmitter.off(ONLY_EVENT,e),void(this.globalSubscriptionEmitter.hasListeners(ONLY_EVENT)||this.unsubscribeToAllChanges());if(void 0===s&&void 0===e)return this.subscriptionEmitter.off(),this.globalSubscriptionEmitter.off(),this.bulkSubscription.unsubscribeList(this.subscriptionEmitter.eventNames()),void this.unsubscribeToAllChanges();throw new Error('invalid argument: "user" or "callback"')}getAll(...s){const{callback:e,users:t}=validateQueryArguments(s);let i,n,r;if(t){const s=(this.counter++).toString();i={topic:message_constants_1.TOPIC.PRESENCE,action:message_constants_1.PRESENCE_ACTIONS.QUERY,correlationId:s,names:t},n=this.queryEmitter,r=s}else i={topic:message_constants_1.TOPIC.PRESENCE,action:message_constants_1.PRESENCE_ACTIONS.QUERY_ALL},n=this.queryAllEmitter,r=ONLY_EVENT;if(this.services.connection.isConnected?this.sendQuery(i):this.services.connection.isInLimbo?this.limboQueue.push(i):this.services.timerRegistry.requestIdleCallback(()=>{n.emit(r,constants_1.EVENT.CLIENT_OFFLINE)}),!e)return new Promise((s,e)=>{n.once(r,(t,i)=>t?e(t):s(i))});n.once(r,e)}handle(s){if(s.isAck)this.services.timeoutRegistry.remove(s);else{if(s.action===message_constants_1.PRESENCE_ACTIONS.QUERY_ALL_RESPONSE)return this.queryAllEmitter.emit(ONLY_EVENT,null,s.names),void this.services.timeoutRegistry.remove(s);if(s.action===message_constants_1.PRESENCE_ACTIONS.QUERY_RESPONSE)return this.queryEmitter.emit(s.correlationId,null,s.parsedData),void this.services.timeoutRegistry.remove(s);if(s.action!==message_constants_1.PRESENCE_ACTIONS.PRESENCE_JOIN)if(s.action!==message_constants_1.PRESENCE_ACTIONS.PRESENCE_JOIN_ALL)if(s.action!==message_constants_1.PRESENCE_ACTIONS.PRESENCE_LEAVE){if(s.action!==message_constants_1.PRESENCE_ACTIONS.PRESENCE_LEAVE_ALL)return s.isError?(this.services.timeoutRegistry.remove(s),void(s.originalAction===message_constants_1.PRESENCE_ACTIONS.QUERY?this.queryEmitter.emit(s.correlationId,message_constants_1.PRESENCE_ACTIONS[s.action]):s.originalAction===message_constants_1.PRESENCE_ACTIONS.QUERY_ALL?this.queryAllEmitter.emit(ONLY_EVENT,message_constants_1.PRESENCE_ACTIONS[s.action]):this.services.logger.error(s))):void this.services.logger.error(s,constants_1.EVENT.UNSOLICITED_MESSAGE);this.globalSubscriptionEmitter.emit(ONLY_EVENT,s.name,!1)}else this.subscriptionEmitter.emit(s.name,s.name,!1);else this.globalSubscriptionEmitter.emit(ONLY_EVENT,s.name,!0);else this.subscriptionEmitter.emit(s.name,s.name,!0)}}sendQuery(s){this.services.connection.sendMessage(s),this.services.timeoutRegistry.add({message:s})}subscribeToAllChanges(){if(!this.services.connection.isConnected)return;const s={topic:message_constants_1.TOPIC.PRESENCE,action:message_constants_1.PRESENCE_ACTIONS.SUBSCRIBE_ALL};this.services.timeoutRegistry.add({message:s}),this.services.connection.sendMessage(s)}unsubscribeToAllChanges(){if(!this.services.connection.isConnected)return;const s={topic:message_constants_1.TOPIC.PRESENCE,action:message_constants_1.PRESENCE_ACTIONS.UNSUBSCRIBE_ALL};this.services.timeoutRegistry.add({message:s}),this.services.connection.sendMessage(s)}onConnectionReestablished(){const s=this.subscriptionEmitter.eventNames();s.length>0&&this.bulkSubscription.subscribeList(s),this.globalSubscriptionEmitter.hasListeners(ONLY_EVENT)&&this.subscribeToAllChanges();for(let s=0;s<this.limboQueue.length;s++)this.sendQuery(this.limboQueue[s]);this.limboQueue=[]}onExitLimbo(){this.queryEmitter.eventNames().forEach(s=>{this.queryEmitter.emit(s,constants_1.EVENT.CLIENT_OFFLINE)}),this.queryAllEmitter.emit(ONLY_EVENT,constants_1.EVENT.CLIENT_OFFLINE),this.limboQueue=[],this.queryAllEmitter.off(),this.queryEmitter.off()}onBulkSubscriptionSent(s){this.services.timeoutRegistry.add({message:s})}}exports.PresenceHandler=PresenceHandler;