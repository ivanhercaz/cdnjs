"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const message_constants_1=require("../../binary-protocol/src/message-constants"),constants_1=require("../constants"),listener_1=require("../util/listener"),Emitter=require("component-emitter2"),bulk_subscription_service_1=require("../util/bulk-subscription-service");class EventHandler{constructor(e,s,t){this.services=e,this.emitter=new Emitter,this.limboQueue=[],this.bulkSubscription=new bulk_subscription_service_1.BulkSubscriptionService(this.services,s.subscriptionInterval,message_constants_1.TOPIC.EVENT,message_constants_1.EVENT_ACTIONS.SUBSCRIBE_BULK,message_constants_1.EVENT_ACTIONS.SUBSCRIBE,message_constants_1.EVENT_ACTIONS.UNSUBSCRIBE_BULK,message_constants_1.EVENT_ACTIONS.UNSUBSCRIBE,this.onBulkSubscriptionSent.bind(this)),this.listeners=t||new listener_1.Listener(message_constants_1.TOPIC.EVENT,e),this.services.connection.registerHandler(message_constants_1.TOPIC.EVENT,this.handle.bind(this)),this.services.connection.onExitLimbo(this.onExitLimbo.bind(this)),this.services.connection.onReestablished(this.onConnectionReestablished.bind(this))}subscribe(e,s){if("string"!=typeof e||0===e.length)throw new Error("invalid argument name");if("function"!=typeof s)throw new Error("invalid argument callback");this.emitter.hasListeners(e)||this.services.connection.isConnected&&this.bulkSubscription.subscribe(e),this.emitter.on(e,s)}unsubscribe(e,s){if(!e||"string"!=typeof e||0===e.length)throw new Error("invalid argument name");if(void 0!==s&&"function"!=typeof s)throw new Error("invalid argument callback");this.emitter.hasListeners(e)?(this.emitter.off(e,s),this.emitter.hasListeners(e)||this.bulkSubscription.unsubscribe(e)):this.services.logger.warn({topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.NOT_SUBSCRIBED,name:e})}emit(e,s){if("string"!=typeof e||0===e.length)throw new Error("invalid argument name");const t={topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.EMIT,name:e,parsedData:s};this.services.connection.isConnected?this.services.connection.sendMessage(t):this.services.connection.isInLimbo&&this.limboQueue.push(t),this.emitter.emit(e,s)}listen(e,s){this.listeners.listen(e,s)}unlisten(e){this.listeners.unlisten(e)}handle(e){if(e.isAck)this.services.timeoutRegistry.remove(e);else{if(e.action!==message_constants_1.EVENT_ACTIONS.EMIT)return e.action===message_constants_1.EVENT_ACTIONS.MESSAGE_DENIED?(this.services.logger.error({topic:message_constants_1.TOPIC.EVENT},message_constants_1.EVENT_ACTIONS.MESSAGE_DENIED),this.services.timeoutRegistry.remove(e),void(e.originalAction===message_constants_1.EVENT_ACTIONS.SUBSCRIBE&&this.emitter.off(e.name))):e.action===message_constants_1.EVENT_ACTIONS.MULTIPLE_SUBSCRIPTIONS?(this.services.timeoutRegistry.remove(Object.assign({},e,{action:message_constants_1.EVENT_ACTIONS.SUBSCRIBE})),void this.services.logger.warn(e)):e.action===message_constants_1.EVENT_ACTIONS.NOT_SUBSCRIBED?(this.services.timeoutRegistry.remove(Object.assign({},e,{action:message_constants_1.EVENT_ACTIONS.SUBSCRIBE})),void this.services.logger.warn(e)):void(e.action!==message_constants_1.EVENT_ACTIONS.SUBSCRIPTION_FOR_PATTERN_FOUND&&e.action!==message_constants_1.EVENT_ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED?e.action!==message_constants_1.EVENT_ACTIONS.INVALID_LISTEN_REGEX?this.services.logger.error(e,constants_1.EVENT.UNSOLICITED_MESSAGE):this.services.logger.error(e):this.listeners.handle(e));void 0!==e.parsedData?this.emitter.emit(e.name,e.parsedData):this.emitter.emit(e.name,void 0)}}onConnectionReestablished(){this.bulkSubscription.subscribeList(this.emitter.eventNames());for(let e=0;e<this.limboQueue.length;e++)this.services.connection.sendMessage(this.limboQueue[e]);this.limboQueue=[]}onExitLimbo(){this.limboQueue=[]}onBulkSubscriptionSent(e){e.names||this.services.timeoutRegistry.add({message:e})}}exports.EventHandler=EventHandler;