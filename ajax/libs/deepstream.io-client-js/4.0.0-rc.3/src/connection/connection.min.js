"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const constants_1=require("../constants"),message_constants_1=require("../../binary-protocol/src/message-constants"),message_parser_1=require("../../binary-protocol/src/message-parser"),state_machine_1=require("../util/state-machine"),utils=require("../util/utils"),Emitter=require("component-emitter2");class Connection{constructor(t,s,e,n){this.services=t,this.options=s,this.reconnectTimeout=-1,this.authParams=null,this.handlers=new Map,this.authCallback=null,this.resumeCallback=null,this.emitter=n,this.internalEmitter=new Emitter,this.isInLimbo=!0,this.clientData=null,this.heartbeatIntervalTimeout=null,this.endpoint=null,this.reconnectionAttempt=0,this.limboTimeout=null;let i=!1,a=!0;this.stateMachine=new state_machine_1.StateMachine(this.services.logger,{init:constants_1.CONNECTION_STATE.CLOSED,onStateChanged:(t,s)=>{t!==s&&(n.emit(constants_1.EVENT.CONNECTION_STATE_CHANGED,t),t===constants_1.CONNECTION_STATE.RECONNECTING?(this.isInLimbo=!0,i=!0,s!==constants_1.CONNECTION_STATE.CLOSED&&(this.internalEmitter.emit(constants_1.EVENT.CONNECTION_LOST),this.limboTimeout=this.services.timerRegistry.add({duration:this.options.offlineBufferTimeout,context:this,callback:()=>{this.isInLimbo=!1,this.internalEmitter.emit(constants_1.EVENT.EXIT_LIMBO)}}))):t===constants_1.CONNECTION_STATE.OPEN&&(i||a)&&(a=!1,this.isInLimbo=!1,this.internalEmitter.emit(constants_1.EVENT.CONNECTION_REESTABLISHED),this.services.timerRegistry.remove(this.limboTimeout)))},transitions:[{name:"initialised",from:constants_1.CONNECTION_STATE.CLOSED,to:constants_1.CONNECTION_STATE.INITIALISING},{name:"connected",from:constants_1.CONNECTION_STATE.INITIALISING,to:constants_1.CONNECTION_STATE.AWAITING_CONNECTION},{name:"connected",from:constants_1.CONNECTION_STATE.REDIRECTING,to:constants_1.CONNECTION_STATE.AWAITING_CONNECTION},{name:"connected",from:constants_1.CONNECTION_STATE.RECONNECTING,to:constants_1.CONNECTION_STATE.AWAITING_CONNECTION},{name:"challenge",from:constants_1.CONNECTION_STATE.AWAITING_CONNECTION,to:constants_1.CONNECTION_STATE.CHALLENGING},{name:"redirected",from:constants_1.CONNECTION_STATE.CHALLENGING,to:constants_1.CONNECTION_STATE.REDIRECTING},{name:"challenge-denied",from:constants_1.CONNECTION_STATE.CHALLENGING,to:constants_1.CONNECTION_STATE.CHALLENGE_DENIED},{name:"accepted",from:constants_1.CONNECTION_STATE.CHALLENGING,to:constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION,handler:this.onAwaitingAuthentication.bind(this)},{name:"authentication-timeout",from:constants_1.CONNECTION_STATE.AWAITING_CONNECTION,to:constants_1.CONNECTION_STATE.AUTHENTICATION_TIMEOUT},{name:"authentication-timeout",from:constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION,to:constants_1.CONNECTION_STATE.AUTHENTICATION_TIMEOUT},{name:"authenticate",from:constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION,to:constants_1.CONNECTION_STATE.AUTHENTICATING},{name:"unsuccesful-login",from:constants_1.CONNECTION_STATE.AUTHENTICATING,to:constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION},{name:"succesful-login",from:constants_1.CONNECTION_STATE.AUTHENTICATING,to:constants_1.CONNECTION_STATE.OPEN},{name:"too-many-auth-attempts",from:constants_1.CONNECTION_STATE.AUTHENTICATING,to:constants_1.CONNECTION_STATE.TOO_MANY_AUTH_ATTEMPTS},{name:"too-many-auth-attempts",from:constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION,to:constants_1.CONNECTION_STATE.TOO_MANY_AUTH_ATTEMPTS},{name:"authentication-timeout",from:constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION,to:constants_1.CONNECTION_STATE.AUTHENTICATION_TIMEOUT},{name:"reconnect",from:constants_1.CONNECTION_STATE.RECONNECTING,to:constants_1.CONNECTION_STATE.RECONNECTING},{name:"closed",from:constants_1.CONNECTION_STATE.CLOSING,to:constants_1.CONNECTION_STATE.CLOSED},{name:"offline",from:constants_1.CONNECTION_STATE.PAUSING,to:constants_1.CONNECTION_STATE.OFFLINE},{name:"error",to:constants_1.CONNECTION_STATE.RECONNECTING},{name:"connection-lost",to:constants_1.CONNECTION_STATE.RECONNECTING},{name:"resume",to:constants_1.CONNECTION_STATE.RECONNECTING},{name:"pause",to:constants_1.CONNECTION_STATE.PAUSING},{name:"close",to:constants_1.CONNECTION_STATE.CLOSING}]}),this.stateMachine.transition("initialised"),this.originalUrl=utils.parseUrl(e,this.options.path),this.url=this.originalUrl,s.lazyConnect||this.createEndpoint()}get isConnected(){return this.stateMachine.state===constants_1.CONNECTION_STATE.OPEN}onLost(t){this.internalEmitter.on(constants_1.EVENT.CONNECTION_LOST,t)}removeOnLost(t){this.internalEmitter.off(constants_1.EVENT.CONNECTION_LOST,t)}onReestablished(t){this.internalEmitter.on(constants_1.EVENT.CONNECTION_REESTABLISHED,t)}removeOnReestablished(t){this.internalEmitter.off(constants_1.EVENT.CONNECTION_REESTABLISHED,t)}onExitLimbo(t){this.internalEmitter.on(constants_1.EVENT.EXIT_LIMBO,t)}registerHandler(t,s){this.handlers.set(t,s)}sendMessage(t){this.isOpen()?this.endpoint&&this.endpoint.sendParsedMessage(t):this.services.logger.error(t,constants_1.EVENT.IS_CLOSED)}authenticate(t,s){if(t&&"object"!=typeof t&&"function"!=typeof t)throw new Error("invalid argument authParamsOrCallback");if(s&&"function"!=typeof s)throw new Error("invalid argument callback");this.stateMachine.state!==constants_1.CONNECTION_STATE.CHALLENGE_DENIED&&this.stateMachine.state!==constants_1.CONNECTION_STATE.TOO_MANY_AUTH_ATTEMPTS&&this.stateMachine.state!==constants_1.CONNECTION_STATE.AUTHENTICATION_TIMEOUT?(t&&(this.authParams="object"==typeof t?t:{}),this.authCallback=t&&"function"==typeof t?t:s||(()=>{}),this.stateMachine.state===constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION&&this.authParams&&this.sendAuthParams(),this.endpoint||this.createEndpoint()):this.services.logger.error({topic:message_constants_1.TOPIC.CONNECTION},constants_1.EVENT.IS_CLOSED)}getConnectionState(){return this.stateMachine.state}isOpen(){const t=this.getConnectionState();return t!==constants_1.CONNECTION_STATE.CLOSED&&t!==constants_1.CONNECTION_STATE.ERROR&&t!==constants_1.CONNECTION_STATE.CLOSING}close(){this.services.timerRegistry.remove(this.heartbeatIntervalTimeout),this.sendMessage({topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.CLOSING}),this.stateMachine.transition("close")}pause(){this.stateMachine.transition("pause"),this.services.timerRegistry.remove(this.heartbeatIntervalTimeout),this.endpoint&&this.endpoint.close()}resume(t){this.stateMachine.transition("resume"),this.resumeCallback=t,this.tryReconnect()}createEndpoint(){this.endpoint=this.services.socketFactory(this.url,this.options.socketOptions,this.options.heartbeatInterval),this.endpoint.onopen=this.onOpen.bind(this),this.endpoint.onerror=this.onError.bind(this),this.endpoint.onclose=this.onClose.bind(this),this.endpoint.onparsedmessages=this.onMessages.bind(this)}onOpen(){this.clearReconnect(),this.checkHeartBeat(),this.stateMachine.transition("connected"),this.sendMessage({topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.CHALLENGE,url:this.originalUrl,protocolVersion:"0.1a"}),this.stateMachine.transition("challenge")}onError(t){setTimeout(()=>{let s;if("ECONNRESET"===t.code||"ECONNREFUSED"===t.code)s=`Can't connect! Deepstream server unreachable on ${this.originalUrl}`;else try{s=JSON.stringify(t)}catch(e){s=t.toString()}this.services.logger.error({topic:message_constants_1.TOPIC.CONNECTION},constants_1.EVENT.CONNECTION_ERROR,s)},1),this.services.timerRegistry.remove(this.heartbeatIntervalTimeout),this.stateMachine.transition("error"),this.tryReconnect()}onClose(){this.services.timerRegistry.remove(this.heartbeatIntervalTimeout),this.stateMachine.state!==constants_1.CONNECTION_STATE.REDIRECTING?this.stateMachine.state!==constants_1.CONNECTION_STATE.CHALLENGE_DENIED&&this.stateMachine.state!==constants_1.CONNECTION_STATE.TOO_MANY_AUTH_ATTEMPTS&&this.stateMachine.state!==constants_1.CONNECTION_STATE.AUTHENTICATION_TIMEOUT&&(this.stateMachine.state!==constants_1.CONNECTION_STATE.CLOSING?this.stateMachine.state!==constants_1.CONNECTION_STATE.PAUSING?(this.stateMachine.transition("connection-lost"),this.tryReconnect()):this.stateMachine.transition("offline"):this.stateMachine.transition("closed")):this.createEndpoint()}onMessages(t){t.forEach(t=>{if(t.parseError)return void this.services.logger.error({topic:message_constants_1.TOPIC.PARSER},t.action,t.raw&&t.raw.toString());const s=t,e=message_parser_1.parseData(s);if(!0!==e&&this.services.logger.error({topic:message_constants_1.TOPIC.PARSER},message_constants_1.PARSER_ACTIONS.INVALID_MESSAGE,e),null===s)return;if(s.topic===message_constants_1.TOPIC.CONNECTION)return void this.handleConnectionResponse(s);if(s.topic===message_constants_1.TOPIC.AUTH)return void this.handleAuthResponse(s);const n=this.handlers.get(s.topic);n&&n(s)})}sendAuthParams(){this.stateMachine.transition("authenticate"),this.sendMessage({topic:message_constants_1.TOPIC.AUTH,action:message_constants_1.AUTH_ACTIONS.REQUEST,parsedData:this.authParams})}checkHeartBeat(){const t=2*this.options.heartbeatInterval;if(this.endpoint)return this.endpoint.getTimeSinceLastMessage()>t?(this.services.timerRegistry.remove(this.heartbeatIntervalTimeout),this.services.logger.error({topic:message_constants_1.TOPIC.CONNECTION},constants_1.EVENT.HEARTBEAT_TIMEOUT),void this.endpoint.close()):void(this.heartbeatIntervalTimeout=this.services.timerRegistry.add({duration:this.options.heartbeatInterval,callback:this.checkHeartBeat,context:this}))}tryReconnect(){if(null===this.reconnectTimeout){if(this.reconnectionAttempt<this.options.maxReconnectAttempts)return this.stateMachine.transition("reconnect"),this.reconnectTimeout=this.services.timerRegistry.add({callback:this.tryOpen,context:this,duration:Math.min(this.options.maxReconnectInterval,this.options.reconnectIntervalIncrement*this.reconnectionAttempt)}),void this.reconnectionAttempt++;this.emitter.emit(constants_1.EVENT[constants_1.EVENT.MAX_RECONNECTION_ATTEMPTS_REACHED],this.reconnectionAttempt),this.clearReconnect(),this.close()}}tryOpen(){this.stateMachine.state!==constants_1.CONNECTION_STATE.REDIRECTING&&(this.url=this.originalUrl),this.createEndpoint(),this.reconnectTimeout=null}clearReconnect(){this.services.timerRegistry.remove(this.reconnectTimeout),this.reconnectTimeout=null,this.reconnectionAttempt=0}handleConnectionResponse(t){if(t.action!==message_constants_1.CONNECTION_ACTIONS.ACCEPT)return t.action===message_constants_1.CONNECTION_ACTIONS.REJECT?(this.stateMachine.transition("challenge-denied"),void(this.endpoint&&this.endpoint.close())):t.action===message_constants_1.CONNECTION_ACTIONS.REDIRECT?(this.url=t.url,this.stateMachine.transition("redirected"),void(this.endpoint&&this.endpoint.close())):void(t.action===message_constants_1.CONNECTION_ACTIONS.AUTHENTICATION_TIMEOUT&&(this.stateMachine.transition("authentication-timeout"),this.services.logger.error(t)));this.stateMachine.transition("accepted")}handleAuthResponse(t){return t.action===message_constants_1.AUTH_ACTIONS.TOO_MANY_AUTH_ATTEMPTS?(this.stateMachine.transition("too-many-auth-attempts"),void this.services.logger.error(t)):t.action===message_constants_1.AUTH_ACTIONS.AUTH_UNSUCCESSFUL?(this.stateMachine.transition("unsuccesful-login"),void this.onAuthUnSuccessful()):t.action===message_constants_1.AUTH_ACTIONS.AUTH_SUCCESSFUL?(this.stateMachine.transition("succesful-login"),void this.onAuthSuccessful(t.parsedData)):void 0}onAwaitingAuthentication(){this.authParams&&this.sendAuthParams()}onAuthSuccessful(t){this.updateClientData(t),this.resumeCallback&&(this.resumeCallback(),this.resumeCallback=null),null!==this.authCallback&&(this.authCallback(!0,this.clientData),this.authCallback=null)}onAuthUnSuccessful(){const t={reason:constants_1.EVENT[constants_1.EVENT.INVALID_AUTHENTICATION_DETAILS]};this.resumeCallback&&(this.resumeCallback(t),this.resumeCallback=null),null!==this.authCallback?(this.authCallback(!1,t),this.authCallback=null):this.emitter.emit(constants_1.EVENT.REAUTHENTICATION_FAILURE,t)}updateClientData(t){const s=t||null;(null!==this.clientData||null!==s&&0!==Object.keys(s).length)&&(utils.deepEquals(this.clientData,t)||(this.emitter.emit(constants_1.EVENT.CLIENT_DATA_CHANGED,Object.assign({},s)),this.clientData=s))}}exports.Connection=Connection;