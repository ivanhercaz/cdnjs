"use strict";var __awaiter=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(n,a){function o(e){try{_(s.next(e))}catch(e){a(e)}}function c(e){try{_(s.throw(e))}catch(e){a(e)}}function _(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(o,c)}_((s=s.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const bluebird_1=require("bluebird"),chai_1=require("chai"),sinon_1=require("sinon"),connection_1=require("./connection"),mocks_1=require("../test/mocks"),client_options_1=require("../client-options"),constants_1=require("../constants"),message_constants_1=require("../../binary-protocol/src/message-constants"),Emitter=require("component-emitter2");describe("connection",()=>{let e,t,i,s,n,a,o,c,_;const N="wss://localhost:6020/deepstream",T={password:"123456"},E={name:"elton"},r="wss://localhost:6020/deepstream",d="wss://otherhost:6020/deepstream";function C(){return __awaiter(this,void 0,void 0,function*(){a.simulateOpen(),yield bluebird_1.Promise.delay(0)})}function l(){return __awaiter(this,void 0,void 0,function*(){n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.AWAITING_CONNECTION),n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.CHALLENGING),chai_1.expect(a.url).to.equal(r),a.simulateOpen(),yield bluebird_1.Promise.delay(0)})}function O(){return __awaiter(this,void 0,void 0,function*(){o.expects("sendParsedMessage").once().withExactArgs([{topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.CHALLENGE,url:N}]),yield bluebird_1.Promise.delay(0)})}function A(){return __awaiter(this,void 0,void 0,function*(){n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION),a.simulateMessages([{topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.ACCEPT}]),yield bluebird_1.Promise.delay(0)})}function u(){return __awaiter(this,void 0,void 0,function*(){a.simulateMessages([{topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.REJECT}]),yield bluebird_1.Promise.delay(0)})}function I(){return __awaiter(this,void 0,void 0,function*(){n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.AUTHENTICATING),o.expects("sendParsedMessage").once().withExactArgs({topic:message_constants_1.TOPIC.AUTH,action:message_constants_1.AUTH_ACTIONS.REQUEST,parsedData:T}),e.authenticate(T,_),yield bluebird_1.Promise.delay(0)})}function m(e){return __awaiter(this,void 0,void 0,function*(){const t=e||E;n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.OPEN),n.expects("emit").once().withExactArgs(constants_1.EVENT.CLIENT_DATA_CHANGED,Object.assign({},t)),a.simulateMessages([{topic:message_constants_1.TOPIC.AUTH,action:message_constants_1.AUTH_ACTIONS.AUTH_SUCCESSFUL,parsedData:Object.assign({},t)}]),yield bluebird_1.Promise.delay(5)})}function y(){return __awaiter(this,void 0,void 0,function*(){c.expects("error").once().withExactArgs({topic:message_constants_1.TOPIC.CONNECTION},constants_1.EVENT.CONNECTION_ERROR,JSON.stringify({code:1234})),a.simulateError(),yield bluebird_1.Promise.delay(1)})}function h(){return __awaiter(this,void 0,void 0,function*(){a.simulateMessages([{topic:message_constants_1.TOPIC.AUTH,action:message_constants_1.AUTH_ACTIONS.AUTH_UNSUCCESSFUL,parsedData:message_constants_1.AUTH_ACTIONS.INVALID_MESSAGE_DATA}]),yield bluebird_1.Promise.delay(10)})}function g(){return __awaiter(this,void 0,void 0,function*(){n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.RECONNECTING),a.close(),yield bluebird_1.Promise.delay(2),chai_1.expect(e.isConnected).to.equal(!1)})}function p(){const e=t.getSocket();a=e.socket,o=e.socketMock}beforeEach(()=>{t=mocks_1.getServicesMock(),i=Object.assign(client_options_1.DefaultOptions,{heartbeatInterval:15,reconnectIntervalIncrement:20,maxReconnectAttempts:3,maxReconnectInterval:300,offlineBufferTimeout:10}),s=new Emitter,n=sinon_1.mock(s),e=new connection_1.Connection(t,i,r,s),p(),function(){const e=t.getLogger();c=e.loggerMock}(),_=sinon_1.spy()}),afterEach(()=>{t.verify(),n.verify(),c.verify()}),it("supports happiest path",()=>__awaiter(this,void 0,void 0,function*(){yield l(),yield O(),yield A(),yield I(),yield m(),yield function(){return __awaiter(this,void 0,void 0,function*(){a.simulateMessages([{topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.EMIT,name:"eventA"}]),yield bluebird_1.Promise.delay(0)})}(),yield function(){return __awaiter(this,void 0,void 0,function*(){n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.CLOSING),o.expects("sendParsedMessage").once().withExactArgs({topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.CLOSING}),e.close(),yield bluebird_1.Promise.delay(0)})}(),yield function(){return __awaiter(this,void 0,void 0,function*(){n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.CLOSED),a.simulateMessages([{topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.CLOSING}]),a.simulateRemoteClose(),yield bluebird_1.Promise.delay(0)})}()})),it("send pong when ping received across all states",()=>__awaiter(this,void 0,void 0,function*(){yield C(),o.expects("sendParsedMessage").once().withExactArgs({topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.PONG}),a.simulateMessages([{topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.PING}])})),it("miss heartbeat once",()=>__awaiter(this,void 0,void 0,function*(){yield C(),yield bluebird_1.Promise.delay(22.5)})),it("miss a heartbeat twice and receive error",()=>__awaiter(this,void 0,void 0,function*(){c.expects("error").once().withExactArgs({topic:message_constants_1.TOPIC.CONNECTION},constants_1.EVENT.HEARTBEAT_TIMEOUT),a.getTimeSinceLastMessage=(()=>200),yield C()})),it("get redirected to server B while connecting to server A, reconnect to server A when connection to server B is lost",()=>__awaiter(this,void 0,void 0,function*(){yield l(),yield O(),yield function(){return __awaiter(this,void 0,void 0,function*(){n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.REDIRECTING),a.simulateMessages([{topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.REDIRECT,url:d}]),yield bluebird_1.Promise.delay(0)})}(),yield function(){return __awaiter(this,void 0,void 0,function*(){n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.AWAITING_CONNECTION),n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.CHALLENGING),p(),chai_1.expect(a.url).to.equal(d),a.simulateOpen(),yield bluebird_1.Promise.delay(0)})}(),yield O(),yield A(),yield g(),yield function(){return __awaiter(this,void 0,void 0,function*(){o.expects("onopen").once(),o.expects("sendParsedMessage").once().withExactArgs({topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.CHALLENGE,url:N}),a.simulateOpen(),yield bluebird_1.Promise.delay(0)})}()})),it("handles challenge denial",()=>__awaiter(this,void 0,void 0,function*(){n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.CHALLENGE_DENIED),yield l(),yield O(),yield u()})),it("handles authentication when challenge was denied",()=>__awaiter(this,void 0,void 0,function*(){c.expects("error").once().withArgs({topic:message_constants_1.TOPIC.CONNECTION},constants_1.EVENT.IS_CLOSED),n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.CHALLENGE_DENIED),yield l(),yield O(),yield u(),e.authenticate(T,_),sinon_1.assert.callCount(_,0),yield bluebird_1.Promise.delay(10)})),it("handles successful authentication",()=>__awaiter(this,void 0,void 0,function*(){yield l(),yield O(),yield A(),yield I(),yield m(),sinon_1.assert.calledOnce(_),sinon_1.assert.calledWithExactly(_,!0,E)})),it("handles rejected authentication",()=>__awaiter(this,void 0,void 0,function*(){n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION),yield l(),yield O(),yield A(),yield I(),yield h(),sinon_1.assert.calledOnce(_),sinon_1.assert.calledWithExactly(_,!1,{reason:constants_1.EVENT.INVALID_AUTHENTICATION_DETAILS})})),it("handles authenticating too may times",()=>__awaiter(this,void 0,void 0,function*(){n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.TOO_MANY_AUTH_ATTEMPTS),yield l(),yield O(),yield A(),yield I(),yield function(){return __awaiter(this,void 0,void 0,function*(){a.simulateMessages([{topic:message_constants_1.TOPIC.AUTH,action:message_constants_1.AUTH_ACTIONS.TOO_MANY_AUTH_ATTEMPTS}]),yield bluebird_1.Promise.delay(0)})}()})),it("handles authentication timeout",()=>__awaiter(this,void 0,void 0,function*(){n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.AUTHENTICATION_TIMEOUT),yield l(),yield O(),yield A(),yield function(){return __awaiter(this,void 0,void 0,function*(){a.simulateMessages([{topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.AUTHENTICATION_TIMEOUT}]),yield bluebird_1.Promise.delay(0)})}()})),it("try to authenticate with invalid data and receive error",()=>__awaiter(this,void 0,void 0,function*(){yield l(),yield O(),yield A(),yield function(){return __awaiter(this,void 0,void 0,function*(){chai_1.expect(()=>{e.authenticate("Bad Auth Data",_)}).to.throw("invalid argument authParamsOrCallback"),chai_1.expect(()=>{e.authenticate({},"Bad Auth Data")}).to.throw("invalid argument callback"),yield bluebird_1.Promise.delay(0)})}()})),it("tries to reconnect every time connection fails, stops when max reconnection attempts is reached and closes connection",()=>__awaiter(this,void 0,void 0,function*(){n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.CLOSING),n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.RECONNECTING),n.expects("emit").once().withExactArgs(constants_1.EVENT[constants_1.EVENT.MAX_RECONNECTION_ATTEMPTS_REACHED],3),yield l(),yield O(),yield A(),yield y(),yield bluebird_1.Promise.delay(0),yield y(),yield bluebird_1.Promise.delay(25),yield y(),yield bluebird_1.Promise.delay(45),yield y(),yield bluebird_1.Promise.delay(70)})),it("tries to reconnect if the connection drops unexpectedly",()=>__awaiter(this,void 0,void 0,function*(){n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.RECONNECTING),yield l(),yield O(),yield A(),yield y()})),it("emits reauthenticationFailure if reauthentication is rejected",()=>__awaiter(this,void 0,void 0,function*(){n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.RECONNECTING),n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION),n.expects("emit").once().withExactArgs(constants_1.EVENT.REAUTHENTICATION_FAILURE,{reason:constants_1.EVENT.INVALID_AUTHENTICATION_DETAILS}),yield l(),yield O(),yield A(),yield I(),yield m(),yield y(),yield bluebird_1.Promise.delay(0),yield l(),yield O(),yield function(){return __awaiter(this,void 0,void 0,function*(){n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.AWAITING_AUTHENTICATION),n.expects("emit").once().withExactArgs(constants_1.EVENT.CONNECTION_STATE_CHANGED,constants_1.CONNECTION_STATE.AUTHENTICATING),o.expects("sendParsedMessage").once().withExactArgs({topic:message_constants_1.TOPIC.AUTH,action:message_constants_1.AUTH_ACTIONS.REQUEST,parsedData:T}),a.simulateMessages([{topic:message_constants_1.TOPIC.CONNECTION,action:message_constants_1.CONNECTION_ACTIONS.ACCEPT}]),yield bluebird_1.Promise.delay(0)})}(),yield h(),yield bluebird_1.Promise.delay(0),sinon_1.assert.calledOnce(_)})),it("goes into limbo on connection lost",()=>__awaiter(this,void 0,void 0,function*(){yield C();const t=sinon_1.spy();e.onExitLimbo(t),yield g(),chai_1.expect(e.isInLimbo).to.equal(!0),yield bluebird_1.Promise.delay(20),sinon_1.assert.calledOnce(t),chai_1.expect(e.isInLimbo).to.equal(!1)}))});