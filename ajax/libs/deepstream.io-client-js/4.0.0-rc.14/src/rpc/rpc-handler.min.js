"use strict";var __values=this&&this.__values||function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],s=0;return t?t.call(e):{next:function(){return e&&s>=e.length&&(e=void 0),{value:e&&e[s++],done:!e}}}},__read=this&&this.__read||function(e,t){var s="function"==typeof Symbol&&e[Symbol.iterator];if(!s)return e;var n,i,o=s.call(e),r=[];try{for(;(void 0===t||0<t--)&&!(n=o.next()).done;)r.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(s=o.return)&&s.call(o)}finally{if(i)throw i.error}}return r};Object.defineProperty(exports,"__esModule",{value:!0});var message_constants_1=require("../../binary-protocol/src/message-constants"),constants_1=require("../constants"),rpc_1=require("../rpc/rpc"),rpc_response_1=require("../rpc/rpc-response"),utils_1=require("../util/utils"),RPCHandler=function(){function e(e,t){this.services=e,this.options=t,this.rpcs=new Map,this.providers=new Map,this.limboQueue=[],this.services.connection.registerHandler(message_constants_1.TOPIC.RPC,this.handle.bind(this)),this.services.connection.onReestablished(this.onConnectionReestablished.bind(this)),this.services.connection.onExitLimbo(this.onExitLimbo.bind(this)),this.services.connection.onLost(this.onConnectionLost.bind(this))}return e.prototype.provide=function(e,t){if("string"!=typeof e||0===e.length)throw new Error("invalid argument name");if(this.providers.has(e))throw new Error("RPC "+e+" already registered");if("function"!=typeof t)throw new Error("invalid argument callback");this.providers.set(e,t),this.services.connection.isConnected&&this.sendProvide(e)},e.prototype.unprovide=function(e){if("string"!=typeof e||0===e.length)throw new Error("invalid argument name");if(this.providers.has(e)){if(this.providers.delete(e),this.services.connection.isConnected){var t={topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.UNPROVIDE,name:e};return this.services.timeoutRegistry.add({message:t}),void this.services.connection.sendMessage(t)}}else this.services.logger.warn({topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.NOT_PROVIDED,name:e})},e.prototype.make=function(e,t,s){var i=this;if("string"!=typeof e||0===e.length)throw new Error("invalid argument name");if(s&&"function"!=typeof s)throw new Error("invalid argument callback");var o=utils_1.getUid();if(this.services.connection.isConnected)return s?void this.rpcs.set(o,new rpc_1.RPC(e,o,t,s,this.options,this.services)):new Promise(function(s,n){i.rpcs.set(o,new rpc_1.RPC(e,o,t,function(e,t){return e?n(e):s(t)},i.options,i.services))});if(this.services.connection.isInLimbo){if(!s)return new Promise(function(s,n){i.limboQueue.push({correlationId:o,name:e,data:t,callback:function(e,t){return e?n(e):s(t)}})});this.limboQueue.push({correlationId:o,name:e,data:t,callback:s})}else{if(!s)return Promise.reject(constants_1.EVENT.CLIENT_OFFLINE);s(constants_1.EVENT.CLIENT_OFFLINE)}},e.prototype.respondToRpc=function(e){var t=this.providers.get(e.name);t?t(e.parsedData,new rpc_response_1.RPCResponse(e,this.options,this.services)):this.services.connection.sendMessage({topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.REJECT,name:e.name,correlationId:e.correlationId})},e.prototype.handle=function(e){if(e.action!==message_constants_1.RPC_ACTIONS.REQUEST)if(e.isAck)this.services.timeoutRegistry.remove(e);else{if(e.action===message_constants_1.RPC_ACTIONS.MESSAGE_PERMISSION_ERROR||e.action===message_constants_1.RPC_ACTIONS.MESSAGE_DENIED){if(e.originalAction===message_constants_1.RPC_ACTIONS.PROVIDE||e.originalAction===message_constants_1.RPC_ACTIONS.UNPROVIDE)return this.services.timeoutRegistry.remove(e),this.providers.delete(e.name),void this.services.logger.error(e);if(e.originalAction===message_constants_1.RPC_ACTIONS.REQUEST){var t=this.getRPC(e);if(t)return t.error(message_constants_1.RPC_ACTIONS[e.action]),void this.rpcs.delete(e.correlationId)}}var s=this.getRPC(e);if(s){if(e.action===message_constants_1.RPC_ACTIONS.ACCEPT)return void s.accept();e.action===message_constants_1.RPC_ACTIONS.RESPONSE?s.respond(e.parsedData):e.action===message_constants_1.RPC_ACTIONS.REQUEST_ERROR?s.error(e.parsedData):e.action!==message_constants_1.RPC_ACTIONS.RESPONSE_TIMEOUT&&e.action!==message_constants_1.RPC_ACTIONS.NO_RPC_PROVIDER||s.error(message_constants_1.RPC_ACTIONS[e.action]),this.rpcs.delete(e.correlationId)}}else this.respondToRpc(e)},e.prototype.getRPC=function(e){var t=this.rpcs.get(e.correlationId);return void 0===t&&this.services.logger.error(e,constants_1.EVENT.UNKNOWN_CORRELATION_ID),t},e.prototype.sendProvide=function(e){var t={topic:message_constants_1.TOPIC.RPC,action:message_constants_1.RPC_ACTIONS.PROVIDE,name:e};this.services.timeoutRegistry.add({message:t}),this.services.connection.sendMessage(t)},e.prototype.onConnectionReestablished=function(){var t,e;try{for(var s=__values(this.providers),n=s.next();!n.done;n=s.next()){var i=__read(n.value,1)[0];this.sendProvide(i)}}catch(e){t={error:e}}finally{try{n&&!n.done&&(e=s.return)&&e.call(s)}finally{if(t)throw t.error}}for(var o=0;o<this.limboQueue.length;o++){var r=this.limboQueue[o],a=r.correlationId,c=r.name,_=r.data,l=r.callback;this.rpcs.set(a,new rpc_1.RPC(c,a,_,l,this.options,this.services))}this.limboQueue=[]},e.prototype.onExitLimbo=function(){for(var e=0;e<this.limboQueue.length;e++)this.limboQueue[e].callback(constants_1.EVENT.CLIENT_OFFLINE);this.limboQueue=[]},e.prototype.onConnectionLost=function(){this.rpcs.forEach(function(e){e.error(constants_1.EVENT.CLIENT_OFFLINE)}),this.rpcs.clear()},e}();exports.RPCHandler=RPCHandler;