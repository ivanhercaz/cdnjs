"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var message_constants_1=require("../../binary-protocol/src/message-constants"),constants_1=require("../../src/constants"),Listener=function(){function t(t,s){this.topic=t,this.services=s,this.listeners=new Map,this.stopCallbacks=new Map,t===message_constants_1.TOPIC.RECORD?this.actions=message_constants_1.RECORD_ACTIONS:t===message_constants_1.TOPIC.EVENT&&(this.actions=message_constants_1.EVENT_ACTIONS),this.services.connection.onLost(this.onConnectionLost.bind(this)),this.services.connection.onReestablished(this.onConnectionReestablished.bind(this))}return t.prototype.listen=function(t,s){if("string"!=typeof t||0===t.length)throw new Error("invalid argument pattern");if("function"!=typeof s)throw new Error("invalid argument callback");this.listeners.has(t)?this.services.logger.warn({topic:this.topic,action:constants_1.EVENT.LISTENER_EXISTS,name:t}):(this.listeners.set(t,s),this.sendListen(t))},t.prototype.unlisten=function(t){if("string"!=typeof t||0===t.length)throw new Error("invalid argument pattern");this.listeners.has(t)?(this.listeners.delete(t),this.sendUnlisten(t)):this.services.logger.warn({topic:this.topic,action:constants_1.EVENT.NOT_LISTENING,name:t})},t.prototype.accept=function(t,s){this.services.connection.sendMessage({topic:this.topic,action:this.actions.LISTEN_ACCEPT,name:t,subscription:s})},t.prototype.reject=function(t,s){this.services.connection.sendMessage({topic:this.topic,action:this.actions.LISTEN_REJECT,name:t,subscription:s})},t.prototype.stop=function(t,s){this.stopCallbacks.set(t,s)},t.prototype.handle=function(t){if(t.isAck)this.services.timeoutRegistry.remove(t);else if(t.action!==this.actions.SUBSCRIPTION_FOR_PATTERN_FOUND)if(t.action!==this.actions.SUBSCRIPTION_FOR_PATTERN_REMOVED)this.services.logger.error(t,constants_1.EVENT.UNSOLICITED_MESSAGE);else{var s=this.stopCallbacks.get(t.subscription);s&&(s(t.subscription),this.stopCallbacks.delete(t.subscription))}else{var e=this.listeners.get(t.name);e&&e(t.subscription,{accept:this.accept.bind(this,t.name,t.subscription),reject:this.reject.bind(this,t.name,t.subscription),onStop:this.stop.bind(this,t.subscription)})}},t.prototype.onConnectionLost=function(){this.stopCallbacks.forEach(function(t,s){t(s)}),this.stopCallbacks.clear()},t.prototype.onConnectionReestablished=function(){var e=this;this.listeners.forEach(function(t,s){e.sendListen(s)})},t.prototype.sendListen=function(t){var s={topic:this.topic,action:this.actions.LISTEN,name:t};this.services.timeoutRegistry.add({message:s}),this.services.connection.sendMessage(s)},t.prototype.sendUnlisten=function(t){var s={topic:this.topic,action:this.actions.UNLISTEN,name:t};this.services.timeoutRegistry.add({message:s}),this.services.connection.sendMessage(s)},t}();exports.Listener=Listener;