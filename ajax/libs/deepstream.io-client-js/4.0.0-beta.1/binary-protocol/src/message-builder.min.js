"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const message_constants_1=require("./message-constants"),utils_1=require("./utils"),constants_1=require("./constants"),message_validator_1=require("./message-validator");function getMessage(t,s){const e=t;let a=e.action;if(e.isWriteAck&&!utils_1.isWriteAck(e.action)&&(a=utils_1.ACTION_TO_WRITE_ACK[e.action]),(e.isAck||s)&&(a|=128,void 0===message_constants_1.ACTIONS[e.topic][e.action]))throw new Error(`message ${message_constants_1.TOPIC[e.topic]} ${e.action} should not have an ack`);const n=Object.create(null);for(const t in message_constants_1.META_KEYS)n[message_constants_1.META_KEYS[t]]=e[t];n[message_constants_1.META_KEYS.payloadEncoding]===message_constants_1.PAYLOAD_ENCODING.JSON&&delete n[message_constants_1.META_KEYS.payloadEncoding];const o=message_validator_1.validateMeta(e.topic,a,n);if(o)throw new Error(`invalid ${message_constants_1.TOPIC[e.topic]} ${message_constants_1.ACTIONS[e.topic][a]||a}: ${o}`);const i=JSON.stringify(n),c="{}"===i?null:Buffer.from(i,"utf8");let _;if(e.data instanceof Buffer)_=e.data;else if(void 0!==e.data||void 0!==e.parsedData){let t=e.data;void 0===t&&(t=JSON.stringify(e.parsedData)),_=Buffer.from(t,"utf8")}else _=null;_&&!message_validator_1.hasPayload(e.topic,a)&&console.error(`invalid message ${message_constants_1.TOPIC[e.topic]} ${e.action}: should not have payload`);const r=c?c.length:0,l=_?_.length:0;return r<=constants_1.META_PAYLOAD_OVERFLOW_LENGTH&&l<=constants_1.META_PAYLOAD_OVERFLOW_LENGTH?buildRaw(!0,e.topic,a,c,_):buildMultipart(e.topic,a,c,_)}function buildMultipart(t,s,e,a){const n=e?e.length:0,o=a?a.length:0,i=[];let c,_=0,r=0;do{const l=Math.min(n-_,constants_1.META_PAYLOAD_OVERFLOW_LENGTH),u=Math.min(o-r,constants_1.META_PAYLOAD_OVERFLOW_LENGTH),E=e&&e.slice(_,_+l),d=a&&a.slice(r,r+u);r+=u,c=(_+=l)===n&&r===o,i.push(buildRaw(c,t,s,E,d))}while(!c);return Buffer.concat(i)}function buildRaw(t,s,e,a,n){const o=a?a.length:0,i=n?n.length:0,c=constants_1.HEADER_LENGTH+o+i,_=Buffer.allocUnsafe(c);return _[0]=(t?128:0)|s,_[1]=e,_.writeUIntBE(o,2,3),_.writeUIntBE(i,5,3),a&&a.copy(_,constants_1.HEADER_LENGTH),n&&n.copy(_,constants_1.HEADER_LENGTH+o),_}exports.getMessage=getMessage;