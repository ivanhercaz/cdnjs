"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const message_constants_1=require("./message-constants"),constants_1=require("./constants"),utils_1=require("./utils"),message_validator_1=require("./message-validator");function isError(a){return a.action>=80&&a.action<112||a.topic===message_constants_1.TOPIC.PARSER}function parse(a,s=[]){let e=0;const t=[];do{const{bytesConsumed:n,rawMessage:r}=readBinary(a,e);if(!r)break;if(s.push(r),e+=n,r.fin){const a=parseMessage(joinMessages(s));s.length=0,t.push(a)}}while(e<a.length);return t}function parseData(a){return void 0!==a.parsedData||void 0===a.data||(a.payloadEncoding&&a.payloadEncoding!==message_constants_1.PAYLOAD_ENCODING.JSON?new Error(`unable to parse data of type '${a.payloadEncoding}'`):"string"==typeof a.data?new Error("tried to parse string data with binary parser"):(a.parsedData=parseJSON(a.data),void 0!==a.parsedData||new Error(`unable to parse data ${a.data}`)))}function readBinary(a,s){if(a.length<s+constants_1.HEADER_LENGTH)return{bytesConsumed:0};const e=!!(128&a[s]),t=127&a[s],n=a[s+1],r=a.readUIntBE(s+2,3),o=a.readUIntBE(s+5,3),i=constants_1.HEADER_LENGTH+r+o;if(a.length<s+i)return{bytesConsumed:0};const c={fin:e,topic:t,action:n,rawHeader:a.slice(s,s+constants_1.HEADER_LENGTH)};return r>0&&(c.meta=a.slice(s+constants_1.HEADER_LENGTH,s+constants_1.HEADER_LENGTH+r)),o>0&&(c.payload=a.slice(s+constants_1.HEADER_LENGTH+r,s+i)),{bytesConsumed:i,rawMessage:c}}function joinMessages(a){if(0===a.length)throw new Error("parseMessage must not be called with an empty message queue");if(1===a.length)return a[0];const{topic:s,action:e,rawHeader:t}=a[0],n=[],r=[];a.forEach(({payload:a,meta:s})=>{a&&n.push(a),s&&r.push(s)});const o=Buffer.concat(n);return{fin:!0,topic:s,action:e,rawHeader:t,meta:Buffer.concat(r),payload:o}}function parseMessage(a){const{topic:s,action:e,rawHeader:t}=a;if(void 0===message_constants_1.TOPIC[s])return{parseError:!0,action:message_constants_1.PARSER_ACTIONS.UNKNOWN_TOPIC,parsedMessage:{topic:s,action:e},description:`unknown topic ${s}`,raw:t};const n=s;if(void 0===message_constants_1.ACTIONS[n][e])return{parseError:!0,action:message_constants_1.PARSER_ACTIONS.UNKNOWN_ACTION,parsedMessage:{topic:n,action:e},description:`unknown ${message_constants_1.TOPIC[n]} action ${e}`,raw:t};const r={topic:n,action:127&e};if(a.meta&&a.meta.length>0){const s=parseJSON(a.meta);if(!s||"object"!=typeof s)return{parseError:!0,action:message_constants_1.PARSER_ACTIONS.MESSAGE_PARSE_ERROR,parsedMessage:r,description:`invalid meta field ${a.meta.toString()}`,raw:t};const o=message_validator_1.validateMeta(n,e,s);if(o)throw new Error(`invalid meta ${message_constants_1.TOPIC[r.topic]} ${message_constants_1.ACTIONS[r.topic][r.action]}: ${o}`);addMetadataToMessage(s,r)}if(void 0!==a.payload){if(!message_validator_1.hasPayload(r.topic,e))return{parseError:!0,action:message_constants_1.PARSER_ACTIONS.INVALID_MESSAGE,parsedMessage:r,description:"should not have a payload"};r.payloadEncoding||n!==message_constants_1.TOPIC.PARSER||(r.payloadEncoding=message_constants_1.PAYLOAD_ENCODING.BINARY),r.data=a.payload}return r.isAck=e>=128,r.isError=isError(r),r.topic===message_constants_1.TOPIC.RECORD&&utils_1.isWriteAck(e)&&(r.isWriteAck=!0),r}function addMetadataToMessage(a,s){for(const e in message_constants_1.META_KEYS){const t=a[message_constants_1.META_KEYS[e]];void 0!==t&&(s[e]=t)}}function parseJSON(a){try{return JSON.parse(a.toString())}catch(a){return}}exports.isError=isError,exports.parse=parse,exports.parseData=parseData,exports.parseJSON=parseJSON;