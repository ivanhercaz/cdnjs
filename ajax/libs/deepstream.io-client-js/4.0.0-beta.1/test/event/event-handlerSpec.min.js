"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const chai_1=require("chai"),sinon=require("sinon"),mocks_1=require("../mocks"),constants_1=require("../../src/constants"),message_constants_1=require("../../binary-protocol/src/message-constants"),client_options_1=require("../../src/client-options"),event_handler_1=require("../../src/event/event-handler");describe("event handler",()=>{let e,s,t,n,c;const o="myEvent";beforeEach(()=>{e=mocks_1.getServicesMock(),s=mocks_1.getListenerMock(),t=new event_handler_1.EventHandler(e,client_options_1.DefaultOptions,s.listener),n=e.getHandle(),c=sinon.spy()}),afterEach(()=>{e.verify(),s.listenerMock.verify()}),it("validates parameters on subscribe, unsubscribe and emit",()=>{chai_1.expect(t.subscribe.bind(t,"",()=>{})).to.throw(),chai_1.expect(t.subscribe.bind(t,1,()=>{})).to.throw(),chai_1.expect(t.subscribe.bind(t,"event",null)).to.throw(),chai_1.expect(t.unsubscribe.bind(t,"",()=>{})).to.throw(),chai_1.expect(t.unsubscribe.bind(t,1,()=>{})).to.throw(),chai_1.expect(t.unsubscribe.bind(t,"event",null)).to.throw(),chai_1.expect(t.unsubscribe.bind(t,null)).to.throw(),chai_1.expect(t.emit.bind(t,"",()=>{})).to.throw(),chai_1.expect(t.emit.bind(t,1,()=>{})).to.throw(),chai_1.expect(t.emit.bind(t,null,()=>{})).to.throw()}),it("emits an event it has no listeners for",()=>{e.connectionMock.expects("sendMessage").once().withExactArgs({topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.EMIT,name:o,parsedData:6}),t.emit(o,6)}),it("subscribes to an event",()=>{e.connectionMock.expects("sendMessage").once().withExactArgs({topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.SUBSCRIBE,name:o}),e.timeoutRegistryMock.expects("add").once().withExactArgs({message:{topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.SUBSCRIBE,name:o}}),t.subscribe(o,c)}),it("resubscribes to an event when connection reestablished",()=>{e.connectionMock.expects("sendMessage").twice().withExactArgs({topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.SUBSCRIBE,name:o}),e.timeoutRegistryMock.expects("add").twice().withExactArgs({message:{topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.SUBSCRIBE,name:o}}),t.subscribe(o,c),e.simulateConnectionReestablished()}),it("subscribes to an event twice",()=>{e.connectionMock.expects("sendMessage").once(),e.timeoutRegistryMock.expects("add").once(),t.subscribe(o,c),t.subscribe(o,c)}),it("unsubscribes to an event after subscribing",()=>{e.connectionMock.expects("sendMessage").once(),e.connectionMock.expects("sendMessage").once().withExactArgs({topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.UNSUBSCRIBE,name:o}),e.timeoutRegistryMock.expects("add").once(),e.timeoutRegistryMock.expects("add").once().withExactArgs({message:{topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.UNSUBSCRIBE,name:o}}),t.subscribe(o,c),t.unsubscribe(o,c)}),it("unsubscribes to an event after unsubscribing already",()=>{e.connectionMock.expects("sendMessage").once(),e.connectionMock.expects("sendMessage").once().withExactArgs({topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.UNSUBSCRIBE,name:o}),e.timeoutRegistryMock.expects("add").once(),e.timeoutRegistryMock.expects("add").once().withExactArgs({message:{topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.UNSUBSCRIBE,name:o}}),e.loggerMock.expects("warn").once().withExactArgs({topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.NOT_SUBSCRIBED,name:o}),t.subscribe(o,c),t.unsubscribe(o,c),t.unsubscribe(o,c)}),it("notifies local listeners for local events",()=>{t.subscribe(o,c),t.emit(o,8),sinon.assert.calledOnce(c),sinon.assert.calledWithExactly(c,8)}),it("notifies local listeners for remote events",()=>{t.subscribe(o,c),n({topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.EMIT,name:o,parsedData:8}),sinon.assert.calledOnce(c),sinon.assert.calledWithExactly(c,8)}),it("removes local listeners",()=>{t.subscribe(o,c),t.unsubscribe(o,c),t.emit(o,11),sinon.assert.callCount(c,0)}),it("notifies local listeners for remote events without data",()=>{t.subscribe(o,c),n({topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.EMIT,name:o}),sinon.assert.calledOnce(c),sinon.assert.calledWithExactly(c,void 0)}),it("unsubscribes locally when it recieves a message denied",()=>{t.subscribe(o,c),n({topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.MESSAGE_DENIED,originalAction:message_constants_1.EVENT_ACTIONS.SUBSCRIBE,name:o}),t.emit(o,11),sinon.assert.callCount(c,0)}),it("forwards subscribe ack messages",()=>{e.timeoutRegistryMock.expects("remove").once().withExactArgs({isAck:!0,topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.SUBSCRIBE,name:o}),n({isAck:!0,topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.SUBSCRIBE,name:o})}),it("forwards unsubscribe ack messages",()=>{e.timeoutRegistryMock.expects("remove").once().withExactArgs({isAck:!0,topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.UNSUBSCRIBE,name:o}),n({isAck:!0,topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.UNSUBSCRIBE,name:o})}),it("warns when a not subscribed is remotely recieved",()=>{e.loggerMock.expects("warn").once().withExactArgs({topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.NOT_SUBSCRIBED,name:o}),n({topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.NOT_SUBSCRIBED,name:o})}),it("listens for pattern",()=>{const e=()=>{};s.listenerMock.expects("listen").once().withExactArgs(".*",e),t.listen(".*",e)}),it("unlistens a pattern",()=>{s.listenerMock.expects("unlisten").once().withExactArgs(".*"),t.unlisten(".*")}),it("it forwards listeners' messages to listeners",()=>{const e={topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.SUBSCRIPTION_FOR_PATTERN_FOUND,name:".*",subscription:"subscription"},t={topic:message_constants_1.TOPIC.EVENT,action:message_constants_1.EVENT_ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED,name:".*",subscription:"subscription"};s.listenerMock.expects("handle").once().withExactArgs(e),s.listenerMock.expects("handle").once().withExactArgs(t),n(e),n(t)}),it("logs an error event for unsolicited event messages",()=>{e.loggerMock.expects("error").once().withExactArgs({topic:message_constants_1.TOPIC.EVENT,action:-1},constants_1.EVENT.UNSOLICITED_MESSAGE),n({topic:message_constants_1.TOPIC.EVENT,action:-1})})});