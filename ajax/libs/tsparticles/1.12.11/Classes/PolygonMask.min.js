"use strict";var __awaiter=this&&this.__awaiter||function(t,r,s,h){return new(s=s||Promise)(function(e,n){function o(t){try{i(h.next(t))}catch(t){n(t)}}function a(t){try{i(h.throw(t))}catch(t){n(t)}}function i(t){var n;t.done?e(t.value):((n=t.value)instanceof s?n:new s(function(t){t(n)})).then(o,a)}i((h=h.apply(t,r||[])).next())})},__generator=this&&this.__generator||function(e,o){var a,i,r,t,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return t={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function n(n){return function(t){return function(n){if(a)throw new TypeError("Generator is already executing.");for(;s;)try{if(a=1,i&&(r=2&n[0]?i.return:n[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,n[1])).done)return r;switch(i=0,r&&(n=[2&n[0],r.value]),n[0]){case 0:case 1:r=n;break;case 4:return s.label++,{value:n[1],done:!1};case 5:s.label++,i=n[1],n=[0];continue;case 7:n=s.ops.pop(),s.trys.pop();continue;default:if(!(r=0<(r=s.trys).length&&r[r.length-1])&&(6===n[0]||2===n[0])){s=0;continue}if(3===n[0]&&(!r||n[1]>r[0]&&n[1]<r[3])){s.label=n[1];break}if(6===n[0]&&s.label<r[1]){s.label=r[1],r=n;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(n);break}r[2]&&s.ops.pop(),s.trys.pop();continue}n=o.call(e,s)}catch(t){n=[6,t],i=0}finally{a=r=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,t])}}};Object.defineProperty(exports,"__esModule",{value:!0});var PolygonMaskType_1=require("../Enums/PolygonMaskType"),Particle_1=require("./Particle"),PolygonMaskInlineArrangement_1=require("../Enums/PolygonMaskInlineArrangement"),Utils_1=require("./Utils/Utils"),PolygonMask=function(){function t(t){this.container=t,this.dimension={height:0,width:0},this.polygonPathLength=0,this.path2DSupported=window.hasOwnProperty("Path2D")}return t.prototype.checkInsidePolygon=function(t){var n=this.container,e=n.options;if(!e.polygon.enable||e.polygon.type===PolygonMaskType_1.PolygonMaskType.none||e.polygon.type===PolygonMaskType_1.PolygonMaskType.inline)return!0;if(!this.raw)return console.error("No polygon found, you need to specify SVG url in config."),!0;for(var o=t?t.x:Math.random()*n.canvas.dimension.width,a=t?t.y:Math.random()*n.canvas.dimension.height,i=!1,r=0,s=this.raw.length-1;r<this.raw.length;s=r++){var h=this.raw[r].x,l=this.raw[r].y,g=this.raw[s].x,y=this.raw[s].y;a<l!=a<y&&o<(g-h)*(a-l)/(y-l)+h&&(i=!i)}return e.polygon.type===PolygonMaskType_1.PolygonMaskType.inside?i:e.polygon.type===PolygonMaskType_1.PolygonMaskType.outside&&!i},t.prototype.redraw=function(){var n=this,e=this.container,t=e.options;t.polygon.enable&&t.polygon.type!==PolygonMaskType_1.PolygonMaskType.none&&(this.redrawTimeout&&clearTimeout(this.redrawTimeout),this.redrawTimeout=setTimeout(function(){n.parseSvgPathToPolygon().then(function(t){n.raw=t,n.createPath2D(),e.particles.redraw()})},250))},t.prototype.init=function(){return __awaiter(this,void 0,void 0,function(){var n,e,o;return __generator(this,function(t){switch(t.label){case 0:return(n=this.container,(e=n.options).polygon.enable&&e.polygon.url)?[4,(o=this).parseSvgPathToPolygon(e.polygon.url)]:[3,2];case 1:o.raw=t.sent(),this.createPath2D(),t.label=2;case 2:return[2]}})})},t.prototype.reset=function(){delete this.raw,delete this.path,delete this.svg},t.prototype.randomPointInPolygon=function(){var t,n=this.container,e=n.options;if(e.polygon.type===PolygonMaskType_1.PolygonMaskType.inline)switch(e.polygon.inline.arrangement){case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.randomPoint:t=this.getRandomPointOnPolygonPath();break;case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.randomLength:t=this.getRandomPointOnPolygonPathByLength();break;case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.equidistant:t=this.getEquidistantPointOnPolygonPathByIndex(n.particles.count);break;case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.onePerPoint:case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.perPoint:default:t=this.getPoingOnPolygonPathByIndex(n.particles.count)}else t={x:Math.random()*n.canvas.dimension.width,y:Math.random()*n.canvas.dimension.height};return this.checkInsidePolygon(t)?t:this.randomPointInPolygon()},t.prototype.parseSvgPathToPolygon=function(u){return __awaiter(this,void 0,void 0,function(){var n,e,o,a,i,r,s,h,l,g,y,c,p,P,d;return __generator(this,function(t){switch(t.label){case 0:return n=this.container,e=n.options,o=u||e.polygon.url,this.path&&this.svg?[3,4]:[4,fetch(o)];case 1:return(a=t.sent()).ok?[4,a.text()]:[3,3];case 2:return i=t.sent(),r=new DOMParser,s=r.parseFromString(i,"image/svg+xml"),this.svg=s.getElementsByTagName("svg")[0],this.path=s.getElementsByTagName("path")[0],this.path&&(this.polygonPathLength=this.path.getTotalLength()),[3,4];case 3:return console.error("tsParticles Error - during polygon mask download"),[2];case 4:for(h=e.polygon.scale,this.dimension.width=parseFloat(this.svg.getAttribute("width")||"0")*h,this.dimension.height=parseFloat(this.svg.getAttribute("height")||"0")*h,this.offset={x:n.canvas.dimension.width/2-this.dimension.width/2,y:n.canvas.dimension.height/2-this.dimension.height/2},l=this.path.pathSegList.numberOfItems,g=[],y={x:0,y:0},c=0;c<l;c++){switch((p=this.path.pathSegList.getItem(c)).pathSegType){case window.SVGPathSeg.PATHSEG_MOVETO_ABS:case window.SVGPathSeg.PATHSEG_LINETO_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_ABS:case window.SVGPathSeg.PATHSEG_ARC_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_ABS:P=p,y.x=P.x,y.y=P.y;break;case window.SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_ABS:y.x=p.x;break;case window.SVGPathSeg.PATHSEG_LINETO_VERTICAL_ABS:y.y=p.y;break;case window.SVGPathSeg.PATHSEG_LINETO_REL:case window.SVGPathSeg.PATHSEG_MOVETO_REL:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_REL:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_REL:case window.SVGPathSeg.PATHSEG_ARC_REL:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_REL:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_REL:d=p,y.x+=d.x,y.y+=d.y;break;case window.SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_REL:y.x+=p.x;break;case window.SVGPathSeg.PATHSEG_LINETO_VERTICAL_REL:y.y+=p.y;break;case window.SVGPathSeg.PATHSEG_UNKNOWN:case window.SVGPathSeg.PATHSEG_CLOSEPATH:continue}g.push({x:y.x*h+this.offset.x,y:y.y*h+this.offset.y})}return[2,g]}})})},t.prototype.drawPolygon=function(){this.container.canvas.drawPolygonMask()},t.prototype.drawPointsOnPolygonPath=function(){var t=this.container;if(this.raw)for(var n=0,e=this.raw;n<e.length;n++){var o=e[n],a={x:o.x,y:o.y};t.particles.addParticle(new Particle_1.Particle(t,a))}},t.prototype.getRandomPointOnPolygonPath=function(){if(!this.raw||!this.raw.length)throw new Error("No polygon data loaded.");var t=Utils_1.Utils.itemFromArray(this.raw);return{x:t.x,y:t.y}},t.prototype.getRandomPointOnPolygonPathByLength=function(){var t,n,e=this.container.options;if(!this.raw||!this.raw.length||!this.path)throw new Error("No polygon data loaded.");var o=Math.floor(Math.random()*this.polygonPathLength)+1,a=this.path.getPointAtLength(o);return{x:a.x*e.polygon.scale+((null===(t=this.offset)||void 0===t?void 0:t.x)||0),y:a.y*e.polygon.scale+((null===(n=this.offset)||void 0===n?void 0:n.y)||0)}},t.prototype.getEquidistantPointOnPolygonPathByIndex=function(t){var n,e,o=this.container.options;if(!this.raw||!this.raw.length||!this.path)throw new Error("No polygon data loaded.");var a=this.polygonPathLength/o.particles.number.value*t,i=this.path.getPointAtLength(a);return{x:i.x*o.polygon.scale+((null===(n=this.offset)||void 0===n?void 0:n.x)||0),y:i.y*o.polygon.scale+((null===(e=this.offset)||void 0===e?void 0:e.y)||0)}},t.prototype.getPoingOnPolygonPathByIndex=function(t){if(!this.raw||!this.raw.length)throw new Error("No polygon data loaded.");var n=this.raw[t%this.raw.length];return{x:n.x,y:n.y}},t.prototype.createPath2D=function(){var t,o=this;if(this.path2DSupported){var n=null===(t=this.path)||void 0===t?void 0:t.getAttribute("d");if(n){var e=new Path2D(n),a=document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGMatrix(),i=new Path2D,r=a.scale(this.container.options.polygon.scale);i.addPath?(i.addPath(e,r),this.polygonPath=i):delete this.polygonPath}else delete this.polygonPath;!this.polygonPath&&this.raw&&(this.polygonPath=new Path2D,this.polygonPath.moveTo(this.raw[0].x,this.raw[0].y),this.raw.forEach(function(t,n){var e;0<n&&null!==(e=o.polygonPath)&&void 0!==e&&e.lineTo(t.x,t.y)}),this.polygonPath.closePath())}},t}();exports.PolygonMask=PolygonMask;