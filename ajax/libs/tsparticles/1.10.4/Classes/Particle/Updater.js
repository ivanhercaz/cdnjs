"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Updater = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _OutMode = require("../../Enums/OutMode");

var _Utils = require("../Utils/Utils");

var _PolygonMaskType = require("../../Enums/PolygonMaskType");

var _Mover = require("./Mover");

var _RotateDirection = require("../../Enums/RotateDirection");

/**
 * Particle updater, it manages movement
 */
var Updater = /*#__PURE__*/function () {
  function Updater(container, particle) {
    (0, _classCallCheck2["default"])(this, Updater);
    this.particle = void 0;
    this.container = void 0;
    this.mover = void 0;
    this.container = container;
    this.particle = particle;
    this.mover = new _Mover.Mover(container, particle);
  }

  (0, _createClass2["default"])(Updater, [{
    key: "update",
    value: function update(delta) {
      /* move the particle */
      this.mover.move(delta);
      /* change opacity status */

      this.updateOpacity();
      /* change size */

      this.updateSize();
      /* change size */

      this.updateAngle();
      /* change particle position if it is out of canvas */

      this.fixOutOfCanvasPosition();
      /* out of canvas modes */

      this.updateOutMode();
    }
  }, {
    key: "updateOpacity",
    value: function updateOpacity() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;

      if (options.particles.opacity.animation.enable) {
        if (particle.opacity.status) {
          if (particle.opacity.value >= options.particles.opacity.value) {
            particle.opacity.status = false;
          }

          particle.opacity.value += particle.opacity.velocity || 0;
        } else {
          if (particle.opacity.value <= options.particles.opacity.animation.minimumValue) {
            particle.opacity.status = true;
          }

          particle.opacity.value -= particle.opacity.velocity || 0;
        }

        if (particle.opacity.value < 0) {
          particle.opacity.value = 0;
        }
      }
    }
  }, {
    key: "updateSize",
    value: function updateSize() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;

      if (options.particles.size.animation.enable) {
        if (particle.size.status) {
          if (particle.radius >= container.retina.sizeValue) {
            particle.size.status = false;
          }

          particle.radius += particle.size.velocity || 0;
        } else {
          if (particle.radius <= options.particles.size.animation.minimumValue) {
            particle.size.status = true;
          }

          particle.radius -= particle.size.velocity || 0;
        }

        if (particle.radius < 0) {
          particle.radius = 0;
        }
      }
    }
  }, {
    key: "updateAngle",
    value: function updateAngle() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;

      if (options.particles.rotate.animation.enable) {
        switch (particle.rotateDirection) {
          case _RotateDirection.RotateDirection.clockwise:
            particle.angle += options.particles.rotate.animation.speed * Math.PI / 18;

            if (particle.angle > 360) {
              particle.angle -= 360;
            }

            break;

          case _RotateDirection.RotateDirection.counterClockwise:
          default:
            particle.angle -= options.particles.rotate.animation.speed * Math.PI / 18;

            if (particle.angle < 0) {
              particle.angle += 360;
            }

            break;
        }
      }
    }
  }, {
    key: "fixOutOfCanvasPosition",
    value: function fixOutOfCanvasPosition() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;
      var outMode = options.particles.move.outMode;
      var newPos;

      if (outMode === _OutMode.OutMode.bounce) {
        newPos = {
          x_left: particle.radius,
          x_right: container.canvas.dimension.width,
          y_bottom: container.canvas.dimension.height,
          y_top: particle.radius
        };
      } else if (outMode === _OutMode.OutMode.bounceHorizontal) {
        newPos = {
          x_left: particle.radius,
          x_right: container.canvas.dimension.width,
          y_bottom: container.canvas.dimension.height + particle.radius - particle.offset.y,
          y_top: -particle.radius - particle.offset.y
        };
      } else if (outMode === _OutMode.OutMode.bounceVertical) {
        newPos = {
          x_left: -particle.radius - particle.offset.x,
          x_right: container.canvas.dimension.width + particle.radius + particle.offset.x,
          y_bottom: container.canvas.dimension.height,
          y_top: particle.radius
        };
      } else {
        newPos = {
          x_left: -particle.radius - particle.offset.x,
          x_right: container.canvas.dimension.width + particle.radius + particle.offset.x,
          y_bottom: container.canvas.dimension.height + particle.radius - particle.offset.y,
          y_top: -particle.radius - particle.offset.y
        };
      }

      if (outMode === _OutMode.OutMode.destroy) {
        if (particle.position.x + particle.radius < 0 || particle.position.y + particle.radius < 0 || particle.position.x - particle.radius > container.canvas.dimension.width || particle.position.y - particle.radius > container.canvas.dimension.height) {
          var idx = container.particles.array.indexOf(particle);
          container.particles.array.splice(idx, 1);
        }
      } else {
        var nextPos = {
          x_left: particle.position.x - particle.radius,
          x_right: particle.position.x + particle.radius,
          y_bottom: particle.position.y + particle.radius,
          y_top: particle.position.y - particle.radius
        };
        var dimension = container.canvas.dimension;

        if (nextPos.x_left > dimension.width - particle.offset.x) {
          particle.position.x = newPos.x_left;
          particle.position.y = Math.random() * dimension.height;
        } else if (nextPos.x_right < -particle.offset.x) {
          particle.position.x = newPos.x_right;
          particle.position.y = Math.random() * dimension.height;
        }

        if (nextPos.y_top > container.canvas.dimension.height - particle.offset.y) {
          particle.position.y = newPos.y_top;
          particle.position.x = Math.random() * container.canvas.dimension.width;
        } else if (nextPos.y_bottom < -particle.offset.y) {
          particle.position.y = newPos.y_bottom;
          particle.position.x = Math.random() * container.canvas.dimension.width;
        }
      }
    }
  }, {
    key: "updateOutMode",
    value: function updateOutMode() {
      var container = this.container;
      var options = container.options;

      switch (options.particles.move.outMode) {
        case _OutMode.OutMode.bounce:
        case _OutMode.OutMode.bounceVertical:
        case _OutMode.OutMode.bounceHorizontal:
          this.updateBounce();
          break;
      }
    }
  }, {
    key: "updateBounce",
    value: function updateBounce() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;
      /* check bounce against polygon boundaries */

      if (options.polygon.enable && options.polygon.type !== _PolygonMaskType.PolygonMaskType.none && options.polygon.type !== _PolygonMaskType.PolygonMaskType.inline) {
        if (!container.polygon.checkInsidePolygon(particle.position)) {
          this.polygonBounce();
        }
      } else if (options.polygon.enable && options.polygon.type === _PolygonMaskType.PolygonMaskType.inline) {
        if (particle.initialPosition) {
          var dist = _Utils.Utils.getDistanceBetweenCoordinates(particle.initialPosition, particle.position);

          if (dist > container.retina.polygonMaskMoveRadius) {
            this.polygonBounce();
          }
        }
      } else {
        var outMode = options.particles.move.outMode;
        var x = particle.position.x + particle.offset.x;
        var y = particle.position.y + particle.offset.y;

        if (outMode === _OutMode.OutMode.bounce || outMode === _OutMode.OutMode.bounceHorizontal) {
          Updater.checkBounds(x, particle.radius, container.canvas.dimension.width, function () {
            particle.velocity.horizontal = -particle.velocity.horizontal;
          });
        }

        if (outMode === _OutMode.OutMode.bounce || outMode === _OutMode.OutMode.bounceVertical) {
          Updater.checkBounds(y, particle.radius, container.canvas.dimension.height, function () {
            particle.velocity.vertical = -particle.velocity.vertical;
          });
        }
      }
    }
  }, {
    key: "polygonBounce",
    value: function polygonBounce() {
      var particle = this.particle;
      particle.velocity.horizontal = -particle.velocity.horizontal + particle.velocity.vertical / 2;
      particle.velocity.vertical = -particle.velocity.vertical + particle.velocity.horizontal / 2;
    }
  }], [{
    key: "checkBounds",
    value: function checkBounds(coordinate, radius, size, outside) {
      if (coordinate + radius > size || coordinate - radius < 0) {
        outside();
      }
    }
  }]);
  return Updater;
}();

exports.Updater = Updater;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9DbGFzc2VzL1BhcnRpY2xlL1VwZGF0ZXIudHMiXSwibmFtZXMiOlsiVXBkYXRlciIsImNvbnRhaW5lciIsInBhcnRpY2xlIiwibW92ZXIiLCJNb3ZlciIsImRlbHRhIiwibW92ZSIsInVwZGF0ZU9wYWNpdHkiLCJ1cGRhdGVTaXplIiwidXBkYXRlQW5nbGUiLCJmaXhPdXRPZkNhbnZhc1Bvc2l0aW9uIiwidXBkYXRlT3V0TW9kZSIsIm9wdGlvbnMiLCJwYXJ0aWNsZXMiLCJvcGFjaXR5IiwiYW5pbWF0aW9uIiwiZW5hYmxlIiwic3RhdHVzIiwidmFsdWUiLCJ2ZWxvY2l0eSIsIm1pbmltdW1WYWx1ZSIsInNpemUiLCJyYWRpdXMiLCJyZXRpbmEiLCJzaXplVmFsdWUiLCJyb3RhdGUiLCJyb3RhdGVEaXJlY3Rpb24iLCJSb3RhdGVEaXJlY3Rpb24iLCJjbG9ja3dpc2UiLCJhbmdsZSIsInNwZWVkIiwiTWF0aCIsIlBJIiwiY291bnRlckNsb2Nrd2lzZSIsIm91dE1vZGUiLCJuZXdQb3MiLCJPdXRNb2RlIiwiYm91bmNlIiwieF9sZWZ0IiwieF9yaWdodCIsImNhbnZhcyIsImRpbWVuc2lvbiIsIndpZHRoIiwieV9ib3R0b20iLCJoZWlnaHQiLCJ5X3RvcCIsImJvdW5jZUhvcml6b250YWwiLCJvZmZzZXQiLCJ5IiwiYm91bmNlVmVydGljYWwiLCJ4IiwiZGVzdHJveSIsInBvc2l0aW9uIiwiaWR4IiwiYXJyYXkiLCJpbmRleE9mIiwic3BsaWNlIiwibmV4dFBvcyIsInJhbmRvbSIsInVwZGF0ZUJvdW5jZSIsInBvbHlnb24iLCJ0eXBlIiwiUG9seWdvbk1hc2tUeXBlIiwibm9uZSIsImlubGluZSIsImNoZWNrSW5zaWRlUG9seWdvbiIsInBvbHlnb25Cb3VuY2UiLCJpbml0aWFsUG9zaXRpb24iLCJkaXN0IiwiVXRpbHMiLCJnZXREaXN0YW5jZUJldHdlZW5Db29yZGluYXRlcyIsInBvbHlnb25NYXNrTW92ZVJhZGl1cyIsImNoZWNr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aUIsUUFBVCxDQUFrQnVELFFBQW5CLEdBQStCeEUsUUFBUSxDQUFDaUIsUUFBVCxDQUFrQnNELFVBQWxCLEdBQStCLENBQTNGO0FBQ0g7OztnQ0ExTzBCRSxVLEVBQW9CckQsTSxFQUFnQkQsSSxFQUFjdUQsTyxFQUEyQjtBQUNwRyxVQUFLRCxVQUFVLEdBQUdyRCxNQUFiLEdBQXNCRCxJQUF2QixJQUFpQ3NELFVBQVUsR0FBR3JELE1BQWIsR0FBc0IsQ0FBM0QsRUFBK0Q7QUFDM0RzRCxRQUFBQSxPQUFPO0FBQ1Y7QUFDSiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQge0NvbnRhaW5lcn0gZnJvbSBcIi4uL0NvbnRhaW5lclwiO1xuaW1wb3J0IHtPdXRNb2RlfSBmcm9tIFwiLi4vLi4vRW51bXMvT3V0TW9kZVwiO1xuaW1wb3J0IHtQYXJ0aWNsZX0gZnJvbSBcIi4uL1BhcnRpY2xlXCI7XG5pbXBvcnQge1V0aWxzfSBmcm9tIFwiLi4vVXRpbHMvVXRpbHNcIjtcbmltcG9ydCB7UG9seWdvbk1hc2tUeXBlfSBmcm9tIFwiLi4vLi4vRW51bXMvUG9seWdvbk1hc2tUeXBlXCI7XG5pbXBvcnQge01vdmVyfSBmcm9tIFwiLi9Nb3ZlclwiO1xuaW1wb3J0IHtSb3RhdGVEaXJlY3Rpb259IGZyb20gXCIuLi8uLi9FbnVtcy9Sb3RhdGVEaXJlY3Rpb25cIjtcblxuLyoqXG4gKiBQYXJ0aWNsZSB1cGRhdGVyLCBpdCBtYW5hZ2VzIG1vdmVtZW50XG4gKi9cbmV4cG9ydCBjbGFzcyBVcGRhdGVyIHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHBhcnRpY2xlOiBQYXJ0aWNsZTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbnRhaW5lcjogQ29udGFpbmVyO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgbW92ZXI6IE1vdmVyO1xuXG4gICAgY29uc3RydWN0b3IoY29udGFpbmVyOiBDb250YWluZXIsIHBhcnRpY2xlOiBQYXJ0aWNsZSkge1xuICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGNvbnRhaW5lcjtcbiAgICAgICAgdGhpcy5wYXJ0aWNsZSA9IHBhcnRpY2xlO1xuICAgICAgICB0aGlzLm1vdmVyID0gbmV3IE1vdmVyKGNvbnRhaW5lciwgcGFydGljbGUpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGNoZWNrQm91bmRzKGNvb3JkaW5hdGU6IG51bWJlciwgcmFkaXVzOiBudW1iZXIsIHNpemU6IG51bWJlciwgb3V0c2lkZTogKCkgPT4gdm9pZCk6IHZvaWQge1xuICAgICAgICBpZiAoKGNvb3JkaW5hdGUgKyByYWRpdXMgPiBzaXplKSB8fCAoY29vcmRpbmF0ZSAtIHJhZGl1cyA8IDApKSB7XG4gICAgICAgICAgICBvdXRzaWRlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgdXBkYXRlKGRlbHRhOiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgLyogbW92ZSB0aGUgcGFydGljbGUgKi9cbiAgICAgICAgdGhpcy5tb3Zlci5tb3ZlKGRlbHRhKTtcblxuICAgICAgICAvKiBjaGFuZ2Ugb3BhY2l0eSBzdGF0dXMgKi9cbiAgICAgICAgdGhpcy51cGRhdGVPcGFjaXR5KCk7XG5cbiAgICAgICAgLyogY2hhbmdlIHNpemUgKi9cbiAgICAgICAgdGhpcy51cGRhdGVTaXplKCk7XG5cbiAgICAgICAgLyogY2hhbmdlIHNpemUgKi9cbiAgICAgICAgdGhpcy51cGRhdGVBbmdsZSgpO1xuXG4gICAgICAgIC8qIGNoYW5nZSBwYXJ0aWNsZSBwb3NpdGlvbiBpZiBpdCBpcyBvdXQgb2YgY2FudmFzICovXG4gICAgICAgIHRoaXMuZml4T3V0T2ZDYW52YXNQb3NpdGlvbigpO1xuXG4gICAgICAgIC8qIG91dCBvZiBjYW52YXMgbW9kZXMgKi9cbiAgICAgICAgdGhpcy51cGRhdGVPdXRNb2RlKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVPcGFjaXR5KCk6IHZvaWQge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcjtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGNvbnRhaW5lci5vcHRpb25zO1xuICAgICAgICBjb25zdCBwYXJ0aWNsZSA9IHRoaXMucGFydGljbGU7XG5cbiAgICAgICAgaWYgKG9wdGlvbnMucGFydGljbGVzLm9wYWNpdHkuYW5pbWF0aW9uLmVuYWJsZSkge1xuICAgICAgICAgICAgaWYgKHBhcnRpY2xlLm9wYWNpdHkuc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBhcnRpY2xlLm9wYWNpdHkudmFsdWUgPj0gb3B0aW9ucy5wYXJ0aWNsZXMub3BhY2l0eS52YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICBwYXJ0aWNsZS5vcGFjaXR5LnN0YXR1cyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHBhcnRpY2xlLm9wYWNpdHkudmFsdWUgKz0gKHBhcnRpY2xlLm9wYWNpdHkudmVsb2NpdHkgfHwgMCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChwYXJ0aWNsZS5vcGFjaXR5LnZhbHVlIDw9IG9wdGlvbnMucGFydGljbGVzLm9wYWNpdHkuYW5pbWF0aW9uLm1pbmltdW1WYWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICBwYXJ0aWNsZS5vcGFjaXR5LnN0YXR1cyA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcGFydGljbGUub3BhY2l0eS52YWx1ZSAtPSAocGFydGljbGUub3BhY2l0eS52ZWxvY2l0eSB8fCAwKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHBhcnRpY2xlLm9wYWNpdHkudmFsdWUgPCAwKSB7XG4gICAgICAgICAgICAgICAgcGFydGljbGUub3BhY2l0eS52YWx1ZSA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHVwZGF0ZVNpemUoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyO1xuICAgICAgICBjb25zdCBvcHRpb25zID0gY29udGFpbmVyLm9wdGlvbnM7XG4gICAgICAgIGNvbnN0IHBhcnRpY2xlID0gdGhpcy5wYXJ0aWNsZTtcblxuICAgICAgICBpZiAob3B0aW9ucy5wYXJ0aWNsZXMuc2l6ZS5hbmltYXRpb24uZW5hYmxlKSB7XG4gICAgICAgICAgICBpZiAocGFydGljbGUuc2l6ZS5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgICBpZiAocGFydGljbGUucmFkaXVzID49IGNvbnRhaW5lci5yZXRpbmEuc2l6ZVZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcnRpY2xlLnNpemUuc3RhdHVzID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcGFydGljbGUucmFkaXVzICs9IChwYXJ0aWNsZS5zaXplLnZlbG9jaXR5IHx8IDApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAocGFydGljbGUucmFkaXVzIDw9IG9wdGlvbnMucGFydGljbGVzLnNpemUuYW5pbWF0aW9uLm1pbmltdW1WYWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICBwYXJ0aWNsZS5zaXplLnN0YXR1cyA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcGFydGljbGUucmFkaXVzIC09IChwYXJ0aWNsZS5zaXplLnZlbG9jaXR5IHx8IDApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocGFydGljbGUucmFkaXVzIDwgMCkge1xuICAgICAgICAgICAgICAgIHBhcnRpY2xlLnJhZGl1cyA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHVwZGF0ZUFuZ2xlKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcjtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGNvbnRhaW5lci5vcHRpb25zO1xuICAgICAgICBjb25zdCBwYXJ0aWNsZSA9IHRoaXMucGFydGljbGU7XG5cbiAgICAgICAgaWYgKG9wdGlvbnMucGFydGljbGVzLnJvdGF0ZS5hbmltYXRpb24uZW5hYmxlKSB7XG4gICAgICAgICAgICBzd2l0Y2ggKHBhcnRpY2xlLnJvdGF0ZURpcmVjdGlvbikge1xuICAgICAgICAgICAgICAgIGNhc2UgUm90YXRlRGlyZWN0aW9uLmNsb2Nrd2lzZTpcbiAgICAgICAgICAgICAgICAgICAgcGFydGljbGUuYW5nbGUgKz0gb3B0aW9ucy5wYXJ0aWNsZXMucm90YXRlLmFuaW1hdGlvbi5zcGVlZCAqIE1hdGguUEkgLyAxODtcblxuICAgICAgICAgICAgICAgICAgICBpZiAocGFydGljbGUuYW5nbGUgPiAzNjApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRpY2xlLmFuZ2xlIC09IDM2MDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlIFJvdGF0ZURpcmVjdGlvbi5jb3VudGVyQ2xvY2t3aXNlOlxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgIHBhcnRpY2xlLmFuZ2xlIC09IG9wdGlvbnMucGFydGljbGVzLnJvdGF0ZS5hbmltYXRpb24uc3BlZWQgKiBNYXRoLlBJIC8gMTg7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnRpY2xlLmFuZ2xlIDwgMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFydGljbGUuYW5nbGUgKz0gMzYwO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBmaXhPdXRPZkNhbnZhc1Bvc2l0aW9uKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcjtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGNvbnRhaW5lci5vcHRpb25zO1xuICAgICAgICBjb25zdCBwYXJ0aWNsZSA9IHRoaXMucGFydGljbGU7XG4gICAgICAgIGNvbnN0IG91dE1vZGUgPSBvcHRpb25zLnBhcnRpY2xlcy5tb3ZlLm91dE1vZGU7XG5cbiAgICAgICAgbGV0IG5ld1BvcztcblxuICAgICAgICBpZiAob3V0TW9kZSA9PT0gT3V0TW9kZS5ib3VuY2UpIHtcbiAgICAgICAgICAgIG5ld1BvcyA9IHtcbiAgICAgICAgICAgICAgICB4X2xlZnQ6IHBhcnRpY2xlLnJhZGl1cyxcbiAgICAgICAgICAgICAgICB4X3JpZ2h0OiBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi53aWR0aCxcbiAgICAgICAgICAgICAgICB5X2JvdHRvbTogY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24uaGVpZ2h0LFxuICAgICAgICAgICAgICAgIHlfdG9wOiBwYXJ0aWNsZS5yYWRpdXMsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2UgaWYgKG91dE1vZGUgPT09IE91dE1vZGUuYm91bmNlSG9yaXpvbnRhbCkge1xuICAgICAgICAgICAgbmV3UG9zID0ge1xuICAgICAgICAgICAgICAgIHhfbGVmdDogcGFydGljbGUucmFkaXVzLFxuICAgICAgICAgICAgICAgIHhfcmlnaHQ6IGNvbnRhaW5lci5jYW52YXMuZGltZW5zaW9uLndpZHRoLFxuICAgICAgICAgICAgICAgIHlfYm90dG9tOiBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi5oZWlnaHQgKyBwYXJ0aWNsZS5yYWRpdXMgLSBwYXJ0aWNsZS5vZmZzZXQueSxcbiAgICAgICAgICAgICAgICB5X3RvcDogLXBhcnRpY2xlLnJhZGl1cyAtIHBhcnRpY2xlLm9mZnNldC55LFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSBlbHNlIGlmIChvdXRNb2RlID09PSBPdXRNb2RlLmJvdW5jZVZlcnRpY2FsKSB7XG4gICAgICAgICAgICBuZXdQb3MgPSB7XG4gICAgICAgICAgICAgICAgeF9sZWZ0OiAtcGFydGljbGUucmFkaXVzIC0gcGFydGljbGUub2Zmc2V0LngsXG4gICAgICAgICAgICAgICAgeF9yaWdodDogY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24ud2lkdGggKyBwYXJ0aWNsZS5yYWRpdXMgKyBwYXJ0aWNsZS5vZmZzZXQueCxcbiAgICAgICAgICAgICAgICB5X2JvdHRvbTogY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24uaGVpZ2h0LFxuICAgICAgICAgICAgICAgIHlfdG9wOiBwYXJ0aWNsZS5yYWRpdXMsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbmV3UG9zID0ge1xuICAgICAgICAgICAgICAgIHhfbGVmdDogLXBhcnRpY2xlLnJhZGl1cyAtIHBhcnRpY2xlLm9mZnNldC54LFxuICAgICAgICAgICAgICAgIHhfcmlnaHQ6IGNvbnRhaW5lci5jYW52YXMuZGltZW5zaW9uLndpZHRoICsgcGFydGljbGUucmFkaXVzICsgcGFydGljbGUub2Zmc2V0LngsXG4gICAgICAgICAgICAgICAgeV9ib3R0b206IGNvbnRhaW5lci5jYW52YXMuZGltZW5zaW9uLmhlaWdodCArIHBhcnRpY2xlLnJhZGl1cyAtIHBhcnRpY2xlLm9mZnNldC55LFxuICAgICAgICAgICAgICAgIHlfdG9wOiAtcGFydGljbGUucmFkaXVzIC0gcGFydGljbGUub2Zmc2V0LnksXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG91dE1vZGUgPT09IE91dE1vZGUuZGVzdHJveSkge1xuICAgICAgICAgICAgaWYgKHBhcnRpY2xlLnBvc2l0aW9uLnggKyBwYXJ0aWNsZS5yYWRpdXMgPCAwIHx8XG4gICAgICAgICAgICAgICAgcGFydGljbGUucG9zaXRpb24ueSArIHBhcnRpY2xlLnJhZGl1cyA8IDAgfHxcbiAgICAgICAgICAgICAgICBwYXJ0aWNsZS5wb3NpdGlvbi54IC0gcGFydGljbGUucmFkaXVzID4gY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24ud2lkdGggfHxcbiAgICAgICAgICAgICAgICBwYXJ0aWNsZS5wb3NpdGlvbi55IC0gcGFydGljbGUucmFkaXVzID4gY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24uaGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaWR4ID0gY29udGFpbmVyLnBhcnRpY2xlcy5hcnJheS5pbmRleE9mKHBhcnRpY2xlKTtcbiAgICAgICAgICAgICAgICBjb250YWluZXIucGFydGljbGVzLmFycmF5LnNwbGljZShpZHgsIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgbmV4dFBvcyA9IHtcbiAgICAgICAgICAgICAgICB4X2xlZnQ6IHBhcnRpY2xlLnBvc2l0aW9uLnggLSBwYXJ0aWNsZS5yYWRpdXMsXG4gICAgICAgICAgICAgICAgeF9yaWdodDogcGFydGljbGUucG9zaXRpb24ueCArIHBhcnRpY2xlLnJhZGl1cyxcbiAgICAgICAgICAgICAgICB5X2JvdHRvbTogcGFydGljbGUucG9zaXRpb24ueSArIHBhcnRpY2xlLnJhZGl1cyxcbiAgICAgICAgICAgICAgICB5X3RvcDogcGFydGljbGUucG9zaXRpb24ueSAtIHBhcnRpY2xlLnJhZGl1cyxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjb25zdCBkaW1lbnNpb24gPSBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbjtcblxuICAgICAgICAgICAgaWYgKG5leHRQb3MueF9sZWZ0ID4gZGltZW5zaW9uLndpZHRoIC0gcGFydGljbGUub2Zmc2V0LngpIHtcbiAgICAgICAgICAgICAgICBwYXJ0aWNsZS5wb3NpdGlvbi54ID0gbmV3UG9zLnhfbGVmdDtcbiAgICAgICAgICAgICAgICBwYXJ0aWNsZS5wb3NpdGlvbi55ID0gTWF0aC5yYW5kb20oKSAqIGRpbWVuc2lvbi5oZWlnaHQ7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG5leHRQb3MueF9yaWdodCA8IC1wYXJ0aWNsZS5vZmZzZXQueCkge1xuICAgICAgICAgICAgICAgIHBhcnRpY2xlLnBvc2l0aW9uLnggPSBuZXdQb3MueF9yaWdodDtcbiAgICAgICAgICAgICAgICBwYXJ0aWNsZS5wb3NpdGlvbi55ID0gTWF0aC5yYW5kb20oKSAqIGRpbWVuc2lvbi5oZWlnaHQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChuZXh0UG9zLnlfdG9wID4gY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24uaGVpZ2h0IC0gcGFydGljbGUub2Zmc2V0LnkpIHtcbiAgICAgICAgICAgICAgICBwYXJ0aWNsZS5wb3NpdGlvbi55ID0gbmV3UG9zLnlfdG9wO1xuICAgICAgICAgICAgICAgIHBhcnRpY2xlLnBvc2l0aW9uLnggPSBNYXRoLnJhbmRvbSgpICogY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24ud2lkdGg7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG5leHRQb3MueV9ib3R0b20gPCAtcGFydGljbGUub2Zmc2V0LnkpIHtcbiAgICAgICAgICAgICAgICBwYXJ0aWNsZS5wb3NpdGlvbi55ID0gbmV3UG9zLnlfYm90dG9tO1xuICAgICAgICAgICAgICAgIHBhcnRpY2xlLnBvc2l0aW9uLnggPSBNYXRoLnJhbmRvbSgpICogY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24ud2lkdGg7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHVwZGF0ZU91dE1vZGUoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyO1xuICAgICAgICBjb25zdCBvcHRpb25zID0gY29udGFpbmVyLm9wdGlvbnM7XG5cbiAgICAgICAgc3dpdGNoIChvcHRpb25zLnBhcnRpY2xlcy5tb3ZlLm91dE1vZGUpIHtcbiAgICAgICAgICAgIGNhc2UgT3V0TW9kZS5ib3VuY2U6XG4gICAgICAgICAgICBjYXNlIE91dE1vZGUuYm91bmNlVmVydGljYWw6XG4gICAgICAgICAgICBjYXNlIE91dE1vZGUuYm91bmNlSG9yaXpvbnRhbDpcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUJvdW5jZSgpO1xuXG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHVwZGF0ZUJvdW5jZSgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jb250YWluZXI7XG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSBjb250YWluZXIub3B0aW9ucztcbiAgICAgICAgY29uc3QgcGFydGljbGUgPSB0aGlzLnBhcnRpY2xlO1xuXG4gICAgICAgIC8qIGNoZWNrIGJvdW5jZSBhZ2FpbnN0IHBvbHlnb24gYm91bmRhcmllcyAqL1xuICAgICAgICBpZiAob3B0aW9ucy5wb2x5Z29uLmVuYWJsZSAmJiBvcHRpb25zLnBvbHlnb24udHlwZSAhPT0gUG9seWdvbk1hc2tUeXBlLm5vbmUgJiZcbiAgICAgICAgICAgIG9wdGlvbnMucG9seWdvbi50eXBlICE9PSBQb2x5Z29uTWFza1R5cGUuaW5saW5lKSB7XG4gICAgICAgICAgICBpZiAoIWNvbnRhaW5lci5wb2x5Z29uLmNoZWNrSW5zaWRlUG9seWdvbihwYXJ0aWNsZS5wb3NpdGlvbikpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnBvbHlnb25Cb3VuY2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zLnBvbHlnb24uZW5hYmxlICYmIG9wdGlvbnMucG9seWdvbi50eXBlID09PSBQb2x5Z29uTWFza1R5cGUuaW5saW5lKSB7XG4gICAgICAgICAgICBpZiAocGFydGljbGUuaW5pdGlhbFBvc2l0aW9uKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IFV0aWxzLmdldERpc3RhbmNlQmV0d2VlbkNvb3JkaW5hdGVzKHBhcnRpY2xlLmluaXRpYWxQb3NpdGlvbiwgcGFydGljbGUucG9zaXRpb24pO1xuXG4gICAgICAgICAgICAgICAgaWYgKGRpc3QgPiBjb250YWluZXIucmV0aW5hLnBvbHlnb25NYXNrTW92ZVJhZGl1cykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnBvbHlnb25Cb3VuY2UoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBvdXRNb2RlID0gb3B0aW9ucy5wYXJ0aWNsZXMubW92ZS5vdXRNb2RlO1xuICAgICAgICAgICAgY29uc3QgeCA9IHBhcnRpY2xlLnBvc2l0aW9uLnggKyBwYXJ0aWNsZS5vZmZzZXQueDtcbiAgICAgICAgICAgIGNvbnN0IHkgPSBwYXJ0aWNsZS5wb3NpdGlvbi55ICsgcGFydGljbGUub2Zmc2V0Lnk7XG5cbiAgICAgICAgICAgIGlmIChvdXRNb2RlID09PSBPdXRNb2RlLmJvdW5jZSB8fCBvdXRNb2RlID09PSBPdXRNb2RlLmJvdW5jZUhvcml6b250YWwpIHtcbiAgICAgICAgICAgICAgICBVcGRhdGVyLmNoZWNrQm91bmRzKHgsIHBhcnRpY2xlLnJhZGl1cywgY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24ud2lkdGgsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcGFydGljbGUudmVsb2NpdHkuaG9yaXpvbnRhbCA9IC1wYXJ0aWNsZS52ZWxvY2l0eS5ob3Jpem9udGFsO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAob3V0TW9kZSA9PT0gT3V0TW9kZS5ib3VuY2UgfHwgb3V0TW9kZSA9PT0gT3V0TW9kZS5ib3VuY2VWZXJ0aWNhbCkge1xuICAgICAgICAgICAgICAgIFVwZGF0ZXIuY2hlY2tCb3VuZHMoeSwgcGFydGljbGUucmFkaXVzLCBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi5oZWlnaHQsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcGFydGljbGUudmVsb2NpdHkudmVydGljYWwgPSAtcGFydGljbGUudmVsb2NpdHkudmVydGljYWw7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHBvbHlnb25Cb3VuY2UoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHBhcnRpY2xlID0gdGhpcy5wYXJ0aWNsZTtcblxuICAgICAgICBwYXJ0aWNsZS52ZWxvY2l0eS5ob3Jpem9udGFsID0gLXBhcnRpY2xlLnZlbG9jaXR5Lmhvcml6b250YWwgKyAocGFydGljbGUudmVsb2NpdHkudmVydGljYWwgLyAyKTtcbiAgICAgICAgcGFydGljbGUudmVsb2NpdHkudmVydGljYWwgPSAtcGFydGljbGUudmVsb2NpdHkudmVydGljYWwgKyAocGFydGljbGUudmVsb2NpdHkuaG9yaXpvbnRhbCAvIDIpO1xuICAgIH1cbn1cbiJdfQ==