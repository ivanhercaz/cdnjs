"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ShapeType_1=require("../Enums/ShapeType"),Updater_1=require("./Particle/Updater"),Utils_1=require("../Utils/Utils"),PolygonMaskType_1=require("../Enums/PolygonMaskType"),RotateDirection_1=require("../Enums/RotateDirection"),ColorUtils_1=require("../Utils/ColorUtils"),Particles_1=require("../Options/Classes/Particles/Particles"),SizeAnimationStatus_1=require("../Enums/SizeAnimationStatus"),OpacityAnimationStatus_1=require("../Enums/OpacityAnimationStatus"),Shape_1=require("../Options/Classes/Particles/Shape/Shape"),StartValueType_1=require("../Enums/StartValueType"),CanvasUtils_1=require("../Utils/CanvasUtils"),Particle=function(){function i(i,t,e){var s,o,a,n,r,l,h,c,p,u,d,v,y,m;this.container=i,this.fill=!0,this.close=!0,this.links=[],this.lastNoiseTime=0,this.destroyed=!1;var f=i.options,g=new Particles_1.Particles;if(g.load(f.particles),void 0!==(null==e?void 0:e.shape)){var U=null!==(s=e.shape.type)&&void 0!==s?s:g.shape.type;this.shape=U instanceof Array?Utils_1.Utils.itemFromArray(U):U;var _=new Shape_1.Shape;if(_.load(e.shape),void 0!==this.shape)void 0!==(S=_.options[this.shape])&&(this.shapeData=Utils_1.Utils.deepExtend({},S instanceof Array?Utils_1.Utils.itemFromArray(S):S),this.fill=null!==(a=null===(o=this.shapeData)||void 0===o?void 0:o.fill)&&void 0!==a?a:this.fill,this.close=null!==(r=null===(n=this.shapeData)||void 0===n?void 0:n.close)&&void 0!==r?r:this.close)}else{var S;U=g.shape.type;this.shape=U instanceof Array?Utils_1.Utils.itemFromArray(U):U,(S=g.shape.options[this.shape])&&(this.shapeData=Utils_1.Utils.deepExtend({},S instanceof Array?Utils_1.Utils.itemFromArray(S):S),this.fill=null!==(h=null===(l=this.shapeData)||void 0===l?void 0:l.fill)&&void 0!==h?h:this.fill,this.close=null!==(p=null===(c=this.shapeData)||void 0===c?void 0:c.close)&&void 0!==p?p:this.close)}void 0!==e&&g.load(e),this.particlesOptions=g;var z=this.particlesOptions.move.noise.delay;this.noiseDelay=1e3*(z.random.enable?Utils_1.Utils.randomInRange(z.random.minimumValue,z.value):z.value),i.retina.initParticle(this);var O=this.particlesOptions.color,T=null!==(u=this.sizeValue)&&void 0!==u?u:i.retina.sizeValue,w="boolean"==typeof this.particlesOptions.size.random?this.particlesOptions.size.random:this.particlesOptions.size.random.enable;if(this.size={value:w&&void 0!==this.randomMinimumSize?Utils_1.Utils.randomInRange(this.randomMinimumSize,T):T},this.direction=this.particlesOptions.move.direction,this.bubble={},this.angle=this.particlesOptions.rotate.random?360*Math.random():this.particlesOptions.rotate.value,this.particlesOptions.rotate.direction==RotateDirection_1.RotateDirection.random){var x=Math.floor(2*Math.random());this.rotateDirection=0<x?RotateDirection_1.RotateDirection.counterClockwise:RotateDirection_1.RotateDirection.clockwise}else this.rotateDirection=this.particlesOptions.rotate.direction;if(this.particlesOptions.size.animation.enable){switch(this.particlesOptions.size.animation.startValue){case StartValueType_1.StartValueType.min:if(!w){var C=i.retina.pixelRatio;this.size.value=this.particlesOptions.size.animation.minimumValue*C}}this.size.status=SizeAnimationStatus_1.SizeAnimationStatus.increasing,this.size.velocity=(null!==(d=this.sizeAnimationSpeed)&&void 0!==d?d:i.retina.sizeAnimationSpeed)/100,this.particlesOptions.size.animation.sync||(this.size.velocity=this.size.velocity*Math.random())}this.particlesOptions.rotate.animation.enable&&(this.particlesOptions.rotate.animation.sync||(this.angle=360*Math.random())),this.position=this.calcPosition(this.container,t),f.polygon.enable&&f.polygon.type===PolygonMaskType_1.PolygonMaskType.inline&&(this.initialPosition={x:this.position.x,y:this.position.y}),this.offset={x:0,y:0},this.particlesOptions.collisions.enable&&this.checkOverlap(t),O instanceof Array?this.color=ColorUtils_1.ColorUtils.colorToRgb(Utils_1.Utils.itemFromArray(O)):this.color=ColorUtils_1.ColorUtils.colorToRgb(O);var A=this.particlesOptions.opacity.random,P=this.particlesOptions.opacity.value;this.opacity={value:A.enable?Utils_1.Utils.randomInRange(A.minimumValue,P):P},this.particlesOptions.opacity.animation.enable&&(this.opacity.status=OpacityAnimationStatus_1.OpacityAnimationStatus.increasing,this.opacity.velocity=this.particlesOptions.opacity.animation.speed/100,this.particlesOptions.opacity.animation.sync||(this.opacity.velocity*=Math.random())),this.initialVelocity=this.calculateVelocity(),this.velocity={horizontal:this.initialVelocity.horizontal,vertical:this.initialVelocity.vertical};var M=i.drawers[this.shape];if(M||(M=CanvasUtils_1.CanvasUtils.getShapeDrawer(this.shape),i.drawers[this.shape]=M),this.shape===ShapeType_1.ShapeType.image||this.shape===ShapeType_1.ShapeType.images){var b=M,k=this.particlesOptions.shape.options[this.shape],D=b.getImages(i).images,R=D[x=Utils_1.Utils.arrayRandomIndex(D)],V=k instanceof Array?k.filter(function(i){return i.src===R.source})[0]:k;this.image={data:R,ratio:V.width/V.height,replaceColor:null!==(v=V.replaceColor)&&void 0!==v?v:V.replace_color,source:V.src},this.image.ratio||(this.image.ratio=1),this.fill=null!==(y=V.fill)&&void 0!==y?y:this.fill,this.close=null!==(m=V.close)&&void 0!==m?m:this.close}this.stroke=this.particlesOptions.stroke instanceof Array?Utils_1.Utils.itemFromArray(this.particlesOptions.stroke):this.particlesOptions.stroke,this.strokeColor="string"==typeof this.stroke.color?ColorUtils_1.ColorUtils.stringToRgb(this.stroke.color):ColorUtils_1.ColorUtils.colorToRgb(this.stroke.color),this.shadowColor="string"==typeof this.particlesOptions.shadow.color?ColorUtils_1.ColorUtils.stringToRgb(this.particlesOptions.shadow.color):ColorUtils_1.ColorUtils.colorToRgb(this.particlesOptions.shadow.color),this.updater=new Updater_1.Updater(this.container,this)}return i.prototype.update=function(i,t){this.links=[],this.updater.update(t)},i.prototype.draw=function(){this.container.canvas.drawParticle(this)},i.prototype.isOverlapping=function(){for(var i=this.container,t=this,e=!1,s=0,o=0,a=i.particles.array.filter(function(i){return i!=t});o<a.length;o++){var n=a[o];s++;var r={x:t.position.x+t.offset.x,y:t.position.y+t.offset.y},l={x:n.position.x+n.offset.x,y:n.position.y+n.offset.y};if(Utils_1.Utils.getDistanceBetweenCoordinates(r,l)<=t.size.value+n.size.value){e=!0;break}}return{collisionFound:e,iterations:s}},i.prototype.checkOverlap=function(i){var t=this.container,e=this.isOverlapping();e.iterations>=t.particles.count?t.particles.remove(this):e.collisionFound&&(this.position.x=i?i.x:Math.random()*t.canvas.size.width,this.position.y=i?i.y:Math.random()*t.canvas.size.height,this.checkOverlap())},i.prototype.startInfection=function(i){var t=this,e=this.container.options,s=e.infection.stages;if(!(s.length<i||i<0)){var o=e.infection,a=s[i];this.infectionTimeout=window.setTimeout(function(){t.infectionStage=i,void 0!==a.duration&&0<=a.duration&&(t.infectionTimeout=window.setTimeout(function(){t.nextInfectionStage()},1e3*a.duration))},1e3*o.delay)}},i.prototype.updateInfection=function(i){var t=this,e=this.container.options;if(!(e.infection.stages.length<i||i<0||void 0!==this.infectionStage&&this.infectionStage>i)){void 0!==this.infectionTimeout&&window.clearTimeout(this.infectionTimeout),this.infectionStage=i;var s=e.infection.stages[this.infectionStage];void 0!==s.duration&&0<=s.duration&&(this.infectionTimeout=window.setTimeout(function(){t.nextInfectionStage()},1e3*s.duration))}},i.prototype.nextInfectionStage=function(){var i=this,t=this.container.options,e=t.infection.stages.length;if(!(e<=0||void 0===this.infectionStage)){if(e<=++this.infectionStage){if(t.infection.cure)return void delete this.infectionStage;this.infectionStage=0}var s=t.infection.stages[this.infectionStage];void 0!==s.duration&&0<=s.duration&&(this.infectionTimeout=window.setTimeout(function(){i.nextInfectionStage()},1e3*s.duration))}},i.prototype.destroy=function(){this.destroyed=!0},i.prototype.calcPosition=function(i,t){for(var e=0,s=i.plugins;e<s.length;e++){var o=s[e],a=void 0!==o.particlePosition?o.particlePosition(t):void 0;if(void 0!==a)return a}var n={x:0,y:0};return n.x=t?t.x:Math.random()*i.canvas.size.width,n.y=t?t.y:Math.random()*i.canvas.size.height,n.x>i.canvas.size.width-2*this.size.value?n.x-=this.size.value:n.x<2*this.size.value&&(n.x+=this.size.value),n.y>i.canvas.size.height-2*this.size.value?n.y-=this.size.value:n.y<2*this.size.value&&(n.y+=this.size.value),n},i.prototype.calculateVelocity=function(){var i=Utils_1.Utils.getParticleBaseVelocity(this),t={horizontal:0,vertical:0};return this.particlesOptions.move.straight?(t.horizontal=i.x,t.vertical=i.y,this.particlesOptions.move.random&&(t.horizontal*=Math.random(),t.vertical*=Math.random())):(t.horizontal=i.x+Math.random()-.5,t.vertical=i.y+Math.random()-.5),t},i}();exports.Particle=Particle;