var __awaiter=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(a,r){function n(e){try{h(s.next(e))}catch(e){r(e)}}function o(e){try{h(s.throw(e))}catch(e){r(e)}}function h(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}h((s=s.apply(e,t||[])).next())})};import{Canvas}from"./Canvas";import{EventListeners}from"./Utils/EventListeners";import{Particles}from"./Particles";import{Retina}from"./Retina";import{ShapeType}from"../Enums/ShapeType";import{PolygonMask}from"./PolygonMask";import{FrameManager}from"./FrameManager";import{Options}from"./Options/Options";import{Utils}from"./Utils/Utils";import{Presets}from"./Utils/Presets";window.customRequestAnimationFrame=(()=>window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||(e=>window.setTimeout(e,1e3/60)))(),window.customCancelRequestAnimationFrame=(()=>window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout)();export class Container{constructor(e,t,...i){this.started=!1,this.destroyed=!1,this.id=e,this.paused=!0,this.sourceOptions=t,this.lastFrameTime=0,this.pageHidden=!1,this.retina=new Retina(this),this.canvas=new Canvas(this),this.particles=new Particles(this),this.polygon=new PolygonMask(this),this.drawer=new FrameManager(this),this.interactivity={mouse:{}},this.images=[],this.bubble={},this.repulse={},this.options=new Options;for(const e of i)this.options.load(Presets.getPreset(e));this.sourceOptions&&this.options.load(this.sourceOptions),this.eventListeners=new EventListeners(this)}static requestFrame(e){return window.customRequestAnimationFrame(e)}static cancelAnimation(e){window.cancelAnimationFrame(e)}play(){this.paused&&(this.lastFrameTime=performance.now(),this.paused=!1),this.drawAnimationFrame=Container.requestFrame(e=>this.drawer.nextFrame(e))}pause(){void 0!==this.drawAnimationFrame&&(Container.cancelAnimation(this.drawAnimationFrame),delete this.drawAnimationFrame,this.paused=!0)}densityAutoParticles(){if(!this.canvas.element||!this.options.particles.number.density.enable)return;let e=this.canvas.element.width*this.canvas.element.height/1e3;this.retina.isRetina&&(e/=2*this.retina.pxRatio);const t=e*this.options.particles.number.value/this.options.particles.number.density.area,i=this.particles.count;i<t?this.particles.push(Math.abs(t-i)):i>t&&this.particles.removeQuantity(i-t)}destroy(){this.stop(),this.retina.reset(),this.canvas.destroy(),delete this.interactivity,delete this.options,delete this.retina,delete this.canvas,delete this.particles,delete this.polygon,delete this.bubble,delete this.repulse,delete this.images,delete this.drawer,delete this.eventListeners,this.destroyed=!0}exportImg(e){this.exportImage(e)}exportImage(e,t,i){var s;return null===(s=this.canvas.element)||void 0===s?void 0:s.toBlob(e,null!=t?t:"image/png",i)}exportConfiguration(){return JSON.stringify(this.options,void 0,2)}loadImage(e,t){return new Promise((i,s)=>{if(e.error=!1,t.src){const a=new Image;a.addEventListener("load",()=>{e.obj=a,i()}),a.addEventListener("error",()=>{e.error=!0,s(`Error tsParticles - loading image: ${t.src}`)}),a.src=t.src}else e.error=!0,s("Error tsParticles - No image.src")})}refresh(){return __awaiter(this,void 0,void 0,function*(){this.stop(),yield this.start()})}stop(){this.started&&(this.started=!1,this.eventListeners.removeListeners(),this.pause(),this.images=[],this.particles.clear(),this.retina.reset(),this.canvas.clear(),this.polygon.reset(),delete this.particles.lineLinkedColor)}start(){return __awaiter(this,void 0,void 0,function*(){if(!this.started){if(this.started=!0,this.eventListeners.addListeners(),yield this.polygon.init(),Utils.isInArray(ShapeType.char,this.options.particles.shape.type)||Utils.isInArray(ShapeType.character,this.options.particles.shape.type))if(this.options.particles.shape.character instanceof Array)for(const e of this.options.particles.shape.character)yield Utils.loadFont(e);else{const e=this.options.particles.shape.character;yield Utils.loadFont(e)}if(Utils.isInArray(ShapeType.image,this.options.particles.shape.type))if(this.options.particles.shape.image instanceof Array)for(const e of this.options.particles.shape.image)yield this.loadImageShape(e);else yield this.loadImageShape(this.options.particles.shape.image);this.checkBeforeDraw()}})}loadImageShape(e){return __awaiter(this,void 0,void 0,function*(){const t=e.src,i={error:!1};i.type=t.substr(t.length-3),yield this.loadImage(i,e),this.images.push(i)})}init(){this.retina.init(),this.canvas.init(),this.particles.init(),this.densityAutoParticles()}checkBeforeDraw(){this.options.particles.shape.type===ShapeType.image&&this.images.every(e=>e.error)||(this.init(),this.play())}};