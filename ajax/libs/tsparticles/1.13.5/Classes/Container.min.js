"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),Canvas_1=require("./Canvas"),EventListeners_1=require("./Utils/EventListeners"),Particles_1=require("./Particles"),Retina_1=require("./Retina"),ShapeType_1=require("../Enums/ShapeType"),PolygonMask_1=require("./PolygonMask"),FrameManager_1=require("./FrameManager"),Options_1=require("./Options/Options"),Utils_1=require("./Utils/Utils"),Presets_1=require("./Utils/Presets"),Emitter_1=require("./Emitter"),Absorber_1=require("./Absorber"),Container=function(){function i(t,e){for(var s=[],i=2;i<arguments.length;i++)s[i-2]=arguments[i];this.started=!1,this.destroyed=!1,this.id=t,this.paused=!0,this.sourceOptions=e,this.lastFrameTime=0,this.pageHidden=!1,this.retina=new Retina_1.Retina(this),this.canvas=new Canvas_1.Canvas(this),this.particles=new Particles_1.Particles(this),this.polygon=new PolygonMask_1.PolygonMask(this),this.drawer=new FrameManager_1.FrameManager(this),this.interactivity={mouse:{}},this.images=[],this.bubble={},this.repulse={particles:[]},this.emitters=[],this.absorbers=[],this.options=new Options_1.Options;for(var r=0,a=s;r<a.length;r++){var n=a[r];this.options.load(Presets_1.Presets.getPreset(n))}this.sourceOptions&&this.options.load(this.sourceOptions),this.eventListeners=new EventListeners_1.EventListeners(this)}return i.requestFrame=function(t){return window.customRequestAnimationFrame(t)},i.cancelAnimation=function(t){window.cancelAnimationFrame(t)},i.prototype.play=function(){var e=this;if(this.paused){this.lastFrameTime=performance.now(),this.paused=!1;for(var t=0,s=this.emitters;t<s.length;t++){s[t].start()}}this.drawAnimationFrame=i.requestFrame(function(t){return e.drawer.nextFrame(t)})},i.prototype.pause=function(){if(void 0!==this.drawAnimationFrame){for(var t=0,e=this.emitters;t<e.length;t++){e[t].stop()}i.cancelAnimation(this.drawAnimationFrame),delete this.drawAnimationFrame,this.paused=!0}},i.prototype.densityAutoParticles=function(){if(this.canvas.element&&this.options.particles.number.density.enable){var t=this.canvas.element.width*this.canvas.element.height/1e3;this.retina.isRetina&&(t/=2*this.retina.pixelRatio);var e=t*this.options.particles.number.value/this.options.particles.number.density.area,s=this.particles.count;s<e?this.particles.push(Math.abs(e-s)):e<s&&this.particles.removeQuantity(s-e)}},i.prototype.destroy=function(){this.stop(),this.retina.reset(),this.canvas.destroy(),delete this.interactivity,delete this.options,delete this.retina,delete this.canvas,delete this.particles,delete this.polygon,delete this.bubble,delete this.repulse,delete this.images,delete this.drawer,delete this.eventListeners,this.destroyed=!0},i.prototype.exportImg=function(t){this.exportImage(t)},i.prototype.exportImage=function(t,e,s){var i;return null===(i=this.canvas.element)||void 0===i?void 0:i.toBlob(t,null!=e?e:"image/png",s)},i.prototype.exportConfiguration=function(){return JSON.stringify(this.options,void 0,2)},i.prototype.refresh=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(t){switch(t.label){case 0:return this.stop(),[4,this.start()];case 1:return t.sent(),[2]}})})},i.prototype.stop=function(){this.started&&(this.started=!1,this.eventListeners.removeListeners(),this.pause(),this.images=[],this.particles.clear(),this.retina.reset(),this.canvas.clear(),this.polygon.reset(),this.emitters=[],this.absorbers=[],delete this.particles.lineLinkedColor)},i.prototype.start=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var e,s,i,r,a,n;return tslib_1.__generator(this,function(t){switch(t.label){case 0:return this.started?[2]:(this.started=!0,this.eventListeners.addListeners(),[4,this.polygon.init()]);case 1:if(t.sent(),!Utils_1.Utils.isInArray(ShapeType_1.ShapeType.char,this.options.particles.shape.type)&&!Utils_1.Utils.isInArray(ShapeType_1.ShapeType.character,this.options.particles.shape.type))return[3,8];if(!(this.options.particles.shape.character instanceof Array))return[3,6];e=0,s=this.options.particles.shape.character,t.label=2;case 2:return e<s.length?(i=s[e],[4,Utils_1.Utils.loadFont(i)]):[3,5];case 3:t.sent(),t.label=4;case 4:return e++,[3,2];case 5:return[3,8];case 6:return void 0===(i=this.options.particles.shape.character)?[3,8]:[4,Utils_1.Utils.loadFont(i)];case 7:t.sent(),t.label=8;case 8:if(!Utils_1.Utils.isInArray(ShapeType_1.ShapeType.image,this.options.particles.shape.type)&&!Utils_1.Utils.isInArray(ShapeType_1.ShapeType.images,this.options.particles.shape.type))return[3,15];if(!(this.options.particles.shape.image instanceof Array))return[3,13];r=0,a=this.options.particles.shape.image,t.label=9;case 9:return r<a.length?(n=a[r],[4,this.loadImageShape(n)]):[3,12];case 10:t.sent(),t.label=11;case 11:return r++,[3,9];case 12:return[3,15];case 13:return[4,this.loadImageShape(this.options.particles.shape.image)];case 14:t.sent(),t.label=15;case 15:return this.init(),this.play(),[2]}})})},i.prototype.loadImageShape=function(i){return tslib_1.__awaiter(this,void 0,void 0,function(){var e,s;return tslib_1.__generator(this,function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),s=(e=this.images).push,[4,Utils_1.Utils.loadImage(i)];case 1:return s.apply(e,[t.sent()]),[3,3];case 2:return t.sent(),[3,3];case 3:return[2]}})})},i.prototype.init=function(){if(this.retina.init(),this.canvas.init(),this.particles.init(),this.options.emitters instanceof Array)for(var t=0,e=this.options.emitters;t<e.length;t++){var s=e[t],i=new Emitter_1.Emitter(this,s);this.emitters.push(i)}else{s=this.options.emitters,i=new Emitter_1.Emitter(this,s);this.emitters.push(i)}if(this.options.absorbers instanceof Array)for(var r=0,a=this.options.absorbers;r<a.length;r++){var n=a[r],o=new Absorber_1.Absorber(this,n);this.absorbers.push(o)}else{n=this.options.absorbers,o=new Absorber_1.Absorber(this,n);this.absorbers.push(o)}this.densityAutoParticles()},i}();exports.Container=Container;