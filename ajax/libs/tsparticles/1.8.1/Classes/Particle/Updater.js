"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Updater = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _OutMode = require("../../Enums/OutMode");

var _Utils = require("../Utils/Utils");

var _ClickMode = require("../../Enums/Modes/ClickMode");

var _PolygonMaskType = require("../../Enums/PolygonMaskType");

var _Mover = require("./Mover");

/**
 * Particle updater, it manages movement
 */
var Updater = /*#__PURE__*/function () {
  function Updater(container, particle) {
    (0, _classCallCheck2["default"])(this, Updater);
    this.particle = void 0;
    this.container = void 0;
    this.mover = void 0;
    this.container = container;
    this.particle = particle;
    this.mover = new _Mover.Mover(container, particle);
  }

  (0, _createClass2["default"])(Updater, [{
    key: "update",
    value: function update(delta) {
      /* move the particle */
      this.mover.move(delta);
      /* change opacity status */

      this.updateOpacity();
      /* change size */

      this.updateSize();
      /* change particle position if it is out of canvas */

      this.fixOutOfCanvasPosition();
      /* out of canvas modes */

      this.updateOutMode();
    }
  }, {
    key: "updateOpacity",
    value: function updateOpacity() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;

      if (options.particles.opacity.animation.enable) {
        if (particle.opacity.status) {
          if (particle.opacity.value >= options.particles.opacity.value) {
            particle.opacity.status = false;
          }

          particle.opacity.value += particle.opacity.velocity || 0;
        } else {
          if (particle.opacity.value <= options.particles.opacity.animation.minimumValue) {
            particle.opacity.status = true;
          }

          particle.opacity.value -= particle.opacity.velocity || 0;
        }

        if (particle.opacity.value < 0) {
          particle.opacity.value = 0;
        }
      }
    }
  }, {
    key: "updateSize",
    value: function updateSize() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;

      if (options.particles.size.animation.enable) {
        if (particle.size.status) {
          if (particle.radius >= container.retina.sizeValue) {
            particle.size.status = false;
          }

          particle.radius += particle.size.velocity || 0;
        } else {
          if (particle.radius <= options.particles.size.animation.minimumValue) {
            particle.size.status = true;
          }

          particle.radius -= particle.size.velocity || 0;
        }

        if (particle.radius < 0) {
          particle.radius = 0;
        }
      }
    }
  }, {
    key: "fixOutOfCanvasPosition",
    value: function fixOutOfCanvasPosition() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;
      var outMode = options.particles.move.outMode;
      var newPos;

      if (outMode === _OutMode.OutMode.bounce) {
        newPos = {
          x_left: particle.radius,
          x_right: container.canvas.dimension.width,
          y_bottom: container.canvas.dimension.height,
          y_top: particle.radius
        };
      } else if (outMode === _OutMode.OutMode.bounceHorizontal) {
        newPos = {
          x_left: particle.radius,
          x_right: container.canvas.dimension.width,
          y_bottom: container.canvas.dimension.height + particle.radius - particle.offset.y,
          y_top: -particle.radius - particle.offset.y
        };
      } else if (outMode === _OutMode.OutMode.bounceVertical) {
        newPos = {
          x_left: -particle.radius - particle.offset.x,
          x_right: container.canvas.dimension.width + particle.radius + particle.offset.x,
          y_bottom: container.canvas.dimension.height,
          y_top: particle.radius
        };
      } else {
        newPos = {
          x_left: -particle.radius - particle.offset.x,
          x_right: container.canvas.dimension.width + particle.radius + particle.offset.x,
          y_bottom: container.canvas.dimension.height + particle.radius - particle.offset.y,
          y_top: -particle.radius - particle.offset.y
        };
      }

      if (outMode === _OutMode.OutMode.destroy) {
        if (particle.position.x + particle.radius < 0 || particle.position.y + particle.radius < 0 || particle.position.x - particle.radius > container.canvas.dimension.width || particle.position.y - particle.radius > container.canvas.dimension.height) {
          var idx = container.particles.array.indexOf(particle);
          container.particles.array.splice(idx, 1);
          /* remove the canvas if the array is empty */

          var clickMode = options.interactivity.events.onClick.mode;

          if (!container.particles.array.length && !_Utils.Utils.isInArray(_ClickMode.ClickMode.push, clickMode)) {
            container.destroy();
          }
        }
      } else {
        var nextPos = {
          x_left: particle.position.x - particle.radius,
          x_right: particle.position.x + particle.radius,
          y_bottom: particle.position.y + particle.radius,
          y_top: particle.position.y - particle.radius
        };
        var dimension = container.canvas.dimension;

        if (nextPos.x_left > dimension.width - particle.offset.x) {
          particle.position.x = newPos.x_left;
          particle.position.y = Math.random() * dimension.height;
        } else if (nextPos.x_right < -particle.offset.x) {
          particle.position.x = newPos.x_right;
          particle.position.y = Math.random() * dimension.height;
        }

        if (nextPos.y_top > container.canvas.dimension.height - particle.offset.y) {
          particle.position.y = newPos.y_top;
          particle.position.x = Math.random() * container.canvas.dimension.width;
        } else if (nextPos.y_bottom < -particle.offset.y) {
          particle.position.y = newPos.y_bottom;
          particle.position.x = Math.random() * container.canvas.dimension.width;
        }
      }
    }
  }, {
    key: "updateOutMode",
    value: function updateOutMode() {
      var container = this.container;
      var options = container.options;

      switch (options.particles.move.outMode) {
        case _OutMode.OutMode.bounce:
        case _OutMode.OutMode.bounceVertical:
        case _OutMode.OutMode.bounceHorizontal:
          this.updateBounce();
          break;
      }
    }
  }, {
    key: "updateBounce",
    value: function updateBounce() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;
      /* check bounce against polygon boundaries */

      if (options.polygon.type !== _PolygonMaskType.PolygonMaskType.none && options.polygon.type !== _PolygonMaskType.PolygonMaskType.inline) {
        if (!container.polygon.checkInsidePolygon(particle.position)) {
          this.polygonBounce();
        }
      } else if (options.polygon.type === _PolygonMaskType.PolygonMaskType.inline) {
        if (!particle.initialPosition) {
          particle.initialPosition = {
            x: 0,
            y: 0
          };
        }

        var dist = _Utils.Utils.getDistanceBetweenCoordinates(particle.initialPosition, particle.position);

        if (dist > container.retina.polygonMaskMoveRadius) {
          this.polygonBounce();
        }
      } else {
        var outMode = options.particles.move.outMode;
        var x = particle.position.x + particle.offset.x;
        var y = particle.position.y + particle.offset.y;

        if (outMode === _OutMode.OutMode.bounce || outMode === _OutMode.OutMode.bounceHorizontal) {
          Updater.checkBounds(x, particle.radius, container.canvas.dimension.width, function () {
            particle.velocity.horizontal = -particle.velocity.horizontal;
          });
        }

        if (outMode === _OutMode.OutMode.bounce || outMode === _OutMode.OutMode.bounceVertical) {
          Updater.checkBounds(y, particle.radius, container.canvas.dimension.height, function () {
            particle.velocity.vertical = -particle.velocity.vertical;
          });
        }
      }
    }
  }, {
    key: "polygonBounce",
    value: function polygonBounce() {
      var particle = this.particle;
      particle.velocity.horizontal = -particle.velocity.horizontal + particle.velocity.vertical / 2;
      particle.velocity.vertical = -particle.velocity.vertical + particle.velocity.horizontal / 2;
    }
  }], [{
    key: "checkBounds",
    value: function checkBounds(coordinate, radius, size, outside) {
      if (coordinate + radius > size || coordinate - radius < 0) {
        outside();
      }
    }
  }]);
  return Updater;
}();

exports.Updater = Updater;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9DbGFzc2VzL1BhcnRpY2xlL1VwZGF0ZXIudHMiXSwibmFtZXMiOlsiVXBkYXRlciIsImNvbnRhaW5lciIsInBhcnRpY2xlIiwibW92ZXIiLCJNb3ZlciIsImRlbHRhIiwibW92ZSIsInVwZGF0ZU9wYWNpdHkiLCJ1cGRhdGVTaXplIiwiZml4T3V0T2ZDYW52YXNQb3NpdGlvbiIsInVwZGF0ZU91dE1vZGUiLCJvcHRpb25zIiwicGFydGljbGVzIiwib3BhY2l0eSIsImFuaW1hdGlvbiIsImVuYWJsZSIsInN0YXR1cyIsInZhbHVlIiwidmVsb2NpdHkiLCJtaW5pbXVtVmFsdWUiLCJzaXplIiwicmFkaXVzIiwicmV0aW5hIiwic2l6ZVZhbHVlIiwib3V0TW9kZSIsIm5ld1BvcyIsIk91dE1vZGUiLCJib3VuY2UiLCJ4X2xlZnQiLCJ4X3JpZ2h0IiwiY2FudmFzIiwiZGltZW5zaW9uIiwid2lkdGgiLCJ5X2JvdHRvbSIsImhlaWdodCIsInlfdG9wIiwiYm91bmNlSG9yaXpvbnRhbCIsIm9mZnNldCIsInkiLCJib3VuY2VWZXJ0aWNhbCIsIngiLCJkZXN0cm95IiwicG9zaXRpb24iLCJpZHgiLCJhcnJheSIsImluZGV4T2YiLCJzcGxpY2UiLCJjbGlja01vZGUiLCJpbnRlcmFjdGl2aXR5IiwiZXZlbnRzIiwib25DbGljayIsIm1vZGUiLCJsZW5ndGgiLCJVdGlscyIsImlzSW5BcnJheSIsIkNsaWNrTW9kZSIsInB1c2giLCJuZXh0UG9zIiwiTWF0aCIsInJhbmRvbSIsInVwZGF0ZUJvdW5jZSIsInBvbHlnb24iLCJ0eXBlIiwiUG9seWdvbk1hc2tUeXBlIiwibm9uZSIsImlubGluZSIsImNoZWNrSW5zaWRlUG9seWdvbiIsInBvbHlnb25Cb3VuY2UiLCJpbml0aWFsUG9zaXRpb24iLCJkaXN0IiwiZ2V0RGlzdGFuY2VCZXR3ZWVuQ29vcmRpbmF0ZXMiLCJwb2x5Z29uTWFza01vdmVSYWRpdXMiLCJjaGVja0JvdW5kcyIsImhvcml6b250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bkUsRUFBMkUsWUFBTTtBQUM3RWhDLFlBQUFBLFFBQVEsQ0FBQ2dCLFFBQVQsQ0FBa0J3RCxRQUFsQixHQUE2QixDQUFDeEUsUUFBUSxDQUFDZ0IsUUFBVCxDQUFrQndELFFBQWhEO0FBQ0gsV0FGRDtBQUdIO0FBQ0o7QUFDSjs7O29DQUU2QjtBQUMxQixVQUFNeEUsUUFBUSxHQUFHLEtBQUtBLFFBQXRCO0FBRUFBLE1BQUFBLFFBQVEsQ0FBQ2dCLFFBQVQsQ0FBa0J1RCxVQUFsQixHQUErQixDQUFDdkUsUUFBUSxDQUFDZ0IsUUFBVCxDQUFrQnVELFVBQW5CLEdBQWlDdkUsUUFBUSxDQUFDZ0IsUUFBVCxDQUFrQndELFFBQWxCLEdBQTZCLENBQTdGO0FBQ0F4RSxNQUFBQSxRQUFRLENBQUNnQixRQUFULENBQWtCd0QsUUFBbEIsR0FBNkIsQ0FBQ3hFLFFBQVEsQ0FBQ2dCLFFBQVQsQ0FBa0J3RCxRQUFuQixHQUErQnhFLFFBQVEsQ0FBQ2dCLFFBQVQsQ0FBa0J1RCxVQUFsQixHQUErQixDQUEzRjtBQUNIOzs7Z0NBbk4wQkUsVSxFQUFvQnRELE0sRUFBZ0JELEksRUFBY3dELE8sRUFBMkI7QUFDcEcsVUFBS0QsVUFBVSxHQUFHdEQsTUFBYixHQUFzQkQsSUFBdkIsSUFBaUN1RCxVQUFVLEdBQUd0RCxNQUFiLEdBQXNCLENBQTNELEVBQStEO0FBQzNEdUQsUUFBQUEsT0FBTztBQUNWO0FBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IHtDb250YWluZXJ9IGZyb20gXCIuLi9Db250YWluZXJcIjtcbmltcG9ydCB7T3V0TW9kZX0gZnJvbSBcIi4uLy4uL0VudW1zL091dE1vZGVcIjtcbmltcG9ydCB7UGFydGljbGV9IGZyb20gXCIuLi9QYXJ0aWNsZVwiO1xuaW1wb3J0IHtVdGlsc30gZnJvbSBcIi4uL1V0aWxzL1V0aWxzXCI7XG5pbXBvcnQge0NsaWNrTW9kZX0gZnJvbSBcIi4uLy4uL0VudW1zL01vZGVzL0NsaWNrTW9kZVwiO1xuaW1wb3J0IHtQb2x5Z29uTWFza1R5cGV9IGZyb20gXCIuLi8uLi9FbnVtcy9Qb2x5Z29uTWFza1R5cGVcIjtcbmltcG9ydCB7TW92ZXJ9IGZyb20gXCIuL01vdmVyXCI7XG5cbi8qKlxuICogUGFydGljbGUgdXBkYXRlciwgaXQgbWFuYWdlcyBtb3ZlbWVudFxuICovXG5leHBvcnQgY2xhc3MgVXBkYXRlciB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBwYXJ0aWNsZTogUGFydGljbGU7XG4gICAgcHJpdmF0ZSByZWFkb25seSBjb250YWluZXI6IENvbnRhaW5lcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IG1vdmVyOiBNb3ZlcjtcblxuICAgIGNvbnN0cnVjdG9yKGNvbnRhaW5lcjogQ29udGFpbmVyLCBwYXJ0aWNsZTogUGFydGljbGUpIHtcbiAgICAgICAgdGhpcy5jb250YWluZXIgPSBjb250YWluZXI7XG4gICAgICAgIHRoaXMucGFydGljbGUgPSBwYXJ0aWNsZTtcbiAgICAgICAgdGhpcy5tb3ZlciA9IG5ldyBNb3Zlcihjb250YWluZXIsIHBhcnRpY2xlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBjaGVja0JvdW5kcyhjb29yZGluYXRlOiBudW1iZXIsIHJhZGl1czogbnVtYmVyLCBzaXplOiBudW1iZXIsIG91dHNpZGU6ICgpID0+IHZvaWQpOiB2b2lkIHtcbiAgICAgICAgaWYgKChjb29yZGluYXRlICsgcmFkaXVzID4gc2l6ZSkgfHwgKGNvb3JkaW5hdGUgLSByYWRpdXMgPCAwKSkge1xuICAgICAgICAgICAgb3V0c2lkZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHVwZGF0ZShkZWx0YTogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIC8qIG1vdmUgdGhlIHBhcnRpY2xlICovXG4gICAgICAgIHRoaXMubW92ZXIubW92ZShkZWx0YSk7XG5cbiAgICAgICAgLyogY2hhbmdlIG9wYWNpdHkgc3RhdHVzICovXG4gICAgICAgIHRoaXMudXBkYXRlT3BhY2l0eSgpO1xuXG4gICAgICAgIC8qIGNoYW5nZSBzaXplICovXG4gICAgICAgIHRoaXMudXBkYXRlU2l6ZSgpO1xuXG4gICAgICAgIC8qIGNoYW5nZSBwYXJ0aWNsZSBwb3NpdGlvbiBpZiBpdCBpcyBvdXQgb2YgY2FudmFzICovXG4gICAgICAgIHRoaXMuZml4T3V0T2ZDYW52YXNQb3NpdGlvbigpO1xuXG4gICAgICAgIC8qIG91dCBvZiBjYW52YXMgbW9kZXMgKi9cbiAgICAgICAgdGhpcy51cGRhdGVPdXRNb2RlKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVPcGFjaXR5KCk6IHZvaWQge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcjtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGNvbnRhaW5lci5vcHRpb25zO1xuICAgICAgICBjb25zdCBwYXJ0aWNsZSA9IHRoaXMucGFydGljbGU7XG5cbiAgICAgICAgaWYgKG9wdGlvbnMucGFydGljbGVzLm9wYWNpdHkuYW5pbWF0aW9uLmVuYWJsZSkge1xuICAgICAgICAgICAgaWYgKHBhcnRpY2xlLm9wYWNpdHkuc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBhcnRpY2xlLm9wYWNpdHkudmFsdWUgPj0gb3B0aW9ucy5wYXJ0aWNsZXMub3BhY2l0eS52YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICBwYXJ0aWNsZS5vcGFjaXR5LnN0YXR1cyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHBhcnRpY2xlLm9wYWNpdHkudmFsdWUgKz0gKHBhcnRpY2xlLm9wYWNpdHkudmVsb2NpdHkgfHwgMCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChwYXJ0aWNsZS5vcGFjaXR5LnZhbHVlIDw9IG9wdGlvbnMucGFydGljbGVzLm9wYWNpdHkuYW5pbWF0aW9uLm1pbmltdW1WYWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICBwYXJ0aWNsZS5vcGFjaXR5LnN0YXR1cyA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcGFydGljbGUub3BhY2l0eS52YWx1ZSAtPSAocGFydGljbGUub3BhY2l0eS52ZWxvY2l0eSB8fCAwKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHBhcnRpY2xlLm9wYWNpdHkudmFsdWUgPCAwKSB7XG4gICAgICAgICAgICAgICAgcGFydGljbGUub3BhY2l0eS52YWx1ZSA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHVwZGF0ZVNpemUoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyO1xuICAgICAgICBjb25zdCBvcHRpb25zID0gY29udGFpbmVyLm9wdGlvbnM7XG4gICAgICAgIGNvbnN0IHBhcnRpY2xlID0gdGhpcy5wYXJ0aWNsZTtcblxuICAgICAgICBpZiAob3B0aW9ucy5wYXJ0aWNsZXMuc2l6ZS5hbmltYXRpb24uZW5hYmxlKSB7XG4gICAgICAgICAgICBpZiAocGFydGljbGUuc2l6ZS5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgICBpZiAocGFydGljbGUucmFkaXVzID49IGNvbnRhaW5lci5yZXRpbmEuc2l6ZVZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcnRpY2xlLnNpemUuc3RhdHVzID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcGFydGljbGUucmFkaXVzICs9IChwYXJ0aWNsZS5zaXplLnZlbG9jaXR5IHx8IDApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAocGFydGljbGUucmFkaXVzIDw9IG9wdGlvbnMucGFydGljbGVzLnNpemUuYW5pbWF0aW9uLm1pbmltdW1WYWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICBwYXJ0aWNsZS5zaXplLnN0YXR1cyA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcGFydGljbGUucmFkaXVzIC09IChwYXJ0aWNsZS5zaXplLnZlbG9jaXR5IHx8IDApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocGFydGljbGUucmFkaXVzIDwgMCkge1xuICAgICAgICAgICAgICAgIHBhcnRpY2xlLnJhZGl1cyA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGZpeE91dE9mQ2FudmFzUG9zaXRpb24oKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyO1xuICAgICAgICBjb25zdCBvcHRpb25zID0gY29udGFpbmVyLm9wdGlvbnM7XG4gICAgICAgIGNvbnN0IHBhcnRpY2xlID0gdGhpcy5wYXJ0aWNsZTtcbiAgICAgICAgY29uc3Qgb3V0TW9kZSA9IG9wdGlvbnMucGFydGljbGVzLm1vdmUub3V0TW9kZTtcblxuICAgICAgICBsZXQgbmV3UG9zO1xuXG4gICAgICAgIGlmIChvdXRNb2RlID09PSBPdXRNb2RlLmJvdW5jZSkge1xuICAgICAgICAgICAgbmV3UG9zID0ge1xuICAgICAgICAgICAgICAgIHhfbGVmdDogcGFydGljbGUucmFkaXVzLFxuICAgICAgICAgICAgICAgIHhfcmlnaHQ6IGNvbnRhaW5lci5jYW52YXMuZGltZW5zaW9uLndpZHRoLFxuICAgICAgICAgICAgICAgIHlfYm90dG9tOiBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi5oZWlnaHQsXG4gICAgICAgICAgICAgICAgeV90b3A6IHBhcnRpY2xlLnJhZGl1cyxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSBpZiAob3V0TW9kZSA9PT0gT3V0TW9kZS5ib3VuY2VIb3Jpem9udGFsKSB7XG4gICAgICAgICAgICBuZXdQb3MgPSB7XG4gICAgICAgICAgICAgICAgeF9sZWZ0OiBwYXJ0aWNsZS5yYWRpdXMsXG4gICAgICAgICAgICAgICAgeF9yaWdodDogY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24ud2lkdGgsXG4gICAgICAgICAgICAgICAgeV9ib3R0b206IGNvbnRhaW5lci5jYW52YXMuZGltZW5zaW9uLmhlaWdodCArIHBhcnRpY2xlLnJhZGl1cyAtIHBhcnRpY2xlLm9mZnNldC55LFxuICAgICAgICAgICAgICAgIHlfdG9wOiAtcGFydGljbGUucmFkaXVzIC0gcGFydGljbGUub2Zmc2V0LnksXG4gICAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2UgaWYgKG91dE1vZGUgPT09IE91dE1vZGUuYm91bmNlVmVydGljYWwpIHtcbiAgICAgICAgICAgIG5ld1BvcyA9IHtcbiAgICAgICAgICAgICAgICB4X2xlZnQ6IC1wYXJ0aWNsZS5yYWRpdXMgLSBwYXJ0aWNsZS5vZmZzZXQueCxcbiAgICAgICAgICAgICAgICB4X3JpZ2h0OiBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi53aWR0aCArIHBhcnRpY2xlLnJhZGl1cyArIHBhcnRpY2xlLm9mZnNldC54LFxuICAgICAgICAgICAgICAgIHlfYm90dG9tOiBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi5oZWlnaHQsXG4gICAgICAgICAgICAgICAgeV90b3A6IHBhcnRpY2xlLnJhZGl1cyxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBuZXdQb3MgPSB7XG4gICAgICAgICAgICAgICAgeF9sZWZ0OiAtcGFydGljbGUucmFkaXVzIC0gcGFydGljbGUub2Zmc2V0LngsXG4gICAgICAgICAgICAgICAgeF9yaWdodDogY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24ud2lkdGggKyBwYXJ0aWNsZS5yYWRpdXMgKyBwYXJ0aWNsZS5vZmZzZXQueCxcbiAgICAgICAgICAgICAgICB5X2JvdHRvbTogY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24uaGVpZ2h0ICsgcGFydGljbGUucmFkaXVzIC0gcGFydGljbGUub2Zmc2V0LnksXG4gICAgICAgICAgICAgICAgeV90b3A6IC1wYXJ0aWNsZS5yYWRpdXMgLSBwYXJ0aWNsZS5vZmZzZXQueSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAob3V0TW9kZSA9PT0gT3V0TW9kZS5kZXN0cm95KSB7XG4gICAgICAgICAgICBpZiAocGFydGljbGUucG9zaXRpb24ueCArIHBhcnRpY2xlLnJhZGl1cyA8IDAgfHxcbiAgICAgICAgICAgICAgICBwYXJ0aWNsZS5wb3NpdGlvbi55ICsgcGFydGljbGUucmFkaXVzIDwgMCB8fFxuICAgICAgICAgICAgICAgIHBhcnRpY2xlLnBvc2l0aW9uLnggLSBwYXJ0aWNsZS5yYWRpdXMgPiBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi53aWR0aCB8fFxuICAgICAgICAgICAgICAgIHBhcnRpY2xlLnBvc2l0aW9uLnkgLSBwYXJ0aWNsZS5yYWRpdXMgPiBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi5oZWlnaHQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBpZHggPSBjb250YWluZXIucGFydGljbGVzLmFycmF5LmluZGV4T2YocGFydGljbGUpO1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5wYXJ0aWNsZXMuYXJyYXkuc3BsaWNlKGlkeCwgMSk7XG5cbiAgICAgICAgICAgICAgICAvKiByZW1vdmUgdGhlIGNhbnZhcyBpZiB0aGUgYXJyYXkgaXMgZW1wdHkgKi9cbiAgICAgICAgICAgICAgICBjb25zdCBjbGlja01vZGUgPSBvcHRpb25zLmludGVyYWN0aXZpdHkuZXZlbnRzLm9uQ2xpY2subW9kZTtcblxuICAgICAgICAgICAgICAgIGlmICghY29udGFpbmVyLnBhcnRpY2xlcy5hcnJheS5sZW5ndGggJiYgIVV0aWxzLmlzSW5BcnJheShDbGlja01vZGUucHVzaCwgY2xpY2tNb2RlKSkge1xuICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuZGVzdHJveSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IG5leHRQb3MgPSB7XG4gICAgICAgICAgICAgICAgeF9sZWZ0OiBwYXJ0aWNsZS5wb3NpdGlvbi54IC0gcGFydGljbGUucmFkaXVzLFxuICAgICAgICAgICAgICAgIHhfcmlnaHQ6IHBhcnRpY2xlLnBvc2l0aW9uLnggKyBwYXJ0aWNsZS5yYWRpdXMsXG4gICAgICAgICAgICAgICAgeV9ib3R0b206IHBhcnRpY2xlLnBvc2l0aW9uLnkgKyBwYXJ0aWNsZS5yYWRpdXMsXG4gICAgICAgICAgICAgICAgeV90b3A6IHBhcnRpY2xlLnBvc2l0aW9uLnkgLSBwYXJ0aWNsZS5yYWRpdXMsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgY29uc3QgZGltZW5zaW9uID0gY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb247XG5cbiAgICAgICAgICAgIGlmIChuZXh0UG9zLnhfbGVmdCA+IGRpbWVuc2lvbi53aWR0aCAtIHBhcnRpY2xlLm9mZnNldC54KSB7XG4gICAgICAgICAgICAgICAgcGFydGljbGUucG9zaXRpb24ueCA9IG5ld1Bvcy54X2xlZnQ7XG4gICAgICAgICAgICAgICAgcGFydGljbGUucG9zaXRpb24ueSA9IE1hdGgucmFuZG9tKCkgKiBkaW1lbnNpb24uaGVpZ2h0O1xuICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0UG9zLnhfcmlnaHQgPCAtcGFydGljbGUub2Zmc2V0LngpIHtcbiAgICAgICAgICAgICAgICBwYXJ0aWNsZS5wb3NpdGlvbi54ID0gbmV3UG9zLnhfcmlnaHQ7XG4gICAgICAgICAgICAgICAgcGFydGljbGUucG9zaXRpb24ueSA9IE1hdGgucmFuZG9tKCkgKiBkaW1lbnNpb24uaGVpZ2h0O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAobmV4dFBvcy55X3RvcCA+IGNvbnRhaW5lci5jYW52YXMuZGltZW5zaW9uLmhlaWdodCAtIHBhcnRpY2xlLm9mZnNldC55KSB7XG4gICAgICAgICAgICAgICAgcGFydGljbGUucG9zaXRpb24ueSA9IG5ld1Bvcy55X3RvcDtcbiAgICAgICAgICAgICAgICBwYXJ0aWNsZS5wb3NpdGlvbi54ID0gTWF0aC5yYW5kb20oKSAqIGNvbnRhaW5lci5jYW52YXMuZGltZW5zaW9uLndpZHRoO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0UG9zLnlfYm90dG9tIDwgLXBhcnRpY2xlLm9mZnNldC55KSB7XG4gICAgICAgICAgICAgICAgcGFydGljbGUucG9zaXRpb24ueSA9IG5ld1Bvcy55X2JvdHRvbTtcbiAgICAgICAgICAgICAgICBwYXJ0aWNsZS5wb3NpdGlvbi54ID0gTWF0aC5yYW5kb20oKSAqIGNvbnRhaW5lci5jYW52YXMuZGltZW5zaW9uLndpZHRoO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVPdXRNb2RlKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcjtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGNvbnRhaW5lci5vcHRpb25zO1xuXG4gICAgICAgIHN3aXRjaCAob3B0aW9ucy5wYXJ0aWNsZXMubW92ZS5vdXRNb2RlKSB7XG4gICAgICAgICAgICBjYXNlIE91dE1vZGUuYm91bmNlOlxuICAgICAgICAgICAgY2FzZSBPdXRNb2RlLmJvdW5jZVZlcnRpY2FsOlxuICAgICAgICAgICAgY2FzZSBPdXRNb2RlLmJvdW5jZUhvcml6b250YWw6XG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVCb3VuY2UoKTtcblxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVCb3VuY2UoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyO1xuICAgICAgICBjb25zdCBvcHRpb25zID0gY29udGFpbmVyLm9wdGlvbnM7XG4gICAgICAgIGNvbnN0IHBhcnRpY2xlID0gdGhpcy5wYXJ0aWNsZTtcblxuICAgICAgICAvKiBjaGVjayBib3VuY2UgYWdhaW5zdCBwb2x5Z29uIGJvdW5kYXJpZXMgKi9cbiAgICAgICAgaWYgKG9wdGlvbnMucG9seWdvbi50eXBlICE9PSBQb2x5Z29uTWFza1R5cGUubm9uZSAmJiBvcHRpb25zLnBvbHlnb24udHlwZSAhPT0gUG9seWdvbk1hc2tUeXBlLmlubGluZSkge1xuICAgICAgICAgICAgaWYgKCFjb250YWluZXIucG9seWdvbi5jaGVja0luc2lkZVBvbHlnb24ocGFydGljbGUucG9zaXRpb24pKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wb2x5Z29uQm91bmNlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5wb2x5Z29uLnR5cGUgPT09IFBvbHlnb25NYXNrVHlwZS5pbmxpbmUpIHtcbiAgICAgICAgICAgIGlmICghcGFydGljbGUuaW5pdGlhbFBvc2l0aW9uKSB7XG4gICAgICAgICAgICAgICAgcGFydGljbGUuaW5pdGlhbFBvc2l0aW9uID0ge3g6IDAsIHk6IDB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgZGlzdCA9IFV0aWxzLmdldERpc3RhbmNlQmV0d2VlbkNvb3JkaW5hdGVzKHBhcnRpY2xlLmluaXRpYWxQb3NpdGlvbiwgcGFydGljbGUucG9zaXRpb24pO1xuICAgICAgICAgICAgaWYgKGRpc3QgPiBjb250YWluZXIucmV0aW5hLnBvbHlnb25NYXNrTW92ZVJhZGl1cykge1xuICAgICAgICAgICAgICAgIHRoaXMucG9seWdvbkJvdW5jZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3Qgb3V0TW9kZSA9IG9wdGlvbnMucGFydGljbGVzLm1vdmUub3V0TW9kZTtcbiAgICAgICAgICAgIGNvbnN0IHggPSBwYXJ0aWNsZS5wb3NpdGlvbi54ICsgcGFydGljbGUub2Zmc2V0Lng7XG4gICAgICAgICAgICBjb25zdCB5ID0gcGFydGljbGUucG9zaXRpb24ueSArIHBhcnRpY2xlLm9mZnNldC55O1xuXG4gICAgICAgICAgICBpZiAob3V0TW9kZSA9PT0gT3V0TW9kZS5ib3VuY2UgfHwgb3V0TW9kZSA9PT0gT3V0TW9kZS5ib3VuY2VIb3Jpem9udGFsKSB7XG4gICAgICAgICAgICAgICAgVXBkYXRlci5jaGVja0JvdW5kcyh4LCBwYXJ0aWNsZS5yYWRpdXMsIGNvbnRhaW5lci5jYW52YXMuZGltZW5zaW9uLndpZHRoLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHBhcnRpY2xlLnZlbG9jaXR5Lmhvcml6b250YWwgPSAtcGFydGljbGUudmVsb2NpdHkuaG9yaXpvbnRhbDtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKG91dE1vZGUgPT09IE91dE1vZGUuYm91bmNlIHx8IG91dE1vZGUgPT09IE91dE1vZGUuYm91bmNlVmVydGljYWwpIHtcbiAgICAgICAgICAgICAgICBVcGRhdGVyLmNoZWNrQm91bmRzKHksIHBhcnRpY2xlLnJhZGl1cywgY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24uaGVpZ2h0LCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHBhcnRpY2xlLnZlbG9jaXR5LnZlcnRpY2FsID0gLXBhcnRpY2xlLnZlbG9jaXR5LnZlcnRpY2FsO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwb2x5Z29uQm91bmNlKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBwYXJ0aWNsZSA9IHRoaXMucGFydGljbGU7XG5cbiAgICAgICAgcGFydGljbGUudmVsb2NpdHkuaG9yaXpvbnRhbCA9IC1wYXJ0aWNsZS52ZWxvY2l0eS5ob3Jpem9udGFsICsgKHBhcnRpY2xlLnZlbG9jaXR5LnZlcnRpY2FsIC8gMik7XG4gICAgICAgIHBhcnRpY2xlLnZlbG9jaXR5LnZlcnRpY2FsID0gLXBhcnRpY2xlLnZlbG9jaXR5LnZlcnRpY2FsICsgKHBhcnRpY2xlLnZlbG9jaXR5Lmhvcml6b250YWwgLyAyKTtcbiAgICB9XG59XG4iXX0=