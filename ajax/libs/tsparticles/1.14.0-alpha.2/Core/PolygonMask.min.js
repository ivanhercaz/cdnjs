"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),PolygonMaskType_1=require("../Enums/PolygonMaskType"),Particle_1=require("./Particle"),PolygonMaskInlineArrangement_1=require("../Enums/PolygonMaskInlineArrangement"),Utils_1=require("../Utils/Utils"),Constants_1=require("../Utils/Constants"),ColorUtils_1=require("../Utils/ColorUtils"),PolygonMask=function(){function g(t){this.container=t,this.dimension={height:0,width:0},this.paths=[],this.path2DSupported=window.hasOwnProperty("Path2D")}return g.prototype.checkInsidePolygon=function(t){var o=this.container,n=o.options;if(!n.polygon.enable||n.polygon.type===PolygonMaskType_1.PolygonMaskType.none||n.polygon.type===PolygonMaskType_1.PolygonMaskType.inline)return!0;if(!this.raw)throw new Error(Constants_1.Constants.noPolygonFound);for(var e=t?t.x:Math.random()*o.canvas.size.width,i=t?t.y:Math.random()*o.canvas.size.height,a=!1,r=0,s=this.raw.length-1;r<this.raw.length;s=r++){var l=this.raw[r].x,h=this.raw[r].y,g=this.raw[s].x,y=this.raw[s].y;i<h!=i<y&&e<(g-l)*(i-h)/(y-h)+l&&(a=!a)}return n.polygon.type===PolygonMaskType_1.PolygonMaskType.inside?a:n.polygon.type===PolygonMaskType_1.PolygonMaskType.outside&&!a},g.prototype.resize=function(){var o=this,n=this.container,t=n.options;t.polygon.enable&&t.polygon.type!==PolygonMaskType_1.PolygonMaskType.none&&(this.redrawTimeout&&clearTimeout(this.redrawTimeout),this.redrawTimeout=window.setTimeout(function(){o.parseSvgPathToPolygon().then(function(t){o.raw=t,o.createPath2D(),n.particles.redraw()})},250))},g.prototype.initAsync=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var o,n,e;return tslib_1.__generator(this,function(t){switch(t.label){case 0:return(o=this.container,(n=o.options).polygon.enable&&n.polygon.url)?[4,(e=this).parseSvgPathToPolygon(n.polygon.url)]:[3,2];case 1:e.raw=t.sent(),this.createPath2D(),t.label=2;case 2:return[2]}})})},g.prototype.reset=function(){delete this.raw,this.paths=[],delete this.svg},g.prototype.randomPointInPolygon=function(){var t,o=this.container,n=o.options;if(n.polygon.type===PolygonMaskType_1.PolygonMaskType.inline)switch(n.polygon.inline.arrangement){case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.randomPoint:t=this.getRandomPointOnPolygonPath();break;case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.randomLength:t=this.getRandomPointOnPolygonPathByLength();break;case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.equidistant:t=this.getEquidistantPointOnPolygonPathByIndex(o.particles.count);break;case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.onePerPoint:case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.perPoint:default:t=this.getPointOnPolygonPathByIndex(o.particles.count)}else t={x:Math.random()*o.canvas.size.width,y:Math.random()*o.canvas.size.height};return this.checkInsidePolygon(t)?t:this.randomPointInPolygon()},g.prototype.particlesInitialization=function(){var t=this.container.options;return!(!t.polygon.enable||t.polygon.type!==PolygonMaskType_1.PolygonMaskType.inline||t.polygon.inline.arrangement!==PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.onePerPoint&&t.polygon.inline.arrangement!==PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.perPoint)&&(this.drawPointsOnPolygonPath(),!0)},g.prototype.particlePosition=function(t){var o,n;if(this.container.options.polygon.enable&&0<(null!==(n=null===(o=this.raw)||void 0===o?void 0:o.length)&&void 0!==n?n:0)){var e={x:0,y:0};if(t)e.x=t.x,e.y=t.y;else{var i=this.randomPointInPolygon();e.x=i.x,e.y=i.y}return e}},g.prototype.particleBounce=function(t){var o=this.container,n=o.options;if(n.polygon.enable&&n.polygon.type!==PolygonMaskType_1.PolygonMaskType.none&&n.polygon.type!==PolygonMaskType_1.PolygonMaskType.inline){if(!this.checkInsidePolygon(t.position))return g.polygonBounce(t),!0}else if(n.polygon.enable&&n.polygon.type===PolygonMaskType_1.PolygonMaskType.inline){if(t.initialPosition)if(Utils_1.Utils.getDistanceBetweenCoordinates(t.initialPosition,t.position)>o.retina.polygonMaskMoveRadius)return g.polygonBounce(t),!0}return!1},g.prototype.clickPositionValid=function(t){var o=this.container.options;return!(!o.polygon.enable||o.polygon.type===PolygonMaskType_1.PolygonMaskType.none||o.polygon.type===PolygonMaskType_1.PolygonMaskType.inline||!this.checkInsidePolygon(t))},g.prototype.parseSvgPathToPolygon=function(f){var m;return tslib_1.__awaiter(this,void 0,void 0,function(){var o,n,e,i,a,r,s,l,h,g,y,p,P,c,d,w,u,_,v,T,S;return tslib_1.__generator(this,function(t){switch(t.label){case 0:return o=this.container,n=o.options,e=f||n.polygon.url,this.paths.length&&this.svg?[3,4]:[4,fetch(e)];case 1:return(i=t.sent()).ok?[4,i.text()]:[3,3];case 2:for(a=t.sent(),r=new DOMParser,s=r.parseFromString(a,"image/svg+xml"),this.svg=s.getElementsByTagName("svg")[0],l=s.getElementsByTagName("path"),_=0;_<l.length;_++)(d=l.item(_))&&this.paths.push({element:d,length:d.getTotalLength()});return[3,4];case 3:throw new Error("tsParticles Error - Error occurred during polygon mask download");case 4:for(h=o.retina.pixelRatio,g=n.polygon.scale/h,this.dimension.width=parseFloat(this.svg.getAttribute("width")||"0")*g,this.dimension.height=parseFloat(this.svg.getAttribute("height")||"0")*g,y=null!==(m=n.polygon.position)&&void 0!==m?m:{x:50,y:50},this.offset={x:o.canvas.size.width*y.x/(100*h)-this.dimension.width/2,y:o.canvas.size.height*y.y/(100*h)-this.dimension.height/2},p=[],P=0,c=this.paths;P<c.length;P++)for(d=c[P],w=d.element.pathSegList.numberOfItems,u={x:0,y:0},_=0;_<w;_++){switch((v=d.element.pathSegList.getItem(_)).pathSegType){case window.SVGPathSeg.PATHSEG_MOVETO_ABS:case window.SVGPathSeg.PATHSEG_LINETO_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_ABS:case window.SVGPathSeg.PATHSEG_ARC_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_ABS:T=v,u.x=T.x,u.y=T.y;break;case window.SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_ABS:u.x=v.x;break;case window.SVGPathSeg.PATHSEG_LINETO_VERTICAL_ABS:u.y=v.y;break;case window.SVGPathSeg.PATHSEG_LINETO_REL:case window.SVGPathSeg.PATHSEG_MOVETO_REL:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_REL:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_REL:case window.SVGPathSeg.PATHSEG_ARC_REL:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_REL:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_REL:S=v,u.x+=S.x,u.y+=S.y;break;case window.SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_REL:u.x+=v.x;break;case window.SVGPathSeg.PATHSEG_LINETO_VERTICAL_REL:u.y+=v.y;break;case window.SVGPathSeg.PATHSEG_UNKNOWN:case window.SVGPathSeg.PATHSEG_CLOSEPATH:continue}p.push({x:u.x*g+this.offset.x,y:u.y*g+this.offset.y})}return[2,p]}})})},g.prototype.draw=function(){var t=this.container.options;if(t.polygon.enable&&t.polygon.draw.enable)for(var o=this.container,n=o.options,e=o.canvas.context,i=n.polygon.draw,a=this.raw,r=0,s=this.paths;r<s.length;r++){var l=s[r].path2d,h=this.path2DSupported;e&&(h&&l&&this.offset?g.drawPolygonMaskPath(e,l,i.stroke,this.offset):a&&g.drawPolygonMask(e,a,i.stroke))}},g.prototype.drawPointsOnPolygonPath=function(){var t=this.container;if(this.raw)for(var o=0,n=this.raw;o<n.length;o++){var e=n[o],i={x:e.x,y:e.y};t.particles.addParticle(new Particle_1.Particle(t,i))}},g.prototype.getRandomPointOnPolygonPath=function(){if(!this.raw||!this.raw.length)throw new Error(Constants_1.Constants.noPolygonDataLoaded);var t=Utils_1.Utils.itemFromArray(this.raw);return{x:t.x,y:t.y}},g.prototype.getRandomPointOnPolygonPathByLength=function(){var t,o,n=this.container.options;if(!this.raw||!this.raw.length||!this.paths.length)throw new Error(Constants_1.Constants.noPolygonDataLoaded);var e=Utils_1.Utils.itemFromArray(this.paths),i=Math.floor(Math.random()*e.length)+1,a=e.element.getPointAtLength(i);return{x:a.x*n.polygon.scale+((null===(t=this.offset)||void 0===t?void 0:t.x)||0),y:a.y*n.polygon.scale+((null===(o=this.offset)||void 0===o?void 0:o.y)||0)}},g.prototype.getEquidistantPointOnPolygonPathByIndex=function(t){var o,n,e,i,a,r,s=this.container.options;if(!this.raw||!this.raw.length||!this.paths.length)throw new Error(Constants_1.Constants.noPolygonDataLoaded);for(var l,h=0,g=this.paths.reduce(function(t,o){return t+o.length},0)/s.particles.number.value,y=0,p=this.paths;y<p.length;y++){var P=p[y],c=g*t-h;if(c<=P.length){l=P.element.getPointAtLength(c);break}h+=P.length}return{x:(null!==(o=null==l?void 0:l.x)&&void 0!==o?o:0)*s.polygon.scale+(null!==(e=null===(n=this.offset)||void 0===n?void 0:n.x)&&void 0!==e?e:0),y:(null!==(i=null==l?void 0:l.y)&&void 0!==i?i:0)*s.polygon.scale+(null!==(r=null===(a=this.offset)||void 0===a?void 0:a.y)&&void 0!==r?r:0)}},g.prototype.getPointOnPolygonPathByIndex=function(t){if(!this.raw||!this.raw.length)throw new Error(Constants_1.Constants.noPolygonDataLoaded);var o=this.raw[t%this.raw.length];return{x:o.x,y:o.y}},g.prototype.createPath2D=function(){var r;if(this.path2DSupported)for(var t=function(e){var t=null===(r=e.element)||void 0===r?void 0:r.getAttribute("d");if(t){var o=new Path2D(t),n=document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGMatrix(),i=new Path2D,a=n.scale(s.container.options.polygon.scale);i.addPath?(i.addPath(o,a),e.path2d=i):delete e.path2d}else delete e.path2d;!e.path2d&&s.raw&&(e.path2d=new Path2D,e.path2d.moveTo(s.raw[0].x,s.raw[0].y),s.raw.forEach(function(t,o){var n;0<o&&null!==(n=e.path2d)&&void 0!==n&&n.lineTo(t.x,t.y)}),e.path2d.closePath())},s=this,o=0,n=this.paths;o<n.length;o++){t(n[o])}},g.polygonBounce=function(t){t.velocity.horizontal=-t.velocity.horizontal+t.velocity.vertical/2,t.velocity.vertical=-t.velocity.vertical+t.velocity.horizontal/2},g.drawPolygonMask=function(t,o,n){var e="string"==typeof n.color?ColorUtils_1.ColorUtils.stringToRgb(n.color):ColorUtils_1.ColorUtils.colorToRgb(n.color);if(e){t.save(),t.beginPath(),t.moveTo(o[0].x,o[0].y);for(var i=1;i<o.length;i++)t.lineTo(o[i].x,o[i].y);t.closePath(),t.strokeStyle=ColorUtils_1.ColorUtils.getStyleFromColor(e),t.lineWidth=n.width,t.stroke(),t.restore()}},g.drawPolygonMaskPath=function(t,o,n,e){t.save(),t.translate(e.x,e.y);var i="string"==typeof n.color?ColorUtils_1.ColorUtils.stringToRgb(n.color):ColorUtils_1.ColorUtils.colorToRgb(n.color);i&&(t.strokeStyle=ColorUtils_1.ColorUtils.getStyleFromColor(i,n.opacity),t.lineWidth=n.width,t.stroke(o)),t.restore()},g}();exports.PolygonMask=PolygonMask;