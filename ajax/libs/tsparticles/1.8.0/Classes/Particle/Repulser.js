"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Repulser = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _ClickMode = require("../../Enums/Modes/ClickMode");

var _HoverMode = require("../../Enums/Modes/HoverMode");

var _OutMode = require("../../Enums/OutMode");

var _Utils = require("../Utils/Utils");

var _DivMode = require("../../Enums/Modes/DivMode");

/**
 * Particle repulse manager
 */
var Repulser = /*#__PURE__*/function () {
  function Repulser(container, particle) {
    (0, _classCallCheck2["default"])(this, Repulser);
    this.particle = void 0;
    this.container = void 0;
    this.container = container;
    this.particle = particle;
  }

  (0, _createClass2["default"])(Repulser, [{
    key: "repulse",
    value: function repulse() {
      var container = this.container;
      var options = container.options;
      var hoverEnabled = options.interactivity.events.onHover.enable;
      var clickEnabled = options.interactivity.events.onClick.enable;
      var mouseMoveStatus = container.interactivity.status === "mousemove";
      var hoverMode = options.interactivity.events.onHover.mode;
      var clickMode = options.interactivity.events.onClick.mode;
      var divMode = options.interactivity.events.onDiv.mode;

      if (mouseMoveStatus && hoverEnabled && _Utils.Utils.isInArray(_HoverMode.HoverMode.repulse, hoverMode)) {
        this.hoverRepulse();
      } else if (clickEnabled && _Utils.Utils.isInArray(_ClickMode.ClickMode.repulse, clickMode)) {
        this.clickRepulse();
      } else if (options.interactivity.events.onDiv.enable && _Utils.Utils.isInArray(_DivMode.DivMode.repulse, divMode)) {
        this.divRepulse();
      }
    }
  }, {
    key: "divRepulse",
    value: function divRepulse() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;
      var elem = document.getElementById(options.interactivity.events.onDiv.el);
      var pos = {
        x: elem.offsetLeft + elem.offsetWidth / 2,
        y: elem.offsetTop + elem.offsetHeight / 2
      };
      var divWidth = elem.offsetWidth / 2;

      if (container.retina.isRetina) {
        pos.x *= container.canvas.pxRatio;
        pos.y *= container.canvas.pxRatio;
        divWidth *= container.canvas.pxRatio;
      }

      var dx_div = particle.position.x - pos.x;
      var dy_div = particle.position.y - pos.y;
      var dist_div = Math.sqrt(dx_div * dx_div + dy_div * dy_div);
      var normVec = {
        x: dx_div / dist_div,
        y: dy_div / dist_div
      };
      var repulseRadius = divWidth;
      var velocity = 100;

      var repulseFactor = _Utils.Utils.clamp((-Math.pow(dist_div / repulseRadius, 4) + 1) * velocity, 0, 50);

      this.particle.position.x += normVec.x * repulseFactor;
      this.particle.position.y += normVec.y * repulseFactor;
    }
  }, {
    key: "clickRepulse",
    value: function clickRepulse() {
      var container = this.container;
      var particle = this.particle;

      if (!container.repulse.finish) {
        if (!container.repulse.count) {
          container.repulse.count = 0;
        }

        container.repulse.count++;

        if (container.repulse.count === container.particles.array.length) {
          container.repulse.finish = true;
        }
      }

      if (container.repulse.clicking) {
        var repulseDistance = container.retina.repulseModeDistance;
        var repulseRadius = Math.pow(repulseDistance / 6, 3);
        var mouseClickPos = container.interactivity.mouse.clickPosition || {
          x: 0,
          y: 0
        };
        var dx = mouseClickPos.x - particle.position.x;
        var dy = mouseClickPos.y - particle.position.y;
        var d = dx * dx + dy * dy;
        var force = -repulseRadius / d; // default

        if (d <= repulseRadius) {
          this.processRepulse(dx, dy, force);
        } // bang - slow motion mode
        // if(!container.repulse_finish){
        //   if(d <= repulseRadius){
        //     process();
        //   }
        // }else{
        //   process();
        // }

      } else if (container.repulse.clicking === false) {
        particle.velocity.horizontal = particle.initialVelocity.horizontal;
        particle.velocity.vertical = particle.initialVelocity.vertical;
      }
    }
  }, {
    key: "hoverRepulse",
    value: function hoverRepulse() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;
      var mousePos = container.interactivity.mouse.position || {
        x: 0,
        y: 0
      };
      var dxMouse = particle.position.x - mousePos.x;
      var dyMouse = particle.position.y - mousePos.y;
      var distMouse = Math.sqrt(dxMouse * dxMouse + dyMouse * dyMouse);
      var normVec = {
        x: dxMouse / distMouse,
        y: dyMouse / distMouse
      };
      var repulseRadius = container.retina.repulseModeDistance;
      var velocity = 100;

      var repulseFactor = _Utils.Utils.clamp((1 - Math.pow(distMouse / repulseRadius, 2)) * velocity, 0, 50);

      var pos = {
        x: particle.position.x + normVec.x * repulseFactor,
        y: particle.position.y + normVec.y * repulseFactor
      };
      var outMode = options.particles.move.outMode;

      if (outMode === _OutMode.OutMode.bounce || outMode === _OutMode.OutMode.bounceVertical || outMode === _OutMode.OutMode.bounceHorizontal) {
        var isInside = {
          horizontal: pos.x - particle.radius > 0 && pos.x + particle.radius < container.canvas.dimension.width,
          vertical: pos.y - particle.radius > 0 && pos.y + particle.radius < container.canvas.dimension.height
        };

        if (outMode === _OutMode.OutMode.bounceVertical || isInside.horizontal) {
          particle.position.x = pos.x;
        }

        if (outMode === _OutMode.OutMode.bounceHorizontal || isInside.vertical) {
          particle.position.y = pos.y;
        }
      } else {
        particle.position.x = pos.x;
        particle.position.y = pos.y;
      }
    }
  }, {
    key: "processRepulse",
    value: function processRepulse(dx, dy, force) {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;
      var f = Math.atan2(dy, dx);
      particle.velocity.horizontal = force * Math.cos(f);
      particle.velocity.vertical = force * Math.sin(f);
      var outMode = options.particles.move.outMode;

      if (outMode === _OutMode.OutMode.bounce || outMode === _OutMode.OutMode.bounceHorizontal || outMode === _OutMode.OutMode.bounceVertical) {
        var pos = {
          x: particle.position.x + particle.velocity.horizontal,
          y: particle.position.y + particle.velocity.vertical
        };

        if (outMode !== _OutMode.OutMode.bounceVertical) {
          if (pos.x + particle.radius > container.canvas.dimension.width) {
            particle.velocity.horizontal = -particle.velocity.horizontal;
          } else if (pos.x - particle.radius < 0) {
            particle.velocity.horizontal = -particle.velocity.horizontal;
          }
        }

        if (outMode !== _OutMode.OutMode.bounceHorizontal) {
          if (pos.y + particle.radius > container.canvas.dimension.height) {
            particle.velocity.vertical = -particle.velocity.vertical;
          } else if (pos.y - particle.radius < 0) {
            particle.velocity.vertical = -particle.velocity.vertical;
          }
        }
      }
    }
  }]);
  return Repulser;
}();

exports.Repulser = Repulser;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9DbGFzc2VzL1BhcnRpY2xlL1JlcHVsc2VyLnRzIl0sIm5hbWVzIjpbIlJlcHVsc2VyIiwiY29udGFpbmVyIiwicGFydGljbGUiLCJvcHRpb25zIiwiaG92ZXJFbmFibGVkIiwiaW50ZXJhY3Rpdml0eSIsImV2ZW50cyIsIm9uSG92ZXIiLCJlbmFibGUiLCJjbGlja0VuYWJsZWQiLCJvbkNsaWNrIiwibW91c2VNb3ZlU3RhdHVzIiwic3RhdHVzIiwiaG92ZXJNb2RlIiwibW9kZSIsImNsaWNrTW9kZSIsImRpdk1vZGUiLCJvbkRpdiIsIlV0aWxzIiwiaXNJbkFycmF5IiwiSG92ZXJNb2RlIiwicmVwdWxzZSIsImhvdmVyUmVwdWxzZSIsIkNsaWNrTW9kZSIsImNsaWNrUmVwdWxzZSIsIkRpdk1vZGUiLCJkaXZSZXB1bHNlIiwiZWxlbSIsImRvY3VtZW50IiwiZ2V0RWxlbWVudEJ5SWQiLCJlbCIsInBvcyIsIngiLCJvZmZzZXRMZWZ0Iiwib2Zmc2V0V2lkdGgiLCJ5Iiwib2Zmc2V0VG9wIiwib2Zmc2V0SGVpZ2h0IiwiZGl2V2lkdGgiLCJyZXRpbmEiLCJpc1JldGluYSIsImNhbnZhcyIsInB4UmF0aW8iLCJkeF9kaXYiLCJwb3NpdGlvbiIsImR5X2RpdiIsImRpc3RfZGl2IiwiTWF0aCIsInNxcnQiLCJub3JtVmVjIiwicmVwdWxzZVJhZGl1cyIsInZlbG9jaXR5IiwicmVwdWxzZUZhY3RvciIsImNsYW1wIiwicG93IiwiZmluaXNoIiwiY291bnQiLCJwYXJ0aWNsZXMiLCJhcnJheSIsImxlbmd0aCIsImNsaWNraW5nIiwicmVwdWxzZURpc3RhbmNlIiwicmVwdWxzZU1vZGVEaXN0YW5jZSIsIm1vdXNlQ2xpY2tQb3MiLCJtb3VzZSIsImNsaWNrUG9zaXRpb24iLCJkeCIsImR5IiwiZCIsImZvcmNlIiwicHJvY2Vzc1JlcHVsc2UiLCJob3Jpem9udGFsIiwiaW5pdGlhbFZlbG9jaXR5IiwidmVydGljYWwiLCJtb3VzZVBvcyIsImR4TW91c2UiLCJkeU1vdXNlIiwiZGlzdE1vdXNlIiwib3V0TW9kZSIsIm1vdmUiLCJPdXRNb2RlIiwiYm91bmNlIiwiYm91bmNlVmVydGljYWwiLCJib3VuY2VIb3Jpem9udGFsIiwiaXNJbnNpZGUiLCJyYWRpdXMiLCJkaW1lbnNpb24iLCJ3aWR0aCIsImhlaWdodCIsImYiLCJhdGFuMiIsImNvcyIsInNpbiJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7QUFFQTs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFFQTs7O0lBR2FBLFE7QUFJVCxvQkFBWUMsU0FBWixFQUFrQ0MsUUFBbEMsRUFBc0Q7QUFBQTtBQUFBLFNBSHJDQSxRQUdxQztBQUFBLFNBRnJDRCxTQUVxQztBQUNsRCxTQUFLQSxTQUFMLEdBQWlCQSxTQUFqQjtBQUNBLFNBQUtDLFFBQUwsR0FBZ0JBLFFBQWhCO0FBQ0g7Ozs7OEJBRXNCO0FBQ25CLFVBQU1ELFNBQVMsR0FBRyxLQUFLQSxTQUF2QjtBQUNBLFVBQU1FLE9BQU8sR0FBR0YsU0FBUyxDQUFDRSxPQUExQjtBQUNBLFVBQU1DLFlBQVksR0FBR0QsT0FBTyxDQUFDRSxhQUFSLENBQXNCQyxNQUF0QixDQUE2QkMsT0FBN0IsQ0FBcUNDLE1BQTFEO0FBQ0EsVUFBTUMsWUFBWSxHQUFHTixPQUFPLENBQUNFLGFBQVIsQ0FBc0JDLE1BQXRCLENBQTZCSSxPQUE3QixDQUFxQ0YsTUFBMUQ7QUFDQSxVQUFNRyxlQUFlLEdBQUdWLFNBQVMsQ0FBQ0ksYUFBVixDQUF3Qk8sTUFBeEIsS0FBbUMsV0FBM0Q7QUFDQSxVQUFNQyxTQUFTLEdBQUdWLE9BQU8sQ0FBQ0UsYUFBUixDQUFzQkMsTUFBdEIsQ0FBNkJDLE9BQTdCLENBQXFDTyxJQUF2RDtBQUNBLFVBQU1DLFNBQVMsR0FBR1osT0FBTyxDQUFDRSxhQUFSLENBQXNCQyxNQUF0QixDQUE2QkksT0FBN0IsQ0FBcUNJLElBQXZEO0FBQ0EsVUFBTUUsT0FBTyxHQUFHYixPQUFPLENBQUNFLGFBQVIsQ0FBc0JDLE1BQXRCLENBQTZC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QUFULENBQWtCb0IsVUFBbEIsR0FBK0IsQ0FBQ3JFLFFBQVEsQ0FBQ2lELFFBQVQsQ0FBa0JvQixVQUFsRDtBQUNILFdBRkQsTUFFTyxJQUFJeEMsR0FBRyxDQUFDQyxDQUFKLEdBQVE5QixRQUFRLENBQUNtRixNQUFqQixHQUEwQixDQUE5QixFQUFpQztBQUNwQ25GLFlBQUFBLFFBQVEsQ0FBQ2lELFFBQVQsQ0FBa0JvQixVQUFsQixHQUErQixDQUFDckUsUUFBUSxDQUFDaUQsUUFBVCxDQUFrQm9CLFVBQWxEO0FBQ0g7QUFDSjs7QUFFRCxZQUFJTyxPQUFPLEtBQUtFLGlCQUFRRyxnQkFBeEIsRUFBMEM7QUFDdEMsY0FBSXBELEdBQUcsQ0FBQ0ksQ0FBSixHQUFRakMsUUFBUSxDQUFDbUYsTUFBakIsR0FBMEJwRixTQUFTLENBQUN3QyxNQUFWLENBQWlCNkMsU0FBakIsQ0FBMkJFLE1BQXpELEVBQWlFO0FBQzdEdEYsWUFBQUEsUUFBUSxDQUFDaUQsUUFBVCxDQUFrQnNCLFFBQWxCLEdBQTZCLENBQUN2RSxRQUFRLENBQUNpRCxRQUFULENBQWtCc0IsUUFBaEQ7QUFDSCxXQUZELE1BRU8sSUFBSTFDLEdBQUcsQ0FBQ0ksQ0FBSixHQUFRakMsUUFBUSxDQUFDbUYsTUFBakIsR0FBMEIsQ0FBOUIsRUFBaUM7QUFDcENuRixZQUFBQSxRQUFRLENBQUNpRCxRQUFULENBQWtCc0IsUUFBbEIsR0FBNkIsQ0FBQ3ZFLFFBQVEsQ0FBQ2lELFFBQVQsQ0FBa0JzQixRQUFoRDtBQUNIO0FBQ0o7QUFDSjtBQUNKIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCB7Q2xpY2tNb2RlfSBmcm9tIFwiLi4vLi4vRW51bXMvTW9kZXMvQ2xpY2tNb2RlXCI7XG5pbXBvcnQge0NvbnRhaW5lcn0gZnJvbSBcIi4uL0NvbnRhaW5lclwiO1xuaW1wb3J0IHtIb3Zlck1vZGV9IGZyb20gXCIuLi8uLi9FbnVtcy9Nb2Rlcy9Ib3Zlck1vZGVcIjtcbmltcG9ydCB7T3V0TW9kZX0gZnJvbSBcIi4uLy4uL0VudW1zL091dE1vZGVcIjtcbmltcG9ydCB7UGFydGljbGV9IGZyb20gXCIuLi9QYXJ0aWNsZVwiO1xuaW1wb3J0IHtVdGlsc30gZnJvbSBcIi4uL1V0aWxzL1V0aWxzXCI7XG5pbXBvcnQge0Rpdk1vZGV9IGZyb20gXCIuLi8uLi9FbnVtcy9Nb2Rlcy9EaXZNb2RlXCI7XG5cbi8qKlxuICogUGFydGljbGUgcmVwdWxzZSBtYW5hZ2VyXG4gKi9cbmV4cG9ydCBjbGFzcyBSZXB1bHNlciB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBwYXJ0aWNsZTogUGFydGljbGU7XG4gICAgcHJpdmF0ZSByZWFkb25seSBjb250YWluZXI6IENvbnRhaW5lcjtcblxuICAgIGNvbnN0cnVjdG9yKGNvbnRhaW5lcjogQ29udGFpbmVyLCBwYXJ0aWNsZTogUGFydGljbGUpIHtcbiAgICAgICAgdGhpcy5jb250YWluZXIgPSBjb250YWluZXI7XG4gICAgICAgIHRoaXMucGFydGljbGUgPSBwYXJ0aWNsZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVwdWxzZSgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jb250YWluZXI7XG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSBjb250YWluZXIub3B0aW9ucztcbiAgICAgICAgY29uc3QgaG92ZXJFbmFibGVkID0gb3B0aW9ucy5pbnRlcmFjdGl2aXR5LmV2ZW50cy5vbkhvdmVyLmVuYWJsZTtcbiAgICAgICAgY29uc3QgY2xpY2tFbmFibGVkID0gb3B0aW9ucy5pbnRlcmFjdGl2aXR5LmV2ZW50cy5vbkNsaWNrLmVuYWJsZTtcbiAgICAgICAgY29uc3QgbW91c2VNb3ZlU3RhdHVzID0gY29udGFpbmVyLmludGVyYWN0aXZpdHkuc3RhdHVzID09PSBcIm1vdXNlbW92ZVwiO1xuICAgICAgICBjb25zdCBob3Zlck1vZGUgPSBvcHRpb25zLmludGVyYWN0aXZpdHkuZXZlbnRzLm9uSG92ZXIubW9kZTtcbiAgICAgICAgY29uc3QgY2xpY2tNb2RlID0gb3B0aW9ucy5pbnRlcmFjdGl2aXR5LmV2ZW50cy5vbkNsaWNrLm1vZGU7XG4gICAgICAgIGNvbnN0IGRpdk1vZGUgPSBvcHRpb25zLmludGVyYWN0aXZpdHkuZXZlbnRzLm9uRGl2Lm1vZGU7XG5cbiAgICAgICAgaWYgKG1vdXNlTW92ZVN0YXR1cyAmJiBob3ZlckVuYWJsZWQgJiYgVXRpbHMuaXNJbkFycmF5KEhvdmVyTW9kZS5yZXB1bHNlLCBob3Zlck1vZGUpKSB7XG4gICAgICAgICAgICB0aGlzLmhvdmVyUmVwdWxzZSgpO1xuICAgICAgICB9IGVsc2UgaWYgKGNsaWNrRW5hYmxlZCAmJiBVdGlscy5pc0luQXJyYXkoQ2xpY2tNb2RlLnJlcHVsc2UsIGNsaWNrTW9kZSkpIHtcbiAgICAgICAgICAgIHRoaXMuY2xpY2tSZXB1bHNlKCk7XG4gICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5pbnRlcmFjdGl2aXR5LmV2ZW50cy5vbkRpdi5lbmFibGUgJiYgVXRpbHMuaXNJbkFycmF5KERpdk1vZGUucmVwdWxzZSwgZGl2TW9kZSkpIHtcbiAgICAgICAgICAgIHRoaXMuZGl2UmVwdWxzZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkaXZSZXB1bHNlKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcjtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGNvbnRhaW5lci5vcHRpb25zO1xuICAgICAgICBjb25zdCBwYXJ0aWNsZSA9IHRoaXMucGFydGljbGU7XG5cbiAgICAgICAgY29uc3QgZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKG9wdGlvbnMuaW50ZXJhY3Rpdml0eS5ldmVudHMub25EaXYuZWwpIGFzIEhUTUxFbGVtZW50O1xuICAgICAgICBjb25zdCBwb3MgPSB7XG4gICAgICAgICAgICB4OiAoZWxlbS5vZmZzZXRMZWZ0ICsgZWxlbS5vZmZzZXRXaWR0aCAvIDIpLFxuICAgICAgICAgICAgeTogKGVsZW0ub2Zmc2V0VG9wICsgZWxlbS5vZmZzZXRIZWlnaHQgLyAyKSxcbiAgICAgICAgfTtcbiAgICAgICAgbGV0IGRpdldpZHRoID0gZWxlbS5vZmZzZXRXaWR0aCAvIDI7XG5cbiAgICAgICAgaWYgKGNvbnRhaW5lci5yZXRpbmEuaXNSZXRpbmEpIHtcbiAgICAgICAgICAgIHBvcy54ICo9IGNvbnRhaW5lci5jYW52YXMucHhSYXRpbztcbiAgICAgICAgICAgIHBvcy55ICo9IGNvbnRhaW5lci5jYW52YXMucHhSYXRpbztcbiAgICAgICAgICAgIGRpdldpZHRoICo9IGNvbnRhaW5lci5jYW52YXMucHhSYXRpb1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZHhfZGl2ID0gcGFydGljbGUucG9zaXRpb24ueCAtIHBvcy54O1xuICAgICAgICBjb25zdCBkeV9kaXYgPSBwYXJ0aWNsZS5wb3NpdGlvbi55IC0gcG9zLnk7XG4gICAgICAgIGNvbnN0IGRpc3RfZGl2ID0gTWF0aC5zcXJ0KGR4X2RpdiAqIGR4X2RpdiArIGR5X2RpdiAqIGR5X2Rpdik7XG4gICAgICAgIGNvbnN0IG5vcm1WZWMgPSB7XG4gICAgICAgICAgICB4OiBkeF9kaXYgLyBkaXN0X2RpdixcbiAgICAgICAgICAgIHk6IGR5X2RpdiAvIGRpc3RfZGl2LFxuICAgICAgICB9O1xuICAgICAgICBjb25zdCByZXB1bHNlUmFkaXVzID0gZGl2V2lkdGg7XG4gICAgICAgIGNvbnN0IHZlbG9jaXR5ID0gMTAwO1xuICAgICAgICBjb25zdCByZXB1bHNlRmFjdG9yID0gVXRpbHMuY2xhbXAoKC1NYXRoLnBvdyhkaXN0X2RpdiAvIHJlcHVsc2VSYWRpdXMsIDQpICsgMSkgKiB2ZWxvY2l0eSwgMCwgNTApO1xuXG4gICAgICAgIHRoaXMucGFydGljbGUucG9zaXRpb24ueCArPSBub3JtVmVjLnggKiByZXB1bHNlRmFjdG9yO1xuICAgICAgICB0aGlzLnBhcnRpY2xlLnBvc2l0aW9uLnkgKz0gbm9ybVZlYy55ICogcmVwdWxzZUZhY3RvcjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNsaWNrUmVwdWxzZSgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jb250YWluZXI7XG4gICAgICAgIGNvbnN0IHBhcnRpY2xlID0gdGhpcy5wYXJ0aWNsZTtcblxuICAgICAgICBpZiAoIWNvbnRhaW5lci5yZXB1bHNlLmZpbmlzaCkge1xuICAgICAgICAgICAgaWYgKCFjb250YWluZXIucmVwdWxzZS5jb3VudCkge1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5yZXB1bHNlLmNvdW50ID0gMDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29udGFpbmVyLnJlcHVsc2UuY291bnQrKztcblxuICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5yZXB1bHNlLmNvdW50ID09PSBjb250YWluZXIucGFydGljbGVzLmFycmF5Lmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5yZXB1bHNlLmZpbmlzaCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29udGFpbmVyLnJlcHVsc2UuY2xpY2tpbmcpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlcHVsc2VEaXN0YW5jZSA9IGNvbnRhaW5lci5yZXRpbmEucmVwdWxzZU1vZGVEaXN0YW5jZTtcbiAgICAgICAgICAgIGNvbnN0IHJlcHVsc2VSYWRpdXMgPSBNYXRoLnBvdyhyZXB1bHNlRGlzdGFuY2UgLyA2LCAzKTtcbiAgICAgICAgICAgIGNvbnN0IG1vdXNlQ2xpY2tQb3MgPSBjb250YWluZXIuaW50ZXJhY3Rpdml0eS5tb3VzZS5jbGlja1Bvc2l0aW9uIHx8IHt4OiAwLCB5OiAwfTtcbiAgICAgICAgICAgIGNvbnN0IGR4ID0gbW91c2VDbGlja1Bvcy54IC0gcGFydGljbGUucG9zaXRpb24ueDtcbiAgICAgICAgICAgIGNvbnN0IGR5ID0gbW91c2VDbGlja1Bvcy55IC0gcGFydGljbGUucG9zaXRpb24ueTtcbiAgICAgICAgICAgIGNvbnN0IGQgPSBkeCAqIGR4ICsgZHkgKiBkeTtcbiAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gLXJlcHVsc2VSYWRpdXMgLyBkO1xuXG4gICAgICAgICAgICAvLyBkZWZhdWx0XG4gICAgICAgICAgICBpZiAoZCA8PSByZXB1bHNlUmFkaXVzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzUmVwdWxzZShkeCwgZHksIGZvcmNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIGJhbmcgLSBzbG93IG1vdGlvbiBtb2RlXG4gICAgICAgICAgICAvLyBpZighY29udGFpbmVyLnJlcHVsc2VfZmluaXNoKXtcbiAgICAgICAgICAgIC8vICAgaWYoZCA8PSByZXB1bHNlUmFkaXVzKXtcbiAgICAgICAgICAgIC8vICAgICBwcm9jZXNzKCk7XG4gICAgICAgICAgICAvLyAgIH1cbiAgICAgICAgICAgIC8vIH1lbHNle1xuICAgICAgICAgICAgLy8gICBwcm9jZXNzKCk7XG4gICAgICAgICAgICAvLyB9XG4gICAgICAgIH0gZWxzZSBpZiAoY29udGFpbmVyLnJlcHVsc2UuY2xpY2tpbmcgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICBwYXJ0aWNsZS52ZWxvY2l0eS5ob3Jpem9udGFsID0gcGFydGljbGUuaW5pdGlhbFZlbG9jaXR5Lmhvcml6b250YWw7XG4gICAgICAgICAgICBwYXJ0aWNsZS52ZWxvY2l0eS52ZXJ0aWNhbCA9IHBhcnRpY2xlLmluaXRpYWxWZWxvY2l0eS52ZXJ0aWNhbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaG92ZXJSZXB1bHNlKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcjtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGNvbnRhaW5lci5vcHRpb25zO1xuICAgICAgICBjb25zdCBwYXJ0aWNsZSA9IHRoaXMucGFydGljbGU7XG4gICAgICAgIGNvbnN0IG1vdXNlUG9zID0gY29udGFpbmVyLmludGVyYWN0aXZpdHkubW91c2UucG9zaXRpb24gfHwge3g6IDAsIHk6IDB9O1xuICAgICAgICBjb25zdCBkeE1vdXNlID0gcGFydGljbGUucG9zaXRpb24ueCAtIG1vdXNlUG9zLng7XG4gICAgICAgIGNvbnN0IGR5TW91c2UgPSBwYXJ0aWNsZS5wb3NpdGlvbi55IC0gbW91c2VQb3MueTtcbiAgICAgICAgY29uc3QgZGlzdE1vdXNlID0gTWF0aC5zcXJ0KGR4TW91c2UgKiBkeE1vdXNlICsgZHlNb3VzZSAqIGR5TW91c2UpO1xuICAgICAgICBjb25zdCBub3JtVmVjID0ge3g6IGR4TW91c2UgLyBkaXN0TW91c2UsIHk6IGR5TW91c2UgLyBkaXN0TW91c2V9O1xuICAgICAgICBjb25zdCByZXB1bHNlUmFkaXVzID0gY29udGFpbmVyLnJldGluYS5yZXB1bHNlTW9kZURpc3RhbmNlO1xuICAgICAgICBjb25zdCB2ZWxvY2l0eSA9IDEwMDtcbiAgICAgICAgY29uc3QgcmVwdWxzZUZhY3RvciA9IFV0aWxzLmNsYW1wKCgxIC0gTWF0aC5wb3coZGlzdE1vdXNlIC8gcmVwdWxzZVJhZGl1cywgMikpICogdmVsb2NpdHksIDAsIDUwKTtcbiAgICAgICAgY29uc3QgcG9zID0ge1xuICAgICAgICAgICAgeDogcGFydGljbGUucG9zaXRpb24ueCArIG5vcm1WZWMueCAqIHJlcHVsc2VGYWN0b3IsXG4gICAgICAgICAgICB5OiBwYXJ0aWNsZS5wb3NpdGlvbi55ICsgbm9ybVZlYy55ICogcmVwdWxzZUZhY3RvcixcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3Qgb3V0TW9kZSA9IG9wdGlvbnMucGFydGljbGVzLm1vdmUub3V0TW9kZTtcblxuICAgICAgICBpZiAob3V0TW9kZSA9PT0gT3V0TW9kZS5ib3VuY2UgfHwgb3V0TW9kZSA9PT0gT3V0TW9kZS5ib3VuY2VWZXJ0aWNhbCB8fCBvdXRNb2RlID09PSBPdXRNb2RlLmJvdW5jZUhvcml6b250YWwpIHtcbiAgICAgICAgICAgIGNvbnN0IGlzSW5zaWRlID0ge1xuICAgICAgICAgICAgICAgIGhvcml6b250YWw6IHBvcy54IC0gcGFydGljbGUucmFkaXVzID4gMCAmJiBwb3MueCArIHBhcnRpY2xlLnJhZGl1cyA8IGNvbnRhaW5lci5jYW52YXMuZGltZW5zaW9uLndpZHRoLFxuICAgICAgICAgICAgICAgIHZlcnRpY2FsOiBwb3MueSAtIHBhcnRpY2xlLnJhZGl1cyA+IDAgJiYgcG9zLnkgKyBwYXJ0aWNsZS5yYWRpdXMgPCBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi5oZWlnaHQsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgaWYgKG91dE1vZGUgPT09IE91dE1vZGUuYm91bmNlVmVydGljYWwgfHwgaXNJbnNpZGUuaG9yaXpvbnRhbCkge1xuICAgICAgICAgICAgICAgIHBhcnRpY2xlLnBvc2l0aW9uLnggPSBwb3MueDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKG91dE1vZGUgPT09IE91dE1vZGUuYm91bmNlSG9yaXpvbnRhbCB8fCBpc0luc2lkZS52ZXJ0aWNhbCkge1xuICAgICAgICAgICAgICAgIHBhcnRpY2xlLnBvc2l0aW9uLnkgPSBwb3MueTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHBhcnRpY2xlLnBvc2l0aW9uLnggPSBwb3MueDtcbiAgICAgICAgICAgIHBhcnRpY2xlLnBvc2l0aW9uLnkgPSBwb3MueTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgcHJvY2Vzc1JlcHVsc2UoZHg6IG51bWJlciwgZHk6IG51bWJlciwgZm9yY2U6IG51bWJlcik6IHZvaWQge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcjtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGNvbnRhaW5lci5vcHRpb25zO1xuICAgICAgICBjb25zdCBwYXJ0aWNsZSA9IHRoaXMucGFydGljbGU7XG4gICAgICAgIGNvbnN0IGYgPSBNYXRoLmF0YW4yKGR5LCBkeCk7XG5cbiAgICAgICAgcGFydGljbGUudmVsb2NpdHkuaG9yaXpvbnRhbCA9IGZvcmNlICogTWF0aC5jb3MoZik7XG4gICAgICAgIHBhcnRpY2xlLnZlbG9jaXR5LnZlcnRpY2FsID0gZm9yY2UgKiBNYXRoLnNpbihmKTtcblxuICAgICAgICBjb25zdCBvdXRNb2RlID0gb3B0aW9ucy5wYXJ0aWNsZXMubW92ZS5vdXRNb2RlO1xuXG4gICAgICAgIGlmIChvdXRNb2RlID09PSBPdXRNb2RlLmJvdW5jZSB8fCBvdXRNb2RlID09PSBPdXRNb2RlLmJvdW5jZUhvcml6b250YWwgfHwgb3V0TW9kZSA9PT0gT3V0TW9kZS5ib3VuY2VWZXJ0aWNhbCkge1xuICAgICAgICAgICAgY29uc3QgcG9zID0ge1xuICAgICAgICAgICAgICAgIHg6IHBhcnRpY2xlLnBvc2l0aW9uLnggKyBwYXJ0aWNsZS52ZWxvY2l0eS5ob3Jpem9udGFsLFxuICAgICAgICAgICAgICAgIHk6IHBhcnRpY2xlLnBvc2l0aW9uLnkgKyBwYXJ0aWNsZS52ZWxvY2l0eS52ZXJ0aWNhbCxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGlmIChvdXRNb2RlICE9PSBPdXRNb2RlLmJvdW5jZVZlcnRpY2FsKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBvcy54ICsgcGFydGljbGUucmFkaXVzID4gY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24ud2lkdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFydGljbGUudmVsb2NpdHkuaG9yaXpvbnRhbCA9IC1wYXJ0aWNsZS52ZWxvY2l0eS5ob3Jpem9udGFsO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocG9zLnggLSBwYXJ0aWNsZS5yYWRpdXMgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcnRpY2xlLnZlbG9jaXR5Lmhvcml6b250YWwgPSAtcGFydGljbGUudmVsb2NpdHkuaG9yaXpvbnRhbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChvdXRNb2RlICE9PSBPdXRNb2RlLmJvdW5jZUhvcml6b250YWwpIHtcbiAgICAgICAgICAgICAgICBpZiAocG9zLnkgKyBwYXJ0aWNsZS5yYWRpdXMgPiBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi5oZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFydGljbGUudmVsb2NpdHkudmVydGljYWwgPSAtcGFydGljbGUudmVsb2NpdHkudmVydGljYWw7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwb3MueSAtIHBhcnRpY2xlLnJhZGl1cyA8IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcGFydGljbGUudmVsb2NpdHkudmVydGljYWwgPSAtcGFydGljbGUudmVsb2NpdHkudmVydGljYWw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuIl19