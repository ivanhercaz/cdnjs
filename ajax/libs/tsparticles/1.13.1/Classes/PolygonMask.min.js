"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),PolygonMaskType_1=require("../Enums/PolygonMaskType"),Particle_1=require("./Particle"),PolygonMaskInlineArrangement_1=require("../Enums/PolygonMaskInlineArrangement"),Utils_1=require("./Utils/Utils"),Constants_1=require("./Utils/Constants"),PolygonMask=function(){function t(t){this.container=t,this.dimension={height:0,width:0},this.paths=[],this.path2DSupported=window.hasOwnProperty("Path2D")}return t.prototype.checkInsidePolygon=function(t){var n=this.container,e=n.options;if(!e.polygon.enable||e.polygon.type===PolygonMaskType_1.PolygonMaskType.none||e.polygon.type===PolygonMaskType_1.PolygonMaskType.inline)return!0;if(!this.raw)throw new Error(Constants_1.Constants.noPolygonFound);for(var o=t?t.x:Math.random()*n.canvas.size.width,a=t?t.y:Math.random()*n.canvas.size.height,i=!1,s=0,r=this.raw.length-1;s<this.raw.length;r=s++){var h=this.raw[s].x,l=this.raw[s].y,g=this.raw[r].x,y=this.raw[r].y;a<l!=a<y&&o<(g-h)*(a-l)/(y-l)+h&&(i=!i)}return e.polygon.type===PolygonMaskType_1.PolygonMaskType.inside?i:e.polygon.type===PolygonMaskType_1.PolygonMaskType.outside&&!i},t.prototype.redraw=function(){var n=this,e=this.container,t=e.options;t.polygon.enable&&t.polygon.type!==PolygonMaskType_1.PolygonMaskType.none&&(this.redrawTimeout&&clearTimeout(this.redrawTimeout),this.redrawTimeout=window.setTimeout(function(){n.parseSvgPathToPolygon().then(function(t){n.raw=t,n.createPath2D(),e.particles.redraw()})},250))},t.prototype.init=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var n,e,o;return tslib_1.__generator(this,function(t){switch(t.label){case 0:return(n=this.container,(e=n.options).polygon.enable&&e.polygon.url)?[4,(o=this).parseSvgPathToPolygon(e.polygon.url)]:[3,2];case 1:o.raw=t.sent(),this.createPath2D(),t.label=2;case 2:return[2]}})})},t.prototype.reset=function(){delete this.raw,this.paths=[],delete this.svg},t.prototype.randomPointInPolygon=function(){var t,n=this.container,e=n.options;if(e.polygon.type===PolygonMaskType_1.PolygonMaskType.inline)switch(e.polygon.inline.arrangement){case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.randomPoint:t=this.getRandomPointOnPolygonPath();break;case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.randomLength:t=this.getRandomPointOnPolygonPathByLength();break;case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.equidistant:t=this.getEquidistantPointOnPolygonPathByIndex(n.particles.count);break;case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.onePerPoint:case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.perPoint:default:t=this.getPointOnPolygonPathByIndex(n.particles.count)}else t={x:Math.random()*n.canvas.size.width,y:Math.random()*n.canvas.size.height};return this.checkInsidePolygon(t)?t:this.randomPointInPolygon()},t.prototype.parseSvgPathToPolygon=function(m){var E;return tslib_1.__awaiter(this,void 0,void 0,function(){var n,e,o,a,i,s,r,h,l,g,y,P,d,p,c,w,u,_,S,T,v;return tslib_1.__generator(this,function(t){switch(t.label){case 0:return n=this.container,e=n.options,o=m||e.polygon.url,this.paths.length&&this.svg?[3,4]:[4,fetch(o)];case 1:return(a=t.sent()).ok?[4,a.text()]:[3,3];case 2:for(i=t.sent(),s=new DOMParser,r=s.parseFromString(i,"image/svg+xml"),this.svg=r.getElementsByTagName("svg")[0],h=r.getElementsByTagName("path"),_=0;_<h.length;_++)(c=h.item(_))&&this.paths.push({element:c,length:c.getTotalLength()});return[3,4];case 3:throw new Error("tsParticles Error - Error occurred during polygon mask download");case 4:for(l=n.retina.pixelRatio,g=e.polygon.scale/l,this.dimension.width=parseFloat(this.svg.getAttribute("width")||"0")*g,this.dimension.height=parseFloat(this.svg.getAttribute("height")||"0")*g,y=null!==(E=e.polygon.position)&&void 0!==E?E:{x:50,y:50},this.offset={x:n.canvas.size.width*y.x/(100*l)-this.dimension.width/2,y:n.canvas.size.height*y.y/(100*l)-this.dimension.height/2},P=[],d=0,p=this.paths;d<p.length;d++)for(c=p[d],w=c.element.pathSegList.numberOfItems,u={x:0,y:0},_=0;_<w;_++){switch((S=c.element.pathSegList.getItem(_)).pathSegType){case window.SVGPathSeg.PATHSEG_MOVETO_ABS:case window.SVGPathSeg.PATHSEG_LINETO_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_ABS:case window.SVGPathSeg.PATHSEG_ARC_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_ABS:T=S,u.x=T.x,u.y=T.y;break;case window.SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_ABS:u.x=S.x;break;case window.SVGPathSeg.PATHSEG_LINETO_VERTICAL_ABS:u.y=S.y;break;case window.SVGPathSeg.PATHSEG_LINETO_REL:case window.SVGPathSeg.PATHSEG_MOVETO_REL:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_REL:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_REL:case window.SVGPathSeg.PATHSEG_ARC_REL:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_REL:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_REL:v=S,u.x+=v.x,u.y+=v.y;break;case window.SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_REL:u.x+=S.x;break;case window.SVGPathSeg.PATHSEG_LINETO_VERTICAL_REL:u.y+=S.y;break;case window.SVGPathSeg.PATHSEG_UNKNOWN:case window.SVGPathSeg.PATHSEG_CLOSEPATH:continue}P.push({x:u.x*g+this.offset.x,y:u.y*g+this.offset.y})}return[2,P]}})})},t.prototype.drawPolygon=function(){this.container.canvas.drawPolygonMask()},t.prototype.drawPointsOnPolygonPath=function(){var t=this.container;if(this.raw)for(var n=0,e=this.raw;n<e.length;n++){var o=e[n],a={x:o.x,y:o.y};t.particles.addParticle(new Particle_1.Particle(t,a))}},t.prototype.getRandomPointOnPolygonPath=function(){if(!this.raw||!this.raw.length)throw new Error(Constants_1.Constants.noPolygonDataLoaded);var t=Utils_1.Utils.itemFromArray(this.raw);return{x:t.x,y:t.y}},t.prototype.getRandomPointOnPolygonPathByLength=function(){var t,n,e=this.container.options;if(!this.raw||!this.raw.length||!this.paths.length)throw new Error(Constants_1.Constants.noPolygonDataLoaded);var o=Utils_1.Utils.itemFromArray(this.paths),a=Math.floor(Math.random()*o.length)+1,i=o.element.getPointAtLength(a);return{x:i.x*e.polygon.scale+((null===(t=this.offset)||void 0===t?void 0:t.x)||0),y:i.y*e.polygon.scale+((null===(n=this.offset)||void 0===n?void 0:n.y)||0)}},t.prototype.getEquidistantPointOnPolygonPathByIndex=function(t){var n,e,o,a,i,s,r=this.container.options;if(!this.raw||!this.raw.length||!this.paths.length)throw new Error(Constants_1.Constants.noPolygonDataLoaded);for(var h,l=0,g=this.paths.reduce(function(t,n){return t+n.length},0)/r.particles.number.value,y=0,P=this.paths;y<P.length;y++){var d=P[y],p=g*t-l;if(p<=d.length){h=d.element.getPointAtLength(p);break}l+=d.length}return{x:(null!==(n=null==h?void 0:h.x)&&void 0!==n?n:0)*r.polygon.scale+(null!==(o=null===(e=this.offset)||void 0===e?void 0:e.x)&&void 0!==o?o:0),y:(null!==(a=null==h?void 0:h.y)&&void 0!==a?a:0)*r.polygon.scale+(null!==(s=null===(i=this.offset)||void 0===i?void 0:i.y)&&void 0!==s?s:0)}},t.prototype.getPointOnPolygonPathByIndex=function(t){if(!this.raw||!this.raw.length)throw new Error(Constants_1.Constants.noPolygonDataLoaded);var n=this.raw[t%this.raw.length];return{x:n.x,y:n.y}},t.prototype.createPath2D=function(){var s;if(this.path2DSupported)for(var t=function(o){var t=null===(s=o.element)||void 0===s?void 0:s.getAttribute("d");if(t){var n=new Path2D(t),e=document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGMatrix(),a=new Path2D,i=e.scale(r.container.options.polygon.scale);a.addPath?(a.addPath(n,i),o.path2d=a):delete o.path2d}else delete o.path2d;!o.path2d&&r.raw&&(o.path2d=new Path2D,o.path2d.moveTo(r.raw[0].x,r.raw[0].y),r.raw.forEach(function(t,n){var e;0<n&&null!==(e=o.path2d)&&void 0!==e&&e.lineTo(t.x,t.y)}),o.path2d.closePath())},r=this,n=0,e=this.paths;n<e.length;n++){t(e[n])}},t}();exports.PolygonMask=PolygonMask;