"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ClickMode_1=require("../../Enums/Modes/ClickMode"),InteractivityDetect_1=require("../../Enums/InteractivityDetect"),PolygonMaskType_1=require("../../Enums/PolygonMaskType"),Constants_1=require("./Constants"),Emitter_1=require("../Emitter"),Utils_1=require("./Utils"),EventListeners=function(){function s(e){var t=this;this.container=e,this.canPush=!0,this.mouseMoveHandler=function(e){return t.mouseTouchMove(e)},this.touchStartHandler=function(e){return t.mouseTouchMove(e)},this.touchMoveHandler=function(e){return t.mouseTouchMove(e)},this.touchEndHandler=function(){return t.mouseTouchFinish()},this.mouseLeaveHandler=function(){return t.mouseTouchFinish()},this.touchCancelHandler=function(){return t.mouseTouchFinish()},this.touchEndClickHandler=function(e){return t.mouseTouchClick(e)},this.mouseUpHandler=function(e){return t.mouseTouchClick(e)},this.visibilityChangeHandler=function(){return t.handleVisibilityChange()},this.resizeHandler=function(){return t.handleWindowResize()}}return s.manageListener=function(e,t,i,n,o){n?s.addListener(e,t,i,o):s.removeListener(e,t,i,o)},s.addListener=function(e,t,i,n){e.addEventListener(t,i,n)},s.removeListener=function(e,t,i,n){e.removeEventListener(t,i,n)},s.prototype.addListeners=function(){this.manageListeners(!0)},s.prototype.removeListeners=function(){this.manageListeners(!1)},s.prototype.manageListeners=function(e){var t=this.container,i=t.options;i.interactivity.detectsOn===InteractivityDetect_1.InteractivityDetect.window?t.interactivity.element=window:i.interactivity.detectsOn===InteractivityDetect_1.InteractivityDetect.parent&&t.canvas.element?t.interactivity.element=t.canvas.element.parentNode:t.interactivity.element=t.canvas.element;var n=t.interactivity.element;n&&(i.interactivity.events.onHover.enable||i.interactivity.events.onClick.enable)&&(s.manageListener(n,Constants_1.Constants.mouseMoveEvent,this.mouseMoveHandler,e),s.manageListener(n,Constants_1.Constants.touchStartEvent,this.touchStartHandler,e),s.manageListener(n,Constants_1.Constants.touchMoveEvent,this.touchMoveHandler,e),i.interactivity.events.onClick.enable||s.manageListener(n,Constants_1.Constants.touchEndEvent,this.touchEndHandler,e),s.manageListener(n,Constants_1.Constants.mouseLeaveEvent,this.mouseLeaveHandler,e),s.manageListener(n,Constants_1.Constants.touchCancelEvent,this.touchCancelHandler,e)),i.interactivity.events.onClick.enable&&n&&(s.manageListener(n,Constants_1.Constants.touchEndEvent,this.touchEndClickHandler,e),s.manageListener(n,Constants_1.Constants.mouseUpEvent,this.mouseUpHandler,e)),i.interactivity.events.resize&&s.manageListener(window,Constants_1.Constants.resizeEvent,this.resizeHandler,e),document&&s.manageListener(document,Constants_1.Constants.visibilityChangeEvent,this.visibilityChangeHandler,e,!1)},s.prototype.handleWindowResize=function(){var e=this.container,t=e.options;if(e.canvas.element){e.canvas.dimension.width=e.canvas.element.offsetWidth,e.canvas.dimension.height=e.canvas.element.offsetHeight,e.retina.isRetina&&(e.canvas.dimension.width*=e.retina.pixelRatio,e.canvas.dimension.height*=e.retina.pixelRatio),e.canvas.element.width=e.canvas.dimension.width,e.canvas.element.height=e.canvas.dimension.height,t.particles.move.enable||e.particles.redraw(),e.densityAutoParticles();for(var i=0,n=e.emitters;i<n.length;i++){n[i].resize()}e.polygon.redraw()}},s.prototype.handleVisibilityChange=function(){var e=this.container;e.options.pauseOnBlur&&(null!==document&&void 0!==document&&document.hidden?(e.pageHidden=!0,e.pause()):(e.pageHidden=!1,e.play()))},s.prototype.mouseTouchMove=function(e){var t,i,n,o,s,a=this.container,r=a.options;if(e.type.startsWith("mouse")){this.canPush=!0;var c=e;if(void 0===(null===(t=a.interactivity)||void 0===t?void 0:t.element))return;if(a.interactivity.element===window){if(a.canvas.element){var l=a.canvas.element.getBoundingClientRect();s={x:c.clientX-l.left,y:c.clientY-l.top}}}else if(r.interactivity.detectsOn===InteractivityDetect_1.InteractivityDetect.parent){var u=c.target,v=c.currentTarget;if(u&&v){var h=u.getBoundingClientRect(),d=v.getBoundingClientRect();s={x:c.offsetX+h.left-d.left,y:c.offsetY+h.top-d.top}}else s={x:c.offsetX||c.clientX,y:c.offsetY||c.clientY}}else c.target===a.canvas.element&&(s={x:c.offsetX||c.clientX,y:c.offsetY||c.clientY})}else{this.canPush="touchmove"!==e.type;var m=e.touches[e.touches.length-1],y=null===(i=a.canvas.element)||void 0===i?void 0:i.getBoundingClientRect();s={x:m.clientX-(null!==(n=null==y?void 0:y.left)&&void 0!==n?n:0),y:m.clientY-(null!==(o=null==y?void 0:y.top)&&void 0!==o?o:0)}}a.interactivity.mouse.position=s,a.retina.isRetina&&a.interactivity.mouse.position&&(a.interactivity.mouse.position.x*=a.retina.pixelRatio,a.interactivity.mouse.position.y*=a.retina.pixelRatio),a.interactivity.status=Constants_1.Constants.mouseMoveEvent},s.prototype.mouseTouchFinish=function(){var e=this.container;delete e.interactivity.mouse.position,e.interactivity.status=Constants_1.Constants.mouseLeaveEvent},s.prototype.mouseTouchClick=function(e){var t=this.container,i=t.options;void 0===i.polygon||i.polygon.enable&&i.polygon.type!==PolygonMaskType_1.PolygonMaskType.none&&i.polygon.type!==PolygonMaskType_1.PolygonMaskType.inline&&!t.polygon.checkInsidePolygon(t.interactivity.mouse.position)||this.doMouseTouchClick(e)},s.prototype.doMouseTouchClick=function(e){var t=this,i=this.container,n=i.options;if(this.canPush){if(!i.interactivity.mouse.position)return;i.interactivity.mouse.clickPosition={x:i.interactivity.mouse.position.x,y:i.interactivity.mouse.position.y},i.interactivity.mouse.clickTime=(new Date).getTime();var o=n.interactivity.modes.push.quantity,s=n.interactivity.modes.remove.quantity;switch(n.interactivity.events.onClick.mode){case ClickMode_1.ClickMode.push:n.particles.move.enable||1===n.interactivity.modes.push.quantity?i.particles.push(o,i.interactivity.mouse):1<n.interactivity.modes.push.quantity&&i.particles.push(o);break;case ClickMode_1.ClickMode.remove:i.particles.removeQuantity(s);break;case ClickMode_1.ClickMode.bubble:i.bubble.clicking=!0;break;case ClickMode_1.ClickMode.repulse:i.repulse.clicking=!0;for(var a=i.repulse.count=0,r=i.repulse.particles;a<r.length;a++){var c=r[a];c.velocity.horizontal=c.initialVelocity.horizontal,c.velocity.vertical=c.initialVelocity.vertical}i.repulse.particles=[],i.repulse.finish=!1,setTimeout(function(){i.destroyed||(i.repulse.clicking=!1)},1e3*n.interactivity.modes.repulse.duration);break;case ClickMode_1.ClickMode.emitter:var l=void 0,u=n.interactivity.modes.emitters;u instanceof Array?0<u.length&&(l=Utils_1.Utils.itemFromArray(u)):l=u;var v=null!=l?l:n.emitters instanceof Array?Utils_1.Utils.itemFromArray(n.emitters):n.emitters,h=i.interactivity.mouse.clickPosition,d=new Emitter_1.Emitter(i,v,h);i.emitters.push(d)}}e.preventDefault(),"touchend"===e.type&&setTimeout(function(){return t.mouseTouchFinish()},500),e.preventDefault()},s}();exports.EventListeners=EventListeners;