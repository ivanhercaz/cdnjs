"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Bubbler = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _ProcessBubbleType = require("../../Enums/ProcessBubbleType");

var _Utils = require("../Utils/Utils");

var _HoverMode = require("../../Enums/Modes/HoverMode");

var _ClickMode = require("../../Enums/Modes/ClickMode");

/**
 * Particle bubble manager
 */
var Bubbler = /*#__PURE__*/function () {
  function Bubbler(container, particle) {
    (0, _classCallCheck2["default"])(this, Bubbler);
    this.opacity = void 0;
    this.radius = void 0;
    this.particle = void 0;
    this.container = void 0;
    this.container = container;
    this.particle = particle;
  }

  (0, _createClass2["default"])(Bubbler, [{
    key: "bubble",
    value: function bubble() {
      var container = this.container;
      var options = container.options;
      var hoverEnabled = options.interactivity.events.onHover.enable;
      var hoverMode = options.interactivity.events.onHover.mode;
      var clickEnabled = options.interactivity.events.onClick.enable;
      var clickMode = options.interactivity.events.onClick.mode;
      /* on hover event */

      if (hoverEnabled && _Utils.Utils.isInArray(_HoverMode.HoverMode.bubble, hoverMode)) {
        this.hoverBubble();
      } else if (clickEnabled && _Utils.Utils.isInArray(_ClickMode.ClickMode.bubble, clickMode)) {
        this.clickBubble();
      }
    }
  }, {
    key: "init",
    value: function init() {
      var particle = this.particle;
      this.opacity = particle.opacity.value;
      this.radius = particle.radius;
    }
  }, {
    key: "process",
    value: function process(distMouse, timeSpent, data) {
      var container = this.container;
      var options = container.options;
      var bubbleDuration = options.interactivity.modes.bubble.duration;
      var bubbleParam = data.bubbleObj.optValue;
      var bubbleDistance = container.retina.bubbleModeDistance;
      var particlesParam = data.particlesObj.optValue;
      var pObjBubble = data.bubbleObj.value;
      var pObj = data.particlesObj.value || 0;
      var type = data.type;

      if (bubbleParam !== particlesParam) {
        if (!container.bubble.durationEnd) {
          if (distMouse <= bubbleDistance) {
            var obj;

            if (pObjBubble) {
              obj = pObjBubble;
            } else {
              obj = pObj;
            }

            if (obj !== bubbleParam) {
              var value = pObj - timeSpent * (pObj - bubbleParam) / bubbleDuration;

              if (type === _ProcessBubbleType.ProcessBubbleType.size) {
                this.radius = value;
              }

              if (type === _ProcessBubbleType.ProcessBubbleType.opacity) {
                this.opacity = value;
              }
            }
          } else {
            if (type === _ProcessBubbleType.ProcessBubbleType.size) {
              this.radius = undefined;
            }

            if (type === _ProcessBubbleType.ProcessBubbleType.opacity) {
              this.opacity = undefined;
            }
          }
        } else if (pObjBubble) {
          var tmpValue = pObj - timeSpent * (pObj - bubbleParam) / bubbleDuration;
          var dif = bubbleParam - tmpValue;

          var _value = bubbleParam + dif;

          if (type === _ProcessBubbleType.ProcessBubbleType.size) {
            this.radius = _value;
          }

          if (type === _ProcessBubbleType.ProcessBubbleType.opacity) {
            this.opacity = _value;
          }
        }
      }
    }
  }, {
    key: "clickBubble",
    value: function clickBubble() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;
      /* on click event */

      var mouseClickPos = container.interactivity.mouse.clickPosition || {
        x: 0,
        y: 0
      };

      var distMouse = _Utils.Utils.getDistanceBetweenCoordinates(particle.position, mouseClickPos);

      var timeSpent = (new Date().getTime() - (container.interactivity.mouse.clickTime || 0)) / 1000;

      if (container.bubble.clicking) {
        if (timeSpent > options.interactivity.modes.bubble.duration) {
          container.bubble.durationEnd = true;
        }

        if (timeSpent > options.interactivity.modes.bubble.duration * 2) {
          container.bubble.clicking = false;
          container.bubble.durationEnd = false;
        }
      }

      if (container.bubble.clicking) {
        /* size */
        var sizeData = {
          bubbleObj: {
            optValue: container.retina.bubbleModeSize,
            value: this.radius
          },
          particlesObj: {
            optValue: container.retina.sizeValue,
            value: this.particle.radius
          },
          type: _ProcessBubbleType.ProcessBubbleType.size
        };
        this.process(distMouse, timeSpent, sizeData);
        /* opacity */

        var opacityData = {
          bubbleObj: {
            optValue: options.interactivity.modes.bubble.opacity,
            value: this.opacity
          },
          particlesObj: {
            optValue: options.particles.opacity.value,
            value: this.particle.opacity.value
          },
          type: _ProcessBubbleType.ProcessBubbleType.opacity
        };
        this.process(distMouse, timeSpent, opacityData);
      }
    }
  }, {
    key: "hoverBubble",
    value: function hoverBubble() {
      var container = this.container;
      var particle = this.particle;
      var mousePos = container.interactivity.mouse.position || {
        x: 0,
        y: 0
      };

      var distMouse = _Utils.Utils.getDistanceBetweenCoordinates(particle.position, mousePos);

      var ratio = 1 - distMouse / container.retina.bubbleModeDistance;
      /* mousemove - check ratio */

      if (distMouse <= container.retina.bubbleModeDistance) {
        if (ratio >= 0 && container.interactivity.status === "mousemove") {
          /* size */
          this.hoverBubbleSize(ratio);
          /* opacity */

          this.hoverBubbleOpacity(ratio);
        }
      } else {
        this.init();
      }
      /* mouseleave */


      if (container.interactivity.status === "mouseleave") {
        this.init();
      }
    }
  }, {
    key: "hoverBubbleSize",
    value: function hoverBubbleSize(ratio) {
      var container = this.container;
      var particle = this.particle;

      if (container.retina.bubbleModeSize !== container.retina.sizeValue) {
        if (container.retina.bubbleModeSize > container.retina.sizeValue) {
          var size = particle.radius + container.retina.bubbleModeSize * ratio;

          if (size >= 0) {
            this.radius = size;
          }
        } else {
          var dif = particle.radius - container.retina.bubbleModeSize;

          var _size = particle.radius - dif * ratio;

          if (_size > 0) {
            this.radius = _size;
          } else {
            this.radius = 0;
          }
        }
      }
    }
  }, {
    key: "hoverBubbleOpacity",
    value: function hoverBubbleOpacity(ratio) {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;
      var modeOpacity = options.interactivity.modes.bubble.opacity;
      var optOpacity = options.particles.opacity.value;
      var pOpacity = particle.opacity.value;

      if (modeOpacity !== optOpacity) {
        if (modeOpacity > optOpacity) {
          var opacity = options.interactivity.modes.bubble.opacity * ratio;

          if (opacity > pOpacity && opacity <= modeOpacity) {
            this.opacity = opacity;
          }
        } else {
          var _opacity = pOpacity - (optOpacity - modeOpacity) * ratio;

          if (_opacity < pOpacity && _opacity >= modeOpacity) {
            this.opacity = _opacity;
          }
        }
      }
    }
  }]);
  return Bubbler;
}();

exports.Bubbler = Bubbler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9DbGFzc2VzL1BhcnRpY2xlL0J1YmJsZXIudHMiXSwibmFtZXMiOlsiQnViYmxlciIsImNvbnRhaW5lciIsInBhcnRpY2xlIiwib3BhY2l0eSIsInJhZGl1cyIsIm9wdGlvbnMiLCJob3ZlckVuYWJsZWQiLCJpbnRlcmFjdGl2aXR5IiwiZXZlbnRzIiwib25Ib3ZlciIsImVuYWJsZSIsImhvdmVyTW9kZSIsIm1vZGUiLCJjbGlja0VuYWJsZWQiLCJvbkNsaWNrIiwiY2xpY2tNb2RlIiwiVXRpbHMiLCJpc0luQXJyYXkiLCJIb3Zlck1vZGUiLCJidWJibGUiLCJob3ZlckJ1YmJsZSIsIkNsaWNrTW9kZSIsImNsaWNrQnViYmxlIiwidmFsdWUiLCJkaXN0TW91c2UiLCJ0aW1lU3BlbnQiLCJkYXRhIiwiYnViYmxlRHVyYXRpb24iLCJtb2RlcyIsImR1cmF0aW9uIiwiYnViYmxlUGFyYW0iLCJidWJibGVPYmoiLCJvcHRWYWx1ZSIsImJ1YmJsZURpc3RhbmNlIiwicmV0aW5hIiwiYnViYmxlTW9kZURpc3RhbmNlIiwicGFydGljbGVzUGFyYW0iLCJwYXJ0aWNsZXNPYmoiLCJwT2JqQnViYmxlIiwicE9iaiIsInR5cGUiLCJkdXJhdGlvbkVuZCIsIm9iaiIsIlByb2Nlc3NCdWJibGVUeXBlIiwic2l6ZSIsInVuZGVmaW5lZCIsInRtcFZhbHVlIiwiZGlmIiwibW91c2VDbGlja1BvcyIsIm1vdXNlIiwiY2xpY2tQb3NpdGlvbiIsIngiLCJ5IiwiZ2V0RGlzdGFuY2VCZXR3ZWVuQ29vcmRpbmF0ZXMiLCJwb3NpdGlvbiIsIkRhdGUiLCJnZXRUaW1lIiwiY2xpY2tUaW1lIiwiY2xpY2tpbmciLCJzaXplRGF0YSIsImJ1YmJsZU1vZGVTaXplIiwic2l6ZVZhbHVlIiwicHJvY2VzcyIsIm9wYWNpdHlEYXRhIiwicGFydGljbGVzIiwibW91c2VQb3MiLCJyYXRpbyIsInN0YXR1cyIsImhvdmVyQnViYmxlU2l6ZSIsImhvdmVyQnViYmxlT3BhY2l0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RCxLQUE3RDs7QUFFQSxjQUFJL0QsT0FBTyxHQUFHc0UsUUFBVixJQUFzQnRFLE9BQU8sSUFBSW9FLFdBQXJDLEVBQWtEO0FBQzlDLGlCQUFLcEUsT0FBTCxHQUFlQSxPQUFmO0FBQ0g7QUFDSixTQU5ELE1BTU87QUFDSCxjQUFNQSxRQUFPLEdBQUdzRSxRQUFRLEdBQUcsQ0FBQ0QsVUFBVSxHQUFHRCxXQUFkLElBQTZCTCxLQUF4RDs7QUFFQSxjQUFJL0QsUUFBTyxHQUFHc0UsUUFBVixJQUFzQnRFLFFBQU8sSUFBSW9FLFdBQXJDLEVBQWtEO0FBQzlDLGlCQUFLcEUsT0FBTCxHQUFlQSxRQUFmO0FBQ0g7QUFDSjtBQUNKO0FBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IHtDb250YWluZXJ9IGZyb20gXCIuLi9Db250YWluZXJcIjtcbmltcG9ydCB7SUJ1YmJsZXJQcm9jZXNzUGFyYW19IGZyb20gXCIuLi8uLi9JbnRlcmZhY2VzL0lCdWJibGVyUHJvY2Vzc1BhcmFtXCI7XG5pbXBvcnQge1BhcnRpY2xlfSBmcm9tIFwiLi4vUGFydGljbGVcIjtcbmltcG9ydCB7UHJvY2Vzc0J1YmJsZVR5cGV9IGZyb20gXCIuLi8uLi9FbnVtcy9Qcm9jZXNzQnViYmxlVHlwZVwiO1xuaW1wb3J0IHtVdGlsc30gZnJvbSBcIi4uL1V0aWxzL1V0aWxzXCI7XG5pbXBvcnQge0hvdmVyTW9kZX0gZnJvbSBcIi4uLy4uL0VudW1zL01vZGVzL0hvdmVyTW9kZVwiO1xuaW1wb3J0IHtDbGlja01vZGV9IGZyb20gXCIuLi8uLi9FbnVtcy9Nb2Rlcy9DbGlja01vZGVcIjtcblxuLyoqXG4gKiBQYXJ0aWNsZSBidWJibGUgbWFuYWdlclxuICovXG5leHBvcnQgY2xhc3MgQnViYmxlciB7XG4gICAgcHVibGljIG9wYWNpdHk/OiBudW1iZXI7XG4gICAgcHVibGljIHJhZGl1cz86IG51bWJlcjtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgcGFydGljbGU6IFBhcnRpY2xlO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgY29udGFpbmVyOiBDb250YWluZXI7XG5cbiAgICBjb25zdHJ1Y3Rvcihjb250YWluZXI6IENvbnRhaW5lciwgcGFydGljbGU6IFBhcnRpY2xlKSB7XG4gICAgICAgIHRoaXMuY29udGFpbmVyID0gY29udGFpbmVyO1xuICAgICAgICB0aGlzLnBhcnRpY2xlID0gcGFydGljbGU7XG4gICAgfVxuXG4gICAgcHVibGljIGJ1YmJsZSgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jb250YWluZXI7XG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSBjb250YWluZXIub3B0aW9ucztcbiAgICAgICAgY29uc3QgaG92ZXJFbmFibGVkID0gb3B0aW9ucy5pbnRlcmFjdGl2aXR5LmV2ZW50cy5vbkhvdmVyLmVuYWJsZTtcbiAgICAgICAgY29uc3QgaG92ZXJNb2RlID0gb3B0aW9ucy5pbnRlcmFjdGl2aXR5LmV2ZW50cy5vbkhvdmVyLm1vZGU7XG4gICAgICAgIGNvbnN0IGNsaWNrRW5hYmxlZCA9IG9wdGlvbnMuaW50ZXJhY3Rpdml0eS5ldmVudHMub25DbGljay5lbmFibGU7XG4gICAgICAgIGNvbnN0IGNsaWNrTW9kZSA9IG9wdGlvbnMuaW50ZXJhY3Rpdml0eS5ldmVudHMub25DbGljay5tb2RlO1xuXG4gICAgICAgIC8qIG9uIGhvdmVyIGV2ZW50ICovXG4gICAgICAgIGlmIChob3ZlckVuYWJsZWQgJiYgVXRpbHMuaXNJbkFycmF5KEhvdmVyTW9kZS5idWJibGUsIGhvdmVyTW9kZSkpIHtcbiAgICAgICAgICAgIHRoaXMuaG92ZXJCdWJibGUoKTtcbiAgICAgICAgfSBlbHNlIGlmIChjbGlja0VuYWJsZWQgJiYgVXRpbHMuaXNJbkFycmF5KENsaWNrTW9kZS5idWJibGUsIGNsaWNrTW9kZSkpIHtcbiAgICAgICAgICAgIHRoaXMuY2xpY2tCdWJibGUoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaW5pdCgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgcGFydGljbGUgPSB0aGlzLnBhcnRpY2xlO1xuXG4gICAgICAgIHRoaXMub3BhY2l0eSA9IHBhcnRpY2xlLm9wYWNpdHkudmFsdWU7XG4gICAgICAgIHRoaXMucmFkaXVzID0gcGFydGljbGUucmFkaXVzO1xuICAgIH1cblxuICAgIHByaXZhdGUgcHJvY2VzcyhkaXN0TW91c2U6IG51bWJlciwgdGltZVNwZW50OiBudW1iZXIsIGRhdGE6IElCdWJibGVyUHJvY2Vzc1BhcmFtKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyO1xuICAgICAgICBjb25zdCBvcHRpb25zID0gY29udGFpbmVyLm9wdGlvbnM7XG4gICAgICAgIGNvbnN0IGJ1YmJsZUR1cmF0aW9uID0gb3B0aW9ucy5pbnRlcmFjdGl2aXR5Lm1vZGVzLmJ1YmJsZS5kdXJhdGlvbjtcbiAgICAgICAgY29uc3QgYnViYmxlUGFyYW0gPSBkYXRhLmJ1YmJsZU9iai5vcHRWYWx1ZTtcbiAgICAgICAgY29uc3QgYnViYmxlRGlzdGFuY2UgPSBjb250YWluZXIucmV0aW5hLmJ1YmJsZU1vZGVEaXN0YW5jZTtcbiAgICAgICAgY29uc3QgcGFydGljbGVzUGFyYW0gPSBkYXRhLnBhcnRpY2xlc09iai5vcHRWYWx1ZTtcbiAgICAgICAgY29uc3QgcE9iakJ1YmJsZSA9IGRhdGEuYnViYmxlT2JqLnZhbHVlO1xuICAgICAgICBjb25zdCBwT2JqID0gZGF0YS5wYXJ0aWNsZXNPYmoudmFsdWUgfHwgMDtcbiAgICAgICAgY29uc3QgdHlwZSA9IGRhdGEudHlwZTtcblxuICAgICAgICBpZiAoYnViYmxlUGFyYW0gIT09IHBhcnRpY2xlc1BhcmFtKSB7XG4gICAgICAgICAgICBpZiAoIWNvbnRhaW5lci5idWJibGUuZHVyYXRpb25FbmQpIHtcbiAgICAgICAgICAgICAgICBpZiAoZGlzdE1vdXNlIDw9IGJ1YmJsZURpc3RhbmNlKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBvYmo7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHBPYmpCdWJibGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9iaiA9IHBPYmpCdWJibGU7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvYmogPSBwT2JqO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKG9iaiAhPT0gYnViYmxlUGFyYW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gcE9iaiAtICh0aW1lU3BlbnQgKiAocE9iaiAtIGJ1YmJsZVBhcmFtKSAvIGJ1YmJsZUR1cmF0aW9uKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IFByb2Nlc3NCdWJibGVUeXBlLnNpemUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJhZGl1cyA9IHZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gUHJvY2Vzc0J1YmJsZVR5cGUub3BhY2l0eSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3BhY2l0eSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IFByb2Nlc3NCdWJibGVUeXBlLnNpemUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmFkaXVzID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IFByb2Nlc3NCdWJibGVUeXBlLm9wYWNpdHkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3BhY2l0eSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAocE9iakJ1YmJsZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRtcFZhbHVlID0gcE9iaiAtICh0aW1lU3BlbnQgKiAocE9iaiAtIGJ1YmJsZVBhcmFtKSAvIGJ1YmJsZUR1cmF0aW9uKTtcbiAgICAgICAgICAgICAgICBjb25zdCBkaWYgPSBidWJibGVQYXJhbSAtIHRtcFZhbHVlO1xuICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gYnViYmxlUGFyYW0gKyBkaWY7XG5cbiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gUHJvY2Vzc0J1YmJsZVR5cGUuc2l6ZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJhZGl1cyA9IHZhbHVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSBQcm9jZXNzQnViYmxlVHlwZS5vcGFjaXR5KSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMub3BhY2l0eSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgY2xpY2tCdWJibGUoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyO1xuICAgICAgICBjb25zdCBvcHRpb25zID0gY29udGFpbmVyLm9wdGlvbnM7XG4gICAgICAgIGNvbnN0IHBhcnRpY2xlID0gdGhpcy5wYXJ0aWNsZTtcblxuICAgICAgICAvKiBvbiBjbGljayBldmVudCAqL1xuICAgICAgICBjb25zdCBtb3VzZUNsaWNrUG9zID0gY29udGFpbmVyLmludGVyYWN0aXZpdHkubW91c2UuY2xpY2tQb3NpdGlvbiB8fCB7eDogMCwgeTogMH07XG4gICAgICAgIGNvbnN0IGRpc3RNb3VzZSA9IFV0aWxzLmdldERpc3RhbmNlQmV0d2VlbkNvb3JkaW5hdGVzKHBhcnRpY2xlLnBvc2l0aW9uLCBtb3VzZUNsaWNrUG9zKTtcbiAgICAgICAgY29uc3QgdGltZVNwZW50ID0gKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gKGNvbnRhaW5lci5pbnRlcmFjdGl2aXR5Lm1vdXNlLmNsaWNrVGltZSB8fCAwKSkgLyAxMDAwO1xuXG4gICAgICAgIGlmIChjb250YWluZXIuYnViYmxlLmNsaWNraW5nKSB7XG4gICAgICAgICAgICBpZiAodGltZVNwZW50ID4gb3B0aW9ucy5pbnRlcmFjdGl2aXR5Lm1vZGVzLmJ1YmJsZS5kdXJhdGlvbikge1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5idWJibGUuZHVyYXRpb25FbmQgPSB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAodGltZVNwZW50ID4gb3B0aW9ucy5pbnRlcmFjdGl2aXR5Lm1vZGVzLmJ1YmJsZS5kdXJhdGlvbiAqIDIpIHtcbiAgICAgICAgICAgICAgICBjb250YWluZXIuYnViYmxlLmNsaWNraW5nID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyLmJ1YmJsZS5kdXJhdGlvbkVuZCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbnRhaW5lci5idWJibGUuY2xpY2tpbmcpIHtcbiAgICAgICAgICAgIC8qIHNpemUgKi9cbiAgICAgICAgICAgIGNvbnN0IHNpemVEYXRhOiBJQnViYmxlclByb2Nlc3NQYXJhbSA9IHtcbiAgICAgICAgICAgICAgICBidWJibGVPYmo6IHtcbiAgICAgICAgICAgICAgICAgICAgb3B0VmFsdWU6IGNvbnRhaW5lci5yZXRpbmEuYnViYmxlTW9kZVNpemUsXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiB0aGlzLnJhZGl1cyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHBhcnRpY2xlc09iajoge1xuICAgICAgICAgICAgICAgICAgICBvcHRWYWx1ZTogY29udGFpbmVyLnJldGluYS5zaXplVmFsdWUsXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiB0aGlzLnBhcnRpY2xlLnJhZGl1cyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHR5cGU6IFByb2Nlc3NCdWJibGVUeXBlLnNpemUsXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICB0aGlzLnByb2Nlc3MoZGlzdE1vdXNlLCB0aW1lU3BlbnQsIHNpemVEYXRhKTtcblxuICAgICAgICAgICAgLyogb3BhY2l0eSAqL1xuICAgICAgICAgICAgY29uc3Qgb3BhY2l0eURhdGE6IElCdWJibGVyUHJvY2Vzc1BhcmFtID0ge1xuICAgICAgICAgICAgICAgIGJ1YmJsZU9iajoge1xuICAgICAgICAgICAgICAgICAgICBvcHRWYWx1ZTogb3B0aW9ucy5pbnRlcmFjdGl2aXR5Lm1vZGVzLmJ1YmJsZS5vcGFjaXR5LFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdGhpcy5vcGFjaXR5LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgcGFydGljbGVzT2JqOiB7XG4gICAgICAgICAgICAgICAgICAgIG9wdFZhbHVlOiBvcHRpb25zLnBhcnRpY2xlcy5vcGFjaXR5LnZhbHVlLFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdGhpcy5wYXJ0aWNsZS5vcGFjaXR5LnZhbHVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgdHlwZTogUHJvY2Vzc0J1YmJsZVR5cGUub3BhY2l0eSxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHRoaXMucHJvY2VzcyhkaXN0TW91c2UsIHRpbWVTcGVudCwgb3BhY2l0eURhdGEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBob3ZlckJ1YmJsZSgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jb250YWluZXI7XG4gICAgICAgIGNvbnN0IHBhcnRpY2xlID0gdGhpcy5wYXJ0aWNsZTtcbiAgICAgICAgY29uc3QgbW91c2VQb3MgPSBjb250YWluZXIuaW50ZXJhY3Rpdml0eS5tb3VzZS5wb3NpdGlvbiB8fCB7XG4gICAgICAgICAgICB4OiAwLFxuICAgICAgICAgICAgeTogMCxcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgZGlzdE1vdXNlID0gVXRpbHMuZ2V0RGlzdGFuY2VCZXR3ZWVuQ29vcmRpbmF0ZXMocGFydGljbGUucG9zaXRpb24sIG1vdXNlUG9zKTtcbiAgICAgICAgY29uc3QgcmF0aW8gPSAxIC0gZGlzdE1vdXNlIC8gY29udGFpbmVyLnJldGluYS5idWJibGVNb2RlRGlzdGFuY2U7XG5cbiAgICAgICAgLyogbW91c2Vtb3ZlIC0gY2hlY2sgcmF0aW8gKi9cbiAgICAgICAgaWYgKGRpc3RNb3VzZSA8PSBjb250YWluZXIucmV0aW5hLmJ1YmJsZU1vZGVEaXN0YW5jZSkge1xuICAgICAgICAgICAgaWYgKHJhdGlvID49IDAgJiYgY29udGFpbmVyLmludGVyYWN0aXZpdHkuc3RhdHVzID09PSBcIm1vdXNlbW92ZVwiKSB7XG4gICAgICAgICAgICAgICAgLyogc2l6ZSAqL1xuICAgICAgICAgICAgICAgIHRoaXMuaG92ZXJCdWJibGVTaXplKHJhdGlvKTtcblxuICAgICAgICAgICAgICAgIC8qIG9wYWNpdHkgKi9cbiAgICAgICAgICAgICAgICB0aGlzLmhvdmVyQnViYmxlT3BhY2l0eShyYXRpbyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmluaXQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qIG1vdXNlbGVhdmUgKi9cbiAgICAgICAgaWYgKGNvbnRhaW5lci5pbnRlcmFjdGl2aXR5LnN0YXR1cyA9PT0gXCJtb3VzZWxlYXZlXCIpIHtcbiAgICAgICAgICAgIHRoaXMuaW5pdCgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBob3ZlckJ1YmJsZVNpemUocmF0aW86IG51bWJlcik6IHZvaWQge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcjtcbiAgICAgICAgY29uc3QgcGFydGljbGUgPSB0aGlzLnBhcnRpY2xlO1xuXG4gICAgICAgIGlmIChjb250YWluZXIucmV0aW5hLmJ1YmJsZU1vZGVTaXplICE9PSBjb250YWluZXIucmV0aW5hLnNpemVWYWx1ZSkge1xuICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5yZXRpbmEuYnViYmxlTW9kZVNpemUgPiBjb250YWluZXIucmV0aW5hLnNpemVWYWx1ZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHNpemUgPSBwYXJ0aWNsZS5yYWRpdXMgKyAoY29udGFpbmVyLnJldGluYS5idWJibGVNb2RlU2l6ZSAqIHJhdGlvKTtcblxuICAgICAgICAgICAgICAgIGlmIChzaXplID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yYWRpdXMgPSBzaXplO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZGlmID0gcGFydGljbGUucmFkaXVzIC0gY29udGFpbmVyLnJldGluYS5idWJibGVNb2RlU2l6ZTtcbiAgICAgICAgICAgICAgICBjb25zdCBzaXplID0gcGFydGljbGUucmFkaXVzIC0gKGRpZiAqIHJhdGlvKTtcblxuICAgICAgICAgICAgICAgIGlmIChzaXplID4gMCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJhZGl1cyA9IHNpemU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yYWRpdXMgPSAwO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaG92ZXJCdWJibGVPcGFjaXR5KHJhdGlvOiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jb250YWluZXI7XG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSBjb250YWluZXIub3B0aW9ucztcbiAgICAgICAgY29uc3QgcGFydGljbGUgPSB0aGlzLnBhcnRpY2xlO1xuICAgICAgICBjb25zdCBtb2RlT3BhY2l0eSA9IG9wdGlvbnMuaW50ZXJhY3Rpdml0eS5tb2Rlcy5idWJibGUub3BhY2l0eTtcbiAgICAgICAgY29uc3Qgb3B0T3BhY2l0eSA9IG9wdGlvbnMucGFydGljbGVzLm9wYWNpdHkudmFsdWU7XG4gICAgICAgIGNvbnN0IHBPcGFjaXR5ID0gcGFydGljbGUub3BhY2l0eS52YWx1ZTtcblxuICAgICAgICBpZiAobW9kZU9wYWNpdHkgIT09IG9wdE9wYWNpdHkpIHtcbiAgICAgICAgICAgIGlmIChtb2RlT3BhY2l0eSA+IG9wdE9wYWNpdHkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBvcGFjaXR5ID0gb3B0aW9ucy5pbnRlcmFjdGl2aXR5Lm1vZGVzLmJ1YmJsZS5vcGFjaXR5ICogcmF0aW87XG5cbiAgICAgICAgICAgICAgICBpZiAob3BhY2l0eSA+IHBPcGFjaXR5ICYmIG9wYWNpdHkgPD0gbW9kZU9wYWNpdHkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGFjaXR5ID0gb3BhY2l0eTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IG9wYWNpdHkgPSBwT3BhY2l0eSAtIChvcHRPcGFjaXR5IC0gbW9kZU9wYWNpdHkpICogcmF0aW87XG5cbiAgICAgICAgICAgICAgICBpZiAob3BhY2l0eSA8IHBPcGFjaXR5ICYmIG9wYWNpdHkgPj0gbW9kZU9wYWNpdHkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGFjaXR5ID0gb3BhY2l0eTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=