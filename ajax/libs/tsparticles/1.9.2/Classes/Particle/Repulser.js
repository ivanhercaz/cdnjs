"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Repulser = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _ClickMode = require("../../Enums/Modes/ClickMode");

var _HoverMode = require("../../Enums/Modes/HoverMode");

var _OutMode = require("../../Enums/OutMode");

var _Utils = require("../Utils/Utils");

var _DivMode = require("../../Enums/Modes/DivMode");

/**
 * Particle repulse manager
 */
var Repulser = /*#__PURE__*/function () {
  function Repulser(container, particle) {
    (0, _classCallCheck2["default"])(this, Repulser);
    this.particle = void 0;
    this.container = void 0;
    this.container = container;
    this.particle = particle;
  }

  (0, _createClass2["default"])(Repulser, [{
    key: "repulse",
    value: function repulse() {
      var container = this.container;
      var options = container.options;
      var hoverEnabled = options.interactivity.events.onHover.enable;
      var clickEnabled = options.interactivity.events.onClick.enable;
      var mouseMoveStatus = container.interactivity.status === "mousemove";
      var hoverMode = options.interactivity.events.onHover.mode;
      var clickMode = options.interactivity.events.onClick.mode;
      var divMode = options.interactivity.events.onDiv.mode;

      if (mouseMoveStatus && hoverEnabled && _Utils.Utils.isInArray(_HoverMode.HoverMode.repulse, hoverMode)) {
        this.hoverRepulse();
      } else if (clickEnabled && _Utils.Utils.isInArray(_ClickMode.ClickMode.repulse, clickMode)) {
        this.clickRepulse();
      } else if (options.interactivity.events.onDiv.enable && _Utils.Utils.isInArray(_DivMode.DivMode.repulse, divMode)) {
        this.divRepulse();
      }
    }
  }, {
    key: "divRepulse",
    value: function divRepulse() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;
      var elem = document.getElementById(options.interactivity.events.onDiv.elementId);
      var pos = {
        x: elem.offsetLeft + elem.offsetWidth / 2,
        y: elem.offsetTop + elem.offsetHeight / 2
      };
      var divWidth = elem.offsetWidth / 2;

      if (container.retina.isRetina) {
        pos.x *= container.canvas.pxRatio;
        pos.y *= container.canvas.pxRatio;
        divWidth *= container.canvas.pxRatio;
      }

      var dxDiv = particle.position.x - pos.x;
      var dyDiv = particle.position.y - pos.y;
      var distDiv = Math.sqrt(dxDiv * dxDiv + dyDiv * dyDiv);
      var normVec = {
        x: dxDiv / distDiv,
        y: dyDiv / distDiv
      };
      var repulseRadius = divWidth;
      var velocity = 100;

      var repulseFactor = _Utils.Utils.clamp((-Math.pow(distDiv / repulseRadius, 4) + 1) * velocity, 0, 50);

      this.particle.position.x += normVec.x * repulseFactor;
      this.particle.position.y += normVec.y * repulseFactor;
    }
  }, {
    key: "clickRepulse",
    value: function clickRepulse() {
      var container = this.container;
      var particle = this.particle;

      if (!container.repulse.finish) {
        if (!container.repulse.count) {
          container.repulse.count = 0;
        }

        container.repulse.count++;

        if (container.repulse.count === container.particles.array.length) {
          container.repulse.finish = true;
        }
      }

      if (container.repulse.clicking) {
        var repulseDistance = container.retina.repulseModeDistance;
        var repulseRadius = Math.pow(repulseDistance / 6, 3);
        var mouseClickPos = container.interactivity.mouse.clickPosition || {
          x: 0,
          y: 0
        };
        var dx = mouseClickPos.x - particle.position.x;
        var dy = mouseClickPos.y - particle.position.y;
        var d = dx * dx + dy * dy;
        var force = -repulseRadius / d; // default

        if (d <= repulseRadius) {
          this.processRepulse(dx, dy, force);
        } // bang - slow motion mode
        // if(!container.repulse_finish){
        //   if(d <= repulseRadius){
        //     process();
        //   }
        // }else{
        //   process();
        // }

      } else if (container.repulse.clicking === false) {
        particle.velocity.horizontal = particle.initialVelocity.horizontal;
        particle.velocity.vertical = particle.initialVelocity.vertical;
      }
    }
  }, {
    key: "hoverRepulse",
    value: function hoverRepulse() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;
      var mousePos = container.interactivity.mouse.position || {
        x: 0,
        y: 0
      };
      var dxMouse = particle.position.x - mousePos.x;
      var dyMouse = particle.position.y - mousePos.y;
      var distMouse = Math.sqrt(dxMouse * dxMouse + dyMouse * dyMouse);
      var normVec = {
        x: dxMouse / distMouse,
        y: dyMouse / distMouse
      };
      var repulseRadius = container.retina.repulseModeDistance;
      var velocity = 100;

      var repulseFactor = _Utils.Utils.clamp((1 - Math.pow(distMouse / repulseRadius, 2)) * velocity, 0, 50);

      var pos = {
        x: particle.position.x + normVec.x * repulseFactor,
        y: particle.position.y + normVec.y * repulseFactor
      };
      var outMode = options.particles.move.outMode;

      if (outMode === _OutMode.OutMode.bounce || outMode === _OutMode.OutMode.bounceVertical || outMode === _OutMode.OutMode.bounceHorizontal) {
        var isInside = {
          horizontal: pos.x - particle.radius > 0 && pos.x + particle.radius < container.canvas.dimension.width,
          vertical: pos.y - particle.radius > 0 && pos.y + particle.radius < container.canvas.dimension.height
        };

        if (outMode === _OutMode.OutMode.bounceVertical || isInside.horizontal) {
          particle.position.x = pos.x;
        }

        if (outMode === _OutMode.OutMode.bounceHorizontal || isInside.vertical) {
          particle.position.y = pos.y;
        }
      } else {
        particle.position.x = pos.x;
        particle.position.y = pos.y;
      }
    }
  }, {
    key: "processRepulse",
    value: function processRepulse(dx, dy, force) {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;
      var f = Math.atan2(dy, dx);
      particle.velocity.horizontal = force * Math.cos(f);
      particle.velocity.vertical = force * Math.sin(f);
      var outMode = options.particles.move.outMode;

      if (outMode === _OutMode.OutMode.bounce || outMode === _OutMode.OutMode.bounceHorizontal || outMode === _OutMode.OutMode.bounceVertical) {
        var pos = {
          x: particle.position.x + particle.velocity.horizontal,
          y: particle.position.y + particle.velocity.vertical
        };

        if (outMode !== _OutMode.OutMode.bounceVertical) {
          if (pos.x + particle.radius > container.canvas.dimension.width || pos.x - particle.radius < 0) {
            particle.velocity.horizontal = -particle.velocity.horizontal;
          }
        }

        if (outMode !== _OutMode.OutMode.bounceHorizontal) {
          if (pos.y + particle.radius > container.canvas.dimension.height || pos.y - particle.radius < 0) {
            particle.velocity.vertical = -particle.velocity.vertical;
          }
        }
      }
    }
  }]);
  return Repulser;
}();

exports.Repulser = Repulser;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9DbGFzc2VzL1BhcnRpY2xlL1JlcHVsc2VyLnRzIl0sIm5hbWVzIjpbIlJlcHVsc2VyIiwiY29udGFpbmVyIiwicGFydGljbGUiLCJvcHRpb25zIiwiaG92ZXJFbmFibGVkIiwiaW50ZXJhY3Rpdml0eSIsImV2ZW50cyIsIm9uSG92ZXIiLCJlbmFibGUiLCJjbGlja0VuYWJsZWQiLCJvbkNsaWNrIiwibW91c2VNb3ZlU3RhdHVzIiwic3RhdHVzIiwiaG92ZXJNb2RlIiwibW9kZSIsImNsaWNrTW9kZSIsImRpdk1vZGUiLCJvbkRpdiIsIlV0aWxzIiwiaXNJbkFycmF5IiwiSG92ZXJNb2RlIiwicmVwdWxzZSIsImhvdmVyUmVwdWxzZSIsIkNsaWNrTW9kZSIsImNsaWNrUmVwdWxzZSIsIkRpdk1vZGUiLCJkaXZSZXB1bHNlIiwiZWxlbSIsImRvY3VtZW50IiwiZ2V0RWxlbWVudEJ5SWQiLCJlbGVtZW50SWQiLCJwb3MiLCJ4Iiwib2Zmc2V0TGVmdCIsIm9mZnNldFdpZHRoIiwieSIsIm9mZnNldFRvcCIsIm9mZnNldEhlaWdodCIsImRpdldpZHRoIiwicmV0aW5hIiwiaXNSZXRpbmEiLCJjYW52YXMiLCJweFJhdGlvIiwiZHhEaXYiLCJwb3NpdGlvbiIsImR5RGl2IiwiZGlzdERpdiIsIk1hdGgiLCJzcXJ0Iiwibm9ybVZlYyIsInJlcHVsc2VSYWRpdXMiLCJ2ZWxvY2l0eSIsInJlcHVsc2VGYWN0b3IiLCJjbGFtcCIsInBvdyIsImZpbmlzaCIsImNvdW50IiwicGFydGljbGVzIiwiYXJyYXkiLCJsZW5ndGgiLCJjbGlja2luZyIsInJlcHVsc2VEaXN0YW5jZSIsInJlcHVsc2VNb2RlRGlzdGFuY2UiLCJtb3VzZUNsaWNrUG9zIiwibW91c2UiLCJjbGlja1Bvc2l0aW9uIiwiZHgiLCJkeSIsImQiLCJmb3JjZSIsInByb2Nlc3NSZXB1bHNlIiwiaG9yaXpvbnRhbCIsImluaXRpYWxWZWxvY2l0eSIsInZlcnRpY2FsIiwibW91c2VQb3MiLCJkeE1vdXNlIiwiZHlNb3VzZSIsImRpc3RNb3VzZSIsIm91dE1vZGUiLCJtb3ZlIiwiT3V0TW9kZSIsImJvdW5jZSIsImJvdW5jZVZlcnRpY2FsIiwiYm91bmNlSG9yaXpvbnRhbCIsImlzSW5zaWRlIiwicmFkaXVzIiwiZGltZW5zaW9uIiwid2lkdGgiLCJoZWlnaHQiLCJmIiwiYXRhbjIiLCJjb3MiLCJzaW4iXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBRUE7OztJQUdhQSxRO0FBSVQsb0JBQVlDLFNBQVosRUFBa0NDLFFBQWxDLEVBQXNEO0FBQUE7QUFBQSxTQUhyQ0EsUUFHcUM7QUFBQSxTQUZyQ0QsU0FFcUM7QUFDbEQsU0FBS0EsU0FBTCxHQUFpQkEsU0FBakI7QUFDQSxTQUFLQyxRQUFMLEdBQWdCQSxRQUFoQjtBQUNIOzs7OzhCQUVzQjtBQUNuQixVQUFNRCxTQUFTLEdBQUcsS0FBS0EsU0FBdkI7QUFDQSxVQUFNRSxPQUFPLEdBQUdGLFNBQVMsQ0FBQ0UsT0FBMUI7QUFDQSxVQUFNQyxZQUFZLEdBQUdELE9BQU8sQ0FBQ0UsYUFBUixDQUFzQkMsTUFBdEIsQ0FBNkJDLE9BQTdCLENBQXFDQyxNQUExRDtBQUNBLFVBQU1DLFlBQVksR0FBR04sT0FBTyxDQUFDRSxhQUFSLENBQXNCQyxNQUF0QixDQUE2QkksT0FBN0IsQ0FBcUNGLE1BQTFEO0FBQ0EsVUFBTUcsZUFBZSxHQUFHVixTQUFTLENBQUNJLGFBQVYsQ0FBd0JPLE1BQXhCLEtBQW1DLFdBQTNEO0FBQ0EsVUFBTUMsU0FBUyxHQUFHVixPQUFPLENBQUNFLGFBQVIsQ0FBc0JDLE1BQXRCLENBQTZCQyxPQUE3QixDQUFxQ08sSUFBdkQ7QUFDQSxVQUFNQyxTQUFTLEdBQUdaLE9BQU8sQ0FBQ0UsYUFBUixDQUFzQkMsTUFBdEIsQ0FBNkJJLE9BQTdCLENBQXFDSSxJQUF2RDtBQUNBLFVBQU1FLE9BQU8sR0FBR2IsT0FBTyxDQUFDRSxhQUFSLENBQXNCQyxNQUF0QixD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QixRQUFRLENBQUNtRixNQUFqQixHQUEwQixDQUE1RixFQUErRjtBQUMzRm5GLFlBQUFBLFFBQVEsQ0FBQ2lELFFBQVQsQ0FBa0JvQixVQUFsQixHQUErQixDQUFDckUsUUFBUSxDQUFDaUQsUUFBVCxDQUFrQm9CLFVBQWxEO0FBQ0g7QUFDSjs7QUFFRCxZQUFJTyxPQUFPLEtBQUtFLGlCQUFRRyxnQkFBeEIsRUFBMEM7QUFDdEMsY0FBSXBELEdBQUcsQ0FBQ0ksQ0FBSixHQUFRakMsUUFBUSxDQUFDbUYsTUFBakIsR0FBMEJwRixTQUFTLENBQUN3QyxNQUFWLENBQWlCNkMsU0FBakIsQ0FBMkJFLE1BQXJELElBQStEekQsR0FBRyxDQUFDSSxDQUFKLEdBQVFqQyxRQUFRLENBQUNtRixNQUFqQixHQUEwQixDQUE3RixFQUFnRztBQUM1Rm5GLFlBQUFBLFFBQVEsQ0FBQ2lELFFBQVQsQ0FBa0JzQixRQUFsQixHQUE2QixDQUFDdkUsUUFBUSxDQUFDaUQsUUFBVCxDQUFrQnNCLFFBQWhEO0FBQ0g7QUFDSjtBQUNKO0FBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IHtDbGlja01vZGV9IGZyb20gXCIuLi8uLi9FbnVtcy9Nb2Rlcy9DbGlja01vZGVcIjtcbmltcG9ydCB7Q29udGFpbmVyfSBmcm9tIFwiLi4vQ29udGFpbmVyXCI7XG5pbXBvcnQge0hvdmVyTW9kZX0gZnJvbSBcIi4uLy4uL0VudW1zL01vZGVzL0hvdmVyTW9kZVwiO1xuaW1wb3J0IHtPdXRNb2RlfSBmcm9tIFwiLi4vLi4vRW51bXMvT3V0TW9kZVwiO1xuaW1wb3J0IHtQYXJ0aWNsZX0gZnJvbSBcIi4uL1BhcnRpY2xlXCI7XG5pbXBvcnQge1V0aWxzfSBmcm9tIFwiLi4vVXRpbHMvVXRpbHNcIjtcbmltcG9ydCB7RGl2TW9kZX0gZnJvbSBcIi4uLy4uL0VudW1zL01vZGVzL0Rpdk1vZGVcIjtcblxuLyoqXG4gKiBQYXJ0aWNsZSByZXB1bHNlIG1hbmFnZXJcbiAqL1xuZXhwb3J0IGNsYXNzIFJlcHVsc2VyIHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHBhcnRpY2xlOiBQYXJ0aWNsZTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbnRhaW5lcjogQ29udGFpbmVyO1xuXG4gICAgY29uc3RydWN0b3IoY29udGFpbmVyOiBDb250YWluZXIsIHBhcnRpY2xlOiBQYXJ0aWNsZSkge1xuICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGNvbnRhaW5lcjtcbiAgICAgICAgdGhpcy5wYXJ0aWNsZSA9IHBhcnRpY2xlO1xuICAgIH1cblxuICAgIHB1YmxpYyByZXB1bHNlKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcjtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGNvbnRhaW5lci5vcHRpb25zO1xuICAgICAgICBjb25zdCBob3ZlckVuYWJsZWQgPSBvcHRpb25zLmludGVyYWN0aXZpdHkuZXZlbnRzLm9uSG92ZXIuZW5hYmxlO1xuICAgICAgICBjb25zdCBjbGlja0VuYWJsZWQgPSBvcHRpb25zLmludGVyYWN0aXZpdHkuZXZlbnRzLm9uQ2xpY2suZW5hYmxlO1xuICAgICAgICBjb25zdCBtb3VzZU1vdmVTdGF0dXMgPSBjb250YWluZXIuaW50ZXJhY3Rpdml0eS5zdGF0dXMgPT09IFwibW91c2Vtb3ZlXCI7XG4gICAgICAgIGNvbnN0IGhvdmVyTW9kZSA9IG9wdGlvbnMuaW50ZXJhY3Rpdml0eS5ldmVudHMub25Ib3Zlci5tb2RlO1xuICAgICAgICBjb25zdCBjbGlja01vZGUgPSBvcHRpb25zLmludGVyYWN0aXZpdHkuZXZlbnRzLm9uQ2xpY2subW9kZTtcbiAgICAgICAgY29uc3QgZGl2TW9kZSA9IG9wdGlvbnMuaW50ZXJhY3Rpdml0eS5ldmVudHMub25EaXYubW9kZTtcblxuICAgICAgICBpZiAobW91c2VNb3ZlU3RhdHVzICYmIGhvdmVyRW5hYmxlZCAmJiBVdGlscy5pc0luQXJyYXkoSG92ZXJNb2RlLnJlcHVsc2UsIGhvdmVyTW9kZSkpIHtcbiAgICAgICAgICAgIHRoaXMuaG92ZXJSZXB1bHNlKCk7XG4gICAgICAgIH0gZWxzZSBpZiAoY2xpY2tFbmFibGVkICYmIFV0aWxzLmlzSW5BcnJheShDbGlja01vZGUucmVwdWxzZSwgY2xpY2tNb2RlKSkge1xuICAgICAgICAgICAgdGhpcy5jbGlja1JlcHVsc2UoKTtcbiAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zLmludGVyYWN0aXZpdHkuZXZlbnRzLm9uRGl2LmVuYWJsZSAmJiBVdGlscy5pc0luQXJyYXkoRGl2TW9kZS5yZXB1bHNlLCBkaXZNb2RlKSkge1xuICAgICAgICAgICAgdGhpcy5kaXZSZXB1bHNlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGRpdlJlcHVsc2UoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyO1xuICAgICAgICBjb25zdCBvcHRpb25zID0gY29udGFpbmVyLm9wdGlvbnM7XG4gICAgICAgIGNvbnN0IHBhcnRpY2xlID0gdGhpcy5wYXJ0aWNsZTtcblxuICAgICAgICBjb25zdCBlbGVtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQob3B0aW9ucy5pbnRlcmFjdGl2aXR5LmV2ZW50cy5vbkRpdi5lbGVtZW50SWQpIGFzIEhUTUxFbGVtZW50O1xuICAgICAgICBjb25zdCBwb3MgPSB7XG4gICAgICAgICAgICB4OiAoZWxlbS5vZmZzZXRMZWZ0ICsgZWxlbS5vZmZzZXRXaWR0aCAvIDIpLFxuICAgICAgICAgICAgeTogKGVsZW0ub2Zmc2V0VG9wICsgZWxlbS5vZmZzZXRIZWlnaHQgLyAyKSxcbiAgICAgICAgfTtcbiAgICAgICAgbGV0IGRpdldpZHRoID0gZWxlbS5vZmZzZXRXaWR0aCAvIDI7XG5cbiAgICAgICAgaWYgKGNvbnRhaW5lci5yZXRpbmEuaXNSZXRpbmEpIHtcbiAgICAgICAgICAgIHBvcy54ICo9IGNvbnRhaW5lci5jYW52YXMucHhSYXRpbztcbiAgICAgICAgICAgIHBvcy55ICo9IGNvbnRhaW5lci5jYW52YXMucHhSYXRpbztcbiAgICAgICAgICAgIGRpdldpZHRoICo9IGNvbnRhaW5lci5jYW52YXMucHhSYXRpb1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZHhEaXYgPSBwYXJ0aWNsZS5wb3NpdGlvbi54IC0gcG9zLng7XG4gICAgICAgIGNvbnN0IGR5RGl2ID0gcGFydGljbGUucG9zaXRpb24ueSAtIHBvcy55O1xuICAgICAgICBjb25zdCBkaXN0RGl2ID0gTWF0aC5zcXJ0KGR4RGl2ICogZHhEaXYgKyBkeURpdiAqIGR5RGl2KTtcbiAgICAgICAgY29uc3Qgbm9ybVZlYyA9IHtcbiAgICAgICAgICAgIHg6IGR4RGl2IC8gZGlzdERpdixcbiAgICAgICAgICAgIHk6IGR5RGl2IC8gZGlzdERpdixcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgcmVwdWxzZVJhZGl1cyA9IGRpdldpZHRoO1xuICAgICAgICBjb25zdCB2ZWxvY2l0eSA9IDEwMDtcbiAgICAgICAgY29uc3QgcmVwdWxzZUZhY3RvciA9IFV0aWxzLmNsYW1wKCgtTWF0aC5wb3coZGlzdERpdiAvIHJlcHVsc2VSYWRpdXMsIDQpICsgMSkgKiB2ZWxvY2l0eSwgMCwgNTApO1xuXG4gICAgICAgIHRoaXMucGFydGljbGUucG9zaXRpb24ueCArPSBub3JtVmVjLnggKiByZXB1bHNlRmFjdG9yO1xuICAgICAgICB0aGlzLnBhcnRpY2xlLnBvc2l0aW9uLnkgKz0gbm9ybVZlYy55ICogcmVwdWxzZUZhY3RvcjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNsaWNrUmVwdWxzZSgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jb250YWluZXI7XG4gICAgICAgIGNvbnN0IHBhcnRpY2xlID0gdGhpcy5wYXJ0aWNsZTtcblxuICAgICAgICBpZiAoIWNvbnRhaW5lci5yZXB1bHNlLmZpbmlzaCkge1xuICAgICAgICAgICAgaWYgKCFjb250YWluZXIucmVwdWxzZS5jb3VudCkge1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5yZXB1bHNlLmNvdW50ID0gMDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29udGFpbmVyLnJlcHVsc2UuY291bnQrKztcblxuICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5yZXB1bHNlLmNvdW50ID09PSBjb250YWluZXIucGFydGljbGVzLmFycmF5Lmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5yZXB1bHNlLmZpbmlzaCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29udGFpbmVyLnJlcHVsc2UuY2xpY2tpbmcpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlcHVsc2VEaXN0YW5jZSA9IGNvbnRhaW5lci5yZXRpbmEucmVwdWxzZU1vZGVEaXN0YW5jZTtcbiAgICAgICAgICAgIGNvbnN0IHJlcHVsc2VSYWRpdXMgPSBNYXRoLnBvdyhyZXB1bHNlRGlzdGFuY2UgLyA2LCAzKTtcbiAgICAgICAgICAgIGNvbnN0IG1vdXNlQ2xpY2tQb3MgPSBjb250YWluZXIuaW50ZXJhY3Rpdml0eS5tb3VzZS5jbGlja1Bvc2l0aW9uIHx8IHt4OiAwLCB5OiAwfTtcbiAgICAgICAgICAgIGNvbnN0IGR4ID0gbW91c2VDbGlja1Bvcy54IC0gcGFydGljbGUucG9zaXRpb24ueDtcbiAgICAgICAgICAgIGNvbnN0IGR5ID0gbW91c2VDbGlja1Bvcy55IC0gcGFydGljbGUucG9zaXRpb24ueTtcbiAgICAgICAgICAgIGNvbnN0IGQgPSBkeCAqIGR4ICsgZHkgKiBkeTtcbiAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gLXJlcHVsc2VSYWRpdXMgLyBkO1xuXG4gICAgICAgICAgICAvLyBkZWZhdWx0XG4gICAgICAgICAgICBpZiAoZCA8PSByZXB1bHNlUmFkaXVzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzUmVwdWxzZShkeCwgZHksIGZvcmNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIGJhbmcgLSBzbG93IG1vdGlvbiBtb2RlXG4gICAgICAgICAgICAvLyBpZighY29udGFpbmVyLnJlcHVsc2VfZmluaXNoKXtcbiAgICAgICAgICAgIC8vICAgaWYoZCA8PSByZXB1bHNlUmFkaXVzKXtcbiAgICAgICAgICAgIC8vICAgICBwcm9jZXNzKCk7XG4gICAgICAgICAgICAvLyAgIH1cbiAgICAgICAgICAgIC8vIH1lbHNle1xuICAgICAgICAgICAgLy8gICBwcm9jZXNzKCk7XG4gICAgICAgICAgICAvLyB9XG4gICAgICAgIH0gZWxzZSBpZiAoY29udGFpbmVyLnJlcHVsc2UuY2xpY2tpbmcgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICBwYXJ0aWNsZS52ZWxvY2l0eS5ob3Jpem9udGFsID0gcGFydGljbGUuaW5pdGlhbFZlbG9jaXR5Lmhvcml6b250YWw7XG4gICAgICAgICAgICBwYXJ0aWNsZS52ZWxvY2l0eS52ZXJ0aWNhbCA9IHBhcnRpY2xlLmluaXRpYWxWZWxvY2l0eS52ZXJ0aWNhbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaG92ZXJSZXB1bHNlKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcjtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGNvbnRhaW5lci5vcHRpb25zO1xuICAgICAgICBjb25zdCBwYXJ0aWNsZSA9IHRoaXMucGFydGljbGU7XG4gICAgICAgIGNvbnN0IG1vdXNlUG9zID0gY29udGFpbmVyLmludGVyYWN0aXZpdHkubW91c2UucG9zaXRpb24gfHwge3g6IDAsIHk6IDB9O1xuICAgICAgICBjb25zdCBkeE1vdXNlID0gcGFydGljbGUucG9zaXRpb24ueCAtIG1vdXNlUG9zLng7XG4gICAgICAgIGNvbnN0IGR5TW91c2UgPSBwYXJ0aWNsZS5wb3NpdGlvbi55IC0gbW91c2VQb3MueTtcbiAgICAgICAgY29uc3QgZGlzdE1vdXNlID0gTWF0aC5zcXJ0KGR4TW91c2UgKiBkeE1vdXNlICsgZHlNb3VzZSAqIGR5TW91c2UpO1xuICAgICAgICBjb25zdCBub3JtVmVjID0ge3g6IGR4TW91c2UgLyBkaXN0TW91c2UsIHk6IGR5TW91c2UgLyBkaXN0TW91c2V9O1xuICAgICAgICBjb25zdCByZXB1bHNlUmFkaXVzID0gY29udGFpbmVyLnJldGluYS5yZXB1bHNlTW9kZURpc3RhbmNlO1xuICAgICAgICBjb25zdCB2ZWxvY2l0eSA9IDEwMDtcbiAgICAgICAgY29uc3QgcmVwdWxzZUZhY3RvciA9IFV0aWxzLmNsYW1wKCgxIC0gTWF0aC5wb3coZGlzdE1vdXNlIC8gcmVwdWxzZVJhZGl1cywgMikpICogdmVsb2NpdHksIDAsIDUwKTtcbiAgICAgICAgY29uc3QgcG9zID0ge1xuICAgICAgICAgICAgeDogcGFydGljbGUucG9zaXRpb24ueCArIG5vcm1WZWMueCAqIHJlcHVsc2VGYWN0b3IsXG4gICAgICAgICAgICB5OiBwYXJ0aWNsZS5wb3NpdGlvbi55ICsgbm9ybVZlYy55ICogcmVwdWxzZUZhY3RvcixcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3Qgb3V0TW9kZSA9IG9wdGlvbnMucGFydGljbGVzLm1vdmUub3V0TW9kZTtcblxuICAgICAgICBpZiAob3V0TW9kZSA9PT0gT3V0TW9kZS5ib3VuY2UgfHwgb3V0TW9kZSA9PT0gT3V0TW9kZS5ib3VuY2VWZXJ0aWNhbCB8fCBvdXRNb2RlID09PSBPdXRNb2RlLmJvdW5jZUhvcml6b250YWwpIHtcbiAgICAgICAgICAgIGNvbnN0IGlzSW5zaWRlID0ge1xuICAgICAgICAgICAgICAgIGhvcml6b250YWw6IHBvcy54IC0gcGFydGljbGUucmFkaXVzID4gMCAmJiBwb3MueCArIHBhcnRpY2xlLnJhZGl1cyA8IGNvbnRhaW5lci5jYW52YXMuZGltZW5zaW9uLndpZHRoLFxuICAgICAgICAgICAgICAgIHZlcnRpY2FsOiBwb3MueSAtIHBhcnRpY2xlLnJhZGl1cyA+IDAgJiYgcG9zLnkgKyBwYXJ0aWNsZS5yYWRpdXMgPCBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi5oZWlnaHQsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgaWYgKG91dE1vZGUgPT09IE91dE1vZGUuYm91bmNlVmVydGljYWwgfHwgaXNJbnNpZGUuaG9yaXpvbnRhbCkge1xuICAgICAgICAgICAgICAgIHBhcnRpY2xlLnBvc2l0aW9uLnggPSBwb3MueDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKG91dE1vZGUgPT09IE91dE1vZGUuYm91bmNlSG9yaXpvbnRhbCB8fCBpc0luc2lkZS52ZXJ0aWNhbCkge1xuICAgICAgICAgICAgICAgIHBhcnRpY2xlLnBvc2l0aW9uLnkgPSBwb3MueTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHBhcnRpY2xlLnBvc2l0aW9uLnggPSBwb3MueDtcbiAgICAgICAgICAgIHBhcnRpY2xlLnBvc2l0aW9uLnkgPSBwb3MueTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgcHJvY2Vzc1JlcHVsc2UoZHg6IG51bWJlciwgZHk6IG51bWJlciwgZm9yY2U6IG51bWJlcik6IHZvaWQge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcjtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGNvbnRhaW5lci5vcHRpb25zO1xuICAgICAgICBjb25zdCBwYXJ0aWNsZSA9IHRoaXMucGFydGljbGU7XG4gICAgICAgIGNvbnN0IGYgPSBNYXRoLmF0YW4yKGR5LCBkeCk7XG5cbiAgICAgICAgcGFydGljbGUudmVsb2NpdHkuaG9yaXpvbnRhbCA9IGZvcmNlICogTWF0aC5jb3MoZik7XG4gICAgICAgIHBhcnRpY2xlLnZlbG9jaXR5LnZlcnRpY2FsID0gZm9yY2UgKiBNYXRoLnNpbihmKTtcblxuICAgICAgICBjb25zdCBvdXRNb2RlID0gb3B0aW9ucy5wYXJ0aWNsZXMubW92ZS5vdXRNb2RlO1xuXG4gICAgICAgIGlmIChvdXRNb2RlID09PSBPdXRNb2RlLmJvdW5jZSB8fCBvdXRNb2RlID09PSBPdXRNb2RlLmJvdW5jZUhvcml6b250YWwgfHwgb3V0TW9kZSA9PT0gT3V0TW9kZS5ib3VuY2VWZXJ0aWNhbCkge1xuICAgICAgICAgICAgY29uc3QgcG9zID0ge1xuICAgICAgICAgICAgICAgIHg6IHBhcnRpY2xlLnBvc2l0aW9uLnggKyBwYXJ0aWNsZS52ZWxvY2l0eS5ob3Jpem9udGFsLFxuICAgICAgICAgICAgICAgIHk6IHBhcnRpY2xlLnBvc2l0aW9uLnkgKyBwYXJ0aWNsZS52ZWxvY2l0eS52ZXJ0aWNhbCxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGlmIChvdXRNb2RlICE9PSBPdXRNb2RlLmJvdW5jZVZlcnRpY2FsKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBvcy54ICsgcGFydGljbGUucmFkaXVzID4gY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24ud2lkdGggfHwgcG9zLnggLSBwYXJ0aWNsZS5yYWRpdXMgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcnRpY2xlLnZlbG9jaXR5Lmhvcml6b250YWwgPSAtcGFydGljbGUudmVsb2NpdHkuaG9yaXpvbnRhbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChvdXRNb2RlICE9PSBPdXRNb2RlLmJvdW5jZUhvcml6b250YWwpIHtcbiAgICAgICAgICAgICAgICBpZiAocG9zLnkgKyBwYXJ0aWNsZS5yYWRpdXMgPiBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi5oZWlnaHQgfHwgcG9zLnkgLSBwYXJ0aWNsZS5yYWRpdXMgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcnRpY2xlLnZlbG9jaXR5LnZlcnRpY2FsID0gLXBhcnRpY2xlLnZlbG9jaXR5LnZlcnRpY2FsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==