"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Updater = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _OutMode = require("../../Enums/OutMode");

var _Utils = require("../Utils/Utils");

var _ClickMode = require("../../Enums/Modes/ClickMode");

var _PolygonMaskType = require("../../Enums/PolygonMaskType");

var _Mover = require("./Mover");

var _RotateDirection = require("../../Enums/RotateDirection");

/**
 * Particle updater, it manages movement
 */
var Updater = /*#__PURE__*/function () {
  function Updater(container, particle) {
    (0, _classCallCheck2["default"])(this, Updater);
    this.particle = void 0;
    this.container = void 0;
    this.mover = void 0;
    this.container = container;
    this.particle = particle;
    this.mover = new _Mover.Mover(container, particle);
  }

  (0, _createClass2["default"])(Updater, [{
    key: "update",
    value: function update(delta) {
      /* move the particle */
      this.mover.move(delta);
      /* change opacity status */

      this.updateOpacity();
      /* change size */

      this.updateSize();
      /* change size */

      this.updateAngle();
      /* change particle position if it is out of canvas */

      this.fixOutOfCanvasPosition();
      /* out of canvas modes */

      this.updateOutMode();
    }
  }, {
    key: "updateOpacity",
    value: function updateOpacity() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;

      if (options.particles.opacity.animation.enable) {
        if (particle.opacity.status) {
          if (particle.opacity.value >= options.particles.opacity.value) {
            particle.opacity.status = false;
          }

          particle.opacity.value += particle.opacity.velocity || 0;
        } else {
          if (particle.opacity.value <= options.particles.opacity.animation.minimumValue) {
            particle.opacity.status = true;
          }

          particle.opacity.value -= particle.opacity.velocity || 0;
        }

        if (particle.opacity.value < 0) {
          particle.opacity.value = 0;
        }
      }
    }
  }, {
    key: "updateSize",
    value: function updateSize() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;

      if (options.particles.size.animation.enable) {
        if (particle.size.status) {
          if (particle.radius >= container.retina.sizeValue) {
            particle.size.status = false;
          }

          particle.radius += particle.size.velocity || 0;
        } else {
          if (particle.radius <= options.particles.size.animation.minimumValue) {
            particle.size.status = true;
          }

          particle.radius -= particle.size.velocity || 0;
        }

        if (particle.radius < 0) {
          particle.radius = 0;
        }
      }
    }
  }, {
    key: "updateAngle",
    value: function updateAngle() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;

      if (options.particles.rotate.animation.enable) {
        switch (options.particles.rotate.direction) {
          case _RotateDirection.RotateDirection.clockwise:
            particle.angle += options.particles.rotate.animation.speed * Math.PI / 18;
            break;

          case _RotateDirection.RotateDirection.counterClockwise:
          default:
            particle.angle -= options.particles.rotate.animation.speed * Math.PI / 18;
            break;
        }
      }
    }
  }, {
    key: "fixOutOfCanvasPosition",
    value: function fixOutOfCanvasPosition() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;
      var outMode = options.particles.move.outMode;
      var newPos;

      if (outMode === _OutMode.OutMode.bounce) {
        newPos = {
          x_left: particle.radius,
          x_right: container.canvas.dimension.width,
          y_bottom: container.canvas.dimension.height,
          y_top: particle.radius
        };
      } else if (outMode === _OutMode.OutMode.bounceHorizontal) {
        newPos = {
          x_left: particle.radius,
          x_right: container.canvas.dimension.width,
          y_bottom: container.canvas.dimension.height + particle.radius - particle.offset.y,
          y_top: -particle.radius - particle.offset.y
        };
      } else if (outMode === _OutMode.OutMode.bounceVertical) {
        newPos = {
          x_left: -particle.radius - particle.offset.x,
          x_right: container.canvas.dimension.width + particle.radius + particle.offset.x,
          y_bottom: container.canvas.dimension.height,
          y_top: particle.radius
        };
      } else {
        newPos = {
          x_left: -particle.radius - particle.offset.x,
          x_right: container.canvas.dimension.width + particle.radius + particle.offset.x,
          y_bottom: container.canvas.dimension.height + particle.radius - particle.offset.y,
          y_top: -particle.radius - particle.offset.y
        };
      }

      if (outMode === _OutMode.OutMode.destroy) {
        if (particle.position.x + particle.radius < 0 || particle.position.y + particle.radius < 0 || particle.position.x - particle.radius > container.canvas.dimension.width || particle.position.y - particle.radius > container.canvas.dimension.height) {
          var idx = container.particles.array.indexOf(particle);
          container.particles.array.splice(idx, 1);
          /* remove the canvas if the array is empty */

          var clickMode = options.interactivity.events.onClick.mode;

          if (!container.particles.array.length && !_Utils.Utils.isInArray(_ClickMode.ClickMode.push, clickMode)) {
            container.destroy();
          }
        }
      } else {
        var nextPos = {
          x_left: particle.position.x - particle.radius,
          x_right: particle.position.x + particle.radius,
          y_bottom: particle.position.y + particle.radius,
          y_top: particle.position.y - particle.radius
        };
        var dimension = container.canvas.dimension;

        if (nextPos.x_left > dimension.width - particle.offset.x) {
          particle.position.x = newPos.x_left;
          particle.position.y = Math.random() * dimension.height;
        } else if (nextPos.x_right < -particle.offset.x) {
          particle.position.x = newPos.x_right;
          particle.position.y = Math.random() * dimension.height;
        }

        if (nextPos.y_top > container.canvas.dimension.height - particle.offset.y) {
          particle.position.y = newPos.y_top;
          particle.position.x = Math.random() * container.canvas.dimension.width;
        } else if (nextPos.y_bottom < -particle.offset.y) {
          particle.position.y = newPos.y_bottom;
          particle.position.x = Math.random() * container.canvas.dimension.width;
        }
      }
    }
  }, {
    key: "updateOutMode",
    value: function updateOutMode() {
      var container = this.container;
      var options = container.options;

      switch (options.particles.move.outMode) {
        case _OutMode.OutMode.bounce:
        case _OutMode.OutMode.bounceVertical:
        case _OutMode.OutMode.bounceHorizontal:
          this.updateBounce();
          break;
      }
    }
  }, {
    key: "updateBounce",
    value: function updateBounce() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;
      /* check bounce against polygon boundaries */

      if (options.polygon.type !== _PolygonMaskType.PolygonMaskType.none && options.polygon.type !== _PolygonMaskType.PolygonMaskType.inline) {
        if (!container.polygon.checkInsidePolygon(particle.position)) {
          this.polygonBounce();
        }
      } else if (options.polygon.type === _PolygonMaskType.PolygonMaskType.inline) {
        if (particle.initialPosition) {
          var dist = _Utils.Utils.getDistanceBetweenCoordinates(particle.initialPosition, particle.position);

          if (dist > container.retina.polygonMaskMoveRadius) {
            this.polygonBounce();
          }
        }
      } else {
        var outMode = options.particles.move.outMode;
        var x = particle.position.x + particle.offset.x;
        var y = particle.position.y + particle.offset.y;

        if (outMode === _OutMode.OutMode.bounce || outMode === _OutMode.OutMode.bounceHorizontal) {
          Updater.checkBounds(x, particle.radius, container.canvas.dimension.width, function () {
            particle.velocity.horizontal = -particle.velocity.horizontal;
          });
        }

        if (outMode === _OutMode.OutMode.bounce || outMode === _OutMode.OutMode.bounceVertical) {
          Updater.checkBounds(y, particle.radius, container.canvas.dimension.height, function () {
            particle.velocity.vertical = -particle.velocity.vertical;
          });
        }
      }
    }
  }, {
    key: "polygonBounce",
    value: function polygonBounce() {
      var particle = this.particle;
      particle.velocity.horizontal = -particle.velocity.horizontal + particle.velocity.vertical / 2;
      particle.velocity.vertical = -particle.velocity.vertical + particle.velocity.horizontal / 2;
    }
  }], [{
    key: "checkBounds",
    value: function checkBounds(coordinate, radius, size, outside) {
      if (coordinate + radius > size || coordinate - radius < 0) {
        outside();
      }
    }
  }]);
  return Updater;
}();

exports.Updater = Updater;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9DbGFzc2VzL1BhcnRpY2xlL1VwZGF0ZXIudHMiXSwibmFtZXMiOlsiVXBkYXRlciIsImNvbnRhaW5lciIsInBhcnRpY2xlIiwibW92ZXIiLCJNb3ZlciIsImRlbHRhIiwibW92ZSIsInVwZGF0ZU9wYWNpdHkiLCJ1cGRhdGVTaXplIiwidXBkYXRlQW5nbGUiLCJmaXhPdXRPZkNhbnZhc1Bvc2l0aW9uIiwidXBkYXRlT3V0TW9kZSIsIm9wdGlvbnMiLCJwYXJ0aWNsZXMiLCJvcGFjaXR5IiwiYW5pbWF0aW9uIiwiZW5hYmxlIiwic3RhdHVzIiwidmFsdWUiLCJ2ZWxvY2l0eSIsIm1pbmltdW1WYWx1ZSIsInNpemUiLCJyYWRpdXMiLCJyZXRpbmEiLCJzaXplVmFsdWUiLCJyb3RhdGUiLCJkaXJlY3Rpb24iLCJSb3RhdGVEaXJlY3Rpb24iLCJjbG9ja3dpc2UiLCJhbmdsZSIsInNwZWVkIiwiTWF0aCIsIlBJIiwiY291bnRlckNsb2Nrd2lzZSIsIm91dE1vZGUiLCJuZXdQb3MiLCJPdXRNb2RlIiwiYm91bmNlIiwieF9sZWZ0IiwieF9yaWdodCIsImNhbnZhcyIsImRpbWVuc2lvbiIsIndpZHRoIiwieV9ib3R0b20iLCJoZWlnaHQiLCJ5X3RvcCIsImJvdW5jZUhvcml6b250YWwiLCJvZmZzZXQiLCJ5IiwiYm91bmNlVmVydGljYWwiLCJ4IiwiZGVzdHJveSIsInBvc2l0aW9uIiwiaWR4IiwiYXJyYXkiLCJpbmRleE9mIiwic3BsaWNlIiwiY2xpY2tNb2RlIiwiaW50ZXJhY3Rpdml0eSIsImV2ZW50cyIsIm9uQ2xpY2siLCJtb2RlIiwibGVuZ3RoIiwiVXRpbHMiLCJpc0luQXJyYXkiLCJDbGlja01vZGUiLCJwdXNoIiwibmV4dFBvcyIsInJhbmRvbSIsInVwZGF0ZUJvdW5jZSIsInBvbHlnb24iLCJ0eXBlIiwiUG9seWdvbk1hc2tUeXBlIiwibm9uZSIsImlubGluZSIsImNoZWNrSW5zaWRlUG9seWdvbiIsInBvbHlnb25Cb3VuY2UiLCJpbml0aWFsUG9zaXRpb24iLCJkaXN0IiwiZ2V0RGlzdGFuY2VCZXR3ZWVuQ29vcmRpbmF0ZXMiLCJwb2x5Z29uTWFza01vdmVSYWRpdXMiLCJjaGVja0JvdW5kcyIsImhvcml6b250YWwiLCJ2ZXJ0aWNhbCIsImNvb3JkaW5hdGUiLCJvdXRzaWRlIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7OztBQUdBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOzs7SUFHYUEsTztBQUtULG1CQUFZQyxTQUFaLEVBQWtDQyxRQUFsQyxFQUFzRDtBQUFBO0FBQUEsU0FKckNBLFFBSXFDO0FBQUEsU0FIckNELFNBR3FDO0FBQUEsU0FGckNFLEtBRXFDO0FBQ2xELFNBQUtGLFNBQUwsR0FBaUJBLFNBQWpCO0FBQ0EsU0FBS0MsUUFBTCxHQUFnQkEsUUFBaEI7QUFDQSxTQUFLQyxLQUFMLEdBQWEsSUFBSUMsWUFBSixDQUFVSCxTQUFWLEVBQXFCQyxRQUFyQixDQUFiO0FBQ0g7Ozs7MkJBUWFHLEssRUFBcUI7QUFDL0I7QUFDQSxXQUFLRixLQUFMLENBQVdHLElBQVgsQ0FBZ0JELEtBQWhCO0FBRUE7O0FBQ0EsV0FBS0UsYUFBTDtBQUVBOztBQUNBLFdBQUtDLFVBQUw7QUFFQTs7QUFDQSxXQUFLQyxXQUFMO0FBRUE7O0FBQ0EsV0FBS0Msc0JBQUw7QUFFQTs7QUFDQSxXQUFLQyxhQUFMO0FBQ0g7OztvQ0FFNkI7QUFDMUIsVUFBTVYsU0FBUyxHQUFHLEtBQUtBLFNBQXZCO0FBQ0EsVUFBTVcsT0FBTyxHQUFHWCxTQUFTLENBQUNXLE9BQTFCO0FBQ0EsVUFBTVYsUUFBUSxHQUFHLEtBQUtBLFFBQXRCOztBQUVBLFVBQUlVLE9BQU8sQ0FBQ0MsU0FBUixDQUFrQkMsT0FBbEIsQ0FBMEJDLFNBQTFCLENBQW9DQyxNQUF4QyxFQUFnRDtBQUM1QyxZQUFJZCxRQUFRLENBQUNZLE9BQVQsQ0FBaUJHLE1BQXJCLEVBQTZCO0FBQ3pCLGNBQUlmLFFBQVEsQ0FBQ1ksT0FBVCxDQUFpQkksS0FBakIs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LENBQUNpQixRQUFULENBQWtCZ0UsUUFBbEIsR0FBNkIsQ0FBN0Y7QUFDQWpGLE1BQUFBLFFBQVEsQ0FBQ2lCLFFBQVQsQ0FBa0JnRSxRQUFsQixHQUE2QixDQUFDakYsUUFBUSxDQUFDaUIsUUFBVCxDQUFrQmdFLFFBQW5CLEdBQStCakYsUUFBUSxDQUFDaUIsUUFBVCxDQUFrQitELFVBQWxCLEdBQStCLENBQTNGO0FBQ0g7OztnQ0F4TzBCRSxVLEVBQW9COUQsTSxFQUFnQkQsSSxFQUFjZ0UsTyxFQUEyQjtBQUNwRyxVQUFLRCxVQUFVLEdBQUc5RCxNQUFiLEdBQXNCRCxJQUF2QixJQUFpQytELFVBQVUsR0FBRzlELE1BQWIsR0FBc0IsQ0FBM0QsRUFBK0Q7QUFDM0QrRCxRQUFBQSxPQUFPO0FBQ1Y7QUFDSiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQge0NvbnRhaW5lcn0gZnJvbSBcIi4uL0NvbnRhaW5lclwiO1xuaW1wb3J0IHtPdXRNb2RlfSBmcm9tIFwiLi4vLi4vRW51bXMvT3V0TW9kZVwiO1xuaW1wb3J0IHtQYXJ0aWNsZX0gZnJvbSBcIi4uL1BhcnRpY2xlXCI7XG5pbXBvcnQge1V0aWxzfSBmcm9tIFwiLi4vVXRpbHMvVXRpbHNcIjtcbmltcG9ydCB7Q2xpY2tNb2RlfSBmcm9tIFwiLi4vLi4vRW51bXMvTW9kZXMvQ2xpY2tNb2RlXCI7XG5pbXBvcnQge1BvbHlnb25NYXNrVHlwZX0gZnJvbSBcIi4uLy4uL0VudW1zL1BvbHlnb25NYXNrVHlwZVwiO1xuaW1wb3J0IHtNb3Zlcn0gZnJvbSBcIi4vTW92ZXJcIjtcbmltcG9ydCB7Um90YXRlRGlyZWN0aW9ufSBmcm9tIFwiLi4vLi4vRW51bXMvUm90YXRlRGlyZWN0aW9uXCI7XG5cbi8qKlxuICogUGFydGljbGUgdXBkYXRlciwgaXQgbWFuYWdlcyBtb3ZlbWVudFxuICovXG5leHBvcnQgY2xhc3MgVXBkYXRlciB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBwYXJ0aWNsZTogUGFydGljbGU7XG4gICAgcHJpdmF0ZSByZWFkb25seSBjb250YWluZXI6IENvbnRhaW5lcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IG1vdmVyOiBNb3ZlcjtcblxuICAgIGNvbnN0cnVjdG9yKGNvbnRhaW5lcjogQ29udGFpbmVyLCBwYXJ0aWNsZTogUGFydGljbGUpIHtcbiAgICAgICAgdGhpcy5jb250YWluZXIgPSBjb250YWluZXI7XG4gICAgICAgIHRoaXMucGFydGljbGUgPSBwYXJ0aWNsZTtcbiAgICAgICAgdGhpcy5tb3ZlciA9IG5ldyBNb3Zlcihjb250YWluZXIsIHBhcnRpY2xlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBjaGVja0JvdW5kcyhjb29yZGluYXRlOiBudW1iZXIsIHJhZGl1czogbnVtYmVyLCBzaXplOiBudW1iZXIsIG91dHNpZGU6ICgpID0+IHZvaWQpOiB2b2lkIHtcbiAgICAgICAgaWYgKChjb29yZGluYXRlICsgcmFkaXVzID4gc2l6ZSkgfHwgKGNvb3JkaW5hdGUgLSByYWRpdXMgPCAwKSkge1xuICAgICAgICAgICAgb3V0c2lkZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHVwZGF0ZShkZWx0YTogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIC8qIG1vdmUgdGhlIHBhcnRpY2xlICovXG4gICAgICAgIHRoaXMubW92ZXIubW92ZShkZWx0YSk7XG5cbiAgICAgICAgLyogY2hhbmdlIG9wYWNpdHkgc3RhdHVzICovXG4gICAgICAgIHRoaXMudXBkYXRlT3BhY2l0eSgpO1xuXG4gICAgICAgIC8qIGNoYW5nZSBzaXplICovXG4gICAgICAgIHRoaXMudXBkYXRlU2l6ZSgpO1xuXG4gICAgICAgIC8qIGNoYW5nZSBzaXplICovXG4gICAgICAgIHRoaXMudXBkYXRlQW5nbGUoKTtcblxuICAgICAgICAvKiBjaGFuZ2UgcGFydGljbGUgcG9zaXRpb24gaWYgaXQgaXMgb3V0IG9mIGNhbnZhcyAqL1xuICAgICAgICB0aGlzLmZpeE91dE9mQ2FudmFzUG9zaXRpb24oKTtcblxuICAgICAgICAvKiBvdXQgb2YgY2FudmFzIG1vZGVzICovXG4gICAgICAgIHRoaXMudXBkYXRlT3V0TW9kZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgdXBkYXRlT3BhY2l0eSgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jb250YWluZXI7XG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSBjb250YWluZXIub3B0aW9ucztcbiAgICAgICAgY29uc3QgcGFydGljbGUgPSB0aGlzLnBhcnRpY2xlO1xuXG4gICAgICAgIGlmIChvcHRpb25zLnBhcnRpY2xlcy5vcGFjaXR5LmFuaW1hdGlvbi5lbmFibGUpIHtcbiAgICAgICAgICAgIGlmIChwYXJ0aWNsZS5vcGFjaXR5LnN0YXR1cykge1xuICAgICAgICAgICAgICAgIGlmIChwYXJ0aWNsZS5vcGFjaXR5LnZhbHVlID49IG9wdGlvbnMucGFydGljbGVzLm9wYWNpdHkudmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFydGljbGUub3BhY2l0eS5zdGF0dXMgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBwYXJ0aWNsZS5vcGFjaXR5LnZhbHVlICs9IChwYXJ0aWNsZS5vcGFjaXR5LnZlbG9jaXR5IHx8IDApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAocGFydGljbGUub3BhY2l0eS52YWx1ZSA8PSBvcHRpb25zLnBhcnRpY2xlcy5vcGFjaXR5LmFuaW1hdGlvbi5taW5pbXVtVmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFydGljbGUub3BhY2l0eS5zdGF0dXMgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHBhcnRpY2xlLm9wYWNpdHkudmFsdWUgLT0gKHBhcnRpY2xlLm9wYWNpdHkudmVsb2NpdHkgfHwgMCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChwYXJ0aWNsZS5vcGFjaXR5LnZhbHVlIDwgMCkge1xuICAgICAgICAgICAgICAgIHBhcnRpY2xlLm9wYWNpdHkudmFsdWUgPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVTaXplKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcjtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGNvbnRhaW5lci5vcHRpb25zO1xuICAgICAgICBjb25zdCBwYXJ0aWNsZSA9IHRoaXMucGFydGljbGU7XG5cbiAgICAgICAgaWYgKG9wdGlvbnMucGFydGljbGVzLnNpemUuYW5pbWF0aW9uLmVuYWJsZSkge1xuICAgICAgICAgICAgaWYgKHBhcnRpY2xlLnNpemUuc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBhcnRpY2xlLnJhZGl1cyA+PSBjb250YWluZXIucmV0aW5hLnNpemVWYWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICBwYXJ0aWNsZS5zaXplLnN0YXR1cyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHBhcnRpY2xlLnJhZGl1cyArPSAocGFydGljbGUuc2l6ZS52ZWxvY2l0eSB8fCAwKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHBhcnRpY2xlLnJhZGl1cyA8PSBvcHRpb25zLnBhcnRpY2xlcy5zaXplLmFuaW1hdGlvbi5taW5pbXVtVmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFydGljbGUuc2l6ZS5zdGF0dXMgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHBhcnRpY2xlLnJhZGl1cyAtPSAocGFydGljbGUuc2l6ZS52ZWxvY2l0eSB8fCAwKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHBhcnRpY2xlLnJhZGl1cyA8IDApIHtcbiAgICAgICAgICAgICAgICBwYXJ0aWNsZS5yYWRpdXMgPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVBbmdsZSgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jb250YWluZXI7XG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSBjb250YWluZXIub3B0aW9ucztcbiAgICAgICAgY29uc3QgcGFydGljbGUgPSB0aGlzLnBhcnRpY2xlO1xuXG4gICAgICAgIGlmIChvcHRpb25zLnBhcnRpY2xlcy5yb3RhdGUuYW5pbWF0aW9uLmVuYWJsZSkge1xuICAgICAgICAgICAgc3dpdGNoIChvcHRpb25zLnBhcnRpY2xlcy5yb3RhdGUuZGlyZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgY2FzZSBSb3RhdGVEaXJlY3Rpb24uY2xvY2t3aXNlOlxuICAgICAgICAgICAgICAgICAgICBwYXJ0aWNsZS5hbmdsZSArPSBvcHRpb25zLnBhcnRpY2xlcy5yb3RhdGUuYW5pbWF0aW9uLnNwZWVkICogTWF0aC5QSSAvIDE4O1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlIFJvdGF0ZURpcmVjdGlvbi5jb3VudGVyQ2xvY2t3aXNlOlxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgIHBhcnRpY2xlLmFuZ2xlIC09IG9wdGlvbnMucGFydGljbGVzLnJvdGF0ZS5hbmltYXRpb24uc3BlZWQgKiBNYXRoLlBJIC8gMTg7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBmaXhPdXRPZkNhbnZhc1Bvc2l0aW9uKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcjtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGNvbnRhaW5lci5vcHRpb25zO1xuICAgICAgICBjb25zdCBwYXJ0aWNsZSA9IHRoaXMucGFydGljbGU7XG4gICAgICAgIGNvbnN0IG91dE1vZGUgPSBvcHRpb25zLnBhcnRpY2xlcy5tb3ZlLm91dE1vZGU7XG5cbiAgICAgICAgbGV0IG5ld1BvcztcblxuICAgICAgICBpZiAob3V0TW9kZSA9PT0gT3V0TW9kZS5ib3VuY2UpIHtcbiAgICAgICAgICAgIG5ld1BvcyA9IHtcbiAgICAgICAgICAgICAgICB4X2xlZnQ6IHBhcnRpY2xlLnJhZGl1cyxcbiAgICAgICAgICAgICAgICB4X3JpZ2h0OiBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi53aWR0aCxcbiAgICAgICAgICAgICAgICB5X2JvdHRvbTogY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24uaGVpZ2h0LFxuICAgICAgICAgICAgICAgIHlfdG9wOiBwYXJ0aWNsZS5yYWRpdXMsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2UgaWYgKG91dE1vZGUgPT09IE91dE1vZGUuYm91bmNlSG9yaXpvbnRhbCkge1xuICAgICAgICAgICAgbmV3UG9zID0ge1xuICAgICAgICAgICAgICAgIHhfbGVmdDogcGFydGljbGUucmFkaXVzLFxuICAgICAgICAgICAgICAgIHhfcmlnaHQ6IGNvbnRhaW5lci5jYW52YXMuZGltZW5zaW9uLndpZHRoLFxuICAgICAgICAgICAgICAgIHlfYm90dG9tOiBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi5oZWlnaHQgKyBwYXJ0aWNsZS5yYWRpdXMgLSBwYXJ0aWNsZS5vZmZzZXQueSxcbiAgICAgICAgICAgICAgICB5X3RvcDogLXBhcnRpY2xlLnJhZGl1cyAtIHBhcnRpY2xlLm9mZnNldC55LFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSBlbHNlIGlmIChvdXRNb2RlID09PSBPdXRNb2RlLmJvdW5jZVZlcnRpY2FsKSB7XG4gICAgICAgICAgICBuZXdQb3MgPSB7XG4gICAgICAgICAgICAgICAgeF9sZWZ0OiAtcGFydGljbGUucmFkaXVzIC0gcGFydGljbGUub2Zmc2V0LngsXG4gICAgICAgICAgICAgICAgeF9yaWdodDogY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24ud2lkdGggKyBwYXJ0aWNsZS5yYWRpdXMgKyBwYXJ0aWNsZS5vZmZzZXQueCxcbiAgICAgICAgICAgICAgICB5X2JvdHRvbTogY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24uaGVpZ2h0LFxuICAgICAgICAgICAgICAgIHlfdG9wOiBwYXJ0aWNsZS5yYWRpdXMsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbmV3UG9zID0ge1xuICAgICAgICAgICAgICAgIHhfbGVmdDogLXBhcnRpY2xlLnJhZGl1cyAtIHBhcnRpY2xlLm9mZnNldC54LFxuICAgICAgICAgICAgICAgIHhfcmlnaHQ6IGNvbnRhaW5lci5jYW52YXMuZGltZW5zaW9uLndpZHRoICsgcGFydGljbGUucmFkaXVzICsgcGFydGljbGUub2Zmc2V0LngsXG4gICAgICAgICAgICAgICAgeV9ib3R0b206IGNvbnRhaW5lci5jYW52YXMuZGltZW5zaW9uLmhlaWdodCArIHBhcnRpY2xlLnJhZGl1cyAtIHBhcnRpY2xlLm9mZnNldC55LFxuICAgICAgICAgICAgICAgIHlfdG9wOiAtcGFydGljbGUucmFkaXVzIC0gcGFydGljbGUub2Zmc2V0LnksXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG91dE1vZGUgPT09IE91dE1vZGUuZGVzdHJveSkge1xuICAgICAgICAgICAgaWYgKHBhcnRpY2xlLnBvc2l0aW9uLnggKyBwYXJ0aWNsZS5yYWRpdXMgPCAwIHx8XG4gICAgICAgICAgICAgICAgcGFydGljbGUucG9zaXRpb24ueSArIHBhcnRpY2xlLnJhZGl1cyA8IDAgfHxcbiAgICAgICAgICAgICAgICBwYXJ0aWNsZS5wb3NpdGlvbi54IC0gcGFydGljbGUucmFkaXVzID4gY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24ud2lkdGggfHxcbiAgICAgICAgICAgICAgICBwYXJ0aWNsZS5wb3NpdGlvbi55IC0gcGFydGljbGUucmFkaXVzID4gY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24uaGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaWR4ID0gY29udGFpbmVyLnBhcnRpY2xlcy5hcnJheS5pbmRleE9mKHBhcnRpY2xlKTtcbiAgICAgICAgICAgICAgICBjb250YWluZXIucGFydGljbGVzLmFycmF5LnNwbGljZShpZHgsIDEpO1xuXG4gICAgICAgICAgICAgICAgLyogcmVtb3ZlIHRoZSBjYW52YXMgaWYgdGhlIGFycmF5IGlzIGVtcHR5ICovXG4gICAgICAgICAgICAgICAgY29uc3QgY2xpY2tNb2RlID0gb3B0aW9ucy5pbnRlcmFjdGl2aXR5LmV2ZW50cy5vbkNsaWNrLm1vZGU7XG5cbiAgICAgICAgICAgICAgICBpZiAoIWNvbnRhaW5lci5wYXJ0aWNsZXMuYXJyYXkubGVuZ3RoICYmICFVdGlscy5pc0luQXJyYXkoQ2xpY2tNb2RlLnB1c2gsIGNsaWNrTW9kZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLmRlc3Ryb3koKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBuZXh0UG9zID0ge1xuICAgICAgICAgICAgICAgIHhfbGVmdDogcGFydGljbGUucG9zaXRpb24ueCAtIHBhcnRpY2xlLnJhZGl1cyxcbiAgICAgICAgICAgICAgICB4X3JpZ2h0OiBwYXJ0aWNsZS5wb3NpdGlvbi54ICsgcGFydGljbGUucmFkaXVzLFxuICAgICAgICAgICAgICAgIHlfYm90dG9tOiBwYXJ0aWNsZS5wb3NpdGlvbi55ICsgcGFydGljbGUucmFkaXVzLFxuICAgICAgICAgICAgICAgIHlfdG9wOiBwYXJ0aWNsZS5wb3NpdGlvbi55IC0gcGFydGljbGUucmFkaXVzLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNvbnN0IGRpbWVuc2lvbiA9IGNvbnRhaW5lci5jYW52YXMuZGltZW5zaW9uO1xuXG4gICAgICAgICAgICBpZiAobmV4dFBvcy54X2xlZnQgPiBkaW1lbnNpb24ud2lkdGggLSBwYXJ0aWNsZS5vZmZzZXQueCkge1xuICAgICAgICAgICAgICAgIHBhcnRpY2xlLnBvc2l0aW9uLnggPSBuZXdQb3MueF9sZWZ0O1xuICAgICAgICAgICAgICAgIHBhcnRpY2xlLnBvc2l0aW9uLnkgPSBNYXRoLnJhbmRvbSgpICogZGltZW5zaW9uLmhlaWdodDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobmV4dFBvcy54X3JpZ2h0IDwgLXBhcnRpY2xlLm9mZnNldC54KSB7XG4gICAgICAgICAgICAgICAgcGFydGljbGUucG9zaXRpb24ueCA9IG5ld1Bvcy54X3JpZ2h0O1xuICAgICAgICAgICAgICAgIHBhcnRpY2xlLnBvc2l0aW9uLnkgPSBNYXRoLnJhbmRvbSgpICogZGltZW5zaW9uLmhlaWdodDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKG5leHRQb3MueV90b3AgPiBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi5oZWlnaHQgLSBwYXJ0aWNsZS5vZmZzZXQueSkge1xuICAgICAgICAgICAgICAgIHBhcnRpY2xlLnBvc2l0aW9uLnkgPSBuZXdQb3MueV90b3A7XG4gICAgICAgICAgICAgICAgcGFydGljbGUucG9zaXRpb24ueCA9IE1hdGgucmFuZG9tKCkgKiBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi53aWR0aDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobmV4dFBvcy55X2JvdHRvbSA8IC1wYXJ0aWNsZS5vZmZzZXQueSkge1xuICAgICAgICAgICAgICAgIHBhcnRpY2xlLnBvc2l0aW9uLnkgPSBuZXdQb3MueV9ib3R0b207XG4gICAgICAgICAgICAgICAgcGFydGljbGUucG9zaXRpb24ueCA9IE1hdGgucmFuZG9tKCkgKiBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi53aWR0aDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgdXBkYXRlT3V0TW9kZSgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jb250YWluZXI7XG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSBjb250YWluZXIub3B0aW9ucztcblxuICAgICAgICBzd2l0Y2ggKG9wdGlvbnMucGFydGljbGVzLm1vdmUub3V0TW9kZSkge1xuICAgICAgICAgICAgY2FzZSBPdXRNb2RlLmJvdW5jZTpcbiAgICAgICAgICAgIGNhc2UgT3V0TW9kZS5ib3VuY2VWZXJ0aWNhbDpcbiAgICAgICAgICAgIGNhc2UgT3V0TW9kZS5ib3VuY2VIb3Jpem9udGFsOlxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQm91bmNlKCk7XG5cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgdXBkYXRlQm91bmNlKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcjtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGNvbnRhaW5lci5vcHRpb25zO1xuICAgICAgICBjb25zdCBwYXJ0aWNsZSA9IHRoaXMucGFydGljbGU7XG5cbiAgICAgICAgLyogY2hlY2sgYm91bmNlIGFnYWluc3QgcG9seWdvbiBib3VuZGFyaWVzICovXG4gICAgICAgIGlmIChvcHRpb25zLnBvbHlnb24udHlwZSAhPT0gUG9seWdvbk1hc2tUeXBlLm5vbmUgJiYgb3B0aW9ucy5wb2x5Z29uLnR5cGUgIT09IFBvbHlnb25NYXNrVHlwZS5pbmxpbmUpIHtcbiAgICAgICAgICAgIGlmICghY29udGFpbmVyLnBvbHlnb24uY2hlY2tJbnNpZGVQb2x5Z29uKHBhcnRpY2xlLnBvc2l0aW9uKSkge1xuICAgICAgICAgICAgICAgIHRoaXMucG9seWdvbkJvdW5jZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMucG9seWdvbi50eXBlID09PSBQb2x5Z29uTWFza1R5cGUuaW5saW5lKSB7XG4gICAgICAgICAgICBpZiAocGFydGljbGUuaW5pdGlhbFBvc2l0aW9uKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IFV0aWxzLmdldERpc3RhbmNlQmV0d2VlbkNvb3JkaW5hdGVzKHBhcnRpY2xlLmluaXRpYWxQb3NpdGlvbiwgcGFydGljbGUucG9zaXRpb24pO1xuXG4gICAgICAgICAgICAgICAgaWYgKGRpc3QgPiBjb250YWluZXIucmV0aW5hLnBvbHlnb25NYXNrTW92ZVJhZGl1cykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnBvbHlnb25Cb3VuY2UoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBvdXRNb2RlID0gb3B0aW9ucy5wYXJ0aWNsZXMubW92ZS5vdXRNb2RlO1xuICAgICAgICAgICAgY29uc3QgeCA9IHBhcnRpY2xlLnBvc2l0aW9uLnggKyBwYXJ0aWNsZS5vZmZzZXQueDtcbiAgICAgICAgICAgIGNvbnN0IHkgPSBwYXJ0aWNsZS5wb3NpdGlvbi55ICsgcGFydGljbGUub2Zmc2V0Lnk7XG5cbiAgICAgICAgICAgIGlmIChvdXRNb2RlID09PSBPdXRNb2RlLmJvdW5jZSB8fCBvdXRNb2RlID09PSBPdXRNb2RlLmJvdW5jZUhvcml6b250YWwpIHtcbiAgICAgICAgICAgICAgICBVcGRhdGVyLmNoZWNrQm91bmRzKHgsIHBhcnRpY2xlLnJhZGl1cywgY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24ud2lkdGgsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcGFydGljbGUudmVsb2NpdHkuaG9yaXpvbnRhbCA9IC1wYXJ0aWNsZS52ZWxvY2l0eS5ob3Jpem9udGFsO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAob3V0TW9kZSA9PT0gT3V0TW9kZS5ib3VuY2UgfHwgb3V0TW9kZSA9PT0gT3V0TW9kZS5ib3VuY2VWZXJ0aWNhbCkge1xuICAgICAgICAgICAgICAgIFVwZGF0ZXIuY2hlY2tCb3VuZHMoeSwgcGFydGljbGUucmFkaXVzLCBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi5oZWlnaHQsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcGFydGljbGUudmVsb2NpdHkudmVydGljYWwgPSAtcGFydGljbGUudmVsb2NpdHkudmVydGljYWw7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHBvbHlnb25Cb3VuY2UoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHBhcnRpY2xlID0gdGhpcy5wYXJ0aWNsZTtcblxuICAgICAgICBwYXJ0aWNsZS52ZWxvY2l0eS5ob3Jpem9udGFsID0gLXBhcnRpY2xlLnZlbG9jaXR5Lmhvcml6b250YWwgKyAocGFydGljbGUudmVsb2NpdHkudmVydGljYWwgLyAyKTtcbiAgICAgICAgcGFydGljbGUudmVsb2NpdHkudmVydGljYWwgPSAtcGFydGljbGUudmVsb2NpdHkudmVydGljYWwgKyAocGFydGljbGUudmVsb2NpdHkuaG9yaXpvbnRhbCAvIDIpO1xuICAgIH1cbn1cbiJdfQ==