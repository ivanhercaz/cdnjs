var __awaiter=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))(function(a,n){function r(t){try{h(s.next(t))}catch(t){n(t)}}function o(t){try{h(s.throw(t))}catch(t){n(t)}}function h(t){var e;t.done?a(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(r,o)}h((s=s.apply(t,e||[])).next())})};import{Canvas}from"./Canvas";import{EventListeners}from"./Utils/EventListeners";import{Particles}from"./Particles";import{Retina}from"./Retina";import{ShapeType}from"../Enums/ShapeType";import{PolygonMask}from"./PolygonMask";import{FrameManager}from"./FrameManager";import{Options}from"./Options/Options";import{Utils}from"./Utils/Utils";import{Presets}from"./Utils/Presets";window.customRequestAnimationFrame=(()=>window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||(t=>window.setTimeout(t,1e3/60)))(),window.customCancelRequestAnimationFrame=(()=>window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout)();export class Container{constructor(t,e,...i){this.started=!1,this.destroyed=!1,this.id=t,this.paused=!0,this.sourceOptions=e,this.lastFrameTime=0,this.pageHidden=!1,this.retina=new Retina(this),this.canvas=new Canvas(this),this.particles=new Particles(this),this.polygon=new PolygonMask(this),this.drawer=new FrameManager(this),this.interactivity={mouse:{}},this.images=[],this.bubble={},this.repulse={},this.options=new Options;for(const t of i)this.options.load(Presets.getPreset(t));this.sourceOptions&&this.options.load(this.sourceOptions),this.eventListeners=new EventListeners(this)}static requestFrame(t){return window.customRequestAnimationFrame(t)}static cancelAnimation(t){window.cancelAnimationFrame(t)}play(){this.paused&&(this.lastFrameTime=performance.now(),this.paused=!1),this.drawAnimationFrame=Container.requestFrame(t=>this.drawer.nextFrame(t))}pause(){void 0!==this.drawAnimationFrame&&(Container.cancelAnimation(this.drawAnimationFrame),delete this.drawAnimationFrame,this.paused=!0)}densityAutoParticles(){if(!this.canvas.element||!this.options.particles.number.density.enable)return;let t=this.canvas.element.width*this.canvas.element.height/1e3;this.retina.isRetina&&(t/=2*this.retina.pxRatio);const e=t*this.options.particles.number.value/this.options.particles.number.density.area,i=this.particles.count;i<e?this.particles.push(Math.abs(e-i)):i>e&&this.particles.removeQuantity(i-e)}destroy(){this.stop(),this.retina.reset(),this.canvas.destroy(),delete this.interactivity,delete this.options,delete this.retina,delete this.canvas,delete this.particles,delete this.polygon,delete this.bubble,delete this.repulse,delete this.images,delete this.drawer,delete this.eventListeners,this.destroyed=!0}exportImg(t){this.exportImage(t)}exportImage(t,e,i){var s;return null===(s=this.canvas.element)||void 0===s?void 0:s.toBlob(t,null!=e?e:"image/png",i)}exportConfiguration(){return JSON.stringify(this.options,void 0,2)}loadImage(t,e){return new Promise((i,s)=>{if(t.error=!1,e.src){const a=new Image;a.addEventListener("load",()=>{t.obj=a,i()}),a.addEventListener("error",()=>{t.error=!0,s(`Error tsParticles - loading image: ${e.src}`)}),a.src=e.src}else t.error=!0,s("Error tsParticles - No image.src")})}refresh(){return __awaiter(this,void 0,void 0,function*(){this.stop(),yield this.start()})}stop(){this.started&&(this.started=!1,this.eventListeners.removeListeners(),this.pause(),this.images=[],this.particles.clear(),this.retina.reset(),this.canvas.clear(),delete this.particles.lineLinkedColor,delete this.polygon.raw,delete this.polygon.path,delete this.polygon.svg)}start(){return __awaiter(this,void 0,void 0,function*(){if(!this.started){if(this.started=!0,this.eventListeners.addListeners(),this.options.polygon.enable&&this.options.polygon.url&&(this.polygon.raw=yield this.polygon.parseSvgPathToPolygon(this.options.polygon.url)),Utils.isInArray(ShapeType.char,this.options.particles.shape.type)||Utils.isInArray(ShapeType.character,this.options.particles.shape.type))if(this.options.particles.shape.character instanceof Array)for(const t of this.options.particles.shape.character)yield Utils.loadFont(t);else{const t=this.options.particles.shape.character;yield Utils.loadFont(t)}if(Utils.isInArray(ShapeType.image,this.options.particles.shape.type))if(this.options.particles.shape.image instanceof Array)for(const t of this.options.particles.shape.image)yield this.loadImageShape(t);else yield this.loadImageShape(this.options.particles.shape.image);this.checkBeforeDraw()}})}loadImageShape(t){return __awaiter(this,void 0,void 0,function*(){const e=t.src,i={error:!1};i.type=e.substr(e.length-3),yield this.loadImage(i,t),this.images.push(i)})}init(){this.retina.init(),this.canvas.init(),this.particles.init(),this.densityAutoParticles()}checkBeforeDraw(){this.options.particles.shape.type===ShapeType.image&&this.images.every(t=>t.error)||(this.init(),this.play())}};