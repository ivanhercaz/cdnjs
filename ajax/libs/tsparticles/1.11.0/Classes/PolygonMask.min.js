var __awaiter=this&&this.__awaiter||function(t,n,o,e){return new(o||(o=Promise))(function(a,i){function s(t){try{r(e.next(t))}catch(t){i(t)}}function h(t){try{r(e.throw(t))}catch(t){i(t)}}function r(t){var n;t.done?a(t.value):(n=t.value,n instanceof o?n:new o(function(t){t(n)})).then(s,h)}r((e=e.apply(t,n||[])).next())})};import{PolygonMaskType}from"../Enums/PolygonMaskType";import{Particle}from"./Particle";import{PolygonMaskInlineArrangement}from"../Enums/PolygonMaskInlineArrangement";import{Utils}from"./Utils/Utils";export class PolygonMask{constructor(t){this.container=t,this.width=0,this.height=0,this.polygonPathLength=0,this.path2DSupported=window.hasOwnProperty("Path2D")}checkInsidePolygon(t){const n=this.container,o=n.options;if(!o.polygon.enable||o.polygon.type===PolygonMaskType.none||o.polygon.type===PolygonMaskType.inline)return!0;if(!this.raw)return console.error("No polygon found, you need to specify SVG url in config."),!0;const e=t?t.x:Math.random()*n.canvas.dimension.width,a=t?t.y:Math.random()*n.canvas.dimension.height;let i=!1;if(this.path2DSupported&&this.polygonPath&&t)i=n.canvas.isPointInPath(this.polygonPath,t);else for(let t=0,n=this.raw.length-1;t<this.raw.length;n=t++){const o=this.raw[t].x,s=this.raw[t].y,h=this.raw[n].x,r=this.raw[n].y;s>a!=r>a&&e<(h-o)*(a-s)/(r-s)+o&&(i=!i)}return o.polygon.type===PolygonMaskType.inside?i:o.polygon.type===PolygonMaskType.outside&&!i}randomPointInPolygon(){const t=this.container,n=t.options;let o;if(n.polygon.type===PolygonMaskType.inline)switch(n.polygon.inline.arrangement){case PolygonMaskInlineArrangement.randomPoint:o=this.getRandomPointOnPolygonPath();break;case PolygonMaskInlineArrangement.randomLength:o=this.getRandomPointOnPolygonPathByLength();break;case PolygonMaskInlineArrangement.equidistant:o=this.getEquidistantPointOnPolygonPathByIndex(t.particles.count);break;case PolygonMaskInlineArrangement.onePerPoint:default:o=this.getPoingOnPolygonPathByIndex(t.particles.count)}else o={x:Math.random()*t.canvas.dimension.width,y:Math.random()*t.canvas.dimension.height};return this.checkInsidePolygon(o)?o:this.randomPointInPolygon()}parseSvgPathToPolygon(t){return __awaiter(this,void 0,void 0,function*(){const n=this.container,o=n.options,e=t||o.polygon.url;if(!this.path||!this.svg){const t=yield fetch(e);if(!t.ok)return void console.error("tsParticles Error - during polygon mask download");{const n=yield t.text(),o=(new DOMParser).parseFromString(n,"image/svg+xml");this.svg=o.getElementsByTagName("svg")[0],this.path=o.getElementsByTagName("path")[0],this.path&&(this.polygonPathLength=this.path.getTotalLength()),this.createPath2D()}}const a=o.polygon.scale;this.width=parseFloat(this.svg.getAttribute("width")||"0")*a,this.height=parseFloat(this.svg.getAttribute("height")||"0")*a,this.offset={x:n.canvas.dimension.width/2-this.width/2,y:n.canvas.dimension.height/2-this.height/2};const i=this.path.pathSegList.numberOfItems,s=[],h={x:0,y:0};for(let t=0;t<i;t++){const n=this.path.pathSegList.getItem(t);switch(n.pathSegType){case window.SVGPathSeg.PATHSEG_MOVETO_ABS:case window.SVGPathSeg.PATHSEG_LINETO_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_ABS:case window.SVGPathSeg.PATHSEG_ARC_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_ABS:const t=n;h.x=t.x,h.y=t.y;break;case window.SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_ABS:h.x=n.x;break;case window.SVGPathSeg.PATHSEG_LINETO_VERTICAL_ABS:h.y=n.y;break;case window.SVGPathSeg.PATHSEG_LINETO_REL:case window.SVGPathSeg.PATHSEG_MOVETO_REL:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_REL:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_REL:case window.SVGPathSeg.PATHSEG_ARC_REL:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_REL:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_REL:const o=n;h.x+=o.x,h.y+=o.y;break;case window.SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_REL:h.x+=n.x;break;case window.SVGPathSeg.PATHSEG_LINETO_VERTICAL_REL:h.y+=n.y;break;case window.SVGPathSeg.PATHSEG_UNKNOWN:case window.SVGPathSeg.PATHSEG_CLOSEPATH:continue}s.push({x:h.x*a+this.offset.x,y:h.y*a+this.offset.y})}return s})}drawPolygon(){const t=this.container;this.raw&&t.canvas.drawPolygonMask(this.raw)}drawPointsOnPolygonPath(){const t=this.container;if(this.raw)for(const n of this.raw){const o={x:n.x,y:n.y},e=new Particle(t,o);t.particles.addParticle(e)}}getRandomPointOnPolygonPath(){if(!this.raw||!this.raw.length)throw new Error("No polygon data loaded.");const t=Utils.itemFromArray(this.raw);return{x:t.x,y:t.y}}getRandomPointOnPolygonPathByLength(){var t,n;const o=this.container.options;if(!this.raw||!this.raw.length||!this.path)throw new Error("No polygon data loaded.");const e=Math.floor(Math.random()*this.polygonPathLength)+1,a=this.path.getPointAtLength(e);return{x:a.x*o.polygon.scale+((null===(t=this.offset)||void 0===t?void 0:t.x)||0),y:a.y*o.polygon.scale+((null===(n=this.offset)||void 0===n?void 0:n.y)||0)}}getEquidistantPointOnPolygonPathByIndex(t){var n,o;const e=this.container.options;if(!this.raw||!this.raw.length||!this.path)throw new Error("No polygon data loaded.");const a=this.polygonPathLength/e.particles.number.value*t,i=this.path.getPointAtLength(a);return{x:i.x*e.polygon.scale+((null===(n=this.offset)||void 0===n?void 0:n.x)||0),y:i.y*e.polygon.scale+((null===(o=this.offset)||void 0===o?void 0:o.y)||0)}}getPoingOnPolygonPathByIndex(t){if(!this.raw||!this.raw.length)throw new Error("No polygon data loaded.");const n=this.raw[t%this.raw.length];return{x:n.x,y:n.y}}createPath2D(){this.path2DSupported&&this.raw&&(this.polygonPath=new Path2D,this.polygonPath.moveTo(this.raw[0].x,this.raw[0].y),this.raw.forEach((t,n)=>{var o;n>0&&(null===(o=this.polygonPath)||void 0===o||o.lineTo(t.x,t.y))}),this.polygonPath.closePath())}};