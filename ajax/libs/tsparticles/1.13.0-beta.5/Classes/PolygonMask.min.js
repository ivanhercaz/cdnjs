"use strict";var __awaiter=this&&this.__awaiter||function(t,r,s,l){return new(s=s||Promise)(function(e,n){function o(t){try{i(l.next(t))}catch(t){n(t)}}function a(t){try{i(l.throw(t))}catch(t){n(t)}}function i(t){var n;t.done?e(t.value):((n=t.value)instanceof s?n:new s(function(t){t(n)})).then(o,a)}i((l=l.apply(t,r||[])).next())})},__generator=this&&this.__generator||function(e,o){var a,i,r,t,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return t={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function n(n){return function(t){return function(n){if(a)throw new TypeError("Generator is already executing.");for(;s;)try{if(a=1,i&&(r=2&n[0]?i.return:n[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,n[1])).done)return r;switch(i=0,r&&(n=[2&n[0],r.value]),n[0]){case 0:case 1:r=n;break;case 4:return s.label++,{value:n[1],done:!1};case 5:s.label++,i=n[1],n=[0];continue;case 7:n=s.ops.pop(),s.trys.pop();continue;default:if(!(r=0<(r=s.trys).length&&r[r.length-1])&&(6===n[0]||2===n[0])){s=0;continue}if(3===n[0]&&(!r||n[1]>r[0]&&n[1]<r[3])){s.label=n[1];break}if(6===n[0]&&s.label<r[1]){s.label=r[1],r=n;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(n);break}r[2]&&s.ops.pop(),s.trys.pop();continue}n=o.call(e,s)}catch(t){n=[6,t],i=0}finally{a=r=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,t])}}};Object.defineProperty(exports,"__esModule",{value:!0});var PolygonMaskType_1=require("../Enums/PolygonMaskType"),Particle_1=require("./Particle"),PolygonMaskInlineArrangement_1=require("../Enums/PolygonMaskInlineArrangement"),Utils_1=require("./Utils/Utils"),Constants_1=require("./Utils/Constants"),PolygonMask=function(){function t(t){this.container=t,this.dimension={height:0,width:0},this.paths=[],this.path2DSupported=window.hasOwnProperty("Path2D")}return t.prototype.checkInsidePolygon=function(t){var n=this.container,e=n.options;if(!e.polygon.enable||e.polygon.type===PolygonMaskType_1.PolygonMaskType.none||e.polygon.type===PolygonMaskType_1.PolygonMaskType.inline)return!0;if(!this.raw)throw new Error(Constants_1.Constants.noPolygonFound);for(var o=t?t.x:Math.random()*n.canvas.dimension.width,a=t?t.y:Math.random()*n.canvas.dimension.height,i=!1,r=0,s=this.raw.length-1;r<this.raw.length;s=r++){var l=this.raw[r].x,h=this.raw[r].y,g=this.raw[s].x,y=this.raw[s].y;a<h!=a<y&&o<(g-l)*(a-h)/(y-h)+l&&(i=!i)}return e.polygon.type===PolygonMaskType_1.PolygonMaskType.inside?i:e.polygon.type===PolygonMaskType_1.PolygonMaskType.outside&&!i},t.prototype.redraw=function(){var n=this,e=this.container,t=e.options;t.polygon.enable&&t.polygon.type!==PolygonMaskType_1.PolygonMaskType.none&&(this.redrawTimeout&&clearTimeout(this.redrawTimeout),this.redrawTimeout=window.setTimeout(function(){n.parseSvgPathToPolygon().then(function(t){n.raw=t,n.createPath2D(),e.particles.redraw()})},250))},t.prototype.init=function(){return __awaiter(this,void 0,void 0,function(){var n,e,o;return __generator(this,function(t){switch(t.label){case 0:return(n=this.container,(e=n.options).polygon.enable&&e.polygon.url)?[4,(o=this).parseSvgPathToPolygon(e.polygon.url)]:[3,2];case 1:o.raw=t.sent(),this.createPath2D(),t.label=2;case 2:return[2]}})})},t.prototype.reset=function(){delete this.raw,this.paths=[],delete this.svg},t.prototype.randomPointInPolygon=function(){var t,n=this.container,e=n.options;if(e.polygon.type===PolygonMaskType_1.PolygonMaskType.inline)switch(e.polygon.inline.arrangement){case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.randomPoint:t=this.getRandomPointOnPolygonPath();break;case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.randomLength:t=this.getRandomPointOnPolygonPathByLength();break;case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.equidistant:t=this.getEquidistantPointOnPolygonPathByIndex(n.particles.count);break;case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.onePerPoint:case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.perPoint:default:t=this.getPointOnPolygonPathByIndex(n.particles.count)}else t={x:Math.random()*n.canvas.dimension.width,y:Math.random()*n.canvas.dimension.height};return this.checkInsidePolygon(t)?t:this.randomPointInPolygon()},t.prototype.parseSvgPathToPolygon=function(v){var m;return __awaiter(this,void 0,void 0,function(){var n,e,o,a,i,r,s,l,h,g,y,c,p,P,d,u,w,_,f,S,T;return __generator(this,function(t){switch(t.label){case 0:return n=this.container,e=n.options,o=v||e.polygon.url,this.paths.length&&this.svg?[3,4]:[4,fetch(o)];case 1:return(a=t.sent()).ok?[4,a.text()]:[3,3];case 2:for(i=t.sent(),r=new DOMParser,s=r.parseFromString(i,"image/svg+xml"),this.svg=s.getElementsByTagName("svg")[0],l=s.getElementsByTagName("path"),_=0;_<l.length;_++)(d=l.item(_))&&this.paths.push({element:d,length:d.getTotalLength()});return[3,4];case 3:throw new Error("tsParticles Error - Error occurred during polygon mask download");case 4:for(h=n.retina.pixelRatio,g=e.polygon.scale/h,this.dimension.width=parseFloat(this.svg.getAttribute("width")||"0")*g,this.dimension.height=parseFloat(this.svg.getAttribute("height")||"0")*g,y=null!==(m=e.polygon.position)&&void 0!==m?m:{x:50,y:50},this.offset={x:n.canvas.dimension.width*y.x/(100*h)-this.dimension.width/2,y:n.canvas.dimension.height*y.y/(100*h)-this.dimension.height/2},c=[],p=0,P=this.paths;p<P.length;p++)for(d=P[p],u=d.element.pathSegList.numberOfItems,w={x:0,y:0},_=0;_<u;_++){switch((f=d.element.pathSegList.getItem(_)).pathSegType){case window.SVGPathSeg.PATHSEG_MOVETO_ABS:case window.SVGPathSeg.PATHSEG_LINETO_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_ABS:case window.SVGPathSeg.PATHSEG_ARC_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_ABS:S=f,w.x=S.x,w.y=S.y;break;case window.SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_ABS:w.x=f.x;break;case window.SVGPathSeg.PATHSEG_LINETO_VERTICAL_ABS:w.y=f.y;break;case window.SVGPathSeg.PATHSEG_LINETO_REL:case window.SVGPathSeg.PATHSEG_MOVETO_REL:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_REL:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_REL:case window.SVGPathSeg.PATHSEG_ARC_REL:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_REL:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_REL:T=f,w.x+=T.x,w.y+=T.y;break;case window.SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_REL:w.x+=f.x;break;case window.SVGPathSeg.PATHSEG_LINETO_VERTICAL_REL:w.y+=f.y;break;case window.SVGPathSeg.PATHSEG_UNKNOWN:case window.SVGPathSeg.PATHSEG_CLOSEPATH:continue}c.push({x:w.x*g+this.offset.x,y:w.y*g+this.offset.y})}return[2,c]}})})},t.prototype.drawPolygon=function(){this.container.canvas.drawPolygonMask()},t.prototype.drawPointsOnPolygonPath=function(){var t=this.container;if(this.raw)for(var n=0,e=this.raw;n<e.length;n++){var o=e[n],a={x:o.x,y:o.y};t.particles.addParticle(new Particle_1.Particle(t,a))}},t.prototype.getRandomPointOnPolygonPath=function(){if(!this.raw||!this.raw.length)throw new Error(Constants_1.Constants.noPolygonDataLoaded);var t=Utils_1.Utils.itemFromArray(this.raw);return{x:t.x,y:t.y}},t.prototype.getRandomPointOnPolygonPathByLength=function(){var t,n,e=this.container.options;if(!this.raw||!this.raw.length||!this.paths.length)throw new Error(Constants_1.Constants.noPolygonDataLoaded);var o=Utils_1.Utils.itemFromArray(this.paths),a=Math.floor(Math.random()*o.length)+1,i=o.element.getPointAtLength(a);return{x:i.x*e.polygon.scale+((null===(t=this.offset)||void 0===t?void 0:t.x)||0),y:i.y*e.polygon.scale+((null===(n=this.offset)||void 0===n?void 0:n.y)||0)}},t.prototype.getEquidistantPointOnPolygonPathByIndex=function(t){var n,e,o,a,i,r,s=this.container.options;if(!this.raw||!this.raw.length||!this.paths.length)throw new Error(Constants_1.Constants.noPolygonDataLoaded);for(var l,h=0,g=this.paths.reduce(function(t,n){return t+n.length},0)/s.particles.number.value,y=0,c=this.paths;y<c.length;y++){var p=c[y],P=g*t-h;if(P<=p.length){l=p.element.getPointAtLength(P);break}h+=p.length}return{x:(null!==(n=null==l?void 0:l.x)&&void 0!==n?n:0)*s.polygon.scale+(null!==(o=null===(e=this.offset)||void 0===e?void 0:e.x)&&void 0!==o?o:0),y:(null!==(a=null==l?void 0:l.y)&&void 0!==a?a:0)*s.polygon.scale+(null!==(r=null===(i=this.offset)||void 0===i?void 0:i.y)&&void 0!==r?r:0)}},t.prototype.getPointOnPolygonPathByIndex=function(t){if(!this.raw||!this.raw.length)throw new Error(Constants_1.Constants.noPolygonDataLoaded);var n=this.raw[t%this.raw.length];return{x:n.x,y:n.y}},t.prototype.createPath2D=function(){var r;if(this.path2DSupported)for(var t=function(o){var t=null===(r=o.element)||void 0===r?void 0:r.getAttribute("d");if(t){var n=new Path2D(t),e=document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGMatrix(),a=new Path2D,i=e.scale(s.container.options.polygon.scale);a.addPath?(a.addPath(n,i),o.path2d=a):delete o.path2d}else delete o.path2d;!o.path2d&&s.raw&&(o.path2d=new Path2D,o.path2d.moveTo(s.raw[0].x,s.raw[0].y),s.raw.forEach(function(t,n){var e;0<n&&null!==(e=o.path2d)&&void 0!==e&&e.lineTo(t.x,t.y)}),o.path2d.closePath())},s=this,n=0,e=this.paths;n<e.length;n++){t(e[n])}},t}();exports.PolygonMask=PolygonMask;