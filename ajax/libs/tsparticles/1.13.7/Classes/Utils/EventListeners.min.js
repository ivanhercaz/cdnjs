"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ClickMode_1=require("../../Enums/Modes/ClickMode"),InteractivityDetect_1=require("../../Enums/InteractivityDetect"),PolygonMaskType_1=require("../../Enums/PolygonMaskType"),Constants_1=require("./Constants"),Emitter_1=require("../Emitter"),Utils_1=require("./Utils"),Absorber_1=require("../Absorber"),EventListeners=function(){function a(e){var t=this;this.container=e,this.canPush=!0,this.mouseMoveHandler=function(e){return t.mouseTouchMove(e)},this.touchStartHandler=function(e){return t.mouseTouchMove(e)},this.touchMoveHandler=function(e){return t.mouseTouchMove(e)},this.touchEndHandler=function(){return t.mouseTouchFinish()},this.mouseLeaveHandler=function(){return t.mouseTouchFinish()},this.touchCancelHandler=function(){return t.mouseTouchFinish()},this.touchEndClickHandler=function(e){return t.mouseTouchClick(e)},this.mouseUpHandler=function(e){return t.mouseTouchClick(e)},this.visibilityChangeHandler=function(){return t.handleVisibilityChange()},this.resizeHandler=function(){return t.handleWindowResize()}}return a.manageListener=function(e,t,i,n,s){if(n){var o={passive:!0};"boolean"==typeof s?o.capture=s:void 0!==s&&(o=s),a.addListener(e,t,i,o)}else a.removeListener(e,t,i,s)},a.addListener=function(e,t,i,n){e.addEventListener(t,i,n)},a.removeListener=function(e,t,i,n){e.removeEventListener(t,i,n)},a.prototype.addListeners=function(){this.manageListeners(!0)},a.prototype.removeListeners=function(){this.manageListeners(!1)},a.prototype.manageListeners=function(e){var t=this.container,i=t.options;i.interactivity.detectsOn===InteractivityDetect_1.InteractivityDetect.window?t.interactivity.element=window:i.interactivity.detectsOn===InteractivityDetect_1.InteractivityDetect.parent&&t.canvas.element?t.interactivity.element=t.canvas.element.parentNode:t.interactivity.element=t.canvas.element;var n=t.interactivity.element;n&&(i.interactivity.events.onHover.enable||i.interactivity.events.onClick.enable)&&(a.manageListener(n,Constants_1.Constants.mouseMoveEvent,this.mouseMoveHandler,e),a.manageListener(n,Constants_1.Constants.touchStartEvent,this.touchStartHandler,e),a.manageListener(n,Constants_1.Constants.touchMoveEvent,this.touchMoveHandler,e),i.interactivity.events.onClick.enable||a.manageListener(n,Constants_1.Constants.touchEndEvent,this.touchEndHandler,e),a.manageListener(n,Constants_1.Constants.mouseLeaveEvent,this.mouseLeaveHandler,e),a.manageListener(n,Constants_1.Constants.touchCancelEvent,this.touchCancelHandler,e)),i.interactivity.events.onClick.enable&&n&&(a.manageListener(n,Constants_1.Constants.touchEndEvent,this.touchEndClickHandler,e),a.manageListener(n,Constants_1.Constants.mouseUpEvent,this.mouseUpHandler,e)),i.interactivity.events.resize&&a.manageListener(window,Constants_1.Constants.resizeEvent,this.resizeHandler,e),document&&a.manageListener(document,Constants_1.Constants.visibilityChangeEvent,this.visibilityChangeHandler,e,!1)},a.prototype.handleWindowResize=function(){var e=this.container,t=e.options;if(e.canvas.element){e.canvas.size.width=e.canvas.element.offsetWidth,e.canvas.size.height=e.canvas.element.offsetHeight,e.retina.isRetina&&(e.canvas.size.width*=e.retina.pixelRatio,e.canvas.size.height*=e.retina.pixelRatio),e.canvas.element.width=e.canvas.size.width,e.canvas.element.height=e.canvas.size.height,t.particles.move.enable||e.particles.redraw(),e.densityAutoParticles();for(var i=0,n=e.emitters;i<n.length;i++){n[i].resize()}for(var s=0,o=e.absorbers;s<o.length;s++){o[s].resize()}e.polygon.redraw()}},a.prototype.handleVisibilityChange=function(){var e=this.container;e.options.pauseOnBlur&&(null!==document&&void 0!==document&&document.hidden?(e.pageHidden=!0,e.pause()):(e.pageHidden=!1,e.getAnimationStatus()&&(e.lastFrameTime=performance.now(),e.play())))},a.prototype.mouseTouchMove=function(e){var t,i,n,s,o,a=this.container,r=a.options;if(e.type.startsWith("mouse")){this.canPush=!0;var c=e;if(void 0===(null===(t=a.interactivity)||void 0===t?void 0:t.element))return;if(a.interactivity.element===window){if(a.canvas.element){var l=a.canvas.element.getBoundingClientRect();o={x:c.clientX-l.left,y:c.clientY-l.top}}}else if(r.interactivity.detectsOn===InteractivityDetect_1.InteractivityDetect.parent){var u=c.target,v=c.currentTarget;if(u&&v){var h=u.getBoundingClientRect(),m=v.getBoundingClientRect();o={x:c.offsetX+h.left-m.left,y:c.offsetY+h.top-m.top}}else o={x:c.offsetX||c.clientX,y:c.offsetY||c.clientY}}else c.target===a.canvas.element&&(o={x:c.offsetX||c.clientX,y:c.offsetY||c.clientY})}else{this.canPush="touchmove"!==e.type;var d=e.touches[e.touches.length-1],y=null===(i=a.canvas.element)||void 0===i?void 0:i.getBoundingClientRect();o={x:d.clientX-(null!==(n=null==y?void 0:y.left)&&void 0!==n?n:0),y:d.clientY-(null!==(s=null==y?void 0:y.top)&&void 0!==s?s:0)}}a.interactivity.mouse.position=o,a.retina.isRetina&&a.interactivity.mouse.position&&(a.interactivity.mouse.position.x*=a.retina.pixelRatio,a.interactivity.mouse.position.y*=a.retina.pixelRatio),a.interactivity.status=Constants_1.Constants.mouseMoveEvent},a.prototype.mouseTouchFinish=function(){var e=this.container;delete e.interactivity.mouse.position,e.interactivity.status=Constants_1.Constants.mouseLeaveEvent},a.prototype.mouseTouchClick=function(e){var t=this.container,i=t.options;void 0===i.polygon||i.polygon.enable&&i.polygon.type!==PolygonMaskType_1.PolygonMaskType.none&&i.polygon.type!==PolygonMaskType_1.PolygonMaskType.inline&&!t.polygon.checkInsidePolygon(t.interactivity.mouse.position)||this.doMouseTouchClick(e)},a.prototype.doMouseTouchClick=function(e){var t=this,i=this.container,n=i.options;if(this.canPush){if(!i.interactivity.mouse.position)return;i.interactivity.mouse.clickPosition={x:i.interactivity.mouse.position.x,y:i.interactivity.mouse.position.y},i.interactivity.mouse.clickTime=(new Date).getTime();var s=n.interactivity.modes.push.quantity,o=n.interactivity.modes.remove.quantity;switch(n.interactivity.events.onClick.mode){case ClickMode_1.ClickMode.push:n.particles.move.enable||1===n.interactivity.modes.push.quantity?i.particles.push(s,i.interactivity.mouse):1<n.interactivity.modes.push.quantity&&i.particles.push(s);break;case ClickMode_1.ClickMode.remove:i.particles.removeQuantity(o);break;case ClickMode_1.ClickMode.bubble:i.bubble.clicking=!0;break;case ClickMode_1.ClickMode.repulse:i.repulse.clicking=!0;for(var a=i.repulse.count=0,r=i.repulse.particles;a<r.length;a++){var c=r[a];c.velocity.horizontal=c.initialVelocity.horizontal,c.velocity.vertical=c.initialVelocity.vertical}i.repulse.particles=[],i.repulse.finish=!1,setTimeout(function(){i.destroyed||(i.repulse.clicking=!1)},1e3*n.interactivity.modes.repulse.duration);break;case ClickMode_1.ClickMode.absorber:var l=void 0,u=n.interactivity.modes.absorbers;u instanceof Array?0<u.length&&(l=Utils_1.Utils.itemFromArray(u)):l=u;var v=null!=l?l:n.absorbers instanceof Array?Utils_1.Utils.itemFromArray(n.absorbers):n.absorbers,h=i.interactivity.mouse.clickPosition,m=new Absorber_1.Absorber(i,v,h);i.absorbers.push(m);break;case ClickMode_1.ClickMode.emitter:var d=void 0,y=n.interactivity.modes.emitters;y instanceof Array?0<y.length&&(d=Utils_1.Utils.itemFromArray(y)):d=y;var p=null!=d?d:n.emitters instanceof Array?Utils_1.Utils.itemFromArray(n.emitters):n.emitters,f=i.interactivity.mouse.clickPosition,C=new Emitter_1.Emitter(i,Utils_1.Utils.deepExtend({},p),f);i.emitters.push(C)}}"touchend"===e.type&&setTimeout(function(){return t.mouseTouchFinish()},500)},a}();exports.EventListeners=EventListeners;