"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),Canvas_1=require("./Canvas"),EventListeners_1=require("../Utils/EventListeners"),Particles_1=require("./Particles"),Retina_1=require("./Retina"),PolygonMask_1=require("../Plugins/PolygonMask"),FrameManager_1=require("./FrameManager"),Options_1=require("../Options/Classes/Options"),Presets_1=require("../Utils/Presets"),Emitter_1=require("./Emitter"),CanvasUtils_1=require("../Utils/CanvasUtils"),Utils_1=require("../Utils/Utils"),ClickMode_1=require("../Enums/Modes/ClickMode"),Absorbers_1=require("../Plugins/Absorbers"),Container=function(){function s(t,e){for(var i=[],s=2;s<arguments.length;s++)i[s-2]=arguments[s];this.started=!1,this.destroyed=!1,this.id=t,this.paused=!0,this.sourceOptions=e,this.lastFrameTime=0,this.pageHidden=!1,this.retina=new Retina_1.Retina(this),this.canvas=new Canvas_1.Canvas(this),this.particles=new Particles_1.Particles(this),this.drawer=new FrameManager_1.FrameManager(this),this.interactivity={mouse:{}},this.bubble={},this.repulse={particles:[]},this.emitters=[],this.plugins=[],this.drawers={},this.options=new Options_1.Options;for(var r=0,n=i;r<n.length;r++){var a=n[r];this.options.load(Presets_1.Presets.getPreset(a))}this.sourceOptions&&this.options.load(this.sourceOptions),this.eventListeners=new EventListeners_1.EventListeners(this)}return s.requestFrame=function(t){return window.customRequestAnimationFrame(t)},s.cancelAnimation=function(t){window.cancelAnimationFrame(t)},s.prototype.play=function(){var e=this;if(this.paused){this.lastFrameTime=performance.now(),this.paused=!1;for(var t=0,i=this.emitters;t<i.length;t++){i[t].start()}}this.drawAnimationFrame=s.requestFrame(function(t){return e.drawer.nextFrame(t)})},s.prototype.pause=function(){if(void 0!==this.drawAnimationFrame){for(var t=0,e=this.emitters;t<e.length;t++){e[t].stop()}s.cancelAnimation(this.drawAnimationFrame),delete this.drawAnimationFrame,this.paused=!0}},s.prototype.densityAutoParticles=function(){if(this.canvas.element&&this.options.particles.number.density.enable){var t=this.canvas.element.width*this.canvas.element.height/1e3;this.retina.isRetina&&(t/=2*this.retina.pixelRatio);var e=t*this.options.particles.number.value/this.options.particles.number.density.area,i=this.particles.count;i<e?this.particles.push(Math.abs(e-i)):e<i&&this.particles.removeQuantity(i-e)}},s.prototype.destroy=function(){for(var t in this.stop(),this.retina.reset(),this.canvas.destroy(),delete this.interactivity,delete this.options,delete this.retina,delete this.canvas,delete this.particles,delete this.bubble,delete this.repulse,delete this.drawer,delete this.eventListeners,this.drawers){var e=this.drawers[t];void 0!==e.destroy&&e.destroy(this)}this.drawers={},this.destroyed=!0},s.prototype.exportImg=function(t){this.exportImage(t)},s.prototype.exportImage=function(t,e,i){var s;return null===(s=this.canvas.element)||void 0===s?void 0:s.toBlob(t,null!=e?e:"image/png",i)},s.prototype.exportConfiguration=function(){return JSON.stringify(this.options,void 0,2)},s.prototype.refresh=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(t){switch(t.label){case 0:return this.stop(),[4,this.start()];case 1:return t.sent(),[2]}})})},s.prototype.stop=function(){if(this.started){this.started=!1,this.eventListeners.removeListeners(),this.pause(),this.particles.clear(),this.retina.reset(),this.canvas.clear();for(var t=0,e=this.plugins;t<e.length;t++){var i=e[t];void 0!==i.reset&&i.reset()}this.emitters=[],this.plugins=[],delete this.particles.lineLinkedColor}},s.prototype.start=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var e,i,s,r,n,a,o,h,l,p,u,c;return tslib_1.__generator(this,function(t){switch(t.label){case 0:if(this.started)return[2];this.options.polygon.enable&&this.plugins.push(new PolygonMask_1.PolygonMask(this)),e=this.options.absorbers,i=!1,e instanceof Array?e.length&&(i=!0):void 0===e&&!Utils_1.Utils.isInArray(ClickMode_1.ClickMode.absorber,this.options.interactivity.events.onClick.mode)||(i=!0),i&&this.plugins.push(new Absorbers_1.Absorbers(this)),this.started=!0,this.eventListeners.addListeners(),s=0,r=this.plugins,t.label=1;case 1:return s<r.length?void 0===(n=r[s]).initAsync?[3,3]:[4,n.initAsync()]:[3,5];case 2:return t.sent(),[3,4];case 3:void 0!==n.init&&n.init(),t.label=4;case 4:return s++,[3,1];case 5:if(this.options.particles.shape.type instanceof Array)for(a=0,o=this.options.particles.shape.type;a<o.length;a++)u=o[a],this.drawers[u]=CanvasUtils_1.CanvasUtils.getShapeDrawer(u);else u=this.options.particles.shape.type,this.drawers[u]=CanvasUtils_1.CanvasUtils.getShapeDrawer(u);for(l in h=[],this.drawers)h.push(l);p=0,t.label=6;case 6:return p<h.length?(u=h[p],void 0===(c=this.drawers[u]).init?[3,8]:[4,c.init(this)]):[3,9];case 7:t.sent(),t.label=8;case 8:return p++,[3,6];case 9:return this.init(),this.play(),[2]}})})},s.prototype.init=function(){if(this.retina.init(),this.canvas.init(),this.particles.init(),this.options.emitters instanceof Array)for(var t=0,e=this.options.emitters;t<e.length;t++){var i=e[t],s=new Emitter_1.Emitter(this,i);this.emitters.push(s)}else{i=this.options.emitters,s=new Emitter_1.Emitter(this,i);this.emitters.push(s)}this.densityAutoParticles()},s}();exports.Container=Container;