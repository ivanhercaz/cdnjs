"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ClickMode_1=require("../Enums/Modes/ClickMode"),InteractivityDetect_1=require("../Enums/InteractivityDetect"),Constants_1=require("./Constants"),Emitter_1=require("../Core/Emitter"),Utils_1=require("./Utils"),EventListeners=function(){function a(e){var t=this;this.container=e,this.canPush=!0,this.mouseMoveHandler=function(e){return t.mouseTouchMove(e)},this.touchStartHandler=function(e){return t.mouseTouchMove(e)},this.touchMoveHandler=function(e){return t.mouseTouchMove(e)},this.touchEndHandler=function(){return t.mouseTouchFinish()},this.mouseLeaveHandler=function(){return t.mouseTouchFinish()},this.touchCancelHandler=function(){return t.mouseTouchFinish()},this.touchEndClickHandler=function(e){return t.mouseTouchClick(e)},this.mouseUpHandler=function(e){return t.mouseTouchClick(e)},this.visibilityChangeHandler=function(){return t.handleVisibilityChange()},this.resizeHandler=function(){return t.handleWindowResize()}}return a.manageListener=function(e,t,i,n,s){if(n){var o={passive:!0};"boolean"==typeof s?o.capture=s:void 0!==s&&(o=s),a.addListener(e,t,i,o)}else a.removeListener(e,t,i,s)},a.addListener=function(e,t,i,n){e.addEventListener(t,i,n)},a.removeListener=function(e,t,i,n){e.removeEventListener(t,i,n)},a.prototype.addListeners=function(){this.manageListeners(!0)},a.prototype.removeListeners=function(){this.manageListeners(!1)},a.prototype.manageListeners=function(e){var t=this.container,i=t.options;i.interactivity.detectsOn===InteractivityDetect_1.InteractivityDetect.window?t.interactivity.element=window:i.interactivity.detectsOn===InteractivityDetect_1.InteractivityDetect.parent&&t.canvas.element?t.interactivity.element=t.canvas.element.parentNode:t.interactivity.element=t.canvas.element;var n=t.interactivity.element;n&&(i.interactivity.events.onHover.enable||i.interactivity.events.onClick.enable)&&(a.manageListener(n,Constants_1.Constants.mouseMoveEvent,this.mouseMoveHandler,e),a.manageListener(n,Constants_1.Constants.touchStartEvent,this.touchStartHandler,e),a.manageListener(n,Constants_1.Constants.touchMoveEvent,this.touchMoveHandler,e),i.interactivity.events.onClick.enable||a.manageListener(n,Constants_1.Constants.touchEndEvent,this.touchEndHandler,e),a.manageListener(n,Constants_1.Constants.mouseLeaveEvent,this.mouseLeaveHandler,e),a.manageListener(n,Constants_1.Constants.touchCancelEvent,this.touchCancelHandler,e)),i.interactivity.events.onClick.enable&&n&&(a.manageListener(n,Constants_1.Constants.touchEndEvent,this.touchEndClickHandler,e),a.manageListener(n,Constants_1.Constants.mouseUpEvent,this.mouseUpHandler,e)),i.interactivity.events.resize&&a.manageListener(window,Constants_1.Constants.resizeEvent,this.resizeHandler,e),document&&a.manageListener(document,Constants_1.Constants.visibilityChangeEvent,this.visibilityChangeHandler,e,!1)},a.prototype.handleWindowResize=function(){var e=this.container,t=e.options;if(e.canvas.element){e.canvas.size.width=e.canvas.element.offsetWidth,e.canvas.size.height=e.canvas.element.offsetHeight,e.retina.isRetina&&(e.canvas.size.width*=e.retina.pixelRatio,e.canvas.size.height*=e.retina.pixelRatio),e.canvas.element.width=e.canvas.size.width,e.canvas.element.height=e.canvas.size.height,t.particles.move.enable||e.particles.redraw(),e.densityAutoParticles();for(var i=0,n=e.emitters;i<n.length;i++){n[i].resize()}for(var s=0,o=e.plugins;s<o.length;s++){var a=o[s];void 0!==a.resize&&a.resize()}}},a.prototype.handleVisibilityChange=function(){var e=this.container;e.options.pauseOnBlur&&(null!==document&&void 0!==document&&document.hidden?(e.pageHidden=!0,e.pause()):(e.pageHidden=!1,e.play()))},a.prototype.mouseTouchMove=function(e){var t,i,n,s,o,a=this.container,r=a.options;if(e.type.startsWith("mouse")){this.canPush=!0;var c=e;if(void 0===(null===(t=a.interactivity)||void 0===t?void 0:t.element))return;if(a.interactivity.element===window){if(a.canvas.element){var l=a.canvas.element.getBoundingClientRect();o={x:c.clientX-l.left,y:c.clientY-l.top}}}else if(r.interactivity.detectsOn===InteractivityDetect_1.InteractivityDetect.parent){var u=c.target,v=c.currentTarget;if(u&&v){var h=u.getBoundingClientRect(),d=v.getBoundingClientRect();o={x:c.offsetX+h.left-d.left,y:c.offsetY+h.top-d.top}}else o={x:c.offsetX||c.clientX,y:c.offsetY||c.clientY}}else c.target===a.canvas.element&&(o={x:c.offsetX||c.clientX,y:c.offsetY||c.clientY})}else{this.canPush="touchmove"!==e.type;var m=e.touches[e.touches.length-1],y=null===(i=a.canvas.element)||void 0===i?void 0:i.getBoundingClientRect();o={x:m.clientX-(null!==(n=null==y?void 0:y.left)&&void 0!==n?n:0),y:m.clientY-(null!==(s=null==y?void 0:y.top)&&void 0!==s?s:0)}}a.interactivity.mouse.position=o,a.retina.isRetina&&a.interactivity.mouse.position&&(a.interactivity.mouse.position.x*=a.retina.pixelRatio,a.interactivity.mouse.position.y*=a.retina.pixelRatio),a.interactivity.status=Constants_1.Constants.mouseMoveEvent},a.prototype.mouseTouchFinish=function(){var e=this.container;delete e.interactivity.mouse.position,e.interactivity.status=Constants_1.Constants.mouseLeaveEvent},a.prototype.mouseTouchClick=function(e){var t=this.container,i=t.options,n=!1,s=t.interactivity.mouse.position;if(void 0!==s&&i.interactivity.events.onClick.enable){for(var o=0,a=t.plugins;o<a.length;o++){var r=a[o];if(void 0!==r.clickPositionValid&&(n=r.clickPositionValid(s)))break}n||this.doMouseTouchClick(e)}},a.prototype.doMouseTouchClick=function(e){var t=this,i=this.container,n=i.options;if(this.canPush){if(!i.interactivity.mouse.position)return;if(i.interactivity.mouse.clickPosition={x:i.interactivity.mouse.position.x,y:i.interactivity.mouse.position.y},i.interactivity.mouse.clickTime=(new Date).getTime(),n.interactivity.events.onClick.mode instanceof Array)for(var s=0,o=n.interactivity.events.onClick.mode;s<o.length;s++){var a=o[s];this.handleClickMode(a)}else{a=n.interactivity.events.onClick.mode;this.handleClickMode(a)}}"touchend"===e.type&&setTimeout(function(){return t.mouseTouchFinish()},500)},a.prototype.handleClickMode=function(e){var t=this.container,i=t.options,n=i.interactivity.modes.push.quantity,s=i.interactivity.modes.remove.quantity;switch(e){case ClickMode_1.ClickMode.push:i.particles.move.enable||1===i.interactivity.modes.push.quantity?t.particles.push(n,t.interactivity.mouse):1<i.interactivity.modes.push.quantity&&t.particles.push(n);break;case ClickMode_1.ClickMode.remove:t.particles.removeQuantity(s);break;case ClickMode_1.ClickMode.bubble:t.bubble.clicking=!0;break;case ClickMode_1.ClickMode.repulse:t.repulse.clicking=!0;for(var o=t.repulse.count=0,a=t.repulse.particles;o<a.length;o++){var r=a[o];r.velocity.horizontal=r.initialVelocity.horizontal,r.velocity.vertical=r.initialVelocity.vertical}t.repulse.particles=[],t.repulse.finish=!1,setTimeout(function(){t.destroyed||(t.repulse.clicking=!1)},1e3*i.interactivity.modes.repulse.duration);break;case ClickMode_1.ClickMode.emitter:var c=void 0,l=i.interactivity.modes.emitters;l instanceof Array?0<l.length&&(c=Utils_1.Utils.itemFromArray(l)):c=l;var u=null!=c?c:i.emitters instanceof Array?Utils_1.Utils.itemFromArray(i.emitters):i.emitters,v=t.interactivity.mouse.clickPosition,h=new Emitter_1.Emitter(t,Utils_1.Utils.deepExtend({},u),v);t.emitters.push(h)}for(var d=0,m=t.plugins;d<m.length;d++){var y=m[d];y.handleClickMode&&y.handleClickMode(e)}},a}();exports.EventListeners=EventListeners;