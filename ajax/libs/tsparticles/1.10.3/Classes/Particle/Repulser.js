"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Repulser = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _ClickMode = require("../../Enums/Modes/ClickMode");

var _HoverMode = require("../../Enums/Modes/HoverMode");

var _OutMode = require("../../Enums/OutMode");

var _Utils = require("../Utils/Utils");

var _DivMode = require("../../Enums/Modes/DivMode");

/**
 * Particle repulse manager
 */
var Repulser = /*#__PURE__*/function () {
  function Repulser(container, particle) {
    (0, _classCallCheck2["default"])(this, Repulser);
    this.particle = void 0;
    this.container = void 0;
    this.container = container;
    this.particle = particle;
  }

  (0, _createClass2["default"])(Repulser, [{
    key: "repulse",
    value: function repulse() {
      var container = this.container;
      var options = container.options;
      var hoverEnabled = options.interactivity.events.onHover.enable;
      var clickEnabled = options.interactivity.events.onClick.enable;
      var mouseMoveStatus = container.interactivity.status === "mousemove";
      var hoverMode = options.interactivity.events.onHover.mode;
      var clickMode = options.interactivity.events.onClick.mode;
      var divMode = options.interactivity.events.onDiv.mode;

      if (mouseMoveStatus && hoverEnabled && _Utils.Utils.isInArray(_HoverMode.HoverMode.repulse, hoverMode)) {
        this.hoverRepulse();
      } else if (clickEnabled && _Utils.Utils.isInArray(_ClickMode.ClickMode.repulse, clickMode)) {
        this.clickRepulse();
      } else if (options.interactivity.events.onDiv.enable && _Utils.Utils.isInArray(_DivMode.DivMode.repulse, divMode)) {
        this.divRepulse();
      }
    }
  }, {
    key: "divRepulse",
    value: function divRepulse() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;
      var elem = document.getElementById(options.interactivity.events.onDiv.elementId);
      var pos = {
        x: elem.offsetLeft + elem.offsetWidth / 2,
        y: elem.offsetTop + elem.offsetHeight / 2
      };
      var divWidth = elem.offsetWidth / 2;

      if (container.retina.isRetina) {
        pos.x *= container.retina.pxRatio;
        pos.y *= container.retina.pxRatio;
        divWidth *= container.retina.pxRatio;
      }

      var dxDiv = particle.position.x - pos.x;
      var dyDiv = particle.position.y - pos.y;
      var distDiv = Math.sqrt(dxDiv * dxDiv + dyDiv * dyDiv);
      var normVec = {
        x: dxDiv / distDiv,
        y: dyDiv / distDiv
      };
      var repulseRadius = divWidth;
      var velocity = 100;

      var repulseFactor = _Utils.Utils.clamp((-Math.pow(distDiv / repulseRadius, 4) + 1) * velocity, 0, 50);

      this.particle.position.x += normVec.x * repulseFactor;
      this.particle.position.y += normVec.y * repulseFactor;
    }
  }, {
    key: "clickRepulse",
    value: function clickRepulse() {
      var container = this.container;
      var particle = this.particle;

      if (!container.repulse.finish) {
        if (!container.repulse.count) {
          container.repulse.count = 0;
        }

        container.repulse.count++;

        if (container.repulse.count === container.particles.array.length) {
          container.repulse.finish = true;
        }
      }

      if (container.repulse.clicking) {
        var repulseDistance = container.retina.repulseModeDistance;
        var repulseRadius = Math.pow(repulseDistance / 6, 3);
        var mouseClickPos = container.interactivity.mouse.clickPosition || {
          x: 0,
          y: 0
        };
        var dx = mouseClickPos.x - particle.position.x;
        var dy = mouseClickPos.y - particle.position.y;
        var d = dx * dx + dy * dy;
        var force = -repulseRadius / d; // default

        if (d <= repulseRadius) {
          this.processRepulse(dx, dy, force);
        } // bang - slow motion mode
        // if(!container.repulse_finish){
        //   if(d <= repulseRadius){
        //     process();
        //   }
        // }else{
        //   process();
        // }

      } else if (container.repulse.clicking === false) {
        particle.velocity.horizontal = particle.initialVelocity.horizontal;
        particle.velocity.vertical = particle.initialVelocity.vertical;
      }
    }
  }, {
    key: "hoverRepulse",
    value: function hoverRepulse() {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;
      var mousePos = container.interactivity.mouse.position || {
        x: 0,
        y: 0
      };
      var dxMouse = particle.position.x - mousePos.x;
      var dyMouse = particle.position.y - mousePos.y;
      var distMouse = Math.sqrt(dxMouse * dxMouse + dyMouse * dyMouse);
      var normVec = {
        x: dxMouse / distMouse,
        y: dyMouse / distMouse
      };
      var repulseRadius = container.retina.repulseModeDistance;
      var velocity = 100;

      var repulseFactor = _Utils.Utils.clamp((1 - Math.pow(distMouse / repulseRadius, 2)) * velocity, 0, 50);

      var pos = {
        x: particle.position.x + normVec.x * repulseFactor,
        y: particle.position.y + normVec.y * repulseFactor
      };
      var outMode = options.particles.move.outMode;

      if (outMode === _OutMode.OutMode.bounce || outMode === _OutMode.OutMode.bounceVertical || outMode === _OutMode.OutMode.bounceHorizontal) {
        var isInside = {
          horizontal: pos.x - particle.radius > 0 && pos.x + particle.radius < container.canvas.dimension.width,
          vertical: pos.y - particle.radius > 0 && pos.y + particle.radius < container.canvas.dimension.height
        };

        if (outMode === _OutMode.OutMode.bounceVertical || isInside.horizontal) {
          particle.position.x = pos.x;
        }

        if (outMode === _OutMode.OutMode.bounceHorizontal || isInside.vertical) {
          particle.position.y = pos.y;
        }
      } else {
        particle.position.x = pos.x;
        particle.position.y = pos.y;
      }
    }
  }, {
    key: "processRepulse",
    value: function processRepulse(dx, dy, force) {
      var container = this.container;
      var options = container.options;
      var particle = this.particle;
      var f = Math.atan2(dy, dx);
      particle.velocity.horizontal = force * Math.cos(f);
      particle.velocity.vertical = force * Math.sin(f);
      var outMode = options.particles.move.outMode;

      if (outMode === _OutMode.OutMode.bounce || outMode === _OutMode.OutMode.bounceHorizontal || outMode === _OutMode.OutMode.bounceVertical) {
        var pos = {
          x: particle.position.x + particle.velocity.horizontal,
          y: particle.position.y + particle.velocity.vertical
        };

        if (outMode !== _OutMode.OutMode.bounceVertical) {
          if (pos.x + particle.radius > container.canvas.dimension.width || pos.x - particle.radius < 0) {
            particle.velocity.horizontal = -particle.velocity.horizontal;
          }
        }

        if (outMode !== _OutMode.OutMode.bounceHorizontal) {
          if (pos.y + particle.radius > container.canvas.dimension.height || pos.y - particle.radius < 0) {
            particle.velocity.vertical = -particle.velocity.vertical;
          }
        }
      }
    }
  }]);
  return Repulser;
}();

exports.Repulser = Repulser;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9DbGFzc2VzL1BhcnRpY2xlL1JlcHVsc2VyLnRzIl0sIm5hbWVzIjpbIlJlcHVsc2VyIiwiY29udGFpbmVyIiwicGFydGljbGUiLCJvcHRpb25zIiwiaG92ZXJFbmFibGVkIiwiaW50ZXJhY3Rpdml0eSIsImV2ZW50cyIsIm9uSG92ZXIiLCJlbmFibGUiLCJjbGlja0VuYWJsZWQiLCJvbkNsaWNrIiwibW91c2VNb3ZlU3RhdHVzIiwic3RhdHVzIiwiaG92ZXJNb2RlIiwibW9kZSIsImNsaWNrTW9kZSIsImRpdk1vZGUiLCJvbkRpdiIsIlV0aWxzIiwiaXNJbkFycmF5IiwiSG92ZXJNb2RlIiwicmVwdWxzZSIsImhvdmVyUmVwdWxzZSIsIkNsaWNrTW9kZSIsImNsaWNrUmVwdWxzZSIsIkRpdk1vZGUiLCJkaXZSZXB1bHNlIiwiZWxlbSIsImRvY3VtZW50IiwiZ2V0RWxlbWVudEJ5SWQiLCJlbGVtZW50SWQiLCJwb3MiLCJ4Iiwib2Zmc2V0TGVmdCIsIm9mZnNldFdpZHRoIiwieSIsIm9mZnNldFRvcCIsIm9mZnNldEhlaWdodCIsImRpdldpZHRoIiwicmV0aW5hIiwiaXNSZXRpbmEiLCJweFJhdGlvIiwiZHhEaXYiLCJwb3NpdGlvbiIsImR5RGl2IiwiZGlzdERpdiIsIk1hdGgiLCJzcXJ0Iiwibm9ybVZlYyIsInJlcHVsc2VSYWRpdXMiLCJ2ZWxvY2l0eSIsInJlcHVsc2VGYWN0b3IiLCJjbGFtcCIsInBvdyIsImZpbmlzaCIsImNvdW50IiwicGFydGljbGVzIiwiYXJyYXkiLCJsZW5ndGgiLCJjbGlja2luZyIsInJlcHVsc2VEaXN0YW5jZSIsInJlcHVsc2VNb2RlRGlzdGFuY2UiLCJtb3VzZUNsaWNrUG9zIiwibW91c2UiLCJjbGlja1Bvc2l0aW9uIiwiZHgiLCJkeSIsImQiLCJmb3JjZSIsInByb2Nlc3NSZXB1bHNlIiwiaG9yaXpvbnRhbCIsImluaXRpYWxWZWxvY2l0eSIsInZlcnRpY2FsIiwibW91c2VQb3MiLCJkeE1vdXNlIiwiZHlNb3VzZSIsImRpc3RNb3VzZSIsIm91dE1vZGUiLCJtb3ZlIiwiT3V0TW9kZSIsImJvdW5jZSIsImJvdW5jZVZlcnRpY2FsIiwiYm91bmNlSG9yaXpvbnRhbCIsImlzSW5zaWRlIiwicmFkaXVzIiwiY2FudmFzIiwiZGltZW5zaW9uIiwid2lkdGgiLCJoZWlnaHQiLCJmIiwiYXRhbjIiLCJjb3MiLCJzaW4iXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBRUE7OztJQUdhQSxRO0FBSVQsb0JBQVlDLFNBQVosRUFBa0NDLFFBQWxDLEVBQXNEO0FBQUE7QUFBQSxTQUhyQ0EsUUFHcUM7QUFBQSxTQUZyQ0QsU0FFcUM7QUFDbEQsU0FBS0EsU0FBTCxHQUFpQkEsU0FBakI7QUFDQSxTQUFLQyxRQUFMLEdBQWdCQSxRQUFoQjtBQUNIOzs7OzhCQUVzQjtBQUNuQixVQUFNRCxTQUFTLEdBQUcsS0FBS0EsU0FBdkI7QUFDQSxVQUFNRSxPQUFPLEdBQUdGLFNBQVMsQ0FBQ0UsT0FBMUI7QUFDQSxVQUFNQyxZQUFZLEdBQUdELE9BQU8sQ0FBQ0UsYUFBUixDQUFzQkMsTUFBdEIsQ0FBNkJDLE9BQTdCLENBQXFDQyxNQUExRDtBQUNBLFVBQU1DLFlBQVksR0FBR04sT0FBTyxDQUFDRSxhQUFSLENBQXNCQyxNQUF0QixDQUE2QkksT0FBN0IsQ0FBcUNGLE1BQTFEO0FBQ0EsVUFBTUcsZUFBZSxHQUFHVixTQUFTLENBQUNJLGFBQVYsQ0FBd0JPLE1BQXhCLEtBQW1DLFdBQTNEO0FBQ0EsVUFBTUMsU0FBUyxHQUFHVixPQUFPLENBQUNFLGFBQVIsQ0FBc0JDLE1BQXRCLENBQTZCQyxPQUE3QixDQUFxQ08sSUFBdkQ7QUFDQSxVQUFNQyxTQUFTLEdBQUdaLE9BQU8sQ0FBQ0UsYUFBUixDQUFzQkMsTUFBdEIsQ0FBNkJJLE9BQTdCLENBQXFDSSxJQUF2RDtBQUNBLFVBQU1FLE9BQU8sR0FBR2IsT0FBTyxDQUFDRSxhQUFSLENBQXNCQyxNQUF0QixD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QUFRLENBQUNrRixNQUFqQixHQUEwQixDQUE1RixFQUErRjtBQUMzRmxGLFlBQUFBLFFBQVEsQ0FBQ2dELFFBQVQsQ0FBa0JvQixVQUFsQixHQUErQixDQUFDcEUsUUFBUSxDQUFDZ0QsUUFBVCxDQUFrQm9CLFVBQWxEO0FBQ0g7QUFDSjs7QUFFRCxZQUFJTyxPQUFPLEtBQUtFLGlCQUFRRyxnQkFBeEIsRUFBMEM7QUFDdEMsY0FBSW5ELEdBQUcsQ0FBQ0ksQ0FBSixHQUFRakMsUUFBUSxDQUFDa0YsTUFBakIsR0FBMEJuRixTQUFTLENBQUNvRixNQUFWLENBQWlCQyxTQUFqQixDQUEyQkUsTUFBckQsSUFBK0R6RCxHQUFHLENBQUNJLENBQUosR0FBUWpDLFFBQVEsQ0FBQ2tGLE1BQWpCLEdBQTBCLENBQTdGLEVBQWdHO0FBQzVGbEYsWUFBQUEsUUFBUSxDQUFDZ0QsUUFBVCxDQUFrQnNCLFFBQWxCLEdBQTZCLENBQUN0RSxRQUFRLENBQUNnRCxRQUFULENBQWtCc0IsUUFBaEQ7QUFDSDtBQUNKO0FBQ0o7QUFDSiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQge0NsaWNrTW9kZX0gZnJvbSBcIi4uLy4uL0VudW1zL01vZGVzL0NsaWNrTW9kZVwiO1xuaW1wb3J0IHtDb250YWluZXJ9IGZyb20gXCIuLi9Db250YWluZXJcIjtcbmltcG9ydCB7SG92ZXJNb2RlfSBmcm9tIFwiLi4vLi4vRW51bXMvTW9kZXMvSG92ZXJNb2RlXCI7XG5pbXBvcnQge091dE1vZGV9IGZyb20gXCIuLi8uLi9FbnVtcy9PdXRNb2RlXCI7XG5pbXBvcnQge1BhcnRpY2xlfSBmcm9tIFwiLi4vUGFydGljbGVcIjtcbmltcG9ydCB7VXRpbHN9IGZyb20gXCIuLi9VdGlscy9VdGlsc1wiO1xuaW1wb3J0IHtEaXZNb2RlfSBmcm9tIFwiLi4vLi4vRW51bXMvTW9kZXMvRGl2TW9kZVwiO1xuXG4vKipcbiAqIFBhcnRpY2xlIHJlcHVsc2UgbWFuYWdlclxuICovXG5leHBvcnQgY2xhc3MgUmVwdWxzZXIge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgcGFydGljbGU6IFBhcnRpY2xlO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgY29udGFpbmVyOiBDb250YWluZXI7XG5cbiAgICBjb25zdHJ1Y3Rvcihjb250YWluZXI6IENvbnRhaW5lciwgcGFydGljbGU6IFBhcnRpY2xlKSB7XG4gICAgICAgIHRoaXMuY29udGFpbmVyID0gY29udGFpbmVyO1xuICAgICAgICB0aGlzLnBhcnRpY2xlID0gcGFydGljbGU7XG4gICAgfVxuXG4gICAgcHVibGljIHJlcHVsc2UoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyO1xuICAgICAgICBjb25zdCBvcHRpb25zID0gY29udGFpbmVyLm9wdGlvbnM7XG4gICAgICAgIGNvbnN0IGhvdmVyRW5hYmxlZCA9IG9wdGlvbnMuaW50ZXJhY3Rpdml0eS5ldmVudHMub25Ib3Zlci5lbmFibGU7XG4gICAgICAgIGNvbnN0IGNsaWNrRW5hYmxlZCA9IG9wdGlvbnMuaW50ZXJhY3Rpdml0eS5ldmVudHMub25DbGljay5lbmFibGU7XG4gICAgICAgIGNvbnN0IG1vdXNlTW92ZVN0YXR1cyA9IGNvbnRhaW5lci5pbnRlcmFjdGl2aXR5LnN0YXR1cyA9PT0gXCJtb3VzZW1vdmVcIjtcbiAgICAgICAgY29uc3QgaG92ZXJNb2RlID0gb3B0aW9ucy5pbnRlcmFjdGl2aXR5LmV2ZW50cy5vbkhvdmVyLm1vZGU7XG4gICAgICAgIGNvbnN0IGNsaWNrTW9kZSA9IG9wdGlvbnMuaW50ZXJhY3Rpdml0eS5ldmVudHMub25DbGljay5tb2RlO1xuICAgICAgICBjb25zdCBkaXZNb2RlID0gb3B0aW9ucy5pbnRlcmFjdGl2aXR5LmV2ZW50cy5vbkRpdi5tb2RlO1xuXG4gICAgICAgIGlmIChtb3VzZU1vdmVTdGF0dXMgJiYgaG92ZXJFbmFibGVkICYmIFV0aWxzLmlzSW5BcnJheShIb3Zlck1vZGUucmVwdWxzZSwgaG92ZXJNb2RlKSkge1xuICAgICAgICAgICAgdGhpcy5ob3ZlclJlcHVsc2UoKTtcbiAgICAgICAgfSBlbHNlIGlmIChjbGlja0VuYWJsZWQgJiYgVXRpbHMuaXNJbkFycmF5KENsaWNrTW9kZS5yZXB1bHNlLCBjbGlja01vZGUpKSB7XG4gICAgICAgICAgICB0aGlzLmNsaWNrUmVwdWxzZSgpO1xuICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMuaW50ZXJhY3Rpdml0eS5ldmVudHMub25EaXYuZW5hYmxlICYmIFV0aWxzLmlzSW5BcnJheShEaXZNb2RlLnJlcHVsc2UsIGRpdk1vZGUpKSB7XG4gICAgICAgICAgICB0aGlzLmRpdlJlcHVsc2UoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZGl2UmVwdWxzZSgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jb250YWluZXI7XG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSBjb250YWluZXIub3B0aW9ucztcbiAgICAgICAgY29uc3QgcGFydGljbGUgPSB0aGlzLnBhcnRpY2xlO1xuXG4gICAgICAgIGNvbnN0IGVsZW0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChvcHRpb25zLmludGVyYWN0aXZpdHkuZXZlbnRzLm9uRGl2LmVsZW1lbnRJZCkgYXMgSFRNTEVsZW1lbnQ7XG4gICAgICAgIGNvbnN0IHBvcyA9IHtcbiAgICAgICAgICAgIHg6IChlbGVtLm9mZnNldExlZnQgKyBlbGVtLm9mZnNldFdpZHRoIC8gMiksXG4gICAgICAgICAgICB5OiAoZWxlbS5vZmZzZXRUb3AgKyBlbGVtLm9mZnNldEhlaWdodCAvIDIpLFxuICAgICAgICB9O1xuICAgICAgICBsZXQgZGl2V2lkdGggPSBlbGVtLm9mZnNldFdpZHRoIC8gMjtcblxuICAgICAgICBpZiAoY29udGFpbmVyLnJldGluYS5pc1JldGluYSkge1xuICAgICAgICAgICAgcG9zLnggKj0gY29udGFpbmVyLnJldGluYS5weFJhdGlvO1xuICAgICAgICAgICAgcG9zLnkgKj0gY29udGFpbmVyLnJldGluYS5weFJhdGlvO1xuICAgICAgICAgICAgZGl2V2lkdGggKj0gY29udGFpbmVyLnJldGluYS5weFJhdGlvXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkeERpdiA9IHBhcnRpY2xlLnBvc2l0aW9uLnggLSBwb3MueDtcbiAgICAgICAgY29uc3QgZHlEaXYgPSBwYXJ0aWNsZS5wb3NpdGlvbi55IC0gcG9zLnk7XG4gICAgICAgIGNvbnN0IGRpc3REaXYgPSBNYXRoLnNxcnQoZHhEaXYgKiBkeERpdiArIGR5RGl2ICogZHlEaXYpO1xuICAgICAgICBjb25zdCBub3JtVmVjID0ge1xuICAgICAgICAgICAgeDogZHhEaXYgLyBkaXN0RGl2LFxuICAgICAgICAgICAgeTogZHlEaXYgLyBkaXN0RGl2LFxuICAgICAgICB9O1xuICAgICAgICBjb25zdCByZXB1bHNlUmFkaXVzID0gZGl2V2lkdGg7XG4gICAgICAgIGNvbnN0IHZlbG9jaXR5ID0gMTAwO1xuICAgICAgICBjb25zdCByZXB1bHNlRmFjdG9yID0gVXRpbHMuY2xhbXAoKC1NYXRoLnBvdyhkaXN0RGl2IC8gcmVwdWxzZVJhZGl1cywgNCkgKyAxKSAqIHZlbG9jaXR5LCAwLCA1MCk7XG5cbiAgICAgICAgdGhpcy5wYXJ0aWNsZS5wb3NpdGlvbi54ICs9IG5vcm1WZWMueCAqIHJlcHVsc2VGYWN0b3I7XG4gICAgICAgIHRoaXMucGFydGljbGUucG9zaXRpb24ueSArPSBub3JtVmVjLnkgKiByZXB1bHNlRmFjdG9yO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2xpY2tSZXB1bHNlKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcjtcbiAgICAgICAgY29uc3QgcGFydGljbGUgPSB0aGlzLnBhcnRpY2xlO1xuXG4gICAgICAgIGlmICghY29udGFpbmVyLnJlcHVsc2UuZmluaXNoKSB7XG4gICAgICAgICAgICBpZiAoIWNvbnRhaW5lci5yZXB1bHNlLmNvdW50KSB7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyLnJlcHVsc2UuY291bnQgPSAwO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb250YWluZXIucmVwdWxzZS5jb3VudCsrO1xuXG4gICAgICAgICAgICBpZiAoY29udGFpbmVyLnJlcHVsc2UuY291bnQgPT09IGNvbnRhaW5lci5wYXJ0aWNsZXMuYXJyYXkubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyLnJlcHVsc2UuZmluaXNoID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb250YWluZXIucmVwdWxzZS5jbGlja2luZykge1xuICAgICAgICAgICAgY29uc3QgcmVwdWxzZURpc3RhbmNlID0gY29udGFpbmVyLnJldGluYS5yZXB1bHNlTW9kZURpc3RhbmNlO1xuICAgICAgICAgICAgY29uc3QgcmVwdWxzZVJhZGl1cyA9IE1hdGgucG93KHJlcHVsc2VEaXN0YW5jZSAvIDYsIDMpO1xuICAgICAgICAgICAgY29uc3QgbW91c2VDbGlja1BvcyA9IGNvbnRhaW5lci5pbnRlcmFjdGl2aXR5Lm1vdXNlLmNsaWNrUG9zaXRpb24gfHwge3g6IDAsIHk6IDB9O1xuICAgICAgICAgICAgY29uc3QgZHggPSBtb3VzZUNsaWNrUG9zLnggLSBwYXJ0aWNsZS5wb3NpdGlvbi54O1xuICAgICAgICAgICAgY29uc3QgZHkgPSBtb3VzZUNsaWNrUG9zLnkgLSBwYXJ0aWNsZS5wb3NpdGlvbi55O1xuICAgICAgICAgICAgY29uc3QgZCA9IGR4ICogZHggKyBkeSAqIGR5O1xuICAgICAgICAgICAgY29uc3QgZm9yY2UgPSAtcmVwdWxzZVJhZGl1cyAvIGQ7XG5cbiAgICAgICAgICAgIC8vIGRlZmF1bHRcbiAgICAgICAgICAgIGlmIChkIDw9IHJlcHVsc2VSYWRpdXMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NSZXB1bHNlKGR4LCBkeSwgZm9yY2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gYmFuZyAtIHNsb3cgbW90aW9uIG1vZGVcbiAgICAgICAgICAgIC8vIGlmKCFjb250YWluZXIucmVwdWxzZV9maW5pc2gpe1xuICAgICAgICAgICAgLy8gICBpZihkIDw9IHJlcHVsc2VSYWRpdXMpe1xuICAgICAgICAgICAgLy8gICAgIHByb2Nlc3MoKTtcbiAgICAgICAgICAgIC8vICAgfVxuICAgICAgICAgICAgLy8gfWVsc2V7XG4gICAgICAgICAgICAvLyAgIHByb2Nlc3MoKTtcbiAgICAgICAgICAgIC8vIH1cbiAgICAgICAgfSBlbHNlIGlmIChjb250YWluZXIucmVwdWxzZS5jbGlja2luZyA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHBhcnRpY2xlLnZlbG9jaXR5Lmhvcml6b250YWwgPSBwYXJ0aWNsZS5pbml0aWFsVmVsb2NpdHkuaG9yaXpvbnRhbDtcbiAgICAgICAgICAgIHBhcnRpY2xlLnZlbG9jaXR5LnZlcnRpY2FsID0gcGFydGljbGUuaW5pdGlhbFZlbG9jaXR5LnZlcnRpY2FsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBob3ZlclJlcHVsc2UoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyO1xuICAgICAgICBjb25zdCBvcHRpb25zID0gY29udGFpbmVyLm9wdGlvbnM7XG4gICAgICAgIGNvbnN0IHBhcnRpY2xlID0gdGhpcy5wYXJ0aWNsZTtcbiAgICAgICAgY29uc3QgbW91c2VQb3MgPSBjb250YWluZXIuaW50ZXJhY3Rpdml0eS5tb3VzZS5wb3NpdGlvbiB8fCB7eDogMCwgeTogMH07XG4gICAgICAgIGNvbnN0IGR4TW91c2UgPSBwYXJ0aWNsZS5wb3NpdGlvbi54IC0gbW91c2VQb3MueDtcbiAgICAgICAgY29uc3QgZHlNb3VzZSA9IHBhcnRpY2xlLnBvc2l0aW9uLnkgLSBtb3VzZVBvcy55O1xuICAgICAgICBjb25zdCBkaXN0TW91c2UgPSBNYXRoLnNxcnQoZHhNb3VzZSAqIGR4TW91c2UgKyBkeU1vdXNlICogZHlNb3VzZSk7XG4gICAgICAgIGNvbnN0IG5vcm1WZWMgPSB7eDogZHhNb3VzZSAvIGRpc3RNb3VzZSwgeTogZHlNb3VzZSAvIGRpc3RNb3VzZX07XG4gICAgICAgIGNvbnN0IHJlcHVsc2VSYWRpdXMgPSBjb250YWluZXIucmV0aW5hLnJlcHVsc2VNb2RlRGlzdGFuY2U7XG4gICAgICAgIGNvbnN0IHZlbG9jaXR5ID0gMTAwO1xuICAgICAgICBjb25zdCByZXB1bHNlRmFjdG9yID0gVXRpbHMuY2xhbXAoKDEgLSBNYXRoLnBvdyhkaXN0TW91c2UgLyByZXB1bHNlUmFkaXVzLCAyKSkgKiB2ZWxvY2l0eSwgMCwgNTApO1xuICAgICAgICBjb25zdCBwb3MgPSB7XG4gICAgICAgICAgICB4OiBwYXJ0aWNsZS5wb3NpdGlvbi54ICsgbm9ybVZlYy54ICogcmVwdWxzZUZhY3RvcixcbiAgICAgICAgICAgIHk6IHBhcnRpY2xlLnBvc2l0aW9uLnkgKyBub3JtVmVjLnkgKiByZXB1bHNlRmFjdG9yLFxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBvdXRNb2RlID0gb3B0aW9ucy5wYXJ0aWNsZXMubW92ZS5vdXRNb2RlO1xuXG4gICAgICAgIGlmIChvdXRNb2RlID09PSBPdXRNb2RlLmJvdW5jZSB8fCBvdXRNb2RlID09PSBPdXRNb2RlLmJvdW5jZVZlcnRpY2FsIHx8IG91dE1vZGUgPT09IE91dE1vZGUuYm91bmNlSG9yaXpvbnRhbCkge1xuICAgICAgICAgICAgY29uc3QgaXNJbnNpZGUgPSB7XG4gICAgICAgICAgICAgICAgaG9yaXpvbnRhbDogcG9zLnggLSBwYXJ0aWNsZS5yYWRpdXMgPiAwICYmIHBvcy54ICsgcGFydGljbGUucmFkaXVzIDwgY29udGFpbmVyLmNhbnZhcy5kaW1lbnNpb24ud2lkdGgsXG4gICAgICAgICAgICAgICAgdmVydGljYWw6IHBvcy55IC0gcGFydGljbGUucmFkaXVzID4gMCAmJiBwb3MueSArIHBhcnRpY2xlLnJhZGl1cyA8IGNvbnRhaW5lci5jYW52YXMuZGltZW5zaW9uLmhlaWdodCxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBpZiAob3V0TW9kZSA9PT0gT3V0TW9kZS5ib3VuY2VWZXJ0aWNhbCB8fCBpc0luc2lkZS5ob3Jpem9udGFsKSB7XG4gICAgICAgICAgICAgICAgcGFydGljbGUucG9zaXRpb24ueCA9IHBvcy54O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAob3V0TW9kZSA9PT0gT3V0TW9kZS5ib3VuY2VIb3Jpem9udGFsIHx8IGlzSW5zaWRlLnZlcnRpY2FsKSB7XG4gICAgICAgICAgICAgICAgcGFydGljbGUucG9zaXRpb24ueSA9IHBvcy55O1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcGFydGljbGUucG9zaXRpb24ueCA9IHBvcy54O1xuICAgICAgICAgICAgcGFydGljbGUucG9zaXRpb24ueSA9IHBvcy55O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwcm9jZXNzUmVwdWxzZShkeDogbnVtYmVyLCBkeTogbnVtYmVyLCBmb3JjZTogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyO1xuICAgICAgICBjb25zdCBvcHRpb25zID0gY29udGFpbmVyLm9wdGlvbnM7XG4gICAgICAgIGNvbnN0IHBhcnRpY2xlID0gdGhpcy5wYXJ0aWNsZTtcbiAgICAgICAgY29uc3QgZiA9IE1hdGguYXRhbjIoZHksIGR4KTtcblxuICAgICAgICBwYXJ0aWNsZS52ZWxvY2l0eS5ob3Jpem9udGFsID0gZm9yY2UgKiBNYXRoLmNvcyhmKTtcbiAgICAgICAgcGFydGljbGUudmVsb2NpdHkudmVydGljYWwgPSBmb3JjZSAqIE1hdGguc2luKGYpO1xuXG4gICAgICAgIGNvbnN0IG91dE1vZGUgPSBvcHRpb25zLnBhcnRpY2xlcy5tb3ZlLm91dE1vZGU7XG5cbiAgICAgICAgaWYgKG91dE1vZGUgPT09IE91dE1vZGUuYm91bmNlIHx8IG91dE1vZGUgPT09IE91dE1vZGUuYm91bmNlSG9yaXpvbnRhbCB8fCBvdXRNb2RlID09PSBPdXRNb2RlLmJvdW5jZVZlcnRpY2FsKSB7XG4gICAgICAgICAgICBjb25zdCBwb3MgPSB7XG4gICAgICAgICAgICAgICAgeDogcGFydGljbGUucG9zaXRpb24ueCArIHBhcnRpY2xlLnZlbG9jaXR5Lmhvcml6b250YWwsXG4gICAgICAgICAgICAgICAgeTogcGFydGljbGUucG9zaXRpb24ueSArIHBhcnRpY2xlLnZlbG9jaXR5LnZlcnRpY2FsLFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgaWYgKG91dE1vZGUgIT09IE91dE1vZGUuYm91bmNlVmVydGljYWwpIHtcbiAgICAgICAgICAgICAgICBpZiAocG9zLnggKyBwYXJ0aWNsZS5yYWRpdXMgPiBjb250YWluZXIuY2FudmFzLmRpbWVuc2lvbi53aWR0aCB8fCBwb3MueCAtIHBhcnRpY2xlLnJhZGl1cyA8IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcGFydGljbGUudmVsb2NpdHkuaG9yaXpvbnRhbCA9IC1wYXJ0aWNsZS52ZWxvY2l0eS5ob3Jpem9udGFsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKG91dE1vZGUgIT09IE91dE1vZGUuYm91bmNlSG9yaXpvbnRhbCkge1xuICAgICAgICAgICAgICAgIGlmIChwb3MueSArIHBhcnRpY2xlLnJhZGl1cyA+IGNvbnRhaW5lci5jYW52YXMuZGltZW5zaW9uLmhlaWdodCB8fCBwb3MueSAtIHBhcnRpY2xlLnJhZGl1cyA8IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcGFydGljbGUudmVsb2NpdHkudmVydGljYWwgPSAtcGFydGljbGUudmVsb2NpdHkudmVydGljYWw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuIl19