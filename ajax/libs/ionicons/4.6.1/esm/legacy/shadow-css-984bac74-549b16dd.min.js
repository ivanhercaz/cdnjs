function scopeCss(t,e,o){return(new ShadowCss).shimCssText(t,e,e+"-h",e+"-s",o)}var ShadowCss=function(){function t(){this.strictStyling=!0}return t.prototype.shimCssText=function(t,e,o,r,n){void 0===o&&(o=""),void 0===r&&(r=""),void 0===n&&(n=!1);var s=extractCommentsWithHash(t);t=stripComments(t);var l=[];if(n){var c=function(t){var e="/*!@___"+l.length+"___*/",o="/*!@"+t.selector+"*/";return l.push({placeholder:e,comment:o}),t.selector=e+t.selector,t};t=processRules(t,function(t){return"@"!==t.selector[0]?c(t):t.selector.startsWith("@media")||t.selector.startsWith("@supports")||t.selector.startsWith("@page")||t.selector.startsWith("@document")?(t.content=processRules(t.content,c),t):t})}var i=this._scopeCssText(t,e,o,r,n);return t=[i].concat(s).join("\n"),n&&l.forEach(function(e){var o=e.placeholder,r=e.comment;t=t.replace(o,r)}),t},t.prototype._scopeCssText=function(t,e,o,r,n){return t=this._insertPolyfillHostInCssText(t),t=this._convertColonHost(t),t=this._convertColonHostContext(t),t=this._convertColonSlotted(t,r),t=this._convertShadowDOMSelectors(t),e&&(t=this._scopeSelectors(t,e,o,r,n)),(t=(t=t.replace(/-shadowcsshost-no-combinator/g,"."+o)).replace(/>\s*\*\s+([^{, ]+)/gm," $1 ")).trim()},t.prototype._convertColonHost=function(t){return this._convertColonRule(t,_cssColonHostRe,this._colonHostPartReplacer)},t.prototype._convertColonSlotted=function(t,e){var o=_cssColonSlottedRe;return t.replace(o,function(){for(var t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];if(t[2]){var r=t[2].trim(),n=t[3];return"."+e+" > "+r+n}return _polyfillHostNoCombinator+t[3]})},t.prototype._convertColonHostContext=function(t){return this._convertColonRule(t,_cssColonHostContextRe,this._colonHostContextPartReplacer)},t.prototype._convertColonRule=function(t,e,o){return t.replace(e,function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(t[2]){for(var r=t[2].split(","),n=[],s=0;s<r.length;s++){var l=r[s].trim();if(!l)break;n.push(o(_polyfillHostNoCombinator,l,t[3]))}return n.join(",")}return _polyfillHostNoCombinator+t[3]})},t.prototype._colonHostContextPartReplacer=function(t,e,o){return e.indexOf(_polyfillHost)>-1?this._colonHostPartReplacer(t,e,o):t+e+o+", "+e+" "+t+o},t.prototype._colonHostPartReplacer=function(t,e,o){return t+e.replace(_polyfillHost,"")+o},t.prototype._convertShadowDOMSelectors=function(t){return _shadowDOMSelectorsRe.reduce(function(t,e){return t.replace(e," ")},t)},t.prototype._scopeSelectors=function(t,e,o,r,n){var s=this;return processRules(t,function(t){var l=t.selector,c=t.content;return"@"!==t.selector[0]?l=s._scopeSelector(t.selector,e,o,r,s.strictStyling):(t.selector.startsWith("@media")||t.selector.startsWith("@supports")||t.selector.startsWith("@page")||t.selector.startsWith("@document"))&&(c=s._scopeSelectors(t.content,e,o,r,n)),l=l.replace(/\s{2,}/g," ").trim(),new CssRule(l,c)})},t.prototype._scopeSelector=function(t,e,o,r,n){var s=this;return t.split(",").map(function(t){return r&&t.indexOf("."+r)>-1?t.trim():s._selectorNeedsScoping(t,e)?n?s._applyStrictSelectorScope(t,e,o).trim():s._applySelectorScope(t,e,o).trim():t.trim()}).join(", ")},t.prototype._selectorNeedsScoping=function(t,e){return!this._makeScopeMatcher(e).test(t)},t.prototype._makeScopeMatcher=function(t){return t=t.replace(/\[/g,"\\[").replace(/\]/g,"\\]"),new RegExp("^("+t+")"+_selectorReSuffix,"m")},t.prototype._applySelectorScope=function(t,e,o){return this._applySimpleSelectorScope(t,e,o)},t.prototype._applySimpleSelectorScope=function(t,e,o){if(_polyfillHostRe.lastIndex=0,_polyfillHostRe.test(t)){var r=this.strictStyling?"."+o:e;return t.replace(_polyfillHostNoCombinatorRe,function(t,e){return e.replace(/([^:]*)(:*)(.*)/,function(t,e,o,n){return e+r+o+n})}).replace(_polyfillHostRe,r+" ")}return e+" "+t},t.prototype._applyStrictSelectorScope=function(t,e,o){for(var r,n=this,s="."+(e=e.replace(/\[is=([^\]]*)\]/g,function(t){for(var e=[],o=1;o<arguments.length;o++)e[o-1]=arguments[o];return e[0]})),l=function(t){var r=t.trim();if(!r)return"";if(t.indexOf(_polyfillHostNoCombinator)>-1)r=n._applySimpleSelectorScope(t,e,o);else{var l=t.replace(_polyfillHostRe,"");if(l.length>0){var c=l.match(/([^:]*)(:*)(.*)/);c&&(r=c[1]+s+c[2]+c[3])}}return r},c=new SafeSelector(t),i="",p=0,a=/( |>|\+|~(?!=))\s*/g,u=!((t=c.content()).indexOf(_polyfillHostNoCombinator)>-1);null!==(r=a.exec(t));){var _=r[1],f=t.slice(p,r.index).trim();i+=((u=u||f.indexOf(_polyfillHostNoCombinator)>-1)?l(f):f)+" "+_+" ",p=a.lastIndex}var h=t.substring(p);return i+=(u=u||h.indexOf(_polyfillHostNoCombinator)>-1)?l(h):h,c.restore(i)},t.prototype._insertPolyfillHostInCssText=function(t){return t=t.replace(_colonHostContextRe,_polyfillHostContext).replace(_colonHostRe,_polyfillHost).replace(_colonSlottedRe,_polyfillSlotted)},t}(),SafeSelector=function(){function t(t){var e=this;this.placeholders=[],this.index=0,t=t.replace(/(\[[^\]]*\])/g,function(t,o){var r="__ph-"+e.index+"__";return e.placeholders.push(o),e.index++,r}),this._content=t.replace(/(:nth-[-\w]+)(\([^)]+\))/g,function(t,o,r){var n="__ph-"+e.index+"__";return e.placeholders.push(r),e.index++,o+n})}return t.prototype.restore=function(t){var e=this;return t.replace(/__ph-(\d+)__/g,function(t,o){return e.placeholders[+o]})},t.prototype.content=function(){return this._content},t}(),_polyfillHost="-shadowcsshost",_polyfillSlotted="-shadowcssslotted",_polyfillHostContext="-shadowcsscontext",_parenSuffix=")(?:\\(((?:\\([^)(]*\\)|[^)(]*)+?)\\))?([^,{]*)",_cssColonHostRe=new RegExp("("+_polyfillHost+_parenSuffix,"gim"),_cssColonHostContextRe=new RegExp("("+_polyfillHostContext+_parenSuffix,"gim"),_cssColonSlottedRe=new RegExp("("+_polyfillSlotted+_parenSuffix,"gim"),_polyfillHostNoCombinator=_polyfillHost+"-no-combinator",_polyfillHostNoCombinatorRe=/-shadowcsshost-no-combinator([^\s]*)/,_shadowDOMSelectorsRe=[/::shadow/g,/::content/g],_selectorReSuffix="([>\\s~+[.,{:][\\s\\S]*)?$",_polyfillHostRe=/-shadowcsshost/gim,_colonHostRe=/:host/gim,_colonSlottedRe=/::slotted/gim,_colonHostContextRe=/:host-context/gim,_commentRe=/\/\*\s*[\s\S]*?\*\//g;function stripComments(t){return t.replace(_commentRe,"")}var _commentWithHashRe=/\/\*\s*#\s*source(Mapping)?URL=[\s\S]+?\*\//g;function extractCommentsWithHash(t){return t.match(_commentWithHashRe)||[]}var _ruleRe=/(\s*)([^;\{\}]+?)(\s*)((?:{%BLOCK%}?\s*;?)|(?:\s*;))/g,_curlyRe=/([{}])/g,OPEN_CURLY="{",CLOSE_CURLY="}",BLOCK_PLACEHOLDER="%BLOCK%",CssRule=function(){return function(t,e){this.selector=t,this.content=e}}();function processRules(t,e){var o=escapeBlocks(t),r=0;return o.escapedString.replace(_ruleRe,function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var s=t[2],l="",c=t[4],i="";c&&c.startsWith("{"+BLOCK_PLACEHOLDER)&&(l=o.blocks[r++],c=c.substring(BLOCK_PLACEHOLDER.length+1),i="{");var p=e(new CssRule(s,l));return""+t[1]+p.selector+t[3]+i+p.content+c})}var StringWithEscapedBlocks=function(){return function(t,e){this.escapedString=t,this.blocks=e}}();function escapeBlocks(t){for(var e=t.split(_curlyRe),o=[],r=[],n=0,s=[],l=0;l<e.length;l++){var c=e[l];c===CLOSE_CURLY&&n--,n>0?s.push(c):(s.length>0&&(r.push(s.join("")),o.push(BLOCK_PLACEHOLDER),s=[]),o.push(c)),c===OPEN_CURLY&&n++}return s.length>0&&(r.push(s.join("")),o.push(BLOCK_PLACEHOLDER)),new StringWithEscapedBlocks(o.join(""),r)}export{ShadowCss,scopeCss};