"use strict";exports.__esModule=!0,exports.send=void 0;var _src=require("zalgo-promise/src"),_src2=require("cross-domain-utils/src"),_src3=require("belter/src"),_conf=require("../conf"),_drivers=require("../drivers"),_lib=require("../lib"),_global=require("../global"),_on=require("./on");function validateOptions(e,r,n){if(!e)throw new Error("Expected name");if(n&&"string"!=typeof n&&!Array.isArray(n)&&!(0,_src3.isRegex)(n))throw new TypeError("Expected domain to be a string, array, or regex");if((0,_src2.isWindowClosed)(r))throw new Error("Target window is closed")}function normalizeDomain(e,r,n,{send:o}){return"string"==typeof r?_src.ZalgoPromise.resolve(r):_src.ZalgoPromise.try(()=>n||(0,_lib.sayHello)(e,{send:o}).then(({domain:e})=>e)).then(e=>{if(!(0,_src2.matchDomain)(r,r))throw new Error(`Domain ${(0,_src3.stringify)(r)} does not match ${(0,_src3.stringify)(r)}`);return e})}const send=(e,r,n,o)=>{let s=(o=o||{}).domain||_conf.WILDCARD;const i=o.timeout||_conf.RES_TIMEOUT,t=o.timeout||_conf.CHILD_WINDOW_TIMEOUT,c=o.fireAndForget||!1;return _src.ZalgoPromise.try(()=>{if(validateOptions(r,e,s),(0,_src2.isAncestor)(window,e))return(0,_lib.awaitWindowHello)(e,t)}).then(({domain:r}={})=>normalizeDomain(e,s,r,{send:send})).then(o=>{s=o;const t=r===_conf.MESSAGE_NAME.METHOD&&n&&"string"==typeof n.name?`${n.name}()`:r;__DEBUG__&&console.info("send::req",t,s,"\n\n",n);const a=new _src.ZalgoPromise,_=`${r}_${(0,_src3.uniqueID)()}`;if(!c){const n={name:r,win:e,domain:s,promise:a};(0,_drivers.addResponseListener)(_,n);const o=(0,_global.windowStore)("requestPromises").getOrSet(e,()=>[]);o.push(a),a.catch(()=>{(0,_drivers.markResponseListenerErrored)(_),(0,_drivers.deleteResponseListener)(_)});const c=(0,_lib.isWindowKnown)(e)?_conf.ACK_TIMEOUT_KNOWN:_conf.ACK_TIMEOUT,d=i;let l=c,E=d;const f=(0,_src3.safeInterval)(()=>(0,_src2.isWindowClosed)(e)?a.reject(new Error(`Window closed for ${r} before ${n.ack?"response":"ack"}`)):n.cancelled?a.reject(new Error(`Response listener was cancelled for ${r}`)):(l=Math.max(l-_conf.RESPONSE_CYCLE_TIME,0),-1!==E&&(E=Math.max(E-_conf.RESPONSE_CYCLE_TIME,0)),n.ack||0!==l?0===E?a.reject(new Error(`No response for postMessage ${t} in ${(0,_src2.getDomain)()} in ${d}ms`)):void 0:a.reject(new Error(`No ack for postMessage ${t} in ${(0,_src2.getDomain)()} in ${c}ms`))),_conf.RESPONSE_CYCLE_TIME);a.finally(()=>{f.cancel(),o.splice(o.indexOf(a,1))}).catch(_src3.noop)}try{(0,_drivers.sendMessage)(e,s,{type:_conf.MESSAGE_TYPE.REQUEST,hash:_,name:r,data:n,fireAndForget:c},{on:_on.on,send:send})}catch(e){throw new Error(`Send request message failed for ${t} in ${(0,_src2.getDomain)()}\n\n${(0,_src3.stringifyError)(e)}`)}return c?a.resolve():a})};exports.send=send;