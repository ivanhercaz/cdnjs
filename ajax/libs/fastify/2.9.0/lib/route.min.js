"use strict";const FindMyWay=require("find-my-way"),proxyAddr=require("proxy-addr"),Context=require("./context"),{buildMiddie:buildMiddie,onRunMiddlewares:onRunMiddlewares}=require("./middleware"),{hookRunner:hookRunner,hookIterator:hookIterator}=require("./hooks"),supportedMethods=["DELETE","GET","HEAD","PATCH","POST","PUT","OPTIONS"],supportedHooks=["preParsing","preValidation","onRequest","preHandler","preSerialization","onResponse"],validation=require("./validation"),buildSchema=validation.build,{buildSchemaCompiler:buildSchemaCompiler}=validation,{beforeHandlerWarning:beforeHandlerWarning}=require("./warnings"),{codes:{FST_ERR_SCH_BUILD:FST_ERR_SCH_BUILD,FST_ERR_SCH_MISSING_COMPILER:FST_ERR_SCH_MISSING_COMPILER}}=require("./errors"),{kRoutePrefix:kRoutePrefix,kLogLevel:kLogLevel,kHooks:kHooks,kSchemas:kSchemas,kSchemaCompiler:kSchemaCompiler,kSchemaResolver:kSchemaResolver,kContentTypeParser:kContentTypeParser,kReply:kReply,kReplySerializerDefault:kReplySerializerDefault,kRequest:kRequest,kMiddlewares:kMiddlewares,kGlobalHooks:kGlobalHooks,kDisableRequestLogging:kDisableRequestLogging}=require("./symbols.js");function buildRouting(e){const o=FindMyWay(e.config),r=new Map;let t,i,n,l,s,a,d,u,h,c,p,f,m,k,g,y;r.put=r.set;let R=!1;return{setup(e,o){t=o.avvio,i=o.fourOhFour,d=o.logger,u=o.hasLogger,h=o.setupResponseListeners,c=o.throwIfAlreadyStarted,p=getTrustProxyFn(e),n=e.trustProxy,l=e.requestIdHeader,s=e.querystringParser,a=e.requestIdLogLabel,f=e.modifyCoreObjects,m=e.genReqId,k=e.disableRequestLogging,g=e.ignoreTrailingSlash,y=!Object.prototype.hasOwnProperty.call(e,"return503OnClosing")||e.return503OnClosing},routing:o.lookup.bind(o),route:b,prepareRoute:function(e,o,r,t){if(t||"function"!=typeof r){if(t&&"function"==typeof t){if("[object Object]"!==Object.prototype.toString.call(r))throw new Error(`Options for ${e}:${o} route must be an object`);if(r.handler)throw"function"==typeof r.handler?new Error(`Duplicate handler for ${e}:${o} route is not allowed!`):new Error(`Handler for ${e}:${o} route must be a function`)}}else t=r,r={};return r=Object.assign({},r,{method:e,url:o,handler:t||r&&r.handler}),b.call(this,r)},routeHandler:S,closeRoutes:()=>{R=!0},printRoutes:o.prettyPrint.bind(o)};function b(e){if(c("Cannot add route when fastify instance is already started!"),Array.isArray(e.method)){for(var n=0;n<e.method.length;n++)if(-1===supportedMethods.indexOf(e.method[n]))throw new Error(`${e.method[n]} method is not supported!`)}else if(-1===supportedMethods.indexOf(e.method))throw new Error(`${e.method} method is not supported!`);if(!e.handler)throw new Error(`Missing handler function for ${e.method}:${e.url} route.`);validateBodyLimitOption(e.bodyLimit),null==e.preHandler&&null!=e.beforeHandler&&(beforeHandlerWarning(),e.preHandler=e.beforeHandler);const l=this[kRoutePrefix];return this.after((o,r)=>{var t=e.url||e.path;if("/"===t&&l.length>0)switch(e.prefixTrailingSlash){case"slash":s.call(this,t,o,r);break;case"no-slash":s.call(this,"",o,r);break;case"both":default:s.call(this,"",o,r),!0!==g&&s.call(this,t,o,r)}else"/"===t[0]&&l.endsWith("/")?s.call(this,t.slice(1),o,r):s.call(this,t,o,r)}),this;function s(n,s,a){const d=l+n;e.url=d,e.path=d,e.prefix=l,e.logLevel=e.logLevel||this[kLogLevel],null==e.attachValidation&&(e.attachValidation=!1);for(const o of this[kGlobalHooks].onRoute)try{o.call(this,e)}catch(e){return void a(e)}const u=e.config||{};u.url=d;const h=new Context(e.schema,e.handler.bind(this),this[kReply],this[kRequest],this[kContentTypeParser],u,this._errorHandler,e.bodyLimit,e.logLevel,e.attachValidation,this[kReplySerializerDefault]);if(e.schema){if(null==this[kSchemaCompiler]&&this[kSchemaResolver])return void a(new FST_ERR_SCH_MISSING_COMPILER(e.method,d));try{if(null==e.schemaCompiler&&null==this[kSchemaCompiler]){const e=this[kSchemas].getJsonSchemas({onlyAbsoluteUri:!0});this.setSchemaCompiler(buildSchemaCompiler(e,r))}buildSchema(h,e.schemaCompiler||this[kSchemaCompiler],this[kSchemas],this[kSchemaResolver])}catch(o){return void a(o.code?o:new FST_ERR_SCH_BUILD(e.method,d,o.message))}}for(const o of supportedHooks)e[o]&&(Array.isArray(e[o])?e[o]=e[o].map(e=>e.bind(this)):e[o]=e[o].bind(this));try{o.on(e.method,d,{version:e.version},S,h)}catch(e){return void a(e)}t.once("preReady",()=>{const o=this[kHooks].onResponse,r=this[kHooks].onSend,t=this[kHooks].onError;h.onSend=r.length?r:null,h.onError=t.length?t:null,h.onResponse=o.length?o:null;for(const o of supportedHooks){const r=this[kHooks][o].concat(e[o]||[]);h[o]=r.length?r:null}h._middie=buildMiddie(this[kMiddlewares]),i.setContext(this,h)}),a(s)}}function S(e,o,r,t){if(!0===R&&(2!==e.httpVersionMajor&&(o.once("finish",()=>e.destroy()),o.setHeader("Connection","close")),y)){const e={"Content-Type":"application/json","Content-Length":"80"};return o.writeHead(503,e),void o.end('{"error":"Service Unavailable","message":"Service Unavailable","statusCode":503}')}e.id=e.headers[l]||m(e),e.originalUrl=e.url;var i,c=e.headers.host,g=e.connection.remoteAddress;n&&(g=proxyAddr(e,p),i=proxyAddr.all(e,p),void 0!==g&&e.headers["x-forwarded-host"]&&(c=e.headers["x-forwarded-host"]));var b=d.child({[a]:e.id,level:t.logLevel});b[kDisableRequestLogging]=k,f&&(e.hostname=c,e.ip=g,e.ips=i,e.log=o.log=b),!1===k&&b.info({req:e},"incoming request");var S=e.url.indexOf("?"),v=s(S>-1?e.url.slice(S+1):""),w=new t.Request(r,e,v,e.headers,b,g,i,c),C=new t.Reply(o,t,w,b);!0!==u&&null===t.onResponse||h(C),null!==t.onRequest?hookRunner(t.onRequest,hookIterator,w,C,middlewareCallback):middlewareCallback(null,w,C)}}function validateBodyLimitOption(e){if(void 0!==e&&(!Number.isInteger(e)||e<=0))throw new TypeError(`'bodyLimit' option must be an integer > 0. Got '${e}'`)}function middlewareCallback(e,o,r){!0!==r.sent&&(null==e?null!==r.context._middie?r.context._middie.run(o.raw,r.res,r):onRunMiddlewares(null,null,null,r):r.send(e))}function getTrustProxyFn(e){const o=e.trustProxy;if("function"==typeof o)return o;if(!0===o)return function(){return!0};if("number"==typeof o)return function(e,r){return r<o};if("string"==typeof o){const e=o.split(",").map(e=>e.trim());return proxyAddr.compile(e)}return proxyAddr.compile(o||[])}module.exports={buildRouting:buildRouting,validateBodyLimitOption:validateBodyLimitOption};