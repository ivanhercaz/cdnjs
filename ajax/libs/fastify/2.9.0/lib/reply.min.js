"use strict";const eos=require("readable-stream").finished,statusCodes=require("http").STATUS_CODES,flatstr=require("flatstr"),FJS=require("fast-json-stringify"),{kFourOhFourContext:kFourOhFourContext,kReplyErrorHandlerCalled:kReplyErrorHandlerCalled,kReplySent:kReplySent,kReplySentOverwritten:kReplySentOverwritten,kReplyStartTime:kReplyStartTime,kReplySerializer:kReplySerializer,kReplySerializerDefault:kReplySerializerDefault,kReplyIsError:kReplyIsError,kReplyHeaders:kReplyHeaders,kReplyHasStatusCode:kReplyHasStatusCode,kReplyIsRunningOnErrorHook:kReplyIsRunningOnErrorHook,kDisableRequestLogging:kDisableRequestLogging}=require("./symbols.js"),{hookRunner:hookRunner,onSendHookRunner:onSendHookRunner}=require("./hooks"),validation=require("./validation"),serialize=validation.serialize,loggerUtils=require("./logger"),now=loggerUtils.now,wrapThenable=require("./wrapThenable"),serializeError=FJS({type:"object",properties:{statusCode:{type:"number"},code:{type:"string"},error:{type:"string"},message:{type:"string"}}}),CONTENT_TYPE={JSON:"application/json; charset=utf-8",PLAIN:"text/plain; charset=utf-8",OCTET:"application/octet-stream"},{codes:{FST_ERR_REP_INVALID_PAYLOAD_TYPE:FST_ERR_REP_INVALID_PAYLOAD_TYPE,FST_ERR_REP_ALREADY_SENT:FST_ERR_REP_ALREADY_SENT,FST_ERR_REP_SENT_VALUE:FST_ERR_REP_SENT_VALUE,FST_ERR_SEND_INSIDE_ONERR:FST_ERR_SEND_INSIDE_ONERR}}=require("./errors");var getHeader;function Reply(e,r,t,o){this.res=e,this.context=r,this[kReplySent]=!1,this[kReplySerializer]=null,this[kReplyErrorHandlerCalled]=!1,this[kReplyIsError]=!1,this[kReplyIsRunningOnErrorHook]=!1,this.request=t,this[kReplyHeaders]={},this[kReplyHasStatusCode]=!1,this[kReplyStartTime]=void 0,this.log=o}function preserializeHook(e,r){null!==e.context.preSerialization?onSendHookRunner(e.context.preSerialization,e.request,e,r,preserializeHookEnd):preserializeHookEnd(null,e.request,e,r)}function preserializeHookEnd(e,r,t,o){null==e?(o=t.context&&t.context[kReplySerializerDefault]?t.context[kReplySerializerDefault](o,t.res.statusCode):serialize(t.context,o,t.res.statusCode),flatstr(o),onSendHook(t,o)):onErrorHook(t,e)}function onSendHook(e,r){e[kReplySent]=!0,null!==e.context.onSend?onSendHookRunner(e.context.onSend,e.request,e,r,wrapOnSendEnd):onSendEnd(e,r)}function wrapOnSendEnd(e,r,t,o){null!=e?onErrorHook(t,e):onSendEnd(t,o)}function onSendEnd(e,r){var t=e.res,o=t.statusCode;if(null==r)return e[kReplySent]=!0,o>=200&&204!==o&&304!==o&&(e[kReplyHeaders]["content-length"]="0"),t.writeHead(o,e[kReplyHeaders]),void t.end(null,null,null);if("function"!=typeof r.pipe){if("string"!=typeof r&&!Buffer.isBuffer(r))throw new FST_ERR_REP_INVALID_PAYLOAD_TYPE(typeof r);e[kReplyHeaders]["content-length"]||(e[kReplyHeaders]["content-length"]=""+Buffer.byteLength(r)),e[kReplySent]=!0,t.writeHead(o,e[kReplyHeaders]),t.end(r,null,null)}else sendStream(r,t,e)}function sendStream(e,r,t){var o=!0;if(eos(e,{readable:!0,writable:!1},function(e){o=!1,null!=e&&(r.headersSent?(t.log.warn({err:e},"response terminated with an error with headers already sent"),r.destroy()):onErrorHook(t,e))}),eos(r,function(n){null!=n&&(r.headersSent&&t.log.warn({err:n},"response terminated with an error with headers already sent"),o&&(e.destroy?e.destroy():"function"==typeof e.close?e.close(noop):"function"==typeof e.abort&&e.abort()))}),r.headersSent)t.log.warn("response will send, but you shouldn't use res.writeHead in stream mode");else for(var n in t[kReplyHeaders])r.setHeader(n,t[kReplyHeaders][n]);e.pipe(r)}function onErrorHook(e,r,t){e[kReplySent]=!0,null!==e.context.onError&&!0===e[kReplyErrorHandlerCalled]?(e[kReplyIsRunningOnErrorHook]=!0,onSendHookRunner(e.context.onError,e.request,e,r,()=>handleError(e,r,t))):handleError(e,r,t)}function handleError(e,r,t){e[kReplyIsRunningOnErrorHook]=!1;var o=e.res,n=o.statusCode;n=n>=400?n:500,null!=r&&(void 0!==r.headers&&e.headers(r.headers),r.status>=400?n=r.status:r.statusCode>=400&&(n=r.statusCode)),o.statusCode=n;var s=e.context.errorHandler;if(s&&!1===e[kReplyErrorHandlerCalled]){e[kReplySent]=!1,e[kReplyIsError]=!1,e[kReplyErrorHandlerCalled]=!0;var i=s(r,e.request,e);i&&"function"==typeof i.then&&wrapThenable(i,e)}else{var l=serializeError({error:statusCodes[n+""],code:r.code,message:r.message||"",statusCode:n});flatstr(l),e[kReplyHeaders]["content-type"]=CONTENT_TYPE.JSON,t?t(e,l):(e[kReplyHeaders]["content-length"]=""+Buffer.byteLength(l),e[kReplySent]=!0,o.writeHead(o.statusCode,e[kReplyHeaders]),o.end(l))}}function setupResponseListeners(e){e[kReplyStartTime]=now();var r=t=>{e.res.removeListener("finish",r),e.res.removeListener("error",r);var o=e.context;o&&null!==o.onResponse?hookRunner(o.onResponse,onResponseIterator,e.request,e,onResponseCallback):onResponseCallback(t,e.request,e)};e.res.on("finish",r),e.res.on("error",r)}function onResponseIterator(e,r,t,o){return e(r,t,o)}function onResponseCallback(e,r,t){if(!t.log[kDisableRequestLogging]){var o=t.getResponseTime();null==e?t.log.info({res:t.res,responseTime:o},"request completed"):t.log.error({res:t.res,err:e,responseTime:o},"request errored")}}function buildReply(e){function r(e,r,t,o){this.res=e,this.context=r,this[kReplyIsError]=!1,this[kReplyErrorHandlerCalled]=!1,this[kReplySent]=!1,this[kReplySentOverwritten]=!1,this[kReplySerializer]=null,this.request=t,this[kReplyHeaders]={},this[kReplyStartTime]=void 0,this.log=o}return r.prototype=new e,r}function notFound(e){if(e[kReplySent]=!1,e[kReplyIsError]=!1,null===e.context[kFourOhFourContext])return e.log.warn("Trying to send a NotFound error inside a 404 handler. Sending basic 404 response."),void e.code(404).send("404 Not Found");e.context=e.context[kFourOhFourContext],e.context.handler(e.request,e)}function noop(){}function getHeaderProper(e,r){r=r.toLowerCase();var t=e.res,o=e[kReplyHeaders][r];return void 0===o&&t.hasHeader(r)&&(o=t.getHeader(r)),o}function getHeaderFallback(e,r){r=r.toLowerCase();var t=e.res,o=e[kReplyHeaders][r];return void 0===o&&(o=t.getHeader(r)),o}Object.defineProperty(Reply.prototype,"sent",{enumerable:!0,get(){return this[kReplySent]},set(e){if(!0!==e)throw new FST_ERR_REP_SENT_VALUE;if(this[kReplySent])throw new FST_ERR_REP_ALREADY_SENT;this[kReplySentOverwritten]=!0,this[kReplySent]=!0}}),Reply.prototype.send=function(e){if(!0===this[kReplyIsRunningOnErrorHook])throw new FST_ERR_SEND_INSIDE_ONERR;if(this[kReplySent])return this.log.warn({err:new FST_ERR_REP_ALREADY_SENT},"Reply already sent"),this;if(e instanceof Error||!0===this[kReplyIsError])return onErrorHook(this,e,onSendHook),this;if(void 0===e)return onSendHook(this,e),this;var r=getHeader(this,"content-type"),t=void 0!==r;if(null!==e){if(Buffer.isBuffer(e)||"function"==typeof e.pipe)return!1===t&&(this[kReplyHeaders]["content-type"]=CONTENT_TYPE.OCTET),onSendHook(this,e),this;if(!1===t&&"string"==typeof e)return this[kReplyHeaders]["content-type"]=CONTENT_TYPE.PLAIN,onSendHook(this,e),this}if(null!==this[kReplySerializer])e=this[kReplySerializer](e);else if(!1===t||r.indexOf("application/json")>-1)return!1!==t&&-1!==r.indexOf("charset")||(this[kReplyHeaders]["content-type"]=CONTENT_TYPE.JSON),preserializeHook(this,e),this;return onSendHook(this,e),this},Reply.prototype.getHeader=function(e){return getHeader(this,e)},Reply.prototype.hasHeader=function(e){return void 0!==this[kReplyHeaders][e.toLowerCase()]},Reply.prototype.removeHeader=function(e){return delete this[kReplyHeaders][e.toLowerCase()],this},Reply.prototype.header=function(e,r){var t=e.toLowerCase();return r=void 0===r?"":r,this[kReplyHeaders][t]&&"set-cookie"===t?("string"==typeof this[kReplyHeaders][t]&&(this[kReplyHeaders][t]=[this[kReplyHeaders][t]]),Array.isArray(r)?Array.prototype.push.apply(this[kReplyHeaders][t],r):this[kReplyHeaders][t].push(r)):this[kReplyHeaders][t]=r,this},Reply.prototype.headers=function(e){for(var r=Object.keys(e),t=0;t<r.length;t++)this.header(r[t],e[r[t]]);return this},Reply.prototype.code=function(e){return this.res.statusCode=e,this[kReplyHasStatusCode]=!0,this},Reply.prototype.status=Reply.prototype.code,Reply.prototype.serialize=function(e){return null!==this[kReplySerializer]?this[kReplySerializer](e):this.context&&this.context[kReplySerializerDefault]?this.context[kReplySerializerDefault](e,this.res.statusCode):serialize(this.context,e,this.res.statusCode)},Reply.prototype.serializer=function(e){return this[kReplySerializer]=e,this},Reply.prototype.type=function(e){return this[kReplyHeaders]["content-type"]=e,this},Reply.prototype.redirect=function(e,r){"string"==typeof e&&(r=e,e=this[kReplyHasStatusCode]?this.res.statusCode:302),this.header("location",r).code(e).send()},Reply.prototype.callNotFound=function(){notFound(this)},Reply.prototype.getResponseTime=function(){var e=0;return void 0!==this[kReplyStartTime]&&(e=now()-this[kReplyStartTime]),e},Reply.prototype.then=function(e,r){this.sent?e():eos(this.res,function(t){t&&"ERR_STREAM_PREMATURE_CLOSE"!==t.code?r&&r(t):e()})};{const e=process.version.match(/v(\d+)/)[1];getHeader=Number(e)>7?getHeaderProper:getHeaderFallback}module.exports=Reply,module.exports.buildReply=buildReply,module.exports.setupResponseListeners=setupResponseListeners;