"use strict";const assert=require("assert"),http=require("http"),https=require("https"),{kState:kState,kOptions:kOptions}=require("./symbols"),{codes:{FST_ERR_HTTP2_INVALID_VERSION:FST_ERR_HTTP2_INVALID_VERSION}}=require("./errors");function createServer(t,e){assert(t,"Missing options"),assert(e,"Missing http handler");var r=null;return{server:r=t.serverFactory?t.serverFactory(e,t):t.https?t.http2?http2().createSecureServer(t.https,e):https.createServer(t.https,e):t.http2?http2().createServer(e):http.createServer(e),listen:function(){const t=(t=>{if(0===t.length)return{port:0,host:"localhost"};const e="function"==typeof t[t.length-1]?t.pop():void 0,r={cb:e},s=t[0],i=t.length,n=t[i-1];return"object"==typeof s&&null!==s?(r.backlog=i>1?n:void 0,Object.assign(r,s)):"string"==typeof s&&isNaN(s)?(r.path=s,r.backlog=i>1?n:void 0):(r.port=i>=1&&s?s:0,r.host=i>=2&&t[1]?t[1]:"localhost",r.backlog=i>=3?t[2]:void 0),r})(Array.from(arguments)),e=t.cb,s=t=>{if(r.removeListener("error",s),t)this[kState].listening=!1,e(t,null);else{const t=i();e(null,t)}},i=()=>{var t=r.address();const e="string"==typeof t;return e||(t=-1===t.address.indexOf(":")?t.address+":"+t.port:"["+t.address+"]:"+t.port),t=(e?"":"http"+(this[kOptions].https?"s":"")+"://")+t,this.log.info("Server listening at "+t),t};if(void 0===e)return(t=>{if(this[kState].listening)return Promise.reject(new Error("Fastify is already listening"));return this.ready().then(()=>{var e,s=new Promise((t,s)=>{e=(t=>{this[kState].listening=!1,s(t)}),r.once("error",e)}),n=new Promise((s,n)=>{r.listen(t,()=>{r.removeListener("error",e),s(i())}),this[kState].listening=!0});return Promise.race([s,n])})})(t);this.ready(i=>null!=i?e(i):this[kState].listening?e(new Error("Fastify is already listening"),null):(r.once("error",s),r.listen(t,s),void(this[kState].listening=!0)))}}}function http2(){try{return require("http2")}catch(t){throw new FST_ERR_HTTP2_INVALID_VERSION}}module.exports={createServer:createServer};