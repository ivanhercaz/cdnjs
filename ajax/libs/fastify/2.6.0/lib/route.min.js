"use strict";const FindMyWay=require("find-my-way"),proxyAddr=require("proxy-addr"),Context=require("./context"),{buildMiddie:buildMiddie,onRunMiddlewares:onRunMiddlewares}=require("./middleware"),{hookRunner:hookRunner,hookIterator:hookIterator}=require("./hooks"),supportedMethods=["DELETE","GET","HEAD","PATCH","POST","PUT","OPTIONS"],validation=require("./validation"),buildSchema=validation.build,{buildSchemaCompiler:buildSchemaCompiler}=validation,{beforeHandlerWarning:beforeHandlerWarning}=require("./warnings"),{kRoutePrefix:kRoutePrefix,kLogLevel:kLogLevel,kHooks:kHooks,kSchemas:kSchemas,kSchemaCompiler:kSchemaCompiler,kContentTypeParser:kContentTypeParser,kReply:kReply,kReplySerializerDefault:kReplySerializerDefault,kRequest:kRequest,kMiddlewares:kMiddlewares,kGlobalHooks:kGlobalHooks,kDisableRequestLogging:kDisableRequestLogging}=require("./symbols.js");function buildRouting(e){const t=FindMyWay(e.config),o=new Map;let r,i,n,l,a,s,d,u,h,c,p,f,m,k,g;o.put=o.set;let y=!1;return{setup(e,t){r=t.avvio,i=t.fourOhFour,d=t.logger,u=t.hasLogger,h=t.setupResponseListeners,c=t.throwIfAlreadyStarted,p=getTrustProxyFn(e),n=e.trustProxy,l=e.requestIdHeader,a=e.querystringParser,s=e.requestIdLogLabel,f=e.modifyCoreObjects,m=e.genReqId,k=e.disableRequestLogging,g=e.ignoreTrailingSlash},routing:t.lookup.bind(t),route:b,prepareRoute:function(e,t,o,r){if(r||"function"!=typeof o){if(r&&"function"==typeof r){if("[object Object]"!==Object.prototype.toString.call(o))throw new Error(`Options for ${e}:${t} route must be an object`);if(o.handler)throw"function"==typeof o.handler?new Error(`Duplicate handler for ${e}:${t} route is not allowed!`):new Error(`Handler for ${e}:${t} route must be a function`)}}else r=o,o={};return o=Object.assign({},o,{method:e,url:t,handler:r||o&&o.handler}),b.call(this,o)},routeHandler:R,closeRoutes:()=>{y=!0},printRoutes:t.prettyPrint.bind(t)};function b(e){if(c("Cannot add route when fastify instance is already started!"),Array.isArray(e.method)){for(var n=0;n<e.method.length;n++)if(-1===supportedMethods.indexOf(e.method[n]))throw new Error(`${e.method[n]} method is not supported!`)}else if(-1===supportedMethods.indexOf(e.method))throw new Error(`${e.method} method is not supported!`);if(!e.handler)throw new Error(`Missing handler function for ${e.method}:${e.url} route.`);validateBodyLimitOption(e.bodyLimit),null==e.preHandler&&null!=e.beforeHandler&&(beforeHandlerWarning(),e.preHandler=e.beforeHandler);const l=this[kRoutePrefix];return this.after((t,o)=>{var r=e.url||e.path;if("/"===r&&l.length>0)switch(e.prefixTrailingSlash){case"slash":a.call(this,r,t,o);break;case"no-slash":a.call(this,"",t,o);break;case"both":default:a.call(this,"",t,o),!0!==g&&a.call(this,r,t,o)}else"/"===r[0]&&l.endsWith("/")?a.call(this,r.slice(1),t,o):a.call(this,r,t,o)}),this;function a(n,a,s){const d=l+n;e.url=d,e.path=d,e.prefix=l,e.logLevel=e.logLevel||this[kLogLevel],null==e.attachValidation&&(e.attachValidation=!1);for(const t of this[kGlobalHooks].onRoute)try{t.call(this,e)}catch(e){return void s(e)}const u=e.config||{};u.url=d;const h=new Context(e.schema,e.handler.bind(this),this[kReply],this[kRequest],this[kContentTypeParser],u,this._errorHandler,e.bodyLimit,e.logLevel,e.attachValidation,this[kReplySerializerDefault]);if(e.schema)try{if(null==e.schemaCompiler&&null==this[kSchemaCompiler]){const e=this[kSchemas].getJsonSchemas({onlyAbsoluteUri:!0});this.setSchemaCompiler(buildSchemaCompiler(e,o))}buildSchema(h,e.schemaCompiler||this[kSchemaCompiler],this[kSchemas])}catch(e){return void s(e)}const c=["preParsing","preValidation","onRequest","preHandler","preSerialization"];for(let t of c)e[t]&&(Array.isArray(e[t])?e[t]=e[t].map(e=>e.bind(this)):e[t]=e[t].bind(this));try{t.on(e.method,d,{version:e.version},R,h)}catch(e){return void s(e)}r.once("preReady",()=>{const t=this[kHooks].onResponse,o=this[kHooks].onSend,r=this[kHooks].onError;h.onSend=o.length?o:null,h.onError=r.length?r:null,h.onResponse=t.length?t:null;for(let t of c){const o=this[kHooks][t].concat(e[t]||[]);h[t]=o.length?o:null}h._middie=buildMiddie(this[kMiddlewares]),i.setContext(this,h)}),s(a)}}function R(e,t,o,r){if(!0===y){const o={"Content-Type":"application/json","Content-Length":"80"};return 2!==e.httpVersionMajor&&(o.Connection="close"),t.writeHead(503,o),t.end('{"error":"Service Unavailable","message":"Service Unavailable","statusCode":503}'),void(2!==e.httpVersionMajor&&setImmediate(()=>e.destroy()))}e.id=e.headers[l]||m(e),e.originalUrl=e.url;var i,c=e.headers.host,g=e.connection.remoteAddress;n&&(g=proxyAddr(e,p),i=proxyAddr.all(e,p),void 0!==g&&e.headers["x-forwarded-host"]&&(c=e.headers["x-forwarded-host"]));var b=d.child({[s]:e.id,level:r.logLevel});b[kDisableRequestLogging]=k,f&&(e.hostname=c,e.ip=g,e.ips=i,e.log=t.log=b),!1===k&&b.info({req:e},"incoming request");var R=e.url.indexOf("?"),w=a(R>-1?e.url.slice(R+1):""),v=new r.Request(o,e,w,e.headers,b,g,i,c),S=new r.Reply(t,r,v,b);!0!==u&&null===r.onResponse||h(S),null!==r.onRequest?hookRunner(r.onRequest,hookIterator,v,S,middlewareCallback):middlewareCallback(null,v,S)}}function validateBodyLimitOption(e){if(void 0!==e&&(!Number.isInteger(e)||e<=0))throw new TypeError(`'bodyLimit' option must be an integer > 0. Got '${e}'`)}function middlewareCallback(e,t,o){!0!==o.sent&&(null==e?null!==o.context._middie?o.context._middie.run(t.raw,o.res,o):onRunMiddlewares(null,null,null,o):o.send(e))}function getTrustProxyFn(e){const t=e.trustProxy;if("function"==typeof t)return t;if(!0===t)return function(){return!0};if("number"==typeof t)return function(e,o){return o<t};if("string"==typeof t){const e=t.split(",").map(e=>e.trim());return proxyAddr.compile(e)}return proxyAddr.compile(t||[])}module.exports={buildRouting:buildRouting,validateBodyLimitOption:validateBodyLimitOption};