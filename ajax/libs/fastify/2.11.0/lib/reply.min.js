"use strict";const eos=require("readable-stream").finished,statusCodes=require("http").STATUS_CODES,flatstr=require("flatstr"),FJS=require("fast-json-stringify"),{kFourOhFourContext:kFourOhFourContext,kReplyErrorHandlerCalled:kReplyErrorHandlerCalled,kReplySent:kReplySent,kReplySentOverwritten:kReplySentOverwritten,kReplyStartTime:kReplyStartTime,kReplySerializer:kReplySerializer,kReplySerializerDefault:kReplySerializerDefault,kReplyIsError:kReplyIsError,kReplyHeaders:kReplyHeaders,kReplyHasStatusCode:kReplyHasStatusCode,kReplyIsRunningOnErrorHook:kReplyIsRunningOnErrorHook,kDisableRequestLogging:kDisableRequestLogging}=require("./symbols.js"),{hookRunner:hookRunner,onSendHookRunner:onSendHookRunner}=require("./hooks"),validation=require("./validation"),serialize=validation.serialize,loggerUtils=require("./logger"),now=loggerUtils.now,wrapThenable=require("./wrapThenable"),serializeError=FJS({type:"object",properties:{statusCode:{type:"number"},code:{type:"string"},error:{type:"string"},message:{type:"string"}}}),CONTENT_TYPE={JSON:"application/json; charset=utf-8",PLAIN:"text/plain; charset=utf-8",OCTET:"application/octet-stream"},{codes:{FST_ERR_REP_INVALID_PAYLOAD_TYPE:FST_ERR_REP_INVALID_PAYLOAD_TYPE,FST_ERR_REP_ALREADY_SENT:FST_ERR_REP_ALREADY_SENT,FST_ERR_REP_SENT_VALUE:FST_ERR_REP_SENT_VALUE,FST_ERR_SEND_INSIDE_ONERR:FST_ERR_SEND_INSIDE_ONERR}}=require("./errors");var getHeader;function Reply(e,t,r,o){this.res=e,this.context=t,this[kReplySent]=!1,this[kReplySerializer]=null,this[kReplyErrorHandlerCalled]=!1,this[kReplyIsError]=!1,this[kReplyIsRunningOnErrorHook]=!1,this.request=r,this[kReplyHeaders]={},this[kReplyHasStatusCode]=!1,this[kReplyStartTime]=void 0,this.log=o}function preserializeHook(e,t){null!==e.context.preSerialization?onSendHookRunner(e.context.preSerialization,e.request,e,t,preserializeHookEnd):preserializeHookEnd(null,e.request,e,t)}function preserializeHookEnd(e,t,r,o){null==e?(o=r.context&&r.context[kReplySerializerDefault]?r.context[kReplySerializerDefault](o,r.res.statusCode):serialize(r.context,o,r.res.statusCode),flatstr(o),onSendHook(r,o)):onErrorHook(r,e)}function onSendHook(e,t){e[kReplySent]=!0,null!==e.context.onSend?onSendHookRunner(e.context.onSend,e.request,e,t,wrapOnSendEnd):onSendEnd(e,t)}function wrapOnSendEnd(e,t,r,o){null!=e?onErrorHook(r,e):onSendEnd(r,o)}function onSendEnd(e,t){var r=e.res,o=r.statusCode;if(null==t)return e[kReplySent]=!0,o>=200&&204!==o&&304!==o&&(e[kReplyHeaders]["content-length"]="0"),r.writeHead(o,e[kReplyHeaders]),void r.end(null,null,null);if("function"!=typeof t.pipe){if("string"!=typeof t&&!Buffer.isBuffer(t))throw new FST_ERR_REP_INVALID_PAYLOAD_TYPE(typeof t);e[kReplyHeaders]["content-length"]||(e[kReplyHeaders]["content-length"]=""+Buffer.byteLength(t)),e[kReplySent]=!0,r.writeHead(o,e[kReplyHeaders]),r.end(t,null,null)}else sendStream(t,r,e)}function sendStream(e,t,r){var o=!0;if(eos(e,{readable:!0,writable:!1},function(e){o=!1,null!=e&&(t.headersSent?(r.log.warn({err:e},"response terminated with an error with headers already sent"),t.destroy()):onErrorHook(r,e))}),eos(t,function(n){null!=n&&(t.headersSent&&r.log.warn({err:n},"response terminated with an error with headers already sent"),o&&(e.destroy?e.destroy():"function"==typeof e.close?e.close(noop):"function"==typeof e.abort&&e.abort()))}),t.headersSent)r.log.warn("response will send, but you shouldn't use res.writeHead in stream mode");else for(var n in r[kReplyHeaders])t.setHeader(n,r[kReplyHeaders][n]);e.pipe(t)}function onErrorHook(e,t,r){e[kReplySent]=!0,null!==e.context.onError&&!0===e[kReplyErrorHandlerCalled]?(e[kReplyIsRunningOnErrorHook]=!0,onSendHookRunner(e.context.onError,e.request,e,t,()=>handleError(e,t,r))):handleError(e,t,r)}function handleError(e,t,r){e[kReplyIsRunningOnErrorHook]=!1;var o=e.res,n=o.statusCode;n=n>=400?n:500,null!=t&&(void 0!==t.headers&&e.headers(t.headers),t.status>=400?n=t.status:t.statusCode>=400&&(n=t.statusCode)),o.statusCode=n;var s=e.context.errorHandler;if(s&&!1===e[kReplyErrorHandlerCalled]){e[kReplySent]=!1,e[kReplyIsError]=!1,e[kReplyErrorHandlerCalled]=!0;var i=s(t,e.request,e);i&&"function"==typeof i.then&&wrapThenable(i,e)}else{var l=serializeError({error:statusCodes[n+""],code:t.code,message:t.message||"",statusCode:n});flatstr(l),e[kReplyHeaders]["content-type"]=CONTENT_TYPE.JSON,r?r(e,l):(e[kReplyHeaders]["content-length"]=""+Buffer.byteLength(l),e[kReplySent]=!0,o.writeHead(o.statusCode,e[kReplyHeaders]),o.end(l))}}function setupResponseListeners(e){e[kReplyStartTime]=now();var t=r=>{e.res.removeListener("finish",t),e.res.removeListener("error",t);var o=e.context;o&&null!==o.onResponse?hookRunner(o.onResponse,onResponseIterator,e.request,e,onResponseCallback):onResponseCallback(r,e.request,e)};e.res.on("finish",t),e.res.on("error",t)}function onResponseIterator(e,t,r,o){return e(t,r,o)}function onResponseCallback(e,t,r){if(!r.log[kDisableRequestLogging]){var o=r.getResponseTime();null==e?r.log.info({res:r.res,responseTime:o},"request completed"):r.log.error({res:r.res,err:e,responseTime:o},"request errored")}}function buildReply(e){function t(e,t,r,o){this.res=e,this.context=t,this[kReplyIsError]=!1,this[kReplyErrorHandlerCalled]=!1,this[kReplySent]=!1,this[kReplySentOverwritten]=!1,this[kReplySerializer]=null,this.request=r,this[kReplyHeaders]={},this[kReplyStartTime]=void 0,this.log=o}return t.prototype=new e,t}function notFound(e){if(e[kReplySent]=!1,e[kReplyIsError]=!1,null===e.context[kFourOhFourContext])return e.log.warn("Trying to send a NotFound error inside a 404 handler. Sending basic 404 response."),void e.code(404).send("404 Not Found");e.context=e.context[kFourOhFourContext],e.context.handler(e.request,e)}function noop(){}function getHeaderProper(e,t){t=t.toLowerCase();var r=e.res,o=e[kReplyHeaders][t];return void 0===o&&r.hasHeader(t)&&(o=r.getHeader(t)),o}function getHeaderFallback(e,t){t=t.toLowerCase();var r=e.res,o=e[kReplyHeaders][t];return void 0===o&&(o=r.getHeader(t)),o}Object.defineProperty(Reply.prototype,"sent",{enumerable:!0,get(){return this[kReplySent]},set(e){if(!0!==e)throw new FST_ERR_REP_SENT_VALUE;if(this[kReplySent])throw new FST_ERR_REP_ALREADY_SENT;this[kReplySentOverwritten]=!0,this[kReplySent]=!0}}),Object.defineProperty(Reply.prototype,"statusCode",{get(){return this.res.statusCode},set(e){this.code(e)}}),Reply.prototype.send=function(e){if(!0===this[kReplyIsRunningOnErrorHook])throw new FST_ERR_SEND_INSIDE_ONERR;if(this[kReplySent])return this.log.warn({err:new FST_ERR_REP_ALREADY_SENT},"Reply already sent"),this;if(e instanceof Error||!0===this[kReplyIsError])return onErrorHook(this,e,onSendHook),this;if(void 0===e)return onSendHook(this,e),this;var t=getHeader(this,"content-type"),r=void 0!==t;if(null!==e){if(Buffer.isBuffer(e)||"function"==typeof e.pipe)return!1===r&&(this[kReplyHeaders]["content-type"]=CONTENT_TYPE.OCTET),onSendHook(this,e),this;if(!1===r&&"string"==typeof e)return this[kReplyHeaders]["content-type"]=CONTENT_TYPE.PLAIN,onSendHook(this,e),this}if(null!==this[kReplySerializer])e=this[kReplySerializer](e);else if(!1===r||t.indexOf("application/json")>-1)return!1!==r&&-1!==t.indexOf("charset")||(this[kReplyHeaders]["content-type"]=CONTENT_TYPE.JSON),preserializeHook(this,e),this;return onSendHook(this,e),this},Reply.prototype.getHeader=function(e){return getHeader(this,e)},Reply.prototype.hasHeader=function(e){return void 0!==this[kReplyHeaders][e.toLowerCase()]},Reply.prototype.removeHeader=function(e){return delete this[kReplyHeaders][e.toLowerCase()],this},Reply.prototype.header=function(e,t){var r=e.toLowerCase();return t=void 0===t?"":t,this[kReplyHeaders][r]&&"set-cookie"===r?("string"==typeof this[kReplyHeaders][r]&&(this[kReplyHeaders][r]=[this[kReplyHeaders][r]]),Array.isArray(t)?Array.prototype.push.apply(this[kReplyHeaders][r],t):this[kReplyHeaders][r].push(t)):this[kReplyHeaders][r]=t,this},Reply.prototype.headers=function(e){for(var t=Object.keys(e),r=0;r<t.length;r++)this.header(t[r],e[t[r]]);return this},Reply.prototype.code=function(e){return this.res.statusCode=e,this[kReplyHasStatusCode]=!0,this},Reply.prototype.status=Reply.prototype.code,Reply.prototype.serialize=function(e){return null!==this[kReplySerializer]?this[kReplySerializer](e):this.context&&this.context[kReplySerializerDefault]?this.context[kReplySerializerDefault](e,this.res.statusCode):serialize(this.context,e,this.res.statusCode)},Reply.prototype.serializer=function(e){return this[kReplySerializer]=e,this},Reply.prototype.type=function(e){return this[kReplyHeaders]["content-type"]=e,this},Reply.prototype.redirect=function(e,t){"string"==typeof e&&(t=e,e=this[kReplyHasStatusCode]?this.res.statusCode:302),this.header("location",t).code(e).send()},Reply.prototype.callNotFound=function(){notFound(this)},Reply.prototype.getResponseTime=function(){var e=0;return void 0!==this[kReplyStartTime]&&(e=now()-this[kReplyStartTime]),e},Reply.prototype.then=function(e,t){this.sent?e():eos(this.res,function(r){r&&"ERR_STREAM_PREMATURE_CLOSE"!==r.code?t&&t(r):e()})};{const e=process.version.match(/v(\d+)/)[1];getHeader=Number(e)>7?getHeaderProper:getHeaderFallback}module.exports=Reply,module.exports.buildReply=buildReply,module.exports.setupResponseListeners=setupResponseListeners;