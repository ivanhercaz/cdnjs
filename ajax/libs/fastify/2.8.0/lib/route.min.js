"use strict";const FindMyWay=require("find-my-way"),proxyAddr=require("proxy-addr"),Context=require("./context"),{buildMiddie:buildMiddie,onRunMiddlewares:onRunMiddlewares}=require("./middleware"),{hookRunner:hookRunner,hookIterator:hookIterator}=require("./hooks"),supportedMethods=["DELETE","GET","HEAD","PATCH","POST","PUT","OPTIONS"],validation=require("./validation"),buildSchema=validation.build,{buildSchemaCompiler:buildSchemaCompiler}=validation,{beforeHandlerWarning:beforeHandlerWarning}=require("./warnings"),{codes:{FST_ERR_SCH_BUILD:FST_ERR_SCH_BUILD}}=require("./errors"),{kRoutePrefix:kRoutePrefix,kLogLevel:kLogLevel,kHooks:kHooks,kSchemas:kSchemas,kSchemaCompiler:kSchemaCompiler,kContentTypeParser:kContentTypeParser,kReply:kReply,kReplySerializerDefault:kReplySerializerDefault,kRequest:kRequest,kMiddlewares:kMiddlewares,kGlobalHooks:kGlobalHooks,kDisableRequestLogging:kDisableRequestLogging}=require("./symbols.js");function buildRouting(e){const r=FindMyWay(e.config),o=new Map;let t,n,i,l,s,a,d,u,h,c,p,f,m,g,k,y;o.put=o.set;let b=!1;return{setup(e,r){t=r.avvio,n=r.fourOhFour,d=r.logger,u=r.hasLogger,h=r.setupResponseListeners,c=r.throwIfAlreadyStarted,p=getTrustProxyFn(e),i=e.trustProxy,l=e.requestIdHeader,s=e.querystringParser,a=e.requestIdLogLabel,f=e.modifyCoreObjects,m=e.genReqId,g=e.disableRequestLogging,k=e.ignoreTrailingSlash,y=!Object.prototype.hasOwnProperty.call(e,"return503OnClosing")||e.return503OnClosing},routing:r.lookup.bind(r),route:R,prepareRoute:function(e,r,o,t){if(t||"function"!=typeof o){if(t&&"function"==typeof t){if("[object Object]"!==Object.prototype.toString.call(o))throw new Error(`Options for ${e}:${r} route must be an object`);if(o.handler)throw"function"==typeof o.handler?new Error(`Duplicate handler for ${e}:${r} route is not allowed!`):new Error(`Handler for ${e}:${r} route must be a function`)}}else t=o,o={};return o=Object.assign({},o,{method:e,url:r,handler:t||o&&o.handler}),R.call(this,o)},routeHandler:w,closeRoutes:()=>{b=!0},printRoutes:r.prettyPrint.bind(r)};function R(e){if(c("Cannot add route when fastify instance is already started!"),Array.isArray(e.method)){for(var i=0;i<e.method.length;i++)if(-1===supportedMethods.indexOf(e.method[i]))throw new Error(`${e.method[i]} method is not supported!`)}else if(-1===supportedMethods.indexOf(e.method))throw new Error(`${e.method} method is not supported!`);if(!e.handler)throw new Error(`Missing handler function for ${e.method}:${e.url} route.`);validateBodyLimitOption(e.bodyLimit),null==e.preHandler&&null!=e.beforeHandler&&(beforeHandlerWarning(),e.preHandler=e.beforeHandler);const l=this[kRoutePrefix];return this.after((r,o)=>{var t=e.url||e.path;if("/"===t&&l.length>0)switch(e.prefixTrailingSlash){case"slash":s.call(this,t,r,o);break;case"no-slash":s.call(this,"",r,o);break;case"both":default:s.call(this,"",r,o),!0!==k&&s.call(this,t,r,o)}else"/"===t[0]&&l.endsWith("/")?s.call(this,t.slice(1),r,o):s.call(this,t,r,o)}),this;function s(i,s,a){const d=l+i;e.url=d,e.path=d,e.prefix=l,e.logLevel=e.logLevel||this[kLogLevel],null==e.attachValidation&&(e.attachValidation=!1);for(const r of this[kGlobalHooks].onRoute)try{r.call(this,e)}catch(e){return void a(e)}const u=e.config||{};u.url=d;const h=new Context(e.schema,e.handler.bind(this),this[kReply],this[kRequest],this[kContentTypeParser],u,this._errorHandler,e.bodyLimit,e.logLevel,e.attachValidation,this[kReplySerializerDefault]);if(e.schema)try{if(null==e.schemaCompiler&&null==this[kSchemaCompiler]){const e=this[kSchemas].getJsonSchemas({onlyAbsoluteUri:!0});this.setSchemaCompiler(buildSchemaCompiler(e,o))}buildSchema(h,e.schemaCompiler||this[kSchemaCompiler],this[kSchemas])}catch(r){return void a(r.code?r:new FST_ERR_SCH_BUILD(e.method,d,r.message))}const c=["preParsing","preValidation","onRequest","preHandler","preSerialization"];for(const r of c)e[r]&&(Array.isArray(e[r])?e[r]=e[r].map(e=>e.bind(this)):e[r]=e[r].bind(this));try{r.on(e.method,d,{version:e.version},w,h)}catch(e){return void a(e)}t.once("preReady",()=>{const r=this[kHooks].onResponse,o=this[kHooks].onSend,t=this[kHooks].onError;h.onSend=o.length?o:null,h.onError=t.length?t:null,h.onResponse=r.length?r:null;for(const r of c){const o=this[kHooks][r].concat(e[r]||[]);h[r]=o.length?o:null}h._middie=buildMiddie(this[kMiddlewares]),n.setContext(this,h)}),a(s)}}function w(e,r,o,t){if(!0===b&&(2!==e.httpVersionMajor&&(r.once("finish",()=>e.destroy()),r.setHeader("Connection","close")),y)){const e={"Content-Type":"application/json","Content-Length":"80"};return r.writeHead(503,e),void r.end('{"error":"Service Unavailable","message":"Service Unavailable","statusCode":503}')}e.id=e.headers[l]||m(e),e.originalUrl=e.url;var n,c=e.headers.host,k=e.connection.remoteAddress;i&&(k=proxyAddr(e,p),n=proxyAddr.all(e,p),void 0!==k&&e.headers["x-forwarded-host"]&&(c=e.headers["x-forwarded-host"]));var R=d.child({[a]:e.id,level:t.logLevel});R[kDisableRequestLogging]=g,f&&(e.hostname=c,e.ip=k,e.ips=n,e.log=r.log=R),!1===g&&R.info({req:e},"incoming request");var w=e.url.indexOf("?"),v=s(w>-1?e.url.slice(w+1):""),S=new t.Request(o,e,v,e.headers,R,k,n,c),C=new t.Reply(r,t,S,R);!0!==u&&null===t.onResponse||h(C),null!==t.onRequest?hookRunner(t.onRequest,hookIterator,S,C,middlewareCallback):middlewareCallback(null,S,C)}}function validateBodyLimitOption(e){if(void 0!==e&&(!Number.isInteger(e)||e<=0))throw new TypeError(`'bodyLimit' option must be an integer > 0. Got '${e}'`)}function middlewareCallback(e,r,o){!0!==o.sent&&(null==e?null!==o.context._middie?o.context._middie.run(r.raw,o.res,o):onRunMiddlewares(null,null,null,o):o.send(e))}function getTrustProxyFn(e){const r=e.trustProxy;if("function"==typeof r)return r;if(!0===r)return function(){return!0};if("number"==typeof r)return function(e,o){return o<r};if("string"==typeof r){const e=r.split(",").map(e=>e.trim());return proxyAddr.compile(e)}return proxyAddr.compile(r||[])}module.exports={buildRouting:buildRouting,validateBodyLimitOption:validateBodyLimitOption};