"use strict";const fastJsonStringify=require("fast-json-stringify"),Ajv=require("ajv"),bodySchema=Symbol("body-schema"),querystringSchema=Symbol("querystring-schema"),paramsSchema=Symbol("params-schema"),responseSchema=Symbol("response-schema"),headersSchema=Symbol("headers-schema"),kFluentSchema=Symbol.for("fluent-schema-object");function getValidatorForStatusCodeSchema(e,r){return fastJsonStringify(e,{schema:r})}function getResponseSchema(e,r){return Object.keys(e).reduce(function(a,s){return a[s]=getValidatorForStatusCodeSchema(e[s],r),a},{})}function build(e,r,a){if(!e.schema)return;generateFluentSchema(e.schema),e.schema=a.resolveRefs(e.schema);const s=e.schema.headers;if(s&&Object.getPrototypeOf(s)!==Object.prototype)e[headersSchema]=r(s);else if(s){const a={};Object.keys(s).forEach(e=>{a[e]=s[e]}),a.required instanceof Array&&(a.required=a.required.map(e=>e.toLowerCase())),s.properties&&(a.properties={},Object.keys(s.properties).forEach(e=>{a.properties[e.toLowerCase()]=s.properties[e]})),e[headersSchema]=r(a)}e.schema.response&&(e[responseSchema]=getResponseSchema(e.schema.response,a.getSchemas())),e.schema.body&&(e[bodySchema]=r(e.schema.body)),e.schema.querystring&&(e[querystringSchema]=r(e.schema.querystring)),e.schema.params&&(e[paramsSchema]=r(e.schema.params))}function generateFluentSchema(e){["params","body","querystring","query","headers"].forEach(r=>{e[r]&&(e[r].isFluentSchema||e[r][kFluentSchema])&&(e[r]=e[r].valueOf())}),e.response&&Object.keys(e.response).forEach(r=>{(e.response[r].isFluentSchema||e.response[r][kFluentSchema])&&(e.response[r]=e.response[r].valueOf())})}function validateParam(e,r,a){var s=e&&e(r[a]);return!1===s?e.errors:s&&s.error?s.error:(s&&s.value&&(r[a]=s.value),!1)}function validate(e,r){var a=validateParam(e[paramsSchema],r,"params");if(a)return wrapValidationError(a,"params");var s=validateParam(e[bodySchema],r,"body");if(s)return wrapValidationError(s,"body");var t=validateParam(e[querystringSchema],r,"query");if(t)return wrapValidationError(t,"querystring");var o=validateParam(e[headersSchema],r,"headers");return o?wrapValidationError(o,"headers"):null}function wrapValidationError(e,r){if(e instanceof Error)return e;var a=new Error(schemaErrorsText(e,r));return a.validation=e,a}function serialize(e,r,a){var s=e[responseSchema];if(!s)return JSON.stringify(r);if(s[a])return s[a](r);var t=(a+"")[0]+"xx";return s[t]?s[t](r):JSON.stringify(r)}function isValidLogger(e){if(!e)return!1;var r=!0;const a=["info","error","debug","fatal","warn","trace","child"];for(var s=0;s<a.length;s+=1)if(!e[a[s]]||"function"!=typeof e[a[s]]){r=!1;break}return r}function schemaErrorsText(e,r){for(var a="",s=0;s<e.length;s++){var t=e[s];a+=r+(t.dataPath||"")+" "+t.message+", "}return a.slice(0,-", ".length)}function buildSchemaCompiler(e,r){const a=new Ajv({coerceTypes:!0,useDefaults:!0,removeAdditional:!0,allErrors:!0,nullable:!0,cache:r});return Array.isArray(e)&&e.forEach(e=>a.addSchema(e)),a.compile.bind(a)}module.exports={build:build,validate:validate,serialize:serialize,isValidLogger:isValidLogger,buildSchemaCompiler:buildSchemaCompiler},module.exports.symbols={bodySchema:bodySchema,querystringSchema:querystringSchema,responseSchema:responseSchema,paramsSchema:paramsSchema,headersSchema:headersSchema};