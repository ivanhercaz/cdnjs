"use strict";const{validate:validateSchema}=require("./validation"),{hookRunner:hookRunner,hookIterator:hookIterator}=require("./hooks"),wrapThenable=require("./wrapThenable");function handleRequest(e,n,r){if(!0!==r.sent)if(null==e){var a=n.raw.method,t=n.headers;if("GET"!==a&&"HEAD"!==a){var l=t["content-type"];"POST"!==a&&"PUT"!==a&&"PATCH"!==a?"OPTIONS"!==a&&"DELETE"!==a?r.code(404).send(new Error("Not Found")):void 0===l||void 0===t["transfer-encoding"]&&void 0===t["content-length"]?handler(n,r):r.context.contentTypeParser.run(l,handler,n,r):void 0===l?void 0!==t["transfer-encoding"]||"0"!==t["content-length"]&&void 0!==t["content-length"]?r.context.contentTypeParser.run("",handler,n,r):handler(n,r):r.context.contentTypeParser.run(l,handler,n,r)}else handler(n,r)}else r.send(e)}function handler(e,n){null!==n.context.preValidation?hookRunner(n.context.preValidation,hookIterator,e,n,preValidationCallback):preValidationCallback(null,e,n)}function preValidationCallback(e,n,r){if(!0!==r.sent&&!0!==r.raw.writableEnded&&(!1!==r.raw.writable||!0!==r.raw.finished))if(null==e){var a=validateSchema(r.context,n);if(a){if(!1===r.context.attachValidation)return void r.code(400).send(a);r.request.validationError=a}null!==r.context.preHandler?hookRunner(r.context.preHandler,hookIterator,n,r,preHandlerCallback):preHandlerCallback(null,n,r)}else r.send(e)}function preHandlerCallback(e,n,r){if(!(r.sent||!0===r.raw.writableEnded||!1===r.raw.writable&&!0===r.raw.finished))if(null==e){var a;try{a=r.context.handler(n,r)}catch(e){return void r.send(e)}void 0!==a&&(null!==a&&"function"==typeof a.then?wrapThenable(a,r):r.send(a))}else r.send(e)}module.exports=handleRequest,module.exports[Symbol.for("internals")]={handler:handler,preHandlerCallback:preHandlerCallback};