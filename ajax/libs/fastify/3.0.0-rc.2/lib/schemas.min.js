"use strict";const fastClone=require("rfdc")({circles:!1,proto:!0}),{kSchemaVisited:kSchemaVisited}=require("./symbols"),kFluentSchema=Symbol.for("fluent-schema-object"),{codes:{FST_ERR_SCH_MISSING_ID:FST_ERR_SCH_MISSING_ID,FST_ERR_SCH_ALREADY_PRESENT:FST_ERR_SCH_ALREADY_PRESENT,FST_ERR_SCH_DUPLICATE:FST_ERR_SCH_DUPLICATE}}=require("./errors");function Schemas(){this.store={}}function normalizeSchema(e){if(e[kSchemaVisited])return e;if(e.query){if(e.querystring)throw new FST_ERR_SCH_DUPLICATE("querystring");e.querystring=e.query}generateFluentSchema(e);for(const r of["headers","querystring","params","body"])if("object"==typeof e[r]&&Object.getPrototypeOf(e[r])!==Object.prototype)return e;return e.body&&(e.body=getSchemaAnyway(e.body)),e.headers&&(e.headers=getSchemaAnyway(e.headers)),e.querystring&&(e.querystring=getSchemaAnyway(e.querystring)),e.params&&(e.params=getSchemaAnyway(e.params)),e.response&&Object.keys(e.response).forEach(r=>{e.response[r]=getSchemaAnyway(e.response[r])}),e[kSchemaVisited]=!0,e}function generateFluentSchema(e){["params","body","querystring","query","headers"].forEach(r=>{e[r]&&(e[r].isFluentSchema||e[r][kFluentSchema])&&(e[r]=e[r].valueOf())}),e.response&&Object.keys(e.response).forEach(r=>{(e.response[r].isFluentSchema||e.response[r][kFluentSchema])&&(e.response[r]=e.response[r].valueOf())})}function getSchemaAnyway(e){return e.$ref||e.oneOf||e.allOf||e.anyOf||e.$merge||e.$patch?e:e.type||e.properties?e:{type:"object",properties:e}}function buildSchemas(e){const r=new Schemas;return Object.values(e.getSchemas()).forEach(e=>r.add(e)),r}Schemas.prototype.add=function(e){var r=fastClone(e.isFluentSchema||e[kFluentSchema]?e.valueOf():e);const t=r.$id;if(!t)throw new FST_ERR_SCH_MISSING_ID;if(this.store[t])throw new FST_ERR_SCH_ALREADY_PRESENT(t);this.store[t]=r},Schemas.prototype.getSchemas=function(){return Object.assign({},this.store)},Schemas.prototype.getSchema=function(e){return this.store[e]},module.exports={Schemas:Schemas,buildSchemas:buildSchemas,normalizeSchema:normalizeSchema};