"use strict";const fastClone=require("rfdc")({circles:!1,proto:!0}),{kSchemaVisited:kSchemaVisited}=require("./symbols"),kFluentSchema=Symbol.for("fluent-schema-object"),{codes:{FST_ERR_SCH_MISSING_ID:FST_ERR_SCH_MISSING_ID,FST_ERR_SCH_ALREADY_PRESENT:FST_ERR_SCH_ALREADY_PRESENT,FST_ERR_SCH_NOT_PRESENT:FST_ERR_SCH_NOT_PRESENT,FST_ERR_SCH_DUPLICATE:FST_ERR_SCH_DUPLICATE}}=require("./errors"),URI_NAME_FRAGMENT=/^#[A-Za-z]{1}[\w-:.]{0,}$/;function Schemas(){this.store={}}function buildSchemas(e){const t=new Schemas;return e.getJsonSchemas().forEach(e=>t.add(e)),t}Schemas.prototype.add=function(e,t){var s=fastClone(e.isFluentSchema||e[kFluentSchema]?e.valueOf():e);const r=s.$id;if(void 0===r)throw new FST_ERR_SCH_MISSING_ID;if(void 0!==this.store[r])throw new FST_ERR_SCH_ALREADY_PRESENT(r);this.store[r]=this.resolveRefs(s,!0,t)},Schemas.prototype.resolve=function(e){if(void 0===this.store[e])throw new FST_ERR_SCH_NOT_PRESENT(e);return Object.assign({},this.store[e])},Schemas.prototype.resolveRefs=function(e,t,s){if(e[kSchemaVisited])return e;if(e.query){if(e.querystring)throw new FST_ERR_SCH_DUPLICATE("querystring");e.querystring=e.query}for(const t of["headers","querystring","params","body"])if("object"==typeof e[t]&&Object.getPrototypeOf(e[t])!==Object.prototype)return e;const r=Object.assign({},e);try{this.traverse(e,s),!0!==t&&this.cleanId(e)}catch(e){if(/FST_ERR_SCH_*/.test(e.code))throw e;return r}return e.headers&&(e.headers=this.getSchemaAnyway(e.headers)),e.querystring&&(e.querystring=this.getSchemaAnyway(e.querystring)),e.params&&(e.params=this.getSchemaAnyway(e.params)),e[kSchemaVisited]=!0,e},Schemas.prototype.traverse=function(e,t){for(var s in e){if("string"==typeof e[s]&&"$schema"!==s&&"$ref"!==s&&"#"===e[s].slice(-1))e[s]=this.resolve(e[s].slice(0,-1));else if("$ref"===s&&t){const r=e[s],o=r.indexOf("#"),i=o>=0?r.slice(0,o):r;if(i.length>0&&!this.store[i]){const e=t(i);e&&this.add(e,t)}}null!==e[s]&&"object"==typeof e[s]&&("enum"!==s||"enum"===s&&"string"!==e.type)&&this.traverse(e[s],t)}},Schemas.prototype.cleanId=function(e){for(var t in e)"$id"!==t||URI_NAME_FRAGMENT.test(e[t])||delete e[t],null!==e[t]&&"object"==typeof e[t]&&this.cleanId(e[t])},Schemas.prototype.getSchemaAnyway=function(e){return e.oneOf||e.allOf||e.anyOf||e.$merge||e.$patch?e:e.type&&e.properties?e:{type:"object",properties:e}},Schemas.prototype.getSchemas=function(){return Object.assign({},this.store)},Schemas.prototype.getJsonSchemas=function(e){const t=this.getSchemas(),s=Object.keys(t).map(e=>(void 0===t[e].$id&&(t[e].$id=e),t[e]));return e&&!0===e.onlyAbsoluteUri?s.filter(e=>!/^\w*$/g.test(e.$id)):s},module.exports={Schemas:Schemas,buildSchemas:buildSchemas};