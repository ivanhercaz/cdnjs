!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Logline=t()}(this,function(){"use strict";function e(e){u&&console.error("Logline: "+e)}function t(e,t,o,n){u&&window.Logline&&window.Logline.env&&window.Logline.env.verbose&&window.console[l[t.toUpperCase()]||l.INFO](e+" "+t.toUpperCase()+" "+o,n||"")}function o(e){var t,r={};if("object"!==(void 0===e?"undefined":n(e)))return e;for(t in e)e.hasOwnProperty(t)&&"function"!=typeof e[t]&&(r[t]=o(e[t]));return r}var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},a=function(){function e(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,o,n){return o&&e(t.prototype,o),n&&e(t,n),t}}(),i=function e(t,o,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,o);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,o,n)}if("value"in r)return r.value;var i=r.get;if(void 0!==i)return i.call(n)},c=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},s=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},u=window.console,l={INFO:"log",WARN:"warn",ERROR:"error",CRITICAL:"error"},f=function(){function t(e){r(this,t),this._namespace=e}return a(t,[{key:"_record",value:function(t,o,n){e("method _record is not implemented.")}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];this._record.apply(this,["info"].concat(t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];this._record.apply(this,["warn"].concat(t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];this._record.apply(this,["error"].concat(t))}},{key:"critical",value:function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];this._record.apply(this,["critical"].concat(t))}}],[{key:"init",value:function(e){return!0}},{key:"transTimeFormat",value:function(e,t){if(!e||/^\d{13}$/.test(e))return+e;if(t&&!/^\d{13}$/.test(t))throw new TypeError("relative time should be standard unix timestamp");return(t||Date.now())-24*e.replace(/d$/,"")*3600*1e3}},{key:"get",value:function(t,o,n){e("method get is not implemented.")}},{key:"keep",value:function(t){e("method keep is not implemented.")}},{key:"clean",value:function(){e("method clean is not implemented.")}},{key:"STATUS",get:function(){return{INITING:1,INITED:2,FAILED:4}}}]),t}(),p=function(){function e(){r(this,e),this._pool=[]}return a(e,[{key:"push",value:function(e,t){e.context=t,this._pool.push(e)}},{key:"consume",value:function(){for(var e;e=this._pool.shift();)e.call(e.context)}}]),e}(),d=function(n){function u(){var e;r(this,u);for(var t=arguments.length,o=Array(t),n=0;n<t;n++)o[n]=arguments[n];return s(this,(e=u.__proto__||Object.getPrototypeOf(u)).call.apply(e,[this].concat(o)))}return c(u,n),a(u,[{key:"_record",value:function(n,r,a){var i=this;try{if(u.status!==f.STATUS.INITED)return u._pool.push(function(){return i._record(n,r,a)}),void(u.status!==f.STATUS.INITING&&u.init());t(this._namespace,n,r,a);var c=u.db.transaction(["logs"],IDBTransaction.READ_WRITE||"readwrite");c.onerror=function(t){return e(t.target.error)};c.objectStore("logs").add({time:Date.now(),level:n,namespace:this._namespace,descriptor:r,data:o(a)}).onerror=function(t){u.status=f.STATUS.FAILED,e(t.target.error)}}catch(t){e("failed to write, "+t.message)}}}],[{key:"init",value:function(t){var o=this;try{if(u.support||e("your platform does not support indexeddb protocol."),u.status)return!1;u._pool=u._pool||new p,u._database=t||"logline",u.status=i(u.__proto__||Object.getPrototypeOf(u),"STATUS",this).INITING,u.request=window.indexedDB.open(u._database),u.request.onerror=function(t){return e("protocol indexeddb is prevented.")},u.request.onsuccess=function(t){u.db=t.target.result,u.status=i(u.__proto__||Object.getPrototypeOf(u),"STATUS",o).INITED,u._pool.consume(),u.db.onerror=function(t){return e(t.target.error)}},u.request.onupgradeneeded=function(e){var t=e.target.result,o=t.createObjectStore("logs",{autoIncrement:!0});o.createIndex("namespace","namespace",{unique:!1}),o.createIndex("level","level",{unique:!1}),o.createIndex("descriptor","descriptor",{unique:!1}),o.createIndex("data","data",{unique:!1})}}catch(t){e("failed init, "+t.message)}}},{key:"get",value:function(t,o,n){try{if(u.status!==i(u.__proto__||Object.getPrototypeOf(u),"STATUS",this).INITED)return u._pool.push(function(){return u.get(t,o,n)});t=f.transTimeFormat(t),o=f.transTimeFormat(o);var r=u._getTransactionStore(IDBTransaction.READ_ONLY);if(!r)return n([]);if(r.getAll){var a=void 0,c=[];r.getAll().onsuccess=function(e){a=e.target.result;for(var r=0;r<a.length;r++)t&&a[r].time<t||o&&a[r].time>o||c.push(a[r]);n(c)}}else{var s=r.openCursor(),l=[];s.onsuccess=function(e){var r=e.target.result;if(r){if(t&&r.value.time<t||o&&r.value.time>o)return r.continue();l.push({time:r.value.time,level:r.value.level,namespace:r.value.namespace,descriptor:r.value.descriptor,data:r.value.data}),r.continue()}else n(l)}}}catch(t){e("failed to get logs, "+t.message)}}},{key:"keep",value:function(t){try{if(u.status!==i(u.__proto__||Object.getPrototypeOf(u),"STATUS",this).INITED)return u._pool.push(function(){return u.keep(t)});var o=u._getTransactionStore(IDBTransaction.READ_WRITE);if(!o)return!1;if(t){var n=Date.now()-24*(t||2)*3600*1e3,r=o.openCursor();r.onsuccess=function(e){var t=e.target.result;t&&t.value.time<n&&(o.delete(t.primaryKey),t.continue())},r.onerror=function(o){return e("unable to locate logs earlier than "+t+"d.")}}else{o.clear().onerror=function(t){return e(t.target.error)}}}catch(t){e("failed to keep logs, "+t.message)}}},{key:"clean",value:function(){try{if(u.status!==i(u.__proto__||Object.getPrototypeOf(u),"STATUS",this).INITED)return u._pool.push(function(){return u.clean()});u.db.close();var t=window.indexedDB.deleteDatabase(u._database);t.onerror=function(t){return e(t.target.error)},t.onsuccess=function(e){delete u.status,delete u.db}}catch(t){e("failed to cleanup logs, "+t.message)}}},{key:"_getTransactionStore",value:function(t){try{if(u.db){var o=u.db.transaction(["logs"],t||IDBTransaction.READ_WRITE);return o.onerror=function(t){return e(t.target.error)},o.objectStore("logs")}e("log database is not created or connections are closed, considering init it.")}catch(t){return e("failed to generate new transaction, "+t.message),!1}}},{key:"support",get:function(){var e=!!(window.indexedDB&&window.IDBTransaction&&window.IDBKeyRange);return e&&(window.IDBTransaction.READ_WRITE="readwrite",window.IDBTransaction.READ_ONLY="readonly"),e}}]),u}(f),_=function(o){function n(){var e;r(this,n);for(var t=arguments.length,o=Array(t),a=0;a<t;a++)o[a]=arguments[a];return s(this,(e=n.__proto__||Object.getPrototypeOf(n)).call.apply(e,[this].concat(o)))}return c(n,o),a(n,[{key:"_record",value:function(o,r,a){var i;try{i=window.localStorage.getItem(n._database)?JSON.parse(window.localStorage.getItem(n._database)):[],i.push([Date.now(),this._namespace,o,r,a]),t(this._namespace,o,r,a),window.localStorage.setItem(n._database,JSON.stringify(i))}catch(t){window.localStorage.removeItem(n._database),window.localStorage.setItem(n._database,JSON.stringify([])),e("failed to write, may be localStorage is full, "+t.message)}}}],[{key:"init",value:function(t){try{n.support||e("your platform does not support localstorage protocol."),n._database=t||"logline",window.localStorage.getItem(n._database)||window.localStorage.setItem(n._database,JSON.stringify([])),n.status=i(n.__proto__||Object.getPrototypeOf(n),"STATUS",this).INITED}catch(t){e("failed to init, "+t.message)}}},{key:"get",value:function(t,o,r){var a,i;try{for(a=JSON.parse(window.localStorage.getItem(n._database)),t=f.transTimeFormat(t),o=f.transTimeFormat(o),i=0;i<a.length;i++)t&&a[i][0]<t||o&&a[i][0]>o||(a[i]={time:a[i][0],namespace:a[i][1],level:a[i][2],descriptor:a[i][3],data:a[i][4]});r(a)}catch(t){e("failed to get, "+t.message),r([])}}},{key:"keep",value:function(t){var o;try{o=t?(window.localStorage.getItem(n._database)?JSON.parse(window.localStorage.getItem(n._database)):[]).filter(function(e){return e.time>=Date.now()-24*(t||2)*3600*1e3}):[],window.localStorage.setItem(n._database,JSON.stringify(o))}catch(t){e("failed to keep, "+t.message)}}},{key:"clean",value:function(){try{delete n.status,window.localStorage.removeItem(n._database)}catch(t){e("failed to clean, "+t.message)}}},{key:"support",get:function(){return"localStorage"in window}}]),n}(f),g=function(o){function n(){var e;r(this,n);for(var t=arguments.length,o=Array(t),a=0;a<t;a++)o[a]=arguments[a];return s(this,(e=n.__proto__||Object.getPrototypeOf(n)).call.apply(e,[this].concat(o)))}return c(n,o),a(n,[{key:"_record",value:function(o,r,a){var i=this;if(n.status!==f.STATUS.INITED)return n._pool.push(function(){return i._record(o,r,a)}),void(n.status!==f.STATUS.INITING&&n.init());try{t(this._namespace,o,r,a),n._db.transaction(function(t){t.executeSql("INSERT INTO logs (time, namespace, level, descriptor, data) VALUES(?, ?, ?, ? ,?)",[Date.now(),i._namespace,o,r,void 0===a||""===a?"":JSON.stringify(a)||""],function(){},function(t,o){e("write error, "+o.message)})})}catch(t){e("error inserting record, "+t.message)}}}],[{key:"init",value:function(t){var o=this;if(n.support||e(new Error("your platform does not support websql protocol.")),n.status)return!1;n._pool=n._pool||new p,n._database=t||"logline",n.status=i(n.__proto__||Object.getPrototypeOf(n),"STATUS",this).INITING;try{n._db=window.openDatabase(n._database,"1.0","cats loves logs",5085593.6),n._db.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS logs (time, namespace, level, descriptor, data)",[],function(){n.status=i(n.__proto__||Object.getPrototypeOf(n),"STATUS",o).INITED,n._pool.consume()},function(t,r){n.status=i(n.__proto__||Object.getPrototypeOf(n),"STATUS",o).FAILED,e("unable to create table, "+r.message)})})}catch(t){e("unable to init log database, "+t.message)}}},{key:"get",value:function(t,o,r){if(n.status!==i(n.__proto__||Object.getPrototypeOf(n),"STATUS",this).INITED)return n._pool.push(function(){return n.get(t,o,r)});t=f.transTimeFormat(t),o=f.transTimeFormat(o);try{n._db.transaction(function(n){n.executeSql("SELECT * FROM logs ORDER BY time DESC",[],function(e,n){for(var a,i,c=[],s=n.rows.length;--s>=0;)if(i=n.rows.item(s),!(t&&i.time<t||o&&i.time>o)){a=JSON.parse(JSON.stringify(i));try{a.data=JSON.parse(a.data)}catch(e){}c.push(a)}r(c)},function(t,o){e(o.message)})})}catch(t){e("unable to collect logs from database.")}}},{key:"keep",value:function(t){if(n.status!==i(n.__proto__||Object.getPrototypeOf(n),"STATUS",this).INITED)return n._pool.push(function(){return n.keep(t)});try{n._db.transaction(function(o){t?o.executeSql("DELETE FROM logs WHERE time < ?",[Date.now()-24*(t||2)*3600*1e3],function(){},function(t,o){e(o.message)}):o.executeSql("DELETE FROM logs",[],function(){},function(t,o){e(o.message)})})}catch(t){e("unable to clean logs from database.")}}},{key:"clean",value:function(){if(n.status!==i(n.__proto__||Object.getPrototypeOf(n),"STATUS",this).INITED)return void n._pool.push(function(){return n.clean()});try{n._db.transaction(function(t){t.executeSql("DROP TABLE logs",[],function(){delete n.status},function(t,o){e(o.message)})})}catch(t){e("unable to clean log database.")}}},{key:"support",get:function(){return"openDatabase"in window}}]),n}(f),y=function(){function t(e){if(r(this,t),!(this instanceof t))return new t(e);try{return t._checkProtocol(),new t._protocol(e)}catch(t){return new f(e)}}return a(t,null,[{key:"_initProtocol",value:function(e){t._protocol=e,t._protocol.init(t._database||"logline")}},{key:"_checkProtocol",value:function(){if(!t._protocol){for(var o=Object.keys(t.PROTOCOL),n=void 0;n=t.PROTOCOL[o.shift()];)if(n.support)return void t._initProtocol(n);e("protocols "+o.join(", ").toLowerCase()+" are not supported on this platform")}}},{key:"get",value:function(e,o,n){switch(t._checkProtocol(),arguments.length){case 1:n=e,e=void 0;break;case 2:n=o,o=void 0}t._protocol.get(e,o,n)}},{key:"all",value:function(e){t.get(e)}},{key:"keep",value:function(e){return t._checkProtocol(),t._protocol.keep(e),this}},{key:"clean",value:function(){return t._checkProtocol(),t._protocol.clean(),this}},{key:"using",value:function(o,n){return-1===[d,_,g].indexOf(o)&&e("specialfied protocol "+(o?o+" ":"")+"is not available"),t._protocol?this:(t.database(n||t._database),t._initProtocol(o),this)}},{key:"database",value:function(e){t._database=e}}]),t}();return y.PROTOCOL={INDEXEDDB:d,LOCALSTORAGE:_,WEBSQL:g},y.INTERFACE=Object.freeze(f),y.env={verbose:!0},y});
//# sourceMappingURL=logline.min.js.map
