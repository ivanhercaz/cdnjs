!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Logline=t()}(this,function(){"use strict";function e(e){s&&console.error("Logline: "+e)}function t(e,t,o,n){s&&window.Logline&&window.Logline.env&&window.Logline.env.verbose&&window.console[l[t.toUpperCase()]||l.INFO](e+" "+t.toUpperCase()+" "+o,n||"")}function o(e){var t,r={};if("object"!==(void 0===e?"undefined":n(e)))return e;for(t in e)e.hasOwnProperty(t)&&"function"!=typeof e[t]&&(r[t]=o(e[t]));return r}var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},a=function(){function e(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,o,n){return o&&e(t.prototype,o),n&&e(t,n),t}}(),i=function e(t,o,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,o);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,o,n)}if("value"in r)return r.value;var i=r.get;if(void 0!==i)return i.call(n)},c=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},u=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},s=window.console,l={INFO:"log",WARN:"warn",ERROR:"error",CRITICAL:"error"},f=function(){function t(e){r(this,t),this._namespace=e}return a(t,[{key:"_record",value:function(t,o,n){e("method _record is not implemented.")}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];this._record.apply(this,["info"].concat(t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];this._record.apply(this,["warn"].concat(t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];this._record.apply(this,["error"].concat(t))}},{key:"critical",value:function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];this._record.apply(this,["critical"].concat(t))}}],[{key:"init",value:function(e){return!0}},{key:"transTimeFormat",value:function(e,t){if(!e||/^\d{13}$/.test(e))return+e;if(t&&!/^\d{13}$/.test(t))throw new TypeError("relative time should be standard unix timestamp");return(t||Date.now())-24*e.replace(/d$/,"")*3600*1e3}},{key:"get",value:function(t,o,n){e("method get is not implemented.")}},{key:"keep",value:function(t){e("method keep is not implemented.")}},{key:"clean",value:function(){e("method clean is not implemented.")}},{key:"STATUS",get:function(){return{INITING:1,INITED:2,FAILED:4}}}]),t}(),p=function(){function e(){r(this,e),this._pool=[]}return a(e,[{key:"push",value:function(e,t){e.context=t,this._pool.push(e)}},{key:"consume",value:function(){for(var e;e=this._pool.shift();)e.call(e.context)}}]),e}(),d=function(n){function s(){var e;r(this,s);for(var t=arguments.length,o=Array(t),n=0;n<t;n++)o[n]=arguments[n];return u(this,(e=s.__proto__||Object.getPrototypeOf(s)).call.apply(e,[this].concat(o)))}return c(s,n),a(s,[{key:"_record",value:function(n,r,a){var i=this;if(s.status!==f.STATUS.INITED)return s._pool.push(function(){return i._record(n,r,a)}),void(s.status!==f.STATUS.INITING&&s.init());t(this._namespace,n,r,a);var c=s.db.transaction(["logs"],IDBTransaction.READ_WRITE||"readwrite");c.onerror=function(t){return e(t.target.error)},c.objectStore("logs").add({time:Date.now(),level:n,namespace:this._namespace,descriptor:r,data:o(a)}).onerror=function(t){s.status=f.STATUS.FAILED,e(t.target.error)}}}],[{key:"init",value:function(t){var o=this;if(s.support||e("your platform does not support indexeddb protocol."),s.status)return!1;s._pool=s._pool||new p,s._database=t||"logline",s.status=i(s.__proto__||Object.getPrototypeOf(s),"STATUS",this).INITING,s.request=window.indexedDB.open(s._database),s.request.onerror=function(t){return e("protocol indexeddb is prevented.")},s.request.onsuccess=function(t){s.db=t.target.result,s.status=i(s.__proto__||Object.getPrototypeOf(s),"STATUS",o).INITED,s._pool.consume(),s.db.onerror=function(t){return e(t.target.error)}},s.request.onupgradeneeded=function(e){var t=e.target.result,o=t.createObjectStore("logs",{autoIncrement:!0});o.createIndex("namespace","namespace",{unique:!1}),o.createIndex("level","level",{unique:!1}),o.createIndex("descriptor","descriptor",{unique:!1}),o.createIndex("data","data",{unique:!1})}}},{key:"get",value:function(e,t,o){if(s.status!==i(s.__proto__||Object.getPrototypeOf(s),"STATUS",this).INITED)return s._pool.push(function(){return s.get(e,t,o)});e=f.transTimeFormat(e),t=f.transTimeFormat(t);var n=s._getTransactionStore(IDBTransaction.READ_ONLY);if(n.getAll){var r=void 0,a=[];n.getAll().onsuccess=function(n){r=n.target.result;for(var i=0;i<r.length;i++)e&&r[i].time<e||t&&r[i].time>t||a.push(r[i]);o(a)}}else{var c=n.openCursor(),u=[];c.onsuccess=function(n){var r=n.target.result;if(r){if(e&&r.value.time<e||t&&r.value.time>t)return r.continue();u.push({time:r.value.time,level:r.value.level,namespace:r.value.namespace,descriptor:r.value.descriptor,data:r.value.data}),r.continue()}else o(u)}}}},{key:"keep",value:function(t){if(s.status!==i(s.__proto__||Object.getPrototypeOf(s),"STATUS",this).INITED)return s._pool.push(function(){return s.keep(t)});var o=s._getTransactionStore(IDBTransaction.READ_WRITE);if(t){var n=Date.now()-24*(t||2)*3600*1e3,r=o.openCursor();r.onsuccess=function(e){var t=e.target.result;t&&t.value.time<n&&(o.delete(t.primaryKey),t.continue())},r.onerror=function(o){return e("unable to locate logs earlier than "+t+"d.")}}else{o.clear().onerror=function(t){return e(t.target.error)}}}},{key:"clean",value:function(){if(s.status!==i(s.__proto__||Object.getPrototypeOf(s),"STATUS",this).INITED)return s._pool.push(function(){return s.clean()});s.db.close();var t=window.indexedDB.deleteDatabase(s._database);t.onerror=function(t){return e(t.target.error)},t.onsuccess=function(e){delete s.status,delete s.db}}},{key:"_getTransactionStore",value:function(t){if(s.db){var o=s.db.transaction(["logs"],t||IDBTransaction.READ_WRITE);return o.onerror=function(t){return e(t.target.error)},o.objectStore("logs")}e("log database is not created or connections are closed, considering init it.")}},{key:"support",get:function(){var e=!!(window.indexedDB&&window.IDBTransaction&&window.IDBKeyRange);return e&&(window.IDBTransaction.READ_WRITE="readwrite",window.IDBTransaction.READ_ONLY="readonly"),e}}]),s}(f),_=function(o){function n(){var e;r(this,n);for(var t=arguments.length,o=Array(t),a=0;a<t;a++)o[a]=arguments[a];return u(this,(e=n.__proto__||Object.getPrototypeOf(n)).call.apply(e,[this].concat(o)))}return c(n,o),a(n,[{key:"_record",value:function(o,r,a){var i=window.localStorage.getItem(n._database)?JSON.parse(window.localStorage.getItem(n._database)):[];i.push([Date.now(),this._namespace,o,r,a]);try{t(this._namespace,o,r,a),window.localStorage.setItem(n._database,JSON.stringify(i))}catch(t){e("error inserting record")}}}],[{key:"init",value:function(t){n.support||e("your platform does not support localstorage protocol."),n._database=t||"logline",window.localStorage.getItem(n._database)||window.localStorage.setItem(n._database,JSON.stringify([])),n.status=i(n.__proto__||Object.getPrototypeOf(n),"STATUS",this).INITED}},{key:"get",value:function(e,t,o){var r,a=JSON.parse(window.localStorage.getItem(n._database));for(e=f.transTimeFormat(e),t=f.transTimeFormat(t),r=0;r<a.length;r++)e&&a[r][0]<e||t&&a[r][0]>t||(a[r]={time:a[r][0],namespace:a[r][1],level:a[r][2],descriptor:a[r][3],data:a[r][4]});o(a)}},{key:"keep",value:function(e){var t=e?(window.localStorage.getItem(n._database)?JSON.parse(window.localStorage.getItem(n._database)):[]).filter(function(t){return t.time>=Date.now()-24*(e||2)*3600*1e3}):[];window.localStorage.setItem(n._database,JSON.stringify(t))}},{key:"clean",value:function(){delete n.status,window.localStorage.removeItem(n._database)}},{key:"support",get:function(){return"localStorage"in window}}]),n}(f),g=function(o){function n(){var e;r(this,n);for(var t=arguments.length,o=Array(t),a=0;a<t;a++)o[a]=arguments[a];return u(this,(e=n.__proto__||Object.getPrototypeOf(n)).call.apply(e,[this].concat(o)))}return c(n,o),a(n,[{key:"_record",value:function(o,r,a){var i=this;if(n.status!==f.STATUS.INITED)return n._pool.push(function(){return i._record(o,r,a)}),void(n.status!==f.STATUS.INITING&&n.init());try{t(this._namespace,o,r,a),n._db.transaction(function(e){e.executeSql("INSERT INTO logs (time, namespace, level, descriptor, data) VALUES(?, ?, ?, ? ,?)",[Date.now(),i._namespace,o,r,void 0===a||""===a?"":JSON.stringify(a)||""],function(){},function(e,t){throw t.message})})}catch(t){e("error inserting record")}}}],[{key:"init",value:function(t){var o=this;if(n.support||e(new Error("your platform does not support websql protocol.")),n.status)return!1;n._pool=n._pool||new p,n._database=t||"logline",n.status=i(n.__proto__||Object.getPrototypeOf(n),"STATUS",this).INITING;try{n._db=window.openDatabase(n._database,"1.0","cats loves logs",5085593.6),n._db.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS logs (time, namespace, level, descriptor, data)",[],function(){n.status=i(n.__proto__||Object.getPrototypeOf(n),"STATUS",o).INITED,n._pool.consume()},function(){n.status=i(n.__proto__||Object.getPrototypeOf(n),"STATUS",o).FAILED})})}catch(t){e("unable to init log database.")}}},{key:"get",value:function(t,o,r){if(n.status!==i(n.__proto__||Object.getPrototypeOf(n),"STATUS",this).INITED)return n._pool.push(function(){return n.get(t,o,r)});t=f.transTimeFormat(t),o=f.transTimeFormat(o);try{n._db.transaction(function(e){e.executeSql("SELECT * FROM logs ORDER BY time DESC",[],function(e,n){for(var a,i,c=[],u=n.rows.length;--u>=0;)if(i=n.rows.item(u),!(t&&i.time<t||o&&i.time>o)){a=JSON.parse(JSON.stringify(i));try{a.data=JSON.parse(a.data)}catch(e){}c.push(a)}r(c)},function(e,t){throw t.message})})}catch(t){e("unable to collect logs from database.")}}},{key:"keep",value:function(t){if(n.status!==i(n.__proto__||Object.getPrototypeOf(n),"STATUS",this).INITED)return n._pool.push(function(){return n.keep(t)});try{n._db.transaction(function(e){t?e.executeSql("DELETE FROM logs WHERE time < ?",[Date.now()-24*(t||2)*3600*1e3],function(){},function(e,t){throw t.message}):e.executeSql("DELETE FROM logs",[],function(){},function(e,t){throw t.message})})}catch(t){e("unable to clean logs from database.")}}},{key:"clean",value:function(){if(n.status!==i(n.__proto__||Object.getPrototypeOf(n),"STATUS",this).INITED)return void n._pool.push(function(){return n.clean()});try{n._db.transaction(function(e){e.executeSql("DROP TABLE logs",[],function(){delete n.status},function(e,t){throw t.message})})}catch(t){e("unable to clean log database.")}}},{key:"support",get:function(){return"openDatabase"in window}}]),n}(f),y=function(){function t(e){return r(this,t),this instanceof t?(t._checkProtocol(),new t._protocol(e)):new t(e)}return a(t,null,[{key:"_initProtocol",value:function(e){t._protocol=e,t._protocol.init(t._database||"logline")}},{key:"_checkProtocol",value:function(){if(!t._protocol){for(var e=Object.keys(t.PROTOCOL),o=void 0;o=t.PROTOCOL[e.shift()];)if(o.support)return void t._initProtocol(o);throw new Error(e.join(", ").toLowerCase()+" protocols are not supported on this platform")}}},{key:"get",value:function(e,o,n){switch(t._checkProtocol(),arguments.length){case 1:n=e,e=void 0;break;case 2:n=o,o=void 0}t._protocol.get(e,o,n)}},{key:"all",value:function(e){t.get(e)}},{key:"keep",value:function(e){return t._checkProtocol(),t._protocol.keep(e),this}},{key:"clean",value:function(){return t._checkProtocol(),t._protocol.clean(),this}},{key:"using",value:function(o,n){return-1===[d,_,g].indexOf(o)&&e("specialfied protocol "+(o?o+" ":"")+"is not available"),t._protocol?this:(t.database(n||t._database),t._initProtocol(o),this)}},{key:"database",value:function(e){t._database=e}}]),t}();return y.PROTOCOL={INDEXEDDB:d,LOCALSTORAGE:_,WEBSQL:g},y.INTERFACE=Object.freeze(f),y.env={verbose:!0},y});
//# sourceMappingURL=logline.min.js.map
