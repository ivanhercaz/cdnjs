function createSimpleSchema(e){return{factory:function(){return{}},props:e}}var formatters={j:function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}};function invariant(e,t){if(!e){var i=Array.prototype.slice.call(arguments,2),r=[],n=0,a=t.replace(/%([a-zA-Z%])/g,function(e,t){if("%%"===e)return e;var a=formatters[t];if("function"==typeof a){var o=i[n++];return r.push(o),a(o)}return e});throw console&&r.length>0&&console.log.apply(console,r),new Error("[serializr] "+(a||"Illegal State"))}}function GUARDED_NOOP(e){if(e)throw new Error(e)}function once(e){var t=!1;return function(){if(!t)return t=!0,e.apply(null,arguments);invariant(!1,"callback was invoked twice")}}function parallel(e,t,i){if(0!==e.length){var r=e.filter(function(){return!0}).length,n=[],a=!1;e.forEach(function(e,o){t(e,function(e,t,o){t?a||(a=!0,i(t)):(n[e]=o,0==--r&&i(null,n))}.bind(null,o),o)})}else i(null,[])}function isPrimitive(e){return null===e||"object"!=typeof e&&"function"!=typeof e}function isModelSchema(e){return e&&e.factory&&e.props}function isPropSchema(e){return e&&e.serializer&&e.deserializer}function isAliasedPropSchema(e){return"object"==typeof e&&!!e.jsonname}function isIdentifierPropSchema(e){return"object"==typeof e&&!0===e.identifier}function isAssignableTo(e,t){for(;e;){if(e===t)return!0;e=e.extends}return!1}function isMapLike(e){return e&&"function"==typeof e.keys&&"function"==typeof e.clear}function getIdentifierProp(e){for(invariant(isModelSchema(e));e;){for(var t in e.props)if("object"==typeof e.props[t]&&!0===e.props[t].identifier)return t;e=e.extends}return null}function processAdditionalPropArgs(e,t){if(t){invariant(isPropSchema(e),"expected a propSchema");["beforeDeserialize","afterDeserialize"].forEach(function(i){"function"==typeof t[i]&&(e[i]=t[i])})}return e}function getDefaultModelSchema(e){return e?isModelSchema(e)?e:isModelSchema(e.serializeInfo)?e.serializeInfo:e.constructor&&e.constructor.serializeInfo?e.constructor.serializeInfo:void 0:null}function setDefaultModelSchema(e,t){return invariant(isModelSchema(t)),e.serializeInfo=t}function createModelSchema(e,t,i){invariant(e!==Object,"one cannot simply put define a model schema for Object"),invariant("function"==typeof e,"expected constructor function");var r={targetClass:e,factory:i||function(){return new e},props:t};if(e.prototype.constructor!==Object){var n=getDefaultModelSchema(e.prototype.constructor);n&&n.targetClass!==e&&(r.extends=n)}return setDefaultModelSchema(e,r),r}function primitive(e){var t={serializer:function(e){return invariant(isPrimitive(e),"this value is not primitive: "+e),e},deserializer:function(e,t){isPrimitive(e)?t(null,e):t("[serializr] this value is not primitive: "+e)}};return t=processAdditionalPropArgs(t,e)}var SKIP="undefined"!=typeof Symbol?Symbol("SKIP"):{SKIP:!0},_defaultPrimitiveProp=primitive(),STRIP_COMMENTS=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,ARGUMENT_NAMES=/([^\s,]+)/g;function getParamNames(e){var t=e.toString().replace(STRIP_COMMENTS,""),i=t.slice(t.indexOf("(")+1,t.indexOf(")")).match(ARGUMENT_NAMES);return null===i&&(i=[]),i}function serializableDecorator(e,t,i,r){var n;if(invariant(arguments.length>=2,"too few arguments. Please use @serializable as property decorator"),void 0===i&&"function"==typeof t&&t.prototype&&void 0!==r&&"number"==typeof r){invariant(isPropSchema(e),"Constructor params must use alias(name)"),invariant(e.jsonname,"Constructor params must use alias(name)");var a=getParamNames(t);a.length>=r&&(i=a[r],e.paramNumber=r,r=void 0,t=t.prototype,n=function(e){for(var i=[],r=0;r<t.constructor.length;r++)Object.keys(e.modelSchema.props).forEach(function(t){var n=e.modelSchema.props[t];n.paramNumber===r&&(i[r]=e.json[n.jsonname])});return new(Function.prototype.bind.apply(t.constructor,[null].concat(i)))})}invariant("string"==typeof i,"incorrect usage of @serializable decorator");var o=getDefaultModelSchema(t);return o&&t.constructor.hasOwnProperty("serializeInfo")||(o=createModelSchema(t.constructor,{},n)),o&&o.targetClass!==t.constructor&&(o=createModelSchema(t.constructor,{},n)),o.props[i]=e,!r||r.get||r.set||(r.writable=!0),r}function serializable(e,t,i){if(1===arguments.length){var r=!0===e?_defaultPrimitiveProp:e;return invariant(isPropSchema(r),"@serializable expects prop schema"),serializableDecorator.bind(null,r)}return serializableDecorator(primitive(),e,t,i)}function serialize(e,t){invariant(1===arguments.length||2===arguments.length,"serialize expects one or 2 arguments");var i=1===arguments.length?e:t,r=1===arguments.length?null:e;if(Array.isArray(i)){if(0===i.length)return[];r?"object"!=typeof r&&(r=getDefaultModelSchema(r)):r=getDefaultModelSchema(i[0])}else r?"object"!=typeof r&&(r=getDefaultModelSchema(r)):r=getDefaultModelSchema(i);return invariant(!!r,"Failed to find default schema for "+e),Array.isArray(i)?i.map(function(e){return serializeWithSchema(r,e)}):serializeWithSchema(r,i)}function checkStarSchemaInvariant(e){invariant(!0===e||e.pattern,`prop schema '*' can only be used with 'true' or a prop def with a 'pattern': ${JSON.stringify(e)}`)}function serializeWithSchema(e,t){var i;return invariant(e&&"object"==typeof e&&e.props,"Expected schema"),invariant(t&&"object"==typeof t,"Expected object"),i=e.extends?serializeWithSchema(e.extends,t):{},Object.keys(e.props).forEach(function(r){var n=e.props[r];if("*"!==r){if(!0===n&&(n=_defaultPrimitiveProp),!1!==n){var a=n.serializer(t[r],r,t);a!==SKIP&&(i[n.jsonname||r]=a)}}else serializeStarProps(e,n,t,i)}),i}function serializeStarProps(e,t,i,r){for(var n in checkStarSchemaInvariant(t),i)if(i.hasOwnProperty(n)&&!(n in e.props)&&(!0===t||t.pattern&&t.pattern.test(n))){var a=i[n];if(!0===t)isPrimitive(a)&&(r[n]=a);else if(t.props){if((o=serialize(t,a))===SKIP)return;r[n]=o}else{var o;if((o=t.serializer(a,n,i))===SKIP)return;r[n]=o}}}var rootContextCache=new WeakMap;function Context(e,t,i,r,n){this.parentContext=e,this.isRoot=!e,this.pendingCallbacks=0,this.pendingRefsCount=0,this.onReadyCb=r||GUARDED_NOOP,this.json=i,this.target=null,this.hasError=!1,this.modelSchema=t,this.isRoot?(this.rootContext=this,this.args=n,this.pendingRefs={},this.resolvedRefs={}):(this.rootContext=e.rootContext,this.args=e.args)}function getTargetContext(e){return rootContextCache.get(e)}function schemaHasAlias(e,t){for(var i in e.props)if("object"==typeof e.props[i]&&e.props[i].jsonname===t)return!0;return!1}function deserializeStarProps(e,t,i,r,n){for(var a in checkStarSchemaInvariant(i),n)if(!(a in t.props||schemaHasAlias(t,a))){var o=n[a];if(!0===i)invariant(isPrimitive(o),"encountered non primitive value while deserializing '*' properties in property '"+a+"': "+o),r[a]=o;else if(i.pattern.test(a))if(i.factory){var s=deserializeObjectWithSchema(e,i,o,e.callback||GUARDED_NOOP,{});void 0!==s&&(r[a]=s)}else{function l(e){e!==SKIP&&(r[a]=e)}i.deserializer(o,e.rootContext.createCallback(l),e)}}}function deserialize(e,t,i,r){if(invariant(arguments.length>=2,"deserialize expects at least 2 arguments"),invariant(isModelSchema(e=getDefaultModelSchema(e)),"first argument should be model schema"),Array.isArray(t)){var n=[];return parallel(t,function(t,i){var a=deserializeObjectWithSchema(null,e,t,i,r);n.push(a)},i||GUARDED_NOOP),n}return deserializeObjectWithSchema(null,e,t,i,r)}function deserializeObjectWithSchema(e,t,i,r,n){if(null!=i&&"object"==typeof i){var a=new Context(e,t,i,r,n),o=t.factory(a);invariant(!!o,"No object returned from factory"),a.setTarget(o);var s=a.createCallback(GUARDED_NOOP);return deserializePropsWithSchema(a,t,i,o),s(),o}r(null,null)}function deserializePropsWithSchema(e,t,i,r){t.extends&&deserializePropsWithSchema(e,t.extends,i,r),Object.keys(t.props).forEach(function(n){var a=t.props[n];if("*"!==n){if(!0===a&&(a=_defaultPrimitiveProp),!1!==a){var o=a.jsonname||n;onBeforeDeserialize(function(t,o){t||void 0===o||function(t,n,a){t.deserializer(n,function o(s){return function(l,c){onAfterDeserialize(function(i,n){i&&void 0!==n&&"function"==typeof t.afterDeserialize?t.deserializer(n,o(s),e,r[a]):s(i,n)},l,c,n,i,a,e,t)}}(e.rootContext.createCallback(function(e){e!==SKIP&&(r[a]=e)})),e,r[a])}(a,o,n)},i[o],i,o,e,a)}}else deserializeStarProps(e,t,a,r,i)})}function onBeforeDeserialize(e,t,i,r,n,a){a&&"function"==typeof a.beforeDeserialize?a.beforeDeserialize(e,t,i,r,n,a):e(null,t)}function onAfterDeserialize(e,t,i,r,n,a,o,s){s&&"function"==typeof s.afterDeserialize?s.afterDeserialize(e,t,i,r,n,a,o,s):e(t,i)}function object(e,t){invariant("object"==typeof e||"function"==typeof e,"No modelschema provided. If you are importing it from another file be aware of circular dependencies.");var i={serializer:function(t){return invariant(isModelSchema(e=getDefaultModelSchema(e)),"expected modelSchema, got "+e),null==t?t:serialize(e,t)},deserializer:function(i,r,n){invariant(isModelSchema(e=getDefaultModelSchema(e)),"expected modelSchema, got "+e),null!=i?deserializeObjectWithSchema(n,e,i,r,t):r(null,i)}};return i=processAdditionalPropArgs(i,t)}function serializeAll(e,t){let i,r=!1;function n(e){var t=getDefaultModelSchema(e);return t&&e.hasOwnProperty("serializeInfo")||setDefaultModelSchema(e,t=createModelSchema(e,{})),getDefaultModelSchema(e).props["*"]=i,e}return 1===arguments.length?(invariant("function"==typeof e,"@serializeAll can only be used as class decorator"),i=!0,r=!0):(invariant("object"==typeof e&&e.test,"@serializeAll pattern doesn't have test"),"function"==typeof t&&(t=object(t)),invariant("object"==typeof t&&t.serializer,"couldn't resolve schema"),i=Object.assign({},t,{pattern:e})),r?n(e):n}function cancelDeserialize(e){invariant("object"==typeof e&&e&&!Array.isArray(e),"cancelDeserialize needs an object");var t=getTargetContext(e);t&&t.cancelAwaits()}function update(e,t,i,r,n){2===arguments.length||"function"==typeof arguments[2]?(e=getDefaultModelSchema(t=arguments[0]),i=arguments[1],r=arguments[2],n=arguments[3]):e=getDefaultModelSchema(e),invariant(isModelSchema(e),"update failed to determine schema"),invariant("object"==typeof t&&t&&!Array.isArray(t),"update needs an object");var a=new Context(null,e,i,r,n);a.setTarget(t);var o=a.createCallback(GUARDED_NOOP),s=deserializePropsWithSchema(a,e,i,t);return o(),s}function defaultRegisterFunction(e,t,i){i.rootContext.resolve(i.modelSchema,e,i.target)}function identifier(e,t){var i,r;"function"==typeof e?(i=e,r=t):r=e,invariant(!r||"object"==typeof r,"Additional property arguments should be an object, register function should be omitted or a funtion");var n={identifier:!0,serializer:_defaultPrimitiveProp.serializer,deserializer:function(e,t,r){_defaultPrimitiveProp.deserializer(e,function(e,n){defaultRegisterFunction(n,r.target,r),i&&i(n,r.target,r),t(e,n)})}};return n=processAdditionalPropArgs(n,r)}function date(e){var t={serializer:function(e){return null==e?e:(invariant(e instanceof Date,"Expected Date object"),e.getTime())},deserializer:function(e,t){t(null,null!=e?new Date(e):e)}};return t=processAdditionalPropArgs(t,e)}function alias(e,t){return invariant(e&&"string"==typeof e,"expected prop name as first argument"),invariant(isPropSchema(t=t&&!0!==t?t:_defaultPrimitiveProp),"expected prop schema as second argument"),invariant(!isAliasedPropSchema(t),"provided prop is already aliased"),{jsonname:e,serializer:t.serializer,deserializer:t.deserializer,identifier:isIdentifierPropSchema(t),beforeDeserialize:t.beforeDeserialize,afterDeserialize:t.afterDeserialize}}function custom(e,t,i){invariant("function"==typeof e,"first argument should be function"),invariant("function"==typeof t,"second argument should be a function or promise");var r={serializer:e,deserializer:function(e,r,n,a){4===t.length?t(e,n,a,r,i):r(null,t(e,n,a,null,i))}};return r=processAdditionalPropArgs(r,i)}function optional(e,t){invariant(isPropSchema(t=t&&!0!==t?t:_defaultPrimitiveProp),"expected prop schema as second argument");const i=t.serializer;return invariant("function"==typeof i,"expected prop schema to have a callable serializer"),Object.assign({},t,{serializer:function(...e){const t=i(...e);return void 0===t?SKIP:t}})}function createDefaultRefLookup(e){return function(t,i,r){r.rootContext.await(e,t,i)}}function reference(e,t,i){invariant(!!e,"No modelschema provided. If you are importing it from another file be aware of circular dependencies.");var r,n=!1;function a(){if(n=!0,invariant("string"!=typeof e||t&&"function"==typeof t,"if the reference target is specified by attribute name, a lookup function is required"),invariant(!t||"function"==typeof t,"second argument should be a lookup function or additional arguments object"),"string"==typeof e)r=e;else{var i=getDefaultModelSchema(e);invariant(isModelSchema(i),"expected model schema or string as first argument for 'ref', got "+i),t=t||createDefaultRefLookup(i),invariant(!!(r=getIdentifierProp(i)),"provided model schema doesn't define an identifier() property and cannot be used by 'ref'.")}}"object"==typeof t&&void 0===i&&(i=t,t=void 0);var o={serializer:function(e){return n||a(),e?e[r]:null},deserializer:function(e,i,r){n||a(),null==e?i(null,e):t(e,i,r)}};return o=processAdditionalPropArgs(o,i)}function list(e,t){invariant(isPropSchema(e=e||_defaultPrimitiveProp),"expected prop schema as first argument"),invariant(!isAliasedPropSchema(e),"provided prop is aliased, please put aliases first");var i={serializer:function(t){return void 0===t?SKIP:(invariant(t&&"length"in t&&"map"in t,"expected array (like) object"),t.map(e.serializer))},deserializer:function(t,i,r){Array.isArray(t)?parallel(t,function(i,n,a){function o(t,o){"function"==typeof e.afterDeserialize?onAfterDeserialize(s,t,o,i,a,r,e):n(t,o)}function s(t,i){t&&void 0!==i&&"function"==typeof e.afterDeserialize?e.deserializer(i,o,r):n(t,i)}onBeforeDeserialize(function(t,i){t?n(t):e.deserializer(i,o,r)},i,t,a,r,e)},i):i("[serializr] expected JSON array")}};return i=processAdditionalPropArgs(i,t)}function map(e,t){invariant(isPropSchema(e=e||_defaultPrimitiveProp),"expected prop schema as first argument"),invariant(!isAliasedPropSchema(e),"provided prop is aliased, please put aliases first");var i={serializer:function(t){invariant(t&&"object"==typeof t,"expected object or Map");var i=isMapLike(t),r={};if(i)t.forEach(function(t,i){r[i]=e.serializer(t)});else for(var n in t)r[n]=e.serializer(t[n]);return r},deserializer:function(i,r,n,a){if(i&&"object"==typeof i){var o=Object.keys(i);list(e,t).deserializer(o.map(function(e){return i[e]}),function(e,t){if(e)r(e);else{var i,n=isMapLike(a);n?(a.clear(),i=a):i={};for(var s=0,l=o.length;s<l;s++)n?i.set(o[s],t[s]):i[o[s]]=t[s];r(null,i)}},n)}else r("[serializr] expected JSON object")}};return i=processAdditionalPropArgs(i,t)}function mapAsArray(e,t,i){invariant(isPropSchema(e=e||_defaultPrimitiveProp),"expected prop schema as first argument"),invariant(!!t,"expected key property name as second argument");var r={serializer:function(t){invariant(t&&"object"==typeof t,"expected object or Map");var i=isMapLike(t),r=[];if(i)t.forEach(function(t){r.push(e.serializer(t))});else for(var n in t)r.push(e.serializer(t[n]));return r},deserializer:function(r,n,a,o){list(e,i).deserializer(r,function(e,i){if(e)n(e);else{var a,s=isMapLike(o);s?(o.clear(),a=o):a={};for(var l=0,c=r.length;l<c;l++)s?a.set(i[l][t],i[l]):a[i[l][t].toString()]=i[l];n(null,a)}},a)}};return r=processAdditionalPropArgs(r,i)}function raw(e){var t={serializer:function(e){return e},deserializer:function(e,t){t(null,e)}};return t=processAdditionalPropArgs(t,e)}Context.prototype.createCallback=function(e){return this.pendingCallbacks++,once(function(t,i){t?this.hasError||(this.hasError=!0,this.onReadyCb(t),rootContextCache.delete(this)):this.hasError||(e(i),--this.pendingCallbacks===this.pendingRefsCount&&(this.pendingRefsCount>0?(this.onReadyCb(new Error('Unresolvable references in json: "'+Object.keys(this.pendingRefs).filter(function(e){return this.pendingRefs[e].length>0},this).join('", "')+'"')),rootContextCache.delete(this)):(this.onReadyCb(null,this.target),rootContextCache.delete(this))))}.bind(this))},Context.prototype.await=function(e,t,i){if(invariant(this.isRoot),t in this.resolvedRefs){var r=this.resolvedRefs[t].filter(function(t){return isAssignableTo(t.modelSchema,e)})[0];if(r)return void i(null,r.value)}this.pendingRefsCount++,this.pendingRefs[t]||(this.pendingRefs[t]=[]),this.pendingRefs[t].push({modelSchema:e,uuid:t,callback:i})},Context.prototype.resolve=function(e,t,i){if(invariant(this.isRoot),this.resolvedRefs[t]||(this.resolvedRefs[t]=[]),this.resolvedRefs[t].push({modelSchema:e,value:i}),t in this.pendingRefs)for(var r=this.pendingRefs[t].length-1;r>=0;r--){var n=this.pendingRefs[t][r];isAssignableTo(e,n.modelSchema)&&(this.pendingRefs[t].splice(r,1),this.pendingRefsCount--,n.callback(null,i))}},Context.prototype.setTarget=function(e){this.isRoot&&this.target&&rootContextCache.delete(this.target),this.target=e,rootContextCache.set(this.target,this)},Context.prototype.cancelAwaits=function(){invariant(this.isRoot);var e=this;Object.keys(this.pendingRefs).forEach(function(t){e.pendingRefs[t].forEach(function(i){e.pendingRefsCount--,i.callback(new Error("Reference resolution canceled for "+t))})}),this.pendingRefs={},this.pendingRefsCount=0};export{createSimpleSchema,createModelSchema,getDefaultModelSchema,setDefaultModelSchema,serializable,serialize,serializeAll,cancelDeserialize,deserialize,update,primitive,identifier,date,alias,custom,object,object as child,optional,reference,reference as ref,list,map,mapAsArray,raw,SKIP};