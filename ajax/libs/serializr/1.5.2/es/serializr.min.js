function createSimpleSchema(e){return{factory:function(){return{}},props:e}}var formatters={j:function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}};function invariant(e,i){if(!e){var t=Array.prototype.slice.call(arguments,2),r=[],n=0,a=i.replace(/%([a-zA-Z%])/g,function(e,i){if("%%"===e)return e;var a=formatters[i];if("function"==typeof a){var o=t[n++];return r.push(o),a(o)}return e});throw console&&r.length>0&&console.log.apply(console,r),new Error("[serializr] "+(a||"Illegal State"))}}function GUARDED_NOOP(e){if(e)throw new Error(e)}function once(e){var i=!1;return function(){if(!i)return i=!0,e.apply(null,arguments);invariant(!1,"callback was invoked twice")}}function parallel(e,i,t){if(0!==e.length){var r=e.filter(function(){return!0}).length,n=[],a=!1;e.forEach(function(e,o){i(e,function(e,i,o){i?a||(a=!0,t(i)):(n[e]=o,0==--r&&t(null,n))}.bind(null,o),o)})}else t(null,[])}function isPrimitive(e){return null===e||"object"!=typeof e&&"function"!=typeof e}function isModelSchema(e){return e&&e.factory&&e.props}function isPropSchema(e){return e&&e.serializer&&e.deserializer}function isAliasedPropSchema(e){return"object"==typeof e&&!!e.jsonname}function isIdentifierPropSchema(e){return"object"==typeof e&&!0===e.identifier}function isAssignableTo(e,i){for(;e;){if(e===i)return!0;e=e.extends}return!1}function isMapLike(e){return e&&"function"==typeof e.keys&&"function"==typeof e.clear}function getIdentifierProp(e){for(invariant(isModelSchema(e));e;){for(var i in e.props)if("object"==typeof e.props[i]&&!0===e.props[i].identifier)return i;e=e.extends}return null}function processAdditionalPropArgs(e,i){if(i){invariant(isPropSchema(e),"expected a propSchema");["beforeDeserialize","afterDeserialize"].forEach(function(t){"function"==typeof i[t]&&(e[t]=i[t])})}return e}function getDefaultModelSchema(e){return e?isModelSchema(e)?e:isModelSchema(e.serializeInfo)?e.serializeInfo:e.constructor&&e.constructor.serializeInfo?e.constructor.serializeInfo:void 0:null}function setDefaultModelSchema(e,i){return invariant(isModelSchema(i)),e.serializeInfo=i}function createModelSchema(e,i,t){invariant(e!==Object,"one cannot simply put define a model schema for Object"),invariant("function"==typeof e,"expected constructor function");var r={targetClass:e,factory:t||function(){return new e},props:i};if(e.prototype.constructor!==Object){var n=getDefaultModelSchema(e.prototype.constructor);n&&n.targetClass!==e&&(r.extends=n)}return setDefaultModelSchema(e,r),r}function primitive(e){var i={serializer:function(e){return invariant(isPrimitive(e),"this value is not primitive: "+e),e},deserializer:function(e,i){isPrimitive(e)?i(null,e):i("[serializr] this value is not primitive: "+e)}};return i=processAdditionalPropArgs(i,e)}var SKIP="undefined"!=typeof Symbol?Symbol("SKIP"):{SKIP:!0},_defaultPrimitiveProp=primitive(),STRIP_COMMENTS=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,ARGUMENT_NAMES=/([^\s,]+)/g;function getParamNames(e){var i=e.toString().replace(STRIP_COMMENTS,""),t=i.slice(i.indexOf("(")+1,i.indexOf(")")).match(ARGUMENT_NAMES);return null===t&&(t=[]),t}function serializableDecorator(e,i,t,r){var n;if(invariant(arguments.length>=2,"too few arguments. Please use @serializable as property decorator"),void 0===t&&"function"==typeof i&&i.prototype&&void 0!==r&&"number"==typeof r){invariant(isPropSchema(e),"Constructor params must use alias(name)"),invariant(e.jsonname,"Constructor params must use alias(name)");var a=getParamNames(i);a.length>=r&&(t=a[r],e.paramNumber=r,r=void 0,i=i.prototype,n=function(e){for(var t=[],r=0;r<i.constructor.length;r++)Object.keys(e.modelSchema.props).forEach(function(i){var n=e.modelSchema.props[i];n.paramNumber===r&&(t[r]=e.json[n.jsonname])});return new(Function.prototype.bind.apply(i.constructor,[null].concat(t)))})}invariant("string"==typeof t,"incorrect usage of @serializable decorator");var o=getDefaultModelSchema(i);return o&&i.constructor.hasOwnProperty("serializeInfo")||(o=createModelSchema(i.constructor,{},n)),o&&o.targetClass!==i.constructor&&(o=createModelSchema(i.constructor,{},n)),o.props[t]=e,!r||r.get||r.set||(r.writable=!0),r}function serializable(e,i,t){if(1===arguments.length){var r=!0===e?_defaultPrimitiveProp:e;return invariant(isPropSchema(r),"@serializable expects prop schema"),serializableDecorator.bind(null,r)}return serializableDecorator(primitive(),e,i,t)}function serialize(e,i){invariant(1===arguments.length||2===arguments.length,"serialize expects one or 2 arguments");var t=1===arguments.length?e:i,r=1===arguments.length?null:e;if(Array.isArray(t)){if(0===t.length)return[];r||(r=getDefaultModelSchema(t[0]))}else r||(r=getDefaultModelSchema(t));return invariant(!!r,"Failed to find default schema for "+e),Array.isArray(t)?t.map(function(e){return serializeWithSchema(r,e)}):serializeWithSchema(r,t)}function serializeWithSchema(e,i){var t;return invariant(e&&"object"==typeof e,"Expected schema"),invariant(i&&"object"==typeof i,"Expected object"),t=e.extends?serializeWithSchema(e.extends,i):{},Object.keys(e.props).forEach(function(r){var n=e.props[r];if("*"===r)return invariant(!0===n,"prop schema '*' can only be used with 'true'"),void serializeStarProps(e,i,t);if(!0===n&&(n=_defaultPrimitiveProp),!1!==n){var a=n.serializer(i[r],r,i);a!==SKIP&&(t[n.jsonname||r]=a)}}),t}function serializeStarProps(e,i,t){for(var r in i)if(i.hasOwnProperty(r)&&!(r in e.props)){var n=i[r];isPrimitive(n)&&(t[r]=n)}}function serializeAll(e){invariant(1===arguments.length&&"function"==typeof e,"@serializeAll can only be used as class decorator");var i=getDefaultModelSchema(e);return i&&e.hasOwnProperty("serializeInfo")||setDefaultModelSchema(e,i=createModelSchema(e,{})),getDefaultModelSchema(e).props["*"]=!0,e}var rootContextCache=new WeakMap;function Context(e,i,t,r,n){this.parentContext=e,this.isRoot=!e,this.pendingCallbacks=0,this.pendingRefsCount=0,this.onReadyCb=r||GUARDED_NOOP,this.json=t,this.target=null,this.hasError=!1,this.modelSchema=i,this.isRoot?(this.rootContext=this,this.args=n,this.pendingRefs={},this.resolvedRefs={}):(this.rootContext=e.rootContext,this.args=e.args)}function getTargetContext(e){return rootContextCache.get(e)}function cancelDeserialize(e){invariant("object"==typeof e&&e&&!Array.isArray(e),"cancelDeserialize needs an object");var i=getTargetContext(e);i&&i.cancelAwaits()}function schemaHasAlias(e,i){for(var t in e.props)if("object"==typeof e.props[t]&&e.props[t].jsonname===i)return!0;return!1}function deserializeStarProps(e,i,t){for(var r in t)if(!(r in e.props||schemaHasAlias(e,r))){var n=t[r];invariant(isPrimitive(n),"encountered non primitive value while deserializing '*' properties in property '"+r+"': "+n),i[r]=n}}function deserialize(e,i,t,r){if(invariant(arguments.length>=2,"deserialize expects at least 2 arguments"),invariant(isModelSchema(e=getDefaultModelSchema(e)),"first argument should be model schema"),Array.isArray(i)){var n=[];return parallel(i,function(i,t){var a=deserializeObjectWithSchema(null,e,i,t,r);n.push(a)},t||GUARDED_NOOP),n}return deserializeObjectWithSchema(null,e,i,t,r)}function deserializeObjectWithSchema(e,i,t,r,n){if(null!=t&&"object"==typeof t){var a=new Context(e,i,t,r,n),o=i.factory(a);invariant(!!o,"No object returned from factory"),a.setTarget(o);var s=a.createCallback(GUARDED_NOOP);return deserializePropsWithSchema(a,i,t,o),s(),o}r(null,null)}function deserializePropsWithSchema(e,i,t,r){i.extends&&deserializePropsWithSchema(e,i.extends,t,r),Object.keys(i.props).forEach(function(n){var a=i.props[n];if("*"===n)return invariant(!0===a,"prop schema '*' can only be used with 'true'"),void deserializeStarProps(i,r,t);if(!0===a&&(a=_defaultPrimitiveProp),!1!==a){var o=a.jsonname||n;onBeforeDeserialize(function(i,o){i||void 0===o||function(i,n,a){i.deserializer(n,function o(s){return function(l,c){onAfterDeserialize(function(t,n){t&&void 0!==n&&"function"==typeof i.afterDeserialize?i.deserializer(n,o(s),e,r[a]):s(t,n)},l,c,n,t,a,e,i)}}(e.rootContext.createCallback(function(e){e!==SKIP&&(r[a]=e)})),e,r[a])}(a,o,n)},t[o],t,o,e,a)}})}function onBeforeDeserialize(e,i,t,r,n,a){a&&"function"==typeof a.beforeDeserialize?a.beforeDeserialize(e,i,t,r,n,a):e(null,i)}function onAfterDeserialize(e,i,t,r,n,a,o,s){s&&"function"==typeof s.afterDeserialize?s.afterDeserialize(e,i,t,r,n,a,o,s):e(i,t)}function update(e,i,t,r,n){2===arguments.length||"function"==typeof arguments[2]?(e=getDefaultModelSchema(i=arguments[0]),t=arguments[1],r=arguments[2],n=arguments[3]):e=getDefaultModelSchema(e),invariant(isModelSchema(e),"update failed to determine schema"),invariant("object"==typeof i&&i&&!Array.isArray(i),"update needs an object");var a=new Context(null,e,t,r,n);a.setTarget(i);var o=a.createCallback(GUARDED_NOOP),s=deserializePropsWithSchema(a,e,t,i);return o(),s}function defaultRegisterFunction(e,i,t){t.rootContext.resolve(t.modelSchema,e,t.target)}function identifier(e,i){var t,r;"function"==typeof e?(t=e,r=i):r=e,invariant(!r||"object"==typeof r,"Additional property arguments should be an object, register function should be omitted or a funtion");var n={identifier:!0,serializer:_defaultPrimitiveProp.serializer,deserializer:function(e,i,r){_defaultPrimitiveProp.deserializer(e,function(e,n){defaultRegisterFunction(n,r.target,r),t&&t(n,r.target,r),i(e,n)})}};return n=processAdditionalPropArgs(n,r)}function date(e){var i={serializer:function(e){return null==e?e:(invariant(e instanceof Date,"Expected Date object"),e.getTime())},deserializer:function(e,i){i(null,null!=e?new Date(e):e)}};return i=processAdditionalPropArgs(i,e)}function alias(e,i){return invariant(e&&"string"==typeof e,"expected prop name as first argument"),invariant(isPropSchema(i=i&&!0!==i?i:_defaultPrimitiveProp),"expected prop schema as second argument"),invariant(!isAliasedPropSchema(i),"provided prop is already aliased"),{jsonname:e,serializer:i.serializer,deserializer:i.deserializer,identifier:isIdentifierPropSchema(i),beforeDeserialize:i.beforeDeserialize,afterDeserialize:i.afterDeserialize}}function custom(e,i,t){invariant("function"==typeof e,"first argument should be function"),invariant("function"==typeof i,"second argument should be a function or promise");var r={serializer:e,deserializer:function(e,r,n,a){4===i.length?i(e,n,a,r,t):r(null,i(e,n,a,null,t))}};return r=processAdditionalPropArgs(r,t)}function object(e,i){invariant("object"==typeof e||"function"==typeof e,"No modelschema provided. If you are importing it from another file be aware of circular dependencies.");var t={serializer:function(i){return invariant(isModelSchema(e=getDefaultModelSchema(e)),"expected modelSchema, got "+e),null==i?i:serialize(e,i)},deserializer:function(t,r,n){invariant(isModelSchema(e=getDefaultModelSchema(e)),"expected modelSchema, got "+e),null!=t?deserializeObjectWithSchema(n,e,t,r,i):r(null,t)}};return t=processAdditionalPropArgs(t,i)}function createDefaultRefLookup(e){return function(i,t,r){r.rootContext.await(e,i,t)}}function reference(e,i,t){invariant(!!e,"No modelschema provided. If you are importing it from another file be aware of circular dependencies.");var r,n=!1;function a(){if(n=!0,invariant("string"!=typeof e||i&&"function"==typeof i,"if the reference target is specified by attribute name, a lookup function is required"),invariant(!i||"function"==typeof i,"second argument should be a lookup function or additional arguments object"),"string"==typeof e)r=e;else{var t=getDefaultModelSchema(e);invariant(isModelSchema(t),"expected model schema or string as first argument for 'ref', got "+t),i=i||createDefaultRefLookup(t),invariant(!!(r=getIdentifierProp(t)),"provided model schema doesn't define an identifier() property and cannot be used by 'ref'.")}}"object"==typeof i&&void 0===t&&(t=i,i=void 0);var o={serializer:function(e){return n||a(),e?e[r]:null},deserializer:function(e,t,r){n||a(),null==e?t(null,e):i(e,t,r)}};return o=processAdditionalPropArgs(o,t)}function list(e,i){invariant(isPropSchema(e=e||_defaultPrimitiveProp),"expected prop schema as first argument"),invariant(!isAliasedPropSchema(e),"provided prop is aliased, please put aliases first");var t={serializer:function(i){return void 0===i?SKIP:(invariant(i&&"length"in i&&"map"in i,"expected array (like) object"),i.map(e.serializer))},deserializer:function(i,t,r){Array.isArray(i)?parallel(i,function(t,n,a){function o(i,o){"function"==typeof e.afterDeserialize?onAfterDeserialize(s,i,o,t,a,r,e):n(i,o)}function s(i,t){i&&void 0!==t&&"function"==typeof e.afterDeserialize?e.deserializer(t,o,r):n(i,t)}onBeforeDeserialize(function(i,t){i?n(i):e.deserializer(t,o,r)},t,i,a,r,e)},t):t("[serializr] expected JSON array")}};return t=processAdditionalPropArgs(t,i)}function map(e,i){invariant(isPropSchema(e=e||_defaultPrimitiveProp),"expected prop schema as first argument"),invariant(!isAliasedPropSchema(e),"provided prop is aliased, please put aliases first");var t={serializer:function(i){invariant(i&&"object"==typeof i,"expected object or Map");var t=isMapLike(i),r={};if(t)i.forEach(function(i,t){r[t]=e.serializer(i)});else for(var n in i)r[n]=e.serializer(i[n]);return r},deserializer:function(t,r,n,a){if(t&&"object"==typeof t){var o=Object.keys(t);list(e,i).deserializer(o.map(function(e){return t[e]}),function(e,i){if(e)r(e);else{var t,n=isMapLike(a);n?(a.clear(),t=a):t={};for(var s=0,l=o.length;s<l;s++)n?t.set(o[s],i[s]):t[o[s]]=i[s];r(null,t)}},n)}else r("[serializr] expected JSON object")}};return t=processAdditionalPropArgs(t,i)}function mapAsArray(e,i,t){invariant(isPropSchema(e=e||_defaultPrimitiveProp),"expected prop schema as first argument"),invariant(!!i,"expected key property name as second argument");var r={serializer:function(i){invariant(i&&"object"==typeof i,"expected object or Map");var t=isMapLike(i),r=[];if(t)i.forEach(function(i){r.push(e.serializer(i))});else for(var n in i)r.push(e.serializer(i[n]));return r},deserializer:function(r,n,a,o){list(e,t).deserializer(r,function(e,t){if(e)n(e);else{var a,s=isMapLike(o);s?(o.clear(),a=o):a={};for(var l=0,c=r.length;l<c;l++)s?a.set(t[l][i],t[l]):a[t[l][i].toString()]=t[l];n(null,a)}},a)}};return r=processAdditionalPropArgs(r,t)}function raw(e){var i={serializer:function(e){return e},deserializer:function(e,i){i(null,e)}};return i=processAdditionalPropArgs(i,e)}Context.prototype.createCallback=function(e){return this.pendingCallbacks++,once(function(i,t){i?this.hasError||(this.hasError=!0,this.onReadyCb(i),rootContextCache.delete(this)):this.hasError||(e(t),--this.pendingCallbacks===this.pendingRefsCount&&(this.pendingRefsCount>0?(this.onReadyCb(new Error('Unresolvable references in json: "'+Object.keys(this.pendingRefs).filter(function(e){return this.pendingRefs[e].length>0},this).join('", "')+'"')),rootContextCache.delete(this)):(this.onReadyCb(null,this.target),rootContextCache.delete(this))))}.bind(this))},Context.prototype.await=function(e,i,t){if(invariant(this.isRoot),i in this.resolvedRefs){var r=this.resolvedRefs[i].filter(function(i){return isAssignableTo(i.modelSchema,e)})[0];if(r)return void t(null,r.value)}this.pendingRefsCount++,this.pendingRefs[i]||(this.pendingRefs[i]=[]),this.pendingRefs[i].push({modelSchema:e,uuid:i,callback:t})},Context.prototype.resolve=function(e,i,t){if(invariant(this.isRoot),this.resolvedRefs[i]||(this.resolvedRefs[i]=[]),this.resolvedRefs[i].push({modelSchema:e,value:t}),i in this.pendingRefs)for(var r=this.pendingRefs[i].length-1;r>=0;r--){var n=this.pendingRefs[i][r];isAssignableTo(e,n.modelSchema)&&(this.pendingRefs[i].splice(r,1),this.pendingRefsCount--,n.callback(null,t))}},Context.prototype.setTarget=function(e){this.isRoot&&this.target&&rootContextCache.delete(this.target),this.target=e,rootContextCache.set(this.target,this)},Context.prototype.cancelAwaits=function(){invariant(this.isRoot);var e=this;Object.keys(this.pendingRefs).forEach(function(i){e.pendingRefs[i].forEach(function(t){e.pendingRefsCount--,t.callback(new Error("Reference resolution canceled for "+i))})}),this.pendingRefs={},this.pendingRefsCount=0};export{createSimpleSchema,createModelSchema,getDefaultModelSchema,setDefaultModelSchema,serializable,serialize,serializeAll,cancelDeserialize,deserialize,update,primitive,identifier,date,alias,custom,object,object as child,reference,reference as ref,list,map,mapAsArray,raw,SKIP};