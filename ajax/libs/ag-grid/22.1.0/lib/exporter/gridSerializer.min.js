"use strict";var __decorate=this&&this.__decorate||function(e,o,r,t){var n,i=arguments.length,l=i<3?o:null===t?t=Object.getOwnPropertyDescriptor(o,r):t;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,o,r,t);else for(var a=e.length-1;0<=a;a--)(n=e[a])&&(l=(i<3?n(l):3<i?n(o,r,l):n(o,r))||l);return 3<i&&l&&Object.defineProperty(o,r,l),l},__metadata=this&&this.__metadata||function(e,o){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,o)};Object.defineProperty(exports,"__esModule",{value:!0});var context_1=require("../context/context"),columnController_1=require("../columnController/columnController"),constants_1=require("../constants"),selectionController_1=require("../selectionController"),gridOptionsWrapper_1=require("../gridOptionsWrapper"),displayedGroupCreator_1=require("../columnController/displayedGroupCreator"),columnFactory_1=require("../columnController/columnFactory"),groupInstanceIdCreator_1=require("../columnController/groupInstanceIdCreator"),columnGroup_1=require("../entities/columnGroup"),pinnedRowModel_1=require("../rowModels/pinnedRowModel"),utils_1=require("../utils"),BaseGridSerializingSession=function(){function e(e){var o=e.columnController,r=e.valueService,t=e.gridOptionsWrapper,n=e.processCellCallback,i=e.processHeaderCallback,l=e.cellAndHeaderEscaper;this.columnController=o,this.valueService=r,this.gridOptionsWrapper=t,this.processCellCallback=n,this.processHeaderCallback=i,this.cellAndHeaderEscaper=l}return e.prototype.extractHeaderValue=function(e){var o=this.getHeaderName(this.processHeaderCallback,e);return null==o&&(o=""),this.cellAndHeaderEscaper?this.cellAndHeaderEscaper(o):o},e.prototype.extractRowCellValue=function(e,o,r,t){var n,i=0<this.columnController.getRowGroupColumns().length;return n=t&&t.group&&i&&0===o?this.createValueForGroupNode(t):this.valueService.getValue(e,t),null==(n=this.processCell(t,e,n,this.processCellCallback,r))&&(n=""),this.cellAndHeaderEscaper?this.cellAndHeaderEscaper(n):n},e.prototype.getHeaderName=function(e,o){return e?e({column:o,api:this.gridOptionsWrapper.getApi(),columnApi:this.gridOptionsWrapper.getColumnApi(),context:this.gridOptionsWrapper.getContext()}):this.columnController.getDisplayNameForColumn(o,"csv",!0)},e.prototype.createValueForGroupNode=function(e){for(var o=[e.key];e.parent;)e=e.parent,o.push(e.key);return o.reverse().join(" -> ")},e.prototype.processCell=function(e,o,r,t,n){return t?t({column:o,node:e,value:r,api:this.gridOptionsWrapper.getApi(),columnApi:this.gridOptionsWrapper.getColumnApi(),context:this.gridOptionsWrapper.getContext(),type:n}):r},e}();exports.BaseGridSerializingSession=BaseGridSerializingSession;var RowType,GridSerializer=function(){function e(){}return e.prototype.serialize=function(n,e){var i=e&&e.skipGroups,o=e&&e.skipHeader,r=e&&e.columnGroups,l=e&&e.skipFooters,a=e&&e.skipPinnedTop,p=e&&e.skipPinnedBottom,t=e&&e.customHeader,s=e&&e.customFooter,d=e&&e.allColumns,c=e&&e.onlySelected,u=e&&e.columnKeys,C=e&&e.onlySelectedAllPages,h=e&&e.shouldRowBeSkipped||function(){return!1},_=this.gridOptionsWrapper.getApi(),m=this.gridOptionsWrapper.isGroupRemoveSingleChildren(),g=this.gridOptionsWrapper.isGroupRemoveLowestSingleChildren(),f=this.gridOptionsWrapper.getContext(),y=this.columnController.isPivotMode(),v=this.rowModel.getType()===constants_1.Constants.ROW_MODEL_TYPE_CLIENT_SIDE,w=!v&&c,G=[];if(G=utils_1._.existsAndNotEmpty(u)?this.columnController.getGridColumns(u):d&&!y?(G=this.gridOptionsWrapper.isTreeData()?this.columnController.getGridColumns([constants_1.Constants.GROUP_AUTO_COLUMN_ID]):[]).concat(this.columnController.getAllPrimaryColumns()||[]):this.columnController.getAllDisplayedColumns(),t&&n.addCustomHeader(t),n.prepare(G),r){var A=new groupInstanceIdCreator_1.GroupInstanceIdCreator,R=this.displayedGroupCreator.createDisplayedGroups(G,this.columnController.getGridBalancedTree(),A,null);this.recursivelyAddHeaderGroups(R,n)}if(!o){var O=n.onNewHeaderRow();G.forEach(function(e,o){O.onColumn(e,o,void 0)})}(this.pinnedRowModel.forEachPinnedTopRow(E),y)?this.rowModel.forEachPivotNode?this.rowModel.forEachPivotNode(E):this.rowModel.forEachNode(E):C||w?this.selectionController.getSelectedNodes().forEach(function(e){E(e)}):v?this.rowModel.forEachNodeAfterFilterAndSort(E):this.rowModel.forEachNode(E);function E(r){var e=g&&r.leafGroup,o=1===r.allChildrenCount&&(m||e);if((!r.group||!i&&!o)&&((!l||!r.footer)&&(!c||r.isSelected())&&(!a||"top"!==r.rowPinned)&&(!p||"bottom"!==r.rowPinned)&&(!(-1===r.level)||r.leafGroup)&&!h({node:r,api:_,context:f}))){var t=n.onNewBodyRow();G.forEach(function(e,o){t.onColumn(e,o,r)})}}return this.pinnedRowModel.forEachPinnedBottomRow(E),s&&n.addCustomFooter(s),n.parse()},e.prototype.recursivelyAddHeaderGroups=function(e,o){var r=[];e.forEach(function(e){e.getChildren&&e.getChildren().forEach(function(e){return r.push(e)})}),0<e.length&&e[0]instanceof columnGroup_1.ColumnGroup&&this.doAddHeaderHeader(o,e),r&&0<r.length&&this.recursivelyAddHeaderGroups(r,o)},e.prototype.doAddHeaderHeader=function(e,o){var t=this,n=e.onNewHeaderGroupingRow(),i=0;o.forEach(function(e){var o=e,r=t.columnController.getDisplayNameForColumnGroup(o,"header");n.onColumn(r||"",i++,o.getLeafColumns().length-1)})},__decorate([context_1.Autowired("displayedGroupCreator"),__metadata("design:type",displayedGroupCreator_1.DisplayedGroupCreator)],e.prototype,"displayedGroupCreator",void 0),__decorate([context_1.Autowired("columnController"),__metadata("design:type",columnController_1.ColumnController)],e.prototype,"columnController",void 0),__decorate([context_1.Autowired("rowModel"),__metadata("design:type",Object)],e.prototype,"rowModel",void 0),__decorate([context_1.Autowired("pinnedRowModel"),__metadata("design:type",pinnedRowModel_1.PinnedRowModel)],e.prototype,"pinnedRowModel",void 0),__decorate([context_1.Autowired("selectionController"),__metadata("design:type",selectionController_1.SelectionController)],e.prototype,"selectionController",void 0),__decorate([context_1.Autowired("columnFactory"),__metadata("design:type",columnFactory_1.ColumnFactory)],e.prototype,"columnFactory",void 0),__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),e=__decorate([context_1.Bean("gridSerializer")],e)}();exports.GridSerializer=GridSerializer,function(e){e[e.HEADER_GROUPING=0]="HEADER_GROUPING",e[e.HEADER=1]="HEADER",e[e.BODY=2]="BODY"}(RowType=exports.RowType||(exports.RowType={}));