"use strict";var __decorate=this&&this.__decorate||function(e,o,r,t){var n,i=arguments.length,a=i<3?o:null===t?t=Object.getOwnPropertyDescriptor(o,r):t;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,o,r,t);else for(var u=e.length-1;0<=u;u--)(n=e[u])&&(a=(i<3?n(a):3<i?n(o,r,a):n(o,r))||a);return 3<i&&a&&Object.defineProperty(o,r,a),a},__metadata=this&&this.__metadata||function(e,o){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,o)},__param=this&&this.__param||function(r,t){return function(e,o){t(e,o,r)}};Object.defineProperty(exports,"__esModule",{value:!0});var gridOptionsWrapper_1=require("../gridOptionsWrapper"),logger_1=require("../logger"),columnUtils_1=require("./columnUtils"),columnKeyCreator_1=require("./columnKeyCreator"),originalColumnGroup_1=require("../entities/originalColumnGroup"),column_1=require("../entities/column"),context_1=require("../context/context"),defaultColumnTypes_1=require("../entities/defaultColumnTypes"),utils_1=require("../utils"),ColumnFactory=function(){function e(){}return e.prototype.setBeans=function(e){this.logger=e.create("ColumnFactory")},e.prototype.createColumnTree=function(e,o,r){var t=new columnKeyCreator_1.ColumnKeyCreator;if(r){var n=r.map(function(e){return e.getId()});t.addExistingKeys(n)}var i=r?r.slice():null,a=this.recursivelyCreateColumns(e,0,o,i,t,null),u=this.findMaxDept(a,0);this.logger.log("Number of levels for grouped columns is "+u);var l=this.balanceColumnTree(a,0,u,t);return this.columnUtils.depthFirstOriginalTreeSearch(null,l,function(e,o){e instanceof originalColumnGroup_1.OriginalColumnGroup&&e.setupExpandable(),e.setOriginalParent(o)}),{columnTree:l,treeDept:u}},e.prototype.createForAutoGroups=function(e,r){var t=this,n=[];return e.forEach(function(e){var o=t.createAutoGroupTreeItem(r,e);n.push(o)}),n},e.prototype.createAutoGroupTreeItem=function(e,o){for(var r=o,t=this.findDepth(e)-1;0<=t;t--){var n=new originalColumnGroup_1.OriginalColumnGroup(null,"FAKE_PATH_"+o.getId()+"}_"+t,!0,t);this.context.wireBean(n),n.setChildren([r]),r.setOriginalParent(n),r=n}return r},e.prototype.findDepth=function(e){for(var o=0,r=e;r&&r[0]&&r[0]instanceof originalColumnGroup_1.OriginalColumnGroup;)o++,r=r[0].getChildren();return o},e.prototype.balanceColumnTree=function(e,o,r,t){for(var n=[],i=0;i<e.length;i++){var a=e[i];if(a instanceof originalColumnGroup_1.OriginalColumnGroup){var u=a,l=this.balanceColumnTree(u.getChildren(),o+1,r,t);u.setChildren(l),n.push(u)}else{for(var s=void 0,p=void 0,c=r-1;o<=c;c--){var d=t.getUniqueKey(null,null),g=this.createMergedColGroupDef(null),f=new originalColumnGroup_1.OriginalColumnGroup(g,d,!0,o);this.context.wireBean(f),p&&p.setChildren([f]),p=f,s=s||p}if(s){if(n.push(s),e.some(function(e){return e instanceof originalColumnGroup_1.OriginalColumnGroup})){p.setChildren([a]);continue}p.setChildren(e);break}n.push(a)}}return n},e.prototype.findMaxDept=function(e,o){for(var r=o,t=0;t<e.length;t++){var n=e[t];if(n instanceof originalColumnGroup_1.OriginalColumnGroup){var i=n,a=this.findMaxDept(i.getChildren(),o+1);r<a&&(r=a)}}return r},e.prototype.recursivelyCreateColumns=function(e,r,t,n,i,a){var u=this,l=[];return e&&e.forEach(function(e){var o;o=u.isColumnGroup(e)?u.createColumnGroup(t,e,r,n,i,a):u.createColumn(t,e,n,i,a),l.push(o)}),l},e.prototype.createColumnGroup=function(e,o,r,t,n,i){var a=this.createMergedColGroupDef(o),u=n.getUniqueKey(a.groupId,null),l=new originalColumnGroup_1.OriginalColumnGroup(a,u,!1,r);this.context.wireBean(l);var s=this.recursivelyCreateColumns(a.children,r+1,e,t,n,l);return l.setChildren(s),l},e.prototype.createMergedColGroupDef=function(e){var o={};return utils_1._.assign(o,this.gridOptionsWrapper.getDefaultColGroupDef()),utils_1._.assign(o,e),this.checkForDeprecatedItems(o),o},e.prototype.createColumn=function(e,o,r,t,n){var i=this.mergeColDefs(o);this.checkForDeprecatedItems(i);var a=this.findExistingColumn(o,r);if(a)a.setColDef(i,o);else{var u=t.getUniqueKey(i.colId,i.field);a=new column_1.Column(i,o,u,e),this.context.wireBean(a)}return a},e.prototype.findExistingColumn=function(r,e){var o=utils_1._.find(e,function(e){var o=e.getUserProvidedColDef();return!!o&&(o===r||null!==o.colId&&void 0!==o.colId&&o.colId===r.colId)});return o&&utils_1._.removeFromArray(e,o),o},e.prototype.mergeColDefs=function(e){var o={};return utils_1._.assign(o,this.gridOptionsWrapper.getDefaultColDef()),e.type&&this.assignColumnTypes(e,o),utils_1._.assign(o,e),o},e.prototype.assignColumnTypes=function(e,r){var o;if(e.type instanceof Array){e.type.some(function(e){return"string"!=typeof e})?console.warn("ag-grid: if colDef.type is supplied an array it should be of type 'string[]'"):o=e.type}else{if("string"!=typeof e.type)return void console.warn("ag-grid: colDef.type should be of type 'string' | 'string[]'");o=e.type.split(",")}var t=utils_1._.assign({},this.gridOptionsWrapper.getColumnTypes(),defaultColumnTypes_1.DefaultColumnTypes);o.forEach(function(e){var o=t[e.trim()];o?utils_1._.assign(r,o):console.warn("ag-grid: colDef.type '"+e+"' does not correspond to defined gridOptions.columnTypes")})},e.prototype.checkForDeprecatedItems=function(e){if(e){var o=e;void 0!==o.group&&console.warn("ag-grid: colDef.group is invalid, please check documentation on how to do grouping as it changed in version 3"),void 0!==o.headerGroup&&console.warn("ag-grid: colDef.headerGroup is invalid, please check documentation on how to do grouping as it changed in version 3"),void 0!==o.headerGroupShow&&console.warn("ag-grid: colDef.headerGroupShow is invalid, should be columnGroupShow, please check documentation on how to do grouping as it changed in version 3"),void 0!==o.suppressRowGroup&&console.warn("ag-grid: colDef.suppressRowGroup is deprecated, please use colDef.type instead"),void 0!==o.suppressAggregation&&console.warn("ag-grid: colDef.suppressAggregation is deprecated, please use colDef.type instead"),(o.suppressRowGroup||o.suppressAggregation)&&console.warn("ag-grid: colDef.suppressAggregation and colDef.suppressRowGroup are deprecated, use allowRowGroup, allowPivot and allowValue instead"),o.displayName&&(console.warn("ag-grid: Found displayName "+o.displayName+", please use headerName instead, displayName is deprecated."),o.headerName=o.displayName)}},e.prototype.isColumnGroup=function(e){return void 0!==e.children},__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.Autowired("columnUtils"),__metadata("design:type",columnUtils_1.ColumnUtils)],e.prototype,"columnUtils",void 0),__decorate([context_1.Autowired("context"),__metadata("design:type",context_1.Context)],e.prototype,"context",void 0),__decorate([__param(0,context_1.Qualifier("loggerFactory")),__metadata("design:type",Function),__metadata("design:paramtypes",[logger_1.LoggerFactory]),__metadata("design:returntype",void 0)],e.prototype,"setBeans",null),e=__decorate([context_1.Bean("columnFactory")],e)}();exports.ColumnFactory=ColumnFactory;