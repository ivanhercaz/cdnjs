"use strict";var __decorate=this&&this.__decorate||function(e,t,i,r){var o,a=arguments.length,n=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var l=e.length-1;0<=l;l--)(o=e[l])&&(n=(a<3?o(n):3<a?o(t,i,n):o(t,i))||n);return 3<a&&n&&Object.defineProperty(t,i,n),n},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var gridOptionsWrapper_1=require("../gridOptionsWrapper"),expressionService_1=require("./expressionService"),columnController_1=require("../columnController/columnController"),context_1=require("../context/context"),events_1=require("../events"),eventService_1=require("../eventService"),valueCache_1=require("./valueCache"),utils_1=require("../utils"),ValueService=function(){function e(){this.initialised=!1}return e.prototype.init=function(){this.cellExpressions=this.gridOptionsWrapper.isEnableCellExpressions(),this.initialised=!0},e.prototype.getValue=function(e,t,i,r){if(void 0===i&&(i=!1),void 0===r&&(r=!1),this.initialised||this.init(),t){var o,a=e.getColDef(),n=a.field,l=e.getId(),s=t.data,u=t.groupData&&void 0!==t.groupData[l],p=!r&&t.aggData&&void 0!==t.aggData[l];if(i&&a.filterValueGetter?o=this.executeFilterValueGetter(a.filterValueGetter,s,e,t):this.gridOptionsWrapper.isTreeData()&&p?o=t.aggData[l]:this.gridOptionsWrapper.isTreeData()&&a.valueGetter?o=this.executeValueGetter(a.valueGetter,s,e,t):this.gridOptionsWrapper.isTreeData()&&n&&s?o=utils_1._.getValueUsingField(s,n,e.isFieldContainsDots()):u?o=t.groupData[l]:p?o=t.aggData[l]:a.valueGetter?o=this.executeValueGetter(a.valueGetter,s,e,t):n&&s&&(o=utils_1._.getValueUsingField(s,n,e.isFieldContainsDots())),this.cellExpressions&&"string"==typeof o&&0===o.indexOf("=")){var c=o.substring(1);o=this.executeValueGetter(c,s,e,t)}return o}},e.prototype.setValue=function(e,t,i){var r=this.columnController.getPrimaryColumn(t);if(e&&r){var o=e.data;utils_1._.missing(o)&&(e.data={});var a=r.getColDef(),n=a.field,l=a.newValueHandler,s=a.valueSetter;if(utils_1._.missing(n)&&utils_1._.missing(l)&&utils_1._.missing(s))console.warn("ag-Grid: you need either field or valueSetter set on colDef for editing to work");else{var u,p={node:e,data:e.data,oldValue:this.getValue(r,e),newValue:i,colDef:r.getColDef(),column:r,api:this.gridOptionsWrapper.getApi(),columnApi:this.gridOptionsWrapper.getColumnApi(),context:this.gridOptionsWrapper.getContext()};if(p.newValue=i,void 0===(u=l&&utils_1._.exists(l)?l(p):utils_1._.exists(s)?this.expressionService.evaluate(s,p):this.setValueUsingField(o,n,i,r.isFieldContainsDots()))&&(u=!0),u){e.resetQuickFilterAggregateText(),this.valueCache.onDataChanged(),p.newValue=this.getValue(r,e);var c=r.getColDef().onCellValueChanged;"function"==typeof c&&setTimeout(function(){return c(p)},0);var d={type:events_1.Events.EVENT_CELL_VALUE_CHANGED,event:null,rowIndex:e.rowIndex,rowPinned:e.rowPinned,column:p.column,api:p.api,colDef:p.colDef,columnApi:p.columnApi,context:p.context,data:e.data,node:e,oldValue:p.oldValue,newValue:p.newValue,value:p.newValue};this.eventService.dispatchEvent(d)}}}},e.prototype.setValueUsingField=function(e,t,i,r){if(!t)return!1;if(r)for(var o=t.split("."),a=e;0<o.length&&a;){var n=o.shift();0===o.length?a[n]=i:a=a[n]}else e[t]=i;return!0},e.prototype.executeFilterValueGetter=function(e,t,i,r){var o={data:t,node:r,column:i,colDef:i.getColDef(),api:this.gridOptionsWrapper.getApi(),columnApi:this.gridOptionsWrapper.getColumnApi(),context:this.gridOptionsWrapper.getContext(),getValue:this.getValueCallback.bind(this,r)};return this.expressionService.evaluate(e,o)},e.prototype.executeValueGetter=function(e,t,i,r){var o=i.getId(),a=this.valueCache.getValue(r,o);if(void 0!==a)return a;var n={data:t,node:r,column:i,colDef:i.getColDef(),api:this.gridOptionsWrapper.getApi(),columnApi:this.gridOptionsWrapper.getColumnApi(),context:this.gridOptionsWrapper.getContext(),getValue:this.getValueCallback.bind(this,r)},l=this.expressionService.evaluate(e,n);return this.valueCache.setValue(r,o,l),l},e.prototype.getValueCallback=function(e,t){var i=this.columnController.getPrimaryColumn(t);return i?this.getValue(i,e):null},e.prototype.getKeyForNode=function(e,t){var i=this.getValue(e,t),r=e.getColDef().keyCreator,o=r?r({value:i}):i;return"string"==typeof o||null==o||"[object Object]"===(o=String(o))&&utils_1._.doOnce(function(){console.warn("ag-Grid: a column you are grouping or pivoting by has objects as values. If you want to group by complex objects then either a) use a colDef.keyCreator (se ag-Grid docs) or b) to toString() on the object to return a key")},"getKeyForNode - warn about [object,object]"),o},__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.Autowired("expressionService"),__metadata("design:type",expressionService_1.ExpressionService)],e.prototype,"expressionService",void 0),__decorate([context_1.Autowired("columnController"),__metadata("design:type",columnController_1.ColumnController)],e.prototype,"columnController",void 0),__decorate([context_1.Autowired("eventService"),__metadata("design:type",eventService_1.EventService)],e.prototype,"eventService",void 0),__decorate([context_1.Autowired("valueCache"),__metadata("design:type",valueCache_1.ValueCache)],e.prototype,"valueCache",void 0),__decorate([context_1.PostConstruct,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],e.prototype,"init",null),e=__decorate([context_1.Bean("valueService")],e)}();exports.ValueService=ValueService;