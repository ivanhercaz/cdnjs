"use strict";var __decorate=this&&this.__decorate||function(e,t,n,o){var i,p=arguments.length,r=p<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,n,o);else for(var u=e.length-1;0<=u;u--)(i=e[u])&&(r=(p<3?i(r):3<p?i(t,n,r):i(t,n))||r);return 3<p&&r&&Object.defineProperty(t,n,r),r},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var constants_1=require("../constants"),context_1=require("../context/context"),gridOptionsWrapper_1=require("../gridOptionsWrapper"),environment_1=require("../environment"),eventService_1=require("../eventService"),events_1=require("../events"),utils_1=require("../utils"),PopupService=function(){function e(){this.popupList=[]}return e.prototype.registerGridCore=function(e){this.gridCore=e},e.prototype.getDocument=function(){return this.gridOptionsWrapper.getDocument()},e.prototype.getPopupParent=function(){var e=this.gridOptionsWrapper.getPopupParent();return e||this.gridCore.getRootGui()},e.prototype.positionPopupForMenu=function(e){var t,n=e.eventSource.getBoundingClientRect(),o=this.getDocument(),i=this.getPopupParent();t=i===o.body?o.documentElement.getBoundingClientRect():i.getBoundingClientRect();var p=n.top-t.top;p=this.keepYWithinBounds(e,p);var r=0<e.ePopup.clientWidth?e.ePopup.clientWidth:200;e.ePopup.style.minWidth=r+"px";var u,s=t.right-t.left-r;function a(){return n.right-t.left-2}function d(){return n.left-t.left-r}this.gridOptionsWrapper.isEnableRtl()?((u=d())<0&&(u=a()),s<u&&(u=0)):(s<(u=a())&&(u=d()),u<0&&(u=0)),e.ePopup.style.left=u+"px",e.ePopup.style.top=p+"px"},e.prototype.positionPopupUnderMouseEvent=function(e){var t=this.calculatePointerAlign(e.mouseEvent),n=t.x,o=t.y,i=e.ePopup,p=e.nudgeX,r=e.nudgeY;this.positionPopup({ePopup:i,x:n,y:o,nudgeX:p,nudgeY:r,keepWithinBounds:!0}),this.callPostProcessPopup(e.ePopup,null,e.mouseEvent,e.type,e.column,e.rowNode)},e.prototype.calculatePointerAlign=function(e){var t=this.getDocument(),n=this.getPopupParent(),o=n.getBoundingClientRect(),i=t.documentElement.getBoundingClientRect();return{x:e.clientX-(n===t.body?i.left:o.left),y:e.clientY-(n===t.body?i.top:o.top)}},e.prototype.positionPopupUnderComponent=function(e){var t,n=e.eventSource.getBoundingClientRect(),o=this.getDocument(),i=this.getPopupParent(),p=e.alignSide||"left";t=i===o.body?o.documentElement.getBoundingClientRect():i.getBoundingClientRect();var r=n.left-t.left;"right"===p&&(r-=e.ePopup.offsetWidth-n.width),this.positionPopup({ePopup:e.ePopup,minWidth:e.minWidth,minHeight:e.minHeight,nudgeX:e.nudgeX,nudgeY:e.nudgeY,x:r,y:n.top-t.top+n.height,keepWithinBounds:e.keepWithinBounds}),this.callPostProcessPopup(e.ePopup,e.eventSource,null,e.type,e.column,e.rowNode)},e.prototype.positionPopupOverComponent=function(e){var t,n=e.eventSource.getBoundingClientRect(),o=this.getDocument(),i=this.getPopupParent();t=i===o.body?o.documentElement.getBoundingClientRect():i.getBoundingClientRect(),this.positionPopup({ePopup:e.ePopup,minWidth:e.minWidth,nudgeX:e.nudgeX,nudgeY:e.nudgeY,x:n.left-t.left,y:n.top-t.top,keepWithinBounds:e.keepWithinBounds}),this.callPostProcessPopup(e.ePopup,e.eventSource,null,e.type,e.column,e.rowNode)},e.prototype.callPostProcessPopup=function(e,t,n,o,i,p){var r=this.gridOptionsWrapper.getPostProcessPopupFunc();r&&r({column:i,rowNode:p,ePopup:e,type:o,eventSource:t,mouseEvent:n})},e.prototype.positionPopup=function(e){var t=e.x,n=e.y;e.nudgeX&&(t+=e.nudgeX),e.nudgeY&&(n+=e.nudgeY),e.keepWithinBounds&&(t=this.keepXWithinBounds(e,t),n=this.keepYWithinBounds(e,n)),e.ePopup.style.left=t+"px",e.ePopup.style.top=n+"px"},e.prototype.keepYWithinBounds=function(e,t){var n=this.gridOptionsWrapper.getDocument(),o=n.documentElement,i=this.getPopupParent(),p=i.getBoundingClientRect(),r=n.documentElement.getBoundingClientRect(),u=i===n.body,s=Math.min(200,p.height),a=0;e.minHeight&&e.minHeight<s?s=e.minHeight:0<e.ePopup.offsetHeight&&(s=e.ePopup.clientHeight,a=utils_1._.getAbsoluteHeight(e.ePopup)-s);var d=u?utils_1._.getAbsoluteHeight(o)+o.scrollTop:p.height;u&&(d-=Math.abs(r.top-p.top));var l=d-s-a-3;return Math.min(Math.max(t,0),Math.abs(l))},e.prototype.keepXWithinBounds=function(e,t){var n=this.gridOptionsWrapper.getDocument(),o=n.documentElement,i=this.getPopupParent(),p=i.getBoundingClientRect(),r=n.documentElement.getBoundingClientRect(),u=i===n.body,s=e.ePopup,a=Math.min(200,p.width),d=0;e.minWidth&&e.minWidth<a?a=e.minWidth:0<s.offsetWidth&&(a=s.offsetWidth,s.style.minWidth=a+"px",d=utils_1._.getAbsoluteWidth(s)-a);var l=u?utils_1._.getAbsoluteWidth(o)+o.scrollLeft:p.width;u&&(l-=Math.abs(r.left-p.left));var c=l-a-d-3;return Math.min(Math.max(t,0),Math.abs(c))},e.prototype.addAsModalPopup=function(e,t,n,o){return this.addPopup(!0,e,t,n,o)},e.prototype.addPopup=function(e,n,t,o,i,p){var r=this,u=this.gridOptionsWrapper.getDocument();if(!u)return console.warn("ag-grid: could not find the document, document is empty"),function(){};var s=utils_1._.findIndex(this.popupList,function(e){return e.element===n});if(-1!==s)return this.popupList[s].hideFunc;var a=this.getPopupParent();a.appendChild(n),n.style.top="0px",n.style.left="0px";var d=document.createElement("div"),l=this.environment.getTheme().theme;l&&utils_1._.addCssClass(d,l),utils_1._.addCssClass(d,"ag-popup"),utils_1._.addCssClass(n,this.gridOptionsWrapper.isEnableRtl()?"ag-rtl":"ag-ltr"),d.appendChild(n),a.appendChild(d),p?this.setAlwaysOnTop(d,!0):this.bringPopupToFront(d);function c(e){(e.which||e.keyCode)===constants_1.Constants.KEY_ESCAPE&&d.contains(document.activeElement)&&m(null)}function g(e){m(e)}function h(e){m(null,e)}var v=!1,m=function(e,t){r.isEventFromCurrentPopup(e,t,n)||r.isEventSameChainAsOriginalEvent(i,e,t)||v||(v=!0,a.removeChild(d),u.removeEventListener("keydown",c),u.removeEventListener("mousedown",g),u.removeEventListener("touchstart",h),u.removeEventListener("contextmenu",g),r.eventService.removeEventListener(events_1.Events.EVENT_DRAG_STARTED,g),o&&o(),r.popupList=r.popupList.filter(function(e){return e.element!==n}))};return window.setTimeout(function(){t&&u.addEventListener("keydown",c),e&&(u.addEventListener("mousedown",g),r.eventService.addEventListener(events_1.Events.EVENT_DRAG_STARTED,g),u.addEventListener("touchstart",h),u.addEventListener("contextmenu",g))},0),this.popupList.push({element:n,hideFunc:m}),m},e.prototype.isEventFromCurrentPopup=function(e,t,n){var o=e||t;if(!o)return!1;var i=utils_1._.findIndex(this.popupList,function(e){return e.element===n});if(-1===i)return!1;for(var p=i;p<this.popupList.length;p++){var r=this.popupList[p];if(utils_1._.isElementInEventPath(r.element,o))return!0}for(var u=o.target;u&&u!=document.body;){if(u.classList.contains("ag-custom-component-popup")||null===u.parentElement)return!0;u=u.parentElement}},e.prototype.isEventSameChainAsOriginalEvent=function(e,t,n){var o=null;if(t?o=t:n&&(o=n.touches[0]),o&&e){var i=t?t.screenX:0,p=t?t.screenY:0,r=Math.abs(e.screenX-i)<5,u=Math.abs(e.screenY-p)<5;if(r&&u)return!0}return!1},e.prototype.getWrapper=function(e){for(;!utils_1._.containsClass(e,"ag-popup")&&e.parentElement;)e=e.parentElement;return utils_1._.containsClass(e,"ag-popup")?e:null},e.prototype.setAlwaysOnTop=function(e,t){var n=this.getWrapper(e);n&&(utils_1._.addOrRemoveCssClass(n,"ag-always-on-top",!!t),t&&this.bringPopupToFront(n))},e.prototype.bringPopupToFront=function(e){var t=this.getPopupParent(),n=Array.prototype.slice.call(t.querySelectorAll(".ag-popup")),o=n.length,i=Array.prototype.slice.call(t.querySelectorAll(".ag-popup.ag-always-on-top")),p=i.length,r=this.getWrapper(e);if(r&&!(o<=1)&&t.contains(e)){var u=n.indexOf(r);if(p)utils_1._.containsClass(r,"ag-always-on-top")?u!==o-1&&utils_1._.last(i).insertAdjacentElement("afterend",r):u!==o-p-1&&i[0].insertAdjacentElement("beforebegin",r);else u!==o-1&&utils_1._.last(n).insertAdjacentElement("afterend",r);var s={type:"popupToFront",api:this.gridOptionsWrapper.getApi(),columnApi:this.gridOptionsWrapper.getColumnApi(),eWrapper:r};this.eventService.dispatchEvent(s)}},__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.Autowired("environment"),__metadata("design:type",environment_1.Environment)],e.prototype,"environment",void 0),__decorate([context_1.Autowired("eventService"),__metadata("design:type",eventService_1.EventService)],e.prototype,"eventService",void 0),e=__decorate([context_1.Bean("popupService")],e)}();exports.PopupService=PopupService;