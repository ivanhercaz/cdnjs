"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var utils_1=require("../utils"),Context=function(){function t(t,e){if(this.beanWrappers={},this.registeredModules=[],this.componentsMappedByName={},this.destroyed=!1,t&&t.beans){this.contextParams=t,this.registeredModules=t.registeredModules,this.logger=e,this.logger.log(">> creating ag-Application Context"),this.setupComponents(),this.createBeans();var r=this.getBeanInstances();this.wireBeans(r),this.logger.log(">> ag-Application Context ready - component is alive")}}return t.prototype.getBeanInstances=function(){return utils_1._.mapObject(this.beanWrappers,function(t){return t.beanInstance})},t.prototype.setupComponents=function(){var e=this;this.contextParams.components&&this.contextParams.components.forEach(function(t){return e.addComponent(t)})},t.prototype.addComponent=function(t){var e=t.componentName.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase().toUpperCase();this.componentsMappedByName[e]=t.theClass},t.prototype.createComponentFromElement=function(t,e){var r=t.nodeName;if(this.componentsMappedByName&&this.componentsMappedByName[r]){var n=new this.componentsMappedByName[r];return this.wireBean(n,e),n}return null},t.prototype.wireBean=function(t,e){if(!t)throw Error("Can't wire to bean since it is null");this.wireBeans([t],e)},t.prototype.wireBeans=function(t,e){this.autoWireBeans(t),this.methodWireBeans(t),this.callLifeCycleMethods(t,"preConstructMethods"),utils_1._.exists(e)&&t.forEach(e),this.callLifeCycleMethods(t,"postConstructMethods")},t.prototype.createBeans=function(){var a=this;this.contextParams.beans.forEach(this.createBeanWrapper.bind(this)),this.contextParams.overrideBeans&&this.contextParams.overrideBeans.forEach(this.createBeanWrapper.bind(this)),utils_1._.iterateObject(this.beanWrappers,function(t,e){var r;e.bean.__agBeanMetaData&&e.bean.__agBeanMetaData.autowireMethods&&e.bean.__agBeanMetaData.autowireMethods.agConstructor&&(r=e.bean.__agBeanMetaData.autowireMethods.agConstructor);var n=a.getBeansForParameters(r,e.bean.name),o=applyToConstructor(e.bean,n);e.beanInstance=o,a.logger.log("bean "+a.getBeanName(o)+" created")})},t.prototype.createBeanWrapper=function(t){var e=t.__agBeanMetaData;if(!e){var r=void 0;return r=t.prototype.constructor?t.prototype.constructor.name:""+t,void console.error("context item "+r+" is not a bean")}var n={bean:t,beanInstance:null,beanName:e.beanName};this.beanWrappers[e.beanName]=n},t.prototype.autoWireBeans=function(t){var o=this;t.forEach(function(n){o.forEachMetaDataInHierarchy(n,function(t,r){var e=t.agClassAttributes;e&&e.forEach(function(t){var e=o.lookupBeanInstance(r,t.beanName,t.optional);n[t.attributeName]=e})})})},t.prototype.methodWireBeans=function(t){var a=this;t.forEach(function(o){a.forEachMetaDataInHierarchy(o,function(t,n){utils_1._.iterateObject(t.autowireMethods,function(t,e){if("agConstructor"!==t){var r=a.getBeansForParameters(e,n);o[t].apply(o,r)}})})})},t.prototype.forEachMetaDataInHierarchy=function(t,e){for(var r=Object.getPrototypeOf(t);null!=r;){var n=r.constructor;if(n.hasOwnProperty("__agBeanMetaData"))e(n.__agBeanMetaData,this.getBeanName(n));r=Object.getPrototypeOf(r)}},t.prototype.getBeanName=function(t){if(t.__agBeanMetaData&&t.__agBeanMetaData.beanName)return t.__agBeanMetaData.beanName;var e=t.toString();return e.substring(9,e.indexOf("("))},t.prototype.getBeansForParameters=function(t,n){var o=this,a=[];return t&&utils_1._.iterateObject(t,function(t,e){var r=o.lookupBeanInstance(n,e);a[Number(t)]=r}),a},t.prototype.lookupBeanInstance=function(t,e,r){if(void 0===r&&(r=!1),"context"===e)return this;if(this.contextParams.seed&&this.contextParams.seed.hasOwnProperty(e))return this.contextParams.seed[e];var n=this.beanWrappers[e];return n?n.beanInstance:(r||console.error("ag-Grid: unable to find bean reference "+e+" while initialising "+t),null)},t.prototype.callLifeCycleMethods=function(t,n){var e=this;t.forEach(function(r){e.forEachMetaDataInHierarchy(r,function(t){var e=t[n];e&&e.forEach(function(t){return r[t]()})})})},t.prototype.getBean=function(t){return this.lookupBeanInstance("getBean",t,!0)},t.prototype.getEnterpriseDefaultComponents=function(){return this.contextParams.enterpriseDefaultComponents},t.prototype.destroy=function(){if(!this.destroyed){this.logger.log(">> Shutting down ag-Application Context");var t=this.getBeanInstances();this.callLifeCycleMethods(t,"preDestroyMethods"),this.contextParams.seed=null,this.destroyed=!0,this.logger.log(">> ag-Application Context shut down - component is dead")}},t.prototype.isModuleRegistered=function(t){return-1!==this.registeredModules.indexOf(t)},t}();function applyToConstructor(t,e){var r=[null].concat(e);return new(t.bind.apply(t,r))}function PreConstruct(t,e,r){var n=getOrCreateProps(t.constructor);n.postConstructMethods||(n.preConstructMethods=[]),n.preConstructMethods.push(e)}function PostConstruct(t,e,r){var n=getOrCreateProps(t.constructor);n.postConstructMethods||(n.postConstructMethods=[]),n.postConstructMethods.push(e)}function PreDestroy(t,e,r){var n=getOrCreateProps(t.constructor);n.preDestroyMethods||(n.preDestroyMethods=[]),n.preDestroyMethods.push(e)}function Bean(e){return function(t){getOrCreateProps(t).beanName=e}}function Autowired(n){return function(t,e,r){autowiredFunc(t,n,!1,t,e,null)}}function Optional(n){return function(t,e,r){autowiredFunc(t,n,!0,t,e,null)}}function autowiredFunc(t,e,r,n,o,a){if(null!==e)if("number"!=typeof a){var s=getOrCreateProps(t.constructor);s.agClassAttributes||(s.agClassAttributes=[]),s.agClassAttributes.push({attributeName:o,beanName:e,optional:r})}else console.error("ag-Grid: Autowired should be on an attribute");else console.error("ag-Grid: Autowired name should not be null")}function Qualifier(s){return function(t,e,r){var n,o="function"==typeof t?t:t.constructor;if("number"==typeof r){var a=void 0;a=e?(n=getOrCreateProps(o),e):(n=getOrCreateProps(o),"agConstructor"),n.autowireMethods||(n.autowireMethods={}),n.autowireMethods[a]||(n.autowireMethods[a]={}),n.autowireMethods[a][r]=s}}}function getOrCreateProps(t){return t.hasOwnProperty("__agBeanMetaData")||(t.__agBeanMetaData={}),t.__agBeanMetaData}exports.Context=Context,exports.PreConstruct=PreConstruct,exports.PostConstruct=PostConstruct,exports.PreDestroy=PreDestroy,exports.Bean=Bean,exports.Autowired=Autowired,exports.Optional=Optional,exports.Qualifier=Qualifier;