"use strict";var __extends=this&&this.__extends||function(){var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}(),__decorate=this&&this.__decorate||function(t,e,i,o){var s,n=arguments.length,r=n<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,o);else for(var a=t.length-1;0<=a;a--)(s=t[a])&&(r=(n<3?s(r):3<n?s(e,i,r):s(e,i))||r);return 3<n&&r&&Object.defineProperty(e,i,r),r},__metadata=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};Object.defineProperty(exports,"__esModule",{value:!0});var dragService_1=require("../dragAndDrop/dragService"),componentAnnotations_1=require("./componentAnnotations"),context_1=require("../context/context"),popupService_1=require("./popupService"),popupComponent_1=require("./popupComponent"),utils_1=require("../utils"),component_1=require("./component"),Dialog=function(i){function o(t){var e=i.call(this,o.TEMPLATE)||this;return e.resizable={},e.isResizable=!1,e.isMaximizable=!1,e.isMaximized=!1,e.maximizeListeners=[],e.movable=!1,e.closable=!0,e.isMoving=!1,e.isResizing=!1,e.dragStartPosition={x:0,y:0},e.position={x:0,y:0},e.size={width:0,height:0},e.lastPosition={x:0,y:0,width:0,height:0},e.config=t,e}return __extends(o,i),o.prototype.postConstruct=function(){var i=this,t=this.config,e=t.alwaysOnTop,o=t.component,s=t.centered,n=t.resizable,r=t.movable,a=t.maximizable,p=t.closable,h=t.title,l=t.minWidth,c=t.width,d=t.minHeight,g=t.height,m=this.config,u=m.x,f=m.y,_=this.getGui();this.popupParent=this.popupService.getPopupParent(),this.minHeight=null!=d?d:250,this.minWidth=null!=l?l:250,o&&this.setBodyComponent(o),n&&this.setResizable(n),h&&this.setTitle(h),this.isResizable&&a&&this.setMaximizable(a),this.setMovable(!!r),this.setClosable(null!=p?p:this.closable),c&&(utils_1._.setFixedWidth(_,c),this.size.width=c),g&&(utils_1._.setFixedHeight(_,g),this.size.height=g),this.close=this.popupService.addPopup(!1,_,!0,this.destroy.bind(this)),e&&(_.style.zIndex="6"),this.refreshSize(),_.focus(),s&&(u=_.offsetParent.clientWidth/2-this.getWidth()/2,f=_.offsetParent.clientHeight/2-this.getHeight()/2),(u||f)&&this.offsetDialog(u,f),this.addDestroyableEventListener(this.eTitleBar,"mousedown",function(t){if(!_.contains(t.relatedTarget)&&!_.contains(document.activeElement)){var e=i.eContentWrapper.querySelector("button, [href], input, select, textarea, [tabindex]");e&&e.focus()}}),this.addDestroyableEventListener(_,"focusin",function(t){_.contains(t.relatedTarget)||i.popupService.bringPopupToFront(_)})},o.prototype.updateDragStartPosition=function(t,e){this.dragStartPosition={x:t,y:e}},o.prototype.getResizerElement=function(t){return{topLeft:this.eTopLeftResizer,top:this.eTopResizer,topRight:this.eTopRightResizer,right:this.eRightResizer,bottomRight:this.eBottomRightResizer,bottom:this.eBottomResizer,bottomLeft:this.eBottomLeftResizer,left:this.eLeftResizer}[t]},o.prototype.setResizable=function(n){var r=this,a=!1;"boolean"==typeof n&&(n={topLeft:n,top:n,topRight:n,right:n,bottomRight:n,bottom:n,bottomLeft:n,left:n}),Object.keys(n).forEach(function(t){var e=t,i=!!n[e],o=r.getResizerElement(e),s={eElement:o,onDragStart:r.onDialogResizeStart.bind(r),onDragging:function(t){return r.onDialogResize(t,e)},onDragStop:r.onDialogResizeEnd.bind(r)};!!r.resizable[e]!=i&&(i?(r.dragService.addDragSource(s),o.style.pointerEvents="all",a=!0):(r.dragService.removeDragSource(s),o.style.pointerEvents="none"))}),this.isResizable=a},o.prototype.onDialogResizeStart=function(t){this.isResizing=!0,this.updateDragStartPosition(t.clientX,t.clientY)},o.prototype.calculateMouseMovement=function(t){var e=this.popupParent.getBoundingClientRect(),i=t.e,o=t.isLeft,s=t.isTop,n=t.anywhereWithin,r=t.topBuffer,a=i.clientX-this.dragStartPosition.x,p=i.clientY-this.dragStartPosition.y,h=this.getWidth(),l=this.getHeight(),c=e.left>=i.clientX&&this.position.x<=0||e.right<=i.clientX&&e.right<=this.position.x+e.left+h;return{movementX:a=(c=c||(o?a<0&&i.clientX>this.position.x+e.left||0<a&&i.clientX<this.position.x+e.left:n?a<0&&i.clientX>this.position.x+e.left+h||0<a&&i.clientX<this.position.x+e.left:a<0&&i.clientX>this.position.x+e.left+h||0<a&&i.clientX<this.position.x+e.left+h))?0:a,movementY:p=e.top>=i.clientY&&this.position.y<=0||e.bottom<=i.clientY&&e.bottom<=this.position.y+e.top+l||s&&(p<0&&i.clientY>this.position.y+e.top+(r||0)||0<p&&i.clientY<this.position.y+e.top)||!s&&(p<0&&i.clientY>this.position.y+e.top+l||0<p&&i.clientY<this.position.y+e.top+l)?0:p}},o.prototype.onDialogResize=function(t,e){if(this.isResizing){var i=!!e.match(/left/i),o=!!e.match(/right/i),s=!!e.match(/top/i),n=!!e.match(/bottom/i),r=i||o,a=s||n,p=this.calculateMouseMovement({e:t,isLeft:i,isTop:s}),h=p.movementX,l=p.movementY,c=0,d=0;if(r&&h){var g=i?-1:1,m=this.getWidth(),u=m+h*g,f=!1;i&&(c=m-u,(this.position.x+c<=0||u<=this.minWidth)&&(f=!0,c=0)),f||this.setWidth(u)}if(a&&l){g=s?-1:1;var _=this.getHeight(),v=_+l*g,y=!1;s&&(d=_-v,(this.position.y+d<=0||v<=this.minHeight)&&(y=!0,d=0)),y||this.setHeight(v)}this.updateDragStartPosition(t.clientX,t.clientY),(c||d)&&this.offsetDialog(this.position.x+c,this.position.y+d),this.isMaximized=!1}},o.prototype.onDialogResizeEnd=function(){this.isResizing=!1},o.prototype.refreshSize=function(){var t=this.size,e=t.width,i=t.height;e||this.setWidth(this.getGui().offsetWidth),i||this.setHeight(this.getGui().offsetHeight)},o.prototype.setMovable=function(t){if(t!==this.movable){this.movable=t;var e={eElement:this.eTitleBar,onDragStart:this.onDialogMoveStart.bind(this),onDragging:this.onDialogMove.bind(this),onDragStop:this.onDialogMoveEnd.bind(this)};this.dragService[t?"addDragSource":"removeDragSource"](e)}},o.prototype.onDialogMoveStart=function(t){this.isMoving=!0,this.updateDragStartPosition(t.clientX,t.clientY)},o.prototype.onDialogMove=function(t){if(this.isMoving){var e=this.position,i=e.x,o=e.y,s=this.calculateMouseMovement({e:t,isTop:!0,anywhereWithin:!0,topBuffer:this.getHeight()-this.getBodyHeight()}),n=s.movementX,r=s.movementY;this.offsetDialog(i+n,o+r),this.updateDragStartPosition(t.clientX,t.clientY)}},o.prototype.offsetDialog=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0);var i=this.getGui();this.popupService.positionPopup({ePopup:i,x:t,y:e,minWidth:this.minWidth,minHeight:this.minHeight,keepWithinBounds:!0}),this.position.x=parseInt(i.style.left,10),this.position.y=parseInt(i.style.top,10)},o.prototype.onDialogMoveEnd=function(){this.isMoving=!1},o.prototype.setClosable=function(t){if(t!==this.closable&&(this.closable=t),t){var e=this.closeButtonComp=new component_1.Component(o.CLOSE_BTN_TEMPLATE);this.addTitleBarButton(e),e.addDestroyableEventListener(e.getGui(),"click",this.onBtClose.bind(this))}else this.closeButtonComp&&(this.closeButtonComp.destroy(),this.closeButtonComp=void 0)},o.prototype.setMaximizable=function(t){if(!1===t)return this.clearMaximizebleListeners(),void(this.maximizeButtonComp&&(this.maximizeButtonComp.destroy(),this.maximizeButtonComp=void 0));var e=this.eTitleBar;if(this.isResizable&&e&&t!==this.isMaximizable){var i=this.maximizeButtonComp=new component_1.Component(o.MAXIMIZE_BTN_TEMPLATE);i.addDestroyableEventListener(i.getGui(),"click",this.toggleMaximize.bind(this)),this.addTitleBarButton(i,0),this.maximizeListeners.push(this.addDestroyableEventListener(e,"dblclick",this.toggleMaximize.bind(this)))}},o.prototype.toggleMaximize=function(){var t=this.maximizeButtonComp.getGui(),e=t.querySelector(".ag-icon-maximize"),i=t.querySelector(".ag-icon-minimize");if(this.isMaximized){var o=this.lastPosition,s=o.x,n=o.y,r=o.width,a=o.height;this.setWidth(r),this.setHeight(a),this.offsetDialog(s,n)}else this.lastPosition.width=this.getWidth(),this.lastPosition.height=this.getHeight(),this.lastPosition.x=this.position.x,this.lastPosition.y=this.position.y,this.offsetDialog(0,0),this.setHeight(1/0),this.setWidth(1/0);this.isMaximized=!this.isMaximized,utils_1._.addOrRemoveCssClass(e,"ag-hidden",this.isMaximized),utils_1._.addOrRemoveCssClass(i,"ag-hidden",!this.isMaximized)},o.prototype.clearMaximizebleListeners=function(){this.maximizeListeners.length&&(this.maximizeListeners.forEach(function(t){return t()}),this.maximizeListeners.length=0)},o.prototype.setBodyComponent=function(t){t.setParentComponent(this),this.eContentWrapper.appendChild(t.getGui())},o.prototype.addTitleBarButton=function(t,e){var i=this.eTitleBarButtons,o=i.children,s=o.length;null==e&&(e=s),e=Math.max(0,Math.min(e,s));var n=t.getGui();utils_1._.addCssClass(n,"ag-dialog-button"),0===e?i.insertAdjacentElement("afterbegin",n):e===s?i.insertAdjacentElement("beforeend",n):o[e-1].insertAdjacentElement("afterend",n),t.setParentComponent(this)},o.prototype.getBodyHeight=function(){return utils_1._.getInnerHeight(this.eContentWrapper)},o.prototype.getBodyWidth=function(){return utils_1._.getInnerWidth(this.eContentWrapper)},o.prototype.setTitle=function(t){this.eTitle.innerText=t},o.prototype.getHeight=function(){return this.size.height},o.prototype.setHeight=function(t){var e=Math.max(this.minHeight,t),i=this.getGui();e+this.position.y>i.offsetParent.clientHeight&&(e=i.offsetParent.clientHeight-this.position.y),this.size.height!==e&&(this.size.height=e,utils_1._.setFixedHeight(i,e),utils_1._.setFixedHeight(this.eContentWrapper,i.clientHeight-this.eTitleBar.offsetHeight))},o.prototype.getWidth=function(){return this.size.width},o.prototype.setWidth=function(t){var e=Math.max(this.minWidth,t),i=this.getGui();e+this.position.x>i.offsetParent.clientWidth&&(e=i.offsetParent.clientWidth-this.position.x),this.size.width!==e&&(this.size.width=e,utils_1._.setFixedWidth(i,e))},o.prototype.onBtClose=function(){this.close()},o.prototype.destroy=function(){i.prototype.destroy.call(this),this.closeButtonComp&&(this.closeButtonComp.destroy(),this.closeButtonComp=void 0),this.maximizeButtonComp&&(this.maximizeButtonComp.destroy(),this.maximizeButtonComp=void 0),this.clearMaximizebleListeners();var t=this.getGui();t&&t.offsetParent&&this.close()},o.TEMPLATE='<div class="ag-dialog" tabindex="-1">\n            <div class="ag-resizer-wrapper">\n                <div ref="eTopLeftResizer" class="ag-resizer ag-resizer-topLeft"></div>\n                <div ref="eTopResizer" class="ag-resizer ag-resizer-top"></div>\n                <div ref="eTopRightResizer" class="ag-resizer ag-resizer-topRight"></div>\n                <div ref="eRightResizer" class="ag-resizer ag-resizer-right"></div>\n                <div ref="eBottomRightResizer" class="ag-resizer ag-resizer-bottomRight"></div>\n                <div ref="eBottomResizer" class="ag-resizer ag-resizer-bottom"></div>\n                <div ref="eBottomLeftResizer" class="ag-resizer ag-resizer-bottomLeft"></div>\n                <div ref="eLeftResizer" class="ag-resizer ag-resizer-left"></div>\n            </div>\n            <div ref="eTitleBar" class="ag-dialog-title-bar ag-unselectable">\n                <span ref="eTitle" class="ag-dialog-title-bar-title"></span>\n                <div ref="eTitleBarButtons" class="ag-dialog-title-bar-buttons"></div>\n            </div>\n            <div ref="eContentWrapper" class="ag-dialog-content-wrapper"></div>\n        </div>',o.CLOSE_BTN_TEMPLATE='<div class="ag-dialog-button">\n            <span class="ag-icon ag-icon-cross"></span>\n        </div>\n        ',o.MAXIMIZE_BTN_TEMPLATE='<div class="ag-dialog-button">\n            <span class="ag-icon ag-icon-maximize"></span>\n            <span class="ag-icon ag-icon-minimize ag-hidden"></span>\n        </span>\n        ',__decorate([context_1.Autowired("dragService"),__metadata("design:type",dragService_1.DragService)],o.prototype,"dragService",void 0),__decorate([context_1.Autowired("popupService"),__metadata("design:type",popupService_1.PopupService)],o.prototype,"popupService",void 0),__decorate([componentAnnotations_1.RefSelector("eContentWrapper"),__metadata("design:type",HTMLElement)],o.prototype,"eContentWrapper",void 0),__decorate([componentAnnotations_1.RefSelector("eTitleBar"),__metadata("design:type",HTMLElement)],o.prototype,"eTitleBar",void 0),__decorate([componentAnnotations_1.RefSelector("eTitleBarButtons"),__metadata("design:type",HTMLElement)],o.prototype,"eTitleBarButtons",void 0),__decorate([componentAnnotations_1.RefSelector("eTitle"),__metadata("design:type",HTMLElement)],o.prototype,"eTitle",void 0),__decorate([componentAnnotations_1.RefSelector("eTopLeftResizer"),__metadata("design:type",HTMLElement)],o.prototype,"eTopLeftResizer",void 0),__decorate([componentAnnotations_1.RefSelector("eTopResizer"),__metadata("design:type",HTMLElement)],o.prototype,"eTopResizer",void 0),__decorate([componentAnnotations_1.RefSelector("eTopRightResizer"),__metadata("design:type",HTMLElement)],o.prototype,"eTopRightResizer",void 0),__decorate([componentAnnotations_1.RefSelector("eRightResizer"),__metadata("design:type",HTMLElement)],o.prototype,"eRightResizer",void 0),__decorate([componentAnnotations_1.RefSelector("eBottomRightResizer"),__metadata("design:type",HTMLElement)],o.prototype,"eBottomRightResizer",void 0),__decorate([componentAnnotations_1.RefSelector("eBottomResizer"),__metadata("design:type",HTMLElement)],o.prototype,"eBottomResizer",void 0),__decorate([componentAnnotations_1.RefSelector("eBottomLeftResizer"),__metadata("design:type",HTMLElement)],o.prototype,"eBottomLeftResizer",void 0),__decorate([componentAnnotations_1.RefSelector("eLeftResizer"),__metadata("design:type",HTMLElement)],o.prototype,"eLeftResizer",void 0),__decorate([context_1.PostConstruct,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],o.prototype,"postConstruct",null),o}(popupComponent_1.PopupComponent);exports.Dialog=Dialog;