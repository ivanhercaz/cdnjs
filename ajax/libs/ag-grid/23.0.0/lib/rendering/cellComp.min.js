"use strict";var __extends=this&&this.__extends||function(){var s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};return function(e,t){function i(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,i=1,s=arguments.length;i<s;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};Object.defineProperty(exports,"__esModule",{value:!0});var column_1=require("../entities/column"),constants_1=require("../constants"),events_1=require("../events"),component_1=require("../widgets/component"),checkboxSelectionComponent_1=require("./checkboxSelectionComponent"),iRangeController_1=require("../interfaces/iRangeController"),rowDragComp_1=require("./rowDragComp"),popupEditorWrapper_1=require("./cellEditors/popupEditorWrapper"),utils_1=require("../utils"),dndSourceComp_1=require("./dndSourceComp"),CellComp=function(p){function a(e,t,i,s,n,o,r){var l=p.call(this)||this;if(l.editingCell=!1,l.suppressRefreshCell=!1,l.scope=null,l.cellEditorVersion=0,l.cellRendererVersion=0,l.scope=e,l.beans=t,l.column=i,l.rowNode=s,l.rowComp=n,l.autoHeightCell=o,l.printLayout=r,l.createGridCellVo(),l.rangeSelectionEnabled=t.gridOptionsWrapper.isEnableRangeSelection(),l.cellFocused=l.beans.focusedCellController.isCellFocused(l.cellPosition),l.firstRightPinned=l.column.isFirstRightPinned(),l.lastLeftPinned=l.column.isLastLeftPinned(),l.rangeSelectionEnabled){var a=l.beans.rangeController;l.rangeCount=a.getCellRangeCount(l.cellPosition),l.rangeCount&&(l.hasChartRange=a.getCellRanges().every(function(e){return utils_1._.exists(e.type)}))}return l.getValueAndFormat(),l.setUsingWrapper(),l.chooseCellRenderer(),l.setupColSpan(),l.rowSpan=l.column.getRowSpan(l.rowNode),l}return __extends(a,p),a.prototype.getCreateTemplate=function(){var e=this.beans.gridOptionsWrapper.isEnableCellTextSelection()?"":'unselectable="on"',t=[],i=this.column,s=this.getCellWidth(),n=this.modifyLeftForPrintLayout(this.getCellLeft()),o=this.getInitialValueToRender(),r=utils_1._.get(this.column,"colDef.template",null)?o:utils_1._.escape(o);this.tooltip=this.getToolTip();var l=utils_1._.escape(this.tooltip),a=utils_1._.escape(i.getId()),p="",h="",u=this.preProcessStylesFromColDef(),d=this.getInitialCssClasses(),c=this.getStylesForRowSpanning();return this.usingWrapper&&(p='<div ref="eCellWrapper" class="ag-cell-wrapper"><span ref="eCellValue" class="ag-cell-value" '+e+">",h="</span></div>"),t.push("<div"),t.push(' tabindex="-1"'),t.push(" "+e),t.push(' role="gridcell"'),t.push(' comp-id="'+this.getCompId()+'" '),t.push(' col-id="'+a+'"'),t.push(' class="'+d.join(" ")+'"'),this.beans.gridOptionsWrapper.isEnableBrowserTooltips()&&utils_1._.exists(l)&&t.push('title="'+l+'"'),t.push(' style="width: '+s+"px; left: "+n+"px; "+u+" "+c+'" >'),t.push(p),utils_1._.exists(r,!0)&&t.push(r),t.push(h),t.push("</div>"),t.join("")},a.prototype.getStylesForRowSpanning=function(){return 1===this.rowSpan?"":"height: "+this.beans.gridOptionsWrapper.getRowHeightAsNumber()*this.rowSpan+"px; z-index: 1;"},a.prototype.afterAttached=function(){var e='[comp-id="'+this.getCompId()+'"]',t=this.eParentRow.querySelector(e);this.setGui(t),this.addDomData(),this.populateTemplate(),this.createCellRendererInstance(!0),this.angular1Compile(),this.rangeSelectionEnabled&&this.shouldHaveSelectionHandle()&&this.addSelectionHandle(),utils_1._.exists(this.tooltip)&&!this.beans.gridOptionsWrapper.isEnableBrowserTooltips()&&this.beans.tooltipManager.registerTooltip(this)},a.prototype.onColumnHover=function(){var e=this.beans.columnHoverService.isHovered(this.column);utils_1._.addOrRemoveCssClass(this.getGui(),"ag-column-hover",e)},a.prototype.onCellChanged=function(e){e.column===this.column&&this.refreshCell({})},a.prototype.getCellLeft=function(){return(this.beans.gridOptionsWrapper.isEnableRtl()&&this.colsSpanning?utils_1._.last(this.colsSpanning):this.column).getLeft()},a.prototype.getCellWidth=function(){if(!this.colsSpanning)return this.column.getActualWidth();var t=0;return this.colsSpanning.forEach(function(e){return t+=e.getActualWidth()}),t},a.prototype.onFlashCells=function(e){var t=this.beans.cellPositionUtils.createId(this.cellPosition);e.cells[t]&&this.animateCell("highlight")},a.prototype.setupColSpan=function(){utils_1._.missing(this.getComponentHolder().colSpan)||(this.addDestroyableEventListener(this.beans.eventService,events_1.Events.EVENT_DISPLAYED_COLUMNS_CHANGED,this.onDisplayColumnsChanged.bind(this)),this.addDestroyableEventListener(this.beans.eventService,events_1.Events.EVENT_DISPLAYED_COLUMNS_WIDTH_CHANGED,this.onWidthChanged.bind(this)),this.colsSpanning=this.getColSpanningList())},a.prototype.getColSpanningList=function(){var e=this.column.getColSpan(this.rowNode),t=[];if(1===e)t.push(this.column);else for(var i=this.column,s=this.column.getPinned(),n=0;i&&n<e&&(t.push(i),(i=this.beans.columnController.getDisplayedColAfter(i))&&!utils_1._.missing(i))&&s===i.getPinned();n++);return t},a.prototype.onDisplayColumnsChanged=function(){var e=this.getColSpanningList();utils_1._.compareArrays(this.colsSpanning,e)||(this.colsSpanning=e,this.onWidthChanged(),this.onLeftChanged())},a.prototype.getInitialCssClasses=function(){var e=["ag-cell","ag-cell-not-inline-editing"];return this.autoHeightCell||e.push("ag-cell-with-height"),!this.beans.gridOptionsWrapper.isSuppressCellSelection()&&this.cellFocused&&e.push("ag-cell-focus"),this.firstRightPinned&&e.push("ag-cell-first-right-pinned"),this.lastLeftPinned&&e.push("ag-cell-last-left-pinned"),this.beans.columnHoverService.isHovered(this.column)&&e.push("ag-column-hover"),utils_1._.pushAll(e,this.preProcessClassesFromColDef()),utils_1._.pushAll(e,this.preProcessCellClassRules()),utils_1._.pushAll(e,this.getInitialRangeClasses()),this.usingWrapper||e.push("ag-cell-value"),e},a.prototype.getInitialValueToRender=function(){if(this.usingCellRenderer)return"string"==typeof this.cellRendererGui?this.cellRendererGui:"";var e=this.getComponentHolder();if(e.template)return e.template;if(e.templateUrl){var t=this.beans.templateService.getTemplate(e.templateUrl,this.refreshCell.bind(this,!0));return t||""}return this.getValueToUse()},a.prototype.getRenderedRow=function(){return this.rowComp},a.prototype.isSuppressNavigable=function(){return this.column.isSuppressNavigable(this.rowNode)},a.prototype.getCellRenderer=function(){return this.cellRenderer},a.prototype.getCellEditor=function(){return this.cellEditor},a.prototype.refreshCell=function(e){if(!this.suppressRefreshCell&&!this.editingCell){var t=this.getComponentHolder(),i=e&&e.newData,s=e&&e.suppressFlash||t.suppressCellFlash,n=e&&e.forceRefresh,o=this.value;this.getValueAndFormat();var r=!this.valuesAreEqual(o,this.value);if(n||r){!i&&this.attemptCellRendererRefresh()||this.replaceContentsAfterRefresh();var l=this.beans.filterManager.isSuppressFlashingCellsBecauseFiltering();!s&&!l&&(this.beans.gridOptionsWrapper.isEnableCellChangeFlash()||t.enableCellChangeFlash)&&this.flashCell(),this.postProcessStylesFromColDef(),this.postProcessClassesFromColDef()}this.updateAngular1ScopeAndCompile(),this.refreshToolTip(),this.postProcessCellClassRules()}},a.prototype.flashCell=function(){this.animateCell("data-changed")},a.prototype.animateCell=function(e){var t="ag-cell-"+e,i="ag-cell-"+e+"-animation",s=this.getGui();utils_1._.addCssClass(s,t),utils_1._.removeCssClass(s,i),window.setTimeout(function(){utils_1._.removeCssClass(s,t),utils_1._.addCssClass(s,i),window.setTimeout(function(){utils_1._.removeCssClass(s,i)},1e3)},500)},a.prototype.replaceContentsAfterRefresh=function(){utils_1._.clearElement(this.eParentOfValue),this.cellRenderer&&this.cellRenderer.destroy&&this.cellRenderer.destroy(),this.cellRenderer=null,this.cellRendererGui=null,this.putDataIntoCellAfterRefresh(),this.updateAngular1ScopeAndCompile()},a.prototype.updateAngular1ScopeAndCompile=function(){this.beans.gridOptionsWrapper.isAngularCompileRows()&&this.scope&&(this.scope.data=__assign({},this.rowNode.data),this.angular1Compile())},a.prototype.angular1Compile=function(){if(this.beans.gridOptionsWrapper.isAngularCompileRows()){var e=this.getGui();if(!e.classList.contains("ng-scope")||0===e.childElementCount){var t=this.beans.$compile(e)(this.scope);this.addDestroyFunc(function(){t.remove()})}}},a.prototype.postProcessStylesFromColDef=function(){var e=this.processStylesFromColDef();e&&utils_1._.addStylesToElement(this.getGui(),e)},a.prototype.preProcessStylesFromColDef=function(){var e=this.processStylesFromColDef();return utils_1._.cssStyleObjectToMarkup(e)},a.prototype.processStylesFromColDef=function(){var e=this.getComponentHolder();if(e.cellStyle){var t=void 0;if("function"==typeof e.cellStyle){var i={value:this.value,data:this.rowNode.data,node:this.rowNode,colDef:e,column:this.column,$scope:this.scope,context:this.beans.gridOptionsWrapper.getContext(),api:this.beans.gridOptionsWrapper.getApi()};t=(0,e.cellStyle)(i)}else t=e.cellStyle;return t}},a.prototype.postProcessClassesFromColDef=function(){var t=this;this.processClassesFromColDef(function(e){return utils_1._.addCssClass(t.getGui(),e)})},a.prototype.preProcessClassesFromColDef=function(){var t=[];return this.processClassesFromColDef(function(e){return t.push(e)}),t},a.prototype.processClassesFromColDef=function(e){var t=this.getComponentHolder();this.beans.stylingService.processStaticCellClasses(t,{value:this.value,data:this.rowNode.data,node:this.rowNode,colDef:t,rowIndex:this.rowNode.rowIndex,$scope:this.scope,api:this.beans.gridOptionsWrapper.getApi(),columnApi:this.beans.gridOptionsWrapper.getColumnApi(),context:this.beans.gridOptionsWrapper.getContext()},e)},a.prototype.putDataIntoCellAfterRefresh=function(){var e=this.getComponentHolder();if(e.template)this.eParentOfValue.innerHTML=e.template;else if(e.templateUrl){var t=this.beans.templateService.getTemplate(e.templateUrl,this.refreshCell.bind(this,!0));t&&(this.eParentOfValue.innerHTML=t)}else if(this.chooseCellRenderer(),this.usingCellRenderer)this.createCellRendererInstance();else{var i=this.getValueToUse();null!=i&&(this.eParentOfValue.innerHTML=utils_1._.escape(i))}},a.prototype.attemptCellRendererRefresh=function(){if(utils_1._.missing(this.cellRenderer)||!this.cellRenderer||utils_1._.missing(this.cellRenderer.refresh))return!1;var e=this.createCellRendererParams(),t=this.beans.userComponentFactory.createFinalParams(this.getComponentHolder(),this.cellRendererType,e),i=this.cellRenderer.refresh(t);return!0===i||void 0===i},a.prototype.refreshToolTip=function(){var e=this.getToolTip();if(this.tooltip!==e){var t=utils_1._.exists(e),i=utils_1._.exists(this.tooltip);if(!t||this.tooltip!==e.toString())if(this.tooltip=e,this.beans.gridOptionsWrapper.isEnableBrowserTooltips())if(t){var s=utils_1._.escape(this.tooltip);this.eParentOfValue.setAttribute("title",s)}else this.eParentOfValue.removeAttribute("title");else i?t||this.beans.tooltipManager.unregisterTooltip(this):t&&this.beans.tooltipManager.registerTooltip(this)}},a.prototype.valuesAreEqual=function(e,t){var i=this.getComponentHolder(),s=i?i.equals:null;return s?s(e,t):e===t},a.prototype.getToolTip=function(){var e=this.getComponentHolder(),t=this.rowNode.data;if(e.tooltipField&&utils_1._.exists(t))return utils_1._.getValueUsingField(t,e.tooltipField,this.column.isTooltipFieldContainsDots());var i=e.tooltipValueGetter||e.tooltip;return i?i({api:this.beans.gridOptionsWrapper.getApi(),columnApi:this.beans.gridOptionsWrapper.getColumnApi(),colDef:e,column:this.getColumn(),context:this.beans.gridOptionsWrapper.getContext(),value:this.value,valueFormatted:this.valueFormatted,rowIndex:this.cellPosition.rowIndex,node:this.rowNode,data:this.rowNode.data,$scope:this.scope}):null},a.prototype.getTooltipText=function(e){return void 0===e&&(e=!0),e?utils_1._.escape(this.tooltip):this.tooltip},a.prototype.processCellClassRules=function(e,t){var i=this.getComponentHolder();this.beans.stylingService.processClassRules(i.cellClassRules,{value:this.value,data:this.rowNode.data,node:this.rowNode,colDef:i,rowIndex:this.cellPosition.rowIndex,api:this.beans.gridOptionsWrapper.getApi(),columnApi:this.beans.gridOptionsWrapper.getColumnApi(),$scope:this.scope,context:this.beans.gridOptionsWrapper.getContext()},e,t)},a.prototype.postProcessCellClassRules=function(){var t=this;this.processCellClassRules(function(e){utils_1._.addCssClass(t.getGui(),e)},function(e){utils_1._.removeCssClass(t.getGui(),e)})},a.prototype.preProcessCellClassRules=function(){var t=[];return this.processCellClassRules(function(e){t.push(e)},function(e){}),t},a.prototype.setUsingWrapper=function(){var e=this.getComponentHolder();if(this.rowNode.rowPinned)return this.usingWrapper=!1,this.includeSelectionComponent=!1,this.includeRowDraggingComponent=!1,void(this.includeDndSourceComponent=!1);var t="function"==typeof e.checkboxSelection,i="function"==typeof e.rowDrag,s="function"==typeof e.dndSource;this.includeSelectionComponent=t||!0===e.checkboxSelection,this.includeRowDraggingComponent=i||!0===e.rowDrag,this.includeDndSourceComponent=s||!0===e.dndSource,this.usingWrapper=this.includeRowDraggingComponent||this.includeSelectionComponent||this.includeDndSourceComponent},a.prototype.chooseCellRenderer=function(){var e=this.getComponentHolder();if(e.template||e.templateUrl)this.usingCellRenderer=!1;else{var t=this.createCellRendererParams(),i=this.beans.userComponentFactory.lookupComponentClassDef(e,"cellRenderer",t);this.beans.userComponentFactory.lookupComponentClassDef(e,"pinnedRowCellRenderer",t)&&this.rowNode.rowPinned?(this.cellRendererType=a.CELL_RENDERER_TYPE_PINNED,this.usingCellRenderer=!0):i?(this.cellRendererType=a.CELL_RENDERER_TYPE_NORMAL,this.usingCellRenderer=!0):this.usingCellRenderer=!1}},a.prototype.createCellRendererInstance=function(e){var t=this;if(void 0===e&&(e=!1),this.usingCellRenderer){var i=this.beans.gridOptionsWrapper.isAngularCompileRows(),s=this.beans.gridOptionsWrapper.isSuppressAnimationFrame();(i||s||this.autoHeightCell)&&(e=!1);var n=this.createCellRendererParams();this.cellRendererVersion++;var o=this.afterCellRendererCreated.bind(this,this.cellRendererVersion),r=this.cellRendererType===a.CELL_RENDERER_TYPE_NORMAL,l=function(){var e;(e=r?t.beans.userComponentFactory.newCellRenderer(t.getComponentHolder(),n):t.beans.userComponentFactory.newPinnedRowCellRenderer(t.getComponentHolder(),n))&&e.then(o)};e?this.beans.taskQueue.addP2Task(l):l()}},a.prototype.afterCellRendererCreated=function(e,t){this.isAlive()&&e===this.cellRendererVersion?(this.cellRenderer=t,this.cellRendererGui=this.cellRenderer.getGui(),utils_1._.missing(this.cellRendererGui)||this.editingCell||this.eParentOfValue.appendChild(this.cellRendererGui)):t.destroy&&t.destroy()},a.prototype.createCellRendererParams=function(){var i=this;return{value:this.value,valueFormatted:this.valueFormatted,getValue:this.getValue.bind(this),setValue:function(e){i.beans.valueService.setValue(i.rowNode,i.column,e)},formatValue:this.formatValue.bind(this),data:this.rowNode.data,node:this.rowNode,colDef:this.getComponentHolder(),column:this.column,$scope:this.scope,rowIndex:this.cellPosition.rowIndex,api:this.beans.gridOptionsWrapper.getApi(),columnApi:this.beans.gridOptionsWrapper.getColumnApi(),context:this.beans.gridOptionsWrapper.getContext(),refreshCell:this.refreshCell.bind(this),eGridCell:this.getGui(),eParentOfValue:this.eParentOfValue,addRowCompListener:this.rowComp?this.rowComp.addEventListener.bind(this.rowComp):null,addRenderedRowListener:function(e,t){console.warn("ag-Grid: since ag-Grid .v11, params.addRenderedRowListener() is now params.addRowCompListener()"),i.rowComp&&i.rowComp.addEventListener(e,t)}}},a.prototype.formatValue=function(e){var t=this.beans.valueFormatterService.formatValue(this.column,this.rowNode,this.scope,e);return null!=t?t:e},a.prototype.getValueToUse=function(){return null!==this.valueFormatted&&void 0!==this.valueFormatted?this.valueFormatted:this.value},a.prototype.getValueAndFormat=function(){this.value=this.getValue(),this.valueFormatted=this.beans.valueFormatterService.formatValue(this.column,this.rowNode,this.scope,this.value)},a.prototype.getValue=function(){var e=this.rowNode.leafGroup&&this.beans.columnController.isPivotMode(),t=this.rowNode.group&&this.rowNode.expanded&&!this.rowNode.footer&&!e,i=this.beans.gridOptionsWrapper.isGroupIncludeFooter(),s=this.beans.gridOptionsWrapper.isGroupSuppressBlankHeader(),n=t&&i&&!s;return this.beans.valueService.getValue(this.column,this.rowNode,!1,n)},a.prototype.onMouseEvent=function(e,t){if(!utils_1._.isStopPropagationForAgGrid(t))switch(e){case"click":this.onCellClicked(t);break;case"mousedown":this.onMouseDown(t);break;case"dblclick":this.onCellDoubleClicked(t);break;case"mouseout":this.onMouseOut(t);break;case"mouseover":this.onMouseOver(t)}},a.prototype.dispatchCellContextMenuEvent=function(e){var t=this.getComponentHolder(),i=this.createEvent(e,events_1.Events.EVENT_CELL_CONTEXT_MENU);this.beans.eventService.dispatchEvent(i),t.onCellContextMenu&&window.setTimeout(function(){return t.onCellContextMenu(i)},0)},a.prototype.createEvent=function(e,t){var i={node:this.rowNode,data:this.rowNode.data,value:this.value,column:this.column,colDef:this.getComponentHolder(),context:this.beans.gridOptionsWrapper.getContext(),api:this.beans.gridApi,columnApi:this.beans.columnApi,rowPinned:this.rowNode.rowPinned,event:e,type:t,rowIndex:this.rowNode.rowIndex};return this.scope&&(i.$scope=this.scope),i},a.prototype.onMouseOut=function(e){var t=this.createEvent(e,events_1.Events.EVENT_CELL_MOUSE_OUT);this.beans.eventService.dispatchEvent(t),this.beans.columnHoverService.clearMouseOver()},a.prototype.onMouseOver=function(e){var t=this.createEvent(e,events_1.Events.EVENT_CELL_MOUSE_OVER);this.beans.eventService.dispatchEvent(t),this.beans.columnHoverService.setMouseOver([this.column])},a.prototype.onCellDoubleClicked=function(e){var t=this.getComponentHolder(),i=this.createEvent(e,events_1.Events.EVENT_CELL_DOUBLE_CLICKED);this.beans.eventService.dispatchEvent(i),"function"==typeof t.onCellDoubleClicked&&window.setTimeout(function(){return t.onCellDoubleClicked(i)},0),this.beans.gridOptionsWrapper.isSingleClickEdit()||this.beans.gridOptionsWrapper.isSuppressClickEdit()||this.startRowOrCellEdit()},a.prototype.startRowOrCellEdit=function(e,t){this.beans.gridOptionsWrapper.isFullRowEdit()?this.rowComp.startRowEditing(e,t,this):this.startEditingIfEnabled(e,t,!0)},a.prototype.isCellEditable=function(){return this.column.isCellEditable(this.rowNode)},a.prototype.startEditingIfEnabled=function(e,t,i){if(void 0===e&&(e=null),void 0===t&&(t=null),void 0===i&&(i=!1),this.isCellEditable()&&!this.editingCell){this.editingCell=!0,this.cellEditorVersion++;var s=this.afterCellEditorCreated.bind(this,this.cellEditorVersion),n=this.createCellEditorParams(e,t,i);this.createCellEditor(n).then(s),utils_1._.missing(this.cellEditor)&&i&&this.focusCell(!0)}},a.prototype.createCellEditor=function(i){var s=this;return this.beans.userComponentFactory.newCellEditor(this.column.getColDef(),i).map(function(e){if(!(e.isPopup&&e.isPopup()))return e;s.beans.gridOptionsWrapper.isFullRowEdit()&&console.warn("ag-Grid: popup cellEditor does not work with fullRowEdit - you cannot use them both - either turn off fullRowEdit, or stop using popup editors.");var t=new popupEditorWrapper_1.PopupEditorWrapper(e);return s.beans.context.wireBean(t),t.init(i),t})},a.prototype.afterCellEditorCreated=function(e,t){if(!(e!==this.cellEditorVersion)&&this.editingCell){if(t.isCancelBeforeStart&&t.isCancelBeforeStart())return t.destroy&&t.destroy(),void(this.editingCell=!1);if(!t.getGui)return console.warn("ag-Grid: cellEditor for column "+this.column.getId()+" is missing getGui() method"),t.render&&console.warn("ag-Grid: we found 'render' on the component, are you trying to set a React renderer but added it as colDef.cellEditor instead of colDef.cellEditorFmk?"),t.destroy&&t.destroy(),void(this.editingCell=!1);this.cellEditor=t,this.cellEditorInPopup=void 0!==t.isPopup&&t.isPopup(),this.setInlineEditingClass(),this.cellEditorInPopup?this.addPopupCellEditor():this.addInCellEditor(),t.afterGuiAttached&&t.afterGuiAttached();var i=this.createEvent(null,events_1.Events.EVENT_CELL_EDITING_STARTED);this.beans.eventService.dispatchEvent(i)}else t.destroy&&t.destroy()},a.prototype.addInCellEditor=function(){utils_1._.clearElement(this.getGui()),this.cellEditor&&this.getGui().appendChild(this.cellEditor.getGui()),this.angular1Compile()},a.prototype.addPopupCellEditor=function(){var e=this,t=this.cellEditor?this.cellEditor.getGui():null;this.hideEditorPopup=this.beans.popupService.addAsModalPopup(t,!0,function(){e.onPopupEditorClosed()}),this.beans.popupService.positionPopupOverComponent({column:this.column,rowNode:this.rowNode,type:"popupCellEditor",eventSource:this.getGui(),ePopup:t,keepWithinBounds:!0}),this.angular1Compile()},a.prototype.onPopupEditorClosed=function(){this.editingCell&&(this.stopRowOrCellEdit(),this.beans.focusedCellController.isCellFocused(this.cellPosition)&&this.focusCell(!0))},a.prototype.setInlineEditingClass=function(){var e=this.editingCell&&!this.cellEditorInPopup,t=this.editingCell&&this.cellEditorInPopup;utils_1._.addOrRemoveCssClass(this.getGui(),"ag-cell-inline-editing",e),utils_1._.addOrRemoveCssClass(this.getGui(),"ag-cell-not-inline-editing",!e),utils_1._.addOrRemoveCssClass(this.getGui(),"ag-cell-popup-editing",t),utils_1._.addOrRemoveCssClass(this.getGui().parentNode,"ag-row-inline-editing",e),utils_1._.addOrRemoveCssClass(this.getGui().parentNode,"ag-row-not-inline-editing",!e)},a.prototype.createCellEditorParams=function(e,t,i){return{value:this.getValue(),keyPress:e,charPress:t,column:this.column,colDef:this.column.getColDef(),rowIndex:this.cellPosition.rowIndex,node:this.rowNode,data:this.rowNode.data,api:this.beans.gridOptionsWrapper.getApi(),cellStartedEdit:i,columnApi:this.beans.gridOptionsWrapper.getColumnApi(),context:this.beans.gridOptionsWrapper.getContext(),$scope:this.scope,onKeyDown:this.onKeyDown.bind(this),stopEditing:this.stopEditingAndFocus.bind(this),eGridCell:this.getGui(),parseValue:this.parseValue.bind(this),formatValue:this.formatValue.bind(this)}},a.prototype.stopEditingAndFocus=function(e){void 0===e&&(e=!1),this.stopRowOrCellEdit(),this.focusCell(!0),e||this.navigateAfterEdit()},a.prototype.parseValue=function(e){var t=this.getComponentHolder(),i={node:this.rowNode,data:this.rowNode.data,oldValue:this.value,newValue:e,colDef:t,column:this.column,api:this.beans.gridOptionsWrapper.getApi(),columnApi:this.beans.gridOptionsWrapper.getColumnApi(),context:this.beans.gridOptionsWrapper.getContext()},s=t.valueParser;return utils_1._.exists(s)?this.beans.expressionService.evaluate(s,i):e},a.prototype.focusCell=function(e){void 0===e&&(e=!1),this.beans.focusedCellController.setFocusedCell(this.cellPosition.rowIndex,this.column,this.rowNode.rowPinned,e)},a.prototype.setFocusInOnEditor=function(){this.editingCell&&(this.cellEditor&&this.cellEditor.focusIn?this.cellEditor.focusIn():this.focusCell(!0))},a.prototype.isEditing=function(){return this.editingCell},a.prototype.onKeyDown=function(e){var t=e.which||e.keyCode;switch(t){case constants_1.Constants.KEY_ENTER:this.onEnterKeyDown();break;case constants_1.Constants.KEY_F2:this.onF2KeyDown();break;case constants_1.Constants.KEY_ESCAPE:this.onEscapeKeyDown();break;case constants_1.Constants.KEY_TAB:this.onTabKeyDown(e);break;case constants_1.Constants.KEY_BACKSPACE:case constants_1.Constants.KEY_DELETE:this.onBackspaceOrDeleteKeyPressed(t);break;case constants_1.Constants.KEY_DOWN:case constants_1.Constants.KEY_UP:case constants_1.Constants.KEY_RIGHT:case constants_1.Constants.KEY_LEFT:this.onNavigationKeyPressed(e,t)}},a.prototype.setFocusOutOnEditor=function(){this.editingCell&&this.cellEditor&&this.cellEditor.focusOut&&this.cellEditor.focusOut()},a.prototype.onNavigationKeyPressed=function(e,t){this.editingCell||(e.shiftKey&&this.rangeSelectionEnabled?this.onShiftRangeSelect(t):this.beans.rowRenderer.navigateToNextCell(e,t,this.cellPosition,!0),e.preventDefault())},a.prototype.onShiftRangeSelect=function(e){var t=this.beans.rangeController.extendLatestRangeInDirection(e);t&&this.beans.rowRenderer.ensureCellVisible(t)},a.prototype.onTabKeyDown=function(e){this.beans.rowRenderer.onTabKeyDown(this,e)},a.prototype.onBackspaceOrDeleteKeyPressed=function(e){this.editingCell||this.startRowOrCellEdit(e)},a.prototype.onEnterKeyDown=function(){this.editingCell||this.rowComp.isEditing()?this.stopEditingAndFocus():this.beans.gridOptionsWrapper.isEnterMovesDown()?this.beans.rowRenderer.navigateToNextCell(null,constants_1.Constants.KEY_DOWN,this.cellPosition,!1):this.startRowOrCellEdit(constants_1.Constants.KEY_ENTER)},a.prototype.navigateAfterEdit=function(){this.beans.gridOptionsWrapper.isFullRowEdit()||this.beans.gridOptionsWrapper.isEnterMovesDownAfterEdit()&&this.beans.rowRenderer.navigateToNextCell(null,constants_1.Constants.KEY_DOWN,this.cellPosition,!1)},a.prototype.onF2KeyDown=function(){this.editingCell||this.startRowOrCellEdit(constants_1.Constants.KEY_F2)},a.prototype.onEscapeKeyDown=function(){this.editingCell&&(this.stopRowOrCellEdit(!0),this.focusCell(!0))},a.prototype.onKeyPress=function(e){if(!(utils_1._.getTarget(e)!==this.getGui())&&!this.editingCell){var t=String.fromCharCode(e.charCode);" "===t?this.onSpaceKeyPressed(e):utils_1._.isEventFromPrintableCharacter(e)&&(this.startRowOrCellEdit(null,t),e.preventDefault())}},a.prototype.onSpaceKeyPressed=function(e){if(!this.editingCell&&this.beans.gridOptionsWrapper.isRowSelection()){var t=this.rowNode.isSelected();this.rowNode.setSelected(!t)}e.preventDefault()},a.prototype.onMouseDown=function(e){var t=!1,i=e.button,s=e.ctrlKey,n=e.metaKey,o=e.shiftKey,r=e.target,l=this.beans,a=l.eventService,p=l.rangeController;if(p&&(p.isCellInAnyRange(this.getCellPosition())&&2===i))return;if(utils_1._.isBrowserIE()&&r.classList.contains("ag-cell")&&(t=!0),!o||p&&!p.getCellRanges().length?this.focusCell(t):e.preventDefault(),!utils_1._.isElementChildOfClass(r,"ag-selection-checkbox",3)){if(utils_1._.isLeftClick(e)&&p){var h=this.cellPosition;if(o)p.extendLatestRangeToCell(h);else{var u=s||n;p.setRangeToCell(h,u)}}var d=this.createEvent(e,events_1.Events.EVENT_CELL_MOUSE_DOWN);a.dispatchEvent(d)}},a.prototype.isDoubleClickOnIPad=function(){if(!utils_1._.isUserAgentIPad())return!1;var e=(new Date).getTime(),t=e-this.lastIPadMouseClickEvent<200;return this.lastIPadMouseClickEvent=e,t},a.prototype.onCellClicked=function(e){if(this.isDoubleClickOnIPad())return this.onCellDoubleClicked(e),void e.preventDefault();var t=this.createEvent(e,events_1.Events.EVENT_CELL_CLICKED);this.beans.eventService.dispatchEvent(t);var i=this.getComponentHolder();i.onCellClicked&&window.setTimeout(function(){return i.onCellClicked(t)},0),!this.beans.gridOptionsWrapper.isSingleClickEdit()&&!i.singleClickEdit||this.beans.gridOptionsWrapper.isSuppressClickEdit()||this.startRowOrCellEdit(),utils_1._.doIeFocusHack(this.getGui())},a.prototype.createGridCellVo=function(){this.cellPosition={rowIndex:this.rowNode.rowIndex,rowPinned:this.rowNode.rowPinned,column:this.column}},a.prototype.getCellPosition=function(){return this.cellPosition},a.prototype.getParentRow=function(){return this.eParentRow},a.prototype.setParentRow=function(e){this.eParentRow=e},a.prototype.getColumn=function(){return this.column},a.prototype.getComponentHolder=function(){return this.column.getColDef()},a.prototype.detach=function(){this.eParentRow.removeChild(this.getGui())},a.prototype.destroy=function(){p.prototype.destroy.call(this),this.cellEditor&&this.cellEditor.destroy&&(this.cellEditor.destroy(),this.cellEditor=null),this.cellRenderer&&this.cellRenderer.destroy&&(this.cellRenderer.destroy(),this.cellRenderer=null),this.selectionHandle&&this.selectionHandle.destroy()},a.prototype.onLeftChanged=function(){var e=this.modifyLeftForPrintLayout(this.getCellLeft());this.getGui().style.left=e+"px"},a.prototype.modifyLeftForPrintLayout=function(e){return this.printLayout?this.column.getPinned()===column_1.Column.PINNED_LEFT?e:this.column.getPinned()===column_1.Column.PINNED_RIGHT?this.beans.columnController.getPinnedLeftContainerWidth()+this.beans.columnController.getBodyContainerWidth()+e:this.beans.columnController.getPinnedLeftContainerWidth()+e:e},a.prototype.onWidthChanged=function(){var e=this.getCellWidth();this.getGui().style.width=e+"px"},a.prototype.getRangeBorders=function(){var e,t,i=this,s=this.beans.gridOptionsWrapper.isEnableRtl(),n=!1,o=!1,r=!1,l=!1,a=this.cellPosition.column,p=this.beans.rangeController;t=s?(e=this.beans.columnController.getDisplayedColAfter(a),this.beans.columnController.getDisplayedColBefore(a)):(e=this.beans.columnController.getDisplayedColBefore(a),this.beans.columnController.getDisplayedColAfter(a));var h=p.getCellRanges().filter(function(e){return p.isCellInSpecificRange(i.cellPosition,e)});e||(l=!0),t||(o=!0);for(var u=0;u<h.length&&!(n&&o&&r&&l);u++){var d=h[u],c=p.getRangeStartRow(d),g=p.getRangeEndRow(d);!n&&this.beans.rowPositionUtils.sameRow(c,this.cellPosition)&&(n=!0),!r&&this.beans.rowPositionUtils.sameRow(g,this.cellPosition)&&(r=!0),!l&&d.columns.indexOf(e)<0&&(l=!0),!o&&d.columns.indexOf(t)<0&&(o=!0)}return{top:n,right:o,bottom:r,left:l}},a.prototype.getInitialRangeClasses=function(){var e=[];if(!this.rangeSelectionEnabled||!this.rangeCount)return e;var t=this.beans.rangeController;e.push("ag-cell-range-selected"),this.hasChartRange&&e.push("ag-cell-range-chart");var i=Math.min(this.rangeCount,4);if(e.push("ag-cell-range-selected-"+i),1!==this.rangeCount||t.isMoreThanOneCell()||e.push("ag-cell-range-single-cell"),0<this.rangeCount){var s=this.getRangeBorders();s.top&&e.push("ag-cell-range-top"),s.right&&e.push("ag-cell-range-right"),s.bottom&&e.push("ag-cell-range-bottom"),s.left&&e.push("ag-cell-range-left")}return this.selectionHandle&&e.push("ag-cell-range-handle"),e},a.prototype.onRowIndexChanged=function(){this.createGridCellVo(),this.onCellFocused(),this.onRangeSelectionChanged()},a.prototype.onRangeSelectionChanged=function(){if(this.beans.enterprise){var e=this.beans,t=this.cellPosition,i=this.rangeCount,s=e.rangeController,n=s.getCellRangeCount(t),o=this.getGui();i!==n&&(utils_1._.addOrRemoveCssClass(o,"ag-cell-range-selected",0!==n),utils_1._.addOrRemoveCssClass(o,"ag-cell-range-selected-1",1===n),utils_1._.addOrRemoveCssClass(o,"ag-cell-range-selected-2",2===n),utils_1._.addOrRemoveCssClass(o,"ag-cell-range-selected-3",3===n),utils_1._.addOrRemoveCssClass(o,"ag-cell-range-selected-4",4<=n),this.rangeCount=n);var r=this.rangeCount&&s.getCellRanges().every(function(e){return utils_1._.exists(e.type)});this.hasChartRange!==r&&(utils_1._.addOrRemoveCssClass(o,"ag-cell-range-chart",r),this.hasChartRange=r),this.updateRangeBorders();var l=1===this.rangeCount&&!s.isMoreThanOneCell();utils_1._.addOrRemoveCssClass(o,"ag-cell-range-single-cell",l),this.refreshHandle(),utils_1._.addOrRemoveCssClass(o,"ag-cell-range-handle",!!this.selectionHandle)}},a.prototype.shouldHaveSelectionHandle=function(){var e=this.beans,t=e.gridOptionsWrapper,i=e.rangeController,s=this.getGui(),n=i.getCellRanges(),o=n.length;if(!o)return!1;var r=utils_1._.last(n),l=n[0].type===iRangeController_1.CellRangeType.DIMENSION,a=(t.isEnableFillHandle()||t.isEnableRangeHandle()||this.hasChartRange&&!l)&&1===o;if(!a&&this.hasChartRange){var p=this.getCellPosition();a=l&&2===o&&i.isCellInSpecificRange(this.getCellPosition(),r);var h=l&&i.isCellInSpecificRange(p,n[0]);utils_1._.addOrRemoveCssClass(s,"ag-cell-range-chart-category",h)}return this.rangeCount&&a&&null!=r.endRow&&this.beans.rangeController.isContiguousRange(r)&&(utils_1._.containsClass(s,"ag-cell-range-single-cell")||utils_1._.containsClass(s,"ag-cell-range-bottom")&&utils_1._.containsClass(s,"ag-cell-range-right"))},a.prototype.addSelectionHandle=function(){var e=this.beans,t=e.gridOptionsWrapper,i=e.context,s=e.rangeController,n=utils_1._.last(s.getCellRanges()).type,o=t.isEnableFillHandle()&&utils_1._.missing(n)?"fill":"range";this.selectionHandle&&this.selectionHandle.getType()!==o&&(this.selectionHandle.destroy(),this.selectionHandle=void 0),this.selectionHandle||(this.selectionHandle=i.createComponentFromElement(document.createElement("ag-"+o+"-handle"))),this.selectionHandle.refresh(this)},a.prototype.updateRangeBordersIfRangeCount=function(){0<this.rangeCount&&(this.updateRangeBorders(),this.refreshHandle())},a.prototype.refreshHandle=function(){var e=this.shouldHaveSelectionHandle();this.selectionHandle&&!e&&(this.selectionHandle.destroy(),this.selectionHandle=null),e&&this.addSelectionHandle()},a.prototype.updateRangeBorders=function(){var e=this.getRangeBorders(),t=1===this.rangeCount&&!this.beans.rangeController.isMoreThanOneCell(),i=!t&&e.top,s=!t&&e.right,n=!t&&e.bottom,o=!t&&e.left,r=this.getGui();utils_1._.addOrRemoveCssClass(r,"ag-cell-range-top",i),utils_1._.addOrRemoveCssClass(r,"ag-cell-range-right",s),utils_1._.addOrRemoveCssClass(r,"ag-cell-range-bottom",n),utils_1._.addOrRemoveCssClass(r,"ag-cell-range-left",o)},a.prototype.onFirstRightPinnedChanged=function(){var e=this.column.isFirstRightPinned();this.firstRightPinned!==e&&(this.firstRightPinned=e,utils_1._.addOrRemoveCssClass(this.getGui(),"ag-cell-first-right-pinned",e))},a.prototype.onLastLeftPinnedChanged=function(){var e=this.column.isLastLeftPinned();this.lastLeftPinned!==e&&(this.lastLeftPinned=e,utils_1._.addOrRemoveCssClass(this.getGui(),"ag-cell-last-left-pinned",e))},a.prototype.populateTemplate=function(){this.usingWrapper?(this.eParentOfValue=this.getRefElement("eCellValue"),this.eCellWrapper=this.getRefElement("eCellWrapper"),this.includeRowDraggingComponent&&this.addRowDragging(),this.includeDndSourceComponent&&this.addDndSource(),this.includeSelectionComponent&&this.addSelectionCheckbox()):this.eParentOfValue=this.getGui()},a.prototype.getFrameworkOverrides=function(){return this.beans.frameworkOverrides},a.prototype.addRowDragging=function(){var e=this.beans.gridOptionsWrapper.isPagination(),t=this.beans.gridOptionsWrapper.isRowDragManaged(),i=this.beans.gridOptionsWrapper.isRowModelDefault();if(t){if(!i)return void utils_1._.doOnce(function(){return console.warn("ag-Grid: managed row dragging is only allowed in the Client Side Row Model")},"CellComp.addRowDragging");if(e)return void utils_1._.doOnce(function(){return console.warn("ag-Grid: managed row dragging is not possible when doing pagination")},"CellComp.addRowDragging")}var s=new rowDragComp_1.RowDragComp(this.rowNode,this.column,this.getValueToUse(),this.beans);this.addFeature(this.beans.context,s),this.eCellWrapper.insertBefore(s.getGui(),this.eParentOfValue)},a.prototype.addDndSource=function(){var e=new dndSourceComp_1.DndSourceComp(this.rowNode,this.column,this.getValueToUse(),this.beans,this.getGui());this.addFeature(this.beans.context,e),this.eCellWrapper.insertBefore(e.getGui(),this.eParentOfValue)},a.prototype.addSelectionCheckbox=function(){var e=new checkboxSelectionComponent_1.CheckboxSelectionComponent;this.beans.context.wireBean(e);var t=this.getComponentHolder().checkboxSelection;t="function"==typeof t?t:null,e.init({rowNode:this.rowNode,column:this.column,visibleFunc:t}),this.addDestroyFunc(function(){return e.destroy()}),this.eCellWrapper.insertBefore(e.getGui(),this.eParentOfValue)},a.prototype.addDomData=function(){var e=this,t=this.getGui();this.beans.gridOptionsWrapper.setDomData(t,a.DOM_DATA_KEY_CELL_COMP,this),this.addDestroyFunc(function(){return e.beans.gridOptionsWrapper.setDomData(t,a.DOM_DATA_KEY_CELL_COMP,null)})},a.prototype.onCellFocused=function(e){var t=this.beans.focusedCellController.isCellFocused(this.cellPosition);t!==this.cellFocused&&(this.beans.gridOptionsWrapper.isSuppressCellSelection()||utils_1._.addOrRemoveCssClass(this.getGui(),"ag-cell-focus",t),this.cellFocused=t);if(t&&e&&e.forceBrowserFocus){var i=this.getGui();i.focus(),utils_1._.doIeFocusHack(i)}var s=this.beans.gridOptionsWrapper.isFullRowEdit();t||s||!this.editingCell||this.stopRowOrCellEdit()},a.prototype.stopRowOrCellEdit=function(e){void 0===e&&(e=!1),this.beans.gridOptionsWrapper.isFullRowEdit()?this.rowComp.stopRowEditing(e):this.stopEditing(e)},a.prototype.stopEditing=function(e){if(void 0===e&&(e=!1),this.editingCell)if(this.cellEditor){var t,i=!1;if(!e)this.cellEditor.isCancelAfterEnd&&this.cellEditor.isCancelAfterEnd()||(t=this.cellEditor.getValue(),i=!0);if(this.editingCell=!1,this.cellEditor.destroy&&this.cellEditor.destroy(),this.cellEditor=null,this.cellEditorInPopup&&this.hideEditorPopup)this.hideEditorPopup(),this.hideEditorPopup=null;else if(utils_1._.clearElement(this.getGui()),this.usingWrapper)this.getGui().appendChild(this.eCellWrapper);else if(this.cellRenderer){var s=this.cellRendererGui;s&&this.getGui().appendChild(s)}this.setInlineEditingClass(),i&&(this.suppressRefreshCell=!0,this.rowNode.setDataValue(this.column,t),this.suppressRefreshCell=!1),this.refreshCell({forceRefresh:!0,suppressFlash:!0});var n=this.createEvent(null,events_1.Events.EVENT_CELL_EDITING_STOPPED);this.beans.eventService.dispatchEvent(n)}else this.editingCell=!1},a.DOM_DATA_KEY_CELL_COMP="cellComp",a.CELL_RENDERER_TYPE_NORMAL="cellRenderer",a.CELL_RENDERER_TYPE_PINNED="pinnedRowCellRenderer",a}(component_1.Component);exports.CellComp=CellComp;