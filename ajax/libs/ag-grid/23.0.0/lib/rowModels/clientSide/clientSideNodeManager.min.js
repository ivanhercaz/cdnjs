"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var rowNode_1=require("../../entities/rowNode"),events_1=require("../../events"),utils_1=require("../../utils"),ClientSideNodeManager=function(){function d(e,t,o,r,i,s,a,n){this.nextId=0,this.allNodesMap={},this.rootNode=e,this.gridOptionsWrapper=t,this.context=o,this.eventService=r,this.columnController=i,this.gridApi=s,this.columnApi=a,this.selectionController=n,this.rootNode.group=!0,this.rootNode.level=-1,this.rootNode.id=d.ROOT_NODE_ID,this.rootNode.allLeafChildren=[],this.rootNode.childrenAfterGroup=[],this.rootNode.childrenAfterSort=[],this.rootNode.childrenAfterFilter=[],this.postConstruct()}return d.prototype.postConstruct=function(){this.getNodeChildDetails=this.gridOptionsWrapper.getNodeChildDetailsFunc(),this.suppressParentsInRowNodes=this.gridOptionsWrapper.isSuppressParentsInRowNodes(),this.doesDataFlower=this.gridOptionsWrapper.getDoesDataFlowerFunc(),this.isRowMasterFunc=this.gridOptionsWrapper.getIsRowMasterFunc(),this.doingLegacyTreeData=utils_1._.exists(this.getNodeChildDetails),this.doingMasterDetail=this.gridOptionsWrapper.isMasterDetail(),this.getNodeChildDetails&&console.warn("ag-Grid: the callback nodeChildDetailsFunc() is now deprecated. The new way of doing\n                                    tree data in ag-Grid was introduced in v14 (released November 2017). In the next\n                                    major release of ag-Grid we will be dropping support for the old version of\n                                    tree data. If you are reading this message, please go to the docs to see how\n                                    to implement Tree Data without using nodeChildDetailsFunc().")},d.prototype.getCopyOfNodesMap=function(){return utils_1._.cloneObject(this.allNodesMap)},d.prototype.getRowNode=function(e){return this.allNodesMap[e]},d.prototype.setRowData=function(e){if(this.rootNode.childrenAfterFilter=null,this.rootNode.childrenAfterGroup=null,this.rootNode.childrenAfterSort=null,this.rootNode.childrenMapped=null,this.nextId=0,this.allNodesMap={},!e)return this.rootNode.allLeafChildren=[],void(this.rootNode.childrenAfterGroup=[]);var t=this.recursiveFunction(e,this.rootNode,d.TOP_LEVEL);this.doingLegacyTreeData?(this.rootNode.childrenAfterGroup=t,this.setLeafChildren(this.rootNode)):this.rootNode.allLeafChildren=t},d.prototype.updateRowData=function(e,t){if(this.isLegacyTreeData())return null;e.add,e.addIndex,e.remove,e.update;var o={remove:[],update:[],add:[]};return this.executeAdd(e,o),this.executeRemove(e,o),this.executeUpdate(e,o),t&&utils_1._.sortRowNodesByOrder(this.rootNode.allLeafChildren,t),o},d.prototype.executeAdd=function(e,o){var r=this,t=e.add,i=e.addIndex;t&&("number"==typeof i&&0<=i?t.reverse().forEach(function(e){var t=r.addRowNode(e,i);o.add.push(t)}):t.forEach(function(e){var t=r.addRowNode(e);o.add.push(t)}))},d.prototype.executeRemove=function(e,o){var r=this,t=e.remove;if(t){var i={},s=!1;if(t.forEach(function(e){var t=r.lookupRowNode(e);t&&(t.isSelected()&&(s=!0),t.setSelected(!1,!1,!0),t.clearRowTop(),i[t.id]=!0,delete r.allNodesMap[t.id],o.remove.push(t))}),this.rootNode.allLeafChildren=this.rootNode.allLeafChildren.filter(function(e){return!i[e.id]}),s){this.selectionController.updateGroupsFromChildrenSelections();var a={type:events_1.Events.EVENT_SELECTION_CHANGED,api:this.gridApi,columnApi:this.columnApi};this.eventService.dispatchEvent(a)}}},d.prototype.executeUpdate=function(e,o){var r=this,t=e.update;t&&t.forEach(function(e){var t=r.lookupRowNode(e);t&&(t.updateData(e),o.update.push(t))})},d.prototype.addRowNode=function(e,t){var o=this.createNode(e,this.rootNode,d.TOP_LEVEL);return utils_1._.exists(t)?utils_1._.insertIntoArray(this.rootNode.allLeafChildren,o,t):this.rootNode.allLeafChildren.push(o),o},d.prototype.lookupRowNode=function(t){var e,o=this.gridOptionsWrapper.getRowNodeIdFunc();if(utils_1._.exists(o)){var r=o(t);if(!(e=this.allNodesMap[r]))return console.error("ag-Grid: could not find row id="+r+", data item was not found for this id"),null}else if(!(e=utils_1._.find(this.rootNode.allLeafChildren,function(e){return e.data===t})))return console.error("ag-Grid: could not find data item as object was not found",t),null;return e},d.prototype.recursiveFunction=function(e,o,r){var i=this;if("string"!=typeof e){var s=[];return e.forEach(function(e){var t=i.createNode(e,o,r);s.push(t)}),s}console.warn("ag-Grid: rowData must be an array, however you passed in a string. If you are loading JSON, make sure you convert the JSON string to JavaScript objects first")},d.prototype.createNode=function(e,t,o){var r=new rowNode_1.RowNode;this.context.wireBean(r);var i=this.gridOptionsWrapper.isTreeData(),s=!i&&utils_1._.exists(this.getNodeChildDetails)?this.getNodeChildDetails(e):null;if(s&&s.group)r.group=!0,r.childrenAfterGroup=this.recursiveFunction(s.children,r,o+1),r.expanded=!0===s.expanded,r.field=s.field,r.key=s.key,r.canFlower=r.master,this.setLeafChildren(r);else if(r.group=!1,i)r.master=!1,r.expanded=!1;else{this.doesDataFlower?r.master=this.doesDataFlower(e):this.doingMasterDetail?this.isRowMasterFunc?r.master=this.isRowMasterFunc(e):r.master=!0:r.master=!1;var a=this.columnController.getRowGroupColumns(),n=o+(a?a.length:0);r.expanded=!!r.master&&this.isExpanded(n)}return r.canFlower=r.master,t&&!this.suppressParentsInRowNodes&&(r.parent=t),r.level=o,r.setDataAndId(e,this.nextId.toString()),this.allNodesMap[r.id]&&console.warn("ag-grid: duplicate node id '"+r.id+"' detected from getRowNodeId callback, this could cause issues in your grid."),this.allNodesMap[r.id]=r,this.nextId++,r},d.prototype.isExpanded=function(e){var t=this.gridOptionsWrapper.getGroupDefaultExpanded();return-1===t||e<t},d.prototype.setLeafChildren=function(t){t.allLeafChildren=[],t.childrenAfterGroup&&t.childrenAfterGroup.forEach(function(e){e.group?e.allLeafChildren&&e.allLeafChildren.forEach(function(e){return t.allLeafChildren.push(e)}):t.allLeafChildren.push(e)})},d.prototype.isLegacyTreeData=function(){return!!utils_1._.exists(this.gridOptionsWrapper.getNodeChildDetailsFunc())&&(console.warn("ag-Grid: adding and removing rows is not supported when using nodeChildDetailsFunc, ie it is not supported for legacy tree data. Please see the docs on the new preferred way of providing tree data that works with delta updates."),!0)},d.TOP_LEVEL=0,d.ROOT_NODE_ID="ROOT_NODE_ID",d}();exports.ClientSideNodeManager=ClientSideNodeManager;