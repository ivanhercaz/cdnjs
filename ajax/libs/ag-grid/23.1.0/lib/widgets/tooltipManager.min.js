"use strict";var __decorate=this&&this.__decorate||function(e,t,o,i){var r,n=arguments.length,s=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,i);else for(var p=e.length-1;0<=p;p--)(r=e[p])&&(s=(n<3?r(s):3<n?r(t,o,s):r(t,o))||s);return 3<n&&s&&Object.defineProperty(t,o,s),s},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var context_1=require("../context/context"),popupService_1=require("./popupService"),userComponentFactory_1=require("../components/framework/userComponentFactory"),gridOptionsWrapper_1=require("../gridOptionsWrapper"),columnApi_1=require("../columnController/columnApi"),gridApi_1=require("../gridApi"),utils_1=require("../utils"),TooltipManager=function(){function e(){this.DEFAULT_HIDE_TOOLTIP_TIMEOUT=1e4,this.MOUSEOUT_HIDE_TOOLTIP_TIMEOUT=1e3,this.MOUSEOVER_SHOW_TOOLTIP_TIMEOUT=2e3,this.HIDE_SHOW_ONLY=!0,this.showTimeoutId=0,this.hideTimeoutId=0,this.registeredComponents={}}return e.prototype.registerTooltip=function(t){var o=this,e=t.getGui(),i=t.getCompId();this.registeredComponents[i]={tooltipComp:void 0,destroyFunc:void 0,eventDestroyFuncs:[t.addDestroyableEventListener(e,"mouseover",function(e){return o.processMouseOver(e,t)}),t.addDestroyableEventListener(e,"mousemove",function(e){return o.processMouseMove(e)}),t.addDestroyableEventListener(e,"mousedown",this.hideTooltip.bind(this)),t.addDestroyableEventListener(e,"mouseout",this.processMouseOut.bind(this))]},t.addDestroyFunc(function(){return o.unregisterTooltip(t)})},e.prototype.unregisterTooltip=function(e){var t=e.getCompId(),o=this.registeredComponents[t];this.activeComponent===e&&this.hideTooltip(),e.isAlive()&&o&&o.eventDestroyFuncs.length&&o.eventDestroyFuncs.forEach(function(e){return e()}),delete this.registeredComponents[t]},e.prototype.processMouseOver=function(e,t){var o=this.MOUSEOVER_SHOW_TOOLTIP_TIMEOUT;if(this.activeComponent){if(this.lastHoveredComponent===this.activeComponent)return;o=200}else if(this.showTimeoutId&&this.lastHoveredComponent===t)return;this.clearTimers(this.HIDE_SHOW_ONLY),this.lastHoveredComponent!==t&&(this.lastHoveredComponent=t,this.lastMouseEvent=e,this.showTimeoutId=window.setTimeout(this.showTooltip.bind(this),o,e))},e.prototype.processMouseOut=function(e){var t=this.activeComponent,o=e.relatedTarget;if(t){if(!t.getGui().contains(o)){var i=this.registeredComponents[t.getCompId()];utils_1._.addCssClass(i.tooltipComp.getGui(),"ag-tooltip-hiding"),this.lastHoveredComponent=void 0,this.clearTimers(),this.hideTimeoutId=window.setTimeout(this.hideTooltip.bind(this),this.MOUSEOUT_HIDE_TOOLTIP_TIMEOUT)}}else{if(this.lastHoveredComponent){var r=this.lastHoveredComponent.getGui().contains(o);if(this.showTimeoutId&&r)return;r||(this.lastHoveredComponent=void 0)}this.clearTimers()}},e.prototype.processMouseMove=function(e){this.lastMouseEvent=e},e.prototype.showTooltip=function(e){var t=this.lastHoveredComponent,o=t,i=this.registeredComponents[t.getCompId()];this.hideTooltip();var r={api:this.gridApi,columnApi:this.columnApi,colDef:t.getComponentHolder(),column:o.getColumn&&o.getColumn(),context:this.gridOptionsWrapper.getContext(),rowIndex:o.getCellPosition&&o.getCellPosition().rowIndex,value:t.getTooltipText()};this.createTooltipComponent(r,i,e)},e.prototype.createTooltipComponent=function(e,i,t){var r=this;this.userComponentFactory.newTooltipComponent(e).then(function(e){if(i){var t=(i.tooltipComp=e).getGui();utils_1._.containsClass(t,"ag-tooltip")||utils_1._.addCssClass(t,"ag-tooltip-custom");var o=r.popupService.addPopup(!1,t,!1);i.destroyFunc=function(){o(),e.destroy&&e.destroy()},r.popupService.positionPopupUnderMouseEvent({type:"tooltip",mouseEvent:r.lastMouseEvent,ePopup:t,nudgeY:18}),r.activeComponent=r.lastHoveredComponent,r.hideTimeoutId=window.setTimeout(r.hideTooltip.bind(r),r.DEFAULT_HIDE_TOOLTIP_TIMEOUT)}})},e.prototype.hideTooltip=function(){var e=this.activeComponent;if(this.clearTimers(),e){var t=e.getCompId(),o=this.registeredComponents[t];this.activeComponent=void 0,o&&(o.destroyFunc&&o.destroyFunc(),this.clearRegisteredComponent(o))}},e.prototype.clearRegisteredComponent=function(e){delete e.destroyFunc,delete e.tooltipComp},e.prototype.clearTimers=function(e){void 0===e&&(e=!1),this.hideTimeoutId&&!e&&(window.clearTimeout(this.hideTimeoutId),this.hideTimeoutId=0),this.showTimeoutId&&(window.clearTimeout(this.showTimeoutId),this.showTimeoutId=0)},__decorate([context_1.Autowired("popupService"),__metadata("design:type",popupService_1.PopupService)],e.prototype,"popupService",void 0),__decorate([context_1.Autowired("userComponentFactory"),__metadata("design:type",userComponentFactory_1.UserComponentFactory)],e.prototype,"userComponentFactory",void 0),__decorate([context_1.Autowired("columnApi"),__metadata("design:type",columnApi_1.ColumnApi)],e.prototype,"columnApi",void 0),__decorate([context_1.Autowired("gridApi"),__metadata("design:type",gridApi_1.GridApi)],e.prototype,"gridApi",void 0),__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),e=__decorate([context_1.Bean("tooltipManager")],e)}();exports.TooltipManager=TooltipManager;