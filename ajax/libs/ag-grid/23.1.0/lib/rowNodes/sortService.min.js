"use strict";var __decorate=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,a=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,o);else for(var l=e.length-1;0<=l;l--)(n=e[l])&&(a=(i<3?n(a):3<i?n(t,r,a):n(t,r))||a);return 3<i&&a&&Object.defineProperty(t,r,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var context_1=require("../context/context"),sortController_1=require("../sortController"),valueService_1=require("../valueService/valueService"),gridOptionsWrapper_1=require("../gridOptionsWrapper"),columnController_1=require("../columnController/columnController"),utils_1=require("../utils"),SortService=function(){function e(){}return e.prototype.init=function(){this.postSortFunc=this.gridOptionsWrapper.getPostSortFunc()},e.prototype.sort=function(r,o,n,i,a,l){var p=this;a.forEachChangedNodeDepthFirst(function(e){if(p.pullDownGroupDataForHideOpenParents(e.childrenAfterFilter,!0),o){var t=n?p.doDeltaSort(e,r,i,a,l):p.doFullSort(e,r);e.childrenAfterSort=t.map(function(e){return e.rowNode})}else e.childrenAfterSort=e.childrenAfterFilter.slice(0);p.updateChildIndexes(e),p.postSortFunc&&p.postSortFunc(e.childrenAfterSort)}),this.updateGroupDataForHiddenOpenParents(a)},e.prototype.doFullSort=function(e,t){var r=e.childrenAfterFilter.map(this.mapNodeToSortedNode.bind(this));return r.sort(this.compareRowNodes.bind(this,t)),r},e.prototype.mapNodeToSortedNode=function(e,t){return{currentPos:t,rowNode:e}},e.prototype.doDeltaSort=function(e,t,o,n,i){var r=e.childrenAfterSort.filter(function(e){var t=!o[e.id],r=i||n.canSkip(e);return t&&r}).map(this.mapNodeToSortedNode.bind(this)),a={};r.forEach(function(e){return a[e.rowNode.id]=e.rowNode});var l=e.childrenAfterFilter.filter(function(e){return!a[e.id]}).map(this.mapNodeToSortedNode.bind(this));return l.sort(this.compareRowNodes.bind(this,t)),0===l.length?r:0===r.length?l:this.mergeSortedArrays(t,r,l)},e.prototype.mergeSortedArrays=function(e,t,r){for(var o=[],n=0,i=0;n<t.length&&i<r.length;){this.compareRowNodes(e,t[n],r[i])<0?o.push(t[n++]):o.push(r[i++])}for(;n<t.length;)o.push(t[n++]);for(;i<r.length;)o.push(r[i++]);return o},e.prototype.compareRowNodes=function(e,t,r){for(var o=t.rowNode,n=r.rowNode,i=0,a=e.length;i<a;i++){var l=e[i],p=-1===l.inverter,d=this.getValue(o,l.column),u=this.getValue(n,l.column),s=void 0;if(0!==(s=l.column.getColDef().comparator?l.column.getColDef().comparator(d,u,o,n,p):utils_1._.defaultComparator(d,u,this.gridOptionsWrapper.isAccentedSort())))return s*l.inverter}return t.currentPos-r.currentPos},e.prototype.getValue=function(e,t){return this.valueService.getValue(t,e)},e.prototype.updateChildIndexes=function(e){if(!utils_1._.missing(e.childrenAfterSort))for(var t=e.childrenAfterSort,r=0;r<t.length;r++){var o=t[r],n=0===r,i=r===e.childrenAfterSort.length-1;o.setFirstChild(n),o.setLastChild(i),o.setChildIndex(r)}},e.prototype.updateGroupDataForHiddenOpenParents=function(e){var t=this;if(this.gridOptionsWrapper.isGroupHideOpenParents()){var r=function(e){t.pullDownGroupDataForHideOpenParents(e.childrenAfterSort,!1),e.childrenAfterSort.forEach(function(e){e.hasChildren()&&r(e)})};e.executeFromRootNode(function(e){return r(e)})}},e.prototype.pullDownGroupDataForHideOpenParents=function(e,a){var l=this;utils_1._.missing(e)||this.gridOptionsWrapper.isGroupHideOpenParents()&&e.forEach(function(i){l.columnController.getGroupDisplayColumns().forEach(function(e){var t=e.getColDef().showRowGroup;if("string"==typeof t){var r=t,o=l.columnController.getPrimaryColumn(r);if(!(o===i.rowGroupColumn))if(a)i.setGroupValue(e.getId(),null);else{var n=i.getFirstChildOfFirstChild(o);n&&i.setGroupValue(e.getId(),n.key)}}else console.error("ag-Grid: groupHideOpenParents only works when specifying specific columns for colDef.showRowGroup")})})},__decorate([context_1.Autowired("sortController"),__metadata("design:type",sortController_1.SortController)],e.prototype,"sortController",void 0),__decorate([context_1.Autowired("columnController"),__metadata("design:type",columnController_1.ColumnController)],e.prototype,"columnController",void 0),__decorate([context_1.Autowired("valueService"),__metadata("design:type",valueService_1.ValueService)],e.prototype,"valueService",void 0),__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.PostConstruct,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],e.prototype,"init",null),e=__decorate([context_1.Bean("sortService")],e)}();exports.SortService=SortService;