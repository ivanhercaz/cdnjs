"use strict";var __decorate=this&&this.__decorate||function(e,t,r,i){var o,n=arguments.length,l=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,r,i);else for(var s=e.length-1;0<=s;s--)(o=e[s])&&(l=(n<3?o(l):3<n?o(t,r,l):o(t,r))||l);return 3<n&&l&&Object.defineProperty(t,r,l),l},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var utils_1=require("../utils"),gridOptionsWrapper_1=require("../gridOptionsWrapper"),popupService_1=require("../widgets/popupService"),valueService_1=require("../valueService/valueService"),columnController_1=require("../columnController/columnController"),columnApi_1=require("../columnController/columnApi"),context_1=require("../context/context"),eventService_1=require("../eventService"),events_1=require("../events"),gridApi_1=require("../gridApi"),userComponentFactory_1=require("../components/framework/userComponentFactory"),FilterManager=function(){function e(){this.allFilters={},this.quickFilter=null,this.quickFilterParts=null,this.processingFilterChange=!1}var t;return(t=e).prototype.registerGridCore=function(e){this.gridCore=e},e.prototype.init=function(){this.eventService.addEventListener(events_1.Events.EVENT_ROW_DATA_CHANGED,this.onNewRowsLoaded.bind(this)),this.eventService.addEventListener(events_1.Events.EVENT_NEW_COLUMNS_LOADED,this.onNewColumnsLoaded.bind(this)),this.quickFilter=this.parseQuickFilter(this.gridOptionsWrapper.getQuickFilterText()),this.setQuickFilterParts(),this.allowShowChangeAfterFilter=this.gridOptionsWrapper.isAllowShowChangeAfterFilter(),this.checkExternalFilter()},e.prototype.setQuickFilterParts=function(){this.quickFilter?this.quickFilterParts=this.quickFilter.split(" "):this.quickFilterParts=null},e.prototype.setFilterModel=function(i){var o=this,n=[];if(i){var l=Object.keys(i);utils_1._.iterateObject(this.allFilters,function(e,t){utils_1._.removeFromArray(l,e);var r=i[e];o.setModelOnFilterWrapper(t.filterPromise,r),n.push(t.filterPromise)}),utils_1._.iterateArray(l,function(e){var t=o.columnController.getPrimaryColumn(e);if(t){var r=o.getOrCreateFilterWrapper(t,"NO_UI");o.setModelOnFilterWrapper(r.filterPromise,i[e]),n.push(r.filterPromise)}else console.warn("Warning ag-grid setFilterModel - no column found for colId "+e)})}else utils_1._.iterateObject(this.allFilters,function(e,t){o.setModelOnFilterWrapper(t.filterPromise,null),n.push(t.filterPromise)});utils_1.Promise.all(n).then(function(e){o.onFilterChanged()})},e.prototype.setModelOnFilterWrapper=function(e,t){e.then(function(e){"function"==typeof e.setModel?e.setModel(t):console.warn("Warning ag-grid - filter missing setModel method, which is needed for setFilterModel")})},e.prototype.getFilterModel=function(){var o={};return utils_1._.iterateObject(this.allFilters,function(e,t){var r=t.filterPromise.resolveNow(null,function(e){return e});if(null==r)return null;if("function"==typeof r.getModel){var i=r.getModel();utils_1._.exists(i)&&(o[e]=i)}else console.warn("Warning ag-grid - filter API missing getModel method, which is needed for getFilterModel")}),o},e.prototype.isAdvancedFilterPresent=function(){return this.advancedFilterPresent},e.prototype.setAdvancedFilterPresent=function(){var r=!1;utils_1._.iterateObject(this.allFilters,function(e,t){t.filterPromise.resolveNow(!1,function(e){return e.isFilterActive()})&&(r=!0)}),this.advancedFilterPresent=r},e.prototype.updateFilterFlagInColumns=function(i,o){utils_1._.iterateObject(this.allFilters,function(e,t){var r=t.filterPromise.resolveNow(!1,function(e){return e.isFilterActive()});t.column.setFilterActive(r,i,o)})},e.prototype.isAnyFilterPresent=function(){return this.isQuickFilterPresent()||this.advancedFilterPresent||this.externalFilterPresent},e.prototype.doesFilterPass=function(e,t){for(var r=e.data,i=Object.keys(this.allFilters),o=0,n=i.length;o<n;o++){var l=i[o],s=this.allFilters[l];if(void 0!==s){var a=s.filterPromise.resolveNow(void 0,function(e){return e});if(void 0!==a&&a!==t&&a.isFilterActive()){a.doesFilterPass||console.error("Filter is missing method doesFilterPass");var c={node:e,data:r};if(!a.doesFilterPass(c))return!1}}}return!0},e.prototype.parseQuickFilter=function(e){return utils_1._.missing(e)||""===e?null:this.gridOptionsWrapper.isRowModelDefault()?e.toUpperCase():(console.warn("ag-grid: quick filtering only works with the Client-side Row Model"),null)},e.prototype.setQuickFilter=function(e){var t=this.parseQuickFilter(e);this.quickFilter!==t&&(this.quickFilter=t,this.setQuickFilterParts(),this.onFilterChanged())},e.prototype.checkExternalFilter=function(){this.externalFilterPresent=this.gridOptionsWrapper.isExternalFilterPresent()},e.prototype.onFilterChanged=function(e){this.setAdvancedFilterPresent(),this.updateFilterFlagInColumns("filterChanged",e),this.checkExternalFilter(),utils_1._.iterateObject(this.allFilters,function(e,t){t.filterPromise.then(function(e){e.onAnyFilterChanged&&e.onAnyFilterChanged()})});var t={type:events_1.Events.EVENT_FILTER_CHANGED,api:this.gridApi,columnApi:this.columnApi};e&&utils_1._.mergeDeep(t,e),this.processingFilterChange=!0,this.eventService.dispatchEvent(t),this.processingFilterChange=!1},e.prototype.isSuppressFlashingCellsBecauseFiltering=function(){return!this.allowShowChangeAfterFilter&&this.processingFilterChange},e.prototype.isQuickFilterPresent=function(){return null!==this.quickFilter},e.prototype.doesRowPassOtherFilters=function(e,t){return this.doesRowPassFilter(t,e)},e.prototype.doesRowPassQuickFilterNoCache=function(r,i){var o=this,e=this.columnController.getAllColumnsForQuickFilter(),n=!1;return e.forEach(function(e){if(!n){var t=o.getQuickFilterTextForColumn(e,r);utils_1._.exists(t)&&0<=t.indexOf(i)&&(n=!0)}}),n},e.prototype.doesRowPassQuickFilterCache=function(e,t){return e.quickFilterAggregateText||this.aggregateRowForQuickFilter(e),0<=e.quickFilterAggregateText.indexOf(t)},e.prototype.doesRowPassQuickFilter=function(t){var r=this,i=!0,o=this.gridOptionsWrapper.isCacheQuickFilter();return this.quickFilterParts.forEach(function(e){(o?r.doesRowPassQuickFilterCache(t,e):r.doesRowPassQuickFilterNoCache(t,e))||(i=!1)}),i},e.prototype.doesRowPassFilter=function(e,t){return!(this.isQuickFilterPresent()&&!this.doesRowPassQuickFilter(e))&&(!(this.externalFilterPresent&&!this.gridOptionsWrapper.doesExternalFilterPass(e))&&!(this.advancedFilterPresent&&!this.doesFilterPass(e,t)))},e.prototype.getQuickFilterTextForColumn=function(e,t){var r,i=this.valueService.getValue(e,t,!0),o=e.getColDef();if(e.getColDef().getQuickFilterText){var n={value:i,node:t,data:t.data,column:e,colDef:o,context:this.gridOptionsWrapper.getContext()};r=e.getColDef().getQuickFilterText(n)}else r=i;return utils_1._.exists(r)?r.toString().toUpperCase():null},e.prototype.aggregateRowForQuickFilter=function(r){var i=this,o=[];this.columnController.getAllColumnsForQuickFilter().forEach(function(e){var t=i.getQuickFilterTextForColumn(e,r);utils_1._.exists(t)&&o.push(t)}),r.quickFilterAggregateText=o.join(t.QUICK_FILTER_SEPARATOR)},e.prototype.onNewRowsLoaded=function(e){utils_1._.iterateObject(this.allFilters,function(e,t){t.filterPromise.then(function(e){e.onNewRowsLoaded&&e.onNewRowsLoaded()})}),this.updateFilterFlagInColumns(e),this.setAdvancedFilterPresent()},e.prototype.createValueGetter=function(t){var r=this;return function(e){return r.valueService.getValue(t,e,!0)}},e.prototype.getFilterComponent=function(e,t){return this.getOrCreateFilterWrapper(e,t).filterPromise},e.prototype.isFilterActive=function(e){var t=this.cachedFilter(e);return!!t&&t.filterPromise.resolveNow(!1,function(e){return e.isFilterActive()})},e.prototype.getOrCreateFilterWrapper=function(e,t){var r=this.cachedFilter(e);return r?"NO_UI"!==t&&this.putIntoGui(r,t):(r=this.createFilterWrapper(e,t),this.allFilters[e.getColId()]=r),r},e.prototype.cachedFilter=function(e){return this.allFilters[e.getColId()]},e.prototype.createFilterInstance=function(t,e){var r=this,i="agTextColumnFilter";this.gridOptionsWrapper.isEnterprise()&&(i="agSetColumnFilter");var o,n=utils_1._.cloneObject(t.getColDef()),l=this.createFilterParams(t,n,e);l.filterChangedCallback=this.onFilterChanged.bind(this),l.filterModifiedCallback=function(){var e={type:events_1.Events.EVENT_FILTER_MODIFIED,api:r.gridApi,columnApi:r.columnApi,column:t,filterInstance:o};r.eventService.dispatchEvent(e)};var s=this.userComponentFactory.newFilterComponent(n,l,i,function(e,t){return utils_1._.assign(e,{doesRowPassOtherFilter:r.doesRowPassOtherFilters.bind(r,t)})});return s.then(function(e){return o=e}),s},e.prototype.createFilterParams=function(e,t,r){void 0===r&&(r=null);var i={api:this.gridOptionsWrapper.getApi(),column:e,colDef:t,rowModel:this.rowModel,filterChangedCallback:null,filterModifiedCallback:null,valueGetter:this.createValueGetter(e),context:this.gridOptionsWrapper.getContext(),doesRowPassOtherFilter:null};return r&&(i.$scope=r),i},e.prototype.createFilterWrapper=function(e,t){var r={column:e,filterPromise:null,scope:null,compiledElement:null,guiPromise:utils_1.Promise.external()};return r.scope=this.gridOptionsWrapper.isAngularCompileFilters()?this.$scope.$new():null,r.filterPromise=this.createFilterInstance(e,r.scope),this.putIntoGui(r,t),r},e.prototype.putIntoGui=function(i,o){var n=this,l=document.createElement("div");l.className="ag-filter",i.filterPromise.then(function(e){var t=e.getGui();if(utils_1._.missing(t)&&console.warn("getGui method from filter returned "+t+", it should be a DOM element or an HTML template string."),"string"==typeof t&&(t=utils_1._.loadTemplate(t)),l.appendChild(t),i.scope){var r=n.$compile(l)(i.scope);i.compiledElement=r,window.setTimeout(function(){return i.scope.$apply()},0)}i.guiPromise.resolve(l),n.eventService.dispatchEvent({type:events_1.Events.EVENT_FILTER_OPENED,column:i.column,source:o,eGui:l,api:n.gridApi,columnApi:n.columnApi})})},e.prototype.onNewColumnsLoaded=function(){var r=this,i=!1;utils_1._.iterateObject(this.allFilters,function(e,t){r.columnController.getPrimaryColumn(t.column)||(i=!0,r.disposeFilterWrapper(t,"filterDestroyed"))}),i&&this.onFilterChanged()},e.prototype.destroyFilter=function(e,t){void 0===t&&(t="api");var r=this.allFilters[e.getColId()];r&&(this.disposeFilterWrapper(r,t),this.onFilterChanged())},e.prototype.disposeFilterWrapper=function(t,r){var i=this;t.filterPromise.then(function(e){e.setModel(null),e.destroy&&e.destroy(),t.column.setFilterActive(!1,r),t.scope&&(t.compiledElement&&t.compiledElement.remove(),t.scope.$destroy()),delete i.allFilters[t.column.getColId()]})},e.prototype.destroy=function(){var r=this;utils_1._.iterateObject(this.allFilters,function(e,t){r.disposeFilterWrapper(t,"filterDestroyed")})},e.QUICK_FILTER_SEPARATOR="\n",__decorate([context_1.Autowired("$compile"),__metadata("design:type",Object)],e.prototype,"$compile",void 0),__decorate([context_1.Autowired("$scope"),__metadata("design:type",Object)],e.prototype,"$scope",void 0),__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.Autowired("popupService"),__metadata("design:type",popupService_1.PopupService)],e.prototype,"popupService",void 0),__decorate([context_1.Autowired("valueService"),__metadata("design:type",valueService_1.ValueService)],e.prototype,"valueService",void 0),__decorate([context_1.Autowired("columnController"),__metadata("design:type",columnController_1.ColumnController)],e.prototype,"columnController",void 0),__decorate([context_1.Autowired("rowModel"),__metadata("design:type",Object)],e.prototype,"rowModel",void 0),__decorate([context_1.Autowired("eventService"),__metadata("design:type",eventService_1.EventService)],e.prototype,"eventService",void 0),__decorate([context_1.Autowired("enterprise"),__metadata("design:type",Boolean)],e.prototype,"enterprise",void 0),__decorate([context_1.Autowired("context"),__metadata("design:type",context_1.Context)],e.prototype,"context",void 0),__decorate([context_1.Autowired("columnApi"),__metadata("design:type",columnApi_1.ColumnApi)],e.prototype,"columnApi",void 0),__decorate([context_1.Autowired("gridApi"),__metadata("design:type",gridApi_1.GridApi)],e.prototype,"gridApi",void 0),__decorate([context_1.Autowired("userComponentFactory"),__metadata("design:type",userComponentFactory_1.UserComponentFactory)],e.prototype,"userComponentFactory",void 0),__decorate([context_1.PostConstruct,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],e.prototype,"init",null),__decorate([context_1.PreDestroy,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],e.prototype,"destroy",null),e=t=__decorate([context_1.Bean("filterManager")],e)}();exports.FilterManager=FilterManager;