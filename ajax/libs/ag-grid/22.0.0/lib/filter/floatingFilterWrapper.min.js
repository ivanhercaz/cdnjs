"use strict";var __extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])})(t,e)};return function(t,e){function o(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}}(),__decorate=this&&this.__decorate||function(t,e,o,n){var i,r=arguments.length,a=r<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,o,n);else for(var l=t.length-1;0<=l;l--)(i=t[l])&&(a=(r<3?i(a):3<r?i(e,o,a):i(e,o))||a);return 3<r&&a&&Object.defineProperty(e,o,a),a},__metadata=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};Object.defineProperty(exports,"__esModule",{value:!0});var context_1=require("../context/context"),column_1=require("../entities/column"),setLeftFeature_1=require("../rendering/features/setLeftFeature"),floatingFilter_1=require("./floatingFilter"),component_1=require("../widgets/component"),componentAnnotations_1=require("../widgets/componentAnnotations"),gridOptionsWrapper_1=require("../gridOptionsWrapper"),beans_1=require("../rendering/beans"),hoverFeature_1=require("../headerRendering/hoverFeature"),events_1=require("../events"),eventService_1=require("../eventService"),columnHoverService_1=require("../rendering/columnHoverService"),utils_1=require("../utils"),userComponentFactory_1=require("../components/framework/userComponentFactory"),gridApi_1=require("../gridApi"),columnApi_1=require("../columnController/columnApi"),filterManager_1=require("./filterManager"),FloatingFilterWrapper=function(o){function s(t){var e=o.call(this,s.TEMPLATE)||this;return e.column=t,e}return __extends(s,o),s.prototype.postConstruct=function(){this.setupFloatingFilter(),this.setupWidth(),this.setupLeftPositioning(),this.setupColumnHover(),this.addFeature(this.getContext(),new hoverFeature_1.HoverFeature([this.column],this.getGui())),this.addDestroyableEventListener(this.eButtonShowMainFilter,"click",this.showParentFilter.bind(this))},s.prototype.setupFloatingFilter=function(){var e=this;this.column.getColDef().filter?(this.floatingFilterCompPromise=this.getFloatingFilterInstance(),this.floatingFilterCompPromise?this.floatingFilterCompPromise.then(function(t){t?e.setupWithFloatingFilter(t):e.setupEmpty()}):this.setupEmpty(),this.setupSyncWithFilter()):this.setupEmpty()},s.prototype.setupLeftPositioning=function(){var t=new setLeftFeature_1.SetLeftFeature(this.column,this.getGui(),this.beans);t.init(),this.addDestroyFunc(t.destroy.bind(t))},s.prototype.setupSyncWithFilter=function(){function t(){var t=e.filterManager.getFilterComponent(e.column,"NO_UI");e.onParentModelChanged(t.resolveNow(null,function(t){return t.getModel()}))}var e=this;this.addDestroyableEventListener(this.column,column_1.Column.EVENT_FILTER_CHANGED,t),this.filterManager.cachedFilter(this.column)&&t()},s.prototype.showParentFilter=function(){this.menuFactory.showMenuAfterButtonClick(this.column,this.eButtonShowMainFilter,"filterMenuTab",["filterMenuTab"])},s.prototype.setupColumnHover=function(){this.addDestroyableEventListener(this.eventService,events_1.Events.EVENT_COLUMN_HOVER_CHANGED,this.onColumnHover.bind(this)),this.onColumnHover()},s.prototype.onColumnHover=function(){var t=this.columnHoverService.isHovered(this.column);utils_1._.addOrRemoveCssClass(this.getGui(),"ag-column-hover",t)},s.prototype.setupWidth=function(){this.addDestroyableEventListener(this.column,column_1.Column.EVENT_WIDTH_CHANGED,this.onColumnWidthChanged.bind(this)),this.onColumnWidthChanged()},s.prototype.onColumnWidthChanged=function(){this.getGui().style.width=this.column.getActualWidth()+"px"},s.prototype.setupWithFloatingFilter=function(t){function e(){t.destroy&&t.destroy()}if(this.isAlive()){this.addDestroyFunc(e);var o=t.getGui();utils_1._.addOrRemoveCssClass(this.eFloatingFilterBody,"ag-floating-filter-body",!this.suppressFilterButton),utils_1._.addOrRemoveCssClass(this.eFloatingFilterBody,"ag-floating-filter-full-body",this.suppressFilterButton),utils_1._.setVisible(this.eButtonWrapper,!this.suppressFilterButton);var n=utils_1._.createIconNoSpan("filter",this.gridOptionsWrapper,this.column);this.eButtonShowMainFilter.appendChild(n),this.eFloatingFilterBody.appendChild(o),t.afterGuiAttached&&t.afterGuiAttached(),this.wireQuerySelectors()}else e()},s.prototype.getFloatingFilterInstance=function(){var t,e=this,o=this.column.getColDef();"string"==typeof o.filter?t=s.filterToFloatingFilterNames[o.filter]:!0===o.filter&&(t=this.gridOptionsWrapper.isEnterprise()?"agSetColumnFloatingFilter":"agTextColumnFloatingFilter");var n={api:this.gridApi,column:this.column,currentParentModel:this.currentParentModel.bind(this),onFloatingFilterChanged:this.onFloatingFilterChanged.bind(this),suppressFilterButton:!1};this.suppressFilterButton=!!o.floatingFilterComponentParams&&!!o.floatingFilterComponentParams.suppressFilterButton;var i=this.userComponentFactory.newFloatingFilterComponent(o,n,t);if(!i){var r=this.getFilterComponentPrototype(o);if(r&&r.prototype&&r.prototype.getModelAsString){var a=n.currentParentModel;n.currentParentModel=function(){return e.filterManager.getFilterComponent(e.column,"NO_UI").resolveNow(null,function(t){return t.getModelAsString?t.getModelAsString(a()):null})};var l=this.userComponentFactory.createUserComponentFromConcreteClass(floatingFilter_1.ReadModelAsStringFloatingFilterComp,n);i=utils_1.Promise.resolve(l)}}return i},s.prototype.createDynamicParams=function(){return{column:this.column,colDef:this.column.getColDef(),api:this.gridApi,columnApi:this.columnApi}},s.prototype.getFilterComponentPrototype=function(t){var e=this.userComponentFactory.lookupComponentClassDef(t,"filter",this.createDynamicParams());return e?e.component:null},s.prototype.setupEmpty=function(){utils_1._.setVisible(this.eButtonWrapper,!1)},s.prototype.currentParentModel=function(){var t=this.filterManager.getFilterComponent(this.column,"NO_UI").resolveNow(null,function(t){return t.getNullableModel?t.getNullableModel():t.getModel()});return t&&null!=t.operator?t.condition1:t},s.prototype.onFloatingFilterChanged=function(o){var n,i=this,t=new utils_1.Promise(function(t){n=t});return this.filterManager.getFilterComponent(this.column,"NO_UI").then(function(t){if(t.onFloatingFilterChanged){var e=t.onFloatingFilterChanged(o);n(e)}else t.setModel(o),i.filterManager.onFilterChanged(),n(!0)}),t.resolveNow(!0,function(t){return t})},s.prototype.onParentModelChanged=function(t){if(this.floatingFilterCompPromise){var e,o=null;o=t&&t.operator?(e=t).condition1:t,this.floatingFilterCompPromise.then(function(t){t.onParentModelChanged(o,e)})}},s.filterToFloatingFilterNames={set:"agSetColumnFloatingFilter",agSetColumnFilter:"agSetColumnFloatingFilter",number:"agNumberColumnFloatingFilter",agNumberColumnFilter:"agNumberColumnFloatingFilter",date:"agDateColumnFloatingFilter",agDateColumnFilter:"agDateColumnFloatingFilter",text:"agTextColumnFloatingFilter",agTextColumnFilter:"agTextColumnFloatingFilter"},s.TEMPLATE='<div class="ag-header-cell" aria-hidden="true">\n            <div ref="eFloatingFilterBody" aria-hidden="true"></div>\n            <div class="ag-floating-filter-button" ref="eButtonWrapper" aria-hidden="true">\n                    <button type="button" ref="eButtonShowMainFilter"></button>\n            </div>\n        </div>',__decorate([context_1.Autowired("columnHoverService"),__metadata("design:type",columnHoverService_1.ColumnHoverService)],s.prototype,"columnHoverService",void 0),__decorate([context_1.Autowired("eventService"),__metadata("design:type",eventService_1.EventService)],s.prototype,"eventService",void 0),__decorate([context_1.Autowired("beans"),__metadata("design:type",beans_1.Beans)],s.prototype,"beans",void 0),__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],s.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.Autowired("userComponentFactory"),__metadata("design:type",userComponentFactory_1.UserComponentFactory)],s.prototype,"userComponentFactory",void 0),__decorate([context_1.Autowired("gridApi"),__metadata("design:type",gridApi_1.GridApi)],s.prototype,"gridApi",void 0),__decorate([context_1.Autowired("columnApi"),__metadata("design:type",columnApi_1.ColumnApi)],s.prototype,"columnApi",void 0),__decorate([context_1.Autowired("filterManager"),__metadata("design:type",filterManager_1.FilterManager)],s.prototype,"filterManager",void 0),__decorate([context_1.Autowired("menuFactory"),__metadata("design:type",Object)],s.prototype,"menuFactory",void 0),__decorate([componentAnnotations_1.RefSelector("eFloatingFilterBody"),__metadata("design:type",HTMLElement)],s.prototype,"eFloatingFilterBody",void 0),__decorate([componentAnnotations_1.RefSelector("eButtonWrapper"),__metadata("design:type",HTMLElement)],s.prototype,"eButtonWrapper",void 0),__decorate([componentAnnotations_1.RefSelector("eButtonShowMainFilter"),__metadata("design:type",HTMLElement)],s.prototype,"eButtonShowMainFilter",void 0),__decorate([context_1.PostConstruct,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],s.prototype,"postConstruct",null),s}(component_1.Component);exports.FloatingFilterWrapper=FloatingFilterWrapper;