import{isObject,isArray,toArray,isString,splitComma,splitSpace,RGBA,splitBracket,COLOR_MODELS,stringToRGBA,$,document,IS_WINDOW,ANIMATION,removeEvent,addEvent,OBJECT,ARRAY,PROPERTY,STRING,NUMBER,requestAnimationFrame,cancelAnimationFrame,splitUnit,camelize,isUndefined,TRANSFORM,FILTER,FUNCTION,dot as dot$1,isFunction,fromCSS,findIndex,find,KEYFRAMES,addClass,removeClass,hasClass,decamelize}from"@daybrush/utils";import ListMap from"list-map";var extendStatics=function(t,e){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};function __extends(t,e){function i(){this.constructor=t}extendStatics(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}function __decorate(t,e,i,r){var n,s=arguments.length,a=s<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,r);else for(var o=t.length-1;o>=0;o--)(n=t[o])&&(a=(s<3?n(a):s>3?n(e,i,a):n(e,i))||a);return s>3&&a&&Object.defineProperty(e,i,a),a}function cubic(t,e,i){var r=1-i;return i*i*i+3*i*i*r*e+3*i*r*r*t}function solveFromX(t,e,i){for(var r=i,n=1;Math.abs(n)>.001;){if(n=cubic(t,e,r)-i,Math.abs(n)<.001)return r;r-=n/2}return r}function bezier(t,e,i,r){var n=function(n){var s=solveFromX(t,i,Math.max(Math.min(1,n),0));return cubic(e,r,s)};return n.easingName="cubic-bezier("+t+","+e+","+i+","+r+")",n}function steps(t,e){var i=function(i){var r=1/t;return i>=1?1:("start"===e?r:0)+Math.floor(i/r)*r};return i.easingName="steps("+t+", "+e+")",i}var _a,STEP_START=steps(1,"start"),STEP_END=steps(1,"end"),LINEAR=bezier(0,0,1,1),EASE=bezier(.25,.1,.25,1),EASE_IN=bezier(.42,0,1,1),EASE_OUT=bezier(0,0,.58,1),EASE_IN_OUT=bezier(.42,0,.58,1),PREFIX="__SCENEJS_",DATA_SCENE_ID="data-scene-id",TIMING_FUNCTION="animation-timing-function",ROLES={transform:{},filter:{},attribute:{}},ALIAS={easing:[TIMING_FUNCTION]},FIXED=((_a={})[TIMING_FUNCTION]=!0,_a.contents=!0,_a),MAXIMUM=1e6,THRESHOLD=1e-6,DURATION="duration",FILL_MODE="fillMode",DIRECTION="direction",ITERATION_COUNT="iterationCount",DELAY="delay",EASING="easing",PLAY_SPEED="playSpeed",EASING_NAME="easingName",ITERATION_TIME="iterationTime",PAUSED="paused",ENDED="ended",TIMEUPDATE="timeupdate",ANIMATE="animate",PLAY="play",RUNNING="running",ITERATION="iteration",START_ANIMATION="startAnimation",PAUSE_ANIMATION="pauseAnimation",ALTERNATE="alternate",REVERSE="reverse",ALTERNATE_REVERSE="alternate-reverse",NORMAL="normal",INFINITE="infinite",PLAY_STATE="playState",PLAY_CSS="playCSS",PREV_TIME="prevTime",TICK_TIME="tickTime",CURRENT_TIME="currentTime",SELECTOR="selector",TRANSFORM_NAME="transform",EASINGS={linear:LINEAR,ease:EASE,"ease-in":EASE_IN,"ease-out":EASE_OUT,"ease-in-out":EASE_IN_OUT,"step-start":STEP_START,"step-end":STEP_END},OPTIONS=[DURATION,FILL_MODE,DIRECTION,ITERATION_COUNT,DELAY,EASING,PLAY_SPEED],EVENTS=[PAUSED,ENDED,TIMEUPDATE,ANIMATE,PLAY,ITERATION],EventTrigger=function(){function t(){this.events={}}var e=t.prototype;return e._on=function(t,e,i){var r=this,n=this.events;if(isObject(t))for(var s in t)this._on(s,t[s],i);else t in n||(n[t]=[]),e&&(isArray(e)?e.forEach(function(e){return r._on(t,e,i)}):n[t].push(i?function i(){for(var r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];e.apply(void 0,r),this.off(t,i)}:e))},e.on=function(t,e){return this._on(t,e),this},e.off=function(t,e){if(t)if(e){var i=this.events[t];if(!i)return this;var r=i.indexOf(e);-1!==r&&i.splice(r,1)}else this.events[t]=[];else this.events={};return this},e.trigger=function(t){for(var e=this,i=[],r=1;r<arguments.length;r++)i[r-1]=arguments[r];var n=this.events;if(!(t in n))return this;var s=i||[];!s[0]&&(s[0]={});n[t];var a=s[0];return a.type=t,a.currentTarget=this,!a.target&&(a.target=this),toArray(n[t]).forEach(function(t){t.apply(e,i)}),this},e.once=function(t,e){return this._on(t,e,!0),this},t}(),PropertyObject=function(){function t(t,e){this.prefix="",this.suffix="",this.model="",this.type="",this.separator=",",e&&this.setOptions(e),this.value=isString(t)?t.split(this.separator):t}var e=t.prototype;return e.setOptions=function(t){for(var e in t)this[e]=t[e];return this},e.size=function(){return this.value.length},e.get=function(t){return this.value[t]},e.set=function(t,e){return this.value[t]=e,this},e.clone=function(){var e=this,i=e.separator,r=e.prefix,n=e.suffix,s=e.model,a=e.type;return new t(this.value.map(function(e){return e instanceof t?e.clone():e}),{separator:i,prefix:r,suffix:n,model:s,type:a})},e.toValue=function(){return this.prefix+this.join()+this.suffix},e.join=function(){return this.value.map(function(e){return e instanceof t?e.toValue():e}).join(this.separator)},e.forEach=function(t){return this.value.forEach(t),this},t}();function splitStyle(t){for(var e=t.split(";"),i={},r=e.length,n=0;n<r;++n){var s=/([^:]*):([\S\s]*)/g.exec(e[n]);!s||s.length<3||!s[1]?--r:i[s[1].trim()]=toPropertyObject(s[2].trim())}return{styles:i,length:r}}function arrayToColorObject(t){var e=RGBA;return 3===t.length&&(t[3]=1),new PropertyObject(t,{model:e,separator:",",type:"color",prefix:e+"(",suffix:")"})}function stringToBracketObject(t){var e=splitBracket(t),i=e.prefix,r=e.value,n=e.suffix;if(void 0===r)return t;if(-1!==COLOR_MODELS.indexOf(i))return arrayToColorObject(stringToRGBA(t));var s=toPropertyObject(r),a=[r],o=",",u=i+"(",f=")"+n;return s instanceof PropertyObject&&(o=s.separator,a=s.value,u+=s.prefix,f=s.suffix+f),new PropertyObject(a,{separator:o,model:i,prefix:u,suffix:f})}function arrayToPropertyObject(t,e){return new PropertyObject(t,{type:"array",separator:e})}function stringToColorObject(t){var e=stringToRGBA(t);return e?arrayToColorObject(e):t}function toPropertyObject(t){if(!isString(t))return isArray(t)?arrayToPropertyObject(t,","):t;var e=splitComma(t);return e.length>1?arrayToPropertyObject(e.map(function(t){return toPropertyObject(t)}),","):(e=splitSpace(t)).length>1?arrayToPropertyObject(e.map(function(t){return toPropertyObject(t)})," "):(e=/^(['"])([^'"]*)(['"])$/g.exec(t))&&e[1]===e[3]?new PropertyObject([toPropertyObject(e[2])],{prefix:e[1],suffix:e[1]}):-1!==t.indexOf("(")?stringToBracketObject(t):"#"===t.charAt(0)?stringToColorObject(t):t}function toObject(t,e){void 0===e&&(e={});var i=t.model;if(i){t.setOptions({model:"",suffix:"",prefix:""});var r=t.size()>1?t:t.get(0);e[i]=r}else t.forEach(function(t){toObject(t,e)});return e}function isPropertyObject(t){return t instanceof PropertyObject}function setAlias(t,e){ALIAS[t]=e}function setRole(t,e,i){for(var r=t.length,n=ROLES,s=FIXED,a=0;a<r-1;++a)!n[t[a]]&&(n[t[a]]={}),n=n[t[a]],i&&(!s[t[a]]&&(s[t[a]]={}),s=s[t[a]]);i&&(s[t[r-1]]=!0),n[t[r-1]]=!!e||{}}function getType(t){var e=typeof t;if(e===OBJECT){if(isArray(t))return ARRAY;if(isPropertyObject(t))return PROPERTY}else if(e===STRING||e===NUMBER)return"value";return e}function isPureObject(t){return isObject(t)&&t.constructor===Object}function getNames(t,e){var i=[];if(isPureObject(t))for(var r in t)e.push(r),i=i.concat(getNames(t[r],e)),e.pop();else i.push(e.slice());return i}function updateFrame(t,e){for(var i in e){isPureObject(e[i])?(isObject(t[i])||(t[i]={}),updateFrame(t[i],e[i])):t[i]=!0}return t}function toFixed(t){return Math.round(t*MAXIMUM)/MAXIMUM}function getValueByNames(t,e,i){void 0===i&&(i=t.length);for(var r=e,n=0;n<i;++n){if(!isObject(r))return;r=r[t[n]]}return r}function isInProperties(t,e,i){var r=e.length,n=t;if(0===r)return!1;for(var s=0;s<r;++s){if(!0===n)return!1;if(!(n=n[e[s]])||!i&&!0===n)return!1}return!0}function isRole(t,e){return isInProperties(ROLES,t,e)}function isFixed(t){return isInProperties(FIXED,t,!0)}function setPlayCSS(t,e){t.state[PLAY_CSS]=e}function isPausedCSS(t){return t.state[PLAY_CSS]&&t.isPaused()}function isEndedCSS(t){return!t.isEnded()&&t.state[PLAY_CSS]}function exportCSS(t,e){var i=PREFIX+"STYLE_"+toId(t),r=$("#"+i);r?r.innerText=e:document.body.insertAdjacentHTML("beforeend",'<style id="'+i+'">'+e+"</style>")}function makeId(t){for(;;){var e=""+Math.floor(1e7*Math.random());if(!IS_WINDOW||!t)return e;if(!$('[data-scene-id="'+e+'"]'))return e}}function getRealId(t){return t.getId()||t.setId(makeId(!1)).getId()}function toId(t){return(""+t).match(/[0-9a-zA-Z]+/g).join("")}function playCSS(t,e,i,r){if(void 0===r&&(r={}),ANIMATION&&t.getPlayState()!==RUNNING){var n=i||START_ANIMATION;if(isPausedCSS(t))t.addPlayClass(!0,n,r);else{t.isEnded()&&t.setTime(0),e&&t.exportCSS({className:n});var s=t.addPlayClass(!1,n,r);if(!s)return;addAnimationEvent(t,s),setPlayCSS(t,!0)}t.setPlayState(RUNNING)}}function addAnimationEvent(t,e){var i=t.state,r=t.getDuration(),n=!r||!isFinite(r),s=function(){setPlayCSS(t,!1),t.finish()},a=function(){t.trigger(PLAY)};t.once(ENDED,function(){removeEvent(e,"animationcancel",s),removeEvent(e,"animationend",s),removeEvent(e,"animationiteration",o),removeEvent(e,"animationstart",a)});var o=function(e){var s=e.elapsedTime,a=n?0:s/r;i[CURRENT_TIME]=s,t.setIteration(a)};addEvent(e,"animationcancel",s),addEvent(e,"animationend",s),addEvent(e,"animationiteration",o),addEvent(e,"animationstart",a)}function getEasing(t){var e;if(isString(t))if(t in EASINGS)e=EASINGS[t];else{var i=toPropertyObject(t);if(isString(i))return 0;if("cubic-bezier"===i.model)e=bezier((t=i.value.map(function(t){return parseFloat(t)}))[0],t[1],t[2],t[3]);else{if("steps"!==i.model)return 0;e=steps(parseFloat(i.value[0]),i.value[1])}}else e=isArray(t)?bezier(t[0],t[1],t[2],t[3]):t;return e}function GetterSetter(t,e,i){return function(r){var n=r.prototype;t.forEach(function(t){n[camelize("get "+t)]=function(){return this[i][t]}}),e.forEach(function(t){n[camelize("set "+t)]=function(e){return this[i][t]=e,this}})}}function isDirectionReverse(t,e,i){return i===REVERSE||(e!==INFINITE&&t===e&&e%1==0?i===(t%2>=1?ALTERNATE_REVERSE:ALTERNATE):i===(t%2>=1?ALTERNATE:ALTERNATE_REVERSE))}var setters=["id",ITERATION_COUNT,DELAY,FILL_MODE,DIRECTION,PLAY_SPEED,DURATION,PLAY_SPEED,ITERATION_TIME,PLAY_STATE],getters=setters.concat([EASING,EASING_NAME]),Animator=function(t){function e(e){var i=t.call(this)||this;return i.timerId=0,i.state={id:"",easing:0,easingName:"linear",iterationCount:1,delay:0,fillMode:"forwards",direction:NORMAL,playSpeed:1,currentTime:0,iterationTime:-1,iteration:0,tickTime:0,prevTime:0,playState:PAUSED,duration:0},i.setOptions(e),i}__extends(e,t);var i=e.prototype;return i.setEasing=function(t){var e=getEasing(t),i=e&&e[EASING_NAME]||"linear",r=this.state;return r[EASING]=e,r[EASING_NAME]=i,this},i.setOptions=function(t){for(var e in void 0===t&&(t={}),t){var i=t[e];e!==EASING?e!==DURATION?OPTIONS.indexOf(e)>-1&&(this.state[e]=i):i&&this.setDuration(i):this.setEasing(i)}return this},i.getTotalDuration=function(){return this.getActiveDuration(!0)},i.getActiveDuration=function(t){var e=this.state,i=e[ITERATION_COUNT];return i===INFINITE?1/0:(t?e[DELAY]:0)+this.getDuration()*i},i.isEnded=function(){return 0===this.state[TICK_TIME]&&this.state[PLAY_STATE]===PAUSED||!(this.getTime()<this.getActiveDuration())},i.isPaused=function(){return this.state[PLAY_STATE]===PAUSED},i.start=function(t){void 0===t&&(t=this.state[DELAY]);var e=this.state;return e[PLAY_STATE]=RUNNING,e[TICK_TIME]>=t&&(this.trigger(PLAY),!0)},i.play=function(t){var e=this,i=this.state,r=i[DELAY],n=this.getTime();return i[PLAY_STATE]=RUNNING,this.isEnded()&&(0===n||n>=this.getActiveDuration())&&this.setTime(-r,!0),i[TICK_TIME]=this.getTime(),this.timerId=requestAnimationFrame(function(r){i[PREV_TIME]=r,e.tick(r,t)}),this.start(),this},i.pause=function(){var t=this.state;return t[PLAY_STATE]!==PAUSED&&(t[PLAY_STATE]=PAUSED,this.trigger(PAUSED)),cancelAnimationFrame(this.timerId),this},i.finish=function(){return this.setTime(0),this.state[TICK_TIME]=0,this.end(),this},i.end=function(){return this.pause(),this.trigger(ENDED),this},i.setTime=function(t,e,i){var r=this.getActiveDuration(),n=this.state,s=n[TICK_TIME],a=n[DELAY],o=e?t:this.getUnitTime(t);if(n[TICK_TIME]=a+o,o<0?o=0:o>r&&(o=r),n[CURRENT_TIME]=o,this.calculate(),e&&!i){var u=n[TICK_TIME];if(s<a&&t>=0&&this.start(0),u<s||this.isEnded())return void this.end()}return this.isDelay()?this:(this.trigger(TIMEUPDATE,{currentTime:o,time:this.getIterationTime(),iterationCount:n[ITERATION]}),this)},i.getTime=function(){return this.state[CURRENT_TIME]},i.getUnitTime=function(t){if(isString(t)){var e=this.getDuration()||100;if("from"===t)return 0;if("to"===t)return e;var i=splitUnit(t),r=i.unit,n=i.value;return"%"===r?(!this.getDuration()&&this.setDuration(e),toFixed(parseFloat(t)/100*e)):">"===r?n+THRESHOLD:n}return toFixed(t)},i.isDelay=function(){var t=this.state,e=t[DELAY],i=t[TICK_TIME];return e>0&&i<e},i.setIteration=function(t){var e=this.state,i=Math.floor(t),r=e[ITERATION_COUNT]===INFINITE?1/0:e[ITERATION_COUNT];return e[ITERATION]<i&&i<r&&this.trigger("iteration",{currentTime:e[CURRENT_TIME],iterationCount:i}),e[ITERATION]=t,this},i.calculate=function(){var t=this.state,e=t[ITERATION_COUNT],i=t[FILL_MODE],r=t[DIRECTION],n=this.getDuration(),s=this.getTime(),a=0===n?0:s/n,o=n?s%n:0;if(!n)return this.setIterationTime(0),this;this.setIteration(a);var u=isDirectionReverse(a,e,r),f=isFinite(n);(f&&u&&(o=n-o),f&&e!==INFINITE)&&(a>=e&&(o=n*("both"===i||"forwards"===i?e%1||1:0),u&&(o=n-o)));return this.setIterationTime(o),this},i.tick=function(t,e){var i=this;if(!this.isPaused()){var r=this.state,n=r[PLAY_SPEED],s=r[PREV_TIME],a=r[DELAY],o=r[TICK_TIME]+Math.min(1e3,t-s)/1e3*n;r[PREV_TIME]=t,this.setTime(o-a,!0),e&&1e3*e<t&&this.pause(),r[PLAY_STATE]!==PAUSED&&(this.timerId=requestAnimationFrame(function(t){i.tick(t,e)}))}},e=__decorate([GetterSetter(getters,setters,"state")],e)}(EventTrigger);function toInnerProperties(t){if(!t)return"";var e=[];for(var i in t)e.push(i.replace(/\d$/g,"")+"("+t[i]+")");return e.join(" ")}function clone(t,e){return void 0===e&&(e=!1),merge({},t,e)}function merge(t,e,i){for(var r in void 0===i&&(i=!1),e){var n=e[r],s=getType(n);s===PROPERTY?t[r]=i?n.toValue():n.clone():s===FUNCTION?t[r]=i?getValue([r],n):n:s===ARRAY?t[r]=n.slice():s===OBJECT?isObject(t[r])&&!isPropertyObject(t[r])?merge(t[r],n,i):t[r]=clone(n,i):t[r]=e[r]}return t}function getPropertyName(t){return t[0]in ALIAS?ALIAS[t[0]]:t}function getValue(t,e){var i=getType(e);if(i===PROPERTY)return e.toValue();if(i===FUNCTION){if(t[0]!==TIMING_FUNCTION)return getValue(t,e())}else if(i===OBJECT)return clone(e,!0);return e}var Frame=function(){function t(t){void 0===t&&(t={}),this.properties={},this.set(t)}var e=t.prototype;return e.get=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=this.raw.apply(this,t);return getValue(getPropertyName(t),i)},e.raw=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return getValueByNames(getPropertyName(t),this.properties)},e.remove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=getPropertyName(t),r=i.length;if(!r)return this;var n=getValueByNames(i,this.properties,r-1);return isObject(n)&&delete n[i[r-1]],this},e.set=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=t.length,r=t.slice(0,-1),n=t[i-1];if(r[0]in ALIAS)this._set(ALIAS[r[0]],n);else if(2===i&&isArray(r[0]))this._set(r[0],n);else if(isArray(n))this._set(r,n);else if(isPropertyObject(n))isRole(r)?this.set.apply(this,r.concat([toObject(n)])):this._set(r,n);else if(isObject(n))for(var s in n)this.set.apply(this,r.concat([s,n[s]]));else if(isString(n)){if(isRole(r,!0)){if(isFixed(r)||!isRole(r))this._set(r,n);else{var a=toPropertyObject(n);isObject(a)&&this.set.apply(this,r.concat([a]))}return this}var o=splitStyle(n),u=o.styles,f=o.length;for(var s in u)this.set.apply(this,r.concat([s,u[s]]));if(f)return this;this._set(r,n)}else this._set(r,n);return this},e.getNames=function(){return getNames(this.properties,[])},e.has=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=getPropertyName(t),r=i.length;return!!r&&!isUndefined(getValueByNames(i,this.properties,r))},e.clone=function(){return(new t).merge(this)},e.merge=function(t){var e=this.properties,i=t.properties;return i?(merge(e,i),this):this},e.toCSSObject=function(){var t=this.get(),e={};for(var i in t)if(!isRole([i],!0)){var r=t[i];i!==TIMING_FUNCTION?e[i]=r:e[TIMING_FUNCTION.replace("animation",ANIMATION)]=(isString(r)?r:r[EASING_NAME])||"initial"}var n=toInnerProperties(t[TRANSFORM_NAME]),s=toInnerProperties(t.filter);return TRANSFORM&&n&&(e[TRANSFORM]=n),FILTER&&s&&(e[FILTER]=s),e},e.toCSS=function(){var t=this.toCSSObject(),e=[];for(var i in t)e.push(i+":"+t[i]+";");return e.join("")},e._set=function(t,e){for(var i=this.properties,r=t.length,n=0;n<r-1;++n){var s=t[n];!(s in i)&&(i[s]={}),i=i[s]}r&&(1===t.length&&t[0]===TIMING_FUNCTION?i[TIMING_FUNCTION]=getEasing(e):i[t[r-1]]=isString(e)?toPropertyObject(e):e)},t}();function dotArray(t,e,i,r){var n=e.length;return t.map(function(t,s){return s>=n?t:dot(t,e[s],i,r)})}function dotColor(t,e,i,r){var n=t.value,s=e.value,a=t.model;if(a!==e.model)return dot(t.toValue(),e.toValue(),i,r);3===n.length&&(n[3]=1),3===s.length&&(s[3]=1);for(var o=dotArray(n,s,i,r),u=a,f=0;f<3;++f)o[f]=parseInt(o[f],10);return new PropertyObject(o,{type:"color",model:u,prefix:u+"(",suffix:")"})}function dotObject(t,e,i,r){var n=t.type;if("color"===n)return dotColor(t,e,i,r);var s=dotArray(t.value,e.value,i,r);return new PropertyObject(s,{type:n,separator:t.separator||e.separator,prefix:t.prefix||e.prefix,suffix:t.suffix||e.suffix,model:t.model||e.model})}function dot(t,e,i,r){if(0===r)return e;if(0===i||i+r===0)return t;var n=getType(t),s=getType(e),a=n===FUNCTION,o=s===FUNCTION;if(a||o)return function(){return dot(a?toPropertyObject(t()):t,o?toPropertyObject(e()):e,i,r)};if(n!==s)return t;if(n===PROPERTY)return dotObject(t,e,i,r);if(n===ARRAY)return dotArray(t,e,i,r);if("value"!==n)return t;var u,f=splitUnit(""+t),c=splitUnit(""+e);if(isNaN(f.value)||isNaN(c.value))return t;u=dot$1(f.value,c.value,i,r);var h=f.prefix||c.prefix,l=f.unit||c.unit;return h||l?h+u+l:u}function dotValue(t,e,i,r,n,s){if(t===e)return r;if(t===i)return n;if(!s)return dot(r,n,t-e,i-t);var a=s((t-e)/(i-e));return dot(r,n,a,1-a)}function getNearTimeIndex(t,e){for(var i=t.length,r=0;r<i;++r){if(t[r]===e)return[r,r];if(t[r]>e)return[r>0?r-1:0,r]}return[i-1,i-1]}function makeAnimationProperties(t){var e=[];for(var i in t)e.push(ANIMATION+"-"+decamelize(i)+":"+t[i]+";");return e.join("")}function addTime(t,e){for(var i=t.length,r=0;r<i;++r)if(e<t[r])return void t.splice(r,0,e);t[i]=e}function addEntry(t,e,i){var r=t[t.length-1];(!r||r[0]!==e||r[1]!==i)&&t.push([toFixed(e),toFixed(i)])}function getEntries(t,e){var i=t.map(function(t){return[t,t]}),r=[];return e.forEach(function(t){for(var e=t[ITERATION_COUNT],n=t[DELAY],s=t[PLAY_SPEED],a=t[DIRECTION],o=Math.ceil(e),u=i[i.length-1][0],f=i.length,c=u*e,h=0;h<o;++h)for(var l=a===REVERSE||a===ALTERNATE&&h%2||a===ALTERNATE_REVERSE&&!(h%2),E=0;E<f;++E){var T=i[l?f-E-1:E],m=T[1],p=u*h+(l?u-T[0]:T[0]),v=i[l?f-E:E-1];if(p>c){if(0!==E){var I=u*h+(l?u-v[0]:v[0]),d=dot$1(v[1],m,c-I,p-c);addEntry(r,(n+u*e)/s,d)}break}if(p===c&&r.length&&r[r.length-1][0]===c+n)break;addEntry(r,(n+p)/s,m)}n&&r.unshift([0,r[0][1]]),i=r,r=[]}),i}var SceneItem=function(t){function e(e,i){var r=t.call(this)||this;return r.times=[],r.items={},r.names={},r.elements=[],r.needUpdate=!0,r.load(e,i),r}__extends(e,t);var i=e.prototype;return i.getDuration=function(){var t=this.times,e=t.length;return(0===e?0:t[e-1])||this.state[DURATION]},i.size=function(){return this.times.length},i.setDuration=function(t){if(!t)return this;var e=this.getDuration();if(e>0){var i=t/e,r=this.times,n=this.items,s={};this.times=r.map(function(t){var e=toFixed(t*i);return s[e]=n[t],e}),this.items=s}else this.newFrame(t);return this},i.setId=function(t){var e=this.state;e.id=t||makeId(!!length);var i=this.elements;if(i.length&&!e[SELECTOR]){var r=toId(this.getId());e[SELECTOR]="["+DATA_SCENE_ID+'="'+r+'"]',i.forEach(function(t){t.setAttribute(DATA_SCENE_ID,r)})}return this},i.set=function(t){for(var i=this,r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];if(isArray(t))for(var s=t.length,a=0;a<s;++a){var o=1===s?0:this.getUnitTime(a/(s-1)*100+"%");this.set(o,t[a])}else if(isObject(t)){var u=function(e){var r=t[e],n=f.getUnitTime(e);isNaN(n)?getNames(r,[e]).forEach(function(t){for(var e=getValueByNames(t.slice(1),r),n=isArray(e)?e:[getValueByNames(t,i.target),e],s=n.length,a=0;a<s;++a)i.newFrame(a/(s-1)*100+"%").set(t,n[a])}):f.set(n,r)},f=this;for(var o in t)u(o)}else{var c=r[0];if(c instanceof Frame)this.setFrame(t,c);else if(c instanceof e){var h=c.getDelay(),l=this.getUnitTime(t),E=c.toObject(!this.hasFrame(l+h)),T=c.getDuration(),m=c.getDirection().indexOf("reverse")>-1;for(var p in E){var v=m?T-parseFloat(p):parseFloat(p);this.set(l+v,E[p])}}else if(1===r.length&&isArray(c))c.forEach(function(e){i.set(t,e)});else{var I=this.newFrame(t);I.set.apply(I,r)}}return this.needUpdate=!0,this},i.get=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var r=this.getFrame(t);return r&&r.get.apply(r,e)},i.remove=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];if(e.length){var r=this.getFrame(t);r&&r.remove.apply(r,e)}else this.removeFrame(t);return this.needUpdate=!0,this},i.append=function(t){return t instanceof e?this.set(this.getDuration(),t):this.append(new e(t)),this},i.prepend=function(t){if(t instanceof e){var i=t.getDuration()+t.getDelay(),r=this.getFrame(0);this.removeFrame(0),this.unshift(i),this.set(0,t),this.set(i+THRESHOLD,r)}else this.prepend(new e(t));return this},i.unshift=function(t){var e=this.times,i=this.items,r={};return this.times=e.map(function(e){var n=toFixed(t+e);return r[n]=i[e],n}),this.items=r,this},i.toObject=function(t){void 0===t&&(t=!0);var e={},i=this.getDelay();return this.forEach(function(r,n){e[(n||t?0:THRESHOLD)+i+n]=r.clone()}),e},i.setSelector=function(t){return isFunction(t)?this.setElement(t(this.getId())):this.setElement(t),this},i.getElements=function(){return this.elements},i.setElements=function(t){return this.setElement(t)},i.setElement=function(t){var e=this.state,i=[];if(!t)return this;if(!0===t||isString(t)){var r=!0===t?""+e.id:t,n=/([\s\S]+)(:+[a-zA-Z]+)$/g.exec(r);i=toArray($(n?n[1]:r,!0)),e[SELECTOR]=r}else i=t instanceof Element?[t]:toArray(t);return i.length?(this.elements=i,this.setId(this.getId()),this.target=i[0].style,this.targetFunc=function(t){var r=t.get("attribute");if(r){var n=function(t){i.forEach(function(e){e.setAttribute(t,r[t])})};for(var s in r)n(s)}var a=t.toCSS();if(e.cssText!==a)return e.cssText=a,i.forEach(function(t){t.style.cssText+=a}),t},this):this},i.setTarget=function(t){return this.target=t,this.targetFunc=function(e){var i=e.get();for(var r in i)t[r]=i[r]},this},i.setCSS=function(t,e){return this.set(t,fromCSS(this.elements,e)),this},i.setTime=function(e,i,r,n){t.prototype.setTime.call(this,e,i,r);var s=this.getIterationTime(),a=this.getEasing()||n,o=this.getNowFrame(s,a),u=this.getTime();return this.temp=o,this.trigger("animate",{frame:o,currentTime:u,time:s}),this.targetFunc&&this.targetFunc(o),this},i.update=function(){var t={};return this.forEach(function(e){updateFrame(t,e.properties)}),this.names=t,this.needUpdate=!1,this},i.newFrame=function(t){var e=this.getFrame(t);return e||(e=new Frame,this.setFrame(t,e),e)},i.setFrame=function(t,e){var i=this.getUnitTime(t);return this.items[i]=e,addTime(this.times,i),this.needUpdate=!0,this},i.getFrame=function(t){return this.items[this.getUnitTime(t)]},i.removeFrame=function(t){var e=this.getUnitTime(t),i=this.items,r=this.times.indexOf(e);return delete i[e],r>-1&&this.times.splice(r,1),this.needUpdate=!0,this},i.hasFrame=function(t){return this.getUnitTime(t)in this.items},i.hasName=function(t){return this.needUpdate&&this.update(),isInProperties(this.names,t,!0)},i.mergeFrame=function(t,e){e&&this.newFrame(t).merge(e);return this},i.getNowFrame=function(t,e,i){var r=this;this.needUpdate&&this.update();var n=new Frame,s=getNearTimeIndex(this.times,t),a=s[0],o=s[1],u=this.getEasing()||e,f=this.names;if(this.hasName([TIMING_FUNCTION])){var c=this.getNowValue(t,[TIMING_FUNCTION],a,o,!1,0,!0);isFunction(c)&&(u=c)}if(i){var h=updateFrame({},this.getFrame(t).properties);for(var l in ROLES)l in h&&(h[l]=f[l]);f=h}return getNames(f,[]).forEach(function(e){var s=r.getNowValue(t,e,a,o,i,u,isFixed(e));isUndefined(s)||n.set(e,s)}),n},i.load=function(t,e){var i;if(void 0===t&&(t={}),void 0===e&&(e=t.options),e&&this.setOptions(e),isArray(t))this.set(t);else if(t.keyframes)this.set(t.keyframes);else for(var r in t)"options"!==r&&this.set(((i={})[r]=t[r],i));return e&&e[DURATION]&&this.setDuration(e[DURATION]),this},i.clone=function(){var t=new e;return t.setOptions(this.state),this.forEach(function(e,i){t.setFrame(i,e.clone())}),t},i.forEach=function(t){var e=this.times,i=this.items;return e.forEach(function(e){t(i[e],e,i)}),this},i.setOptions=function(e){void 0===e&&(e={}),t.prototype.setOptions.call(this,e);var i=e.id,r=e.selector,n=e.elements,s=e.element,a=e.target;return i&&this.setId(i),a?this.setTarget(a):r?this.setSelector(r):(n||s)&&this.setElement(n||s),this},i.toCSS=function(t,e,i){void 0===t&&(t={className:START_ANIMATION}),void 0===e&&(e=this.getDuration()),void 0===i&&(i=[]);var r=this.state,n=r[SELECTOR];if(!n)return"";var s=this.getDuration();r[DURATION]=s,i.push(r);var a=toArray(i).reverse(),o=toId(getRealId(this)),u=i[0],f=findIndex(a,function(t){return t[ITERATION_COUNT]===INFINITE||!isFinite(t[DURATION])},i.length-1),c=a.slice(0,f),h=e||c.reduce(function(t,e){return(e[DELAY]+t*e[ITERATION_COUNT])/e[PLAY_SPEED]},s),l=a.slice(f).reduce(function(t,e){return(t+e[DELAY])/e[PLAY_SPEED]},0),E=find(a,function(t){return t[EASING]&&t[EASING_NAME]},r)[EASING_NAME],T=a[f][ITERATION_COUNT],m=u[FILL_MODE],p=a[f][DIRECTION],v=makeAnimationProperties({fillMode:m,direction:p,iterationCount:T,delay:l+"s",name:PREFIX+"KEYFRAMES_"+o,duration:h/u[PLAY_SPEED]+"s",timingFunction:E}),I=splitComma(n).map(function(t){var e=/([\s\S]+)(:+[a-zA-Z]+)$/g.exec(t);return e?[e[0],e[1]]:[t,""]}),d=t.className,A=t.selector;return"\n    "+((isFunction(A)?A(this,n):A)||I.map(function(t){var e=t[0],i=t[1];return e+"."+d+i}))+" {"+v+"}\n    "+I.map(function(t){var e=t[0],i=t[1];return e+"."+PAUSE_ANIMATION+i})+" {"+ANIMATION+"-play-state: paused;}\n    @"+KEYFRAMES+" "+PREFIX+"KEYFRAMES_"+o+"{"+this._toKeyframes(h,c,p)+"}"},i.exportCSS=function(t,e,i){if(!this.elements.length)return"";var r=this.toCSS(t,e,i);return!(i&&!isUndefined(i[ITERATION_COUNT]))&&exportCSS(getRealId(this),r),this},i.pause=function(){return t.prototype.pause.call(this),isPausedCSS(this)&&this.pauseCSS(),this},i.pauseCSS=function(){return this.elements.forEach(function(t){addClass(t,PAUSE_ANIMATION)}),this},i.endCSS=function(){return this.elements.forEach(function(t){removeClass(t,PAUSE_ANIMATION),removeClass(t,START_ANIMATION)}),setPlayCSS(this,!1),this},i.end=function(){return isEndedCSS(this)&&this.endCSS(),t.prototype.end.call(this),this},i.playCSS=function(t,e,i){return void 0===t&&(t=!0),void 0===i&&(i={}),playCSS(this,t,e,i),this},i.addPlayClass=function(t,e,i){void 0===i&&(i={});var r=this.elements,n=r.length,s=makeAnimationProperties(i);if(n)return t?r.forEach(function(t){removeClass(t,PAUSE_ANIMATION)}):r.forEach(function(t){t.style.cssText+=s,hasClass(t,START_ANIMATION)?(removeClass(t,START_ANIMATION),requestAnimationFrame(function(){requestAnimationFrame(function(){addClass(t,START_ANIMATION)})})):addClass(t,START_ANIMATION)}),r[0]},i.getNowValue=function(t,e,i,r,n,s,a){var o,u,f,c,h=this.times,l=h.length,E=isUndefined(i),T=isUndefined(r);if(E||T){var m=getNearTimeIndex(h,t);E&&(i=m[0]),T&&(r=m[1])}for(var p=i;p>=0;--p){if((I=this.getFrame(h[p])).has.apply(I,e)){o=h[p],f=I;break}}var v=f&&f.raw.apply(f,e);if(n&&!isRole([e[0]]))return o===t?v:void 0;if(a)return v;for(p=r;p<l;++p){var I;if((I=this.getFrame(h[p])).has.apply(I,e)){u=h[p],c=I;break}}var d=c&&c.raw.apply(c,e);return!f||isUndefined(v)?d:!c||isUndefined(d)||v===d?v:dotValue(t,Math.max(o,0),u,v,d,s)},i._toKeyframes=function(t,e,i){var r=this,n={},s=this.times.slice();if(!s.length)return"";var a=this.getDuration();!this.getFrame(0)&&s.unshift(0),!this.getFrame(a)&&s.push(a);var o=getEntries(s,e),u=o[o.length-1];u[0]<t&&addEntry(o,t,u[1]);var f=-1;return o.map(function(e){var s=e[0],o=e[1];n[o]||(n[o]=(r.hasFrame(o)&&0!==o&&o!==a?r.getNowFrame(o,0,!0):r.getNowFrame(o)).toCSS());var u=s/t*100;return u-f<THRESHOLD&&(u+=THRESHOLD),f=u,Math.min(u,100)+"%{\n                "+(0!==s||isDirectionReverse(0,1,i)?n[o]:"")+"\n            }"}).join("")},e}(Animator),Scene=function(t){function e(e,i){var r=t.call(this)||this;return r.items=new ListMap,r.load(e,i),r}__extends(e,t);var i=e.prototype;return i.getDuration=function(){var t=0;return this.forEach(function(e){t=Math.max(t,e.getTotalDuration()/e.getPlaySpeed())}),t||this.state[DURATION]},i.setDuration=function(e){this.items;var i=this.getDuration();if(0===e||!isFinite(i))return this;if(0===i)this.forEach(function(t){t.setDuration(e)});else{var r=e/i;this.forEach(function(t){t.setDelay(t.getDelay()*r),t.setDuration(t.getDuration()*r)})}return t.prototype.setDuration.call(this,e),this},i.getItem=function(t){return this.items.get(t)},i.newItem=function(t,e){if(void 0===e&&(e={}),this.items.has(t))return this.items.get(t);var i=new SceneItem;return this.setItem(t,i),i.setOptions(e),i},i.removeItem=function(t){return this.items.remove(t),this},i.setItem=function(t,e){return e.setId(t),this.items.set(t,e),this},i.setTime=function(e,i,r,n){t.prototype.setTime.call(this,e,i,r);var s=this.getIterationTime(),a=this.getEasing()||n,o={};return this.forEach(function(t){t.setTime(s*t.getPlaySpeed()-t.getDelay(),i,!0,a),o[t.getId()]=t.temp}),this.temp=o,this.trigger("animate",{frames:o,currentTime:this.getTime(),time:s}),this},i.forEach=function(t){return this.items.forEach(function(e,i,r,n){t(e,i,r,n)}),this},i.toCSS=function(t,e,i){void 0===e&&(e=this.getDuration()),void 0===i&&(i=[]);var r=e&&isFinite(e)?e:0,n=[],s=this.state;return s[DURATION]=this.getDuration(),this.forEach(function(e){n.push(e.toCSS(t,r,i.concat(s)))}),n.join("")},i.exportCSS=function(t,e,i){var r=this.toCSS(t,e,i);return(!i||!i.length)&&exportCSS(getRealId(this),r),this},i.append=function(t){t.setDelay(t.getDelay()+this.getDuration()),this.setItem(getRealId(t),t)},i.pauseCSS=function(){return this.forEach(function(t){t.pauseCSS()})},i.pause=function(){return t.prototype.pause.call(this),isPausedCSS(this)&&this.pauseCSS(),this.forEach(function(t){t.pause()}),this},i.endCSS=function(){this.forEach(function(t){t.endCSS()}),setPlayCSS(this,!1)},i.end=function(){return isEndedCSS(this)&&this.endCSS(),t.prototype.end.call(this),this},i.addPlayClass=function(t,e,i){var r;return void 0===i&&(i={}),this.forEach(function(n){var s=n.addPlayClass(t,e,i);!r&&(r=s)}),r},i.playCSS=function(t,e,i){return void 0===t&&(t=!0),void 0===i&&(i={}),playCSS(this,t,e,i),this},i.set=function(t){return this.load(t),this},i.load=function(t,i){if(void 0===t&&(t={}),void 0===i&&(i=t.options),!t)return this;var r=i&&i[SELECTOR]||this.state[SELECTOR];for(var n in t)if("options"!==n){var s=t[n],a=void 0;if(s instanceof e||s instanceof SceneItem)this.setItem(n,s),a=s;else{if(isFunction(s)&&r){for(var o=IS_WINDOW?$(""+(isFunction(r)?r(n):n),!0):[],u=o.length,f=new e,c=0;c<u;++c)f.newItem(c).setId().setElement(o[c]).load(s(c,o[c]));this.setItem(n,f);continue}(a=this.newItem(n)).load(s)}r&&a.setSelector(r)}this.setOptions(i)},i.setOptions=function(e){void 0===e&&(e={}),t.prototype.setOptions.call(this,e);var i=e.selector;return i&&(this.state[SELECTOR]=i),this},i.setSelector=function(t){var e=this.state,i=t||e[SELECTOR];e[SELECTOR]=i;var r=isFunction(t);return i&&this.forEach(function(e,n){e.setSelector(r?t(n):i)}),this},i.start=function(e){void 0===e&&(e=this.state[DELAY]);var i=t.prototype.start.call(this,e);return i?this.forEach(function(t){t.start(0)}):this.forEach(function(t){t.setPlayState(RUNNING)}),i},e.VERSION="1.0.2",e}(Animator);function animate(t,e){return new Scene(t,e).play()}function animateItem(t,e){return new SceneItem(t,e).play()}export default Scene;export{Animator,EASE,EASE_IN,EASE_IN_OUT,EASE_OUT,EVENTS,FIXED,Frame,LINEAR,OPTIONS,ROLES,STEP_END,STEP_START,SceneItem,animate,animateItem,bezier,setAlias,setRole,steps};