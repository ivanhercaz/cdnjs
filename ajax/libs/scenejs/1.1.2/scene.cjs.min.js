"use strict";var utils=require("@daybrush/utils"),ListMap=require("list-map"),extendStatics=function(t,e){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};function __extends(t,e){function i(){this.constructor=t}extendStatics(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}function __decorate(t,e,i,r){var n,s=arguments.length,a=s<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,r);else for(var o=t.length-1;0<=o;o--)(n=t[o])&&(a=(s<3?n(a):3<s?n(e,i,a):n(e,i))||a);return 3<s&&a&&Object.defineProperty(e,i,a),a}function cubic(t,e,i){var r=1-i;return i*i*i+3*i*i*r*e+3*i*r*r*t}function solveFromX(t,e,i){for(var r=i,n=1;.001<Math.abs(n);){if(n=cubic(t,e,r)-i,Math.abs(n)<.001)return r;r-=n/2}return r}function bezier(i,r,n,s){function t(t){var e=solveFromX(i,n,Math.max(Math.min(1,t),0));return cubic(r,s,e)}return t.easingName="cubic-bezier("+i+","+r+","+n+","+s+")",t}function steps(i,r){function t(t){var e=1/i;return 1<=t?1:("start"===r?e:0)+Math.floor(t/e)*e}return t.easingName="steps("+i+", "+r+")",t}var _a,STEP_START=steps(1,"start"),STEP_END=steps(1,"end"),LINEAR=bezier(0,0,1,1),EASE=bezier(.25,.1,.25,1),EASE_IN=bezier(.42,0,1,1),EASE_OUT=bezier(0,0,.58,1),EASE_IN_OUT=bezier(.42,0,.58,1),PREFIX="__SCENEJS_",DATA_SCENE_ID="data-scene-id",TIMING_FUNCTION="animation-timing-function",ROLES={transform:{},filter:{},attribute:{},html:!0},ALIAS={easing:[TIMING_FUNCTION]},FIXED=((_a={})[TIMING_FUNCTION]=!0,_a.contents=!0,_a.html=!0,_a),MAXIMUM=1e6,THRESHOLD=1e-6,DURATION="duration",FILL_MODE="fillMode",DIRECTION="direction",ITERATION_COUNT="iterationCount",DELAY="delay",EASING="easing",PLAY_SPEED="playSpeed",EASING_NAME="easingName",ITERATION_TIME="iterationTime",PAUSED="paused",ENDED="ended",TIMEUPDATE="timeupdate",ANIMATE="animate",PLAY="play",RUNNING="running",ITERATION="iteration",START_ANIMATION="startAnimation",PAUSE_ANIMATION="pauseAnimation",ALTERNATE="alternate",REVERSE="reverse",ALTERNATE_REVERSE="alternate-reverse",NORMAL="normal",INFINITE="infinite",PLAY_STATE="playState",PLAY_CSS="playCSS",PREV_TIME="prevTime",TICK_TIME="tickTime",CURRENT_TIME="currentTime",SELECTOR="selector",TRANSFORM_NAME="transform",EASINGS={linear:LINEAR,ease:EASE,"ease-in":EASE_IN,"ease-out":EASE_OUT,"ease-in-out":EASE_IN_OUT,"step-start":STEP_START,"step-end":STEP_END},OPTIONS=[DURATION,FILL_MODE,DIRECTION,ITERATION_COUNT,DELAY,EASING,PLAY_SPEED],EVENTS=[PAUSED,ENDED,TIMEUPDATE,ANIMATE,PLAY,ITERATION],EventTrigger=function(){function t(){this.events={}}var e=t.prototype;return e._on=function(r,n,e){var i=this,t=this.events;if(utils.isObject(r))for(var s in r)this._on(s,r[s],e);else r in t||(t[r]=[]),n&&(utils.isArray(n)?n.forEach(function(t){return i._on(r,t,e)}):t[r].push(e?function t(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];n.apply(void 0,e),this.off(r,t)}:n))},e.on=function(t,e){return this._on(t,e),this},e.off=function(t,e){if(t)if(e){var i=this.events[t];if(!i)return this;var r=i.indexOf(e);-1!==r&&i.splice(r,1)}else this.events[t]=[];else this.events={};return this},e.trigger=function(t){for(var e=this,i=[],r=1;r<arguments.length;r++)i[r-1]=arguments[r];var n=this.events;if(!(t in n))return this;var s=i||[];s[0]||(s[0]={});n[t];var a=s[0];return a.type=t,a.currentTarget=this,a.target||(a.target=this),utils.toArray(n[t]).forEach(function(t){t.apply(e,i)}),this},e.once=function(t,e){return this._on(t,e,!0),this},t}(),PropertyObject=function(){function a(t,e){this.prefix="",this.suffix="",this.model="",this.type="",this.separator=",",e&&this.setOptions(e),this.value=utils.isString(t)?t.split(this.separator):t}var t=a.prototype;return t.setOptions=function(t){for(var e in t)this[e]=t[e];return this},t.size=function(){return this.value.length},t.get=function(t){return this.value[t]},t.set=function(t,e){return this.value[t]=e,this},t.clone=function(){var t=this,e=t.separator,i=t.prefix,r=t.suffix,n=t.model,s=t.type;return new a(this.value.map(function(t){return t instanceof a?t.clone():t}),{separator:e,prefix:i,suffix:r,model:n,type:s})},t.toValue=function(){return this.prefix+this.join()+this.suffix},t.join=function(){return this.value.map(function(t){return t instanceof a?t.toValue():t}).join(this.separator)},t.forEach=function(t){return this.value.forEach(t),this},a}();function splitStyle(t){for(var e=t.split(";"),i={},r=e.length,n=0;n<r;++n){var s=/([^:]*):([\S\s]*)/g.exec(e[n]);!s||s.length<3||!s[1]?--r:i[s[1].trim()]=toPropertyObject(s[2].trim())}return{styles:i,length:r}}function arrayToColorObject(t){var e=utils.RGBA;return 3===t.length&&(t[3]=1),new PropertyObject(t,{model:e,separator:",",type:"color",prefix:e+"(",suffix:")"})}function stringToBracketObject(t){var e=utils.splitBracket(t),i=e.prefix,r=e.value,n=e.suffix;if(void 0===r)return t;if(-1!==utils.COLOR_MODELS.indexOf(i))return arrayToColorObject(utils.stringToRGBA(t));var s=toPropertyObject(r),a=[r],o=",",u=i+"(",f=")"+n;return s instanceof PropertyObject&&(o=s.separator,a=s.value,u+=s.prefix,f=s.suffix+f),new PropertyObject(a,{separator:o,model:i,prefix:u,suffix:f})}function arrayToPropertyObject(t,e){return new PropertyObject(t,{type:"array",separator:e})}function stringToColorObject(t){var e=utils.stringToRGBA(t);return e?arrayToColorObject(e):t}function toPropertyObject(t){if(!utils.isString(t))return utils.isArray(t)?arrayToPropertyObject(t,","):t;var e=utils.splitComma(t);return 1<e.length?arrayToPropertyObject(e.map(function(t){return toPropertyObject(t)}),","):1<(e=utils.splitSpace(t)).length?arrayToPropertyObject(e.map(function(t){return toPropertyObject(t)})," "):(e=/^(['"])([^'"]*)(['"])$/g.exec(t))&&e[1]===e[3]?new PropertyObject([toPropertyObject(e[2])],{prefix:e[1],suffix:e[1]}):-1!==t.indexOf("(")?stringToBracketObject(t):"#"===t.charAt(0)?stringToColorObject(t):t}function toObject(t,e){void 0===e&&(e={});var i=t.model;if(i){t.setOptions({model:"",suffix:"",prefix:""});var r=1<t.size()?t:t.get(0);e[i]=r}else t.forEach(function(t){toObject(t,e)});return e}function isPropertyObject(t){return t instanceof PropertyObject}function setAlias(t,e){ALIAS[t]=e}function setRole(t,e,i){for(var r=t.length,n=ROLES,s=FIXED,a=0;a<r-1;++a)n[t[a]]||(n[t[a]]={}),n=n[t[a]],i&&(s[t[a]]||(s[t[a]]={}),s=s[t[a]]);i&&(s[t[r-1]]=!0),n[t[r-1]]=!!e||{}}function getType(t){var e=typeof t;if(e===utils.OBJECT){if(utils.isArray(t))return utils.ARRAY;if(isPropertyObject(t))return utils.PROPERTY}else if(e===utils.STRING||e===utils.NUMBER)return"value";return e}function isPureObject(t){return utils.isObject(t)&&t.constructor===Object}function getNames(t,e){var i=[];if(isPureObject(t))for(var r in t)e.push(r),i=i.concat(getNames(t[r],e)),e.pop();else i.push(e.slice());return i}function updateFrame(t,e){for(var i in e){isPureObject(e[i])?(utils.isObject(t[i])||(t[i]={}),updateFrame(t[i],e[i])):t[i]=!0}return t}function toFixed(t){return Math.round(t*MAXIMUM)/MAXIMUM}function getValueByNames(t,e,i){void 0===i&&(i=t.length);for(var r=e,n=0;n<i;++n){if(!utils.isObject(r))return;r=r[t[n]]}return r}function isInProperties(t,e,i){var r=e.length,n=t;if(0===r)return!1;for(var s=0;s<r;++s){if(!0===n)return!1;if(!(n=n[e[s]])||!i&&!0===n)return!1}return!0}function isRole(t,e){return isInProperties(ROLES,t,e)}function isFixed(t){return isInProperties(FIXED,t,!0)}function setPlayCSS(t,e){t.state[PLAY_CSS]=e}function isPausedCSS(t){return t.state[PLAY_CSS]&&t.isPaused()}function isEndedCSS(t){return!t.isEnded()&&t.state[PLAY_CSS]}function exportCSS(t,e){var i=PREFIX+"STYLE_"+toId(t),r=utils.$("#"+i);r?r.innerText=e:utils.document.body.insertAdjacentHTML("beforeend",'<style id="'+i+'">'+e+"</style>")}function makeId(t){for(;;){var e=""+Math.floor(1e7*Math.random());if(!utils.IS_WINDOW||!t)return e;if(!utils.$('[data-scene-id="'+e+'"]'))return e}}function getRealId(t){return t.getId()||t.setId(makeId(!1)).getId()}function toId(t){return(""+t).match(/[0-9a-zA-Z]+/g).join("")}function playCSS(t,e,i,r){if(void 0===r&&(r={}),utils.ANIMATION&&t.getPlayState()!==RUNNING){var n=i||START_ANIMATION;if(isPausedCSS(t))t.addPlayClass(!0,n,r);else{t.isEnded()&&t.setTime(0),e&&t.exportCSS({className:n});var s=t.addPlayClass(!1,n,r);if(!s)return;addAnimationEvent(t,s),setPlayCSS(t,!0)}t.setPlayState(RUNNING)}}function addAnimationEvent(r,t){function e(){setPlayCSS(r,!1),r.finish()}function i(){r.trigger(PLAY)}var n=r.state,s=r.getDuration(),a=!s||!isFinite(s);r.once(ENDED,function(){utils.removeEvent(t,"animationcancel",e),utils.removeEvent(t,"animationend",e),utils.removeEvent(t,"animationiteration",o),utils.removeEvent(t,"animationstart",i)});var o=function(t){var e=t.elapsedTime,i=a?0:e/s;n[CURRENT_TIME]=e,r.setIteration(i)};utils.addEvent(t,"animationcancel",e),utils.addEvent(t,"animationend",e),utils.addEvent(t,"animationiteration",o),utils.addEvent(t,"animationstart",i)}function getEasing(t){var e;if(utils.isString(t))if(t in EASINGS)e=EASINGS[t];else{var i=toPropertyObject(t);if(utils.isString(i))return 0;if("cubic-bezier"===i.model)e=bezier((t=i.value.map(function(t){return parseFloat(t)}))[0],t[1],t[2],t[3]);else{if("steps"!==i.model)return 0;e=steps(parseFloat(i.value[0]),i.value[1])}}else e=utils.isArray(t)?bezier(t[0],t[1],t[2],t[3]):t;return e}function GetterSetter(e,r,n){return function(t){var i=t.prototype;e.forEach(function(t){i[utils.camelize("get "+t)]=function(){return this[n][t]}}),r.forEach(function(e){i[utils.camelize("set "+e)]=function(t){return this[n][e]=t,this}})}}function isDirectionReverse(t,e,i){return i===REVERSE||(e!==INFINITE&&t===e&&e%1==0?i===(1<=t%2?ALTERNATE_REVERSE:ALTERNATE):i===(1<=t%2?ALTERNATE:ALTERNATE_REVERSE))}var setters=["id",ITERATION_COUNT,DELAY,FILL_MODE,DIRECTION,PLAY_SPEED,DURATION,PLAY_SPEED,ITERATION_TIME,PLAY_STATE],getters=setters.concat([EASING,EASING_NAME]),Animator=function(i){function t(t){var e=i.call(this)||this;return e.timerId=0,e.state={id:"",easing:0,easingName:"linear",iterationCount:1,delay:0,fillMode:"forwards",direction:NORMAL,playSpeed:1,currentTime:0,iterationTime:-1,iteration:0,tickTime:0,prevTime:0,playState:PAUSED,duration:0},e.setOptions(t),e}__extends(t,i);var e=t.prototype;return e.setEasing=function(t){var e=getEasing(t),i=e&&e[EASING_NAME]||"linear",r=this.state;return r[EASING]=e,r[EASING_NAME]=i,this},e.setOptions=function(t){for(var e in void 0===t&&(t={}),t){var i=t[e];e!==EASING?e!==DURATION?-1<OPTIONS.indexOf(e)&&(this.state[e]=i):i&&this.setDuration(i):this.setEasing(i)}return this},e.getTotalDuration=function(){return this.getActiveDuration(!0)},e.getActiveDuration=function(t){var e=this.state,i=e[ITERATION_COUNT];return i===INFINITE?1/0:(t?e[DELAY]:0)+this.getDuration()*i},e.isEnded=function(){return 0===this.state[TICK_TIME]&&this.state[PLAY_STATE]===PAUSED||!(this.getTime()<this.getActiveDuration())},e.isPaused=function(){return this.state[PLAY_STATE]===PAUSED},e.start=function(t){void 0===t&&(t=this.state[DELAY]);var e=this.state;return e[PLAY_STATE]=RUNNING,e[TICK_TIME]>=t&&(this.trigger(PLAY),!0)},e.play=function(e){var i=this,r=this.state,t=r[DELAY],n=this.getTime();return r[PLAY_STATE]=RUNNING,this.isEnded()&&(0===n||n>=this.getActiveDuration())&&this.setTime(-t,!0),this.timerId=utils.requestAnimationFrame(function(t){r[PREV_TIME]=t,i.tick(t,e)}),this.start(),this},e.pause=function(){var t=this.state;return t[PLAY_STATE]!==PAUSED&&(t[PLAY_STATE]=PAUSED,this.trigger(PAUSED)),utils.cancelAnimationFrame(this.timerId),this},e.finish=function(){return this.setTime(0),this.state[TICK_TIME]=0,this.end(),this},e.end=function(){return this.pause(),this.trigger(ENDED),this},e.setTime=function(t,e,i){var r=this.getActiveDuration(),n=this.state,s=n[TICK_TIME],a=n[DELAY],o=e?t:this.getUnitTime(t);if(n[TICK_TIME]=a+o,o<0?o=0:r<o&&(o=r),n[CURRENT_TIME]=o,this.calculate(),e&&!i){var u=n[TICK_TIME];if(s<a&&0<=t&&this.start(0),u<s||this.isEnded())return void this.end()}return this.isDelay()||this.trigger(TIMEUPDATE,{currentTime:o,time:this.getIterationTime(),iterationCount:n[ITERATION]}),this},e.getTime=function(){return this.state[CURRENT_TIME]},e.getUnitTime=function(t){if(utils.isString(t)){var e=this.getDuration()||100;if("from"===t)return 0;if("to"===t)return e;var i=utils.splitUnit(t),r=i.unit,n=i.value;return"%"===r?(this.getDuration()||this.setDuration(e),toFixed(parseFloat(t)/100*e)):">"===r?n+THRESHOLD:n}return toFixed(t)},e.isDelay=function(){var t=this.state,e=t[DELAY],i=t[TICK_TIME];return 0<e&&i<e},e.setIteration=function(t){var e=this.state,i=Math.floor(t),r=e[ITERATION_COUNT]===INFINITE?1/0:e[ITERATION_COUNT];return e[ITERATION]<i&&i<r&&this.trigger("iteration",{currentTime:e[CURRENT_TIME],iterationCount:i}),e[ITERATION]=t,this},e.calculate=function(){var t=this.state,e=t[ITERATION_COUNT],i=t[FILL_MODE],r=t[DIRECTION],n=this.getDuration(),s=this.getTime(),a=0===n?0:s/n,o=n?s%n:0;if(!n)return this.setIterationTime(0),this;this.setIteration(a);var u=isDirectionReverse(a,e,r),f=isFinite(n);f&&u&&(o=n-o),!f||e===INFINITE||e<=a&&(o=n*("both"===i||"forwards"===i?e%1||1:0),u&&(o=n-o));return this.setIterationTime(o),this},e.tick=function(t,e){var i=this;if(!this.isPaused()){var r=this.state,n=r[PLAY_SPEED],s=r[PREV_TIME],a=r[DELAY],o=r[TICK_TIME]+Math.min(1e3,t-s)/1e3*n;r[PREV_TIME]=t,this.setTime(o-a,!0),e&&1e3*e<t&&this.pause(),r[PLAY_STATE]!==PAUSED&&(this.timerId=utils.requestAnimationFrame(function(t){i.tick(t,e)}))}},t=__decorate([GetterSetter(getters,setters,"state")],t)}(EventTrigger);function toInnerProperties(t){if(!t)return"";var e=[];for(var i in t)e.push(i.replace(/\d$/g,"")+"("+t[i]+")");return e.join(" ")}function clone(t,e){return void 0===e&&(e=!1),merge({},t,e)}function merge(t,e,i){for(var r in void 0===i&&(i=!1),e){var n=e[r],s=getType(n);s===utils.PROPERTY?t[r]=i?n.toValue():n.clone():s===utils.FUNCTION?t[r]=i?getValue([r],n):n:s===utils.ARRAY?t[r]=n.slice():s===utils.OBJECT?utils.isObject(t[r])&&!isPropertyObject(t[r])?merge(t[r],n,i):t[r]=clone(n,i):t[r]=e[r]}return t}function getPropertyName(t){return t[0]in ALIAS?ALIAS[t[0]]:t}function getValue(t,e){var i=getType(e);if(i===utils.PROPERTY)return e.toValue();if(i===utils.FUNCTION){if(t[0]!==TIMING_FUNCTION)return getValue(t,e())}else if(i===utils.OBJECT)return clone(e,!0);return e}var Frame=function(){function t(t){void 0===t&&(t={}),this.properties={},this.set(t)}var e=t.prototype;return e.get=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=this.raw.apply(this,t);return getValue(getPropertyName(t),i)},e.raw=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return getValueByNames(getPropertyName(t),this.properties)},e.remove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=getPropertyName(t),r=i.length;if(!r)return this;var n=getValueByNames(i,this.properties,r-1);return utils.isObject(n)&&delete n[i[r-1]],this},e.set=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=this,r=t.length,n=t.slice(0,-1),s=t[r-1];if(n[0]in ALIAS)i._set(ALIAS[n[0]],s);else if(2===r&&utils.isArray(n[0]))i._set(n[0],s);else if(utils.isArray(s))i._set(n,s);else if(isPropertyObject(s))isRole(n)?i.set.apply(i,n.concat([toObject(s)])):i._set(n,s);else if(utils.isObject(s))for(var a in!i.has.apply(i,n)&&isRole(n)&&i._set(n,{}),s)i.set.apply(i,n.concat([a,s[a]]));else if(utils.isString(s)){if(isRole(n,!0)){if(isFixed(n)||!isRole(n))this._set(n,s);else{var o=toPropertyObject(s);utils.isObject(o)&&i.set.apply(i,n.concat([o]))}return this}var u=splitStyle(s),f=u.styles,c=u.length;for(var a in f)i.set.apply(i,n.concat([a,f[a]]));if(c)return this;i._set(n,s)}else i._set(n,s);return i},e.getNames=function(){return getNames(this.properties,[])},e.has=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=getPropertyName(t),r=i.length;return!!r&&!utils.isUndefined(getValueByNames(i,this.properties,r))},e.clone=function(){return(new t).merge(this)},e.merge=function(t){var e=this.properties,i=t.properties;return i&&merge(e,i),this},e.toCSSObject=function(){var t=this.get(),e={};for(var i in t)if(!isRole([i],!0)){var r=t[i];i===TIMING_FUNCTION?e[TIMING_FUNCTION.replace("animation",utils.ANIMATION)]=(utils.isString(r)?r:r[EASING_NAME])||"initial":"content"===i?e.content='"'+(""+r).replace(/"/g,'\\"')+'"':e[i]=r}var n=toInnerProperties(t[TRANSFORM_NAME]),s=toInnerProperties(t.filter);return utils.TRANSFORM&&n&&(e[utils.TRANSFORM]=n),utils.FILTER&&s&&(e[utils.FILTER]=s),e},e.toCSS=function(){var t=this.toCSSObject(),e=[];for(var i in t)e.push(i+":"+t[i]+";");return e.join("")},e._set=function(t,e){for(var i=this.properties,r=t.length,n=0;n<r-1;++n){var s=t[n];s in i||(i[s]={}),i=i[s]}r&&(1===t.length&&t[0]===TIMING_FUNCTION?i[TIMING_FUNCTION]=getEasing(e):i[t[r-1]]=utils.isString(e)?toPropertyObject(e):e)},t}();function dotArray(t,i,r,n){var s=i.length;return t.map(function(t,e){return s<=e?t:dot(t,i[e],r,n)})}function dotColor(t,e,i,r){var n=t.value,s=e.value,a=t.model;if(a!==e.model)return dot(t.toValue(),e.toValue(),i,r);3===n.length&&(n[3]=1),3===s.length&&(s[3]=1);for(var o=dotArray(n,s,i,r),u=a,f=0;f<3;++f)o[f]=parseInt(o[f],10);return new PropertyObject(o,{type:"color",model:u,prefix:u+"(",suffix:")"})}function dotObject(t,e,i,r){var n=t.type;if("color"===n)return dotColor(t,e,i,r);var s=dotArray(t.value,e.value,i,r);return new PropertyObject(s,{type:n,separator:t.separator||e.separator,prefix:t.prefix||e.prefix,suffix:t.suffix||e.suffix,model:t.model||e.model})}function dot(t,e,i,r){if(0===r)return e;if(0===i||i+r===0)return t;var n=getType(t),s=getType(e),a=n===utils.FUNCTION,o=s===utils.FUNCTION;if(a||o)return function(){return dot(a?toPropertyObject(t()):t,o?toPropertyObject(e()):e,i,r)};if(n!==s)return t;if(n===utils.PROPERTY)return dotObject(t,e,i,r);if(n===utils.ARRAY)return dotArray(t,e,i,r);if("value"!==n)return t;var u,f=utils.splitUnit(""+t),c=utils.splitUnit(""+e);if(isNaN(f.value)||isNaN(c.value))return t;u=utils.dot(f.value,c.value,i,r);var l=f.prefix||c.prefix,h=f.unit||c.unit;return l||h?l+u+h:u}function dotValue(t,e,i,r,n,s){if(t===e)return r;if(t===i)return n;if(!s)return dot(r,n,t-e,i-t);var a=s((t-e)/(i-e));return dot(r,n,a,1-a)}function getNearTimeIndex(t,e){for(var i=t.length,r=0;r<i;++r){if(t[r]===e)return[r,r];if(t[r]>e)return[0<r?r-1:0,r]}return[i-1,i-1]}function makeAnimationProperties(t){var e=[];for(var i in t)e.push(utils.ANIMATION+"-"+utils.decamelize(i)+":"+t[i]+";");return e.join("")}function addTime(t,e){for(var i=t.length,r=0;r<i;++r)if(e<t[r])return void t.splice(r,0,e);t[i]=e}function addEntry(t,e,i){var r=t[t.length-1];r&&r[0]===e&&r[1]===i||t.push([toFixed(e),toFixed(i)])}function getEntries(t,e){var I=t.map(function(t){return[t,t]}),d=[];return e.forEach(function(t){for(var e=t[ITERATION_COUNT],i=t[DELAY],r=t[PLAY_SPEED],n=t[DIRECTION],s=Math.ceil(e),a=I[I.length-1][0],o=I.length,u=a*e,f=0;f<s;++f)for(var c=n===REVERSE||n===ALTERNATE&&f%2||n===ALTERNATE_REVERSE&&!(f%2),l=0;l<o;++l){var h=I[c?o-l-1:l],E=h[1],T=a*f+(c?a-h[0]:h[0]),m=I[c?o-l:l-1];if(u<T){if(0!==l){var p=a*f+(c?a-m[0]:m[0]),v=utils.dot(m[1],E,u-p,T-u);addEntry(d,(i+a*e)/r,v)}break}if(T===u&&d.length&&d[d.length-1][0]===u+i)break;addEntry(d,(i+T)/r,E)}i&&d.unshift([0,d[0][1]]),I=d,d=[]}),I}var SceneItem=function(u){function I(t,e){var i=u.call(this)||this;return i.times=[],i.items={},i.names={},i.elements=[],i.needUpdate=!0,i.load(t,e),i}__extends(I,u);var t=I.prototype;return t.getDuration=function(){var t=this.times,e=t.length;return(0===e?0:t[e-1])||this.state[DURATION]},t.size=function(){return this.times.length},t.setDuration=function(t){if(!t)return this;var e=this.getDuration();if(0<e){var i=t/e,r=this.times,n=this.items,s={};this.times=r.map(function(t){var e=toFixed(t*i);return s[e]=n[t],e}),this.items=s}else this.newFrame(t);return this},t.setId=function(t){var e=this.state;e.id=t||makeId(!!length);var i=this.elements;if(i.length&&!e[SELECTOR]){var r=toId(this.getId());e[SELECTOR]="["+DATA_SCENE_ID+'="'+r+'"]',i.forEach(function(t){t.setAttribute(DATA_SCENE_ID,r)})}return this},t.set=function(i){for(var a=this,t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];if(utils.isArray(i))for(var r=i.length,n=0;n<r;++n){var s=1===r?0:this.getUnitTime(n/(r-1)*100+"%");this.set(s,i[n])}else if(utils.isObject(i)){var o=function(t){var s=i[t],e=u.getUnitTime(t);isNaN(e)?getNames(s,[t]).forEach(function(t){for(var e=getValueByNames(t.slice(1),s),i=utils.isArray(e)?e:[getValueByNames(t,a.target),e],r=i.length,n=0;n<r;++n)a.newFrame(n/(r-1)*100+"%").set(t,i[n])}):u.set(e,s)},u=this;for(var s in i)o(s)}else{var f=t[0];if(f instanceof Frame)this.setFrame(i,f);else if(f instanceof I){var c=f.getDelay(),l=this.getUnitTime(i),h=f.toObject(!this.hasFrame(l+c)),E=f.getDuration(),T=-1<f.getDirection().indexOf("reverse");for(var m in h){var p=T?E-parseFloat(m):parseFloat(m);this.set(l+p,h[m])}}else if(1===t.length&&utils.isArray(f))f.forEach(function(t){a.set(i,t)});else{var v=this.newFrame(i);v.set.apply(v,t)}}return this.needUpdate=!0,this},t.get=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var r=this.getFrame(t);return r&&r.get.apply(r,e)},t.remove=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];if(e.length){var r=this.getFrame(t);r&&r.remove.apply(r,e)}else this.removeFrame(t);return this.needUpdate=!0,this},t.append=function(t){return t instanceof I?this.set(this.getDuration(),t):this.append(new I(t)),this},t.prepend=function(t){if(t instanceof I){var e=t.getDuration()+t.getDelay(),i=this.getFrame(0);this.removeFrame(0),this.unshift(e),this.set(0,t),this.set(e+THRESHOLD,i)}else this.prepend(new I(t));return this},t.unshift=function(i){var t=this.times,r=this.items,n={};return this.times=t.map(function(t){var e=toFixed(i+t);return n[e]=r[t],e}),this.items=n,this},t.toObject=function(i){void 0===i&&(i=!0);var r={},n=this.getDelay();return this.forEach(function(t,e){r[(e||i?0:THRESHOLD)+n+e]=t.clone()}),r},t.setSelector=function(t){return utils.isFunction(t)?this.setElement(t(this.getId())):this.setElement(t),this},t.getElements=function(){return this.elements},t.setElements=function(t){return this.setElement(t)},t.setElement=function(t){var a=this.state,o=[];if(!t)return this;if(!0===t||utils.isString(t)){var e=!0===t?""+a.id:t,i=/([\s\S]+)(:+[a-zA-Z]+)$/g.exec(e);o=utils.toArray(utils.$(i?i[1]:e,!0)),a[SELECTOR]=e}else o=t instanceof Element?[t]:utils.toArray(t);return o.length&&(this.elements=o,this.setId(this.getId()),this.target=o[0].style,this.targetFunc=function(t){var i=t.get("attribute");if(i){var e=function(e){o.forEach(function(t){t.setAttribute(e,i[e])})};for(var r in i)e(r)}if(t.has("html")){var n=t.get("html");o.forEach(function(t){t.innerHTML=n})}var s=t.toCSS();if(a.cssText!==s)return a.cssText=s,o.forEach(function(t){t.style.cssText+=s}),t}),this},t.setTarget=function(r){return this.target=r,this.targetFunc=function(t){var e=t.get();for(var i in e)r[i]=e[i]},this},t.setCSS=function(t,e){return this.set(t,utils.fromCSS(this.elements,e)),this},t.setTime=function(t,e,i,r){u.prototype.setTime.call(this,t,e,i);var n=this.getIterationTime(),s=this.getEasing()||r,a=this.getNowFrame(n,s),o=this.getTime();return this.temp=a,this.trigger("animate",{frame:a,currentTime:o,time:n}),this.targetFunc&&this.targetFunc(a),this},t.update=function(){var e={};return this.forEach(function(t){updateFrame(e,t.properties)}),this.names=e,this.needUpdate=!1,this},t.newFrame=function(t){var e=this.getFrame(t);return e||(e=new Frame,this.setFrame(t,e),e)},t.setFrame=function(t,e){var i=this.getUnitTime(t);return this.items[i]=e,addTime(this.times,i),this.needUpdate=!0,this},t.getFrame=function(t){return this.items[this.getUnitTime(t)]},t.removeFrame=function(t){var e=this.getUnitTime(t),i=this.items,r=this.times.indexOf(e);return delete i[e],-1<r&&this.times.splice(r,1),this.needUpdate=!0,this},t.hasFrame=function(t){return this.getUnitTime(t)in this.items},t.hasName=function(t){return this.needUpdate&&this.update(),isInProperties(this.names,t,!0)},t.mergeFrame=function(t,e){e&&this.newFrame(t).merge(e);return this},t.getNowFrame=function(i,t,r){var n=this;this.needUpdate&&this.update();var s=new Frame,e=getNearTimeIndex(this.times,i),a=e[0],o=e[1],u=this.getEasing()||t,f=this.names;if(this.hasName([TIMING_FUNCTION])){var c=this.getNowValue(i,[TIMING_FUNCTION],a,o,!1,0,!0);utils.isFunction(c)&&(u=c)}if(r){var l=updateFrame({},this.getFrame(i).properties);for(var h in ROLES)h in l&&(l[h]=f[h]);f=l}return getNames(f,[]).forEach(function(t){var e=n.getNowValue(i,t,a,o,r,u,isFixed(t));utils.isUndefined(e)||s.set(t,e)}),s},t.load=function(t,e){var i;if(void 0===t&&(t={}),void 0===e&&(e=t.options),e&&this.setOptions(e),utils.isArray(t))this.set(t);else if(t.keyframes)this.set(t.keyframes);else for(var r in t)"options"!==r&&this.set(((i={})[r]=t[r],i));return e&&e[DURATION]&&this.setDuration(e[DURATION]),this},t.clone=function(){var i=new I;return i.setOptions(this.state),this.forEach(function(t,e){i.setFrame(e,t.clone())}),i},t.forEach=function(e){var t=this.times,i=this.items;return t.forEach(function(t){e(i[t],t,i)}),this},t.setOptions=function(t){void 0===t&&(t={}),u.prototype.setOptions.call(this,t);var e=t.id,i=t.selector,r=t.elements,n=t.element,s=t.target;return e&&this.setId(e),s?this.setTarget(s):i?this.setSelector(i):(r||n)&&this.setElement(r||n),this},t.toCSS=function(t,e,i){void 0===t&&(t={className:START_ANIMATION}),void 0===e&&(e=this.getDuration()),void 0===i&&(i=[]);var r=this.state,n=r[SELECTOR];if(!n)return"";var s=this.getDuration();r[DURATION]=s,i.push(r);var a=utils.toArray(i).reverse(),o=toId(getRealId(this)),u=i[0],f=utils.findIndex(a,function(t){return t[ITERATION_COUNT]===INFINITE||!isFinite(t[DURATION])},i.length-1),c=a.slice(0,f),l=e||c.reduce(function(t,e){return(e[DELAY]+t*e[ITERATION_COUNT])/e[PLAY_SPEED]},s),h=a.slice(f).reduce(function(t,e){return(t+e[DELAY])/e[PLAY_SPEED]},0),E=utils.find(a,function(t){return t[EASING]&&t[EASING_NAME]},r)[EASING_NAME],T=a[f][ITERATION_COUNT],m=u[FILL_MODE],p=a[f][DIRECTION],v=makeAnimationProperties({fillMode:m,direction:p,iterationCount:T,delay:h+"s",name:PREFIX+"KEYFRAMES_"+o,duration:l/u[PLAY_SPEED]+"s",timingFunction:E}),I=utils.splitComma(n).map(function(t){var e=/([\s\S]+)(:+[a-zA-Z]+)$/g.exec(t);return e?[e[1],e[2]]:[t,""]}),d=t.className,A=t.selector;return"\n    "+((utils.isFunction(A)?A(this,n):A)||I.map(function(t){var e=t[0],i=t[1];return e+"."+d+i}))+" {"+v+"}\n    "+I.map(function(t){var e=t[0],i=t[1];return e+"."+PAUSE_ANIMATION+i})+" {"+utils.ANIMATION+"-play-state: paused;}\n    @"+utils.KEYFRAMES+" "+PREFIX+"KEYFRAMES_"+o+"{"+this._toKeyframes(l,c,p)+"}"},t.exportCSS=function(t,e,i){if(!this.elements.length)return"";var r=this.toCSS(t,e,i);return i&&!utils.isUndefined(i[ITERATION_COUNT])||exportCSS(getRealId(this),r),this},t.pause=function(){return u.prototype.pause.call(this),isPausedCSS(this)&&this.pauseCSS(),this},t.pauseCSS=function(){return this.elements.forEach(function(t){utils.addClass(t,PAUSE_ANIMATION)}),this},t.endCSS=function(){return this.elements.forEach(function(t){utils.removeClass(t,PAUSE_ANIMATION),utils.removeClass(t,START_ANIMATION)}),setPlayCSS(this,!1),this},t.end=function(){return isEndedCSS(this)&&this.endCSS(),u.prototype.end.call(this),this},t.playCSS=function(t,e,i){return void 0===t&&(t=!0),void 0===i&&(i={}),playCSS(this,t,e,i),this},t.addPlayClass=function(t,e,i){void 0===i&&(i={});var r=this.elements,n=r.length,s=makeAnimationProperties(i);if(n)return t?r.forEach(function(t){utils.removeClass(t,PAUSE_ANIMATION)}):r.forEach(function(t){t.style.cssText+=s,utils.hasClass(t,START_ANIMATION)?(utils.removeClass(t,START_ANIMATION),utils.requestAnimationFrame(function(){utils.requestAnimationFrame(function(){utils.addClass(t,START_ANIMATION)})})):utils.addClass(t,START_ANIMATION)}),r[0]},t.getNowValue=function(t,e,i,r,n,s,a){var o,u,f,c,l=this.times,h=l.length,E=utils.isUndefined(i),T=utils.isUndefined(r);if(E||T){var m=getNearTimeIndex(l,t);E&&(i=m[0]),T&&(r=m[1])}for(var p=i;0<=p;--p){if((I=this.getFrame(l[p])).has.apply(I,e)){o=l[p],f=I;break}}var v=f&&f.raw.apply(f,e);if(n&&!isRole([e[0]]))return o===t?v:void 0;if(a)return v;for(p=r;p<h;++p){var I;if((I=this.getFrame(l[p])).has.apply(I,e)){u=l[p],c=I;break}}var d=c&&c.raw.apply(c,e);return!f||utils.isUndefined(v)?d:!c||utils.isUndefined(d)||v===d?v:dotValue(t,Math.max(o,0),u,v,d,s)},t._toKeyframes=function(n,t,s){var a=this,o={},e=this.times.slice();if(!e.length)return"";var u=this.getDuration();this.getFrame(0)||e.unshift(0),this.getFrame(u)||e.push(u);var i=getEntries(e,t),r=i[i.length-1];r[0]<n&&addEntry(i,n,r[1]);var f=-1;return i.map(function(t){var e=t[0],i=t[1];o[i]||(o[i]=(a.hasFrame(i)&&0!==i&&i!==u?a.getNowFrame(i,0,!0):a.getNowFrame(i)).toCSS());var r=e/n*100;return r-f<THRESHOLD&&(r+=THRESHOLD),f=r,Math.min(r,100)+"%{\n                "+(0!==e||isDirectionReverse(0,1,s)?o[i]:"")+"\n            }"}).join("")},I}(Animator),Scene=function(o){function c(t,e){var i=o.call(this)||this;return i.items=new ListMap,i.load(t,e),i}__extends(c,o);var t=c.prototype;return t.getDuration=function(){var e=0;return this.forEach(function(t){e=Math.max(e,t.getTotalDuration()/t.getPlaySpeed())}),e||this.state[DURATION]},t.setDuration=function(e){this.items;var t=this.getDuration();if(0===e||!isFinite(t))return this;if(0===t)this.forEach(function(t){t.setDuration(e)});else{var i=e/t;this.forEach(function(t){t.setDelay(t.getDelay()*i),t.setDuration(t.getDuration()*i)})}return o.prototype.setDuration.call(this,e),this},t.getItem=function(t){return this.items.get(t)},t.newItem=function(t,e){if(void 0===e&&(e={}),this.items.has(t))return this.items.get(t);var i=new SceneItem;return this.setItem(t,i),i.setOptions(e),i},t.removeItem=function(t){return this.items.remove(t),this},t.setItem=function(t,e){return e.setId(t),this.items.set(t,e),this},t.setTime=function(t,e,i,r){o.prototype.setTime.call(this,t,e,i);var n=this.getIterationTime(),s=this.getEasing()||r,a={};return this.forEach(function(t){t.setTime(n*t.getPlaySpeed()-t.getDelay(),e,!0,s),a[t.getId()]=t.temp}),this.temp=a,this.trigger("animate",{frames:a,currentTime:this.getTime(),time:n}),this},t.forEach=function(n){return this.items.forEach(function(t,e,i,r){n(t,e,i,r)}),this},t.toCSS=function(e,t,i){void 0===t&&(t=this.getDuration()),void 0===i&&(i=[]);var r=t&&isFinite(t)?t:0,n=[],s=this.state;return s[DURATION]=this.getDuration(),this.forEach(function(t){n.push(t.toCSS(e,r,i.concat(s)))}),n.join("")},t.exportCSS=function(t,e,i){var r=this.toCSS(t,e,i);return i&&i.length||exportCSS(getRealId(this),r),this},t.append=function(t){t.setDelay(t.getDelay()+this.getDuration()),this.setItem(getRealId(t),t)},t.pauseCSS=function(){return this.forEach(function(t){t.pauseCSS()})},t.pause=function(){return o.prototype.pause.call(this),isPausedCSS(this)&&this.pauseCSS(),this.forEach(function(t){t.pause()}),this},t.endCSS=function(){this.forEach(function(t){t.endCSS()}),setPlayCSS(this,!1)},t.end=function(){return isEndedCSS(this)&&this.endCSS(),o.prototype.end.call(this),this},t.addPlayClass=function(i,r,n){var s;return void 0===n&&(n={}),this.forEach(function(t){var e=t.addPlayClass(i,r,n);s=s||e}),s},t.playCSS=function(t,e,i){return void 0===t&&(t=!0),void 0===i&&(i={}),playCSS(this,t,e,i),this},t.set=function(t){return this.load(t),this},t.load=function(t,e){if(void 0===t&&(t={}),void 0===e&&(e=t.options),!t)return this;var i=e&&e[SELECTOR]||this.state[SELECTOR];for(var r in t)if("options"!==r){var n=t[r],s=void 0;if(n instanceof c||n instanceof SceneItem)this.setItem(r,n),s=n;else{if(utils.isFunction(n)&&i){for(var a=utils.IS_WINDOW?utils.$(""+(utils.isFunction(i)?i(r):r),!0):[],o=a.length,u=new c,f=0;f<o;++f)u.newItem(f).setId().setElement(a[f]).load(n(f,a[f]));this.setItem(r,u);continue}(s=this.newItem(r)).load(n)}i&&s.setSelector(i)}this.setOptions(e)},t.setOptions=function(t){void 0===t&&(t={}),o.prototype.setOptions.call(this,t);var e=t.selector;return e&&(this.state[SELECTOR]=e),this},t.setSelector=function(i){var t=this.state,r=i||t[SELECTOR];t[SELECTOR]=r;var n=utils.isFunction(i);return r&&this.forEach(function(t,e){t.setSelector(n?i(e):r)}),this},t.start=function(t){void 0===t&&(t=this.state[DELAY]);var e=o.prototype.start.call(this,t);return e?this.forEach(function(t){t.start(0)}):this.forEach(function(t){t.setPlayState(RUNNING)}),e},c.VERSION="1.1.2",c}(Animator);function animate(t,e){return new Scene(t,e).play()}function animateItem(t,e){return new SceneItem(t,e).play()}var others={SceneItem:SceneItem,Frame:Frame,Animator:Animator,default:Scene,OPTIONS:OPTIONS,EVENTS:EVENTS,FIXED:FIXED,ROLES:ROLES,setRole:setRole,setAlias:setAlias,bezier:bezier,steps:steps,STEP_START:STEP_START,STEP_END:STEP_END,LINEAR:LINEAR,EASE:EASE,EASE_IN:EASE_IN,EASE_OUT:EASE_OUT,EASE_IN_OUT:EASE_IN_OUT,animate:animate,animateItem:animateItem};for(var name in others)Scene[name]=others[name];module.exports=Scene;