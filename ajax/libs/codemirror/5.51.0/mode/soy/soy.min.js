!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../htmlmixed/htmlmixed"],t):t(CodeMirror)}(function(T){"use strict";var t={noEndTag:!0,soyState:"param-def"},E={alias:{noEndTag:!0},delpackage:{noEndTag:!0},namespace:{noEndTag:!0,soyState:"namespace-def"},"@param":t,"@param?":t,"@inject":t,"@inject?":t,"@state":t,template:{soyState:"templ-def",variableScope:!0},literal:{},msg:{},fallbackmsg:{noEndTag:!0,reduceIndent:!0},select:{},plural:{},let:{soyState:"var-def"},if:{},elseif:{noEndTag:!0,reduceIndent:!0},else:{noEndTag:!0,reduceIndent:!0},switch:{},case:{noEndTag:!0,reduceIndent:!0},default:{noEndTag:!0,reduceIndent:!0},foreach:{variableScope:!0,soyState:"var-def"},ifempty:{noEndTag:!0,reduceIndent:!0},for:{variableScope:!0,soyState:"var-def"},call:{soyState:"templ-ref"},param:{soyState:"param-ref"},print:{noEndTag:!0},deltemplate:{soyState:"templ-def",variableScope:!0},delcall:{soyState:"templ-ref"},log:{},element:{variableScope:!0}},I=Object.keys(E).filter(function(t){return!E[t].noEndTag||E[t].reduceIndent});T.defineMode("soy",function(h){var t=T.getMode(h,"text/plain"),y={html:T.getMode(h,{name:"text/html",multilineTagIndentFactor:2,multilineTagIndentPastTag:!1}),attributes:t,text:t,uri:t,trusted_resource_uri:t,css:T.getMode(h,"text/css"),js:T.getMode(h,{name:"text/javascript",statementIndent:2*h.indentUnit})};function S(t){return t[t.length-1]}function v(e,a,t){if(e.sol()){for(var n=0;n<a.indent&&e.eat(/\s/);n++);if(n)return null}var r=e.string,o=t.exec(r.substr(e.pos));o&&(e.string=r.substr(0,e.pos+o.index));var s=e.hideFirstChars(a.indent,function(){var t=S(a.localStates);return t.mode.token(e,t.state)});return e.string=r,s}function x(t,e){return{element:e,next:t}}function b(t){t.context&&(t.context.scope&&(t.variables=t.context.scope),t.context=t.context.previousContext)}function w(t,e,a){return function(t,e){for(;t;){if(t.element===e)return 1;t=t.next}}(t,e)?"variable-2":a?"variable":"variable-2 error"}function k(t,e,a){this.previousContext=t,this.tag=e,this.kind=null,this.scope=a}return{startState:function(){return{soyState:[],templates:null,variables:x(null,"ij"),scopes:null,indent:0,quoteKind:null,context:null,localStates:[{mode:y.html,state:T.startState(y.html)}]}},copyState:function(t){return{tag:t.tag,soyState:t.soyState.concat([]),templates:t.templates,variables:t.variables,context:t.context,indent:t.indent,quoteKind:t.quoteKind,localStates:t.localStates.map(function(t){return{mode:t.mode,state:T.copyState(t.mode,t.state)}})}},token:function(t,e){switch(S(e.soyState)){case"comment":if(t.match(/^.*?\*\//)?e.soyState.pop():t.skipToEnd(),!e.context||!e.context.scope)for(var a=/@param\??\s+(\S+)/g,n=t.current();r=a.exec(n);)e.variables=x(e.variables,r[1]);return"comment";case"string":var r;return(r=t.match(/^.*?(["']|\\[\s\S])/))?r[1]==e.quoteKind&&(e.quoteKind=null,e.soyState.pop()):t.skipToEnd(),"string"}if(!e.soyState.length||"literal"!=S(e.soyState)){if(t.match(/^\/\*/))return e.soyState.push("comment"),"comment";if(t.match(t.sol()?/^\s*\/\/.*/:/^\s+\/\/.*/))return"comment"}switch(S(e.soyState)){case"templ-def":return(r=t.match(/^\.?([\w]+(?!\.[\w]+)*)/))?(e.templates=x(e.templates,r[1]),e.soyState.pop(),"def"):(t.next(),null);case"templ-ref":return(r=t.match(/(\.?[a-zA-Z_][a-zA-Z_0-9]+)+/))?(e.soyState.pop(),"."==r[0][0]?"variable-2":"variable"):(t.next(),null);case"namespace-def":return(r=t.match(/^\.?([\w\.]+)/))?(e.soyState.pop(),"variable"):(t.next(),null);case"param-def":return(r=t.match(/^\w+/))?(e.variables=x(e.variables,r[0]),e.soyState.pop(),e.soyState.push("param-type"),"def"):(t.next(),null);case"param-ref":return(r=t.match(/^\w+/))?(e.soyState.pop(),"property"):(t.next(),null);case"param-type":var o=t.peek();return"}"==o||"="==o?(e.soyState.pop(),null):t.eatWhile(/^([\w]+|[?])/)?"type":(t.next(),null);case"var-def":return(r=t.match(/^\$([\w]+)/))?(e.variables=x(e.variables,r[1]),e.soyState.pop(),"def"):(t.next(),null);case"tag":var s=(m="/"==e.tag[0])?e.tag.substring(1):e.tag,i=E[s];if(t.match(/^\/?}/)){var l="/}"==t.current();return l&&!m&&b(e),"/template"==e.tag||"/deltemplate"==e.tag?(e.variables=x(null,"ij"),e.indent=0):e.indent-=h.indentUnit*(l||-1==I.indexOf(e.tag)?2:1),e.soyState.pop(),"keyword"}if(t.match(/^([\w?]+)(?==)/)){if(e.context&&e.context.tag==s&&"kind"==t.current()&&(r=t.match(/^="([^"]+)/,!1))){var c=r[1];e.context.kind=c;var d=y[c]||y.html;(g=S(e.localStates)).mode.indent&&(e.indent+=g.mode.indent(g.state,"","")),e.localStates.push({mode:d,state:T.startState(d)})}return"attribute"}return(r=t.match(/([\w]+)(?=\()/))?"variable callee":(r=t.match(/^["']/))?(e.soyState.push("string"),e.quoteKind=r,"string"):t.match(/(null|true|false)(?!\w)/)||t.match(/0x([0-9a-fA-F]{2,})/)||t.match(/-?([0-9]*[.])?[0-9]+(e[0-9]*)?/)?"atom":t.match(/(\||[+\-*\/%]|[=!]=|\?:|[<>]=?)/)?"operator":(r=t.match(/^\$([\w]+)/))?w(e.variables,r[1]):(r=t.match(/^\w+/))?/^(?:as|and|or|not|in)$/.test(r[0])?"keyword":null:(t.next(),null);case"literal":return t.match(/^(?=\{\/literal})/)?(e.soyState.pop(),this.token(t,e)):v(t,e,/\{\/literal}/)}if(t.match(/^\{literal}/))return e.indent+=h.indentUnit,e.soyState.push("literal"),e.context=new k(e.context,"literal",e.variables),"keyword";if(r=t.match(/^\{([/@\\]?\w+\??)(?=$|[\s}]|\/[/*])/)){var u=e.tag;e.tag=r[1];var m="/"==e.tag[0],p=!!E[e.tag];s=m?e.tag.substring(1):e.tag,i=E[s];"/switch"!=e.tag&&(e.indent+=((m||i&&i.reduceIndent)&&"switch"!=u?1:2)*h.indentUnit),e.soyState.push("tag");var f=!1;if(i)if(m||i.soyState&&e.soyState.push(i.soyState),i.noEndTag||!p&&m){if(m)if(e.context&&e.context.tag==s){if(e.context){var g;if(e.context.kind)e.localStates.pop(),(g=S(e.localStates)).mode.indent&&(e.indent-=g.mode.indent(g.state,"",""));b(e)}}else f=!0}else e.context=new k(e.context,e.tag,i.variableScope?e.variables:null);else m&&(f=!0);return(f?"error ":"")+"keyword"}return t.eat("{")?(e.tag="print",e.indent+=2*h.indentUnit,e.soyState.push("tag"),"keyword"):v(t,e,/\{|\s+\/\/|\/\*/)},indent:function(t,e,a){var n=t.indent,r=S(t.soyState);if("comment"==r)return T.Pass;if("literal"==r)/^\{\/literal}/.test(e)&&(n-=h.indentUnit);else{if(/^\s*\{\/(template|deltemplate)\b/.test(e))return 0;/^\{(\/|(fallbackmsg|elseif|else|ifempty)\b)/.test(e)&&(n-=h.indentUnit),"switch"!=t.tag&&/^\{(case|default)\b/.test(e)&&(n-=h.indentUnit),/^\{\/switch\b/.test(e)&&(n-=h.indentUnit)}var o=S(t.localStates);return n&&o.mode.indent&&(n+=o.mode.indent(o.state,e,a)),n},innerMode:function(t){return t.soyState.length&&"literal"!=S(t.soyState)?null:S(t.localStates)},electricInput:/^\s*\{(\/|\/template|\/deltemplate|\/switch|fallbackmsg|elseif|else|case|default|ifempty|\/literal\})$/,lineComment:"//",blockCommentStart:"/*",blockCommentEnd:"*/",blockCommentContinue:" * ",useInnerComments:!1,fold:"indent"}},"htmlmixed"),T.registerHelper("wordChars","soy",/[\w$]/),T.registerHelper("hintWords","soy",Object.keys(E).concat(["css","debugger"])),T.defineMIME("text/x-soy","soy")});