import _extends from"@babel/runtime/helpers/esm/extends";import _objectWithoutPropertiesLoose from"@babel/runtime/helpers/esm/objectWithoutPropertiesLoose";import React from"react";import PropTypes from"prop-types";import ReactDOM from"react-dom";import{elementTypeAcceptingRef}from"@material-ui/utils";import Drawer,{getAnchor,isHorizontal}from"../Drawer/Drawer";import ownerDocument from"../utils/ownerDocument";import useEventCallback from"../utils/useEventCallback";import{duration}from"../styles/transitions";import useTheme from"../styles/useTheme";import{getTransitionProps}from"../transitions/utils";import NoSsr from"../NoSsr";import SwipeArea from"./SwipeArea";const UNCERTAINTY_THRESHOLD=3;let nodeThatClaimedTheSwipe=null;export function reset(){nodeThatClaimedTheSwipe=null};function calculateCurrentX(e,t){return"right"===e?document.body.offsetWidth-t[0].pageX:t[0].pageX}function calculateCurrentY(e,t){return"bottom"===e?window.innerHeight-t[0].clientY:t[0].clientY}function getMaxTranslate(e,t){return e?t.clientWidth:t.clientHeight}function getTranslate(e,t,r,n){return Math.min(Math.max(r?t-e:n+t-e,0),n)}function getDomTreeShapes(e,t){let r=[];for(;e&&e!==t;){const t=window.getComputedStyle(e);"absolute"===t.getPropertyValue("position")||"hidden"===t.getPropertyValue("overflow-x")?r=[]:(e.clientWidth>0&&e.scrollWidth>e.clientWidth||e.clientHeight>0&&e.scrollHeight>e.clientHeight)&&r.push(e),e=e.parentElement}return r}function findNativeHandler({domTreeShapes:e,start:t,current:r,anchor:n}){const o={x:"scrollLeft",y:"scrollTop"},a={x:"scrollWidth",y:"scrollHeight"},i={x:"clientWidth",y:"clientHeight"};return e.some(e=>{let s=r>=t;"top"!==n&&"left"!==n||(s=!s);const c="left"===n||"right"===n?"x":"y",l=e[o[c]],u=l>0,p=l+e[i[c]]<e[a[c]];return s&&p||!s&&u?e:null})}const disableSwipeToOpenDefault="undefined"!=typeof navigator&&/iPad|iPhone|iPod/.test(navigator.userAgent),transitionDurationDefault={enter:duration.enteringScreen,exit:duration.leavingScreen},useEnhancedEffect="undefined"!=typeof window?React.useLayoutEffect:React.useEffect,SwipeableDrawer=React.forwardRef(function(e,t){const{anchor:r="left",disableBackdropTransition:n=!1,disableDiscovery:o=!1,disableSwipeToOpen:a=disableSwipeToOpenDefault,hideBackdrop:i,hysteresis:s=.52,minFlingVelocity:c=450,ModalProps:{BackdropProps:l}={},onClose:u,onOpen:p,open:d,PaperProps:m={},SwipeAreaProps:f,swipeAreaWidth:h=20,transitionDuration:T=transitionDurationDefault,variant:y="temporary"}=e,g=_objectWithoutPropertiesLoose(e.ModalProps,["BackdropProps"]),w=_objectWithoutPropertiesLoose(e,["anchor","disableBackdropTransition","disableDiscovery","disableSwipeToOpen","hideBackdrop","hysteresis","minFlingVelocity","ModalProps","onClose","onOpen","open","PaperProps","SwipeAreaProps","swipeAreaWidth","transitionDuration","variant"]),b=useTheme(),[P,v]=React.useState(!1),S=React.useRef({isSwiping:null}),R=React.useRef(),D=React.useRef(),C=React.useRef(),E=React.useRef(!1),x=React.useRef();useEnhancedEffect(()=>{x.current=null},[d]);const M=React.useCallback((e,t={})=>{const{mode:o=null,changeTransition:a=!0}=t,s=getAnchor(b,r),c=-1!==["right","bottom"].indexOf(s)?1:-1,l=isHorizontal(r),u=l?`translate(${c*e}px, 0)`:`translate(0, ${c*e}px)`,p=C.current.style;p.webkitTransform=u,p.transform=u;let d="";if(o&&(d=b.transitions.create("all",getTransitionProps({timeout:T},{mode:o}))),a&&(p.webkitTransition=d,p.transition=d),!n&&!i){const t=D.current.style;t.opacity=1-e/getMaxTranslate(l,C.current),a&&(t.webkitTransition=d,t.transition=d)}},[r,n,i,b,T]),H=useEventCallback(e=>{if(!E.current)return;if(nodeThatClaimedTheSwipe=null,E.current=!1,v(!1),!S.current.isSwiping)return void(S.current.isSwiping=null);S.current.isSwiping=null;const t=getAnchor(b,r),n=isHorizontal(r);let o;o=n?calculateCurrentX(t,e.changedTouches):calculateCurrentY(t,e.changedTouches);const a=n?S.current.startX:S.current.startY,i=getMaxTranslate(n,C.current),l=getTranslate(o,a,d,i),m=l/i;Math.abs(S.current.velocity)>c&&(x.current=1e3*Math.abs((i-l)/S.current.velocity)),d?S.current.velocity>c||m>s?u():M(0,{mode:"exit"}):S.current.velocity<-c||1-m>s?p():M(getMaxTranslate(n,C.current),{mode:"enter"})}),k=useEventCallback(e=>{if(!C.current||!E.current)return;if(null!=nodeThatClaimedTheSwipe&&nodeThatClaimedTheSwipe!==S.current)return;const t=getAnchor(b,r),n=isHorizontal(r),a=calculateCurrentX(t,e.touches),i=calculateCurrentY(t,e.touches);if(d&&C.current.contains(e.target)&&null==nodeThatClaimedTheSwipe){const t=findNativeHandler({domTreeShapes:getDomTreeShapes(e.target,C.current),start:n?S.current.startX:S.current.startY,current:n?a:i,anchor:r});if(t)return void(nodeThatClaimedTheSwipe=t);nodeThatClaimedTheSwipe=S.current}if(null==S.current.isSwiping){const t=Math.abs(a-S.current.startX),r=Math.abs(i-S.current.startY);t>r&&e.cancelable&&e.preventDefault();const s=n?t>r&&t>3:r>t&&r>3;if(!0===s||(n?r>3:t>3)){if(S.current.isSwiping=s,!s)return void H(e);S.current.startX=a,S.current.startY=i,o||d||(n?S.current.startX-=h:S.current.startY-=h)}}if(!S.current.isSwiping)return;const s=getMaxTranslate(n,C.current);let c=n?S.current.startX:S.current.startY;d&&!S.current.paperHit&&(c=Math.min(c,s));const l=getTranslate(n?a:i,c,d,s);if(d)if(S.current.paperHit)0===l&&(S.current.startX=a,S.current.startY=i);else{if(!(n?a<s:i<s))return;S.current.paperHit=!0,S.current.startX=a,S.current.startY=i}null===S.current.lastTranslate&&(S.current.lastTranslate=l,S.current.lastTime=performance.now()+1);const u=(l-S.current.lastTranslate)/(performance.now()-S.current.lastTime)*1e3;S.current.velocity=.4*S.current.velocity+.6*u,S.current.lastTranslate=l,S.current.lastTime=performance.now(),e.cancelable&&e.preventDefault(),M(l)}),A=useEventCallback(e=>{if(e.defaultPrevented)return;if(e.muiHandled)return;if(d&&!D.current.contains(e.target)&&!C.current.contains(e.target))return;const t=getAnchor(b,r),n=isHorizontal(r),i=calculateCurrentX(t,e.touches),s=calculateCurrentY(t,e.touches);if(!d){if(a||e.target!==R.current)return;if(n){if(i>h)return}else if(s>h)return}e.muiHandled=!0,nodeThatClaimedTheSwipe=null,S.current.startX=i,S.current.startY=s,v(!0),!d&&C.current&&M(getMaxTranslate(n,C.current)+(o?20:-h),{changeTransition:!1}),S.current.velocity=0,S.current.lastTime=null,S.current.lastTranslate=null,S.current.paperHit=!1,E.current=!0});React.useEffect(()=>{if("temporary"===y){const e=ownerDocument(C.current);return e.addEventListener("touchstart",A),e.addEventListener("touchmove",k,{passive:!1}),e.addEventListener("touchend",H),()=>{e.removeEventListener("touchstart",A),e.removeEventListener("touchmove",k,{passive:!1}),e.removeEventListener("touchend",H)}}},[y,A,k,H]),React.useEffect(()=>()=>{nodeThatClaimedTheSwipe===S.current&&(nodeThatClaimedTheSwipe=null)},[]),React.useEffect(()=>{d||v(!1)},[d]);const O=React.useCallback(e=>{D.current=ReactDOM.findDOMNode(e)},[]),Y=React.useCallback(e=>{C.current=ReactDOM.findDOMNode(e)},[]);return React.createElement(React.Fragment,null,React.createElement(Drawer,_extends({open:!("temporary"!==y||!P)||d,variant:y,ModalProps:_extends({BackdropProps:_extends({},l,{ref:O})},g),PaperProps:_extends({},m,{style:_extends({pointerEvents:"temporary"!==y||d?"":"none"},m.style),ref:Y}),anchor:r,transitionDuration:x.current||T,onClose:u,ref:t},w)),!a&&"temporary"===y&&React.createElement(NoSsr,null,React.createElement(SwipeArea,_extends({anchor:r,ref:R,width:h},f))))});"production"!==process.env.NODE_ENV&&(SwipeableDrawer.propTypes={anchor:PropTypes.oneOf(["left","top","right","bottom"]),children:PropTypes.node,disableBackdropTransition:PropTypes.bool,disableDiscovery:PropTypes.bool,disableSwipeToOpen:PropTypes.bool,hideBackdrop:PropTypes.bool,hysteresis:PropTypes.number,minFlingVelocity:PropTypes.number,ModalProps:PropTypes.shape({BackdropProps:PropTypes.shape({component:elementTypeAcceptingRef})}),onClose:PropTypes.func.isRequired,onOpen:PropTypes.func.isRequired,open:PropTypes.bool.isRequired,PaperProps:PropTypes.shape({component:elementTypeAcceptingRef,style:PropTypes.object}),SwipeAreaProps:PropTypes.object,swipeAreaWidth:PropTypes.number,transitionDuration:PropTypes.oneOfType([PropTypes.number,PropTypes.shape({enter:PropTypes.number,exit:PropTypes.number})]),variant:PropTypes.oneOf(["permanent","persistent","temporary"])});export default SwipeableDrawer;