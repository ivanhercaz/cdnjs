import _extends from"@babel/runtime/helpers/esm/extends";import _objectWithoutProperties from"@babel/runtime/helpers/esm/objectWithoutProperties";import React from"react";import PropTypes from"prop-types";import ReactDOM from"react-dom";import{elementTypeAcceptingRef}from"@material-ui/utils";import Drawer,{getAnchor,isHorizontal}from"../Drawer/Drawer";import ownerDocument from"../utils/ownerDocument";import useEventCallback from"../utils/useEventCallback";import{duration}from"../styles/transitions";import useTheme from"../styles/useTheme";import{getTransitionProps}from"../transitions/utils";import NoSsr from"../NoSsr";import SwipeArea from"./SwipeArea";var UNCERTAINTY_THRESHOLD=3,nodeThatClaimedTheSwipe=null;export function reset(){nodeThatClaimedTheSwipe=null};function calculateCurrentX(e,t){return"right"===e?document.body.offsetWidth-t[0].pageX:t[0].pageX}function calculateCurrentY(e,t){return"bottom"===e?window.innerHeight-t[0].clientY:t[0].clientY}function getMaxTranslate(e,t){return e?t.clientWidth:t.clientHeight}function getTranslate(e,t,r,n){return Math.min(Math.max(r?t-e:n+t-e,0),n)}function getDomTreeShapes(e,t){for(var r=[];e&&e!==t;){var n=window.getComputedStyle(e);"absolute"===n.getPropertyValue("position")||"hidden"===n.getPropertyValue("overflow-x")?r=[]:(e.clientWidth>0&&e.scrollWidth>e.clientWidth||e.clientHeight>0&&e.scrollHeight>e.clientHeight)&&r.push(e),e=e.parentElement}return r}function findNativeHandler(e){var t=e.domTreeShapes,r=e.start,n=e.current,a=e.anchor,o={x:"scrollLeft",y:"scrollTop"},i={x:"scrollWidth",y:"scrollHeight"},s={x:"clientWidth",y:"clientHeight"};return t.some(function(e){var t=n>=r;"top"!==a&&"left"!==a||(t=!t);var c="left"===a||"right"===a?"x":"y",u=e[o[c]],l=u>0,p=u+e[s[c]]<e[i[c]];return t&&p||!t&&l?e:null})}var disableSwipeToOpenDefault="undefined"!=typeof navigator&&/iPad|iPhone|iPod/.test(navigator.userAgent),transitionDurationDefault={enter:duration.enteringScreen,exit:duration.leavingScreen},useEnhancedEffect="undefined"!=typeof window?React.useLayoutEffect:React.useEffect,SwipeableDrawer=React.forwardRef(function(e,t){var r=e.anchor,n=void 0===r?"left":r,a=e.disableBackdropTransition,o=void 0!==a&&a,i=e.disableDiscovery,s=void 0!==i&&i,c=e.disableSwipeToOpen,u=void 0===c?disableSwipeToOpenDefault:c,l=e.hideBackdrop,p=e.hysteresis,d=void 0===p?.52:p,f=e.minFlingVelocity,m=void 0===f?450:f,h=e.ModalProps,T=(h=void 0===h?{}:h).BackdropProps,v=_objectWithoutProperties(h,["BackdropProps"]),y=e.onClose,g=e.onOpen,w=e.open,b=e.PaperProps,P=void 0===b?{}:b,R=e.SwipeAreaProps,S=e.swipeAreaWidth,D=void 0===S?20:S,E=e.transitionDuration,C=void 0===E?transitionDurationDefault:E,H=e.variant,x=void 0===H?"temporary":H,A=_objectWithoutProperties(e,["anchor","disableBackdropTransition","disableDiscovery","disableSwipeToOpen","hideBackdrop","hysteresis","minFlingVelocity","ModalProps","onClose","onOpen","open","PaperProps","SwipeAreaProps","swipeAreaWidth","transitionDuration","variant"]),O=useTheme(),M=React.useState(!1),k=M[0],Y=M[1],N=React.useRef({isSwiping:null}),_=React.useRef(),X=React.useRef(),W=React.useRef(),L=React.useRef(!1),B=React.useRef();useEnhancedEffect(function(){B.current=null},[w]);var j=React.useCallback(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.mode,a=void 0===r?null:r,i=t.changeTransition,s=void 0===i||i,c=getAnchor(O,n),u=-1!==["right","bottom"].indexOf(c)?1:-1,p=isHorizontal(n),d=p?"translate(".concat(u*e,"px, 0)"):"translate(0, ".concat(u*e,"px)"),f=W.current.style;f.webkitTransform=d,f.transform=d;var m="";if(a&&(m=O.transitions.create("all",getTransitionProps({timeout:C},{mode:a}))),s&&(f.webkitTransition=m,f.transition=m),!o&&!l){var h=X.current.style;h.opacity=1-e/getMaxTranslate(p,W.current),s&&(h.webkitTransition=m,h.transition=m)}},[n,o,l,O,C]),V=useEventCallback(function(e){if(L.current)if(nodeThatClaimedTheSwipe=null,L.current=!1,Y(!1),N.current.isSwiping){N.current.isSwiping=null;var t,r=getAnchor(O,n),a=isHorizontal(n);t=a?calculateCurrentX(r,e.changedTouches):calculateCurrentY(r,e.changedTouches);var o=a?N.current.startX:N.current.startY,i=getMaxTranslate(a,W.current),s=getTranslate(t,o,w,i),c=s/i;Math.abs(N.current.velocity)>m&&(B.current=1e3*Math.abs((i-s)/N.current.velocity)),w?N.current.velocity>m||c>d?y():j(0,{mode:"exit"}):N.current.velocity<-m||1-c>d?g():j(getMaxTranslate(a,W.current),{mode:"enter"})}else N.current.isSwiping=null}),z=useEventCallback(function(e){if(W.current&&L.current&&(null==nodeThatClaimedTheSwipe||nodeThatClaimedTheSwipe===N.current)){var t=getAnchor(O,n),r=isHorizontal(n),a=calculateCurrentX(t,e.touches),o=calculateCurrentY(t,e.touches);if(w&&W.current.contains(e.target)&&null==nodeThatClaimedTheSwipe){var i=findNativeHandler({domTreeShapes:getDomTreeShapes(e.target,W.current),start:r?N.current.startX:N.current.startY,current:r?a:o,anchor:n});if(i)return void(nodeThatClaimedTheSwipe=i);nodeThatClaimedTheSwipe=N.current}if(null==N.current.isSwiping){var c=Math.abs(a-N.current.startX),u=Math.abs(o-N.current.startY);c>u&&e.cancelable&&e.preventDefault();var l=r?c>u&&c>UNCERTAINTY_THRESHOLD:u>c&&u>UNCERTAINTY_THRESHOLD;if(!0===l||(r?u>UNCERTAINTY_THRESHOLD:c>UNCERTAINTY_THRESHOLD)){if(N.current.isSwiping=l,!l)return void V(e);N.current.startX=a,N.current.startY=o,s||w||(r?N.current.startX-=D:N.current.startY-=D)}}if(N.current.isSwiping){var p=getMaxTranslate(r,W.current),d=r?N.current.startX:N.current.startY;w&&!N.current.paperHit&&(d=Math.min(d,p));var f=getTranslate(r?a:o,d,w,p);if(w)if(N.current.paperHit)0===f&&(N.current.startX=a,N.current.startY=o);else{if(!(r?a<p:o<p))return;N.current.paperHit=!0,N.current.startX=a,N.current.startY=o}null===N.current.lastTranslate&&(N.current.lastTranslate=f,N.current.lastTime=performance.now()+1);var m=(f-N.current.lastTranslate)/(performance.now()-N.current.lastTime)*1e3;N.current.velocity=.4*N.current.velocity+.6*m,N.current.lastTranslate=f,N.current.lastTime=performance.now(),e.cancelable&&e.preventDefault(),j(f)}}}),I=useEventCallback(function(e){if(!e.defaultPrevented&&!e.muiHandled&&(!w||X.current.contains(e.target)||W.current.contains(e.target))){var t=getAnchor(O,n),r=isHorizontal(n),a=calculateCurrentX(t,e.touches),o=calculateCurrentY(t,e.touches);if(!w){if(u||e.target!==_.current)return;if(r){if(a>D)return}else if(o>D)return}e.muiHandled=!0,nodeThatClaimedTheSwipe=null,N.current.startX=a,N.current.startY=o,Y(!0),!w&&W.current&&j(getMaxTranslate(r,W.current)+(s?20:-D),{changeTransition:!1}),N.current.velocity=0,N.current.lastTime=null,N.current.lastTranslate=null,N.current.paperHit=!1,L.current=!0}});React.useEffect(function(){if("temporary"===x){var e=ownerDocument(W.current);return e.addEventListener("touchstart",I),e.addEventListener("touchmove",z,{passive:!1}),e.addEventListener("touchend",V),function(){e.removeEventListener("touchstart",I),e.removeEventListener("touchmove",z,{passive:!1}),e.removeEventListener("touchend",V)}}},[x,I,z,V]),React.useEffect(function(){return function(){nodeThatClaimedTheSwipe===N.current&&(nodeThatClaimedTheSwipe=null)}},[]),React.useEffect(function(){w||Y(!1)},[w]);var U=React.useCallback(function(e){X.current=ReactDOM.findDOMNode(e)},[]),F=React.useCallback(function(e){W.current=ReactDOM.findDOMNode(e)},[]);return React.createElement(React.Fragment,null,React.createElement(Drawer,_extends({open:!("temporary"!==x||!k)||w,variant:x,ModalProps:_extends({BackdropProps:_extends({},T,{ref:U})},v),PaperProps:_extends({},P,{style:_extends({pointerEvents:"temporary"!==x||w?"":"none"},P.style),ref:F}),anchor:n,transitionDuration:B.current||C,onClose:y,ref:t},A)),!u&&"temporary"===x&&React.createElement(NoSsr,null,React.createElement(SwipeArea,_extends({anchor:n,ref:_,width:D},R))))});"production"!==process.env.NODE_ENV&&(SwipeableDrawer.propTypes={anchor:PropTypes.oneOf(["left","top","right","bottom"]),children:PropTypes.node,disableBackdropTransition:PropTypes.bool,disableDiscovery:PropTypes.bool,disableSwipeToOpen:PropTypes.bool,hideBackdrop:PropTypes.bool,hysteresis:PropTypes.number,minFlingVelocity:PropTypes.number,ModalProps:PropTypes.shape({BackdropProps:PropTypes.shape({component:elementTypeAcceptingRef})}),onClose:PropTypes.func.isRequired,onOpen:PropTypes.func.isRequired,open:PropTypes.bool.isRequired,PaperProps:PropTypes.shape({component:elementTypeAcceptingRef,style:PropTypes.object}),SwipeAreaProps:PropTypes.object,swipeAreaWidth:PropTypes.number,transitionDuration:PropTypes.oneOfType([PropTypes.number,PropTypes.shape({enter:PropTypes.number,exit:PropTypes.number})]),variant:PropTypes.oneOf(["permanent","persistent","temporary"])});export default SwipeableDrawer;