import _objectWithoutProperties from"@babel/runtime/helpers/esm/objectWithoutProperties";import _extends from"@babel/runtime/helpers/esm/extends";import React from"react";import PropTypes from"prop-types";import ReactDOM from"react-dom";import{elementTypeAcceptingRef}from"@material-ui/utils";import{getThemeProps}from"@material-ui/styles";import Drawer,{getAnchor,isHorizontal}from"../Drawer/Drawer";import ownerDocument from"../utils/ownerDocument";import useEventCallback from"../utils/useEventCallback";import{duration}from"../styles/transitions";import useTheme from"../styles/useTheme";import{getTransitionProps}from"../transitions/utils";import NoSsr from"../NoSsr";import SwipeArea from"./SwipeArea";var UNCERTAINTY_THRESHOLD=3,nodeThatClaimedTheSwipe=null;export function reset(){nodeThatClaimedTheSwipe=null};function calculateCurrentX(e,t){return"right"===e?document.body.offsetWidth-t[0].pageX:t[0].pageX}function calculateCurrentY(e,t){return"bottom"===e?window.innerHeight-t[0].clientY:t[0].clientY}function getMaxTranslate(e,t){return e?t.clientWidth:t.clientHeight}function getTranslate(e,t,r,n){return Math.min(Math.max(r?t-e:n+t-e,0),n)}function getDomTreeShapes(e,t){for(var r=[];e&&e!==t;){var n=window.getComputedStyle(e);"absolute"===n.getPropertyValue("position")||"hidden"===n.getPropertyValue("overflow-x")?r=[]:(e.clientWidth>0&&e.scrollWidth>e.clientWidth||e.clientHeight>0&&e.scrollHeight>e.clientHeight)&&r.push(e),e=e.parentElement}return r}function findNativeHandler(e){var t=e.domTreeShapes,r=e.start,n=e.current,a=e.anchor,o={x:"scrollLeft",y:"scrollTop"},i={x:"scrollWidth",y:"scrollHeight"},s={x:"clientWidth",y:"clientHeight"};return t.some(function(e){var t=n>=r;"top"!==a&&"left"!==a||(t=!t);var c="left"===a||"right"===a?"x":"y",u=e[o[c]],l=u>0,p=u+e[s[c]]<e[i[c]];return t&&p||!t&&l?e:null})}var disableSwipeToOpenDefault="undefined"!=typeof navigator&&/iPad|iPhone|iPod/.test(navigator.userAgent),transitionDurationDefault={enter:duration.enteringScreen,exit:duration.leavingScreen},useEnhancedEffect="undefined"!=typeof window?React.useLayoutEffect:React.useEffect,SwipeableDrawer=React.forwardRef(function(e,t){var r=useTheme(),n=getThemeProps({name:"MuiSwipeableDrawer",props:_extends({},e),theme:r}),a=n.anchor,o=void 0===a?"left":a,i=n.disableBackdropTransition,s=void 0!==i&&i,c=n.disableDiscovery,u=void 0!==c&&c,l=n.disableSwipeToOpen,p=void 0===l?disableSwipeToOpenDefault:l,d=n.hideBackdrop,f=n.hysteresis,m=void 0===f?.52:f,h=n.minFlingVelocity,T=void 0===h?450:h,v=n.ModalProps,y=(v=void 0===v?{}:v).BackdropProps,g=_objectWithoutProperties(v,["BackdropProps"]),w=n.onClose,b=n.onOpen,P=n.open,S=n.PaperProps,R=void 0===S?{}:S,E=n.SwipeAreaProps,D=n.swipeAreaWidth,C=void 0===D?20:D,H=n.transitionDuration,x=void 0===H?transitionDurationDefault:H,A=n.variant,M=void 0===A?"temporary":A,O=_objectWithoutProperties(n,["anchor","disableBackdropTransition","disableDiscovery","disableSwipeToOpen","hideBackdrop","hysteresis","minFlingVelocity","ModalProps","onClose","onOpen","open","PaperProps","SwipeAreaProps","swipeAreaWidth","transitionDuration","variant"]),k=React.useState(!1),Y=k[0],N=k[1],_=React.useRef({isSwiping:null}),X=React.useRef(),W=React.useRef(),L=React.useRef(),B=React.useRef(!1),j=React.useRef();useEnhancedEffect(function(){j.current=null},[P]);var V=React.useCallback(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.mode,a=void 0===n?null:n,i=t.changeTransition,c=void 0===i||i,u=getAnchor(r,o),l=-1!==["right","bottom"].indexOf(u)?1:-1,p=isHorizontal(o),f=p?"translate(".concat(l*e,"px, 0)"):"translate(0, ".concat(l*e,"px)"),m=L.current.style;m.webkitTransform=f,m.transform=f;var h="";if(a&&(h=r.transitions.create("all",getTransitionProps({timeout:x},{mode:a}))),c&&(m.webkitTransition=h,m.transition=h),!s&&!d){var T=W.current.style;T.opacity=1-e/getMaxTranslate(p,L.current),c&&(T.webkitTransition=h,T.transition=h)}},[o,s,d,r,x]),z=useEventCallback(function(e){if(B.current)if(nodeThatClaimedTheSwipe=null,B.current=!1,N(!1),_.current.isSwiping){_.current.isSwiping=null;var t,n=getAnchor(r,o),a=isHorizontal(o);t=a?calculateCurrentX(n,e.changedTouches):calculateCurrentY(n,e.changedTouches);var i=a?_.current.startX:_.current.startY,s=getMaxTranslate(a,L.current),c=getTranslate(t,i,P,s),u=c/s;Math.abs(_.current.velocity)>T&&(j.current=1e3*Math.abs((s-c)/_.current.velocity)),P?_.current.velocity>T||u>m?w():V(0,{mode:"exit"}):_.current.velocity<-T||1-u>m?b():V(getMaxTranslate(a,L.current),{mode:"enter"})}else _.current.isSwiping=null}),I=useEventCallback(function(e){if(L.current&&B.current&&(null==nodeThatClaimedTheSwipe||nodeThatClaimedTheSwipe===_.current)){var t=getAnchor(r,o),n=isHorizontal(o),a=calculateCurrentX(t,e.touches),i=calculateCurrentY(t,e.touches);if(P&&L.current.contains(e.target)&&null==nodeThatClaimedTheSwipe){var s=findNativeHandler({domTreeShapes:getDomTreeShapes(e.target,L.current),start:n?_.current.startX:_.current.startY,current:n?a:i,anchor:o});if(s)return void(nodeThatClaimedTheSwipe=s);nodeThatClaimedTheSwipe=_.current}if(null==_.current.isSwiping){var c=Math.abs(a-_.current.startX),l=Math.abs(i-_.current.startY);c>l&&e.cancelable&&e.preventDefault();var p=n?c>l&&c>UNCERTAINTY_THRESHOLD:l>c&&l>UNCERTAINTY_THRESHOLD;if(!0===p||(n?l>UNCERTAINTY_THRESHOLD:c>UNCERTAINTY_THRESHOLD)){if(_.current.isSwiping=p,!p)return void z(e);_.current.startX=a,_.current.startY=i,u||P||(n?_.current.startX-=C:_.current.startY-=C)}}if(_.current.isSwiping){var d=getMaxTranslate(n,L.current),f=n?_.current.startX:_.current.startY;P&&!_.current.paperHit&&(f=Math.min(f,d));var m=getTranslate(n?a:i,f,P,d);if(P)if(_.current.paperHit)0===m&&(_.current.startX=a,_.current.startY=i);else{if(!(n?a<d:i<d))return;_.current.paperHit=!0,_.current.startX=a,_.current.startY=i}null===_.current.lastTranslate&&(_.current.lastTranslate=m,_.current.lastTime=performance.now()+1);var h=(m-_.current.lastTranslate)/(performance.now()-_.current.lastTime)*1e3;_.current.velocity=.4*_.current.velocity+.6*h,_.current.lastTranslate=m,_.current.lastTime=performance.now(),e.cancelable&&e.preventDefault(),V(m)}}}),U=useEventCallback(function(e){if(!e.defaultPrevented&&!e.muiHandled&&(!P||W.current.contains(e.target)||L.current.contains(e.target))){var t=getAnchor(r,o),n=isHorizontal(o),a=calculateCurrentX(t,e.touches),i=calculateCurrentY(t,e.touches);if(!P){if(p||e.target!==X.current)return;if(n){if(a>C)return}else if(i>C)return}e.muiHandled=!0,nodeThatClaimedTheSwipe=null,_.current.startX=a,_.current.startY=i,N(!0),!P&&L.current&&V(getMaxTranslate(n,L.current)+(u?20:-C),{changeTransition:!1}),_.current.velocity=0,_.current.lastTime=null,_.current.lastTranslate=null,_.current.paperHit=!1,B.current=!0}});React.useEffect(function(){if("temporary"===M){var e=ownerDocument(L.current);return e.addEventListener("touchstart",U),e.addEventListener("touchmove",I,{passive:!1}),e.addEventListener("touchend",z),function(){e.removeEventListener("touchstart",U),e.removeEventListener("touchmove",I,{passive:!1}),e.removeEventListener("touchend",z)}}},[M,U,I,z]),React.useEffect(function(){return function(){nodeThatClaimedTheSwipe===_.current&&(nodeThatClaimedTheSwipe=null)}},[]),React.useEffect(function(){P||N(!1)},[P]);var F=React.useCallback(function(e){W.current=ReactDOM.findDOMNode(e)},[]);return React.createElement(React.Fragment,null,React.createElement(Drawer,_extends({open:!("temporary"!==M||!Y)||P,variant:M,ModalProps:_extends({BackdropProps:_extends({},y,{ref:F})},g),PaperProps:_extends({},R,{style:_extends({pointerEvents:"temporary"!==M||P?"":"none"},R.style),ref:L}),anchor:o,transitionDuration:j.current||x,onClose:w,ref:t},O)),!p&&"temporary"===M&&React.createElement(NoSsr,null,React.createElement(SwipeArea,_extends({anchor:o,ref:X,width:C},E))))});"production"!==process.env.NODE_ENV&&(SwipeableDrawer.propTypes={anchor:PropTypes.oneOf(["left","top","right","bottom"]),children:PropTypes.node,disableBackdropTransition:PropTypes.bool,disableDiscovery:PropTypes.bool,disableSwipeToOpen:PropTypes.bool,hideBackdrop:PropTypes.bool,hysteresis:PropTypes.number,minFlingVelocity:PropTypes.number,ModalProps:PropTypes.shape({BackdropProps:PropTypes.shape({component:elementTypeAcceptingRef})}),onClose:PropTypes.func.isRequired,onOpen:PropTypes.func.isRequired,open:PropTypes.bool.isRequired,PaperProps:PropTypes.shape({component:elementTypeAcceptingRef,style:PropTypes.object}),SwipeAreaProps:PropTypes.object,swipeAreaWidth:PropTypes.number,transitionDuration:PropTypes.oneOfType([PropTypes.number,PropTypes.shape({enter:PropTypes.number,exit:PropTypes.number})]),variant:PropTypes.oneOf(["permanent","persistent","temporary"])});export default SwipeableDrawer;