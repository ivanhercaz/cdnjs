import{__decorate,__param,__metadata}from"tslib";import{InjectionToken,ɵɵdefineInjectable,ɵɵinject,Injectable,Inject,Input,Directive,ElementRef,Renderer2,NgModule}from"@angular/core";import{BehaviorSubject,ReplaySubject}from"rxjs";import{filter,map,delay}from"rxjs/operators";import{Location}from"@angular/common";import{NavigationEnd,Router}from"@angular/router";class DefaultConfig{constructor(){this.pageTracking={autoTrackVirtualPages:!0,basePath:"",excludedRoutes:[],clearIds:!1,clearHash:!1,clearQueryParams:!1,idsRegExp:/^\d+$|^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/},this.developerMode=!1,this.ga={},this.appInsights={},this.gtm={},this.gst={}}}const ANGULARTICS2_TOKEN=new InjectionToken("ANGULARTICS2");class RouterlessTracking{trackLocation(e){return new BehaviorSubject({url:"/"})}prepareExternalUrl(e){return e}}let Angulartics2=class{constructor(e,t){this.tracker=e,this.pageTrack=new ReplaySubject(10),this.eventTrack=new ReplaySubject(10),this.exceptionTrack=new ReplaySubject(10),this.setAlias=new ReplaySubject(10),this.setUsername=new ReplaySubject(10),this.setUserProperties=new ReplaySubject(10),this.setUserPropertiesOnce=new ReplaySubject(10),this.setSuperProperties=new ReplaySubject(10),this.setSuperPropertiesOnce=new ReplaySubject(10),this.userTimings=new ReplaySubject(10);const a=new DefaultConfig;this.settings=Object.assign({},a,t.settings),this.settings.pageTracking=Object.assign({},a.pageTracking,t.settings.pageTracking),this.tracker.trackLocation(this.settings).subscribe(e=>this.trackUrlChange(e.url))}filterDeveloperMode(){return filter((e,t)=>!this.settings.developerMode)}trackUrlChange(e){if(this.settings.pageTracking.autoTrackVirtualPages&&!this.matchesExcludedRoute(e)){const t=this.clearUrl(e);let a;a=this.settings.pageTracking.basePath.length?this.settings.pageTracking.basePath+t:this.tracker.prepareExternalUrl(t),this.pageTrack.next({path:a})}}matchesExcludedRoute(e){for(const t of this.settings.pageTracking.excludedRoutes){if(t instanceof RegExp&&t.test(e)||-1!==e.indexOf(t))return!0}return!1}clearUrl(e){return this.settings.pageTracking.clearIds||this.settings.pageTracking.clearQueryParams||this.settings.pageTracking.clearHash?e.split("/").map(e=>this.settings.pageTracking.clearQueryParams?e.split("?")[0]:e).map(e=>this.settings.pageTracking.clearHash?e.split("#")[0]:e).filter(e=>!this.settings.pageTracking.clearIds||!e.match(this.settings.pageTracking.idsRegExp)).join("/"):e}};Angulartics2.ngInjectableDef=ɵɵdefineInjectable({factory:function(){return new Angulartics2(ɵɵinject(RouterlessTracking),ɵɵinject(ANGULARTICS2_TOKEN))},token:Angulartics2,providedIn:"root"}),Angulartics2=__decorate([Injectable({providedIn:"root"}),__param(1,Inject(ANGULARTICS2_TOKEN)),__metadata("design:paramtypes",[RouterlessTracking,Object])],Angulartics2);let AngularRouterTracking=class{constructor(e,t){this.router=e,this.location=t}trackLocation(e){return this.router.events.pipe(filter(e=>e instanceof NavigationEnd),filter(()=>!e.developerMode),map(e=>({url:e.urlAfterRedirects})),delay(0))}prepareExternalUrl(e){return this.location.prepareExternalUrl(e)}};AngularRouterTracking.ngInjectableDef=ɵɵdefineInjectable({factory:function(){return new AngularRouterTracking(ɵɵinject(Router),ɵɵinject(Location))},token:AngularRouterTracking,providedIn:"root"}),AngularRouterTracking=__decorate([Injectable({providedIn:"root"}),__metadata("design:paramtypes",[Router,Location])],AngularRouterTracking);let Angulartics2On=class{constructor(e,t,a){this.elRef=e,this.angulartics2=t,this.renderer=a,this.angularticsProperties={}}ngAfterContentInit(){this.renderer.listen(this.elRef.nativeElement,this.angulartics2On||"click",e=>this.eventTrack(e))}eventTrack(e){const t=this.angularticsAction,a=Object.assign({},this.angularticsProperties,{eventType:e.type});this.angularticsCategory&&(a.category=this.angularticsCategory),this.angularticsLabel&&(a.label=this.angularticsLabel),this.angularticsValue&&(a.value=this.angularticsValue),this.angulartics2.eventTrack.next({action:t,properties:a})}};__decorate([Input("angulartics2On"),__metadata("design:type",String)],Angulartics2On.prototype,"angulartics2On",void 0),__decorate([Input(),__metadata("design:type",String)],Angulartics2On.prototype,"angularticsAction",void 0),__decorate([Input(),__metadata("design:type",String)],Angulartics2On.prototype,"angularticsCategory",void 0),__decorate([Input(),__metadata("design:type",String)],Angulartics2On.prototype,"angularticsLabel",void 0),__decorate([Input(),__metadata("design:type",String)],Angulartics2On.prototype,"angularticsValue",void 0),__decorate([Input(),__metadata("design:type",Object)],Angulartics2On.prototype,"angularticsProperties",void 0);let Angulartics2OnModule=class{};var Angulartics2Module_1;Angulartics2OnModule=__decorate([NgModule({declarations:[Angulartics2On=__decorate([Directive({selector:"[angulartics2On]"}),__metadata("design:paramtypes",[ElementRef,Angulartics2,Renderer2])],Angulartics2On)],exports:[Angulartics2On]})],Angulartics2OnModule);let Angulartics2Module=Angulartics2Module_1=class{static forRoot(e={}){return{ngModule:Angulartics2Module_1,providers:[{provide:ANGULARTICS2_TOKEN,useValue:{settings:e}},{provide:RouterlessTracking,useClass:AngularRouterTracking},Angulartics2]}}};Angulartics2Module=Angulartics2Module_1=__decorate([NgModule({imports:[Angulartics2OnModule],exports:[Angulartics2On]})],Angulartics2Module);export{ANGULARTICS2_TOKEN,AngularRouterTracking,Angulartics2,Angulartics2Module,Angulartics2On,Angulartics2OnModule,DefaultConfig,RouterlessTracking};