"use strict";var intervalometer=require("intervalometer");function preventEvent(t,e,r,n){function i(e){Boolean(t[r])===Boolean(n)&&e.stopImmediatePropagation(),delete t[r]}return t.addEventListener(e,i,!1),i}function proxyProperty(e,t,r,n){function i(e){r[t]=e}n&&i(e[t]),Object.defineProperty(e,t,{get:function(){return r[t]},set:i})}function proxyEvent(e,t,r){r.addEventListener(t,function(){return e.dispatchEvent(new Event(t))})}function dispatchEventAsync(e,t){Promise.resolve().then(function(){e.dispatchEvent(new Event(t))})}var iOS8or9="object"==typeof document&&"object-fit"in document.head.style&&!matchMedia("(-webkit-video-playable-inline)").matches,ಠ="bfred-it:iphone-inline-video",ಠevent="bfred-it:iphone-inline-video:event",ಠplay="bfred-it:iphone-inline-video:nativeplay",ಠpause="bfred-it:iphone-inline-video:nativepause";function getAudioFromVideo(e){var t=new Audio;return proxyEvent(e,"play",t),proxyEvent(e,"playing",t),proxyEvent(e,"pause",t),t.crossOrigin=e.crossOrigin,t.src=e.src||e.currentSrc||"data:",t}var lastTimeupdateEvent,lastRequests=[],requestIndex=0;function setTime(e,t,r){(lastTimeupdateEvent||0)+200<Date.now()&&(e[ಠevent]=!0,lastTimeupdateEvent=Date.now()),r||(e.currentTime=t),lastRequests[++requestIndex%3]=100*t|0}function isPlayerEnded(e){return e.driver.currentTime>=e.video.duration}function update(e){var t=this;t.video.readyState>=t.video.HAVE_FUTURE_DATA?(t.hasAudio||(t.driver.currentTime=t.video.currentTime+e*t.video.playbackRate/1e3,t.video.loop&&isPlayerEnded(t)&&(t.driver.currentTime=0)),setTime(t.video,t.driver.currentTime)):t.video.networkState===t.video.NETWORK_IDLE&&0===t.video.buffered.length&&t.video.load(),t.video.ended&&(delete t.video[ಠevent],t.video.pause(!0))}function play(){var e=this,t=e[ಠ];e.webkitDisplayingFullscreen?e[ಠplay]():("data:"!==t.driver.src&&t.driver.src!==e.src&&(setTime(e,0,!0),t.driver.src=e.src),e.paused&&(t.paused=!1,0===e.buffered.length&&e.load(),t.driver.play(),t.updater.start(),t.hasAudio||(dispatchEventAsync(e,"play"),t.video.readyState>=t.video.HAVE_ENOUGH_DATA&&dispatchEventAsync(e,"playing"))))}function pause(e){var t=this,r=t[ಠ];r.driver.pause(),r.updater.stop(),t.webkitDisplayingFullscreen&&t[ಠpause](),r.paused&&!e||(r.paused=!0,r.hasAudio||dispatchEventAsync(t,"pause"),t.ended&&(t[ಠevent]=!0,dispatchEventAsync(t,"ended")))}function addPlayer(t,r){var n={};(t[ಠ]=n).paused=!0,n.hasAudio=r,n.video=t,n.updater=intervalometer.frameIntervalometer(update.bind(n)),r?n.driver=getAudioFromVideo(t):(t.addEventListener("canplay",function(){t.paused||dispatchEventAsync(t,"playing")}),n.driver={src:t.src||t.currentSrc||"data:",muted:!0,paused:!0,pause:function(){n.driver.paused=!0},play:function(){n.driver.paused=!1,isPlayerEnded(n)&&setTime(t,0)},get ended(){return isPlayerEnded(n)}}),t.addEventListener("emptied",function(){var e=!n.driver.src||"data:"===n.driver.src;n.driver.src&&n.driver.src!==t.src&&(setTime(t,0,!0),n.driver.src=t.src,e||!r&&t.autoplay?n.driver.play():n.updater.stop())},!1),t.addEventListener("webkitbeginfullscreen",function(){t.paused?r&&0===n.driver.buffered.length&&n.driver.load():(t.pause(),t[ಠplay]())}),r&&(t.addEventListener("webkitendfullscreen",function(){n.driver.currentTime=t.currentTime}),t.addEventListener("seeking",function(){lastRequests.indexOf(100*t.currentTime|0)<0&&(n.driver.currentTime=t.currentTime)}))}function overloadAPI(e){var t=e[ಠ];e[ಠplay]=e.play,e[ಠpause]=e.pause,e.play=play,e.pause=pause,proxyProperty(e,"paused",t.driver),proxyProperty(e,"muted",t.driver,!0),proxyProperty(e,"playbackRate",t.driver,!0),proxyProperty(e,"ended",t.driver),proxyProperty(e,"loop",t.driver,!0),preventEvent(e,"seeking"),preventEvent(e,"seeked"),preventEvent(e,"timeupdate",ಠevent,!1),preventEvent(e,"ended",ಠevent,!1)}function enableInlineVideo(t,e){if(void 0===e&&(e={}),!t[ಠ]){if(!e.everywhere){if(!iOS8or9)return;if(!(e.iPad||e.ipad?/iPhone|iPod|iPad/:/iPhone|iPod/).test(navigator.userAgent))return}t.pause();var r=t.autoplay;t.autoplay=!1,addPlayer(t,!t.muted),overloadAPI(t),t.classList.add("IIV"),t.muted&&r&&(t.play(),t.addEventListener("playing",function e(){t.autoplay=!0,t.removeEventListener("playing",e)})),/iPhone|iPod|iPad/.test(navigator.platform)||console.warn("iphone-inline-video is not guaranteed to work in emulated environments")}}module.exports=enableInlineVideo;