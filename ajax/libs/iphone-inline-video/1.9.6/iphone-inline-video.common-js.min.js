"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var Symbol=_interopDefault(require("poor-mans-symbol")),intervalometer=require("intervalometer");function preventEvent(t,e,r,n){function i(e){Boolean(t[r])===Boolean(n)&&e.stopImmediatePropagation(),delete t[r]}return t.addEventListener(e,i,!1),i}function proxyProperty(e,t,r,n){function i(e){r[t]=e}n&&i(e[t]),Object.defineProperty(e,t,{get:function(){return r[t]},set:i})}function proxyEvent(e,t,r){r.addEventListener(t,function(){return e.dispatchEvent(new Event(t))})}function dispatchEventAsync(e,t){Promise.resolve().then(function(){e.dispatchEvent(new Event(t))})}var isWhitelisted="object-fit"in document.head.style&&/iPhone|iPod/i.test(navigator.userAgent)&&!matchMedia("(-webkit-video-playable-inline)").matches,ಠ=Symbol(),ಠevent=Symbol(),ಠplay=Symbol("nativeplay"),ಠpause=Symbol("nativepause");function getAudioFromVideo(e){var t=new Audio;return proxyEvent(e,"play",t),proxyEvent(e,"playing",t),proxyEvent(e,"pause",t),t.crossOrigin=e.crossOrigin,t.src=e.src||e.currentSrc||"data:",t}var lastTimeupdateEvent,lastRequests=[],requestIndex=0;function setTime(e,t,r){(lastTimeupdateEvent||0)+200<Date.now()&&(e[ಠevent]=!0,lastTimeupdateEvent=Date.now()),r||(e.currentTime=t),lastRequests[++requestIndex%3]=100*t|0}function isPlayerEnded(e){return e.driver.currentTime>=e.video.duration}function update(e){var t=this;t.video.readyState>=t.video.HAVE_FUTURE_DATA?(t.hasAudio||(t.driver.currentTime=t.video.currentTime+e*t.video.playbackRate/1e3,t.video.loop&&isPlayerEnded(t)&&(t.driver.currentTime=0)),setTime(t.video,t.driver.currentTime)):t.video.networkState!==t.video.NETWORK_IDLE||t.video.buffered.length||t.video.load(),t.video.ended&&(delete t.video[ಠevent],t.video.pause(!0))}function play(){var e=this,t=e[ಠ];e.webkitDisplayingFullscreen?e[ಠplay]():("data:"!==t.driver.src&&t.driver.src!==e.src&&(setTime(e,0,!0),t.driver.src=e.src),e.paused&&(t.paused=!1,e.buffered.length||e.load(),t.driver.play(),t.updater.start(),t.hasAudio||(dispatchEventAsync(e,"play"),t.video.readyState>=t.video.HAVE_ENOUGH_DATA&&dispatchEventAsync(e,"playing"))))}function pause(e){var t=this,r=t[ಠ];r.driver.pause(),r.updater.stop(),t.webkitDisplayingFullscreen&&t[ಠpause](),r.paused&&!e||(r.paused=!0,r.hasAudio||dispatchEventAsync(t,"pause"),t.ended&&(t[ಠevent]=!0,dispatchEventAsync(t,"ended")))}function addPlayer(t,e){var r=t[ಠ]={};r.paused=!0,r.hasAudio=e,r.video=t,r.updater=intervalometer.frameIntervalometer(update.bind(r)),e?r.driver=getAudioFromVideo(t):(t.addEventListener("canplay",function(){t.paused||dispatchEventAsync(t,"playing")}),r.driver={src:t.src||t.currentSrc||"data:",muted:!0,paused:!0,pause:function(){r.driver.paused=!0},play:function(){r.driver.paused=!1,isPlayerEnded(r)&&setTime(t,0)},get ended(){return isPlayerEnded(r)}}),t.addEventListener("emptied",function(){var e=!r.driver.src||"data:"===r.driver.src;r.driver.src&&r.driver.src!==t.src&&(setTime(t,0,!0),r.driver.src=t.src,e?r.driver.play():r.updater.stop())},!1),t.addEventListener("webkitbeginfullscreen",function(){t.paused?e&&!r.driver.buffered.length&&r.driver.load():(t.pause(),t[ಠplay]())}),e&&(t.addEventListener("webkitendfullscreen",function(){r.driver.currentTime=t.currentTime}),t.addEventListener("seeking",function(){lastRequests.indexOf(100*t.currentTime|0)<0&&(r.driver.currentTime=t.currentTime)}))}function overloadAPI(e){var t=e[ಠ];e[ಠplay]=e.play,e[ಠpause]=e.pause,e.play=play,e.pause=pause,proxyProperty(e,"paused",t.driver),proxyProperty(e,"muted",t.driver,!0),proxyProperty(e,"playbackRate",t.driver,!0),proxyProperty(e,"ended",t.driver),proxyProperty(e,"loop",t.driver,!0),preventEvent(e,"seeking"),preventEvent(e,"seeked"),preventEvent(e,"timeupdate",ಠevent,!1),preventEvent(e,"ended",ಠevent,!1)}function enableInlineVideo(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=!0),r&&!isWhitelisted||e[ಠ]||(addPlayer(e,t),overloadAPI(e),e.classList.add("IIV"),!t&&e.autoplay&&e.play(),/iPhone|iPod|iPad/.test(navigator.platform)||console.warn("iphone-inline-video is not guaranteed to work in emulated environments"))}enableInlineVideo.isWhitelisted=isWhitelisted,module.exports=enableInlineVideo;