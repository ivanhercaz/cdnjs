"use strict";var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var afterRelease,is_1=require("@riim/is"),logger_1=require("@riim/logger"),map_set_polyfill_1=require("@riim/map-set-polyfill"),next_tick_1=require("@riim/next-tick"),symbol_polyfill_1=require("@riim/symbol-polyfill"),EventEmitter_1=require("./EventEmitter"),WaitError_1=require("./WaitError"),MAX_SAFE_INTEGER=Number.MAX_SAFE_INTEGER||9007199254740991,KEY_WRAPPERS=symbol_polyfill_1.Symbol("cellx[wrappers]"),releasePlan=new map_set_polyfill_1.Map,releasePlanIndex=MAX_SAFE_INTEGER,releasePlanToIndex=-1,releasePlanned=!1,currentlyRelease=0,currentCell=null,$error={error:null},pushingIndexCounter=0,errorIndexCounter=0,releaseVersion=1,STATE_INITED=1,STATE_ACTIVE=2,STATE_HAS_FOLLOWERS=4,STATE_CURRENTLY_PULLING=8,STATE_PENDING=16,STATE_FULFILLED=32,STATE_REJECTED=64,STATE_CAN_CANCEL_CHANGE=128;function release(e){if(releasePlanned||e){releasePlanned=!1,currentlyRelease++;for(var t=releasePlan.get(releasePlanIndex);;){var r=t&&t.shift();if(r){var n=void 0,l=r._level,i=r._changeEvent;if(i)n=releasePlanIndex;else{if(releasePlanIndex<l||-1==r._levelInRelease){if(!t.length){if(releasePlanIndex==releasePlanToIndex)break;t=releasePlan.get(++releasePlanIndex)}continue}if(n=releasePlanIndex,r.pull(),releasePlanIndex<n){t.unshift(r),t=releasePlan.get(releasePlanIndex);continue}if(l=r._level,releasePlanIndex<l){t.length||(t=releasePlan.get(++releasePlanIndex));continue}i=r._changeEvent}if(r._levelInRelease=-1,i){r._fixedValue=r._value,r._changeEvent=null;for(var s=r._pushingIndex,a=r._reactions,o=0,_=a.length;o<_;o++){var h=a[o];h._level<=l&&(h._level=l+1),s>h._pushingIndex&&(h._pushingIndex=s,h._prevChangeEvent=h._changeEvent,h._changeEvent=null,h._addToRelease())}if(r.handleEvent(i),releasePlanIndex==MAX_SAFE_INTEGER)break;if(releasePlanIndex!=n){t=releasePlan.get(releasePlanIndex);continue}}if(!t.length){if(releasePlanIndex==releasePlanToIndex)break;t=releasePlan.get(++releasePlanIndex)}}else{if(releasePlanIndex==releasePlanToIndex)break;t=releasePlan.get(++releasePlanIndex)}}if(!--currentlyRelease&&(releasePlanIndex=MAX_SAFE_INTEGER,releasePlanToIndex=-1,releaseVersion++,afterRelease)){var u=afterRelease;afterRelease=null;for(o=0,_=u.length;o<_;o++){var c=u[o];"function"==typeof c?c():c[0]._push(c[1],!0,!1)}}}}function defaultPut(e,t){e.push(t)}var Cell=function(n){function l(e,t){var r=n.call(this)||this;return r._error=null,r._pushingIndex=0,r._errorIndex=0,r._version=0,r._dependencies=void 0,r._reactions=[],r._level=0,r._levelInRelease=-1,r._selfPendingStatusCell=null,r._pendingStatusCell=null,r._selfErrorCell=null,r._errorCell=null,r._state=STATE_CAN_CANCEL_CHANGE,r._prevChangeEvent=null,r._changeEvent=null,r._lastErrorEvent=null,r.debugKey=t&&t.debugKey,r.context=t&&t.context||r,r._pull="function"==typeof e?e:null,r._get=t&&t.get||null,r._validate=t&&t.validate||null,r._merge=t&&t.merge||null,r._put=t&&t.put||defaultPut,r._onFulfilled=r._onRejected=null,r._reap=t&&t.reap||null,r.meta=t&&t.meta||null,r._pull?r._fixedValue=r._value=void 0:(r._validate&&r._validate(e,void 0),r._merge&&(e=r._merge(e,void 0)),r._fixedValue=r._value=e,e instanceof EventEmitter_1.EventEmitter&&e.on("change",r._onValueChange,r)),t&&(t.onChange&&r.on("change",t.onChange),t.onError&&r.on("error",t.onError)),r}return __extends(l,n),Object.defineProperty(l,"currentlyPulling",{get:function(){return!!currentCell},enumerable:!0,configurable:!0}),l.autorun=function(t,r){var n;return new l(function(){var e=this;n=n||function(){e.dispose()},t.call(r,n)},{onChange:function(){}}),n},l.forceRelease=function(){(releasePlanned||currentlyRelease)&&release(!0)},l.afterRelease=function(e){(afterRelease=afterRelease||[]).push(e)},l.prototype.on=function(e,t,r){return(releasePlanned||currentlyRelease)&&release(!0),this._activate(),"object"==typeof e?n.prototype.on.call(this,e,void 0!==t?t:this.context):n.prototype.on.call(this,e,t,void 0!==r?r:this.context),this._state|=STATE_HAS_FOLLOWERS,this},l.prototype.off=function(e,t,r){return(releasePlanned||currentlyRelease)&&release(!0),e?"object"==typeof e?n.prototype.off.call(this,e,void 0!==t?t:this.context):n.prototype.off.call(this,e,t,void 0!==r?r:this.context):n.prototype.off.call(this),!this._reactions.length&&!this._events.has("change")&&!this._events.has("error")&&this._state&STATE_HAS_FOLLOWERS&&(this._state^=STATE_HAS_FOLLOWERS,this._deactivate(),this._reap&&this._reap.call(this.context)),this},l.prototype.addChangeListener=function(e,t){return this.on("change",e,void 0!==t?t:this.context)},l.prototype.removeChangeListener=function(e,t){return this.off("change",e,void 0!==t?t:this.context)},l.prototype.addErrorListener=function(e,t){return this.on("error",e,void 0!==t?t:this.context)},l.prototype.removeErrorListener=function(e,t){return this.off("error",e,void 0!==t?t:this.context)},l.prototype.subscribe=function(t,e){var r=t[KEY_WRAPPERS]||(t[KEY_WRAPPERS]=new map_set_polyfill_1.Map);if(r.has(this))return this;function n(e){return t.call(this,e.data.error||null,e)}return r.set(this,n),void 0===e&&(e=this.context),this.on("change",n,e).on("error",n,e)},l.prototype.unsubscribe=function(e,t){var r=e[KEY_WRAPPERS],n=r&&r.get(this);return n?(r.delete(this),void 0===t&&(t=this.context),this.off("change",n,t).off("error",n,t)):this},l.prototype._addReaction=function(e){this._activate(),this._reactions.push(e),this._state|=STATE_HAS_FOLLOWERS},l.prototype._deleteReaction=function(e){this._reactions.splice(this._reactions.indexOf(e),1),this._reactions.length||this._events.has("change")||this._events.has("error")||(this._state^=STATE_HAS_FOLLOWERS,this._deactivate(),this._reap&&this._reap.call(this.context))},l.prototype._activate=function(){if(this._pull&&!(this._state&STATE_ACTIVE)){var e=this._dependencies;if(null!==e){if(this._version<releaseVersion){var t=this._pull$();!e&&!this._dependencies&&this._state&STATE_INITED||(t===$error?this._fail($error.error,!1,!1):this._push(t,!1,!1)),e=this._dependencies}if(e){for(var r=e.length;e[--r]._addReaction(this),r;);this._state|=STATE_ACTIVE}}}},l.prototype._deactivate=function(){if(this._state&STATE_ACTIVE){for(var e=this._dependencies,t=e.length;e[--t]._deleteReaction(this),t;);-1!=this._levelInRelease&&(this._levelInRelease=-1,this._changeEvent=null),this._state^=STATE_ACTIVE}},l.prototype._onValueChange=function(e){if(this._pushingIndex=++pushingIndexCounter,this._state&STATE_HAS_FOLLOWERS){var t=(e.data||(e.data={})).prevEvent=this._changeEvent;this._changeEvent=e,t?this._value===this._fixedValue&&(this._state&=~STATE_CAN_CANCEL_CHANGE):(this._state&=~STATE_CAN_CANCEL_CHANGE,this._addToRelease())}else this._version=++releaseVersion+ +(0!=currentlyRelease)},l.prototype.get=function(){if(this._pull)if(this._state&STATE_ACTIVE)(releasePlanned||currentlyRelease&&!currentCell)&&release(!0);else if(this._version<releaseVersion+ +releasePlanned+ +(0!=currentlyRelease)){var e=this._dependencies;if(null!==e){var t=this._pull$(),r=this._dependencies;if(e||r||!(this._state&STATE_INITED)){if(r&&this._state&STATE_HAS_FOLLOWERS){for(var n=r.length;r[--n]._addReaction(this),n;);this._state|=STATE_ACTIVE}t===$error?this._fail($error.error,!1,!1):this._push(t,!1,!1)}}}if(currentCell){var l=currentCell._dependencies,i=this._level;l?-1==l.indexOf(this)&&(l.push(this),currentCell._level<=i&&(currentCell._level=i+1)):(currentCell._dependencies=[this],currentCell._level=i+1)}if(currentCell&&this._error&&this._error instanceof WaitError_1.WaitError)throw this._error;return this._get?this._get(this._value):this._value},l.prototype.pull=function(){if(!this._pull)return!1;var e,t,r;if(releasePlanned&&release(),this._state&STATE_HAS_FOLLOWERS){e=this._dependencies,t=this._level,r=this._pull$();var n=this._dependencies,l=0;if(n){var i=n.length;do{var s=n[--i];e&&-1!=e.indexOf(s)||(s._addReaction(this),l++)}while(i)}if(e&&(n?n.length-l:0)<e.length)for(i=e.length;i;){var a=e[--i];n&&-1!=n.indexOf(a)||a._deleteReaction(this)}if(n?this._state|=STATE_ACTIVE:this._state&=~STATE_ACTIVE,currentlyRelease&&this._level>t)return this._addToRelease(),!1}else r=this._pull$();return r===$error?(this._fail($error.error,!1,!0),!0):this._push(r,!1,!0)},l.prototype._pull$=function(){if(this._state&STATE_CURRENTLY_PULLING)throw new TypeError("Circular pulling detected");var e=this._pull;e.length&&(this._selfPendingStatusCell&&this._selfPendingStatusCell.set(!0),this._state|=STATE_PENDING,this._state&=~(STATE_FULFILLED|STATE_REJECTED));var t=currentCell;(currentCell=this)._dependencies=null,this._level=0,this._state|=STATE_CURRENTLY_PULLING;try{return e.length?e.call(this.context,this,this._value):e.call(this.context)}catch(e){return $error.error=e,$error}finally{currentCell=t,this._version=releaseVersion+ +(0!=currentlyRelease);var r=this._pendingStatusCell;r&&r._state&STATE_ACTIVE&&r.pull();var n=this._errorCell;n&&n._state&STATE_ACTIVE&&n.pull(),this._state^=STATE_CURRENTLY_PULLING}},l.prototype.getError=function(){var e=this._errorCell;if(!e){var t=this.debugKey;this._selfErrorCell=new l(this._error,t?{debugKey:t+"._selfErrorCell"}:void 0),e=this._errorCell=new l(function(){this.get();var e,t=this._selfErrorCell.get();if(t&&(e=this._errorIndex)==errorIndexCounter)return t;var r=this._dependencies;if(r){var n=r.length;do{var l=r[--n],i=l.getError();if(i){var s=l._errorIndex;if(s==errorIndexCounter)return i;(!t||e<s)&&(t=i,e=s)}}while(n)}return t},t?{debugKey:t+"._errorCell",context:this}:{context:this})}return e.get()},l.prototype.isPending=function(){var e=this._pendingStatusCell;if(!e){var t=this.debugKey;this._selfPendingStatusCell=new l(!!(this._state&STATE_PENDING),t?{debugKey:t+"._selfPendingStatusCell"}:void 0),e=this._pendingStatusCell=new l(function(){if(this._selfPendingStatusCell.get())return!0;try{this.get()}catch(e){}var e=this._dependencies;if(e){var t=e.length;do{if(e[--t].isPending())return!0}while(t)}return!1},t?{debugKey:t+"._pendingStatusCell",context:this}:{context:this})}return e.get()},l.prototype.set=function(e){return this._validate&&this._validate(e,this._value),this._merge&&(e=this._merge(e,this._value)),this._selfPendingStatusCell&&this._selfPendingStatusCell.set(!0),this._state|=STATE_PENDING,this._state&=~(STATE_FULFILLED|STATE_REJECTED),3<=this._put.length?this._put.call(this.context,this,e,this._value):this._put.call(this.context,this,e),this},l.prototype.push=function(e){return this._push(e,!0,!1),this},l.prototype._push=function(e,t,r){(t||!currentlyRelease&&r)&&(this._pushingIndex=++pushingIndexCounter),this._state|=STATE_INITED,this._error&&this._setError(null,!1);var n=this._value;if(is_1.is(e,n))return(t||currentlyRelease&&r)&&this._fulfill(e),!1;if(this._value=e,n instanceof EventEmitter_1.EventEmitter&&n.off("change",this._onValueChange,this),e instanceof EventEmitter_1.EventEmitter&&e.on("change",this._onValueChange,this),this._state&STATE_HAS_FOLLOWERS){var l=this._changeEvent||this._prevChangeEvent;l?(is_1.is(e,this._fixedValue)&&this._state&STATE_CAN_CANCEL_CHANGE?(this._levelInRelease=-1,this._changeEvent=null):this._changeEvent={target:this,type:"change",data:{prevEvent:l,prevValue:n,value:e}},this._prevChangeEvent=null):(this._state|=STATE_CAN_CANCEL_CHANGE,this._changeEvent={target:this,type:"change",data:{prevEvent:null,prevValue:n,value:e}},this._addToRelease())}else(t||!currentlyRelease&&r)&&releaseVersion++,this._fixedValue=e,this._version=releaseVersion+ +(0!=currentlyRelease);return(t||currentlyRelease&&r)&&this._fulfill(e),!0},l.prototype._fulfill=function(e){this._resolvePending(),this._state&STATE_FULFILLED||(this._state|=STATE_FULFILLED,this._onFulfilled&&this._onFulfilled(e))},l.prototype.fail=function(e){return this._fail(e,!0,!1),this},l.prototype._fail=function(e,t,r){e instanceof WaitError_1.WaitError||(this.debugKey?logger_1.error("["+this.debugKey+"]",e):logger_1.error(e),e instanceof Error||(e=new Error(String(e)))),this._setError(e,t||0!=currentlyRelease&&r)},l.prototype._setError=function(e,t){this._error=e,this._selfErrorCell&&this._selfErrorCell.set(e),e&&(this._errorIndex=++errorIndexCounter,this._handleErrorEvent({target:this,type:"error",data:{error:e}},t?e:null))},l.prototype._handleErrorEvent=function(e,t){if(this._lastErrorEvent!==e){this._lastErrorEvent=e,this.handleEvent(e),t&&this._reject(t);for(var r=this._reactions,n=r.length;n;)r[--n]._handleErrorEvent(e,t)}},l.prototype._reject=function(e){this._resolvePending(),e instanceof WaitError_1.WaitError||this._state&STATE_REJECTED||(this._state|=STATE_REJECTED,this._onRejected&&this._onRejected(e))},l.prototype.wait=function(){throw new WaitError_1.WaitError},l.prototype._addToRelease=function(){var e,t=this._level;t<=this._levelInRelease||((releasePlan.get(t)||(releasePlan.set(t,e=[]),e)).push(this),t<releasePlanIndex&&(releasePlanIndex=t),releasePlanToIndex<t&&(releasePlanToIndex=t),this._levelInRelease=t,releasePlanned||currentlyRelease||(releasePlanned=!0,next_tick_1.nextTick(release)))},l.prototype._resolvePending=function(){this._state&STATE_PENDING&&(this._selfPendingStatusCell&&this._selfPendingStatusCell.set(!1),this._state^=STATE_PENDING)},l.prototype.then=function(e,t){function n(){}var l=this;if(this.on("change",n),!this._pull||this._state&STATE_FULFILLED)return this.off("change",n),Promise.resolve(this._get?this._get(this._value):this._value).then(e);if(this._state&STATE_REJECTED)return this.off("change",n),Promise.reject(this._error).catch(t);var i=this;return new Promise(function(t,r){i._onFulfilled=function(e){i._onFulfilled=i._onRejected=null,l.off("change",n),t(i._get?i._get(e):e)},i._onRejected=function(e){i._onFulfilled=i._onRejected=null,l.off("change",n),r(e)}}).then(e,t)},l.prototype.catch=function(e){return this.then(null,e)},l.prototype.reap=function(){this.off();for(var e=this._reactions,t=e.length;t;)e[--t].reap();return this},l.prototype.dispose=function(){return this.reap()},l}(EventEmitter_1.EventEmitter);exports.Cell=Cell;