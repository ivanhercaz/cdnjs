"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var logger_1=require("@riim/logger"),map_set_polyfill_1=require("@riim/map-set-polyfill"),EventEmitter=function(){function l(){this._events=new map_set_polyfill_1.Map}return l.prototype.getEvents=function(t){var r;return t?(r=this._events.get(t))?Array.isArray(r)?r:[r]:[]:(r=Object.create(null),this._events.forEach(function(t,e){r[e]=Array.isArray(t)?t:[t]}),r)},l.prototype.on=function(t,e,r){if("object"==typeof t){r=void 0!==e?e:this;var i=t;for(t in i)this._on(t,i[t],r)}else this._on(t,e,void 0!==r?r:this);return this},l.prototype.off=function(t,e,r){if(t)if("object"==typeof t){r=void 0!==e?e:this;var i=t;for(t in i)this._off(t,i[t],r)}else this._off(t,e,void 0!==r?r:this);else this._events.clear();return this},l.prototype._on=function(t,e,r){var i=t.indexOf(":");if(-1!=i){var n=t.slice(i+1);l.currentlySubscribing=!0,(this[n+"Cell"]||(this[n],this[n+"Cell"])).on(t.slice(0,i),e,r),l.currentlySubscribing=!1}else{var s=this._events.get(t),o={listener:e,context:r};s?Array.isArray(s)?s.push(o):this._events.set(t,[s,o]):this._events.set(t,o)}},l.prototype._off=function(t,e,r){var i=t.indexOf(":");if(-1!=i){var n=t.slice(i+1);(this[n+"Cell"]||(this[n],this[n+"Cell"])).off(t.slice(0,i),e,r)}else{var s=this._events.get(t);if(!s)return;var o=void 0;if(Array.isArray(s)){if(1!=s.length){for(var l=s.length;l;)if((o=s[--l]).listener==e&&o.context===r){s.splice(l,1);break}return}o=s[0]}else o=s;o.listener==e&&o.context===r&&this._events.delete(t)}},l.prototype.once=function(e,r,i){function n(t){return this._off(e,n,i),r.call(this,t)}return void 0===i&&(i=this),this._on(e,n,i),n},l.prototype.emit=function(t,e){if("string"==typeof t)t={target:this,type:t};else if(t.target){if(t.target!=this)throw new TypeError("Event cannot be emitted on this object")}else t.target=this;return e&&(t.data=e),this.handleEvent(t),t},l.prototype.handleEvent=function(t){var e=this._events.get(t.type);if(e)if(Array.isArray(e)){var r=e.length;if(1==r)!1===this._tryEventListener(e[0],t)&&(t.isPropagationStopped=!0);else{e=e.slice();for(var i=0;i<r;i++)!1===this._tryEventListener(e[i],t)&&(t.isPropagationStopped=!0)}}else!1===this._tryEventListener(e,t)&&(t.isPropagationStopped=!0)},l.prototype._tryEventListener=function(t,e){try{return t.listener.call(t.context,e)}catch(t){logger_1.error(t)}},l.currentlySubscribing=!1,l}();exports.EventEmitter=EventEmitter;