"use strict";var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var afterRelease,is_1=require("@riim/is"),logger_1=require("@riim/logger"),map_set_polyfill_1=require("@riim/map-set-polyfill"),next_tick_1=require("@riim/next-tick"),symbol_polyfill_1=require("@riim/symbol-polyfill"),EventEmitter_1=require("./EventEmitter"),MAX_SAFE_INTEGER=Number.MAX_SAFE_INTEGER||9007199254740991,KEY_WRAPPERS=symbol_polyfill_1.Symbol("wrappers"),errorIndexCounter=0,pushingIndexCounter=0,releasePlan=new map_set_polyfill_1.Map,releasePlanIndex=MAX_SAFE_INTEGER,releasePlanToIndex=-1,releasePlanned=!1,currentlyRelease=0,currentCell=null,$error={error:null},releaseVersion=1,STATE_INITED=1,STATE_CURRENTLY_PULLING=2,STATE_ACTIVE=4,STATE_HAS_FOLLOWERS=8,STATE_PENDING=16,STATE_CAN_CANCEL_CHANGE=32;function release(e){if(releasePlanned||e){releasePlanned=!1,currentlyRelease++;for(var t=releasePlan.get(releasePlanIndex);;){var r=t&&t.shift();if(r){var n=r._level,s=r._changeEvent;if(!s){if(releasePlanIndex<n||-1==r._levelInRelease){if(!t.length){if(releasePlanIndex==releasePlanToIndex)break;t=releasePlan.get(++releasePlanIndex)}continue}if(r.pull(),n=r._level,releasePlanIndex<n){t.length||(t=releasePlan.get(++releasePlanIndex));continue}s=r._changeEvent}if(r._levelInRelease=-1,s){r._fixedValue=r._value,r._changeEvent=null;for(var l=r._pushingIndex,i=r._slaves,a=0,o=i.length;a<o;a++){var _=i[a];_._level<=n&&(_._level=n+1),l>_._pushingIndex&&(_._pushingIndex=l,_._changeEvent=null,_._addToRelease())}var h=releasePlanIndex;if(r.handleEvent(s),releasePlanIndex==MAX_SAFE_INTEGER)break;if(releasePlanIndex!=h){t=releasePlan.get(releasePlanIndex);continue}}if(!t.length){if(releasePlanIndex==releasePlanToIndex)break;t=releasePlan.get(++releasePlanIndex)}}else{if(releasePlanIndex==releasePlanToIndex)break;t=releasePlan.get(++releasePlanIndex)}}if(!--currentlyRelease&&(releasePlanIndex=MAX_SAFE_INTEGER,releasePlanToIndex=-1,releaseVersion++,afterRelease)){var u=afterRelease;afterRelease=null;for(a=0,o=u.length;a<o;a++){var f=u[a];"function"==typeof f?f():f[0]._push(f[1],!0,!1)}}}}function defaultPut(e,t){e.push(t)}var Cell=function(n){function s(e,t){var r=n.call(this)||this;return r._error=null,r._selfErrorCell=null,r._errorCell=null,r._pushingIndex=0,r._errorIndex=0,r._version=0,r._masters=void 0,r._slaves=[],r._level=0,r._levelInRelease=-1,r._selfPendingStatusCell=null,r._pendingStatusCell=null,r._state=STATE_CAN_CANCEL_CHANGE,r._changeEvent=null,r._lastErrorEvent=null,r.debugKey=t&&t.debugKey,r.context=t&&t.context||r,r._pull="function"==typeof e?e:null,r._get=t&&t.get||null,r._validate=t&&t.validate||null,r._merge=t&&t.merge||null,r._put=t&&t.put||defaultPut,r._reap=t&&t.reap||null,r._pull?r._fixedValue=r._value=void 0:(r._validate&&r._validate(e,void 0),r._merge&&(e=r._merge(e,void 0)),r._fixedValue=r._value=e,e instanceof EventEmitter_1.EventEmitter&&e.on("change",r._onValueChange,r)),t&&(t.onChange&&r.on("change",t.onChange),t.onError&&r.on("error",t.onError)),r}return __extends(s,n),Object.defineProperty(s,"currentlyPulling",{get:function(){return!!currentCell},enumerable:!0,configurable:!0}),s.autorun=function(t,r){var n;return new s(function(){var e=this;n=n||function(){e.dispose()},t.call(r,n)},{onChange:function(){}}),n},s.forceRelease=function(){(releasePlanned||currentlyRelease)&&release(!0)},s.afterRelease=function(e){(afterRelease=afterRelease||[]).push(e)},s.prototype.on=function(e,t,r){return(releasePlanned||currentlyRelease)&&release(!0),this._activate(),"object"==typeof e?n.prototype.on.call(this,e,void 0!==t?t:this.context):n.prototype.on.call(this,e,t,void 0!==r?r:this.context),this._state|=STATE_HAS_FOLLOWERS,this},s.prototype.off=function(e,t,r){return(releasePlanned||currentlyRelease)&&release(!0),e?"object"==typeof e?n.prototype.off.call(this,e,void 0!==t?t:this.context):n.prototype.off.call(this,e,t,void 0!==r?r:this.context):n.prototype.off.call(this),!this._slaves.length&&!this._events.has("change")&&!this._events.has("error")&&this._state&STATE_HAS_FOLLOWERS&&(this._state^=STATE_HAS_FOLLOWERS,this._deactivate(),this._reap&&this._reap.call(this.context)),this},s.prototype.addChangeListener=function(e,t){return this.on("change",e,void 0!==t?t:this.context)},s.prototype.removeChangeListener=function(e,t){return this.off("change",e,void 0!==t?t:this.context)},s.prototype.addErrorListener=function(e,t){return this.on("error",e,void 0!==t?t:this.context)},s.prototype.removeErrorListener=function(e,t){return this.off("error",e,void 0!==t?t:this.context)},s.prototype.subscribe=function(t,e){var r=t[KEY_WRAPPERS]||(t[KEY_WRAPPERS]=new map_set_polyfill_1.Map);if(r.has(this))return this;function n(e){return t.call(this,e.data.error||null,e)}return r.set(this,n),void 0===e&&(e=this.context),this.on("change",n,e).on("error",n,e)},s.prototype.unsubscribe=function(e,t){var r=e[KEY_WRAPPERS],n=r&&r.get(this);return n?(r.delete(this),void 0===t&&(t=this.context),this.off("change",n,t).off("error",n,t)):this},s.prototype._registerSlave=function(e){this._activate(),this._slaves.push(e),this._state|=STATE_HAS_FOLLOWERS},s.prototype._unregisterSlave=function(e){this._slaves.splice(this._slaves.indexOf(e),1),this._slaves.length||this._events.has("change")||this._events.has("error")||(this._state^=STATE_HAS_FOLLOWERS,this._deactivate(),this._reap&&this._reap.call(this.context))},s.prototype._activate=function(){if(this._pull&&!(this._state&STATE_ACTIVE)){var e=this._masters;if(null!==e){if(this._version<releaseVersion){var t=this._tryPull();!e&&!this._masters&&this._state&STATE_INITED||(t===$error?this._fail($error.error,!1):this._push(t,!1,!1)),e=this._masters}if(e){for(var r=e.length;e[--r]._registerSlave(this),r;);this._state|=STATE_ACTIVE}}}},s.prototype._deactivate=function(){if(this._state&STATE_ACTIVE){for(var e=this._masters,t=e.length;e[--t]._unregisterSlave(this),t;);-1!=this._levelInRelease&&(this._levelInRelease=-1,this._changeEvent=null),this._state^=STATE_ACTIVE}},s.prototype._addToRelease=function(){var e,t=this._level;t<=this._levelInRelease||((releasePlan.get(t)||(releasePlan.set(t,e=[]),e)).push(this),t<releasePlanIndex&&(releasePlanIndex=t),releasePlanToIndex<t&&(releasePlanToIndex=t),this._levelInRelease=t,releasePlanned||currentlyRelease||(releasePlanned=!0,next_tick_1.nextTick(release)))},s.prototype._onValueChange=function(e){var t=this;this._state&STATE_HAS_FOLLOWERS?currentCell?(afterRelease=afterRelease||[]).push(function(){t._onValueChange$(e)}):this._onValueChange$(e):(this._pushingIndex=++pushingIndexCounter,this._version=++releaseVersion+ +(0<currentlyRelease))},s.prototype._onValueChange$=function(e){this._pushingIndex=++pushingIndexCounter;var t=(e.data||(e.data={})).prev=this._changeEvent;this._changeEvent=e,t?this._value===this._fixedValue&&(this._state&=~STATE_CAN_CANCEL_CHANGE):(this._state&=~STATE_CAN_CANCEL_CHANGE,this._addToRelease())},s.prototype.get=function(){if(this._pull)if(this._state&STATE_ACTIVE)(releasePlanned||currentlyRelease&&!currentCell)&&release(!0);else if(this._version<releaseVersion){var e=this._masters;if(null!==e){var t=this._tryPull(),r=this._masters;if(e||r||!(this._state&STATE_INITED)){if(r&&this._state&STATE_HAS_FOLLOWERS){for(var n=r.length;r[--n]._registerSlave(this),n;);this._state|=STATE_ACTIVE}t===$error?this._fail($error.error,!1):this._push(t,!1,!1)}}}if(currentCell){var s=currentCell._masters,l=this._level;s?-1==s.indexOf(this)&&(s.push(this),currentCell._level<=l&&(currentCell._level=l+1)):(currentCell._masters=[this],currentCell._level=l+1)}return this._get?this._get(this._value):this._value},s.prototype.pull=function(){if(!this._pull)return!1;var e,t,r;if(releasePlanned&&release(),this._state&STATE_HAS_FOLLOWERS){e=this._masters,t=this._level,r=this._tryPull();var n=this._masters,s=0;if(n){var l=n.length;do{var i=n[--l];e&&-1!=e.indexOf(i)||(i._registerSlave(this),s++)}while(l)}if(e&&(n?n.length-s:0)<e.length)for(l=e.length;l;){var a=e[--l];n&&-1!=n.indexOf(a)||a._unregisterSlave(this)}if(n&&n.length?this._state|=STATE_ACTIVE:this._state&=~STATE_ACTIVE,currentlyRelease&&this._level>t)return this._addToRelease(),!1}else r=this._tryPull();return r===$error?(this._fail($error.error,!1),!0):this._push(r,!1,!0)},s.prototype._tryPull=function(){if(this._state&STATE_CURRENTLY_PULLING)throw new TypeError("Circular pulling detected");var e=this._pull;e.length&&(this._selfPendingStatusCell&&this._selfPendingStatusCell.set(!0),this._state|=STATE_PENDING);var t=currentCell;(currentCell=this)._masters=null,this._level=0,this._state|=STATE_CURRENTLY_PULLING;try{return e.length?e.call(this.context,this,this._value):e.call(this.context)}catch(e){return $error.error=e,$error}finally{currentCell=t,this._version=releaseVersion+ +(0<currentlyRelease);var r=this._pendingStatusCell;r&&r._state&STATE_ACTIVE&&r.pull();var n=this._errorCell;n&&n._state&STATE_ACTIVE&&n.pull(),this._state^=STATE_CURRENTLY_PULLING}},s.prototype.getError=function(){var e=this._errorCell;if(!e){var t=this.debugKey;this._selfErrorCell=new s(this._error,t?{debugKey:t+"._selfErrorCell"}:void 0),e=this._errorCell=new s(function(){this.get();var e,t=this._selfErrorCell.get();if(t&&(e=this._errorIndex)==errorIndexCounter)return t;var r=this._masters;if(r){var n=r.length;do{var s=r[--n],l=s.getError();if(l){var i=s._errorIndex;if(i==errorIndexCounter)return l;(!t||e<i)&&(t=l,e=i)}}while(n)}return t},t?{debugKey:t+"._errorCell",context:this}:{context:this})}return e.get()},s.prototype.isPending=function(){var e=this._pendingStatusCell;if(!e){var t=this.debugKey;this._selfPendingStatusCell=new s(!!(this._state&STATE_PENDING),t?{debugKey:t+"._selfPendingStatusCell"}:void 0),e=this._pendingStatusCell=new s(function(){if(this._selfPendingStatusCell.get())return!0;this.get();var e=this._masters;if(e){var t=e.length;do{if(e[--t].isPending())return!0}while(t)}return!1},t?{debugKey:t+"._pendingStatusCell",context:this}:{context:this})}return e.get()},s.prototype.set=function(e){return this._validate&&this._validate(e,this._value),this._merge&&(e=this._merge(e,this._value)),this._selfPendingStatusCell&&this._selfPendingStatusCell.set(!0),this._state|=STATE_PENDING,3<=this._put.length?this._put.call(this.context,this,e,this._value):this._put.call(this.context,this,e),this},s.prototype.push=function(e){return this._push(e,!0,!1),this},s.prototype._push=function(e,t,r){this._state|=STATE_INITED;var n=this._value;return t&&currentCell&&this._state&STATE_HAS_FOLLOWERS?is_1.is(e,n)?(this._setError(null),this._resolvePending(),!1):((afterRelease=afterRelease||[]).push([this,e]),!0):((t||!currentlyRelease&&r)&&(this._pushingIndex=++pushingIndexCounter),this._setError(null),is_1.is(e,n)?((t||currentlyRelease&&r)&&this._resolvePending(),!1):(this._value=e,n instanceof EventEmitter_1.EventEmitter&&n.off("change",this._onValueChange,this),e instanceof EventEmitter_1.EventEmitter&&e.on("change",this._onValueChange,this),this._state&STATE_HAS_FOLLOWERS?this._changeEvent?is_1.is(e,this._fixedValue)&&this._state&STATE_CAN_CANCEL_CHANGE?(this._levelInRelease=-1,this._changeEvent=null):this._changeEvent={target:this,type:"change",data:{oldValue:n,value:e,prev:this._changeEvent}}:(this._state|=STATE_CAN_CANCEL_CHANGE,this._changeEvent={target:this,type:"change",data:{oldValue:n,value:e,prev:null}},this._addToRelease()):((t||!currentlyRelease&&r)&&releaseVersion++,this._fixedValue=e,this._version=releaseVersion+ +(0<currentlyRelease)),(t||currentlyRelease&&r)&&this._resolvePending(),!0))},s.prototype.fail=function(e){return this._fail(e,!0),this},s.prototype._fail=function(e,t){logger_1.error("["+this.debugKey+"]",e),e instanceof Error||(e=new Error(String(e))),this._setError(e),t&&this._resolvePending()},s.prototype._setError=function(e){(e||this._error)&&(this._error=e,this._selfErrorCell&&this._selfErrorCell.set(e),e&&(this._errorIndex=++errorIndexCounter,this._handleErrorEvent({target:this,type:"error",data:{error:e}})))},s.prototype._handleErrorEvent=function(e){if(this._lastErrorEvent!==e){this._lastErrorEvent=e,this.handleEvent(e);for(var t=this._slaves,r=0,n=t.length;r<n;r++)t[r]._handleErrorEvent(e)}},s.prototype._resolvePending=function(){this._state&STATE_PENDING&&(this._selfPendingStatusCell&&this._selfPendingStatusCell.set(!1),this._state^=STATE_PENDING)},s.prototype.reap=function(){for(var e=this._slaves,t=0,r=e.length;t<r;t++)e[t].reap();return this.off()},s.prototype.dispose=function(){return this.reap()},s}(EventEmitter_1.EventEmitter);(exports.Cell=Cell).prototype[symbol_polyfill_1.Symbol.iterator]=function(){return this._value[symbol_polyfill_1.Symbol.iterator]()};