import{Map}from"./Map-polyfill";import{logError}from"./utils";const hasOwn=Object.prototype.hasOwnProperty;let currentlySubscribing=!1,transactionLevel=0,transactionEvents=[],silently=0;export class EventEmitter{constructor(){this._events=new Map}static get currentlySubscribing(){return currentlySubscribing}static transact(t){transactionLevel++;try{t()}catch(t){logError(t)}if(--transactionLevel)return;let e=transactionEvents;transactionEvents=[];for(let t of e)t.target.handleEvent(t)}static silently(t){silently++;try{t()}catch(t){logError(t)}silently--}getEvents(t){if(t){let e=this._events.get(t);return e?Array.isArray(e)?e:[e]:[]}let e=new Map;for(let[t,r]of this._events)e.set(t,Array.isArray(r)?r:[r]);return e}on(t,e,r){if("object"==typeof t){r=void 0!==e?e:this;let i=t;for(t in i)hasOwn.call(i,t)&&this._on(t,i[t],r);for(let t of Object.getOwnPropertySymbols(i))this._on(t,i[t],r)}else this._on(t,e,void 0!==r?r:this);return this}off(t,e,r){if(t)if("object"==typeof t){r=void 0!==e?e:this;let i=t;for(t in i)hasOwn.call(i,t)&&this._off(t,i[t],r);for(let t of Object.getOwnPropertySymbols(i))this._off(t,i[t],r)}else this._off(t,e,void 0!==r?r:this);else this._events.clear();return this}_on(t,e,r){let i;if("string"==typeof t&&-1!=(i=t.indexOf(":"))){let n=t.slice(i+1);currentlySubscribing=!0,(this[n+"Cell"]||(this[n],this[n+"Cell"])).on(t.slice(0,i),e,r),currentlySubscribing=!1}else{let i=this._events.get(t),n={listener:e,context:r};i?Array.isArray(i)?i.push(n):this._events.set(t,[i,n]):this._events.set(t,n)}}_off(t,e,r){let i;if("string"==typeof t&&-1!=(i=t.indexOf(":"))){let n=t.slice(i+1);(this[n+"Cell"]||(this[n],this[n+"Cell"])).off(t.slice(0,i),e,r)}else{let i,n=this._events.get(t);if(!n)return;if(Array.isArray(n)){if(1!=n.length){for(let t=n.length;t;)if((i=n[--t]).listener==e&&i.context===r){n.splice(t,1);break}return}i=n[0]}else i=n;i.listener==e&&i.context===r&&this._events.delete(t)}}once(t,e,r){function i(n){return this._off(t,i,r),e.call(this,n)}return void 0===r&&(r=this),this._on(t,i,r),i}emit(t,e){if("object"==typeof t)if(t.target){if(t.target!=this)throw TypeError("Event cannot be emitted on this target")}else t.target=this;else t={target:this,type:t};if(e&&(t.data=e),!silently)if(transactionLevel)for(let e=transactionEvents.length;;){if(!e){(t.data||(t.data={})).prevEvent=null,transactionEvents.push(t);break}let r=transactionEvents[--e];if(r.target==this&&r.type===t.type){(t.data||(t.data={})).prevEvent=r,transactionEvents[e]=t;break}}else this.handleEvent(t);return t}handleEvent(t){let e=this._events.get(t.type);if(e)if(Array.isArray(e))if(1==e.length)!1===this._tryEventListener(e[0],t)&&(t.propagationStopped=!0);else{e=e.slice();for(let r=0;r<e.length;r++)!1===this._tryEventListener(e[r],t)&&(t.propagationStopped=!0)}else!1===this._tryEventListener(e,t)&&(t.propagationStopped=!0)}_tryEventListener(t,e){try{return t.listener.call(t.context,e)}catch(t){logError(t)}}};