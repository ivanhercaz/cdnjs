"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var logger_1=require("@riim/logger"),map_set_polyfill_1=require("@riim/map-set-polyfill"),currentlySubscribing=!1,transactionEvents=new map_set_polyfill_1.Map,transactionLevel=0,EventEmitter=function(){function t(){this._events=new map_set_polyfill_1.Map}return Object.defineProperty(t,"currentlySubscribing",{get:function(){return currentlySubscribing},set:function(t){currentlySubscribing=t},enumerable:!0,configurable:!0}),t.transact=function(t){transactionLevel++;try{t()}finally{if(--transactionLevel)return;var e=transactionEvents;transactionEvents=new map_set_polyfill_1.Map,e.forEach(function(t,e){for(var r in t)e.handleEvent(t[r])})}},t.prototype.getEvents=function(t){var r;return t?(r=this._events.get(t))?Array.isArray(r)?r:[r]:[]:(r=Object.create(null),this._events.forEach(function(t,e){r[e]=Array.isArray(t)?t:[t]}),r)},t.prototype.on=function(t,e,r){if("object"==typeof t){r=void 0!==e?e:this;var i=t;for(t in i)this._on(t,i[t],r)}else this._on(t,e,void 0!==r?r:this);return this},t.prototype.off=function(t,e,r){if(t)if("object"==typeof t){r=void 0!==e?e:this;var i=t;for(t in i)this._off(t,i[t],r)}else this._off(t,e,void 0!==r?r:this);else this._events.clear();return this},t.prototype._on=function(t,e,r){var i=t.indexOf(":");if(-1!=i){var n=t.slice(i+1);currentlySubscribing=!0,(this[n+"Cell"]||(this[n],this[n+"Cell"])).on(t.slice(0,i),e,r),currentlySubscribing=!1}else{var s=this._events.get(t),o={listener:e,context:r};s?Array.isArray(s)?s.push(o):this._events.set(t,[s,o]):this._events.set(t,o)}},t.prototype._off=function(t,e,r){var i=t.indexOf(":");if(-1!=i){var n=t.slice(i+1);(this[n+"Cell"]||(this[n],this[n+"Cell"])).off(t.slice(0,i),e,r)}else{var s=this._events.get(t);if(!s)return;var o=void 0;if(Array.isArray(s)){if(1!=s.length){for(var a=s.length;a;)if((o=s[--a]).listener==e&&o.context===r){s.splice(a,1);break}return}o=s[0]}else o=s;o.listener==e&&o.context===r&&this._events.delete(t)}},t.prototype.once=function(e,r,i){function n(t){return this._off(e,n,i),r.call(this,t)}return void 0===i&&(i=this),this._on(e,n,i),n},t.prototype.emit=function(t,e){if("string"==typeof t)t={target:this,type:t};else if(t.target){if(t.target!=this)throw new TypeError("Event cannot be emitted on this object")}else t.target=this;if(e&&(t.data=e),transactionLevel){var r=transactionEvents.get(this);r||(r=Object.create(null),transactionEvents.set(this,r)),(t.data||(t.data={})).prev=r[t.type]||null,r[t.type]=t}else this.handleEvent(t);return t},t.prototype.handleEvent=function(t){var e=this._events.get(t.type);if(e)if(Array.isArray(e)){var r=e.length;if(1==r)!1===this._tryEventListener(e[0],t)&&(t.isPropagationStopped=!0);else{e=e.slice();for(var i=0;i<r;i++)!1===this._tryEventListener(e[i],t)&&(t.isPropagationStopped=!0)}}else!1===this._tryEventListener(e,t)&&(t.isPropagationStopped=!0)},t.prototype._tryEventListener=function(t,e){try{return t.listener.call(t.context,e)}catch(t){logger_1.error(t)}},t}();exports.EventEmitter=EventEmitter;