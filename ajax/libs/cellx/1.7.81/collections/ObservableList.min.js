"use strict";var __extends=this&&this.__extends||function(){var i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(t,e){function r(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var is_1=require("@riim/is"),mixin_1=require("@riim/mixin"),symbol_polyfill_1=require("@riim/symbol-polyfill"),EventEmitter_1=require("../EventEmitter"),FreezableCollection_1=require("./FreezableCollection"),ObservableCollection_1=require("./ObservableCollection"),splice=Array.prototype.splice;function defaultComparator(t,e){return t<e?-1:e<t?1:0}var ObservableList=function(i){function h(t,e){var r=i.call(this)||this;return r._items=[],r._length=0,FreezableCollection_1.FreezableCollection.call(r),ObservableCollection_1.ObservableCollection.call(r),"boolean"==typeof e&&(e={adoptsValueChanges:e}),r._adoptsValueChanges=!(!e||!e.adoptsValueChanges),e&&(e.sorted||e.comparator&&!1!==e.sorted)?(r._comparator=e.comparator||defaultComparator,r._sorted=!0):(r._comparator=null,r._sorted=!1),t&&r._addRange(t),r}return __extends(h,i),Object.defineProperty(h.prototype,"length",{get:function(){return this._length},enumerable:!0,configurable:!0}),h.prototype._validateIndex=function(t,e){if(void 0===t)return t;if(t<0){if((t+=this._length)<0)throw new RangeError("Index out of valid range")}else if(t>this._length-(e?0:1))throw new RangeError("Index out of valid range");return t},h.prototype.contains=function(t){return this._valueCounts.has(t)},h.prototype.indexOf=function(t,e){return this._items.indexOf(t,this._validateIndex(e,!0))},h.prototype.lastIndexOf=function(t,e){return this._items.lastIndexOf(t,void 0===e?-1:this._validateIndex(e,!0))},h.prototype.get=function(t){return this._items[this._validateIndex(t,!0)]},h.prototype.getRange=function(t,e){t=this._validateIndex(t,!0);var r=this._items;if(void 0===e)return r.slice(t);if(t+e>r.length)throw new RangeError('Sum of "index" and "count" out of valid range');return r.slice(t,t+e)},h.prototype.set=function(t,e){if(this._sorted)throw new TypeError("Cannot set to sorted list");t=this._validateIndex(t,!0);var r=this._items;return is_1.is(e,r[t])||(this._throwIfFrozen(),this._unregisterValue(r[t]),r[t]=this._registerValue(e),this.emit("change")),this},h.prototype.setRange=function(t,e){if(this._sorted)throw new TypeError("Cannot set to sorted list");t=this._validateIndex(t,!0);var r=e.length;if(!r)return this;if(t+r>this._length)throw new RangeError('Sum of "index" and "values.length" out of valid range');e instanceof h&&(e=e._items.slice());for(var i=this._items,n=!1,o=t+r;t<o;){var s=e[--o-t];is_1.is(s,i[o])||(n||this._throwIfFrozen(),this._unregisterValue(i[o]),i[o]=this._registerValue(s),n=!0)}return n&&this.emit("change"),this},h.prototype.add=function(t){return this._throwIfFrozen(),this._sorted?this._insertSortedValue(t):this._items.push(this._registerValue(t)),this._length++,this.emit("change"),this},h.prototype.addRange=function(t){return t.length&&(this._throwIfFrozen(),this._addRange(t),this.emit("change")),this},h.prototype._addRange=function(t){t instanceof h&&(t=t._items.slice());var e=t.length;if(this._sorted)for(var r=0;r<e;r++)this._insertSortedValue(t[r]);else{var i=this._items,n=i.length;for(r=n+e;n<r;)i[--r]=this._registerValue(t[r-n])}this._length+=e},h.prototype.insert=function(t,e){if(this._sorted)throw new TypeError("Cannot insert to sorted list");return t=this._validateIndex(t,!0),this._throwIfFrozen(),this._items.splice(t,0,this._registerValue(e)),this._length++,this.emit("change"),this},h.prototype.insertRange=function(t,e){if(this._sorted)throw new TypeError("Cannot insert to sorted list");t=this._validateIndex(t,!0);var r=e.length;if(!r)return this;this._throwIfFrozen(),e instanceof h&&(e=e._items);for(var i=r;i;)this._registerValue(e[--i]);return splice.apply(this._items,[t,0].concat(e)),this._length+=r,this.emit("change"),this},h.prototype.remove=function(t,e){var r=this._items.indexOf(t,this._validateIndex(e,!0));return-1!=r&&(this._throwIfFrozen(),this._unregisterValue(t),this._items.splice(r,1),this._length--,this.emit("change"),!0)},h.prototype.removeAll=function(t,e){for(var r=this._validateIndex(e,!0),i=this._items,n=!1;-1!=(r=i.indexOf(t,r));)n||this._throwIfFrozen(),this._unregisterValue(t),i.splice(r,1),n=!0;return n&&(this._length=i.length,this.emit("change")),n},h.prototype.removeEach=function(t,e){e=this._validateIndex(e,!0),t instanceof h&&(t=t._items.slice());for(var r=this._items,i=!1,n=0,o=t.length;n<o;n++){var s=t[n],a=r.indexOf(s,e);-1!=a&&(i||this._throwIfFrozen(),this._unregisterValue(s),r.splice(a,1),i=!0)}return i&&(this._length=r.length,this.emit("change")),i},h.prototype.removeAllEach=function(t,e){e=this._validateIndex(e,!0),t instanceof h&&(t=t._items.slice());for(var r=this._items,i=!1,n=0,o=t.length;n<o;n++)for(var s=t[n],a=e;-1!=(a=r.indexOf(s,a));)i||this._throwIfFrozen(),this._unregisterValue(s),r.splice(a,1),i=!0;return i&&(this._length=r.length,this.emit("change")),i},h.prototype.removeAt=function(t){t=this._validateIndex(t),this._throwIfFrozen();var e=this._items.splice(t,1)[0];return this._unregisterValue(e),this._length--,this.emit("change"),e},h.prototype.removeRange=function(t,e){t=this._validateIndex(t,!0);var r=this._items;if(void 0===e)e=r.length-t;else if(t+e>r.length)throw new RangeError('Sum of "index" and "count" out of valid range');if(!e)return[];this._throwIfFrozen();for(var i=t+e;t<i;)this._unregisterValue(r[--i]);var n=r.splice(t,e);return this._length-=e,this.emit("change"),n},h.prototype.clear=function(){return this._length&&(this._throwIfFrozen(),this._adoptsValueChanges&&this._valueCounts.forEach(function(t,e){e instanceof EventEmitter_1.EventEmitter&&e.off("change",this._onItemChange,this)},this),this._valueCounts.clear(),this._items.length=0,this._length=0,this.emit("change",{subtype:"clear"})),this},h.prototype.join=function(t){return this._items.join(t)},h.prototype.forEach=function(t,e){},h.prototype.map=function(t,e){return[]},h.prototype.filter=function(){return[]},h.prototype.find=function(t,e){for(var r=this._items,i=0,n=r.length;i<n;i++){var o=r[i];if(t.call(e,o,i,this))return o}},h.prototype.findIndex=function(t,e){for(var r=this._items,i=0,n=r.length;i<n;i++)if(t.call(e,r[i],i,this))return i;return-1},h.prototype.every=function(t,e){return!1},h.prototype.some=function(t,e){return!1},h.prototype.reduce=function(t,e){return 0},h.prototype.reduceRight=function(t,e){return 0},h.prototype.keys=function(){return 0},h.prototype.values=function(){return 0},h.prototype.entries=function(){return 0},h.prototype.clone=function(t){return new this.constructor(t?this._items.map(function(t){return t.clone?t.clone():t}):this,{adoptsValueChanges:this._adoptsValueChanges,comparator:this._comparator||void 0,sorted:this._sorted})},h.prototype.toArray=function(){return this._items.slice()},h.prototype.toString=function(){return this._items.join()},h.prototype._insertSortedValue=function(t){for(var e=this._items,r=this._comparator,i=0,n=e.length;i!=n;){var o=i+n>>1;r(t,e[o])<0?n=o:i=1+o}e.splice(i,0,this._registerValue(t))},Object.defineProperty(h.prototype,"isFrozen",{get:function(){return!1},enumerable:!0,configurable:!0}),h.prototype.freeze=function(){return this},h.prototype.unfreeze=function(){return this},h.prototype._throwIfFrozen=function(t){},Object.defineProperty(h.prototype,"adoptsValueChanges",{get:function(){return!1},enumerable:!0,configurable:!0}),h.prototype._onItemChange=function(t){},h.prototype._registerValue=function(t){},h.prototype._unregisterValue=function(t){},h}(EventEmitter_1.EventEmitter);exports.ObservableList=ObservableList,mixin_1.mixin(ObservableList.prototype,FreezableCollection_1.FreezableCollection.prototype,["constructor"]),mixin_1.mixin(ObservableList.prototype,ObservableCollection_1.ObservableCollection.prototype,["constructor"]),["forEach","map","filter","every","some"].forEach(function(t){ObservableList.prototype[t]=function(r,i){return this._items[t](function(t,e){return r.call(i,t,e,this)},this)}}),["reduce","reduceRight"].forEach(function(r){ObservableList.prototype[r]=function(i,t){var n=this;function e(t,e,r){return i(t,e,r,n)}return 2<=arguments.length?this._items[r](e,t):this._items[r](e)}}),[["keys",function(t){return t}],["values",function(t,e){return e}],["entries",function(t,e){return[t,e]}]].forEach(function(t){var i=t[1];ObservableList.prototype[t[0]]=function(){var t=this._items,e=0,r=!1;return{next:function(){if(!r){if(e<t.length)return{value:i(e,t[e++]),done:!1};r=!0}return{value:void 0,done:!0}}}}}),ObservableList.prototype[symbol_polyfill_1.Symbol.iterator]=ObservableList.prototype.values;