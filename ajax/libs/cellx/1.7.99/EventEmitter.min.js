"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const logger_1=require("@riim/logger"),map_set_polyfill_1=require("@riim/map-set-polyfill"),hasOwn=Object.prototype.hasOwnProperty;let currentlySubscribing=!1,transactionLevel=0,transactionEvents=[];class EventEmitter{static get currentlySubscribing(){return currentlySubscribing}static set currentlySubscribing(t){currentlySubscribing=t}static transact(t){transactionLevel++;try{t()}catch(t){logger_1.error(t)}if(--transactionLevel)return;let e=transactionEvents;transactionEvents=[];for(let t of e)t.target.handleEvent(t)}constructor(){this._events=new map_set_polyfill_1.Map}getEvents(t){let e;return t?(e=this._events.get(t))?Array.isArray(e)?e:[e]:[]:(e={__proto__:null},this._events.forEach((t,r)=>{e[r]=Array.isArray(t)?t:[t]}),e)}on(t,e,r){if("object"==typeof t){r=void 0!==e?e:this;let i=t;for(t in i)hasOwn.call(i,t)&&this._on(t,i[t],r)}else this._on(t,e,void 0!==r?r:this);return this}off(t,e,r){if(t)if("object"==typeof t){r=void 0!==e?e:this;let i=t;for(t in i)hasOwn.call(i,t)&&this._off(t,i[t],r)}else this._off(t,e,void 0!==r?r:this);else this._events.clear();return this}_on(t,e,r){let i=t.indexOf(":");if(-1!=i){let s=t.slice(i+1);currentlySubscribing=!0,(this[s+"Cell"]||(this[s],this[s+"Cell"])).on(t.slice(0,i),e,r),currentlySubscribing=!1}else{let i=this._events.get(t),s={listener:e,context:r};i?Array.isArray(i)?i.push(s):this._events.set(t,[i,s]):this._events.set(t,s)}}_off(t,e,r){let i=t.indexOf(":");if(-1!=i){let s=t.slice(i+1);(this[s+"Cell"]||(this[s],this[s+"Cell"])).off(t.slice(0,i),e,r)}else{let i,s=this._events.get(t);if(!s)return;if(Array.isArray(s)){if(1!=s.length){for(let t=s.length;t;)if((i=s[--t]).listener==e&&i.context===r){s.splice(t,1);break}return}i=s[0]}else i=s;i.listener==e&&i.context===r&&this._events.delete(t)}}once(t,e,r){function i(s){return this._off(t,i,r),e.call(this,s)}return void 0===r&&(r=this),this._on(t,i,r),i}emit(t,e){if("string"==typeof t)t={target:this,type:t};else if(t.target){if(t.target!=this)throw new TypeError("Event cannot be emitted on this object")}else t.target=this;if(e&&(t.data=e),transactionLevel)for(let e=transactionEvents.length;;){if(!e){(t.data||(t.data={})).prevEvent=null,transactionEvents.push(t);break}let r=transactionEvents[--e];if(r.target==this&&r.type==t.type){(t.data||(t.data={})).prevEvent=r,transactionEvents[e]=t;break}}else this.handleEvent(t);return t}handleEvent(t){let e=this._events.get(t.type);if(e)if(Array.isArray(e)){let r=e.length;if(1==r)!1===this._tryEventListener(e[0],t)&&(t.propagationStopped=!0);else{e=e.slice();for(let i=0;i<r;i++)!1===this._tryEventListener(e[i],t)&&(t.propagationStopped=!0)}}else!1===this._tryEventListener(e,t)&&(t.propagationStopped=!0)}_tryEventListener(t,e){try{return t.listener.call(t.context,e)}catch(t){logger_1.error(t)}}}exports.EventEmitter=EventEmitter;