"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const logger_1=require("@riim/logger"),next_tick_1=require("@riim/next-tick"),EventEmitter_1=require("./EventEmitter"),WaitError_1=require("./WaitError");function defaultPut(e,t){e.push(t)}const pendingCells=[];let afterRelease,pendingCellsIndex=0,currentCell=null;const $error={error:null};let lastUpdationId=0;function release(){for(;pendingCellsIndex<pendingCells.length;pendingCellsIndex++)pendingCells[pendingCellsIndex]._active&&pendingCells[pendingCellsIndex].actualize();if(pendingCells.length=0,pendingCellsIndex=0,afterRelease){let e=afterRelease;afterRelease=null;for(let t of e)t()}}class Cell extends EventEmitter_1.EventEmitter{constructor(e,t){super(),this._reactions=[],this._error=null,this._lastErrorEvent=null,this._hasSubscribers=!1,this._active=!1,this._currentlyPulling=!1,this._updationId=-1,this.debugKey=t&&t.debugKey,this.context=t&&void 0!==t.context?t.context:this,this._pull="function"==typeof e?e:null,this._get=t&&t.get||null,this._validate=t&&t.validate||null,this._merge=t&&t.merge||null,this._put=t&&t.put||defaultPut,this._reap=t&&t.reap||null,this.meta=t&&t.meta||null,this._pull?(this._dependencies=void 0,this._value=void 0,this._state="dirty",this._inited=!1):(this._dependencies=null,this._validate&&this._validate(e,void 0),this._merge&&(e=this._merge(e,void 0)),this._value=e,this._state="actual",this._inited=!0,e instanceof EventEmitter_1.EventEmitter&&e.on("change",this._onValueChange,this)),t&&(t.onChange&&this.on("change",t.onChange),t.onError&&this.on("error",t.onError))}static get currentlyPulling(){return!!currentCell}static autorun(e,t){let i;return new Cell(function(){i||(i=(()=>{this.dispose()})),e.call(t,i)},{onChange(){}}),i}static release(){release()}static afterRelease(e){(afterRelease||(afterRelease=[])).push(e)}on(e,t,i){return null!==this._dependencies&&this.actualize(),"object"==typeof e?super.on(e,void 0!==t?t:this.context):super.on(e,t,void 0!==i?i:this.context),this._hasSubscribers=!0,this._activate(!0),this}off(e,t,i){return null!==this._dependencies&&this.actualize(),e?"object"==typeof e?super.off(e,void 0!==t?t:this.context):super.off(e,t,void 0!==i?i:this.context):super.off(),!this._hasSubscribers||this._reactions.length||this._events.has("change")||this._events.has("error")||(this._hasSubscribers=!1,this._deactivate(),this._reap&&this._reap.call(this.context)),this}_addReaction(e,t){this._reactions.push(e),this._hasSubscribers=!0,this._activate(t)}_deleteReaction(e){this._reactions.splice(this._reactions.indexOf(e),1),!this._hasSubscribers||this._reactions.length||this._events.has("change")||this._events.has("error")||(this._hasSubscribers=!1,this._deactivate(),this._reap&&this._reap.call(this.context))}_activate(e){if(this._active||!this._pull)return;let t=this._dependencies;if(t){let i=t.length;do{t[--i]._addReaction(this,e)}while(i);e&&(this._state="actual"),this._active=!0}}_deactivate(){if(!this._active)return;let e=this._dependencies,t=e.length;do{e[--t]._deleteReaction(this)}while(t);this._state="dirty",this._active=!1}_onValueChange(e){this._inited=!0,this._updationId=++lastUpdationId;let t=this._reactions;for(let e=0;e<t.length;e++)t[e]._addToRelease(!0);this.handleEvent(e)}_addToRelease(e){this._state=e?"dirty":"check";let t=this._reactions,i=t.length;if(i)do{"actual"==t[--i]._state&&t[i]._addToRelease(!1)}while(i);else 1==pendingCells.push(this)&&next_tick_1.nextTick(release)}actualize(){if("dirty"==this._state)this.pull();else if("check"==this._state){let e=this._dependencies;for(let t=0;;){if(e[t].actualize(),"dirty"==this._state){this.pull();break}if(++t==e.length){this._state="actual";break}}}}get(){if("actual"!=this._state&&this._updationId!=lastUpdationId&&this.actualize(),currentCell&&(currentCell._dependencies?-1==currentCell._dependencies.indexOf(this)&&currentCell._dependencies.push(this):currentCell._dependencies=[this],this._error&&this._error instanceof WaitError_1.WaitError))throw this._error;return this._get?this._get(this._value):this._value}pull(){if(!this._pull)return!1;if(this._currentlyPulling)throw new TypeError("Circular pulling detected");this._currentlyPulling=!0;let e=this._dependencies;this._dependencies=null;let t,i=currentCell;currentCell=this;try{t=this._pull.length?this._pull.call(this.context,this,this._value):this._pull.call(this.context)}catch(e){$error.error=e,t=$error}if(currentCell=i,this._currentlyPulling=!1,this._hasSubscribers){let t=this._dependencies,i=0;if(t){let s=t.length;do{let r=t[--s];e&&-1!=e.indexOf(r)||(r._addReaction(this,!1),i++)}while(s)}if(e&&(!t||t.length-i<e.length))for(let i=e.length;i;)i--,t&&-1!=t.indexOf(e[i])||e[i]._deleteReaction(this);t?this._active=!0:(this._state="actual",this._active=!1)}else this._state=this._dependencies?"dirty":"actual";return t===$error?this.fail($error.error):this.push(t)}set(e){return this._inited||this.pull(),this._validate&&this._validate(e,this._value),this._merge&&(e=this._merge(e,this._value)),this._put.length>=3?this._put.call(this.context,this,e,this._value):this._put.call(this.context,this,e),this}push(e){this._inited=!0,this._error&&this._setError(null);let t=this._value,i=!Object.is(e,t);if(i&&(this._value=e,t instanceof EventEmitter_1.EventEmitter&&t.off("change",this._onValueChange,this),e instanceof EventEmitter_1.EventEmitter&&e.on("change",this._onValueChange,this)),this._active&&(this._state="actual"),this._updationId=++lastUpdationId,i){let i=this._reactions;for(let e=0;e<i.length;e++)i[e]._addToRelease(!0);this.emit("change",{prevValue:t,value:e})}return i}fail(e){this._inited=!0;let t=e instanceof WaitError_1.WaitError;return t||(this.debugKey?logger_1.error("["+this.debugKey+"]",e):logger_1.error(e),e instanceof Error||(e=new Error(String(e)))),this._setError(e),this._active&&(this._state="actual"),t}_setError(e){this._error=e,this._updationId=++lastUpdationId,e&&this._handleErrorEvent({target:this,type:"error",data:{error:e}})}_handleErrorEvent(e){if(this._lastErrorEvent===e)return;this._lastErrorEvent=e,this.handleEvent(e);let t=this._reactions;for(let i=0;i<t.length;i++)t[i]._handleErrorEvent(e)}wait(){throw new WaitError_1.WaitError}reap(){this.off();let e=this._reactions;for(let t=0;t<e.length;t++)e[t].reap();return this}dispose(){return this.reap()}}exports.Cell=Cell;