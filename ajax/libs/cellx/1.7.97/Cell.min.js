"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const is_1=require("@riim/is"),logger_1=require("@riim/logger"),map_set_polyfill_1=require("@riim/map-set-polyfill"),next_tick_1=require("@riim/next-tick"),symbol_polyfill_1=require("@riim/symbol-polyfill"),EventEmitter_1=require("./EventEmitter"),WaitError_1=require("./WaitError"),MAX_SAFE_INTEGER=Number.MAX_SAFE_INTEGER||9007199254740991,KEY_WRAPPERS=symbol_polyfill_1.Symbol("cellx[wrappers]"),releasePlan=new map_set_polyfill_1.Map;let releasePlanIndex=MAX_SAFE_INTEGER,releasePlanToIndex=-1,releasePlanned=!1,currentlyRelease=0;const releasedCells=new map_set_polyfill_1.Set;let afterRelease,releaseVersion=1,currentCell=null;const $error={error:null};let pushingIndexCounter=0,errorIndexCounter=0;const STATE_INITED=1,STATE_ACTIVE=2,STATE_HAS_FOLLOWERS=4,STATE_CURRENTLY_PULLING=8,STATE_PENDING=16,STATE_FULFILLED=32,STATE_REJECTED=64,STATE_CAN_CANCEL_CHANGE=128;function release(e){if(!releasePlanned&&!e)return;releasePlanned=!1,currentlyRelease++;let t=releasePlan.get(releasePlanIndex);for(;;){let e,l=t&&t.shift();if(!l){if(releasePlanIndex==releasePlanToIndex)break;t=releasePlan.get(++releasePlanIndex);continue}let s=l._level,r=l._changeEvent;if(r)e=releasePlanIndex;else{if(s>releasePlanIndex||-1==l._levelInRelease){if(!t.length){if(releasePlanIndex==releasePlanToIndex)break;t=releasePlan.get(++releasePlanIndex)}continue}if(e=releasePlanIndex,l.pull(),releasedCells.has(l)?Cell.debug&&logger_1.warn("Multiple cell pull in release",l):releasedCells.add(l),releasePlanIndex<e){t.unshift(l),t=releasePlan.get(releasePlanIndex);continue}if((s=l._level)>releasePlanIndex){t.length||(t=releasePlan.get(++releasePlanIndex));continue}r=l._changeEvent}if(l._levelInRelease=-1,r){l._fixedValue=l._value,l._changeEvent=null;let i=l._pushingIndex,n=l._reactions;for(let e=0,t=n.length;e<t;e++){let t=n[e];t._level<=s&&(t._level=s+1),i>t._pushingIndex&&(t._pushingIndex=i,t._prevChangeEvent=t._changeEvent,t._changeEvent=null,t._addToRelease())}if(l.handleEvent(r),releasePlanIndex==MAX_SAFE_INTEGER)break;if(releasePlanIndex!=e){t=releasePlan.get(releasePlanIndex);continue}}if(!t.length){if(releasePlanIndex==releasePlanToIndex)break;t=releasePlan.get(++releasePlanIndex)}}if(!--currentlyRelease&&(releasePlanIndex=MAX_SAFE_INTEGER,releasePlanToIndex=-1,releasedCells.clear(),releaseVersion++,afterRelease)){let e=afterRelease;afterRelease=null;for(let t=0,l=e.length;t<l;t++){let l=e[t];"function"==typeof l?l():l[0]._push(l[1],!0,!1)}}}function defaultPut(e,t){e.push(t)}class Cell extends EventEmitter_1.EventEmitter{constructor(e,t){super(),this._error=null,this._pushingIndex=0,this._errorIndex=0,this._version=0,this._dependencies=void 0,this._reactions=[],this._level=0,this._levelInRelease=-1,this._selfPendingStatusCell=null,this._pendingStatusCell=null,this._selfErrorCell=null,this._errorCell=null,this._state=STATE_CAN_CANCEL_CHANGE,this._prevChangeEvent=null,this._changeEvent=null,this._lastErrorEvent=null,this.debugKey=t&&t.debugKey,this.context=t&&void 0!==t.context?t.context:this,this._pull="function"==typeof e?e:null,this._get=t&&t.get||null,this._validate=t&&t.validate||null,this._merge=t&&t.merge||null,this._put=t&&t.put||defaultPut,this._onFulfilled=this._onRejected=null,this._reap=t&&t.reap||null,this.meta=t&&t.meta||null,this._pull?this._fixedValue=this._value=void 0:(this._validate&&this._validate(e,void 0),this._merge&&(e=this._merge(e,void 0)),this._fixedValue=this._value=e,e instanceof EventEmitter_1.EventEmitter&&e.on("change",this._onValueChange,this)),t&&(t.onChange&&this.on("change",t.onChange),t.onError&&this.on("error",t.onError))}static get currentlyPulling(){return!!currentCell}static autorun(e,t){let l;return new Cell(function(){l||(l=(()=>{this.dispose()})),e.call(t,l)},{onChange(){}}),l}static forceRelease(){(releasePlanned||currentlyRelease)&&release(!0)}static afterRelease(e){(afterRelease||(afterRelease=[])).push(e)}on(e,t,l){return(releasePlanned||currentlyRelease)&&release(!0),this._activate(),"object"==typeof e?super.on(e,void 0!==t?t:this.context):super.on(e,t,void 0!==l?l:this.context),this._state|=STATE_HAS_FOLLOWERS,this}off(e,t,l){return(releasePlanned||currentlyRelease)&&release(!0),e?"object"==typeof e?super.off(e,void 0!==t?t:this.context):super.off(e,t,void 0!==l?l:this.context):super.off(),!this._reactions.length&&!this._events.has("change")&&!this._events.has("error")&&this._state&STATE_HAS_FOLLOWERS&&(this._state^=STATE_HAS_FOLLOWERS,this._deactivate(),this._reap&&this._reap.call(this.context)),this}addChangeListener(e,t){return this.on("change",e,void 0!==t?t:this.context)}removeChangeListener(e,t){return this.off("change",e,void 0!==t?t:this.context)}addErrorListener(e,t){return this.on("error",e,void 0!==t?t:this.context)}removeErrorListener(e,t){return this.off("error",e,void 0!==t?t:this.context)}subscribe(e,t){let l=e[KEY_WRAPPERS]||(e[KEY_WRAPPERS]=new map_set_polyfill_1.Map);if(l.has(this))return this;function s(t){return e.call(this,t.data.error||null,t)}return l.set(this,s),void 0===t&&(t=this.context),this.on("change",s,t).on("error",s,t)}unsubscribe(e,t){let l=e[KEY_WRAPPERS],s=l&&l.get(this);return s?(l.delete(this),void 0===t&&(t=this.context),this.off("change",s,t).off("error",s,t)):this}_addReaction(e){this._activate(),this._reactions.push(e),this._state|=STATE_HAS_FOLLOWERS}_deleteReaction(e){this._reactions.splice(this._reactions.indexOf(e),1),this._reactions.length||this._events.has("change")||this._events.has("error")||(this._state^=STATE_HAS_FOLLOWERS,this._deactivate(),this._reap&&this._reap.call(this.context))}_activate(){if(!this._pull||this._state&STATE_ACTIVE)return;let e=this._dependencies;if(null!==e){if(this._version<releaseVersion){let t=this._pull$();!e&&!this._dependencies&&this._state&STATE_INITED||(t===$error?this._fail($error.error,!1,!1):this._push(t,!1,!1)),e=this._dependencies}if(e){let t=e.length;do{e[--t]._addReaction(this)}while(t);this._state|=STATE_ACTIVE}}}_deactivate(){if(!(this._state&STATE_ACTIVE))return;let e=this._dependencies,t=e.length;do{e[--t]._deleteReaction(this)}while(t);-1!=this._levelInRelease&&(this._levelInRelease=-1,this._changeEvent=null),this._state^=STATE_ACTIVE}_onValueChange(e){if(this._pushingIndex=++pushingIndexCounter,this._state&STATE_HAS_FOLLOWERS){let t=(e.data||(e.data={})).prevEvent=this._changeEvent;this._changeEvent=e,t?this._value===this._fixedValue&&(this._state&=~STATE_CAN_CANCEL_CHANGE):(this._state&=~STATE_CAN_CANCEL_CHANGE,this._addToRelease())}else this._version=++releaseVersion+ +(0!=currentlyRelease)}get(){if(this._pull)if(this._state&STATE_ACTIVE)(releasePlanned||currentlyRelease&&!currentCell)&&release(!0);else if(this._version<releaseVersion+ +releasePlanned+ +(0!=currentlyRelease)){let e=this._dependencies;if(null!==e){let t=this._pull$(),l=this._dependencies;if(e||l||!(this._state&STATE_INITED)){if(l&&this._state&STATE_HAS_FOLLOWERS){let e=l.length;do{l[--e]._addReaction(this)}while(e);this._state|=STATE_ACTIVE}t===$error?this._fail($error.error,!1,!1):this._push(t,!1,!1)}}}if(currentCell){let e=currentCell._dependencies,t=this._level;e?-1==e.indexOf(this)&&(e.push(this),currentCell._level<=t&&(currentCell._level=t+1)):(currentCell._dependencies=[this],currentCell._level=t+1)}if(currentCell&&this._error&&this._error instanceof WaitError_1.WaitError)throw this._error;return this._get?this._get(this._value):this._value}pull(){if(!this._pull)return!1;let e,t,l;if(releasePlanned&&release(),this._state&STATE_HAS_FOLLOWERS){e=this._dependencies,t=this._level,l=this._pull$();let s=this._dependencies,r=0;if(s){let t=s.length;do{let l=s[--t];e&&-1!=e.indexOf(l)||(l._addReaction(this),r++)}while(t)}if(e&&(s?s.length-r:0)<e.length)for(let t=e.length;t;){let l=e[--t];s&&-1!=s.indexOf(l)||l._deleteReaction(this)}if(s?this._state|=STATE_ACTIVE:this._state&=~STATE_ACTIVE,currentlyRelease&&this._level>t)return this._addToRelease(),!1}else l=this._pull$();return l===$error?(this._fail($error.error,!1,!0),!0):this._push(l,!1,!0)}_pull$(){if(this._state&STATE_CURRENTLY_PULLING)throw new TypeError("Circular pulling detected");let e=this._pull;e.length&&(this._selfPendingStatusCell&&this._selfPendingStatusCell.set(!0),this._state|=STATE_PENDING,this._state&=~(STATE_FULFILLED|STATE_REJECTED));let t=currentCell;currentCell=this,this._dependencies=null,this._level=0,this._state|=STATE_CURRENTLY_PULLING;try{return e.length?e.call(this.context,this,this._value):e.call(this.context)}catch(e){return $error.error=e,$error}finally{currentCell=t,this._version=releaseVersion+ +(0!=currentlyRelease);let e=this._pendingStatusCell;e&&e._state&STATE_ACTIVE&&e.pull();let l=this._errorCell;l&&l._state&STATE_ACTIVE&&l.pull(),this._state^=STATE_CURRENTLY_PULLING}}getError(){let e=this._errorCell;if(!e){let t=this.debugKey;this._selfErrorCell=new Cell(this._error,t?{debugKey:t+"._selfErrorCell"}:void 0),e=this._errorCell=new Cell(function(){this.get();let e,t=this._selfErrorCell.get();if(t&&(e=this._errorIndex)==errorIndexCounter)return t;let l=this._dependencies;if(l){let s=l.length;do{let r=l[--s],i=r.getError();if(i){let l=r._errorIndex;if(l==errorIndexCounter)return i;(!t||e<l)&&(t=i,e=l)}}while(s)}return t},t?{debugKey:t+"._errorCell",context:this}:{context:this})}return e.get()}isPending(){let e=this._pendingStatusCell;if(!e){let t=this.debugKey;this._selfPendingStatusCell=new Cell(!!(this._state&STATE_PENDING),t?{debugKey:t+"._selfPendingStatusCell"}:void 0),e=this._pendingStatusCell=new Cell(function(){if(this._selfPendingStatusCell.get())return!0;try{this.get()}catch(e){}let e=this._dependencies;if(e){let t=e.length;do{if(e[--t].isPending())return!0}while(t)}return!1},t?{debugKey:t+"._pendingStatusCell",context:this}:{context:this})}return e.get()}set(e){return this._validate&&this._validate(e,this._value),this._merge&&(e=this._merge(e,this._value)),this._selfPendingStatusCell&&this._selfPendingStatusCell.set(!0),this._state|=STATE_PENDING,this._state&=~(STATE_FULFILLED|STATE_REJECTED),this._put.length>=3?this._put.call(this.context,this,e,this._value):this._put.call(this.context,this,e),this}push(e){return this._push(e,!0,!1),this}_push(e,t,l){(t||!currentlyRelease&&l)&&(this._pushingIndex=++pushingIndexCounter),this._state|=STATE_INITED,this._error&&this._setError(null,!1);let s=this._value;if(is_1.is(e,s))return(t||currentlyRelease&&l)&&this._fulfill(e),!1;if(this._value=e,s instanceof EventEmitter_1.EventEmitter&&s.off("change",this._onValueChange,this),e instanceof EventEmitter_1.EventEmitter&&e.on("change",this._onValueChange,this),this._state&STATE_HAS_FOLLOWERS){let t=this._changeEvent||this._prevChangeEvent;t?(is_1.is(e,this._fixedValue)&&this._state&STATE_CAN_CANCEL_CHANGE?(this._levelInRelease=-1,this._changeEvent=null):this._changeEvent={target:this,type:"change",data:{prevEvent:t,prevValue:s,value:e}},this._prevChangeEvent=null):(this._state|=STATE_CAN_CANCEL_CHANGE,this._changeEvent={target:this,type:"change",data:{prevEvent:null,prevValue:s,value:e}},this._addToRelease())}else(t||!currentlyRelease&&l)&&releaseVersion++,this._fixedValue=e,this._version=releaseVersion+ +(0!=currentlyRelease);return(t||currentlyRelease&&l)&&this._fulfill(e),!0}_fulfill(e){this._resolvePending(),this._state&STATE_FULFILLED||(this._state|=STATE_FULFILLED,this._onFulfilled&&this._onFulfilled(e))}fail(e){return this._fail(e,!0,!1),this}_fail(e,t,l){e instanceof WaitError_1.WaitError||(this.debugKey?logger_1.error("["+this.debugKey+"]",e):logger_1.error(e),e instanceof Error||(e=new Error(String(e)))),this._setError(e,t||0!=currentlyRelease&&l)}_setError(e,t){this._error=e,this._selfErrorCell&&this._selfErrorCell.set(e),e&&(this._errorIndex=++errorIndexCounter,this._handleErrorEvent({target:this,type:"error",data:{error:e}},t?e:null))}_handleErrorEvent(e,t){if(this._lastErrorEvent===e)return;this._lastErrorEvent=e,this.handleEvent(e),t&&this._reject(t);let l=this._reactions;for(let s=l.length;s;)l[--s]._handleErrorEvent(e,t)}_reject(e){this._resolvePending(),e instanceof WaitError_1.WaitError||this._state&STATE_REJECTED||(this._state|=STATE_REJECTED,this._onRejected&&this._onRejected(e))}wait(){throw new WaitError_1.WaitError}_addToRelease(){let e,t=this._level;t<=this._levelInRelease||((releasePlan.get(t)||(releasePlan.set(t,e=[]),e)).push(this),releasePlanIndex>t&&(releasePlanIndex=t),releasePlanToIndex<t&&(releasePlanToIndex=t),this._levelInRelease=t,releasePlanned||currentlyRelease||(releasePlanned=!0,next_tick_1.nextTick(release)))}_resolvePending(){this._state&STATE_PENDING&&(this._selfPendingStatusCell&&this._selfPendingStatusCell.set(!1),this._state^=STATE_PENDING)}then(e,t){let l=()=>{};if(this.on("change",l),!this._pull||this._state&STATE_FULFILLED)return this.off("change",l),Promise.resolve(this._get?this._get(this._value):this._value).then(e);if(this._state&STATE_REJECTED)return this.off("change",l),Promise.reject(this._error).catch(t);let s=this;return new Promise((e,t)=>{s._onFulfilled=(t=>{s._onFulfilled=s._onRejected=null,this.off("change",l),e(s._get?s._get(t):t)}),s._onRejected=(e=>{s._onFulfilled=s._onRejected=null,this.off("change",l),t(e)})}).then(e,t)}catch(e){return this.then(null,e)}reap(){this.off();let e=this._reactions;for(let t=e.length;t;)e[--t].reap();return this}dispose(){return this.reap()}}Cell.debug=!1,exports.Cell=Cell;