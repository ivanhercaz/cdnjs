!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.InfiniteAjaxScroll=e()}(this,function(){"use strict";function t(t){return"object"==typeof window.Node?t instanceof window.Node:null!==t&&"object"==typeof t&&"number"==typeof t.nodeType&&"string"==typeof t.nodeName}function e(e,n){if(void 0===n&&(n=document),e instanceof Array)return e.filter(t);if(t(e))return[e];if(o=Object.prototype.toString.call(i=e),"object"==typeof window.NodeList?i instanceof window.NodeList:null!==i&&"object"==typeof i&&"number"==typeof i.length&&/^\[object (HTMLCollection|NodeList|Object)\]$/.test(o)&&(0===i.length||t(i[0])))return Array.prototype.slice.call(e);var i,o;if("string"==typeof e)try{var r=n.querySelectorAll(e);return Array.prototype.slice.call(r)}catch(t){return[]}return[]}var n=Object.prototype.hasOwnProperty,i=Object.prototype.toString,o=Object.defineProperty,r=Object.getOwnPropertyDescriptor,s=function(t){return"function"==typeof Array.isArray?Array.isArray(t):"[object Array]"===i.call(t)},u=function(t){if(!t||"[object Object]"!==i.call(t))return!1;var e,o=n.call(t,"constructor"),r=t.constructor&&t.constructor.prototype&&n.call(t.constructor.prototype,"isPrototypeOf");if(t.constructor&&!o&&!r)return!1;for(e in t);return void 0===e||n.call(t,e)},c=function(t,e){o&&"__proto__"===e.name?o(t,e.name,{enumerable:!0,configurable:!0,value:e.newValue,writable:!0}):t[e.name]=e.newValue},a=function(t,e){if("__proto__"===e){if(!n.call(t,e))return;if(r)return r(t,e).value}return t[e]},l=function t(){var e,n,i,o,r,l,f=arguments,p=arguments[0],d=1,h=arguments.length,m=!1;for("boolean"==typeof p&&(m=p,p=arguments[1]||{},d=2),(null==p||"object"!=typeof p&&"function"!=typeof p)&&(p={});h>d;++d)if(null!=(e=f[d]))for(n in e)i=a(p,n),p!==(o=a(e,n))&&(m&&o&&(u(o)||(r=s(o)))?(r?(r=!1,l=i&&s(i)?i:[]):l=i&&u(i)?i:{},c(p,{name:n,newValue:t(m,l,o)})):void 0!==o&&c(p,{name:n,newValue:o}));return p},f="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},p="Expected a function",d=NaN,h="[object Symbol]",m=/^\s+|\s+$/g,y=/^[-+]0x[0-9a-f]+$/i,v=/^0b[01]+$/i,b=/^0o[0-7]+$/i,g=parseInt,w="object"==typeof self&&self&&self.Object===Object&&self,x="object"==typeof f&&f&&f.Object===Object&&f||w||Function("return this")(),j=Object.prototype.toString,O=Math.max,C=Math.min,T=function(){return x.Date.now()};function E(t,e,n){var i,o,r,s,u,c,a=0,l=!1,f=!1,d=!0;if("function"!=typeof t)throw new TypeError(p);function h(e){var n=i,r=o;return i=o=void 0,a=e,s=t.apply(r,n)}function m(t){var n=t-c;return void 0===c||n>=e||0>n||f&&t-a>=r}function y(){var t=T();if(m(t))return v(t);u=setTimeout(y,function(t){var n=e-(t-c);return f?C(n,r-(t-a)):n}(t))}function v(t){return u=void 0,d&&i?h(t):(i=o=void 0,s)}function b(){var t=T(),n=m(t);if(i=arguments,o=this,c=t,n){if(void 0===u)return function(t){return a=t,u=setTimeout(y,e),l?h(t):s}(c);if(f)return u=setTimeout(y,e),h(c)}return void 0===u&&(u=setTimeout(y,e)),s}return e=S(e)||0,L(n)&&(l=!!n.leading,r=(f="maxWait"in n)?O(S(n.maxWait)||0,e):r,d="trailing"in n?!!n.trailing:d),b.cancel=function(){void 0!==u&&clearTimeout(u),a=0,i=c=o=u=void 0},b.flush=function(){return void 0===u?s:v(T())},b}function L(t){var e=typeof t;return!!t&&("object"==e||"function"==e)}function S(t){if("number"==typeof t)return t;if(function(t){return"symbol"==typeof t||function(t){return!!t&&"object"==typeof t}(t)&&j.call(t)==h}(t))return d;if(L(t)){var e="function"==typeof t.valueOf?t.valueOf():t;t=L(e)?e+"":e}if("string"!=typeof t)return 0===t?t:+t;t=t.replace(m,"");var n=v.test(t);return n||b.test(t)?g(t.slice(2),n?2:8):y.test(t)?d:+t}var H=function(t,e,n){var i=!0,o=!0;if("function"!=typeof t)throw new TypeError(p);return L(n)&&(i="leading"in n?!!n.leading:i,o="trailing"in n?!!n.trailing:o),E(t,e,{leading:i,maxWait:e,trailing:o})},A={item:void 0,next:void 0,pagination:void 0,responseType:"document",bind:!0,scrollContainer:window,spinner:!1},P=function(t,n){var i=e(t);if(i.length>1)throw Error('Expected single element for "'+n+'"');if(0===i.length)throw Error('Element "'+t+'" not found for "'+n+'"')};function _(){this.emitter.emit("scrolled"),this.measure()}function D(){this.emitter.emit("resized"),this.measure()}function N(){}N.prototype={on:function(t,e,n){var i=this.e||(this.e={});return(i[t]||(i[t]=[])).push({fn:e,ctx:n}),this},once:function(t,e,n){var i=this;function o(){i.off(t,o),e.apply(n,arguments)}return o._=e,this.on(t,o,n)},emit:function(t){for(var e=[].slice.call(arguments,1),n=((this.e||(this.e={}))[t]||[]).slice(),i=0,o=n.length;o>i;i++)n[i].fn.apply(n[i].ctx,e);return this},off:function(t,e){var n=this.e||(this.e={}),i=n[t],o=[];if(i&&e)for(var r=0,s=i.length;s>r;r++)i[r].fn!==e&&i[r].fn._!==e&&o.push(i[r]);return o.length?n[t]=o:delete n[t],this}};var q=N;function I(t,e){var n=function(t){if(t!==window)return{x:t.scrollLeft,y:t.scrollTop};var e=void 0!==window.pageXOffset,n="CSS1Compat"===(document.compatMode||"");return{x:e?window.pageXOffset:n?document.documentElement.scrollLeft:document.body.scrollLeft,y:e?window.pageYOffset:n?document.documentElement.scrollTop:document.body.scrollTop}}(e),i=function(t){var e;if(t!==window)e=t.getBoundingClientRect();else{var n=document.documentElement,i=document.body;e={top:0,left:0,right:n.clientWidth||i.clientWidth,width:n.clientWidth||i.clientWidth,bottom:n.clientHeight||i.clientHeight,height:n.clientHeight||i.clientHeight}}return e}(e),o=t.getBoundingClientRect();return n.y+o.bottom-i.top-(n.y+i.height)}var M=document;function R(t){var n=this,i=e(n.options.next,M)[0];if(i)return n.load(i.href).then(function(t){var i=e(n.options.next,M=t.xhr.response)[0];return n.append(t.items).then(function(){return!!i})})}var W={element:void 0,hide:!1};var F=function(t,e){this.options=l({},W,function(t){return"string"==typeof t?t={element:t,hide:!0}:"boolean"==typeof t&&(t={element:void 0,hide:t}),t}(e)),this.options.hide&&(P(this.options.element,"pagination.element"),t.on("binded",this.hide.bind(this)),t.on("unbinded",this.restore.bind(this)))};F.prototype.hide=function(){var t=e(this.options.element)[0];this.originalDisplayStyle=window.getComputedStyle(t).display,t.style.display="none"},F.prototype.restore=function(){e(this.options.element)[0].style.display=this.originalDisplayStyle};var X={element:void 0,delay:600,show:function(t){t.style.opacity="1"},hide:function(t){t.style.opacity="0"}};var $,V,z=function(t,n){!1!==n&&(this.ias=t,this.options=l({},X,function(t){return"string"==typeof t&&(t={element:t}),t}(n)),P(this.options.element,"spinner.element"),this.element=e(this.options.element)[0],this.hideFn=this.options.hide,this.showFn=this.options.show,t.on("binded",this.bind.bind(this)),t.on("binded",this.hide.bind(this)))};z.prototype.bind=function(){var t,e,n=this,i=this.ias;i.on("next",function(){t=+new Date,n.show()}),i.on("append",function(i){e=Math.max(0,n.options.delay-(+new Date-t));var o=i.executor;i.executor=function(t){setTimeout(function(){Promise.resolve(n.hide()).then(function(){o(t)})},e)}})},z.prototype.show=function(){return Promise.resolve(this.showFn(this.element))},z.prototype.hide=function(){return Promise.resolve(this.hideFn(this.element))};var B=function(t,n){void 0===n&&(n={}),P(t,"container"),this.container=e(t)[0],this.options=l({},A,n),this.emitter=new q,this.scrollContainer=this.options.scrollContainer,this.options.scrollContainer!==window&&(P(this.options.scrollContainer,"options.scrollContainer"),this.scrollContainer=e(this.options.scrollContainer)[0]),this.nextHandler=R,"function"==typeof this.options.next&&(this.nextHandler=this.options.next),this.binded=!1,this.paused=!1,this.pageIndex=0,this.on("hit",this.next),this.pagination=new F(this,this.options.pagination),this.spinner=new z(this,this.options.spinner),this.options.bind&&this.bind()};return B.prototype.bind=function(){this.binded||($=H(_,200).bind(this),V=H(D,200).bind(this),this.scrollContainer.addEventListener("scroll",$),this.scrollContainer.addEventListener("resize",V),this.binded=!0,this.emitter.emit("binded"))},B.prototype.unbind=function(){this.binded&&(this.scrollContainer.removeEventListener("resize",V),this.scrollContainer.removeEventListener("scroll",$),this.binded=!1,this.emitter.emit("unbinded"))},B.prototype.next=function(){var t=this;this.pause();var e={pageIndex:this.pageIndex};this.emitter.emit("next",e),Promise.resolve(this.nextHandler(e.pageIndex)).then(function(e){e?(t.pageIndex++,t.resume()):t.emitter.emit("last")})},B.prototype.load=function(t){var n=this;return new Promise(function(i,o){var r=new XMLHttpRequest;r.onreadystatechange=function(){if(r.readyState===XMLHttpRequest.DONE)if(200===r.status){var s=r.response;"document"===n.options.responseType&&(s=e(n.options.item,r.response)),n.emitter.emit("loaded",{items:s,url:t,xhr:r}),i({items:s,url:t,xhr:r})}else console.error("Request failed"),o(r)},t=t+(/\?/.test(t)?"&":"?")+(new Date).getTime(),r.open("GET",t,!0),r.responseType=n.options.responseType,r.setRequestHeader("X-Requested-With","XMLHttpRequest"),n.emitter.emit("load",{url:t,xhr:r}),r.send()})},B.prototype.append=function(t,e){var n=this;e=e||n.container;var i=document.createDocumentFragment();t.forEach(function(t){i.appendChild(t)});var o={items:t,parent:e,executor:function(o){var r=n.sentinel();e.insertBefore(i,r?r.nextSibling:null),window.requestAnimationFrame(function(){o({items:t,parent:e}),n.emitter.emit("appended",{items:t,parent:e})})}};return n.emitter.emit("append",o),new Promise(o.executor)},B.prototype.sentinel=function(){var t=e(this.options.item,this.container);if(!t.length)throw Error('Item "'+this.options.item+'" not found');return t[t.length-1]},B.prototype.pause=function(){this.paused=!0},B.prototype.resume=function(){this.paused=!1,this.measure()},B.prototype.measure=function(){if(!this.paused){var t=I(this.sentinel(),this.scrollContainer);t>0||this.emitter.emit("hit",{distance:t})}},B.prototype.on=function(t,e){this.emitter.on(t,e,this),"binded"===t&&this.binded&&e.bind(this)()},B.prototype.off=function(t,e){this.emitter.off(t,e,this)},B.prototype.once=function(t,e){this.emitter.once(t,e,this),"binded"===t&&this.binded&&e.bind(this)()},B});
